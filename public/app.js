(function () {
  'use strict';

  function _classCallCheck(instance, Constructor) {
    if (!(instance instanceof Constructor)) {
      throw new TypeError("Cannot call a class as a function");
    }
  }

  function _defineProperties(target, props) {
    for (var i = 0; i < props.length; i++) {
      var descriptor = props[i];
      descriptor.enumerable = descriptor.enumerable || false;
      descriptor.configurable = true;
      if ("value" in descriptor) descriptor.writable = true;
      Object.defineProperty(target, descriptor.key, descriptor);
    }
  }

  function _createClass(Constructor, protoProps, staticProps) {
    if (protoProps) _defineProperties(Constructor.prototype, protoProps);
    if (staticProps) _defineProperties(Constructor, staticProps);
    Object.defineProperty(Constructor, "prototype", {
      writable: false
    });
    return Constructor;
  }

  function _defineProperty(obj, key, value) {
    if (key in obj) {
      Object.defineProperty(obj, key, {
        value: value,
        enumerable: true,
        configurable: true,
        writable: true
      });
    } else {
      obj[key] = value;
    }

    return obj;
  }

  function _inherits(subClass, superClass) {
    if (typeof superClass !== "function" && superClass !== null) {
      throw new TypeError("Super expression must either be null or a function");
    }

    subClass.prototype = Object.create(superClass && superClass.prototype, {
      constructor: {
        value: subClass,
        writable: true,
        configurable: true
      }
    });
    Object.defineProperty(subClass, "prototype", {
      writable: false
    });
    if (superClass) _setPrototypeOf(subClass, superClass);
  }

  function _getPrototypeOf(o) {
    _getPrototypeOf = Object.setPrototypeOf ? Object.getPrototypeOf : function _getPrototypeOf(o) {
      return o.__proto__ || Object.getPrototypeOf(o);
    };
    return _getPrototypeOf(o);
  }

  function _setPrototypeOf(o, p) {
    _setPrototypeOf = Object.setPrototypeOf || function _setPrototypeOf(o, p) {
      o.__proto__ = p;
      return o;
    };

    return _setPrototypeOf(o, p);
  }

  function _isNativeReflectConstruct() {
    if (typeof Reflect === "undefined" || !Reflect.construct) return false;
    if (Reflect.construct.sham) return false;
    if (typeof Proxy === "function") return true;

    try {
      Boolean.prototype.valueOf.call(Reflect.construct(Boolean, [], function () {}));
      return true;
    } catch (e) {
      return false;
    }
  }

  function _assertThisInitialized(self) {
    if (self === void 0) {
      throw new ReferenceError("this hasn't been initialised - super() hasn't been called");
    }

    return self;
  }

  function _possibleConstructorReturn(self, call) {
    if (call && (typeof call === "object" || typeof call === "function")) {
      return call;
    } else if (call !== void 0) {
      throw new TypeError("Derived constructors may only return object or undefined");
    }

    return _assertThisInitialized(self);
  }

  function _createSuper(Derived) {
    var hasNativeReflectConstruct = _isNativeReflectConstruct();

    return function _createSuperInternal() {
      var Super = _getPrototypeOf(Derived),
          result;

      if (hasNativeReflectConstruct) {
        var NewTarget = _getPrototypeOf(this).constructor;

        result = Reflect.construct(Super, arguments, NewTarget);
      } else {
        result = Super.apply(this, arguments);
      }

      return _possibleConstructorReturn(this, result);
    };
  }

  function _toConsumableArray(arr) {
    return _arrayWithoutHoles(arr) || _iterableToArray(arr) || _unsupportedIterableToArray(arr) || _nonIterableSpread();
  }

  function _arrayWithoutHoles(arr) {
    if (Array.isArray(arr)) return _arrayLikeToArray(arr);
  }

  function _iterableToArray(iter) {
    if (typeof Symbol !== "undefined" && iter[Symbol.iterator] != null || iter["@@iterator"] != null) return Array.from(iter);
  }

  function _unsupportedIterableToArray(o, minLen) {
    if (!o) return;
    if (typeof o === "string") return _arrayLikeToArray(o, minLen);
    var n = Object.prototype.toString.call(o).slice(8, -1);
    if (n === "Object" && o.constructor) n = o.constructor.name;
    if (n === "Map" || n === "Set") return Array.from(o);
    if (n === "Arguments" || /^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)) return _arrayLikeToArray(o, minLen);
  }

  function _arrayLikeToArray(arr, len) {
    if (len == null || len > arr.length) len = arr.length;

    for (var i = 0, arr2 = new Array(len); i < len; i++) arr2[i] = arr[i];

    return arr2;
  }

  function _nonIterableSpread() {
    throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");
  }

  function _createForOfIteratorHelper(o, allowArrayLike) {
    var it = typeof Symbol !== "undefined" && o[Symbol.iterator] || o["@@iterator"];

    if (!it) {
      if (Array.isArray(o) || (it = _unsupportedIterableToArray(o)) || allowArrayLike && o && typeof o.length === "number") {
        if (it) o = it;
        var i = 0;

        var F = function () {};

        return {
          s: F,
          n: function () {
            if (i >= o.length) return {
              done: true
            };
            return {
              done: false,
              value: o[i++]
            };
          },
          e: function (e) {
            throw e;
          },
          f: F
        };
      }

      throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.");
    }

    var normalCompletion = true,
        didErr = false,
        err;
    return {
      s: function () {
        it = it.call(o);
      },
      n: function () {
        var step = it.next();
        normalCompletion = step.done;
        return step;
      },
      e: function (e) {
        didErr = true;
        err = e;
      },
      f: function () {
        try {
          if (!normalCompletion && it.return != null) it.return();
        } finally {
          if (didErr) throw err;
        }
      }
    };
  }

  function _classPrivateFieldGet(receiver, privateMap) {
    var descriptor = _classExtractFieldDescriptor(receiver, privateMap, "get");

    return _classApplyDescriptorGet(receiver, descriptor);
  }

  function _classPrivateFieldSet(receiver, privateMap, value) {
    var descriptor = _classExtractFieldDescriptor(receiver, privateMap, "set");

    _classApplyDescriptorSet(receiver, descriptor, value);

    return value;
  }

  function _classExtractFieldDescriptor(receiver, privateMap, action) {
    if (!privateMap.has(receiver)) {
      throw new TypeError("attempted to " + action + " private field on non-instance");
    }

    return privateMap.get(receiver);
  }

  function _classApplyDescriptorGet(receiver, descriptor) {
    if (descriptor.get) {
      return descriptor.get.call(receiver);
    }

    return descriptor.value;
  }

  function _classApplyDescriptorSet(receiver, descriptor, value) {
    if (descriptor.set) {
      descriptor.set.call(receiver, value);
    } else {
      if (!descriptor.writable) {
        throw new TypeError("attempted to set read only private field");
      }

      descriptor.value = value;
    }
  }

  function _classPrivateMethodGet(receiver, privateSet, fn) {
    if (!privateSet.has(receiver)) {
      throw new TypeError("attempted to get private field on non-instance");
    }

    return fn;
  }

  function _checkPrivateRedeclaration(obj, privateCollection) {
    if (privateCollection.has(obj)) {
      throw new TypeError("Cannot initialize the same private elements twice on an object");
    }
  }

  function _classPrivateFieldInitSpec(obj, privateMap, value) {
    _checkPrivateRedeclaration(obj, privateMap);

    privateMap.set(obj, value);
  }

  function _classPrivateMethodInitSpec(obj, privateSet) {
    _checkPrivateRedeclaration(obj, privateSet);

    privateSet.add(obj);
  }

  var commonjsGlobal = typeof globalThis !== 'undefined' ? globalThis : typeof window !== 'undefined' ? window : typeof global !== 'undefined' ? global : typeof self !== 'undefined' ? self : {};

  var check = function (it) {
    return it && it.Math == Math && it;
  };

  // https://github.com/zloirock/core-js/issues/86#issuecomment-115759028
  var global$N =
    // eslint-disable-next-line es/no-global-this -- safe
    check(typeof globalThis == 'object' && globalThis) ||
    check(typeof window == 'object' && window) ||
    // eslint-disable-next-line no-restricted-globals -- safe
    check(typeof self == 'object' && self) ||
    check(typeof commonjsGlobal == 'object' && commonjsGlobal) ||
    // eslint-disable-next-line no-new-func -- fallback
    (function () { return this; })() || Function('return this')();

  var objectGetOwnPropertyDescriptor = {};

  var fails$q = function (exec) {
    try {
      return !!exec();
    } catch (error) {
      return true;
    }
  };

  var fails$p = fails$q;

  // Detect IE8's incomplete defineProperty implementation
  var descriptors = !fails$p(function () {
    // eslint-disable-next-line es/no-object-defineproperty -- required for testing
    return Object.defineProperty({}, 1, { get: function () { return 7; } })[1] != 7;
  });

  var fails$o = fails$q;

  var functionBindNative = !fails$o(function () {
    var test = (function () { /* empty */ }).bind();
    // eslint-disable-next-line no-prototype-builtins -- safe
    return typeof test != 'function' || test.hasOwnProperty('prototype');
  });

  var NATIVE_BIND$3 = functionBindNative;

  var call$e = Function.prototype.call;

  var functionCall = NATIVE_BIND$3 ? call$e.bind(call$e) : function () {
    return call$e.apply(call$e, arguments);
  };

  var objectPropertyIsEnumerable = {};

  var $propertyIsEnumerable = {}.propertyIsEnumerable;
  // eslint-disable-next-line es/no-object-getownpropertydescriptor -- safe
  var getOwnPropertyDescriptor$2 = Object.getOwnPropertyDescriptor;

  // Nashorn ~ JDK8 bug
  var NASHORN_BUG = getOwnPropertyDescriptor$2 && !$propertyIsEnumerable.call({ 1: 2 }, 1);

  // `Object.prototype.propertyIsEnumerable` method implementation
  // https://tc39.es/ecma262/#sec-object.prototype.propertyisenumerable
  objectPropertyIsEnumerable.f = NASHORN_BUG ? function propertyIsEnumerable(V) {
    var descriptor = getOwnPropertyDescriptor$2(this, V);
    return !!descriptor && descriptor.enumerable;
  } : $propertyIsEnumerable;

  var createPropertyDescriptor$5 = function (bitmap, value) {
    return {
      enumerable: !(bitmap & 1),
      configurable: !(bitmap & 2),
      writable: !(bitmap & 4),
      value: value
    };
  };

  var NATIVE_BIND$2 = functionBindNative;

  var FunctionPrototype$2 = Function.prototype;
  var bind$6 = FunctionPrototype$2.bind;
  var call$d = FunctionPrototype$2.call;
  var uncurryThis$p = NATIVE_BIND$2 && bind$6.bind(call$d, call$d);

  var functionUncurryThis = NATIVE_BIND$2 ? function (fn) {
    return fn && uncurryThis$p(fn);
  } : function (fn) {
    return fn && function () {
      return call$d.apply(fn, arguments);
    };
  };

  var uncurryThis$o = functionUncurryThis;

  var toString$9 = uncurryThis$o({}.toString);
  var stringSlice$3 = uncurryThis$o(''.slice);

  var classofRaw$1 = function (it) {
    return stringSlice$3(toString$9(it), 8, -1);
  };

  var global$M = global$N;
  var uncurryThis$n = functionUncurryThis;
  var fails$n = fails$q;
  var classof$b = classofRaw$1;

  var Object$5 = global$M.Object;
  var split = uncurryThis$n(''.split);

  // fallback for non-array-like ES3 and non-enumerable old V8 strings
  var indexedObject = fails$n(function () {
    // throws an error in rhino, see https://github.com/mozilla/rhino/issues/346
    // eslint-disable-next-line no-prototype-builtins -- safe
    return !Object$5('z').propertyIsEnumerable(0);
  }) ? function (it) {
    return classof$b(it) == 'String' ? split(it, '') : Object$5(it);
  } : Object$5;

  var global$L = global$N;

  var TypeError$g = global$L.TypeError;

  // `RequireObjectCoercible` abstract operation
  // https://tc39.es/ecma262/#sec-requireobjectcoercible
  var requireObjectCoercible$4 = function (it) {
    if (it == undefined) throw TypeError$g("Can't call method on " + it);
    return it;
  };

  // toObject with fallback for non-array-like ES3 strings
  var IndexedObject$2 = indexedObject;
  var requireObjectCoercible$3 = requireObjectCoercible$4;

  var toIndexedObject$8 = function (it) {
    return IndexedObject$2(requireObjectCoercible$3(it));
  };

  // `IsCallable` abstract operation
  // https://tc39.es/ecma262/#sec-iscallable
  var isCallable$l = function (argument) {
    return typeof argument == 'function';
  };

  var isCallable$k = isCallable$l;

  var isObject$i = function (it) {
    return typeof it == 'object' ? it !== null : isCallable$k(it);
  };

  var global$K = global$N;
  var isCallable$j = isCallable$l;

  var aFunction = function (argument) {
    return isCallable$j(argument) ? argument : undefined;
  };

  var getBuiltIn$9 = function (namespace, method) {
    return arguments.length < 2 ? aFunction(global$K[namespace]) : global$K[namespace] && global$K[namespace][method];
  };

  var uncurryThis$m = functionUncurryThis;

  var objectIsPrototypeOf = uncurryThis$m({}.isPrototypeOf);

  var getBuiltIn$8 = getBuiltIn$9;

  var engineUserAgent = getBuiltIn$8('navigator', 'userAgent') || '';

  var global$J = global$N;
  var userAgent$5 = engineUserAgent;

  var process$4 = global$J.process;
  var Deno = global$J.Deno;
  var versions = process$4 && process$4.versions || Deno && Deno.version;
  var v8 = versions && versions.v8;
  var match, version;

  if (v8) {
    match = v8.split('.');
    // in old Chrome, versions of V8 isn't V8 = Chrome / 10
    // but their correct versions are not interesting for us
    version = match[0] > 0 && match[0] < 4 ? 1 : +(match[0] + match[1]);
  }

  // BrowserFS NodeJS `process` polyfill incorrectly set `.v8` to `0.0`
  // so check `userAgent` even if `.v8` exists, but 0
  if (!version && userAgent$5) {
    match = userAgent$5.match(/Edge\/(\d+)/);
    if (!match || match[1] >= 74) {
      match = userAgent$5.match(/Chrome\/(\d+)/);
      if (match) version = +match[1];
    }
  }

  var engineV8Version = version;

  /* eslint-disable es/no-symbol -- required for testing */

  var V8_VERSION$3 = engineV8Version;
  var fails$m = fails$q;

  // eslint-disable-next-line es/no-object-getownpropertysymbols -- required for testing
  var nativeSymbol = !!Object.getOwnPropertySymbols && !fails$m(function () {
    var symbol = Symbol();
    // Chrome 38 Symbol has incorrect toString conversion
    // `get-own-property-symbols` polyfill symbols converted to object are not Symbol instances
    return !String(symbol) || !(Object(symbol) instanceof Symbol) ||
      // Chrome 38-40 symbols are not inherited from DOM collections prototypes to instances
      !Symbol.sham && V8_VERSION$3 && V8_VERSION$3 < 41;
  });

  /* eslint-disable es/no-symbol -- required for testing */

  var NATIVE_SYMBOL$1 = nativeSymbol;

  var useSymbolAsUid = NATIVE_SYMBOL$1
    && !Symbol.sham
    && typeof Symbol.iterator == 'symbol';

  var global$I = global$N;
  var getBuiltIn$7 = getBuiltIn$9;
  var isCallable$i = isCallable$l;
  var isPrototypeOf$3 = objectIsPrototypeOf;
  var USE_SYMBOL_AS_UID$1 = useSymbolAsUid;

  var Object$4 = global$I.Object;

  var isSymbol$2 = USE_SYMBOL_AS_UID$1 ? function (it) {
    return typeof it == 'symbol';
  } : function (it) {
    var $Symbol = getBuiltIn$7('Symbol');
    return isCallable$i($Symbol) && isPrototypeOf$3($Symbol.prototype, Object$4(it));
  };

  var global$H = global$N;

  var String$5 = global$H.String;

  var tryToString$4 = function (argument) {
    try {
      return String$5(argument);
    } catch (error) {
      return 'Object';
    }
  };

  var global$G = global$N;
  var isCallable$h = isCallable$l;
  var tryToString$3 = tryToString$4;

  var TypeError$f = global$G.TypeError;

  // `Assert: IsCallable(argument) is true`
  var aCallable$6 = function (argument) {
    if (isCallable$h(argument)) return argument;
    throw TypeError$f(tryToString$3(argument) + ' is not a function');
  };

  var aCallable$5 = aCallable$6;

  // `GetMethod` abstract operation
  // https://tc39.es/ecma262/#sec-getmethod
  var getMethod$4 = function (V, P) {
    var func = V[P];
    return func == null ? undefined : aCallable$5(func);
  };

  var global$F = global$N;
  var call$c = functionCall;
  var isCallable$g = isCallable$l;
  var isObject$h = isObject$i;

  var TypeError$e = global$F.TypeError;

  // `OrdinaryToPrimitive` abstract operation
  // https://tc39.es/ecma262/#sec-ordinarytoprimitive
  var ordinaryToPrimitive$1 = function (input, pref) {
    var fn, val;
    if (pref === 'string' && isCallable$g(fn = input.toString) && !isObject$h(val = call$c(fn, input))) return val;
    if (isCallable$g(fn = input.valueOf) && !isObject$h(val = call$c(fn, input))) return val;
    if (pref !== 'string' && isCallable$g(fn = input.toString) && !isObject$h(val = call$c(fn, input))) return val;
    throw TypeError$e("Can't convert object to primitive value");
  };

  var shared$4 = {exports: {}};

  var global$E = global$N;

  // eslint-disable-next-line es/no-object-defineproperty -- safe
  var defineProperty$3 = Object.defineProperty;

  var setGlobal$3 = function (key, value) {
    try {
      defineProperty$3(global$E, key, { value: value, configurable: true, writable: true });
    } catch (error) {
      global$E[key] = value;
    } return value;
  };

  var global$D = global$N;
  var setGlobal$2 = setGlobal$3;

  var SHARED = '__core-js_shared__';
  var store$3 = global$D[SHARED] || setGlobal$2(SHARED, {});

  var sharedStore = store$3;

  var store$2 = sharedStore;

  (shared$4.exports = function (key, value) {
    return store$2[key] || (store$2[key] = value !== undefined ? value : {});
  })('versions', []).push({
    version: '3.21.0',
    mode: 'global',
    copyright: 'Â© 2014-2022 Denis Pushkarev (zloirock.ru)',
    license: 'https://github.com/zloirock/core-js/blob/v3.21.0/LICENSE',
    source: 'https://github.com/zloirock/core-js'
  });

  var global$C = global$N;
  var requireObjectCoercible$2 = requireObjectCoercible$4;

  var Object$3 = global$C.Object;

  // `ToObject` abstract operation
  // https://tc39.es/ecma262/#sec-toobject
  var toObject$5 = function (argument) {
    return Object$3(requireObjectCoercible$2(argument));
  };

  var uncurryThis$l = functionUncurryThis;
  var toObject$4 = toObject$5;

  var hasOwnProperty = uncurryThis$l({}.hasOwnProperty);

  // `HasOwnProperty` abstract operation
  // https://tc39.es/ecma262/#sec-hasownproperty
  var hasOwnProperty_1 = Object.hasOwn || function hasOwn(it, key) {
    return hasOwnProperty(toObject$4(it), key);
  };

  var uncurryThis$k = functionUncurryThis;

  var id$2 = 0;
  var postfix = Math.random();
  var toString$8 = uncurryThis$k(1.0.toString);

  var uid$3 = function (key) {
    return 'Symbol(' + (key === undefined ? '' : key) + ')_' + toString$8(++id$2 + postfix, 36);
  };

  var global$B = global$N;
  var shared$3 = shared$4.exports;
  var hasOwn$c = hasOwnProperty_1;
  var uid$2 = uid$3;
  var NATIVE_SYMBOL = nativeSymbol;
  var USE_SYMBOL_AS_UID = useSymbolAsUid;

  var WellKnownSymbolsStore = shared$3('wks');
  var Symbol$1 = global$B.Symbol;
  var symbolFor = Symbol$1 && Symbol$1['for'];
  var createWellKnownSymbol = USE_SYMBOL_AS_UID ? Symbol$1 : Symbol$1 && Symbol$1.withoutSetter || uid$2;

  var wellKnownSymbol$k = function (name) {
    if (!hasOwn$c(WellKnownSymbolsStore, name) || !(NATIVE_SYMBOL || typeof WellKnownSymbolsStore[name] == 'string')) {
      var description = 'Symbol.' + name;
      if (NATIVE_SYMBOL && hasOwn$c(Symbol$1, name)) {
        WellKnownSymbolsStore[name] = Symbol$1[name];
      } else if (USE_SYMBOL_AS_UID && symbolFor) {
        WellKnownSymbolsStore[name] = symbolFor(description);
      } else {
        WellKnownSymbolsStore[name] = createWellKnownSymbol(description);
      }
    } return WellKnownSymbolsStore[name];
  };

  var global$A = global$N;
  var call$b = functionCall;
  var isObject$g = isObject$i;
  var isSymbol$1 = isSymbol$2;
  var getMethod$3 = getMethod$4;
  var ordinaryToPrimitive = ordinaryToPrimitive$1;
  var wellKnownSymbol$j = wellKnownSymbol$k;

  var TypeError$d = global$A.TypeError;
  var TO_PRIMITIVE = wellKnownSymbol$j('toPrimitive');

  // `ToPrimitive` abstract operation
  // https://tc39.es/ecma262/#sec-toprimitive
  var toPrimitive$1 = function (input, pref) {
    if (!isObject$g(input) || isSymbol$1(input)) return input;
    var exoticToPrim = getMethod$3(input, TO_PRIMITIVE);
    var result;
    if (exoticToPrim) {
      if (pref === undefined) pref = 'default';
      result = call$b(exoticToPrim, input, pref);
      if (!isObject$g(result) || isSymbol$1(result)) return result;
      throw TypeError$d("Can't convert object to primitive value");
    }
    if (pref === undefined) pref = 'number';
    return ordinaryToPrimitive(input, pref);
  };

  var toPrimitive = toPrimitive$1;
  var isSymbol = isSymbol$2;

  // `ToPropertyKey` abstract operation
  // https://tc39.es/ecma262/#sec-topropertykey
  var toPropertyKey$3 = function (argument) {
    var key = toPrimitive(argument, 'string');
    return isSymbol(key) ? key : key + '';
  };

  var global$z = global$N;
  var isObject$f = isObject$i;

  var document$3 = global$z.document;
  // typeof document.createElement is 'object' in old IE
  var EXISTS$1 = isObject$f(document$3) && isObject$f(document$3.createElement);

  var documentCreateElement$2 = function (it) {
    return EXISTS$1 ? document$3.createElement(it) : {};
  };

  var DESCRIPTORS$8 = descriptors;
  var fails$l = fails$q;
  var createElement$1 = documentCreateElement$2;

  // Thanks to IE8 for its funny defineProperty
  var ie8DomDefine = !DESCRIPTORS$8 && !fails$l(function () {
    // eslint-disable-next-line es/no-object-defineproperty -- required for testing
    return Object.defineProperty(createElement$1('div'), 'a', {
      get: function () { return 7; }
    }).a != 7;
  });

  var DESCRIPTORS$7 = descriptors;
  var call$a = functionCall;
  var propertyIsEnumerableModule = objectPropertyIsEnumerable;
  var createPropertyDescriptor$4 = createPropertyDescriptor$5;
  var toIndexedObject$7 = toIndexedObject$8;
  var toPropertyKey$2 = toPropertyKey$3;
  var hasOwn$b = hasOwnProperty_1;
  var IE8_DOM_DEFINE$1 = ie8DomDefine;

  // eslint-disable-next-line es/no-object-getownpropertydescriptor -- safe
  var $getOwnPropertyDescriptor$1 = Object.getOwnPropertyDescriptor;

  // `Object.getOwnPropertyDescriptor` method
  // https://tc39.es/ecma262/#sec-object.getownpropertydescriptor
  objectGetOwnPropertyDescriptor.f = DESCRIPTORS$7 ? $getOwnPropertyDescriptor$1 : function getOwnPropertyDescriptor(O, P) {
    O = toIndexedObject$7(O);
    P = toPropertyKey$2(P);
    if (IE8_DOM_DEFINE$1) try {
      return $getOwnPropertyDescriptor$1(O, P);
    } catch (error) { /* empty */ }
    if (hasOwn$b(O, P)) return createPropertyDescriptor$4(!call$a(propertyIsEnumerableModule.f, O, P), O[P]);
  };

  var objectDefineProperty = {};

  var DESCRIPTORS$6 = descriptors;
  var fails$k = fails$q;

  // V8 ~ Chrome 36-
  // https://bugs.chromium.org/p/v8/issues/detail?id=3334
  var v8PrototypeDefineBug = DESCRIPTORS$6 && fails$k(function () {
    // eslint-disable-next-line es/no-object-defineproperty -- required for testing
    return Object.defineProperty(function () { /* empty */ }, 'prototype', {
      value: 42,
      writable: false
    }).prototype != 42;
  });

  var global$y = global$N;
  var isObject$e = isObject$i;

  var String$4 = global$y.String;
  var TypeError$c = global$y.TypeError;

  // `Assert: Type(argument) is Object`
  var anObject$e = function (argument) {
    if (isObject$e(argument)) return argument;
    throw TypeError$c(String$4(argument) + ' is not an object');
  };

  var global$x = global$N;
  var DESCRIPTORS$5 = descriptors;
  var IE8_DOM_DEFINE = ie8DomDefine;
  var V8_PROTOTYPE_DEFINE_BUG$1 = v8PrototypeDefineBug;
  var anObject$d = anObject$e;
  var toPropertyKey$1 = toPropertyKey$3;

  var TypeError$b = global$x.TypeError;
  // eslint-disable-next-line es/no-object-defineproperty -- safe
  var $defineProperty = Object.defineProperty;
  // eslint-disable-next-line es/no-object-getownpropertydescriptor -- safe
  var $getOwnPropertyDescriptor = Object.getOwnPropertyDescriptor;
  var ENUMERABLE = 'enumerable';
  var CONFIGURABLE$1 = 'configurable';
  var WRITABLE = 'writable';

  // `Object.defineProperty` method
  // https://tc39.es/ecma262/#sec-object.defineproperty
  objectDefineProperty.f = DESCRIPTORS$5 ? V8_PROTOTYPE_DEFINE_BUG$1 ? function defineProperty(O, P, Attributes) {
    anObject$d(O);
    P = toPropertyKey$1(P);
    anObject$d(Attributes);
    if (typeof O === 'function' && P === 'prototype' && 'value' in Attributes && WRITABLE in Attributes && !Attributes[WRITABLE]) {
      var current = $getOwnPropertyDescriptor(O, P);
      if (current && current[WRITABLE]) {
        O[P] = Attributes.value;
        Attributes = {
          configurable: CONFIGURABLE$1 in Attributes ? Attributes[CONFIGURABLE$1] : current[CONFIGURABLE$1],
          enumerable: ENUMERABLE in Attributes ? Attributes[ENUMERABLE] : current[ENUMERABLE],
          writable: false
        };
      }
    } return $defineProperty(O, P, Attributes);
  } : $defineProperty : function defineProperty(O, P, Attributes) {
    anObject$d(O);
    P = toPropertyKey$1(P);
    anObject$d(Attributes);
    if (IE8_DOM_DEFINE) try {
      return $defineProperty(O, P, Attributes);
    } catch (error) { /* empty */ }
    if ('get' in Attributes || 'set' in Attributes) throw TypeError$b('Accessors not supported');
    if ('value' in Attributes) O[P] = Attributes.value;
    return O;
  };

  var DESCRIPTORS$4 = descriptors;
  var definePropertyModule$5 = objectDefineProperty;
  var createPropertyDescriptor$3 = createPropertyDescriptor$5;

  var createNonEnumerableProperty$8 = DESCRIPTORS$4 ? function (object, key, value) {
    return definePropertyModule$5.f(object, key, createPropertyDescriptor$3(1, value));
  } : function (object, key, value) {
    object[key] = value;
    return object;
  };

  var redefine$9 = {exports: {}};

  var uncurryThis$j = functionUncurryThis;
  var isCallable$f = isCallable$l;
  var store$1 = sharedStore;

  var functionToString = uncurryThis$j(Function.toString);

  // this helper broken in `core-js@3.4.1-3.4.4`, so we can't use `shared` helper
  if (!isCallable$f(store$1.inspectSource)) {
    store$1.inspectSource = function (it) {
      return functionToString(it);
    };
  }

  var inspectSource$4 = store$1.inspectSource;

  var global$w = global$N;
  var isCallable$e = isCallable$l;
  var inspectSource$3 = inspectSource$4;

  var WeakMap$2 = global$w.WeakMap;

  var nativeWeakMap = isCallable$e(WeakMap$2) && /native code/.test(inspectSource$3(WeakMap$2));

  var shared$2 = shared$4.exports;
  var uid$1 = uid$3;

  var keys = shared$2('keys');

  var sharedKey$3 = function (key) {
    return keys[key] || (keys[key] = uid$1(key));
  };

  var hiddenKeys$5 = {};

  var NATIVE_WEAK_MAP$1 = nativeWeakMap;
  var global$v = global$N;
  var uncurryThis$i = functionUncurryThis;
  var isObject$d = isObject$i;
  var createNonEnumerableProperty$7 = createNonEnumerableProperty$8;
  var hasOwn$a = hasOwnProperty_1;
  var shared$1 = sharedStore;
  var sharedKey$2 = sharedKey$3;
  var hiddenKeys$4 = hiddenKeys$5;

  var OBJECT_ALREADY_INITIALIZED = 'Object already initialized';
  var TypeError$a = global$v.TypeError;
  var WeakMap$1 = global$v.WeakMap;
  var set$1, get, has;

  var enforce = function (it) {
    return has(it) ? get(it) : set$1(it, {});
  };

  var getterFor = function (TYPE) {
    return function (it) {
      var state;
      if (!isObject$d(it) || (state = get(it)).type !== TYPE) {
        throw TypeError$a('Incompatible receiver, ' + TYPE + ' required');
      } return state;
    };
  };

  if (NATIVE_WEAK_MAP$1 || shared$1.state) {
    var store = shared$1.state || (shared$1.state = new WeakMap$1());
    var wmget = uncurryThis$i(store.get);
    var wmhas = uncurryThis$i(store.has);
    var wmset = uncurryThis$i(store.set);
    set$1 = function (it, metadata) {
      if (wmhas(store, it)) throw new TypeError$a(OBJECT_ALREADY_INITIALIZED);
      metadata.facade = it;
      wmset(store, it, metadata);
      return metadata;
    };
    get = function (it) {
      return wmget(store, it) || {};
    };
    has = function (it) {
      return wmhas(store, it);
    };
  } else {
    var STATE = sharedKey$2('state');
    hiddenKeys$4[STATE] = true;
    set$1 = function (it, metadata) {
      if (hasOwn$a(it, STATE)) throw new TypeError$a(OBJECT_ALREADY_INITIALIZED);
      metadata.facade = it;
      createNonEnumerableProperty$7(it, STATE, metadata);
      return metadata;
    };
    get = function (it) {
      return hasOwn$a(it, STATE) ? it[STATE] : {};
    };
    has = function (it) {
      return hasOwn$a(it, STATE);
    };
  }

  var internalState = {
    set: set$1,
    get: get,
    has: has,
    enforce: enforce,
    getterFor: getterFor
  };

  var DESCRIPTORS$3 = descriptors;
  var hasOwn$9 = hasOwnProperty_1;

  var FunctionPrototype$1 = Function.prototype;
  // eslint-disable-next-line es/no-object-getownpropertydescriptor -- safe
  var getDescriptor = DESCRIPTORS$3 && Object.getOwnPropertyDescriptor;

  var EXISTS = hasOwn$9(FunctionPrototype$1, 'name');
  // additional protection from minified / mangled / dropped function names
  var PROPER = EXISTS && (function something() { /* empty */ }).name === 'something';
  var CONFIGURABLE = EXISTS && (!DESCRIPTORS$3 || (DESCRIPTORS$3 && getDescriptor(FunctionPrototype$1, 'name').configurable));

  var functionName = {
    EXISTS: EXISTS,
    PROPER: PROPER,
    CONFIGURABLE: CONFIGURABLE
  };

  var global$u = global$N;
  var isCallable$d = isCallable$l;
  var hasOwn$8 = hasOwnProperty_1;
  var createNonEnumerableProperty$6 = createNonEnumerableProperty$8;
  var setGlobal$1 = setGlobal$3;
  var inspectSource$2 = inspectSource$4;
  var InternalStateModule$4 = internalState;
  var CONFIGURABLE_FUNCTION_NAME$1 = functionName.CONFIGURABLE;

  var getInternalState$4 = InternalStateModule$4.get;
  var enforceInternalState$1 = InternalStateModule$4.enforce;
  var TEMPLATE = String(String).split('String');

  (redefine$9.exports = function (O, key, value, options) {
    var unsafe = options ? !!options.unsafe : false;
    var simple = options ? !!options.enumerable : false;
    var noTargetGet = options ? !!options.noTargetGet : false;
    var name = options && options.name !== undefined ? options.name : key;
    var state;
    if (isCallable$d(value)) {
      if (String(name).slice(0, 7) === 'Symbol(') {
        name = '[' + String(name).replace(/^Symbol\(([^)]*)\)/, '$1') + ']';
      }
      if (!hasOwn$8(value, 'name') || (CONFIGURABLE_FUNCTION_NAME$1 && value.name !== name)) {
        createNonEnumerableProperty$6(value, 'name', name);
      }
      state = enforceInternalState$1(value);
      if (!state.source) {
        state.source = TEMPLATE.join(typeof name == 'string' ? name : '');
      }
    }
    if (O === global$u) {
      if (simple) O[key] = value;
      else setGlobal$1(key, value);
      return;
    } else if (!unsafe) {
      delete O[key];
    } else if (!noTargetGet && O[key]) {
      simple = true;
    }
    if (simple) O[key] = value;
    else createNonEnumerableProperty$6(O, key, value);
  // add fake Function#toString for correct work wrapped methods / constructors with methods like LoDash isNative
  })(Function.prototype, 'toString', function toString() {
    return isCallable$d(this) && getInternalState$4(this).source || inspectSource$2(this);
  });

  var objectGetOwnPropertyNames = {};

  var ceil = Math.ceil;
  var floor$1 = Math.floor;

  // `ToIntegerOrInfinity` abstract operation
  // https://tc39.es/ecma262/#sec-tointegerorinfinity
  var toIntegerOrInfinity$3 = function (argument) {
    var number = +argument;
    // eslint-disable-next-line no-self-compare -- safe
    return number !== number || number === 0 ? 0 : (number > 0 ? floor$1 : ceil)(number);
  };

  var toIntegerOrInfinity$2 = toIntegerOrInfinity$3;

  var max$2 = Math.max;
  var min$2 = Math.min;

  // Helper for a popular repeating case of the spec:
  // Let integer be ? ToInteger(index).
  // If integer < 0, let result be max((length + integer), 0); else let result be min(integer, length).
  var toAbsoluteIndex$3 = function (index, length) {
    var integer = toIntegerOrInfinity$2(index);
    return integer < 0 ? max$2(integer + length, 0) : min$2(integer, length);
  };

  var toIntegerOrInfinity$1 = toIntegerOrInfinity$3;

  var min$1 = Math.min;

  // `ToLength` abstract operation
  // https://tc39.es/ecma262/#sec-tolength
  var toLength$2 = function (argument) {
    return argument > 0 ? min$1(toIntegerOrInfinity$1(argument), 0x1FFFFFFFFFFFFF) : 0; // 2 ** 53 - 1 == 9007199254740991
  };

  var toLength$1 = toLength$2;

  // `LengthOfArrayLike` abstract operation
  // https://tc39.es/ecma262/#sec-lengthofarraylike
  var lengthOfArrayLike$7 = function (obj) {
    return toLength$1(obj.length);
  };

  var toIndexedObject$6 = toIndexedObject$8;
  var toAbsoluteIndex$2 = toAbsoluteIndex$3;
  var lengthOfArrayLike$6 = lengthOfArrayLike$7;

  // `Array.prototype.{ indexOf, includes }` methods implementation
  var createMethod$2 = function (IS_INCLUDES) {
    return function ($this, el, fromIndex) {
      var O = toIndexedObject$6($this);
      var length = lengthOfArrayLike$6(O);
      var index = toAbsoluteIndex$2(fromIndex, length);
      var value;
      // Array#includes uses SameValueZero equality algorithm
      // eslint-disable-next-line no-self-compare -- NaN check
      if (IS_INCLUDES && el != el) while (length > index) {
        value = O[index++];
        // eslint-disable-next-line no-self-compare -- NaN check
        if (value != value) return true;
      // Array#indexOf ignores holes, Array#includes - not
      } else for (;length > index; index++) {
        if ((IS_INCLUDES || index in O) && O[index] === el) return IS_INCLUDES || index || 0;
      } return !IS_INCLUDES && -1;
    };
  };

  var arrayIncludes = {
    // `Array.prototype.includes` method
    // https://tc39.es/ecma262/#sec-array.prototype.includes
    includes: createMethod$2(true),
    // `Array.prototype.indexOf` method
    // https://tc39.es/ecma262/#sec-array.prototype.indexof
    indexOf: createMethod$2(false)
  };

  var uncurryThis$h = functionUncurryThis;
  var hasOwn$7 = hasOwnProperty_1;
  var toIndexedObject$5 = toIndexedObject$8;
  var indexOf$1 = arrayIncludes.indexOf;
  var hiddenKeys$3 = hiddenKeys$5;

  var push$3 = uncurryThis$h([].push);

  var objectKeysInternal = function (object, names) {
    var O = toIndexedObject$5(object);
    var i = 0;
    var result = [];
    var key;
    for (key in O) !hasOwn$7(hiddenKeys$3, key) && hasOwn$7(O, key) && push$3(result, key);
    // Don't enum bug & hidden keys
    while (names.length > i) if (hasOwn$7(O, key = names[i++])) {
      ~indexOf$1(result, key) || push$3(result, key);
    }
    return result;
  };

  // IE8- don't enum bug keys
  var enumBugKeys$3 = [
    'constructor',
    'hasOwnProperty',
    'isPrototypeOf',
    'propertyIsEnumerable',
    'toLocaleString',
    'toString',
    'valueOf'
  ];

  var internalObjectKeys$1 = objectKeysInternal;
  var enumBugKeys$2 = enumBugKeys$3;

  var hiddenKeys$2 = enumBugKeys$2.concat('length', 'prototype');

  // `Object.getOwnPropertyNames` method
  // https://tc39.es/ecma262/#sec-object.getownpropertynames
  // eslint-disable-next-line es/no-object-getownpropertynames -- safe
  objectGetOwnPropertyNames.f = Object.getOwnPropertyNames || function getOwnPropertyNames(O) {
    return internalObjectKeys$1(O, hiddenKeys$2);
  };

  var objectGetOwnPropertySymbols = {};

  // eslint-disable-next-line es/no-object-getownpropertysymbols -- safe
  objectGetOwnPropertySymbols.f = Object.getOwnPropertySymbols;

  var getBuiltIn$6 = getBuiltIn$9;
  var uncurryThis$g = functionUncurryThis;
  var getOwnPropertyNamesModule$1 = objectGetOwnPropertyNames;
  var getOwnPropertySymbolsModule = objectGetOwnPropertySymbols;
  var anObject$c = anObject$e;

  var concat = uncurryThis$g([].concat);

  // all object keys, includes non-enumerable and symbols
  var ownKeys$1 = getBuiltIn$6('Reflect', 'ownKeys') || function ownKeys(it) {
    var keys = getOwnPropertyNamesModule$1.f(anObject$c(it));
    var getOwnPropertySymbols = getOwnPropertySymbolsModule.f;
    return getOwnPropertySymbols ? concat(keys, getOwnPropertySymbols(it)) : keys;
  };

  var hasOwn$6 = hasOwnProperty_1;
  var ownKeys = ownKeys$1;
  var getOwnPropertyDescriptorModule = objectGetOwnPropertyDescriptor;
  var definePropertyModule$4 = objectDefineProperty;

  var copyConstructorProperties$2 = function (target, source, exceptions) {
    var keys = ownKeys(source);
    var defineProperty = definePropertyModule$4.f;
    var getOwnPropertyDescriptor = getOwnPropertyDescriptorModule.f;
    for (var i = 0; i < keys.length; i++) {
      var key = keys[i];
      if (!hasOwn$6(target, key) && !(exceptions && hasOwn$6(exceptions, key))) {
        defineProperty(target, key, getOwnPropertyDescriptor(source, key));
      }
    }
  };

  var fails$j = fails$q;
  var isCallable$c = isCallable$l;

  var replacement = /#|\.prototype\./;

  var isForced$3 = function (feature, detection) {
    var value = data$2[normalize(feature)];
    return value == POLYFILL ? true
      : value == NATIVE ? false
      : isCallable$c(detection) ? fails$j(detection)
      : !!detection;
  };

  var normalize = isForced$3.normalize = function (string) {
    return String(string).replace(replacement, '.').toLowerCase();
  };

  var data$2 = isForced$3.data = {};
  var NATIVE = isForced$3.NATIVE = 'N';
  var POLYFILL = isForced$3.POLYFILL = 'P';

  var isForced_1 = isForced$3;

  var global$t = global$N;
  var getOwnPropertyDescriptor$1 = objectGetOwnPropertyDescriptor.f;
  var createNonEnumerableProperty$5 = createNonEnumerableProperty$8;
  var redefine$8 = redefine$9.exports;
  var setGlobal = setGlobal$3;
  var copyConstructorProperties$1 = copyConstructorProperties$2;
  var isForced$2 = isForced_1;

  /*
    options.target      - name of the target object
    options.global      - target is the global object
    options.stat        - export as static methods of target
    options.proto       - export as prototype methods of target
    options.real        - real prototype method for the `pure` version
    options.forced      - export even if the native feature is available
    options.bind        - bind methods to the target, required for the `pure` version
    options.wrap        - wrap constructors to preventing global pollution, required for the `pure` version
    options.unsafe      - use the simple assignment of property instead of delete + defineProperty
    options.sham        - add a flag to not completely full polyfills
    options.enumerable  - export as enumerable property
    options.noTargetGet - prevent calling a getter on target
    options.name        - the .name of the function if it does not match the key
  */
  var _export = function (options, source) {
    var TARGET = options.target;
    var GLOBAL = options.global;
    var STATIC = options.stat;
    var FORCED, target, key, targetProperty, sourceProperty, descriptor;
    if (GLOBAL) {
      target = global$t;
    } else if (STATIC) {
      target = global$t[TARGET] || setGlobal(TARGET, {});
    } else {
      target = (global$t[TARGET] || {}).prototype;
    }
    if (target) for (key in source) {
      sourceProperty = source[key];
      if (options.noTargetGet) {
        descriptor = getOwnPropertyDescriptor$1(target, key);
        targetProperty = descriptor && descriptor.value;
      } else targetProperty = target[key];
      FORCED = isForced$2(GLOBAL ? key : TARGET + (STATIC ? '.' : '#') + key, options.forced);
      // contained in target
      if (!FORCED && targetProperty !== undefined) {
        if (typeof sourceProperty == typeof targetProperty) continue;
        copyConstructorProperties$1(sourceProperty, targetProperty);
      }
      // add a flag to not completely full polyfills
      if (options.sham || (targetProperty && targetProperty.sham)) {
        createNonEnumerableProperty$5(sourceProperty, 'sham', true);
      }
      // extend global
      redefine$8(target, key, sourceProperty, options);
    }
  };

  var wellKnownSymbol$i = wellKnownSymbol$k;

  var TO_STRING_TAG$3 = wellKnownSymbol$i('toStringTag');
  var test$1 = {};

  test$1[TO_STRING_TAG$3] = 'z';

  var toStringTagSupport = String(test$1) === '[object z]';

  var global$s = global$N;
  var TO_STRING_TAG_SUPPORT$2 = toStringTagSupport;
  var isCallable$b = isCallable$l;
  var classofRaw = classofRaw$1;
  var wellKnownSymbol$h = wellKnownSymbol$k;

  var TO_STRING_TAG$2 = wellKnownSymbol$h('toStringTag');
  var Object$2 = global$s.Object;

  // ES3 wrong here
  var CORRECT_ARGUMENTS = classofRaw(function () { return arguments; }()) == 'Arguments';

  // fallback for IE11 Script Access Denied error
  var tryGet = function (it, key) {
    try {
      return it[key];
    } catch (error) { /* empty */ }
  };

  // getting tag from ES6+ `Object.prototype.toString`
  var classof$a = TO_STRING_TAG_SUPPORT$2 ? classofRaw : function (it) {
    var O, tag, result;
    return it === undefined ? 'Undefined' : it === null ? 'Null'
      // @@toStringTag case
      : typeof (tag = tryGet(O = Object$2(it), TO_STRING_TAG$2)) == 'string' ? tag
      // builtinTag case
      : CORRECT_ARGUMENTS ? classofRaw(O)
      // ES3 arguments fallback
      : (result = classofRaw(O)) == 'Object' && isCallable$b(O.callee) ? 'Arguments' : result;
  };

  var global$r = global$N;
  var classof$9 = classof$a;

  var String$3 = global$r.String;

  var toString$7 = function (argument) {
    if (classof$9(argument) === 'Symbol') throw TypeError('Cannot convert a Symbol value to a string');
    return String$3(argument);
  };

  var anObject$b = anObject$e;

  // `RegExp.prototype.flags` getter implementation
  // https://tc39.es/ecma262/#sec-get-regexp.prototype.flags
  var regexpFlags$1 = function () {
    var that = anObject$b(this);
    var result = '';
    if (that.global) result += 'g';
    if (that.ignoreCase) result += 'i';
    if (that.multiline) result += 'm';
    if (that.dotAll) result += 's';
    if (that.unicode) result += 'u';
    if (that.sticky) result += 'y';
    return result;
  };

  var fails$i = fails$q;
  var global$q = global$N;

  // babel-minify and Closure Compiler transpiles RegExp('a', 'y') -> /a/y and it causes SyntaxError
  var $RegExp$2 = global$q.RegExp;

  var UNSUPPORTED_Y$2 = fails$i(function () {
    var re = $RegExp$2('a', 'y');
    re.lastIndex = 2;
    return re.exec('abcd') != null;
  });

  // UC Browser bug
  // https://github.com/zloirock/core-js/issues/1008
  var MISSED_STICKY = UNSUPPORTED_Y$2 || fails$i(function () {
    return !$RegExp$2('a', 'y').sticky;
  });

  var BROKEN_CARET = UNSUPPORTED_Y$2 || fails$i(function () {
    // https://bugzilla.mozilla.org/show_bug.cgi?id=773687
    var re = $RegExp$2('^r', 'gy');
    re.lastIndex = 2;
    return re.exec('str') != null;
  });

  var regexpStickyHelpers = {
    BROKEN_CARET: BROKEN_CARET,
    MISSED_STICKY: MISSED_STICKY,
    UNSUPPORTED_Y: UNSUPPORTED_Y$2
  };

  var objectDefineProperties = {};

  var internalObjectKeys = objectKeysInternal;
  var enumBugKeys$1 = enumBugKeys$3;

  // `Object.keys` method
  // https://tc39.es/ecma262/#sec-object.keys
  // eslint-disable-next-line es/no-object-keys -- safe
  var objectKeys$1 = Object.keys || function keys(O) {
    return internalObjectKeys(O, enumBugKeys$1);
  };

  var DESCRIPTORS$2 = descriptors;
  var V8_PROTOTYPE_DEFINE_BUG = v8PrototypeDefineBug;
  var definePropertyModule$3 = objectDefineProperty;
  var anObject$a = anObject$e;
  var toIndexedObject$4 = toIndexedObject$8;
  var objectKeys = objectKeys$1;

  // `Object.defineProperties` method
  // https://tc39.es/ecma262/#sec-object.defineproperties
  // eslint-disable-next-line es/no-object-defineproperties -- safe
  objectDefineProperties.f = DESCRIPTORS$2 && !V8_PROTOTYPE_DEFINE_BUG ? Object.defineProperties : function defineProperties(O, Properties) {
    anObject$a(O);
    var props = toIndexedObject$4(Properties);
    var keys = objectKeys(Properties);
    var length = keys.length;
    var index = 0;
    var key;
    while (length > index) definePropertyModule$3.f(O, key = keys[index++], props[key]);
    return O;
  };

  var getBuiltIn$5 = getBuiltIn$9;

  var html$2 = getBuiltIn$5('document', 'documentElement');

  /* global ActiveXObject -- old IE, WSH */

  var anObject$9 = anObject$e;
  var definePropertiesModule = objectDefineProperties;
  var enumBugKeys = enumBugKeys$3;
  var hiddenKeys$1 = hiddenKeys$5;
  var html$1 = html$2;
  var documentCreateElement$1 = documentCreateElement$2;
  var sharedKey$1 = sharedKey$3;

  var GT = '>';
  var LT = '<';
  var PROTOTYPE = 'prototype';
  var SCRIPT = 'script';
  var IE_PROTO$1 = sharedKey$1('IE_PROTO');

  var EmptyConstructor = function () { /* empty */ };

  var scriptTag = function (content) {
    return LT + SCRIPT + GT + content + LT + '/' + SCRIPT + GT;
  };

  // Create object with fake `null` prototype: use ActiveX Object with cleared prototype
  var NullProtoObjectViaActiveX = function (activeXDocument) {
    activeXDocument.write(scriptTag(''));
    activeXDocument.close();
    var temp = activeXDocument.parentWindow.Object;
    activeXDocument = null; // avoid memory leak
    return temp;
  };

  // Create object with fake `null` prototype: use iframe Object with cleared prototype
  var NullProtoObjectViaIFrame = function () {
    // Thrash, waste and sodomy: IE GC bug
    var iframe = documentCreateElement$1('iframe');
    var JS = 'java' + SCRIPT + ':';
    var iframeDocument;
    iframe.style.display = 'none';
    html$1.appendChild(iframe);
    // https://github.com/zloirock/core-js/issues/475
    iframe.src = String(JS);
    iframeDocument = iframe.contentWindow.document;
    iframeDocument.open();
    iframeDocument.write(scriptTag('document.F=Object'));
    iframeDocument.close();
    return iframeDocument.F;
  };

  // Check for document.domain and active x support
  // No need to use active x approach when document.domain is not set
  // see https://github.com/es-shims/es5-shim/issues/150
  // variation of https://github.com/kitcambridge/es5-shim/commit/4f738ac066346
  // avoid IE GC bug
  var activeXDocument;
  var NullProtoObject = function () {
    try {
      activeXDocument = new ActiveXObject('htmlfile');
    } catch (error) { /* ignore */ }
    NullProtoObject = typeof document != 'undefined'
      ? document.domain && activeXDocument
        ? NullProtoObjectViaActiveX(activeXDocument) // old IE
        : NullProtoObjectViaIFrame()
      : NullProtoObjectViaActiveX(activeXDocument); // WSH
    var length = enumBugKeys.length;
    while (length--) delete NullProtoObject[PROTOTYPE][enumBugKeys[length]];
    return NullProtoObject();
  };

  hiddenKeys$1[IE_PROTO$1] = true;

  // `Object.create` method
  // https://tc39.es/ecma262/#sec-object.create
  var objectCreate = Object.create || function create(O, Properties) {
    var result;
    if (O !== null) {
      EmptyConstructor[PROTOTYPE] = anObject$9(O);
      result = new EmptyConstructor();
      EmptyConstructor[PROTOTYPE] = null;
      // add "__proto__" for Object.getPrototypeOf polyfill
      result[IE_PROTO$1] = O;
    } else result = NullProtoObject();
    return Properties === undefined ? result : definePropertiesModule.f(result, Properties);
  };

  var fails$h = fails$q;
  var global$p = global$N;

  // babel-minify and Closure Compiler transpiles RegExp('.', 's') -> /./s and it causes SyntaxError
  var $RegExp$1 = global$p.RegExp;

  var regexpUnsupportedDotAll = fails$h(function () {
    var re = $RegExp$1('.', 's');
    return !(re.dotAll && re.exec('\n') && re.flags === 's');
  });

  var fails$g = fails$q;
  var global$o = global$N;

  // babel-minify and Closure Compiler transpiles RegExp('(?<a>b)', 'g') -> /(?<a>b)/g and it causes SyntaxError
  var $RegExp = global$o.RegExp;

  var regexpUnsupportedNcg = fails$g(function () {
    var re = $RegExp('(?<a>b)', 'g');
    return re.exec('b').groups.a !== 'b' ||
      'b'.replace(re, '$<a>c') !== 'bc';
  });

  /* eslint-disable regexp/no-empty-capturing-group, regexp/no-empty-group, regexp/no-lazy-ends -- testing */
  /* eslint-disable regexp/no-useless-quantifier -- testing */
  var call$9 = functionCall;
  var uncurryThis$f = functionUncurryThis;
  var toString$6 = toString$7;
  var regexpFlags = regexpFlags$1;
  var stickyHelpers$1 = regexpStickyHelpers;
  var shared = shared$4.exports;
  var create$2 = objectCreate;
  var getInternalState$3 = internalState.get;
  var UNSUPPORTED_DOT_ALL = regexpUnsupportedDotAll;
  var UNSUPPORTED_NCG = regexpUnsupportedNcg;

  var nativeReplace = shared('native-string-replace', String.prototype.replace);
  var nativeExec = RegExp.prototype.exec;
  var patchedExec = nativeExec;
  var charAt$3 = uncurryThis$f(''.charAt);
  var indexOf = uncurryThis$f(''.indexOf);
  var replace$1 = uncurryThis$f(''.replace);
  var stringSlice$2 = uncurryThis$f(''.slice);

  var UPDATES_LAST_INDEX_WRONG = (function () {
    var re1 = /a/;
    var re2 = /b*/g;
    call$9(nativeExec, re1, 'a');
    call$9(nativeExec, re2, 'a');
    return re1.lastIndex !== 0 || re2.lastIndex !== 0;
  })();

  var UNSUPPORTED_Y$1 = stickyHelpers$1.BROKEN_CARET;

  // nonparticipating capturing group, copied from es5-shim's String#split patch.
  var NPCG_INCLUDED = /()??/.exec('')[1] !== undefined;

  var PATCH = UPDATES_LAST_INDEX_WRONG || NPCG_INCLUDED || UNSUPPORTED_Y$1 || UNSUPPORTED_DOT_ALL || UNSUPPORTED_NCG;

  if (PATCH) {
    patchedExec = function exec(string) {
      var re = this;
      var state = getInternalState$3(re);
      var str = toString$6(string);
      var raw = state.raw;
      var result, reCopy, lastIndex, match, i, object, group;

      if (raw) {
        raw.lastIndex = re.lastIndex;
        result = call$9(patchedExec, raw, str);
        re.lastIndex = raw.lastIndex;
        return result;
      }

      var groups = state.groups;
      var sticky = UNSUPPORTED_Y$1 && re.sticky;
      var flags = call$9(regexpFlags, re);
      var source = re.source;
      var charsAdded = 0;
      var strCopy = str;

      if (sticky) {
        flags = replace$1(flags, 'y', '');
        if (indexOf(flags, 'g') === -1) {
          flags += 'g';
        }

        strCopy = stringSlice$2(str, re.lastIndex);
        // Support anchored sticky behavior.
        if (re.lastIndex > 0 && (!re.multiline || re.multiline && charAt$3(str, re.lastIndex - 1) !== '\n')) {
          source = '(?: ' + source + ')';
          strCopy = ' ' + strCopy;
          charsAdded++;
        }
        // ^(? + rx + ) is needed, in combination with some str slicing, to
        // simulate the 'y' flag.
        reCopy = new RegExp('^(?:' + source + ')', flags);
      }

      if (NPCG_INCLUDED) {
        reCopy = new RegExp('^' + source + '$(?!\\s)', flags);
      }
      if (UPDATES_LAST_INDEX_WRONG) lastIndex = re.lastIndex;

      match = call$9(nativeExec, sticky ? reCopy : re, strCopy);

      if (sticky) {
        if (match) {
          match.input = stringSlice$2(match.input, charsAdded);
          match[0] = stringSlice$2(match[0], charsAdded);
          match.index = re.lastIndex;
          re.lastIndex += match[0].length;
        } else re.lastIndex = 0;
      } else if (UPDATES_LAST_INDEX_WRONG && match) {
        re.lastIndex = re.global ? match.index + match[0].length : lastIndex;
      }
      if (NPCG_INCLUDED && match && match.length > 1) {
        // Fix browsers whose `exec` methods don't consistently return `undefined`
        // for NPCG, like IE8. NOTE: This doesn' work for /(.?)?/
        call$9(nativeReplace, match[0], reCopy, function () {
          for (i = 1; i < arguments.length - 2; i++) {
            if (arguments[i] === undefined) match[i] = undefined;
          }
        });
      }

      if (match && groups) {
        match.groups = object = create$2(null);
        for (i = 0; i < groups.length; i++) {
          group = groups[i];
          object[group[0]] = match[group[1]];
        }
      }

      return match;
    };
  }

  var regexpExec$3 = patchedExec;

  var $$d = _export;
  var exec$2 = regexpExec$3;

  // `RegExp.prototype.exec` method
  // https://tc39.es/ecma262/#sec-regexp.prototype.exec
  $$d({ target: 'RegExp', proto: true, forced: /./.exec !== exec$2 }, {
    exec: exec$2
  });

  var NATIVE_BIND$1 = functionBindNative;

  var FunctionPrototype = Function.prototype;
  var apply$3 = FunctionPrototype.apply;
  var call$8 = FunctionPrototype.call;

  // eslint-disable-next-line es/no-reflect -- safe
  var functionApply = typeof Reflect == 'object' && Reflect.apply || (NATIVE_BIND$1 ? call$8.bind(apply$3) : function () {
    return call$8.apply(apply$3, arguments);
  });

  // TODO: Remove from `core-js@4` since it's moved to entry points

  var uncurryThis$e = functionUncurryThis;
  var redefine$7 = redefine$9.exports;
  var regexpExec$2 = regexpExec$3;
  var fails$f = fails$q;
  var wellKnownSymbol$g = wellKnownSymbol$k;
  var createNonEnumerableProperty$4 = createNonEnumerableProperty$8;

  var SPECIES$6 = wellKnownSymbol$g('species');
  var RegExpPrototype = RegExp.prototype;

  var fixRegexpWellKnownSymbolLogic = function (KEY, exec, FORCED, SHAM) {
    var SYMBOL = wellKnownSymbol$g(KEY);

    var DELEGATES_TO_SYMBOL = !fails$f(function () {
      // String methods call symbol-named RegEp methods
      var O = {};
      O[SYMBOL] = function () { return 7; };
      return ''[KEY](O) != 7;
    });

    var DELEGATES_TO_EXEC = DELEGATES_TO_SYMBOL && !fails$f(function () {
      // Symbol-named RegExp methods call .exec
      var execCalled = false;
      var re = /a/;

      if (KEY === 'split') {
        // We can't use real regex here since it causes deoptimization
        // and serious performance degradation in V8
        // https://github.com/zloirock/core-js/issues/306
        re = {};
        // RegExp[@@split] doesn't call the regex's exec method, but first creates
        // a new one. We need to return the patched regex when creating the new one.
        re.constructor = {};
        re.constructor[SPECIES$6] = function () { return re; };
        re.flags = '';
        re[SYMBOL] = /./[SYMBOL];
      }

      re.exec = function () { execCalled = true; return null; };

      re[SYMBOL]('');
      return !execCalled;
    });

    if (
      !DELEGATES_TO_SYMBOL ||
      !DELEGATES_TO_EXEC ||
      FORCED
    ) {
      var uncurriedNativeRegExpMethod = uncurryThis$e(/./[SYMBOL]);
      var methods = exec(SYMBOL, ''[KEY], function (nativeMethod, regexp, str, arg2, forceStringMethod) {
        var uncurriedNativeMethod = uncurryThis$e(nativeMethod);
        var $exec = regexp.exec;
        if ($exec === regexpExec$2 || $exec === RegExpPrototype.exec) {
          if (DELEGATES_TO_SYMBOL && !forceStringMethod) {
            // The native String method already delegates to @@method (this
            // polyfilled function), leasing to infinite recursion.
            // We avoid it by directly calling the native @@method method.
            return { done: true, value: uncurriedNativeRegExpMethod(regexp, str, arg2) };
          }
          return { done: true, value: uncurriedNativeMethod(str, regexp, arg2) };
        }
        return { done: false };
      });

      redefine$7(String.prototype, KEY, methods[0]);
      redefine$7(RegExpPrototype, SYMBOL, methods[1]);
    }

    if (SHAM) createNonEnumerableProperty$4(RegExpPrototype[SYMBOL], 'sham', true);
  };

  var isObject$c = isObject$i;
  var classof$8 = classofRaw$1;
  var wellKnownSymbol$f = wellKnownSymbol$k;

  var MATCH = wellKnownSymbol$f('match');

  // `IsRegExp` abstract operation
  // https://tc39.es/ecma262/#sec-isregexp
  var isRegexp = function (it) {
    var isRegExp;
    return isObject$c(it) && ((isRegExp = it[MATCH]) !== undefined ? !!isRegExp : classof$8(it) == 'RegExp');
  };

  var uncurryThis$d = functionUncurryThis;
  var fails$e = fails$q;
  var isCallable$a = isCallable$l;
  var classof$7 = classof$a;
  var getBuiltIn$4 = getBuiltIn$9;
  var inspectSource$1 = inspectSource$4;

  var noop = function () { /* empty */ };
  var empty = [];
  var construct = getBuiltIn$4('Reflect', 'construct');
  var constructorRegExp = /^\s*(?:class|function)\b/;
  var exec$1 = uncurryThis$d(constructorRegExp.exec);
  var INCORRECT_TO_STRING = !constructorRegExp.exec(noop);

  var isConstructorModern = function isConstructor(argument) {
    if (!isCallable$a(argument)) return false;
    try {
      construct(noop, empty, argument);
      return true;
    } catch (error) {
      return false;
    }
  };

  var isConstructorLegacy = function isConstructor(argument) {
    if (!isCallable$a(argument)) return false;
    switch (classof$7(argument)) {
      case 'AsyncFunction':
      case 'GeneratorFunction':
      case 'AsyncGeneratorFunction': return false;
    }
    try {
      // we can't check .prototype since constructors produced by .bind haven't it
      // `Function#toString` throws on some built-it function in some legacy engines
      // (for example, `DOMQuad` and similar in FF41-)
      return INCORRECT_TO_STRING || !!exec$1(constructorRegExp, inspectSource$1(argument));
    } catch (error) {
      return true;
    }
  };

  isConstructorLegacy.sham = true;

  // `IsConstructor` abstract operation
  // https://tc39.es/ecma262/#sec-isconstructor
  var isConstructor$3 = !construct || fails$e(function () {
    var called;
    return isConstructorModern(isConstructorModern.call)
      || !isConstructorModern(Object)
      || !isConstructorModern(function () { called = true; })
      || called;
  }) ? isConstructorLegacy : isConstructorModern;

  var global$n = global$N;
  var isConstructor$2 = isConstructor$3;
  var tryToString$2 = tryToString$4;

  var TypeError$9 = global$n.TypeError;

  // `Assert: IsConstructor(argument) is true`
  var aConstructor$1 = function (argument) {
    if (isConstructor$2(argument)) return argument;
    throw TypeError$9(tryToString$2(argument) + ' is not a constructor');
  };

  var anObject$8 = anObject$e;
  var aConstructor = aConstructor$1;
  var wellKnownSymbol$e = wellKnownSymbol$k;

  var SPECIES$5 = wellKnownSymbol$e('species');

  // `SpeciesConstructor` abstract operation
  // https://tc39.es/ecma262/#sec-speciesconstructor
  var speciesConstructor$3 = function (O, defaultConstructor) {
    var C = anObject$8(O).constructor;
    var S;
    return C === undefined || (S = anObject$8(C)[SPECIES$5]) == undefined ? defaultConstructor : aConstructor(S);
  };

  var uncurryThis$c = functionUncurryThis;
  var toIntegerOrInfinity = toIntegerOrInfinity$3;
  var toString$5 = toString$7;
  var requireObjectCoercible$1 = requireObjectCoercible$4;

  var charAt$2 = uncurryThis$c(''.charAt);
  var charCodeAt = uncurryThis$c(''.charCodeAt);
  var stringSlice$1 = uncurryThis$c(''.slice);

  var createMethod$1 = function (CONVERT_TO_STRING) {
    return function ($this, pos) {
      var S = toString$5(requireObjectCoercible$1($this));
      var position = toIntegerOrInfinity(pos);
      var size = S.length;
      var first, second;
      if (position < 0 || position >= size) return CONVERT_TO_STRING ? '' : undefined;
      first = charCodeAt(S, position);
      return first < 0xD800 || first > 0xDBFF || position + 1 === size
        || (second = charCodeAt(S, position + 1)) < 0xDC00 || second > 0xDFFF
          ? CONVERT_TO_STRING
            ? charAt$2(S, position)
            : first
          : CONVERT_TO_STRING
            ? stringSlice$1(S, position, position + 2)
            : (first - 0xD800 << 10) + (second - 0xDC00) + 0x10000;
    };
  };

  var stringMultibyte = {
    // `String.prototype.codePointAt` method
    // https://tc39.es/ecma262/#sec-string.prototype.codepointat
    codeAt: createMethod$1(false),
    // `String.prototype.at` method
    // https://github.com/mathiasbynens/String.prototype.at
    charAt: createMethod$1(true)
  };

  var charAt$1 = stringMultibyte.charAt;

  // `AdvanceStringIndex` abstract operation
  // https://tc39.es/ecma262/#sec-advancestringindex
  var advanceStringIndex$1 = function (S, index, unicode) {
    return index + (unicode ? charAt$1(S, index).length : 1);
  };

  var toPropertyKey = toPropertyKey$3;
  var definePropertyModule$2 = objectDefineProperty;
  var createPropertyDescriptor$2 = createPropertyDescriptor$5;

  var createProperty$3 = function (object, key, value) {
    var propertyKey = toPropertyKey(key);
    if (propertyKey in object) definePropertyModule$2.f(object, propertyKey, createPropertyDescriptor$2(0, value));
    else object[propertyKey] = value;
  };

  var global$m = global$N;
  var toAbsoluteIndex$1 = toAbsoluteIndex$3;
  var lengthOfArrayLike$5 = lengthOfArrayLike$7;
  var createProperty$2 = createProperty$3;

  var Array$3 = global$m.Array;
  var max$1 = Math.max;

  var arraySliceSimple = function (O, start, end) {
    var length = lengthOfArrayLike$5(O);
    var k = toAbsoluteIndex$1(start, length);
    var fin = toAbsoluteIndex$1(end === undefined ? length : end, length);
    var result = Array$3(max$1(fin - k, 0));
    for (var n = 0; k < fin; k++, n++) createProperty$2(result, n, O[k]);
    result.length = n;
    return result;
  };

  var global$l = global$N;
  var call$7 = functionCall;
  var anObject$7 = anObject$e;
  var isCallable$9 = isCallable$l;
  var classof$6 = classofRaw$1;
  var regexpExec$1 = regexpExec$3;

  var TypeError$8 = global$l.TypeError;

  // `RegExpExec` abstract operation
  // https://tc39.es/ecma262/#sec-regexpexec
  var regexpExecAbstract = function (R, S) {
    var exec = R.exec;
    if (isCallable$9(exec)) {
      var result = call$7(exec, R, S);
      if (result !== null) anObject$7(result);
      return result;
    }
    if (classof$6(R) === 'RegExp') return call$7(regexpExec$1, R, S);
    throw TypeError$8('RegExp#exec called on incompatible receiver');
  };

  var apply$2 = functionApply;
  var call$6 = functionCall;
  var uncurryThis$b = functionUncurryThis;
  var fixRegExpWellKnownSymbolLogic = fixRegexpWellKnownSymbolLogic;
  var isRegExp = isRegexp;
  var anObject$6 = anObject$e;
  var requireObjectCoercible = requireObjectCoercible$4;
  var speciesConstructor$2 = speciesConstructor$3;
  var advanceStringIndex = advanceStringIndex$1;
  var toLength = toLength$2;
  var toString$4 = toString$7;
  var getMethod$2 = getMethod$4;
  var arraySlice$4 = arraySliceSimple;
  var callRegExpExec = regexpExecAbstract;
  var regexpExec = regexpExec$3;
  var stickyHelpers = regexpStickyHelpers;
  var fails$d = fails$q;

  var UNSUPPORTED_Y = stickyHelpers.UNSUPPORTED_Y;
  var MAX_UINT32 = 0xFFFFFFFF;
  var min = Math.min;
  var $push = [].push;
  var exec = uncurryThis$b(/./.exec);
  var push$2 = uncurryThis$b($push);
  var stringSlice = uncurryThis$b(''.slice);

  // Chrome 51 has a buggy "split" implementation when RegExp#exec !== nativeExec
  // Weex JS has frozen built-in prototypes, so use try / catch wrapper
  var SPLIT_WORKS_WITH_OVERWRITTEN_EXEC = !fails$d(function () {
    // eslint-disable-next-line regexp/no-empty-group -- required for testing
    var re = /(?:)/;
    var originalExec = re.exec;
    re.exec = function () { return originalExec.apply(this, arguments); };
    var result = 'ab'.split(re);
    return result.length !== 2 || result[0] !== 'a' || result[1] !== 'b';
  });

  // @@split logic
  fixRegExpWellKnownSymbolLogic('split', function (SPLIT, nativeSplit, maybeCallNative) {
    var internalSplit;
    if (
      'abbc'.split(/(b)*/)[1] == 'c' ||
      // eslint-disable-next-line regexp/no-empty-group -- required for testing
      'test'.split(/(?:)/, -1).length != 4 ||
      'ab'.split(/(?:ab)*/).length != 2 ||
      '.'.split(/(.?)(.?)/).length != 4 ||
      // eslint-disable-next-line regexp/no-empty-capturing-group, regexp/no-empty-group -- required for testing
      '.'.split(/()()/).length > 1 ||
      ''.split(/.?/).length
    ) {
      // based on es5-shim implementation, need to rework it
      internalSplit = function (separator, limit) {
        var string = toString$4(requireObjectCoercible(this));
        var lim = limit === undefined ? MAX_UINT32 : limit >>> 0;
        if (lim === 0) return [];
        if (separator === undefined) return [string];
        // If `separator` is not a regex, use native split
        if (!isRegExp(separator)) {
          return call$6(nativeSplit, string, separator, lim);
        }
        var output = [];
        var flags = (separator.ignoreCase ? 'i' : '') +
                    (separator.multiline ? 'm' : '') +
                    (separator.unicode ? 'u' : '') +
                    (separator.sticky ? 'y' : '');
        var lastLastIndex = 0;
        // Make `global` and avoid `lastIndex` issues by working with a copy
        var separatorCopy = new RegExp(separator.source, flags + 'g');
        var match, lastIndex, lastLength;
        while (match = call$6(regexpExec, separatorCopy, string)) {
          lastIndex = separatorCopy.lastIndex;
          if (lastIndex > lastLastIndex) {
            push$2(output, stringSlice(string, lastLastIndex, match.index));
            if (match.length > 1 && match.index < string.length) apply$2($push, output, arraySlice$4(match, 1));
            lastLength = match[0].length;
            lastLastIndex = lastIndex;
            if (output.length >= lim) break;
          }
          if (separatorCopy.lastIndex === match.index) separatorCopy.lastIndex++; // Avoid an infinite loop
        }
        if (lastLastIndex === string.length) {
          if (lastLength || !exec(separatorCopy, '')) push$2(output, '');
        } else push$2(output, stringSlice(string, lastLastIndex));
        return output.length > lim ? arraySlice$4(output, 0, lim) : output;
      };
    // Chakra, V8
    } else if ('0'.split(undefined, 0).length) {
      internalSplit = function (separator, limit) {
        return separator === undefined && limit === 0 ? [] : call$6(nativeSplit, this, separator, limit);
      };
    } else internalSplit = nativeSplit;

    return [
      // `String.prototype.split` method
      // https://tc39.es/ecma262/#sec-string.prototype.split
      function split(separator, limit) {
        var O = requireObjectCoercible(this);
        var splitter = separator == undefined ? undefined : getMethod$2(separator, SPLIT);
        return splitter
          ? call$6(splitter, separator, O, limit)
          : call$6(internalSplit, toString$4(O), separator, limit);
      },
      // `RegExp.prototype[@@split]` method
      // https://tc39.es/ecma262/#sec-regexp.prototype-@@split
      //
      // NOTE: This cannot be properly polyfilled in engines that don't support
      // the 'y' flag.
      function (string, limit) {
        var rx = anObject$6(this);
        var S = toString$4(string);
        var res = maybeCallNative(internalSplit, rx, S, limit, internalSplit !== nativeSplit);

        if (res.done) return res.value;

        var C = speciesConstructor$2(rx, RegExp);

        var unicodeMatching = rx.unicode;
        var flags = (rx.ignoreCase ? 'i' : '') +
                    (rx.multiline ? 'm' : '') +
                    (rx.unicode ? 'u' : '') +
                    (UNSUPPORTED_Y ? 'g' : 'y');

        // ^(? + rx + ) is needed, in combination with some S slicing, to
        // simulate the 'y' flag.
        var splitter = new C(UNSUPPORTED_Y ? '^(?:' + rx.source + ')' : rx, flags);
        var lim = limit === undefined ? MAX_UINT32 : limit >>> 0;
        if (lim === 0) return [];
        if (S.length === 0) return callRegExpExec(splitter, S) === null ? [S] : [];
        var p = 0;
        var q = 0;
        var A = [];
        while (q < S.length) {
          splitter.lastIndex = UNSUPPORTED_Y ? 0 : q;
          var z = callRegExpExec(splitter, UNSUPPORTED_Y ? stringSlice(S, q) : S);
          var e;
          if (
            z === null ||
            (e = min(toLength(splitter.lastIndex + (UNSUPPORTED_Y ? q : 0)), S.length)) === p
          ) {
            q = advanceStringIndex(S, q, unicodeMatching);
          } else {
            push$2(A, stringSlice(S, p, q));
            if (A.length === lim) return A;
            for (var i = 1; i <= z.length - 1; i++) {
              push$2(A, z[i]);
              if (A.length === lim) return A;
            }
            q = p = e;
          }
        }
        push$2(A, stringSlice(S, p));
        return A;
      }
    ];
  }, !SPLIT_WORKS_WITH_OVERWRITTEN_EXEC, UNSUPPORTED_Y);

  var classof$5 = classofRaw$1;

  // `IsArray` abstract operation
  // https://tc39.es/ecma262/#sec-isarray
  // eslint-disable-next-line es/no-array-isarray -- safe
  var isArray$3 = Array.isArray || function isArray(argument) {
    return classof$5(argument) == 'Array';
  };

  var fails$c = fails$q;
  var wellKnownSymbol$d = wellKnownSymbol$k;
  var V8_VERSION$2 = engineV8Version;

  var SPECIES$4 = wellKnownSymbol$d('species');

  var arrayMethodHasSpeciesSupport$2 = function (METHOD_NAME) {
    // We can't use this feature detection in V8 since it causes
    // deoptimization and serious performance degradation
    // https://github.com/zloirock/core-js/issues/677
    return V8_VERSION$2 >= 51 || !fails$c(function () {
      var array = [];
      var constructor = array.constructor = {};
      constructor[SPECIES$4] = function () {
        return { foo: 1 };
      };
      return array[METHOD_NAME](Boolean).foo !== 1;
    });
  };

  var uncurryThis$a = functionUncurryThis;

  var arraySlice$3 = uncurryThis$a([].slice);

  var $$c = _export;
  var global$k = global$N;
  var isArray$2 = isArray$3;
  var isConstructor$1 = isConstructor$3;
  var isObject$b = isObject$i;
  var toAbsoluteIndex = toAbsoluteIndex$3;
  var lengthOfArrayLike$4 = lengthOfArrayLike$7;
  var toIndexedObject$3 = toIndexedObject$8;
  var createProperty$1 = createProperty$3;
  var wellKnownSymbol$c = wellKnownSymbol$k;
  var arrayMethodHasSpeciesSupport$1 = arrayMethodHasSpeciesSupport$2;
  var un$Slice = arraySlice$3;

  var HAS_SPECIES_SUPPORT = arrayMethodHasSpeciesSupport$1('slice');

  var SPECIES$3 = wellKnownSymbol$c('species');
  var Array$2 = global$k.Array;
  var max = Math.max;

  // `Array.prototype.slice` method
  // https://tc39.es/ecma262/#sec-array.prototype.slice
  // fallback for not array-like ES3 strings and DOM objects
  $$c({ target: 'Array', proto: true, forced: !HAS_SPECIES_SUPPORT }, {
    slice: function slice(start, end) {
      var O = toIndexedObject$3(this);
      var length = lengthOfArrayLike$4(O);
      var k = toAbsoluteIndex(start, length);
      var fin = toAbsoluteIndex(end === undefined ? length : end, length);
      // inline `ArraySpeciesCreate` for usage native `Array#slice` where it's possible
      var Constructor, result, n;
      if (isArray$2(O)) {
        Constructor = O.constructor;
        // cross-realm fallback
        if (isConstructor$1(Constructor) && (Constructor === Array$2 || isArray$2(Constructor.prototype))) {
          Constructor = undefined;
        } else if (isObject$b(Constructor)) {
          Constructor = Constructor[SPECIES$3];
          if (Constructor === null) Constructor = undefined;
        }
        if (Constructor === Array$2 || Constructor === undefined) {
          return un$Slice(O, k, fin);
        }
      }
      result = new (Constructor === undefined ? Array$2 : Constructor)(max(fin - k, 0));
      for (n = 0; k < fin; k++, n++) if (k in O) createProperty$1(result, n, O[k]);
      result.length = n;
      return result;
    }
  });

  var $$b = _export;
  var call$5 = functionCall;

  // `URL.prototype.toJSON` method
  // https://url.spec.whatwg.org/#dom-url-tojson
  $$b({ target: 'URL', proto: true, enumerable: true }, {
    toJSON: function toJSON() {
      return call$5(URL.prototype.toString, this);
    }
  });

  var TO_STRING_TAG_SUPPORT$1 = toStringTagSupport;
  var classof$4 = classof$a;

  // `Object.prototype.toString` method implementation
  // https://tc39.es/ecma262/#sec-object.prototype.tostring
  var objectToString = TO_STRING_TAG_SUPPORT$1 ? {}.toString : function toString() {
    return '[object ' + classof$4(this) + ']';
  };

  var TO_STRING_TAG_SUPPORT = toStringTagSupport;
  var redefine$6 = redefine$9.exports;
  var toString$3 = objectToString;

  // `Object.prototype.toString` method
  // https://tc39.es/ecma262/#sec-object.prototype.tostring
  if (!TO_STRING_TAG_SUPPORT) {
    redefine$6(Object.prototype, 'toString', toString$3, { unsafe: true });
  }

  var global$j = global$N;

  var nativePromiseConstructor = global$j.Promise;

  var redefine$5 = redefine$9.exports;

  var redefineAll$3 = function (target, src, options) {
    for (var key in src) redefine$5(target, key, src[key], options);
    return target;
  };

  var global$i = global$N;
  var isCallable$8 = isCallable$l;

  var String$2 = global$i.String;
  var TypeError$7 = global$i.TypeError;

  var aPossiblePrototype$1 = function (argument) {
    if (typeof argument == 'object' || isCallable$8(argument)) return argument;
    throw TypeError$7("Can't set " + String$2(argument) + ' as a prototype');
  };

  /* eslint-disable no-proto -- safe */

  var uncurryThis$9 = functionUncurryThis;
  var anObject$5 = anObject$e;
  var aPossiblePrototype = aPossiblePrototype$1;

  // `Object.setPrototypeOf` method
  // https://tc39.es/ecma262/#sec-object.setprototypeof
  // Works with __proto__ only. Old v8 can't work with null proto objects.
  // eslint-disable-next-line es/no-object-setprototypeof -- safe
  var objectSetPrototypeOf = Object.setPrototypeOf || ('__proto__' in {} ? function () {
    var CORRECT_SETTER = false;
    var test = {};
    var setter;
    try {
      // eslint-disable-next-line es/no-object-getownpropertydescriptor -- safe
      setter = uncurryThis$9(Object.getOwnPropertyDescriptor(Object.prototype, '__proto__').set);
      setter(test, []);
      CORRECT_SETTER = test instanceof Array;
    } catch (error) { /* empty */ }
    return function setPrototypeOf(O, proto) {
      anObject$5(O);
      aPossiblePrototype(proto);
      if (CORRECT_SETTER) setter(O, proto);
      else O.__proto__ = proto;
      return O;
    };
  }() : undefined);

  var defineProperty$2 = objectDefineProperty.f;
  var hasOwn$5 = hasOwnProperty_1;
  var wellKnownSymbol$b = wellKnownSymbol$k;

  var TO_STRING_TAG$1 = wellKnownSymbol$b('toStringTag');

  var setToStringTag$4 = function (target, TAG, STATIC) {
    if (target && !STATIC) target = target.prototype;
    if (target && !hasOwn$5(target, TO_STRING_TAG$1)) {
      defineProperty$2(target, TO_STRING_TAG$1, { configurable: true, value: TAG });
    }
  };

  var getBuiltIn$3 = getBuiltIn$9;
  var definePropertyModule$1 = objectDefineProperty;
  var wellKnownSymbol$a = wellKnownSymbol$k;
  var DESCRIPTORS$1 = descriptors;

  var SPECIES$2 = wellKnownSymbol$a('species');

  var setSpecies$1 = function (CONSTRUCTOR_NAME) {
    var Constructor = getBuiltIn$3(CONSTRUCTOR_NAME);
    var defineProperty = definePropertyModule$1.f;

    if (DESCRIPTORS$1 && Constructor && !Constructor[SPECIES$2]) {
      defineProperty(Constructor, SPECIES$2, {
        configurable: true,
        get: function () { return this; }
      });
    }
  };

  var global$h = global$N;
  var isPrototypeOf$2 = objectIsPrototypeOf;

  var TypeError$6 = global$h.TypeError;

  var anInstance$3 = function (it, Prototype) {
    if (isPrototypeOf$2(Prototype, it)) return it;
    throw TypeError$6('Incorrect invocation');
  };

  var uncurryThis$8 = functionUncurryThis;
  var aCallable$4 = aCallable$6;
  var NATIVE_BIND = functionBindNative;

  var bind$5 = uncurryThis$8(uncurryThis$8.bind);

  // optional / simple context binding
  var functionBindContext = function (fn, that) {
    aCallable$4(fn);
    return that === undefined ? fn : NATIVE_BIND ? bind$5(fn, that) : function (/* ...args */) {
      return fn.apply(that, arguments);
    };
  };

  var iterators = {};

  var wellKnownSymbol$9 = wellKnownSymbol$k;
  var Iterators$4 = iterators;

  var ITERATOR$5 = wellKnownSymbol$9('iterator');
  var ArrayPrototype$1 = Array.prototype;

  // check on default Array iterator
  var isArrayIteratorMethod$1 = function (it) {
    return it !== undefined && (Iterators$4.Array === it || ArrayPrototype$1[ITERATOR$5] === it);
  };

  var classof$3 = classof$a;
  var getMethod$1 = getMethod$4;
  var Iterators$3 = iterators;
  var wellKnownSymbol$8 = wellKnownSymbol$k;

  var ITERATOR$4 = wellKnownSymbol$8('iterator');

  var getIteratorMethod$2 = function (it) {
    if (it != undefined) return getMethod$1(it, ITERATOR$4)
      || getMethod$1(it, '@@iterator')
      || Iterators$3[classof$3(it)];
  };

  var global$g = global$N;
  var call$4 = functionCall;
  var aCallable$3 = aCallable$6;
  var anObject$4 = anObject$e;
  var tryToString$1 = tryToString$4;
  var getIteratorMethod$1 = getIteratorMethod$2;

  var TypeError$5 = global$g.TypeError;

  var getIterator$1 = function (argument, usingIterator) {
    var iteratorMethod = arguments.length < 2 ? getIteratorMethod$1(argument) : usingIterator;
    if (aCallable$3(iteratorMethod)) return anObject$4(call$4(iteratorMethod, argument));
    throw TypeError$5(tryToString$1(argument) + ' is not iterable');
  };

  var call$3 = functionCall;
  var anObject$3 = anObject$e;
  var getMethod = getMethod$4;

  var iteratorClose$1 = function (iterator, kind, value) {
    var innerResult, innerError;
    anObject$3(iterator);
    try {
      innerResult = getMethod(iterator, 'return');
      if (!innerResult) {
        if (kind === 'throw') throw value;
        return value;
      }
      innerResult = call$3(innerResult, iterator);
    } catch (error) {
      innerError = true;
      innerResult = error;
    }
    if (kind === 'throw') throw value;
    if (innerError) throw innerResult;
    anObject$3(innerResult);
    return value;
  };

  var global$f = global$N;
  var bind$4 = functionBindContext;
  var call$2 = functionCall;
  var anObject$2 = anObject$e;
  var tryToString = tryToString$4;
  var isArrayIteratorMethod = isArrayIteratorMethod$1;
  var lengthOfArrayLike$3 = lengthOfArrayLike$7;
  var isPrototypeOf$1 = objectIsPrototypeOf;
  var getIterator = getIterator$1;
  var getIteratorMethod = getIteratorMethod$2;
  var iteratorClose = iteratorClose$1;

  var TypeError$4 = global$f.TypeError;

  var Result = function (stopped, result) {
    this.stopped = stopped;
    this.result = result;
  };

  var ResultPrototype = Result.prototype;

  var iterate$3 = function (iterable, unboundFunction, options) {
    var that = options && options.that;
    var AS_ENTRIES = !!(options && options.AS_ENTRIES);
    var IS_ITERATOR = !!(options && options.IS_ITERATOR);
    var INTERRUPTED = !!(options && options.INTERRUPTED);
    var fn = bind$4(unboundFunction, that);
    var iterator, iterFn, index, length, result, next, step;

    var stop = function (condition) {
      if (iterator) iteratorClose(iterator, 'normal', condition);
      return new Result(true, condition);
    };

    var callFn = function (value) {
      if (AS_ENTRIES) {
        anObject$2(value);
        return INTERRUPTED ? fn(value[0], value[1], stop) : fn(value[0], value[1]);
      } return INTERRUPTED ? fn(value, stop) : fn(value);
    };

    if (IS_ITERATOR) {
      iterator = iterable;
    } else {
      iterFn = getIteratorMethod(iterable);
      if (!iterFn) throw TypeError$4(tryToString(iterable) + ' is not iterable');
      // optimisation for array iterators
      if (isArrayIteratorMethod(iterFn)) {
        for (index = 0, length = lengthOfArrayLike$3(iterable); length > index; index++) {
          result = callFn(iterable[index]);
          if (result && isPrototypeOf$1(ResultPrototype, result)) return result;
        } return new Result(false);
      }
      iterator = getIterator(iterable, iterFn);
    }

    next = iterator.next;
    while (!(step = call$2(next, iterator)).done) {
      try {
        result = callFn(step.value);
      } catch (error) {
        iteratorClose(iterator, 'throw', error);
      }
      if (typeof result == 'object' && result && isPrototypeOf$1(ResultPrototype, result)) return result;
    } return new Result(false);
  };

  var wellKnownSymbol$7 = wellKnownSymbol$k;

  var ITERATOR$3 = wellKnownSymbol$7('iterator');
  var SAFE_CLOSING = false;

  try {
    var called = 0;
    var iteratorWithReturn = {
      next: function () {
        return { done: !!called++ };
      },
      'return': function () {
        SAFE_CLOSING = true;
      }
    };
    iteratorWithReturn[ITERATOR$3] = function () {
      return this;
    };
    // eslint-disable-next-line es/no-array-from, no-throw-literal -- required for testing
    Array.from(iteratorWithReturn, function () { throw 2; });
  } catch (error) { /* empty */ }

  var checkCorrectnessOfIteration$2 = function (exec, SKIP_CLOSING) {
    if (!SKIP_CLOSING && !SAFE_CLOSING) return false;
    var ITERATION_SUPPORT = false;
    try {
      var object = {};
      object[ITERATOR$3] = function () {
        return {
          next: function () {
            return { done: ITERATION_SUPPORT = true };
          }
        };
      };
      exec(object);
    } catch (error) { /* empty */ }
    return ITERATION_SUPPORT;
  };

  var global$e = global$N;

  var TypeError$3 = global$e.TypeError;

  var validateArgumentsLength$1 = function (passed, required) {
    if (passed < required) throw TypeError$3('Not enough arguments');
    return passed;
  };

  var userAgent$4 = engineUserAgent;

  var engineIsIos = /(?:ipad|iphone|ipod).*applewebkit/i.test(userAgent$4);

  var classof$2 = classofRaw$1;
  var global$d = global$N;

  var engineIsNode = classof$2(global$d.process) == 'process';

  var global$c = global$N;
  var apply$1 = functionApply;
  var bind$3 = functionBindContext;
  var isCallable$7 = isCallable$l;
  var hasOwn$4 = hasOwnProperty_1;
  var fails$b = fails$q;
  var html = html$2;
  var arraySlice$2 = arraySlice$3;
  var createElement = documentCreateElement$2;
  var validateArgumentsLength = validateArgumentsLength$1;
  var IS_IOS$1 = engineIsIos;
  var IS_NODE$2 = engineIsNode;

  var set = global$c.setImmediate;
  var clear = global$c.clearImmediate;
  var process$3 = global$c.process;
  var Dispatch = global$c.Dispatch;
  var Function$1 = global$c.Function;
  var MessageChannel$1 = global$c.MessageChannel;
  var String$1 = global$c.String;
  var counter = 0;
  var queue$1 = {};
  var ONREADYSTATECHANGE = 'onreadystatechange';
  var location, defer, channel, port;

  try {
    // Deno throws a ReferenceError on `location` access without `--location` flag
    location = global$c.location;
  } catch (error) { /* empty */ }

  var run = function (id) {
    if (hasOwn$4(queue$1, id)) {
      var fn = queue$1[id];
      delete queue$1[id];
      fn();
    }
  };

  var runner = function (id) {
    return function () {
      run(id);
    };
  };

  var listener = function (event) {
    run(event.data);
  };

  var post = function (id) {
    // old engines have not location.origin
    global$c.postMessage(String$1(id), location.protocol + '//' + location.host);
  };

  // Node.js 0.9+ & IE10+ has setImmediate, otherwise:
  if (!set || !clear) {
    set = function setImmediate(handler) {
      validateArgumentsLength(arguments.length, 1);
      var fn = isCallable$7(handler) ? handler : Function$1(handler);
      var args = arraySlice$2(arguments, 1);
      queue$1[++counter] = function () {
        apply$1(fn, undefined, args);
      };
      defer(counter);
      return counter;
    };
    clear = function clearImmediate(id) {
      delete queue$1[id];
    };
    // Node.js 0.8-
    if (IS_NODE$2) {
      defer = function (id) {
        process$3.nextTick(runner(id));
      };
    // Sphere (JS game engine) Dispatch API
    } else if (Dispatch && Dispatch.now) {
      defer = function (id) {
        Dispatch.now(runner(id));
      };
    // Browsers with MessageChannel, includes WebWorkers
    // except iOS - https://github.com/zloirock/core-js/issues/624
    } else if (MessageChannel$1 && !IS_IOS$1) {
      channel = new MessageChannel$1();
      port = channel.port2;
      channel.port1.onmessage = listener;
      defer = bind$3(port.postMessage, port);
    // Browsers with postMessage, skip WebWorkers
    // IE8 has postMessage, but it's sync & typeof its postMessage is 'object'
    } else if (
      global$c.addEventListener &&
      isCallable$7(global$c.postMessage) &&
      !global$c.importScripts &&
      location && location.protocol !== 'file:' &&
      !fails$b(post)
    ) {
      defer = post;
      global$c.addEventListener('message', listener, false);
    // IE8-
    } else if (ONREADYSTATECHANGE in createElement('script')) {
      defer = function (id) {
        html.appendChild(createElement('script'))[ONREADYSTATECHANGE] = function () {
          html.removeChild(this);
          run(id);
        };
      };
    // Rest old browsers
    } else {
      defer = function (id) {
        setTimeout(runner(id), 0);
      };
    }
  }

  var task$1 = {
    set: set,
    clear: clear
  };

  var userAgent$3 = engineUserAgent;
  var global$b = global$N;

  var engineIsIosPebble = /ipad|iphone|ipod/i.test(userAgent$3) && global$b.Pebble !== undefined;

  var userAgent$2 = engineUserAgent;

  var engineIsWebosWebkit = /web0s(?!.*chrome)/i.test(userAgent$2);

  var global$a = global$N;
  var bind$2 = functionBindContext;
  var getOwnPropertyDescriptor = objectGetOwnPropertyDescriptor.f;
  var macrotask = task$1.set;
  var IS_IOS = engineIsIos;
  var IS_IOS_PEBBLE = engineIsIosPebble;
  var IS_WEBOS_WEBKIT = engineIsWebosWebkit;
  var IS_NODE$1 = engineIsNode;

  var MutationObserver = global$a.MutationObserver || global$a.WebKitMutationObserver;
  var document$2 = global$a.document;
  var process$2 = global$a.process;
  var Promise$1 = global$a.Promise;
  // Node.js 11 shows ExperimentalWarning on getting `queueMicrotask`
  var queueMicrotaskDescriptor = getOwnPropertyDescriptor(global$a, 'queueMicrotask');
  var queueMicrotask = queueMicrotaskDescriptor && queueMicrotaskDescriptor.value;

  var flush, head, last, notify$1, toggle, node, promise, then;

  // modern engines have queueMicrotask method
  if (!queueMicrotask) {
    flush = function () {
      var parent, fn;
      if (IS_NODE$1 && (parent = process$2.domain)) parent.exit();
      while (head) {
        fn = head.fn;
        head = head.next;
        try {
          fn();
        } catch (error) {
          if (head) notify$1();
          else last = undefined;
          throw error;
        }
      } last = undefined;
      if (parent) parent.enter();
    };

    // browsers with MutationObserver, except iOS - https://github.com/zloirock/core-js/issues/339
    // also except WebOS Webkit https://github.com/zloirock/core-js/issues/898
    if (!IS_IOS && !IS_NODE$1 && !IS_WEBOS_WEBKIT && MutationObserver && document$2) {
      toggle = true;
      node = document$2.createTextNode('');
      new MutationObserver(flush).observe(node, { characterData: true });
      notify$1 = function () {
        node.data = toggle = !toggle;
      };
    // environments with maybe non-completely correct, but existent Promise
    } else if (!IS_IOS_PEBBLE && Promise$1 && Promise$1.resolve) {
      // Promise.resolve without an argument throws an error in LG WebOS 2
      promise = Promise$1.resolve(undefined);
      // workaround of WebKit ~ iOS Safari 10.1 bug
      promise.constructor = Promise$1;
      then = bind$2(promise.then, promise);
      notify$1 = function () {
        then(flush);
      };
    // Node.js without promises
    } else if (IS_NODE$1) {
      notify$1 = function () {
        process$2.nextTick(flush);
      };
    // for other environments - macrotask based on:
    // - setImmediate
    // - MessageChannel
    // - window.postMessag
    // - onreadystatechange
    // - setTimeout
    } else {
      // strange IE + webpack dev server bug - use .bind(global)
      macrotask = bind$2(macrotask, global$a);
      notify$1 = function () {
        macrotask(flush);
      };
    }
  }

  var microtask$1 = queueMicrotask || function (fn) {
    var task = { fn: fn, next: undefined };
    if (last) last.next = task;
    if (!head) {
      head = task;
      notify$1();
    } last = task;
  };

  var newPromiseCapability$2 = {};

  var aCallable$2 = aCallable$6;

  var PromiseCapability = function (C) {
    var resolve, reject;
    this.promise = new C(function ($$resolve, $$reject) {
      if (resolve !== undefined || reject !== undefined) throw TypeError('Bad Promise constructor');
      resolve = $$resolve;
      reject = $$reject;
    });
    this.resolve = aCallable$2(resolve);
    this.reject = aCallable$2(reject);
  };

  // `NewPromiseCapability` abstract operation
  // https://tc39.es/ecma262/#sec-newpromisecapability
  newPromiseCapability$2.f = function (C) {
    return new PromiseCapability(C);
  };

  var anObject$1 = anObject$e;
  var isObject$a = isObject$i;
  var newPromiseCapability$1 = newPromiseCapability$2;

  var promiseResolve$2 = function (C, x) {
    anObject$1(C);
    if (isObject$a(x) && x.constructor === C) return x;
    var promiseCapability = newPromiseCapability$1.f(C);
    var resolve = promiseCapability.resolve;
    resolve(x);
    return promiseCapability.promise;
  };

  var global$9 = global$N;

  var hostReportErrors$1 = function (a, b) {
    var console = global$9.console;
    if (console && console.error) {
      arguments.length == 1 ? console.error(a) : console.error(a, b);
    }
  };

  var perform$1 = function (exec) {
    try {
      return { error: false, value: exec() };
    } catch (error) {
      return { error: true, value: error };
    }
  };

  var Queue$1 = function () {
    this.head = null;
    this.tail = null;
  };

  Queue$1.prototype = {
    add: function (item) {
      var entry = { item: item, next: null };
      if (this.head) this.tail.next = entry;
      else this.head = entry;
      this.tail = entry;
    },
    get: function () {
      var entry = this.head;
      if (entry) {
        this.head = entry.next;
        if (this.tail === entry) this.tail = null;
        return entry.item;
      }
    }
  };

  var queue = Queue$1;

  var engineIsBrowser = typeof window == 'object';

  var $$a = _export;
  var global$8 = global$N;
  var getBuiltIn$2 = getBuiltIn$9;
  var call$1 = functionCall;
  var NativePromise$1 = nativePromiseConstructor;
  var redefine$4 = redefine$9.exports;
  var redefineAll$2 = redefineAll$3;
  var setPrototypeOf$3 = objectSetPrototypeOf;
  var setToStringTag$3 = setToStringTag$4;
  var setSpecies = setSpecies$1;
  var aCallable$1 = aCallable$6;
  var isCallable$6 = isCallable$l;
  var isObject$9 = isObject$i;
  var anInstance$2 = anInstance$3;
  var inspectSource = inspectSource$4;
  var iterate$2 = iterate$3;
  var checkCorrectnessOfIteration$1 = checkCorrectnessOfIteration$2;
  var speciesConstructor$1 = speciesConstructor$3;
  var task = task$1.set;
  var microtask = microtask$1;
  var promiseResolve$1 = promiseResolve$2;
  var hostReportErrors = hostReportErrors$1;
  var newPromiseCapabilityModule = newPromiseCapability$2;
  var perform = perform$1;
  var Queue = queue;
  var InternalStateModule$3 = internalState;
  var isForced$1 = isForced_1;
  var wellKnownSymbol$6 = wellKnownSymbol$k;
  var IS_BROWSER = engineIsBrowser;
  var IS_NODE = engineIsNode;
  var V8_VERSION$1 = engineV8Version;

  var SPECIES$1 = wellKnownSymbol$6('species');
  var PROMISE = 'Promise';

  var getInternalState$2 = InternalStateModule$3.getterFor(PROMISE);
  var setInternalState$3 = InternalStateModule$3.set;
  var getInternalPromiseState = InternalStateModule$3.getterFor(PROMISE);
  var NativePromisePrototype = NativePromise$1 && NativePromise$1.prototype;
  var PromiseConstructor = NativePromise$1;
  var PromisePrototype = NativePromisePrototype;
  var TypeError$2 = global$8.TypeError;
  var document$1 = global$8.document;
  var process$1 = global$8.process;
  var newPromiseCapability = newPromiseCapabilityModule.f;
  var newGenericPromiseCapability = newPromiseCapability;

  var DISPATCH_EVENT = !!(document$1 && document$1.createEvent && global$8.dispatchEvent);
  var NATIVE_REJECTION_EVENT = isCallable$6(global$8.PromiseRejectionEvent);
  var UNHANDLED_REJECTION = 'unhandledrejection';
  var REJECTION_HANDLED = 'rejectionhandled';
  var PENDING = 0;
  var FULFILLED = 1;
  var REJECTED = 2;
  var HANDLED = 1;
  var UNHANDLED = 2;
  var SUBCLASSING = false;

  var Internal, OwnPromiseCapability, PromiseWrapper, nativeThen;

  var FORCED$3 = isForced$1(PROMISE, function () {
    var PROMISE_CONSTRUCTOR_SOURCE = inspectSource(PromiseConstructor);
    var GLOBAL_CORE_JS_PROMISE = PROMISE_CONSTRUCTOR_SOURCE !== String(PromiseConstructor);
    // V8 6.6 (Node 10 and Chrome 66) have a bug with resolving custom thenables
    // https://bugs.chromium.org/p/chromium/issues/detail?id=830565
    // We can't detect it synchronously, so just check versions
    if (!GLOBAL_CORE_JS_PROMISE && V8_VERSION$1 === 66) return true;
    // We can't use @@species feature detection in V8 since it causes
    // deoptimization and performance degradation
    // https://github.com/zloirock/core-js/issues/679
    if (V8_VERSION$1 >= 51 && /native code/.test(PROMISE_CONSTRUCTOR_SOURCE)) return false;
    // Detect correctness of subclassing with @@species support
    var promise = new PromiseConstructor(function (resolve) { resolve(1); });
    var FakePromise = function (exec) {
      exec(function () { /* empty */ }, function () { /* empty */ });
    };
    var constructor = promise.constructor = {};
    constructor[SPECIES$1] = FakePromise;
    SUBCLASSING = promise.then(function () { /* empty */ }) instanceof FakePromise;
    if (!SUBCLASSING) return true;
    // Unhandled rejections tracking support, NodeJS Promise without it fails @@species test
    return !GLOBAL_CORE_JS_PROMISE && IS_BROWSER && !NATIVE_REJECTION_EVENT;
  });

  var INCORRECT_ITERATION = FORCED$3 || !checkCorrectnessOfIteration$1(function (iterable) {
    PromiseConstructor.all(iterable)['catch'](function () { /* empty */ });
  });

  // helpers
  var isThenable = function (it) {
    var then;
    return isObject$9(it) && isCallable$6(then = it.then) ? then : false;
  };

  var callReaction = function (reaction, state) {
    var value = state.value;
    var ok = state.state == FULFILLED;
    var handler = ok ? reaction.ok : reaction.fail;
    var resolve = reaction.resolve;
    var reject = reaction.reject;
    var domain = reaction.domain;
    var result, then, exited;
    try {
      if (handler) {
        if (!ok) {
          if (state.rejection === UNHANDLED) onHandleUnhandled(state);
          state.rejection = HANDLED;
        }
        if (handler === true) result = value;
        else {
          if (domain) domain.enter();
          result = handler(value); // can throw
          if (domain) {
            domain.exit();
            exited = true;
          }
        }
        if (result === reaction.promise) {
          reject(TypeError$2('Promise-chain cycle'));
        } else if (then = isThenable(result)) {
          call$1(then, result, resolve, reject);
        } else resolve(result);
      } else reject(value);
    } catch (error) {
      if (domain && !exited) domain.exit();
      reject(error);
    }
  };

  var notify = function (state, isReject) {
    if (state.notified) return;
    state.notified = true;
    microtask(function () {
      var reactions = state.reactions;
      var reaction;
      while (reaction = reactions.get()) {
        callReaction(reaction, state);
      }
      state.notified = false;
      if (isReject && !state.rejection) onUnhandled(state);
    });
  };

  var dispatchEvent = function (name, promise, reason) {
    var event, handler;
    if (DISPATCH_EVENT) {
      event = document$1.createEvent('Event');
      event.promise = promise;
      event.reason = reason;
      event.initEvent(name, false, true);
      global$8.dispatchEvent(event);
    } else event = { promise: promise, reason: reason };
    if (!NATIVE_REJECTION_EVENT && (handler = global$8['on' + name])) handler(event);
    else if (name === UNHANDLED_REJECTION) hostReportErrors('Unhandled promise rejection', reason);
  };

  var onUnhandled = function (state) {
    call$1(task, global$8, function () {
      var promise = state.facade;
      var value = state.value;
      var IS_UNHANDLED = isUnhandled(state);
      var result;
      if (IS_UNHANDLED) {
        result = perform(function () {
          if (IS_NODE) {
            process$1.emit('unhandledRejection', value, promise);
          } else dispatchEvent(UNHANDLED_REJECTION, promise, value);
        });
        // Browsers should not trigger `rejectionHandled` event if it was handled here, NodeJS - should
        state.rejection = IS_NODE || isUnhandled(state) ? UNHANDLED : HANDLED;
        if (result.error) throw result.value;
      }
    });
  };

  var isUnhandled = function (state) {
    return state.rejection !== HANDLED && !state.parent;
  };

  var onHandleUnhandled = function (state) {
    call$1(task, global$8, function () {
      var promise = state.facade;
      if (IS_NODE) {
        process$1.emit('rejectionHandled', promise);
      } else dispatchEvent(REJECTION_HANDLED, promise, state.value);
    });
  };

  var bind$1 = function (fn, state, unwrap) {
    return function (value) {
      fn(state, value, unwrap);
    };
  };

  var internalReject = function (state, value, unwrap) {
    if (state.done) return;
    state.done = true;
    if (unwrap) state = unwrap;
    state.value = value;
    state.state = REJECTED;
    notify(state, true);
  };

  var internalResolve = function (state, value, unwrap) {
    if (state.done) return;
    state.done = true;
    if (unwrap) state = unwrap;
    try {
      if (state.facade === value) throw TypeError$2("Promise can't be resolved itself");
      var then = isThenable(value);
      if (then) {
        microtask(function () {
          var wrapper = { done: false };
          try {
            call$1(then, value,
              bind$1(internalResolve, wrapper, state),
              bind$1(internalReject, wrapper, state)
            );
          } catch (error) {
            internalReject(wrapper, error, state);
          }
        });
      } else {
        state.value = value;
        state.state = FULFILLED;
        notify(state, false);
      }
    } catch (error) {
      internalReject({ done: false }, error, state);
    }
  };

  // constructor polyfill
  if (FORCED$3) {
    // 25.4.3.1 Promise(executor)
    PromiseConstructor = function Promise(executor) {
      anInstance$2(this, PromisePrototype);
      aCallable$1(executor);
      call$1(Internal, this);
      var state = getInternalState$2(this);
      try {
        executor(bind$1(internalResolve, state), bind$1(internalReject, state));
      } catch (error) {
        internalReject(state, error);
      }
    };
    PromisePrototype = PromiseConstructor.prototype;
    // eslint-disable-next-line no-unused-vars -- required for `.length`
    Internal = function Promise(executor) {
      setInternalState$3(this, {
        type: PROMISE,
        done: false,
        notified: false,
        parent: false,
        reactions: new Queue(),
        rejection: false,
        state: PENDING,
        value: undefined
      });
    };
    Internal.prototype = redefineAll$2(PromisePrototype, {
      // `Promise.prototype.then` method
      // https://tc39.es/ecma262/#sec-promise.prototype.then
      // eslint-disable-next-line unicorn/no-thenable -- safe
      then: function then(onFulfilled, onRejected) {
        var state = getInternalPromiseState(this);
        var reaction = newPromiseCapability(speciesConstructor$1(this, PromiseConstructor));
        state.parent = true;
        reaction.ok = isCallable$6(onFulfilled) ? onFulfilled : true;
        reaction.fail = isCallable$6(onRejected) && onRejected;
        reaction.domain = IS_NODE ? process$1.domain : undefined;
        if (state.state == PENDING) state.reactions.add(reaction);
        else microtask(function () {
          callReaction(reaction, state);
        });
        return reaction.promise;
      },
      // `Promise.prototype.catch` method
      // https://tc39.es/ecma262/#sec-promise.prototype.catch
      'catch': function (onRejected) {
        return this.then(undefined, onRejected);
      }
    });
    OwnPromiseCapability = function () {
      var promise = new Internal();
      var state = getInternalState$2(promise);
      this.promise = promise;
      this.resolve = bind$1(internalResolve, state);
      this.reject = bind$1(internalReject, state);
    };
    newPromiseCapabilityModule.f = newPromiseCapability = function (C) {
      return C === PromiseConstructor || C === PromiseWrapper
        ? new OwnPromiseCapability(C)
        : newGenericPromiseCapability(C);
    };

    if (isCallable$6(NativePromise$1) && NativePromisePrototype !== Object.prototype) {
      nativeThen = NativePromisePrototype.then;

      if (!SUBCLASSING) {
        // make `Promise#then` return a polyfilled `Promise` for native promise-based APIs
        redefine$4(NativePromisePrototype, 'then', function then(onFulfilled, onRejected) {
          var that = this;
          return new PromiseConstructor(function (resolve, reject) {
            call$1(nativeThen, that, resolve, reject);
          }).then(onFulfilled, onRejected);
        // https://github.com/zloirock/core-js/issues/640
        }, { unsafe: true });

        // makes sure that native promise-based APIs `Promise#catch` properly works with patched `Promise#then`
        redefine$4(NativePromisePrototype, 'catch', PromisePrototype['catch'], { unsafe: true });
      }

      // make `.constructor === Promise` work for native promise-based APIs
      try {
        delete NativePromisePrototype.constructor;
      } catch (error) { /* empty */ }

      // make `instanceof Promise` work for native promise-based APIs
      if (setPrototypeOf$3) {
        setPrototypeOf$3(NativePromisePrototype, PromisePrototype);
      }
    }
  }

  $$a({ global: true, wrap: true, forced: FORCED$3 }, {
    Promise: PromiseConstructor
  });

  setToStringTag$3(PromiseConstructor, PROMISE, false);
  setSpecies(PROMISE);

  PromiseWrapper = getBuiltIn$2(PROMISE);

  // statics
  $$a({ target: PROMISE, stat: true, forced: FORCED$3 }, {
    // `Promise.reject` method
    // https://tc39.es/ecma262/#sec-promise.reject
    reject: function reject(r) {
      var capability = newPromiseCapability(this);
      call$1(capability.reject, undefined, r);
      return capability.promise;
    }
  });

  $$a({ target: PROMISE, stat: true, forced: FORCED$3 }, {
    // `Promise.resolve` method
    // https://tc39.es/ecma262/#sec-promise.resolve
    resolve: function resolve(x) {
      return promiseResolve$1(this, x);
    }
  });

  $$a({ target: PROMISE, stat: true, forced: INCORRECT_ITERATION }, {
    // `Promise.all` method
    // https://tc39.es/ecma262/#sec-promise.all
    all: function all(iterable) {
      var C = this;
      var capability = newPromiseCapability(C);
      var resolve = capability.resolve;
      var reject = capability.reject;
      var result = perform(function () {
        var $promiseResolve = aCallable$1(C.resolve);
        var values = [];
        var counter = 0;
        var remaining = 1;
        iterate$2(iterable, function (promise) {
          var index = counter++;
          var alreadyCalled = false;
          remaining++;
          call$1($promiseResolve, C, promise).then(function (value) {
            if (alreadyCalled) return;
            alreadyCalled = true;
            values[index] = value;
            --remaining || resolve(values);
          }, reject);
        });
        --remaining || resolve(values);
      });
      if (result.error) reject(result.value);
      return capability.promise;
    },
    // `Promise.race` method
    // https://tc39.es/ecma262/#sec-promise.race
    race: function race(iterable) {
      var C = this;
      var capability = newPromiseCapability(C);
      var reject = capability.reject;
      var result = perform(function () {
        var $promiseResolve = aCallable$1(C.resolve);
        iterate$2(iterable, function (promise) {
          call$1($promiseResolve, C, promise).then(capability.resolve, reject);
        });
      });
      if (result.error) reject(result.value);
      return capability.promise;
    }
  });

  var $$9 = _export;
  var NativePromise = nativePromiseConstructor;
  var fails$a = fails$q;
  var getBuiltIn$1 = getBuiltIn$9;
  var isCallable$5 = isCallable$l;
  var speciesConstructor = speciesConstructor$3;
  var promiseResolve = promiseResolve$2;
  var redefine$3 = redefine$9.exports;

  // Safari bug https://bugs.webkit.org/show_bug.cgi?id=200829
  var NON_GENERIC = !!NativePromise && fails$a(function () {
    // eslint-disable-next-line unicorn/no-thenable -- required for testing
    NativePromise.prototype['finally'].call({ then: function () { /* empty */ } }, function () { /* empty */ });
  });

  // `Promise.prototype.finally` method
  // https://tc39.es/ecma262/#sec-promise.prototype.finally
  $$9({ target: 'Promise', proto: true, real: true, forced: NON_GENERIC }, {
    'finally': function (onFinally) {
      var C = speciesConstructor(this, getBuiltIn$1('Promise'));
      var isFunction = isCallable$5(onFinally);
      return this.then(
        isFunction ? function (x) {
          return promiseResolve(C, onFinally()).then(function () { return x; });
        } : onFinally,
        isFunction ? function (e) {
          return promiseResolve(C, onFinally()).then(function () { throw e; });
        } : onFinally
      );
    }
  });

  // makes sure that native promise-based APIs `Promise#finally` properly works with patched `Promise#then`
  if (isCallable$5(NativePromise)) {
    var method = getBuiltIn$1('Promise').prototype['finally'];
    if (NativePromise.prototype['finally'] !== method) {
      redefine$3(NativePromise.prototype, 'finally', method, { unsafe: true });
    }
  }

  class e$1 {
    route = null;
    view;
    title = "untitled";
    handle;
    app;
    beforeRouteHandler = null;
    afterRouteHandler = null;
    leaveRouteHandler = null;
    alreadyRouteHandler = null;
    static #e = 0;

    static get nextHandle() {
      return e$1.#e++;
    }

    initialise() {
      this.view.initialise();
    }

    registerRoute(e) {
      if (null === this.route) throw new Error(`No route set for '${this.title}' controller.`);
      console.log({
        route: this.route
      }), e.on(this.route, this.routeHandler.bind(this), {
        before: this.beforeRouteHandler ? this.beforeRouteHandler.bind(this) : null,
        after: this.afterRouteHandler ? this.afterRouteHandler.bind(this) : null,
        leave: this.leaveRouteHandler ? this.leaveRouteHandler.bind(this) : null,
        already: this.alreadyRouteHandler ? this.alreadyRouteHandler.bind(this) : null
      });
    }

    routeHandler(e, t) {}

  }

  class t$1 extends Error {
    constructor(e) {
      super(e);
    }

  }

  class r$1 {
    #t = [];
    static STOP_PROPAGATION = "STOP_PROPAGATION";

    bindListener(e, t, r, n) {
      this.#t = this.#t || [];

      const o = function (e, o, i) {
        return r.call(t, e, o, i, n);
      };

      return this.#t[e] ? this.#t[e].push(o) - 1 : (this.#t[e] = [o], 0);
    }

    addListener(e, t, r = {}) {
      this.#t = this.#t || [];

      const n = function (e, n, o = {}) {
        return t({
          context: e,
          eventName: n,
          ...o,
          ...r
        });
      };

      return this.#t[e] ? this.#t[e].push(n) - 1 : (this.#t[e] = [n], 0);
    }

    removeListener(e, t) {
      this.#t[e] && this.#t[e][t] ? delete this.#t[e][t] : console.log("trying to remove non-existent event handler, event = " + e + " handle = " + t);
    }

    destructor() {
      this.#t = null;
    }

    fireEvent(e, t) {
      if (this.#t) for (let t in this.#t[e]) if (this.#t[e].hasOwnProperty(t) && this.#t[e][t](this, e, arguments[1]) === r$1.STOP_PROPAGATION) break;
    }

  }

  var n$1 = "undefined" != typeof globalThis ? globalThis : "undefined" != typeof window ? window : "undefined" != typeof global ? global : "undefined" != typeof self ? self : {};

  function o$1(e) {
    throw new Error('Could not dynamically require "' + e + '". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.');
  }

  var s$1 = function e(t, r, n) {
    function i(a, c) {
      if (!r[a]) {
        if (!t[a]) {
          if (!c && o$1) return o$1(a);
          if (s) return s(a, !0);
          var l = new Error("Cannot find module '" + a + "'");
          throw l.code = "MODULE_NOT_FOUND", l;
        }

        var u = r[a] = {
          exports: {}
        };
        t[a][0].call(u.exports, function (e) {
          var r = t[a][1][e];
          return i(r || e);
        }, u, u.exports, e, t, r, n);
      }

      return r[a].exports;
    }

    for (var s = o$1, a = 0; a < n.length; a++) i(n[a]);

    return i;
  }({
    1: [function (e, t, r) {
      (function (e) {
        var r,
            n,
            o = e.MutationObserver || e.WebKitMutationObserver;

        if (o) {
          var i = 0,
              s = new o(u),
              a = e.document.createTextNode("");
          s.observe(a, {
            characterData: !0
          }), r = function () {
            a.data = i = ++i % 2;
          };
        } else if (e.setImmediate || void 0 === e.MessageChannel) r = "document" in e && "onreadystatechange" in e.document.createElement("script") ? function () {
          var t = e.document.createElement("script");
          t.onreadystatechange = function () {
            u(), t.onreadystatechange = null, t.parentNode.removeChild(t), t = null;
          }, e.document.documentElement.appendChild(t);
        } : function () {
          setTimeout(u, 0);
        };else {
          var c = new e.MessageChannel();
          c.port1.onmessage = u, r = function () {
            c.port2.postMessage(0);
          };
        }

        var l = [];

        function u() {
          var e, t;
          n = !0;

          for (var r = l.length; r;) {
            for (t = l, l = [], e = -1; ++e < r;) t[e]();

            r = l.length;
          }

          n = !1;
        }

        function d(e) {
          1 !== l.push(e) || n || r();
        }

        t.exports = d;
      }).call(this, void 0 !== n$1 ? n$1 : "undefined" != typeof self ? self : "undefined" != typeof window ? window : {});
    }, {}],
    2: [function (e, t, r) {
      var n = e(1);

      function o() {}

      var i = {},
          s = ["REJECTED"],
          a = ["FULFILLED"],
          c = ["PENDING"];

      function l(e) {
        if ("function" != typeof e) throw new TypeError("resolver must be a function");
        this.state = c, this.queue = [], this.outcome = void 0, e !== o && f(this, e);
      }

      function u(e, t, r) {
        this.promise = e, "function" == typeof t && (this.onFulfilled = t, this.callFulfilled = this.otherCallFulfilled), "function" == typeof r && (this.onRejected = r, this.callRejected = this.otherCallRejected);
      }

      function d(e, t, r) {
        n(function () {
          var n;

          try {
            n = t(r);
          } catch (t) {
            return i.reject(e, t);
          }

          n === e ? i.reject(e, new TypeError("Cannot resolve promise with itself")) : i.resolve(e, n);
        });
      }

      function h(e) {
        var t = e && e.then;
        if (e && ("object" == typeof e || "function" == typeof e) && "function" == typeof t) return function () {
          t.apply(e, arguments);
        };
      }

      function f(e, t) {
        var r = !1;

        function n(t) {
          r || (r = !0, i.reject(e, t));
        }

        function o(t) {
          r || (r = !0, i.resolve(e, t));
        }

        function s() {
          t(o, n);
        }

        var a = p(s);
        "error" === a.status && n(a.value);
      }

      function p(e, t) {
        var r = {};

        try {
          r.value = e(t), r.status = "success";
        } catch (e) {
          r.status = "error", r.value = e;
        }

        return r;
      }

      function v(e) {
        return e instanceof this ? e : i.resolve(new this(o), e);
      }

      function y(e) {
        var t = new this(o);
        return i.reject(t, e);
      }

      function m(e) {
        var t = this;
        if ("[object Array]" !== Object.prototype.toString.call(e)) return this.reject(new TypeError("must be an array"));
        var r = e.length,
            n = !1;
        if (!r) return this.resolve([]);

        for (var s = new Array(r), a = 0, c = -1, l = new this(o); ++c < r;) u(e[c], c);

        return l;

        function u(e, o) {
          function c(e) {
            s[o] = e, ++a !== r || n || (n = !0, i.resolve(l, s));
          }

          t.resolve(e).then(c, function (e) {
            n || (n = !0, i.reject(l, e));
          });
        }
      }

      function g(e) {
        var t = this;
        if ("[object Array]" !== Object.prototype.toString.call(e)) return this.reject(new TypeError("must be an array"));
        var r = e.length,
            n = !1;
        if (!r) return this.resolve([]);

        for (var s = -1, a = new this(o); ++s < r;) c(e[s]);

        return a;

        function c(e) {
          t.resolve(e).then(function (e) {
            n || (n = !0, i.resolve(a, e));
          }, function (e) {
            n || (n = !0, i.reject(a, e));
          });
        }
      }

      t.exports = l, l.prototype.catch = function (e) {
        return this.then(null, e);
      }, l.prototype.then = function (e, t) {
        if ("function" != typeof e && this.state === a || "function" != typeof t && this.state === s) return this;
        var r = new this.constructor(o);
        return this.state !== c ? d(r, this.state === a ? e : t, this.outcome) : this.queue.push(new u(r, e, t)), r;
      }, u.prototype.callFulfilled = function (e) {
        i.resolve(this.promise, e);
      }, u.prototype.otherCallFulfilled = function (e) {
        d(this.promise, this.onFulfilled, e);
      }, u.prototype.callRejected = function (e) {
        i.reject(this.promise, e);
      }, u.prototype.otherCallRejected = function (e) {
        d(this.promise, this.onRejected, e);
      }, i.resolve = function (e, t) {
        var r = p(h, t);
        if ("error" === r.status) return i.reject(e, r.value);
        var n = r.value;
        if (n) f(e, n);else {
          e.state = a, e.outcome = t;

          for (var o = -1, s = e.queue.length; ++o < s;) e.queue[o].callFulfilled(t);
        }
        return e;
      }, i.reject = function (e, t) {
        e.state = s, e.outcome = t;

        for (var r = -1, n = e.queue.length; ++r < n;) e.queue[r].callRejected(t);

        return e;
      }, l.resolve = v, l.reject = y, l.all = m, l.race = g;
    }, {
      1: 1
    }],
    3: [function (e, t, r) {
      (function (t) {
        "function" != typeof t.Promise && (t.Promise = e(2));
      }).call(this, void 0 !== n$1 ? n$1 : "undefined" != typeof self ? self : "undefined" != typeof window ? window : {});
    }, {
      2: 2
    }],
    4: [function (e, t, r) {
      var n = "function" == typeof Symbol && "symbol" == typeof Symbol.iterator ? function (e) {
        return typeof e;
      } : function (e) {
        return e && "function" == typeof Symbol && e.constructor === Symbol && e !== Symbol.prototype ? "symbol" : typeof e;
      };

      function o(e, t) {
        if (!(e instanceof t)) throw new TypeError("Cannot call a class as a function");
      }

      function i() {
        try {
          if ("undefined" != typeof indexedDB) return indexedDB;
          if ("undefined" != typeof webkitIndexedDB) return webkitIndexedDB;
          if ("undefined" != typeof mozIndexedDB) return mozIndexedDB;
          if ("undefined" != typeof OIndexedDB) return OIndexedDB;
          if ("undefined" != typeof msIndexedDB) return msIndexedDB;
        } catch (e) {
          return;
        }
      }

      var s = i();

      function a() {
        try {
          if (!s || !s.open) return !1;
          var e = "undefined" != typeof openDatabase && /(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent) && !/Chrome/.test(navigator.userAgent) && !/BlackBerry/.test(navigator.platform),
              t = "function" == typeof fetch && -1 !== fetch.toString().indexOf("[native code");
          return (!e || t) && "undefined" != typeof indexedDB && "undefined" != typeof IDBKeyRange;
        } catch (e) {
          return !1;
        }
      }

      function c(e, t) {
        e = e || [], t = t || {};

        try {
          return new Blob(e, t);
        } catch (o) {
          if ("TypeError" !== o.name) throw o;

          for (var r = new ("undefined" != typeof BlobBuilder ? BlobBuilder : "undefined" != typeof MSBlobBuilder ? MSBlobBuilder : "undefined" != typeof MozBlobBuilder ? MozBlobBuilder : WebKitBlobBuilder)(), n = 0; n < e.length; n += 1) r.append(e[n]);

          return r.getBlob(t.type);
        }
      }

      "undefined" == typeof Promise && e(3);
      var l = Promise;

      function u(e, t) {
        t && e.then(function (e) {
          t(null, e);
        }, function (e) {
          t(e);
        });
      }

      function d(e, t, r) {
        "function" == typeof t && e.then(t), "function" == typeof r && e.catch(r);
      }

      function h(e) {
        return "string" != typeof e && (console.warn(e + " used as a key, but it is not a string."), e = String(e)), e;
      }

      function f() {
        if (arguments.length && "function" == typeof arguments[arguments.length - 1]) return arguments[arguments.length - 1];
      }

      var p = "local-forage-detect-blob-support",
          v = void 0,
          y = {},
          m = Object.prototype.toString,
          g = "readonly",
          b = "readwrite";

      function S(e) {
        for (var t = e.length, r = new ArrayBuffer(t), n = new Uint8Array(r), o = 0; o < t; o++) n[o] = e.charCodeAt(o);

        return r;
      }

      function E(e) {
        return new l(function (t) {
          var r = e.transaction(p, b),
              n = c([""]);
          r.objectStore(p).put(n, "key"), r.onabort = function (e) {
            e.preventDefault(), e.stopPropagation(), t(!1);
          }, r.oncomplete = function () {
            var e = navigator.userAgent.match(/Chrome\/(\d+)/),
                r = navigator.userAgent.match(/Edge\//);
            t(r || !e || parseInt(e[1], 10) >= 43);
          };
        }).catch(function () {
          return !1;
        });
      }

      function _(e) {
        return "boolean" == typeof v ? l.resolve(v) : E(e).then(function (e) {
          return v = e;
        });
      }

      function w(e) {
        var t = y[e.name],
            r = {};
        r.promise = new l(function (e, t) {
          r.resolve = e, r.reject = t;
        }), t.deferredOperations.push(r), t.dbReady ? t.dbReady = t.dbReady.then(function () {
          return r.promise;
        }) : t.dbReady = r.promise;
      }

      function I(e) {
        var t = y[e.name].deferredOperations.pop();
        if (t) return t.resolve(), t.promise;
      }

      function R(e, t) {
        var r = y[e.name].deferredOperations.pop();
        if (r) return r.reject(t), r.promise;
      }

      function C(e, t) {
        return new l(function (r, n) {
          if (y[e.name] = y[e.name] || H(), e.db) {
            if (!t) return r(e.db);
            w(e), e.db.close();
          }

          var o = [e.name];
          t && o.push(e.version);
          var i = s.open.apply(s, o);
          t && (i.onupgradeneeded = function (t) {
            var r = i.result;

            try {
              r.createObjectStore(e.storeName), t.oldVersion <= 1 && r.createObjectStore(p);
            } catch (r) {
              if ("ConstraintError" !== r.name) throw r;
              console.warn('The database "' + e.name + '" has been upgraded from version ' + t.oldVersion + " to version " + t.newVersion + ', but the storage "' + e.storeName + '" already exists.');
            }
          }), i.onerror = function (e) {
            e.preventDefault(), n(i.error);
          }, i.onsuccess = function () {
            var t = i.result;
            t.onversionchange = function (e) {
              e.target.close();
            }, r(t), I(e);
          };
        });
      }

      function x(e) {
        return C(e, !1);
      }

      function T(e) {
        return C(e, !0);
      }

      function $(e, t) {
        if (!e.db) return !0;
        var r = !e.db.objectStoreNames.contains(e.storeName),
            n = e.version < e.db.version,
            o = e.version > e.db.version;

        if (n && (e.version !== t && console.warn('The database "' + e.name + "\" can't be downgraded from version " + e.db.version + " to version " + e.version + "."), e.version = e.db.version), o || r) {
          if (r) {
            var i = e.db.version + 1;
            i > e.version && (e.version = i);
          }

          return !0;
        }

        return !1;
      }

      function L(e) {
        return new l(function (t, r) {
          var n = new FileReader();
          n.onerror = r, n.onloadend = function (r) {
            var n = btoa(r.target.result || "");
            t({
              __local_forage_encoded_blob: !0,
              data: n,
              type: e.type
            });
          }, n.readAsBinaryString(e);
        });
      }

      function N(e) {
        return c([S(atob(e.data))], {
          type: e.type
        });
      }

      function O(e) {
        return e && e.__local_forage_encoded_blob;
      }

      function A(e) {
        var t = this,
            r = t._initReady().then(function () {
          var e = y[t._dbInfo.name];
          if (e && e.dbReady) return e.dbReady;
        });

        return d(r, e, e), r;
      }

      function D(e) {
        w(e);

        for (var t = y[e.name], r = t.forages, n = 0; n < r.length; n++) {
          var o = r[n];
          o._dbInfo.db && (o._dbInfo.db.close(), o._dbInfo.db = null);
        }

        return e.db = null, x(e).then(function (t) {
          return e.db = t, $(e) ? T(e) : t;
        }).then(function (n) {
          e.db = t.db = n;

          for (var o = 0; o < r.length; o++) r[o]._dbInfo.db = n;
        }).catch(function (t) {
          throw R(e, t), t;
        });
      }

      function P(e, t, r, n) {
        void 0 === n && (n = 1);

        try {
          var o = e.db.transaction(e.storeName, t);
          r(null, o);
        } catch (o) {
          if (n > 0 && (!e.db || "InvalidStateError" === o.name || "NotFoundError" === o.name)) return l.resolve().then(function () {
            if (!e.db || "NotFoundError" === o.name && !e.db.objectStoreNames.contains(e.storeName) && e.version <= e.db.version) return e.db && (e.version = e.db.version + 1), T(e);
          }).then(function () {
            return D(e).then(function () {
              P(e, t, r, n - 1);
            });
          }).catch(r);
          r(o);
        }
      }

      function H() {
        return {
          forages: [],
          db: null,
          dbReady: null,
          deferredOperations: []
        };
      }

      function q(e) {
        var t = this,
            r = {
          db: null
        };
        if (e) for (var n in e) r[n] = e[n];
        var o = y[r.name];
        o || (o = H(), y[r.name] = o), o.forages.push(t), t._initReady || (t._initReady = t.ready, t.ready = A);
        var i = [];

        function s() {
          return l.resolve();
        }

        for (var a = 0; a < o.forages.length; a++) {
          var c = o.forages[a];
          c !== t && i.push(c._initReady().catch(s));
        }

        var u = o.forages.slice(0);
        return l.all(i).then(function () {
          return r.db = o.db, x(r);
        }).then(function (e) {
          return r.db = e, $(r, t._defaultConfig.version) ? T(r) : e;
        }).then(function (e) {
          r.db = o.db = e, t._dbInfo = r;

          for (var n = 0; n < u.length; n++) {
            var i = u[n];
            i !== t && (i._dbInfo.db = r.db, i._dbInfo.version = r.version);
          }
        });
      }

      function k(e, t) {
        var r = this;
        e = h(e);
        var n = new l(function (t, n) {
          r.ready().then(function () {
            P(r._dbInfo, g, function (o, i) {
              if (o) return n(o);

              try {
                var s = i.objectStore(r._dbInfo.storeName).get(e);
                s.onsuccess = function () {
                  var e = s.result;
                  void 0 === e && (e = null), O(e) && (e = N(e)), t(e);
                }, s.onerror = function () {
                  n(s.error);
                };
              } catch (e) {
                n(e);
              }
            });
          }).catch(n);
        });
        return u(n, t), n;
      }

      function j(e, t) {
        var r = this,
            n = new l(function (t, n) {
          r.ready().then(function () {
            P(r._dbInfo, g, function (o, i) {
              if (o) return n(o);

              try {
                var s = i.objectStore(r._dbInfo.storeName).openCursor(),
                    a = 1;
                s.onsuccess = function () {
                  var r = s.result;

                  if (r) {
                    var n = r.value;
                    O(n) && (n = N(n));
                    var o = e(n, r.key, a++);
                    void 0 !== o ? t(o) : r.continue();
                  } else t();
                }, s.onerror = function () {
                  n(s.error);
                };
              } catch (e) {
                n(e);
              }
            });
          }).catch(n);
        });
        return u(n, t), n;
      }

      function F(e, t, r) {
        var n = this;
        e = h(e);
        var o = new l(function (r, o) {
          var i;
          n.ready().then(function () {
            return i = n._dbInfo, "[object Blob]" === m.call(t) ? _(i.db).then(function (e) {
              return e ? t : L(t);
            }) : t;
          }).then(function (t) {
            P(n._dbInfo, b, function (i, s) {
              if (i) return o(i);

              try {
                var a = s.objectStore(n._dbInfo.storeName);
                null === t && (t = void 0);
                var c = a.put(t, e);
                s.oncomplete = function () {
                  void 0 === t && (t = null), r(t);
                }, s.onabort = s.onerror = function () {
                  var e = c.error ? c.error : c.transaction.error;
                  o(e);
                };
              } catch (e) {
                o(e);
              }
            });
          }).catch(o);
        });
        return u(o, r), o;
      }

      function V(e, t) {
        var r = this;
        e = h(e);
        var n = new l(function (t, n) {
          r.ready().then(function () {
            P(r._dbInfo, b, function (o, i) {
              if (o) return n(o);

              try {
                var s = i.objectStore(r._dbInfo.storeName).delete(e);
                i.oncomplete = function () {
                  t();
                }, i.onerror = function () {
                  n(s.error);
                }, i.onabort = function () {
                  var e = s.error ? s.error : s.transaction.error;
                  n(e);
                };
              } catch (e) {
                n(e);
              }
            });
          }).catch(n);
        });
        return u(n, t), n;
      }

      function M(e) {
        var t = this,
            r = new l(function (e, r) {
          t.ready().then(function () {
            P(t._dbInfo, b, function (n, o) {
              if (n) return r(n);

              try {
                var i = o.objectStore(t._dbInfo.storeName).clear();
                o.oncomplete = function () {
                  e();
                }, o.onabort = o.onerror = function () {
                  var e = i.error ? i.error : i.transaction.error;
                  r(e);
                };
              } catch (e) {
                r(e);
              }
            });
          }).catch(r);
        });
        return u(r, e), r;
      }

      function U(e) {
        var t = this,
            r = new l(function (e, r) {
          t.ready().then(function () {
            P(t._dbInfo, g, function (n, o) {
              if (n) return r(n);

              try {
                var i = o.objectStore(t._dbInfo.storeName).count();
                i.onsuccess = function () {
                  e(i.result);
                }, i.onerror = function () {
                  r(i.error);
                };
              } catch (e) {
                r(e);
              }
            });
          }).catch(r);
        });
        return u(r, e), r;
      }

      function B(e, t) {
        var r = this,
            n = new l(function (t, n) {
          e < 0 ? t(null) : r.ready().then(function () {
            P(r._dbInfo, g, function (o, i) {
              if (o) return n(o);

              try {
                var s = i.objectStore(r._dbInfo.storeName),
                    a = !1,
                    c = s.openKeyCursor();
                c.onsuccess = function () {
                  var r = c.result;
                  r ? 0 === e || a ? t(r.key) : (a = !0, r.advance(e)) : t(null);
                }, c.onerror = function () {
                  n(c.error);
                };
              } catch (e) {
                n(e);
              }
            });
          }).catch(n);
        });
        return u(n, t), n;
      }

      function Y(e) {
        var t = this,
            r = new l(function (e, r) {
          t.ready().then(function () {
            P(t._dbInfo, g, function (n, o) {
              if (n) return r(n);

              try {
                var i = o.objectStore(t._dbInfo.storeName).openKeyCursor(),
                    s = [];
                i.onsuccess = function () {
                  var t = i.result;
                  t ? (s.push(t.key), t.continue()) : e(s);
                }, i.onerror = function () {
                  r(i.error);
                };
              } catch (e) {
                r(e);
              }
            });
          }).catch(r);
        });
        return u(r, e), r;
      }

      function K(e, t) {
        t = f.apply(this, arguments);
        var r = this.config();
        (e = "function" != typeof e && e || {}).name || (e.name = e.name || r.name, e.storeName = e.storeName || r.storeName);
        var n,
            o = this;

        if (e.name) {
          var i = e.name === r.name && o._dbInfo.db ? l.resolve(o._dbInfo.db) : x(e).then(function (t) {
            var r = y[e.name],
                n = r.forages;
            r.db = t;

            for (var o = 0; o < n.length; o++) n[o]._dbInfo.db = t;

            return t;
          });
          n = e.storeName ? i.then(function (t) {
            if (t.objectStoreNames.contains(e.storeName)) {
              var r = t.version + 1;
              w(e);
              var n = y[e.name],
                  o = n.forages;
              t.close();

              for (var i = 0; i < o.length; i++) {
                var a = o[i];
                a._dbInfo.db = null, a._dbInfo.version = r;
              }

              var c = new l(function (t, n) {
                var o = s.open(e.name, r);
                o.onerror = function (e) {
                  o.result.close(), n(e);
                }, o.onupgradeneeded = function () {
                  o.result.deleteObjectStore(e.storeName);
                }, o.onsuccess = function () {
                  var e = o.result;
                  e.close(), t(e);
                };
              });
              return c.then(function (e) {
                n.db = e;

                for (var t = 0; t < o.length; t++) {
                  var r = o[t];
                  r._dbInfo.db = e, I(r._dbInfo);
                }
              }).catch(function (t) {
                throw (R(e, t) || l.resolve()).catch(function () {}), t;
              });
            }
          }) : i.then(function (t) {
            w(e);
            var r = y[e.name],
                n = r.forages;
            t.close();

            for (var o = 0; o < n.length; o++) n[o]._dbInfo.db = null;

            var i = new l(function (t, r) {
              var n = s.deleteDatabase(e.name);
              n.onerror = function () {
                var e = n.result;
                e && e.close(), r(n.error);
              }, n.onblocked = function () {
                console.warn('dropInstance blocked for database "' + e.name + '" until all open connections are closed');
              }, n.onsuccess = function () {
                var e = n.result;
                e && e.close(), t(e);
              };
            });
            return i.then(function (e) {
              r.db = e;

              for (var t = 0; t < n.length; t++) I(n[t]._dbInfo);
            }).catch(function (t) {
              throw (R(e, t) || l.resolve()).catch(function () {}), t;
            });
          });
        } else n = l.reject("Invalid arguments");

        return u(n, t), n;
      }

      var W = {
        _driver: "asyncStorage",
        _initStorage: q,
        _support: a(),
        iterate: j,
        getItem: k,
        setItem: F,
        removeItem: V,
        clear: M,
        length: U,
        key: B,
        keys: Y,
        dropInstance: K
      };

      function z() {
        return "function" == typeof openDatabase;
      }

      var Q = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",
          G = "~~local_forage_type~",
          X = /^~~local_forage_type~([^~]+)~/,
          J = "__lfsc__:",
          Z = J.length,
          ee = "arbf",
          te = "blob",
          re = "si08",
          ne = "ui08",
          oe = "uic8",
          ie = "si16",
          se = "si32",
          ae = "ur16",
          ce = "ui32",
          le = "fl32",
          ue = "fl64",
          de = Z + ee.length,
          he = Object.prototype.toString;

      function fe(e) {
        var t,
            r,
            n,
            o,
            i,
            s = .75 * e.length,
            a = e.length,
            c = 0;
        "=" === e[e.length - 1] && (s--, "=" === e[e.length - 2] && s--);
        var l = new ArrayBuffer(s),
            u = new Uint8Array(l);

        for (t = 0; t < a; t += 4) r = Q.indexOf(e[t]), n = Q.indexOf(e[t + 1]), o = Q.indexOf(e[t + 2]), i = Q.indexOf(e[t + 3]), u[c++] = r << 2 | n >> 4, u[c++] = (15 & n) << 4 | o >> 2, u[c++] = (3 & o) << 6 | 63 & i;

        return l;
      }

      function pe(e) {
        var t,
            r = new Uint8Array(e),
            n = "";

        for (t = 0; t < r.length; t += 3) n += Q[r[t] >> 2], n += Q[(3 & r[t]) << 4 | r[t + 1] >> 4], n += Q[(15 & r[t + 1]) << 2 | r[t + 2] >> 6], n += Q[63 & r[t + 2]];

        return r.length % 3 == 2 ? n = n.substring(0, n.length - 1) + "=" : r.length % 3 == 1 && (n = n.substring(0, n.length - 2) + "=="), n;
      }

      function ve(e, t) {
        var r = "";

        if (e && (r = he.call(e)), e && ("[object ArrayBuffer]" === r || e.buffer && "[object ArrayBuffer]" === he.call(e.buffer))) {
          var n,
              o = J;
          e instanceof ArrayBuffer ? (n = e, o += ee) : (n = e.buffer, "[object Int8Array]" === r ? o += re : "[object Uint8Array]" === r ? o += ne : "[object Uint8ClampedArray]" === r ? o += oe : "[object Int16Array]" === r ? o += ie : "[object Uint16Array]" === r ? o += ae : "[object Int32Array]" === r ? o += se : "[object Uint32Array]" === r ? o += ce : "[object Float32Array]" === r ? o += le : "[object Float64Array]" === r ? o += ue : t(new Error("Failed to get type for BinaryArray"))), t(o + pe(n));
        } else if ("[object Blob]" === r) {
          var i = new FileReader();
          i.onload = function () {
            var r = G + e.type + "~" + pe(this.result);
            t(J + te + r);
          }, i.readAsArrayBuffer(e);
        } else try {
          t(JSON.stringify(e));
        } catch (r) {
          console.error("Couldn't convert value into a JSON string: ", e), t(null, r);
        }
      }

      function ye(e) {
        if (e.substring(0, Z) !== J) return JSON.parse(e);
        var t,
            r = e.substring(de),
            n = e.substring(Z, de);

        if (n === te && X.test(r)) {
          var o = r.match(X);
          t = o[1], r = r.substring(o[0].length);
        }

        var i = fe(r);

        switch (n) {
          case ee:
            return i;

          case te:
            return c([i], {
              type: t
            });

          case re:
            return new Int8Array(i);

          case ne:
            return new Uint8Array(i);

          case oe:
            return new Uint8ClampedArray(i);

          case ie:
            return new Int16Array(i);

          case ae:
            return new Uint16Array(i);

          case se:
            return new Int32Array(i);

          case ce:
            return new Uint32Array(i);

          case le:
            return new Float32Array(i);

          case ue:
            return new Float64Array(i);

          default:
            throw new Error("Unkown type: " + n);
        }
      }

      var me = {
        serialize: ve,
        deserialize: ye,
        stringToBuffer: fe,
        bufferToString: pe
      };

      function ge(e, t, r, n) {
        e.executeSql("CREATE TABLE IF NOT EXISTS " + t.storeName + " (id INTEGER PRIMARY KEY, key unique, value)", [], r, n);
      }

      function be(e) {
        var t = this,
            r = {
          db: null
        };
        if (e) for (var n in e) r[n] = "string" != typeof e[n] ? e[n].toString() : e[n];
        var o = new l(function (e, n) {
          try {
            r.db = openDatabase(r.name, String(r.version), r.description, r.size);
          } catch (e) {
            return n(e);
          }

          r.db.transaction(function (o) {
            ge(o, r, function () {
              t._dbInfo = r, e();
            }, function (e, t) {
              n(t);
            });
          }, n);
        });
        return r.serializer = me, o;
      }

      function Se(e, t, r, n, o, i) {
        e.executeSql(r, n, o, function (e, s) {
          s.code === s.SYNTAX_ERR ? e.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?", [t.storeName], function (e, a) {
            a.rows.length ? i(e, s) : ge(e, t, function () {
              e.executeSql(r, n, o, i);
            }, i);
          }, i) : i(e, s);
        }, i);
      }

      function Ee(e, t) {
        var r = this;
        e = h(e);
        var n = new l(function (t, n) {
          r.ready().then(function () {
            var o = r._dbInfo;
            o.db.transaction(function (r) {
              Se(r, o, "SELECT * FROM " + o.storeName + " WHERE key = ? LIMIT 1", [e], function (e, r) {
                var n = r.rows.length ? r.rows.item(0).value : null;
                n && (n = o.serializer.deserialize(n)), t(n);
              }, function (e, t) {
                n(t);
              });
            });
          }).catch(n);
        });
        return u(n, t), n;
      }

      function _e(e, t) {
        var r = this,
            n = new l(function (t, n) {
          r.ready().then(function () {
            var o = r._dbInfo;
            o.db.transaction(function (r) {
              Se(r, o, "SELECT * FROM " + o.storeName, [], function (r, n) {
                for (var i = n.rows, s = i.length, a = 0; a < s; a++) {
                  var c = i.item(a),
                      l = c.value;
                  if (l && (l = o.serializer.deserialize(l)), void 0 !== (l = e(l, c.key, a + 1))) return void t(l);
                }

                t();
              }, function (e, t) {
                n(t);
              });
            });
          }).catch(n);
        });
        return u(n, t), n;
      }

      function we(e, t, r, n) {
        var o = this;
        e = h(e);
        var i = new l(function (i, s) {
          o.ready().then(function () {
            void 0 === t && (t = null);
            var a = t,
                c = o._dbInfo;
            c.serializer.serialize(t, function (t, l) {
              l ? s(l) : c.db.transaction(function (r) {
                Se(r, c, "INSERT OR REPLACE INTO " + c.storeName + " (key, value) VALUES (?, ?)", [e, t], function () {
                  i(a);
                }, function (e, t) {
                  s(t);
                });
              }, function (t) {
                if (t.code === t.QUOTA_ERR) {
                  if (n > 0) return void i(we.apply(o, [e, a, r, n - 1]));
                  s(t);
                }
              });
            });
          }).catch(s);
        });
        return u(i, r), i;
      }

      function Ie(e, t, r) {
        return we.apply(this, [e, t, r, 1]);
      }

      function Re(e, t) {
        var r = this;
        e = h(e);
        var n = new l(function (t, n) {
          r.ready().then(function () {
            var o = r._dbInfo;
            o.db.transaction(function (r) {
              Se(r, o, "DELETE FROM " + o.storeName + " WHERE key = ?", [e], function () {
                t();
              }, function (e, t) {
                n(t);
              });
            });
          }).catch(n);
        });
        return u(n, t), n;
      }

      function Ce(e) {
        var t = this,
            r = new l(function (e, r) {
          t.ready().then(function () {
            var n = t._dbInfo;
            n.db.transaction(function (t) {
              Se(t, n, "DELETE FROM " + n.storeName, [], function () {
                e();
              }, function (e, t) {
                r(t);
              });
            });
          }).catch(r);
        });
        return u(r, e), r;
      }

      function xe(e) {
        var t = this,
            r = new l(function (e, r) {
          t.ready().then(function () {
            var n = t._dbInfo;
            n.db.transaction(function (t) {
              Se(t, n, "SELECT COUNT(key) as c FROM " + n.storeName, [], function (t, r) {
                var n = r.rows.item(0).c;
                e(n);
              }, function (e, t) {
                r(t);
              });
            });
          }).catch(r);
        });
        return u(r, e), r;
      }

      function Te(e, t) {
        var r = this,
            n = new l(function (t, n) {
          r.ready().then(function () {
            var o = r._dbInfo;
            o.db.transaction(function (r) {
              Se(r, o, "SELECT key FROM " + o.storeName + " WHERE id = ? LIMIT 1", [e + 1], function (e, r) {
                var n = r.rows.length ? r.rows.item(0).key : null;
                t(n);
              }, function (e, t) {
                n(t);
              });
            });
          }).catch(n);
        });
        return u(n, t), n;
      }

      function $e(e) {
        var t = this,
            r = new l(function (e, r) {
          t.ready().then(function () {
            var n = t._dbInfo;
            n.db.transaction(function (t) {
              Se(t, n, "SELECT key FROM " + n.storeName, [], function (t, r) {
                for (var n = [], o = 0; o < r.rows.length; o++) n.push(r.rows.item(o).key);

                e(n);
              }, function (e, t) {
                r(t);
              });
            });
          }).catch(r);
        });
        return u(r, e), r;
      }

      function Le(e) {
        return new l(function (t, r) {
          e.transaction(function (n) {
            n.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'", [], function (r, n) {
              for (var o = [], i = 0; i < n.rows.length; i++) o.push(n.rows.item(i).name);

              t({
                db: e,
                storeNames: o
              });
            }, function (e, t) {
              r(t);
            });
          }, function (e) {
            r(e);
          });
        });
      }

      function Ne(e, t) {
        t = f.apply(this, arguments);
        var r = this.config();
        (e = "function" != typeof e && e || {}).name || (e.name = e.name || r.name, e.storeName = e.storeName || r.storeName);
        var n,
            o = this;
        return u(n = e.name ? new l(function (t) {
          var n;
          n = e.name === r.name ? o._dbInfo.db : openDatabase(e.name, "", "", 0), e.storeName ? t({
            db: n,
            storeNames: [e.storeName]
          }) : t(Le(n));
        }).then(function (e) {
          return new l(function (t, r) {
            e.db.transaction(function (n) {
              function o(e) {
                return new l(function (t, r) {
                  n.executeSql("DROP TABLE IF EXISTS " + e, [], function () {
                    t();
                  }, function (e, t) {
                    r(t);
                  });
                });
              }

              for (var i = [], s = 0, a = e.storeNames.length; s < a; s++) i.push(o(e.storeNames[s]));

              l.all(i).then(function () {
                t();
              }).catch(function (e) {
                r(e);
              });
            }, function (e) {
              r(e);
            });
          });
        }) : l.reject("Invalid arguments"), t), n;
      }

      var Oe = {
        _driver: "webSQLStorage",
        _initStorage: be,
        _support: z(),
        iterate: _e,
        getItem: Ee,
        setItem: Ie,
        removeItem: Re,
        clear: Ce,
        length: xe,
        key: Te,
        keys: $e,
        dropInstance: Ne
      };

      function Ae() {
        try {
          return "undefined" != typeof localStorage && "setItem" in localStorage && !!localStorage.setItem;
        } catch (e) {
          return !1;
        }
      }

      function De(e, t) {
        var r = e.name + "/";
        return e.storeName !== t.storeName && (r += e.storeName + "/"), r;
      }

      function Pe() {
        var e = "_localforage_support_test";

        try {
          return localStorage.setItem(e, !0), localStorage.removeItem(e), !1;
        } catch (e) {
          return !0;
        }
      }

      function He() {
        return !Pe() || localStorage.length > 0;
      }

      function qe(e) {
        var t = this,
            r = {};
        if (e) for (var n in e) r[n] = e[n];
        return r.keyPrefix = De(e, t._defaultConfig), He() ? (t._dbInfo = r, r.serializer = me, l.resolve()) : l.reject();
      }

      function ke(e) {
        var t = this,
            r = t.ready().then(function () {
          for (var e = t._dbInfo.keyPrefix, r = localStorage.length - 1; r >= 0; r--) {
            var n = localStorage.key(r);
            0 === n.indexOf(e) && localStorage.removeItem(n);
          }
        });
        return u(r, e), r;
      }

      function je(e, t) {
        var r = this;
        e = h(e);
        var n = r.ready().then(function () {
          var t = r._dbInfo,
              n = localStorage.getItem(t.keyPrefix + e);
          return n && (n = t.serializer.deserialize(n)), n;
        });
        return u(n, t), n;
      }

      function Fe(e, t) {
        var r = this,
            n = r.ready().then(function () {
          for (var t = r._dbInfo, n = t.keyPrefix, o = n.length, i = localStorage.length, s = 1, a = 0; a < i; a++) {
            var c = localStorage.key(a);

            if (0 === c.indexOf(n)) {
              var l = localStorage.getItem(c);
              if (l && (l = t.serializer.deserialize(l)), void 0 !== (l = e(l, c.substring(o), s++))) return l;
            }
          }
        });
        return u(n, t), n;
      }

      function Ve(e, t) {
        var r = this,
            n = r.ready().then(function () {
          var t,
              n = r._dbInfo;

          try {
            t = localStorage.key(e);
          } catch (e) {
            t = null;
          }

          return t && (t = t.substring(n.keyPrefix.length)), t;
        });
        return u(n, t), n;
      }

      function Me(e) {
        var t = this,
            r = t.ready().then(function () {
          for (var e = t._dbInfo, r = localStorage.length, n = [], o = 0; o < r; o++) {
            var i = localStorage.key(o);
            0 === i.indexOf(e.keyPrefix) && n.push(i.substring(e.keyPrefix.length));
          }

          return n;
        });
        return u(r, e), r;
      }

      function Ue(e) {
        var t = this.keys().then(function (e) {
          return e.length;
        });
        return u(t, e), t;
      }

      function Be(e, t) {
        var r = this;
        e = h(e);
        var n = r.ready().then(function () {
          var t = r._dbInfo;
          localStorage.removeItem(t.keyPrefix + e);
        });
        return u(n, t), n;
      }

      function Ye(e, t, r) {
        var n = this;
        e = h(e);
        var o = n.ready().then(function () {
          void 0 === t && (t = null);
          var r = t;
          return new l(function (o, i) {
            var s = n._dbInfo;
            s.serializer.serialize(t, function (t, n) {
              if (n) i(n);else try {
                localStorage.setItem(s.keyPrefix + e, t), o(r);
              } catch (e) {
                "QuotaExceededError" !== e.name && "NS_ERROR_DOM_QUOTA_REACHED" !== e.name || i(e), i(e);
              }
            });
          });
        });
        return u(o, r), o;
      }

      function Ke(e, t) {
        if (t = f.apply(this, arguments), !(e = "function" != typeof e && e || {}).name) {
          var r = this.config();
          e.name = e.name || r.name, e.storeName = e.storeName || r.storeName;
        }

        var n,
            o = this;
        return n = e.name ? new l(function (t) {
          e.storeName ? t(De(e, o._defaultConfig)) : t(e.name + "/");
        }).then(function (e) {
          for (var t = localStorage.length - 1; t >= 0; t--) {
            var r = localStorage.key(t);
            0 === r.indexOf(e) && localStorage.removeItem(r);
          }
        }) : l.reject("Invalid arguments"), u(n, t), n;
      }

      var We = {
        _driver: "localStorageWrapper",
        _initStorage: qe,
        _support: Ae(),
        iterate: Fe,
        getItem: je,
        setItem: Ye,
        removeItem: Be,
        clear: ke,
        length: Ue,
        key: Ve,
        keys: Me,
        dropInstance: Ke
      },
          ze = function (e, t) {
        return e === t || "number" == typeof e && "number" == typeof t && isNaN(e) && isNaN(t);
      },
          Qe = function (e, t) {
        for (var r = e.length, n = 0; n < r;) {
          if (ze(e[n], t)) return !0;
          n++;
        }

        return !1;
      },
          Ge = Array.isArray || function (e) {
        return "[object Array]" === Object.prototype.toString.call(e);
      },
          Xe = {},
          Je = {},
          Ze = {
        INDEXEDDB: W,
        WEBSQL: Oe,
        LOCALSTORAGE: We
      },
          et = [Ze.INDEXEDDB._driver, Ze.WEBSQL._driver, Ze.LOCALSTORAGE._driver],
          tt = ["dropInstance"],
          rt = ["clear", "getItem", "iterate", "key", "keys", "length", "removeItem", "setItem"].concat(tt),
          nt = {
        description: "",
        driver: et.slice(),
        name: "localforage",
        size: 4980736,
        storeName: "keyvaluepairs",
        version: 1
      };

      function ot(e, t) {
        e[t] = function () {
          var r = arguments;
          return e.ready().then(function () {
            return e[t].apply(e, r);
          });
        };
      }

      function it() {
        for (var e = 1; e < arguments.length; e++) {
          var t = arguments[e];
          if (t) for (var r in t) t.hasOwnProperty(r) && (Ge(t[r]) ? arguments[0][r] = t[r].slice() : arguments[0][r] = t[r]);
        }

        return arguments[0];
      }

      var st = function () {
        function e(t) {
          for (var r in o(this, e), Ze) if (Ze.hasOwnProperty(r)) {
            var n = Ze[r],
                i = n._driver;
            this[r] = i, Xe[i] || this.defineDriver(n);
          }

          this._defaultConfig = it({}, nt), this._config = it({}, this._defaultConfig, t), this._driverSet = null, this._initDriver = null, this._ready = !1, this._dbInfo = null, this._wrapLibraryMethodsWithReady(), this.setDriver(this._config.driver).catch(function () {});
        }

        return e.prototype.config = function (e) {
          if ("object" === (void 0 === e ? "undefined" : n(e))) {
            if (this._ready) return new Error("Can't call config() after localforage has been used.");

            for (var t in e) {
              if ("storeName" === t && (e[t] = e[t].replace(/\W/g, "_")), "version" === t && "number" != typeof e[t]) return new Error("Database version must be a number.");
              this._config[t] = e[t];
            }

            return !("driver" in e) || !e.driver || this.setDriver(this._config.driver);
          }

          return "string" == typeof e ? this._config[e] : this._config;
        }, e.prototype.defineDriver = function (e, t, r) {
          var n = new l(function (t, r) {
            try {
              var n = e._driver,
                  o = new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");
              if (!e._driver) return void r(o);

              for (var i = rt.concat("_initStorage"), s = 0, a = i.length; s < a; s++) {
                var c = i[s];
                if ((!Qe(tt, c) || e[c]) && "function" != typeof e[c]) return void r(o);
              }

              var d = function () {
                for (var t = function (e) {
                  return function () {
                    var t = new Error("Method " + e + " is not implemented by the current driver"),
                        r = l.reject(t);
                    return u(r, arguments[arguments.length - 1]), r;
                  };
                }, r = 0, n = tt.length; r < n; r++) {
                  var o = tt[r];
                  e[o] || (e[o] = t(o));
                }
              };

              d();

              var h = function (r) {
                Xe[n] && console.info("Redefining LocalForage driver: " + n), Xe[n] = e, Je[n] = r, t();
              };

              "_support" in e ? e._support && "function" == typeof e._support ? e._support().then(h, r) : h(!!e._support) : h(!0);
            } catch (e) {
              r(e);
            }
          });
          return d(n, t, r), n;
        }, e.prototype.driver = function () {
          return this._driver || null;
        }, e.prototype.getDriver = function (e, t, r) {
          var n = Xe[e] ? l.resolve(Xe[e]) : l.reject(new Error("Driver not found."));
          return d(n, t, r), n;
        }, e.prototype.getSerializer = function (e) {
          var t = l.resolve(me);
          return d(t, e), t;
        }, e.prototype.ready = function (e) {
          var t = this,
              r = t._driverSet.then(function () {
            return null === t._ready && (t._ready = t._initDriver()), t._ready;
          });

          return d(r, e, e), r;
        }, e.prototype.setDriver = function (e, t, r) {
          var n = this;
          Ge(e) || (e = [e]);

          var o = this._getSupportedDrivers(e);

          function i() {
            n._config.driver = n.driver();
          }

          function s(e) {
            return n._extend(e), i(), n._ready = n._initStorage(n._config), n._ready;
          }

          function a(e) {
            return function () {
              var t = 0;

              function r() {
                for (; t < e.length;) {
                  var o = e[t];
                  return t++, n._dbInfo = null, n._ready = null, n.getDriver(o).then(s).catch(r);
                }

                i();
                var a = new Error("No available storage method found.");
                return n._driverSet = l.reject(a), n._driverSet;
              }

              return r();
            };
          }

          var c = null !== this._driverSet ? this._driverSet.catch(function () {
            return l.resolve();
          }) : l.resolve();
          return this._driverSet = c.then(function () {
            var e = o[0];
            return n._dbInfo = null, n._ready = null, n.getDriver(e).then(function (e) {
              n._driver = e._driver, i(), n._wrapLibraryMethodsWithReady(), n._initDriver = a(o);
            });
          }).catch(function () {
            i();
            var e = new Error("No available storage method found.");
            return n._driverSet = l.reject(e), n._driverSet;
          }), d(this._driverSet, t, r), this._driverSet;
        }, e.prototype.supports = function (e) {
          return !!Je[e];
        }, e.prototype._extend = function (e) {
          it(this, e);
        }, e.prototype._getSupportedDrivers = function (e) {
          for (var t = [], r = 0, n = e.length; r < n; r++) {
            var o = e[r];
            this.supports(o) && t.push(o);
          }

          return t;
        }, e.prototype._wrapLibraryMethodsWithReady = function () {
          for (var e = 0, t = rt.length; e < t; e++) ot(this, rt[e]);
        }, e.prototype.createInstance = function (t) {
          return new e(t);
        }, e;
      }(),
          at = new st();

      t.exports = at;
    }, {
      3: 3
    }]
  }, {}, [4])(4);
  /*!
      localForage -- Offline Storage, Improved
      Version 1.10.0
      https://localforage.github.io/localForage
      (c) 2013-2017 Mozilla, Apache License 2.0
  */


  function a$1(e) {
    return e ? (e ^ 16 * Math.random() >> e / 4).toString(16) : ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, a$1);
  }

  const c$1 = /^[a-fA-F0-9]{8}-(?:[a-fA-F0-9]{4}-){3}[a-fA-F0-9]{12}$/;

  class l$1 extends r$1 {
    _id;
    _savedRemotely = !1;
    static EVENT_SAVED_REMOTELY = "savedremotely";

    set savedRemotely(e) {
      this._savedRemotely !== e && (this._savedRemotely = !!e, this._savedRemotely && this.fireEvent(l$1.EVENT_SAVED_REMOTELY, {
        id: this.id
      }));
    }

    _savedLocally = !1;
    deleted = !1;
    createdStamp;
    modifiedStamp;
    projectId;
    isPristine = !1;

    constructor() {
      super(), this.createdStamp = Math.floor(Date.now() / 1e3);
    }

    unsaved() {
      return !(this._savedLocally && this._savedRemotely);
    }

    get id() {
      return this._id ? "undefined" === this._id && (console.error("id is literal 'undefined', am forcing new id"), this._id = a$1()) : this._id = a$1(), this._id;
    }

    set id(e) {
      if (this._id && e !== this._id) throw new Error(`Occurrence id has already been set, when trying to set new id '${e}'.`);
      this._id = e;
    }

    static _tasks = [];

    queuePost(e) {
      return new Promise((t, r) => {
        const n = () => (console.log({
          "posting form data": e
        }), this.post(e).then(t, r));

        l$1._tasks.push(n), l$1._tasks.length > 1 ? console.log("Added post request to the queue.") : (console.log("No pending tasks, starting post request immediately."), n().finally(l$1._next));
      });
    }

    static _next() {
      if (l$1._tasks.shift(), l$1._tasks.length) return console.log("Running the next task."), l$1._tasks[0]().finally(l$1._next);
    }

    post(e) {
      return fetch(this.SAVE_ENDPOINT, {
        method: "POST",
        body: e
      }).then(e => {
        if (e.ok) {
          return e.clone().json().then(t => {
            switch (console.log({
              "returned to client after save": t
            }), t.saveState) {
              case "SAVED_TO_SERVER":
                this._savedLocally = !0, this.savedRemotely = !0;
                break;

              case "SAVED_LOCALLY":
                this._savedLocally = !0, this.savedRemotely = !1;
                break;

              default:
                console.log(`Unrecognised save state '${t.saveState}'`);
            }

            return this.createdStamp = parseInt(t.created, 10), this.modifiedStamp = parseInt(t.modified, 10), e.json();
          });
        }

        return console.log("Save failed, presumably service worker is missing and there is no network connection. Should write to IndexedDb here."), Promise.reject("IndexedDb storage not yet implemented");
      });
    }

    static retrieveFromLocal(e, t) {
      return s$1.getItem(`${t.TYPE}.${e}`).then(r => r ? (t.id = e, t._parseDescriptor(r), t) : Promise.reject(`Failed to retrieve ${t.TYPE}.${e} locally`));
    }

    _parseDescriptor(e) {
      this._parseAttributes(e.attributes), this._parseSavedState(e.saveState), this.deleted = !0 === e.deleted || "true" === e.deleted, this.createdStamp = parseInt(e.created, 10), this.modifiedStamp = e.modified ? parseInt(e.modified, 10) : 0, this.projectId = parseInt(e.projectId, 10);
    }

    _parseAttributes(e) {
      "string" == typeof e && (e = JSON.parse(e)), Array.isArray(e) ? (console.log("Attributes were spuriously represented as an array rather than as an empty object"), this.attributes = {}) : this.attributes = e;
    }

    _parseSavedState(e) {
      switch (e) {
        case "SAVED_LOCALLY":
          this.savedRemotely = !1, this._savedLocally = !0;
          break;

        case "SAVED_TO_SERVER":
          this.savedRemotely = !0, this._savedLocally = !0;
          break;

        default:
          throw new Error(`Unrecognised saved state '${e}`);
      }
    }

    touch() {
      this.modifiedStamp = Math.floor(Date.now() / 1e3), this.isPristine && (this.isPristine = !1, this.createdStamp = this.modifiedStamp), this._savedLocally = !1, this.savedRemotely = !1;
    }

    evaluateCompletionStatus(e) {
      const t = {};
      let r = !0;

      for (let n in e) if (e.hasOwnProperty(n)) {
        let o = e[n];
        t[n] = o.validator ? o.validator(n, o, this.attributes) : o.field.isValid(n, o, this.attributes), null !== t[n] && (r = r && t[n]);
      }

      return {
        requiredFieldsPresent: r,
        validity: t
      };
    }

  }

  class u$1 extends Error {}

  function d$1(e) {
    try {
      const t = document.createElement("textarea");
      return t.innerHTML = e, t.innerHTML.replace(/"/g, "&quot;");
    } catch (t) {
      const r = document.createElement("pre");
      return r.appendChild(document.createTextNode(e)), r.innerHTML.replace(/"/g, "&quot;");
    }
  }

  class h$1 {
    static rawTaxa;
    id;
    nameString = "";
    canonical = "";
    hybridCanonical = "";
    acceptedEntityId = "";
    qualifier = "";
    authority = "";
    vernacular = "";
    vernacularRoot = "";
    used;
    sortOrder;
    parentIds = [];
    static showVernacular = !0;

    static fromId(e) {
      if (!h$1.rawTaxa) {
        if (!BsbiDb.TaxonNames) throw new u$1("Taxon.fromId() called before taxon list has loaded.");
        h$1.rawTaxa = BsbiDb.TaxonNames;
      }

      if (!h$1.rawTaxa.hasOwnProperty(e)) throw new u$1(`Taxon id '${e}' not found.`);
      const t = h$1.rawTaxa[e],
            r = new h$1();
      return r.id = e, r.nameString = t[0], r.canonical = t[1] || t[0], r.hybridCanonical = t[2] || r.canonical, r.acceptedEntityId = t[3] || e, r.qualifier = t[4], r.authority = t[5], r.vernacular = t[6], r.vernacularRoot = t[7], r.used = t[8], r.sortOrder = t[9], r.parentIds = t[10], r;
    }

    formattedHTML(e) {
      let t;
      return this.id !== this.acceptedEntityId && (t = h$1.fromId(this.acceptedEntityId)), e ? t ? `<q class="taxon-vernacular">${d$1(this.vernacular)}</q><wbr> <span class="italictaxon">${this.nameString}${this.qualifier ? ` <span class="taxon-qualifier">${this.qualifier}</span>` : ""}</span> <span class="taxauthority">${d$1(this.authority)}</span> = <span class="italictaxon">${t.nameString}${t.qualifier ? ` <span class="taxon-qualifier">${t.qualifier}</span>` : ""}</span> <span class="taxauthority">${d$1(t.authority)}</span>` : `<q class="taxon-vernacular">${d$1(this.vernacular)}</q><wbr> <span class="italictaxon">${this.nameString}${this.qualifier ? ` <span class="taxon-qualifier">${this.qualifier}</span>` : ""}</span> <span class="taxauthority">${d$1(this.authority)}</span>` : t ? `<span class="italictaxon">${this.nameString}${this.qualifier ? ` <span class="taxon-qualifier">${this.qualifier}</span>` : ""}</span> <span class="taxauthority">${this.authority}</span>${this.vernacular ? ` <wbr><q class="taxon-vernacular">${d$1(this.vernacular)}</q>` : ""} = <span class="italictaxon">${t.nameString}${t.qualifier ? ` <span class="taxon-qualifier">${t.qualifier}</span>` : ""}</span> <span class="taxauthority">${d$1(t.authority)}</span>` : `<span class="italictaxon">${this.nameString}${this.qualifier ? ` <span class="taxon-qualifier">${this.qualifier}</span>` : ""}</span> <span class="taxauthority">${d$1(this.authority)}</span>${this.vernacular ? ` <wbr><q class="taxon-vernacular">${d$1(this.vernacular)}</q>` : ""}` ;
    }

  }

  class f$1 extends l$1 {
    attributes = {};
    SAVE_ENDPOINT = "/saveoccurrence.php";
    TYPE = "occurrence";
    static EVENT_MODIFIED = "modified";
    isNew = !1;

    get taxon() {
      return this.attributes.taxon && this.attributes.taxon.taxonId ? h$1.fromId(this.attributes.taxon.taxonId) : null;
    }

    formChangedHandler(e) {
      console.log("Occurrence change handler invoked."), e.form.updateModelFromContent(), e.form.conditionallyValidateForm(), this.touch(), this.fireEvent(f$1.EVENT_MODIFIED, {
        occurrenceId: this.id
      });
    }

    delete() {
      this.deleted || (this.touch(), this.deleted = !0, this.fireEvent(f$1.EVENT_MODIFIED, {
        occurrenceId: this.id
      }));
    }

    save(e) {
      if (this._savedRemotely) return Promise.reject(`${this.id} has already been saved.`);
      {
        const t = new FormData();
        return !e && this.surveyId && (e = this.surveyId), t.append("type", this.TYPE), t.append("surveyId", e), t.append("occurrenceId", this.id), t.append("id", this.id), t.append("projectId", this.projectId.toString()), t.append("attributes", JSON.stringify(this.attributes)), t.append("deleted", this.deleted.toString()), t.append("created", this.createdStamp.toString()), console.log("queueing occurrence post"), this.queuePost(t);
      }
    }

    _parseDescriptor(e) {
      super._parseDescriptor(e), this.surveyId = e.surveyId;
    }

  }

  class p$1 extends Error {}

  class v$1 extends e$1 {
    route = "/list/:action/:id";
    static EVENT_SELECT_OCCURRENCE = "selectoccurrence";
    static EVENT_SELECT_SURVEY_SECTION = "selectsurveysection";
    static EVENT_NEW_RECORD = "newrecord";
    static EVENT_DELETE_OCCURRENCE = "deleteoccurrence";
    static EVENT_BACK = "back";
    static EVENT_NEXT_TO_RECORDS = "nexttorecords";
    title = "App homepage";
    app;
    view;
    #r = "";
    needsFullRefresh = !0;
    needRightPanelRefresh = !0;
    viewSubcontext = "";
    surveySection;
    leftPanelBaseRoute = "";

    get occurrences() {
      return this.app.occurrences;
    }

    get currentOccurrence() {
      if (this.#r) {
        if (this.app.occurrences.has(this.#r)) return this.app.occurrences.get(this.#r);
        throw new t$1(`Record id '${this.#r}' was not found.`);
      }

      return null;
    }

    get currentOccurrenceId() {
      return this.#r;
    }

    set currentOccurrenceId(e) {
      this.#r = e;
    }

    get survey() {
      return this.app.currentSurvey;
    }

    constructor(t) {
      super(), this.view = t, t.controller = this, this.handle = e$1.nextHandle, t.addListener(v$1.EVENT_SELECT_OCCURRENCE, this.occurrenceSelectionHandler.bind(this)), t.addListener(v$1.EVENT_SELECT_SURVEY_SECTION, this.surveyPartSelectionHandler.bind(this)), t.addListener(v$1.EVENT_NEW_RECORD, this.newRecordHandler.bind(this)), t.addListener(v$1.EVENT_DELETE_OCCURRENCE, this.deleteOccurrenceHandler.bind(this)), t.addListener(v$1.EVENT_BACK, this.backHandler.bind(this)), t.addListener(v$1.EVENT_NEXT_TO_RECORDS, this.nextTransitionToRecordsHandler.bind(this));
    }

    nextTransitionToRecordsHandler() {
      console.log("in nextTransitionToRecordsHandler()"), this.app.haveExtantOccurrences() ? this.app.router.navigate("/list/record/") : this.newRecordHandler();
    }

    deleteOccurrenceHandler(e) {
      console.log({
        deleting: e.occurrenceId
      });
      const t = this.app.occurrences.get(e.occurrenceId);
      if (!t) throw new p$1(`Occurrence id '${e.occurrenceId}' not found when trying to delete.`);
      t.delete(), this.currentOccurrenceId === e.occurrenceId && this.app.router.navigate("/list/record/");
    }

    surveyPartSelectionHandler(e) {
      console.log({
        "In surveyPartSelectionHandler": e
      }), "record" === e.sectionKey ? this.app.router.navigate("/list/record/") : e.sectionKey ? this.app.router.navigate(`/list/survey/${e.sectionKey}`) : this.app.router.navigate("/list/");
    }

    newRecordHandler() {
      const e = this.app.addNewOccurrence();
      this.app.router.navigate(`/list/record/${e.id}`);
    }

    occurrenceSelectionHandler(e) {
      console.log({
        "In occurrenceSelectionHandler": e
      }), this.currentOccurrenceId && e.occurrenceId && this.currentOccurrenceId === e.occurrenceId ? console.log(`ignoring spurious navigation event for '${e.occurrenceId}'`) : this.app.router.navigate(`/list/record/${e.occurrenceId}`);
    }

    registerRoute(e) {
      e.on("/list", this.mainRouteHandler.bind(this, "list", "", ""), {
        before: this.beforeRouteHandler ? this.beforeRouteHandler.bind(this) : null,
        after: this.afterRouteHandler ? this.afterRouteHandler.bind(this) : null,
        leave: this.leaveRouteHandler ? this.leaveRouteHandler.bind(this) : null,
        already: this.alreadyRouteHandler ? this.alreadyRouteHandler.bind(this) : null
      }), e.on("/list/help", this.mainRouteHandler.bind(this, "list", "", "help")), e.on("/list/record/", this.mainRouteHandler.bind(this, "list", "record", ""), {
        before: this.beforeRouteHandler ? this.beforeRouteHandler.bind(this) : null,
        after: this.afterRouteHandler ? this.afterRouteHandler.bind(this) : null,
        leave: this.leaveRouteHandler ? this.leaveRouteHandler.bind(this) : null,
        already: this.alreadyRouteHandler ? this.alreadyRouteHandler.bind(this) : null
      }), e.on("/list/record/help", this.mainRouteHandler.bind(this, "list", "record", "help")), e.on("/list/record/:id", this.mainRouteHandler.bind(this, "list", "record", "form"), {
        before: this.beforeRouteHandler ? this.beforeRouteHandler.bind(this) : null,
        after: this.afterRouteHandler ? this.afterRouteHandler.bind(this) : null,
        leave: this.leaveRouteHandler ? this.leaveRouteHandler.bind(this) : null,
        already: this.alreadyRouteHandler ? this.alreadyRouteHandler.bind(this) : null
      }), e.on("/list/survey/:section", this.mainRouteHandler.bind(this, "list", "survey", ""), {
        before: this.beforeRouteHandler ? this.beforeRouteHandler.bind(this) : null,
        after: this.afterRouteHandler ? this.afterRouteHandler.bind(this) : null,
        leave: this.leaveRouteHandler ? this.leaveRouteHandler.bind(this) : null,
        already: this.alreadyRouteHandler ? this.alreadyRouteHandler.bind(this) : null
      }), e.on("/list/survey/:section/help", this.mainRouteHandler.bind(this, "list", "survey", "help"));
    }

    mainRouteHandler(e, t, r, n) {
      console.log("reached special route handler for MainController.js"), console.log({
        context: e,
        params: t,
        query: n
      }), this.app.saveRoute();

      try {
        this.viewSubcontext = t, t && this.viewContexts[t].call(this, n), this.app.currentControllerHandle !== this.handle && (this.needsFullRefresh = !0, this.needRightPanelRefresh = !0, this.app.currentControllerHandle = this.handle), this.view.panelKey = r, this.view.display(), this.needsFullRefresh = !1;
      } catch (e) {
        this.error = e, console.log({
          error: e
        });

        try {
          this.needsFullRefresh = !0, this.view.display();
        } catch (e) {
          console.log({
            rethrownError: e
          }), document.body.innerHTML = `<h2>Internal error</h2><p>Please report this problem:</p><p>${e.message}</p>`;
        }
      }
    }

    viewContexts = {
      record(e) {
        this.surveySection = null, e ? this.#r !== e.id ? (this.needRightPanelRefresh = !0, this.currentOccurrenceId = e.id ? e.id : "") : this.needRightPanelRefresh = !1 : (this.currentOccurrenceId = "", this.needRightPanelRefresh = !0), this.leftPanelBaseRoute = "/list/record";
      },

      survey(e) {
        console.log(`in survey section ${e.section}`), this.currentOccurrenceId = "", this.needRightPanelRefresh = !0, this.surveySection = e.section, this.leftPanelBaseRoute = `/list/survey/${e.section}`;
      }

    };

    backHandler() {
      this.app.routeHistory.length >= 2 && this.app.routeHistory[this.app.routeHistory.length - 2].url === this.leftPanelBaseRoute ? (this.app.routeHistory.length -= 1, console.log("using standard back navigation"), window.history.back()) : (console.log(`navigating back using base address '${this.leftPanelBaseRoute}'`), this.app.router.navigate(this.leftPanelBaseRoute));
    }

  }

  class y$1 extends e$1 {
    route;

    constructor(t, r) {
      super(), this.view = t, this.route = r, this.handle = e$1.nextHandle;
    }

    routeHandler(e, t) {
      this.app.currentControllerHandle = this.handle, this.view.display();
    }

  }

  class m$1 extends l$1 {
    static EVENT_MODIFIED = "modified";
    SAVE_ENDPOINT = "/savesurvey.php";
    TYPE = "survey";
    attributes = {};
    isNew = !1;
    hasAppModifiedListener = !1;

    get geoReference() {
      return this.attributes.georef || {
        gridRef: "",
        rawString: "",
        source: "unknown",
        latLng: null,
        precision: null
      };
    }

    get date() {
      return this.attributes.date || "";
    }

    get place() {
      return this.attributes.place || "";
    }

    formChangedHandler(e) {
      console.log("Survey change handler invoked."), e.form.updateModelFromContent(), console.log("Survey calling conditional validation."), e.form.conditionallyValidateForm(), this.touch(), this.fireEvent(m$1.EVENT_MODIFIED, {
        surveyId: this.id
      });
    }

    setAttribute(e, t) {
      this.attributes[e] !== t && (this.attributes[e] = t, this.touch(), this.fireEvent(m$1.EVENT_MODIFIED, {
        surveyId: this.id
      }));
    }

    save() {
      if (this._savedRemotely) return Promise.reject(`${this.id} has already been saved.`);
      {
        const e = new FormData();
        return e.append("type", this.TYPE), e.append("surveyId", this.id), e.append("id", this.id), e.append("projectId", this.projectId.toString()), e.append("attributes", JSON.stringify(this.attributes)), e.append("deleted", this.deleted.toString()), e.append("created", this.createdStamp.toString()), console.log("queueing survey post"), this.queuePost(e);
      }
    }

    generateSurveyName() {
      let e = (this.attributes.place || this.attributes.georef && this.attributes.georef.gridRef || "(unlocalised)").trim();
      const t = this.date;
      let r;
      if (t) r = t;else {
        const e = new Date(1e3 * this.createdStamp);

        try {
          r = e.toLocaleString("default", {
            year: "numeric",
            month: "long",
            day: "numeric"
          });
        } catch (t) {
          r = e.toLocaleString("en-GB", {
            year: "numeric",
            month: "long",
            day: "numeric"
          });
        }
      }
      return `${d$1(e)} ${r}`;
    }

  }

  class g$1 extends l$1 {
    file;
    static imageCache = new Map();
    TYPE = "image";

    getUrl() {}

    SAVE_ENDPOINT = "/saveimage.php";

    static fromFile(e) {
      const t = new g$1();
      return t.file = e, t;
    }

    save(e, t, r) {
      if (this._savedRemotely) return Promise.reject(`${this.id} has already been saved.`);
      {
        const n = new FormData();
        return n.append("type", this.TYPE), n.append("surveyId", e || ""), n.append("occurrenceId", t || this.occurrenceId), n.append("projectId", r ? r.toString() : ""), n.append("imageId", this.id), n.append("id", this.id), n.append("image", this.file), n.append("deleted", this.deleted.toString()), console.log(`queueing image post, image id ${this.id}`), this.queuePost(n);
      }
    }

    static EVENT_MODIFIED = "modified";

    static placeholder(e) {
      let t = new g$1();
      return t._id = e, g$1.imageCache.set(e, t), t;
    }

    _parseDescriptor(e) {
      super._parseDescriptor(e), this.surveyId = e.surveyId, this.occurrenceId = e.occurrenceId, this.file = e.image;
    }

    static imageLink(e, t, r, n) {
      t = t || 0, r = r || 0;
      let o = "";
      n.className && (o += ` class="${n.className}"`);
      return `<picture><source srcset="/image.php?imageid=${e}&amp;height=128&amp;format=webp" type="image/webp"><img${o} src="/image.php?imageid=${e}&amp;width=${t}&amp;height=${r}&amp;format=jpeg" ${t > r ? `width="${t}"` : `height="${r}"`} alt="photo"></picture>`;
    }

  }

  class b$1 extends r$1 {
    #n;
    #o;
    controllers = [];
    currentControllerHandle = !1;
    routeHistory = [];
    occurrences;
    surveys;
    _currentSurvey = null;

    set currentSurvey(e) {
      if (this._currentSurvey !== e) {
        this._currentSurvey = e || null;
        let t = e ? e.id : null;
        s$1.setItem(b$1.CURRENT_SURVEY_KEY_NAME, t);
      }
    }

    get currentSurvey() {
      return this._currentSurvey;
    }

    getLastSurveyId() {
      return s$1.getItem(b$1.CURRENT_SURVEY_KEY_NAME).catch(e => (console.log({
        "Error retrieving last survey id": e
      }), Promise.resolve(null)));
    }

    layout;
    static EVENT_ADD_SURVEY_USER_REQUEST = "useraddsurveyrequest";
    static EVENT_RESET_SURVEYS = "userresetsurveys";
    static EVENT_NEW_SURVEY = "newsurvey";
    static LOAD_SURVEYS_ENDPOINT = "/loadsurveys.php";
    static EVENT_OCCURRENCE_ADDED = "occurrenceadded";
    static EVENT_SURVEYS_CHANGED = "surveyschanged";
    static EVENT_ALL_SYNCED_TO_SERVER = "allsyncedtoserver";
    static EVENT_SYNC_ALL_FAILED = "syncallfailed";
    static CURRENT_SURVEY_KEY_NAME = "currentsurvey";
    static devMode = !1;

    constructor() {
      super(), this.reset();
    }

    setLocalForageName(e) {
      s$1.config({
        name: e
      });
    }

    reset() {
      this.surveys = new Map(), this.clearCurrentSurvey();
    }

    clearCurrentSurvey() {
      this.occurrences = new Map(), this.currentSurvey = null;
    }

    set router(e) {
      this.#n = e;
    }

    get router() {
      return this.#n;
    }

    set containerId(e) {
      const t = document.getElementById(e);
      if (!t) throw new Error(`App container '${e}' not found.`);
      this.#o = t;
    }

    get container() {
      return this.#o;
    }

    registerController(e) {
      e.handle = this.controllers.length, this.controllers[this.controllers.length] = e, e.app = this, e.registerRoute(this.#n);
    }

    initialise() {
      this.layout.initialise(), this.#n.notFound(e => {
        console.log(`no route found for '${e}'`), this.notFoundView();
      }), this.#n.on(() => {
        console.log("redirecting from '/' to '/list'"), this.#n.pause(), this.currentSurvey && this.currentSurvey.isPristine ? this.#n.navigate("/list/survey/welcome").resume() : this.#n.navigate("/list").resume(), this.#n.resolve();
      });

      for (let e of this.controllers) e.initialise();
    }

    display() {
      console.log("App display"), this.#n.resolve(), this.syncAll();
    }

    saveRoute() {
      const e = this.#n.lastRouteResolved();
      this.routeHistory.length ? this.routeHistory[this.routeHistory.length - 1] !== e && (this.routeHistory[this.routeHistory.length] = e) : this.routeHistory[0] = e;
    }

    markAllNotPristine() {
      for (let e of this.occurrences) e[1].isPristine = !1;
    }

    setLayout(e) {
      this.layout = e, e.setApp(this);
    }

    addSurvey(e) {
      if (e.projectId !== this.projectId) throw new Error(`Survey project id '${e.projectId} does not match with current project ('${this.projectId}')`);
      e.hasAppModifiedListener || (e.hasAppModifiedListener = !0, console.log("setting survey's modified/save handler"), e.addListener(m$1.EVENT_MODIFIED, () => (this.fireEvent(b$1.EVENT_SURVEYS_CHANGED), e.save()))), this.surveys.set(e.id, e), this.fireEvent(b$1.EVENT_SURVEYS_CHANGED);
    }

    haveExtantOccurrences() {
      for (let e of this.occurrences) if (!e.deleted) return !0;

      return !1;
    }

    addOccurrence(e) {
      if (!e.surveyId) throw new p$1("Survey id must set prior to registering occurrence.");

      if (0 === this.occurrences.size) {
        this.surveys.get(e.surveyId).createdStamp = e.createdStamp;
      }

      console.log(`in addOccurrence setting id '${e.id}'`), this.occurrences.set(e.id, e), e.addListener(f$1.EVENT_MODIFIED, () => {
        const t = this.surveys.get(e.surveyId);
        if (!t) throw new Error(`Failed to look up survey id ${e.surveyId}`);
        t.isPristine = !1, t.unsaved() && t.save(), e.save(t.id);
      });
    }

    refreshFromServer(e) {
      console.log({
        "Refresh from server, ids": e
      });
      const t = new FormData();
      let r = 0;

      for (let n of e) n && "undefined" !== n && t.append(`surveyId[${r++}]`, n);

      return fetch(b$1.LOAD_SURVEYS_ENDPOINT, {
        method: "POST",
        body: t
      }).then(e => e.ok ? e.json() : Promise.reject("Invalid response from server when refreshing survey ids")).then(e => {
        console.log({
          "refresh from server json response": e
        });
        const t = [];

        for (let r in e) if (e.hasOwnProperty(r)) for (let n of e[r]) t.push(this._conditionallyReplaceObject(n));

        return Promise.all(t);
      });
    }

    _conditionallyReplaceObject(e) {
      const t = `${e.type}.${e.id}`;
      return s$1.getItem(t).then(r => r && !e.deleted && r.modified >= e.modified ? (console.log(`Local copy of ${t} is the same or newer than the server copy. (${r.modified} >= ${e.modified}) `), Promise.resolve()) : (console.log(`Adding or replacing local copy of ${t}`), s$1.setItem(t, e)));
    }

    seekKeys(e) {
      return console.log("starting seekKeys"), s$1.keys().then(t => {
        console.log({
          "in seekKeys: local forage keys": t
        });

        for (let r of t) if (r !== b$1.CURRENT_SURVEY_KEY_NAME) {
          let t, n;
          [t, n] = r.split(".", 2), e.hasOwnProperty(t) ? e[t].includes(n) || e[t].push(n) : console.log(`Unrecognised stored key type '${t}.`);
        }

        return e;
      });
    }

    syncAll() {
      return this.seekKeys({
        survey: [],
        occurrence: [],
        image: []
      }).then(e => this._syncLocalUnsaved(e).then(e => (this.fireEvent(b$1.EVENT_ALL_SYNCED_TO_SERVER), e)), e => (console.log(`Failed to sync all: ${e}`), this.fireEvent(b$1.EVENT_SYNC_ALL_FAILED), !1));
    }

    _syncLocalUnsaved(e) {
      const t = [];

      for (let r of e.survey) t.push(m$1.retrieveFromLocal(r, new m$1()).then(e => {
        if (e.unsaved()) return e.save();
      }));

      for (let r of e.occurrence) t.push(f$1.retrieveFromLocal(r, new f$1()).then(e => {
        if (e.unsaved()) return e.save();
      }));

      for (let r of e.image) t.push(g$1.retrieveFromLocal(r, new g$1()).then(e => {
        if (e.unsaved()) return e.save();
      }));

      return Promise.all(t).catch(e => (console.log(`Save failure: ${e}`), Promise.reject(e)));
    }

    restoreOccurrences(e = "") {
      return console.log(`Invoked restoreOccurrences, target survey id: ${e}`), "undefined" === e && (console.error("Attempt to restore occurrences for literal 'undefined' survey id."), e = ""), e ? this._restoreOccurrenceImp(e) : this.getLastSurveyId().then(e => (console.log(`Retrieved last used survey id '${e}'`), this._restoreOccurrenceImp(e).catch(() => (console.log(`Failed to retrieve lastSurveyId ${e}. Resetting current survey and retrying.`), this.currentSurvey = null, this._restoreOccurrenceImp()))), () => this._restoreOccurrenceImp());
    }

    _restoreOccurrenceImp(e) {
      if (e && this.surveys.has(e)) {
        const t = this.surveys.get(e);
        if (t.isPristine) return this.clearCurrentSurvey(), this.currentSurvey = t, this.fireEvent(b$1.EVENT_SURVEYS_CHANGED), Promise.resolve();
      }

      const t = {
        survey: [],
        occurrence: [],
        image: []
      };
      return e && (t.survey[0] = e), this.seekKeys(t).then(e => e.survey.length ? this.refreshFromServer(e.survey).finally(() => this.seekKeys(e)) : null).finally(() => {
        if (console.log({
          storedObjectKeys: t
        }), t && t.survey && t.survey.length) {
          const r = [];
          let n = 0;

          for (let o of t.survey) r.push(this._restoreSurveyFromLocal(o, t, e === o || !e && 0 == n++));

          return Promise.all(r).finally(() => this.currentSurvey ? (this.currentSurvey.deleted ? this.setNewSurvey() : this.fireEvent(b$1.EVENT_SURVEYS_CHANGED), Promise.resolve()) : (console.log(`Failed to retrieve survey id '${e}'`), Promise.reject(new Error(`Failed to retrieve survey id '${e}'`))));
        }

        return console.log("no pre-existing surveys, so creating a new one"), this.setNewSurvey(), Promise.resolve();
      });
    }

    setNewSurvey() {
      this.currentSurvey = new m$1(), this.currentSurvey.projectId = this.projectId, this.currentSurvey.isPristine = !0, this.currentSurvey.isNew = !0, this.fireEvent(b$1.EVENT_NEW_SURVEY), this.addSurvey(this.currentSurvey);
    }

    addNewOccurrence() {
      const e = new f$1();
      return e.surveyId = this.currentSurvey.id, e.projectId = this.projectId, e.isNew = !0, e.isPristine = !0, this.addOccurrence(e), this.fireEvent(b$1.EVENT_OCCURRENCE_ADDED, {
        occurrenceId: e.id,
        surveyId: e.surveyId
      }), e;
    }

    _restoreSurveyFromLocal(e, t, r) {
      let n = m$1.retrieveFromLocal(e, new m$1()).then(n => {
        if (console.log(`retrieving local survey ${e}`), r) {
          this.clearCurrentSurvey(), this.addSurvey(n);
          const r = [];

          for (let n of t.occurrence) r.push(f$1.retrieveFromLocal(n, new f$1()).then(t => {
            t.surveyId === e && (console.log(`adding occurrence ${n}`), this.addOccurrence(t));
          }));

          return Promise.all(r);
        }

        this.addSurvey(n);
      });
      return r && n.finally(() => {
        const r = [];

        for (let n of t.image) r.push(g$1.retrieveFromLocal(n, new g$1()).then(t => {
          console.log(`restoring image id '${n}'`), t.surveyId === e && g$1.imageCache.set(n, t);
        }, e => {
          console.log(`Failed to retrieve an image: ${e}`);
        }));

        return this.currentSurvey = this.surveys.get(t.survey[0]), Promise.all(r);
      }), n;
    }

    clearLocalForage() {
      return s$1.clear();
    }

  }

  class S$1 extends e$1 {
    route = "/survey/:action/:id";
    static EVENT_BACK = "back";
    title = "Survey picker";
    app;
    view;

    get survey() {
      return this.app.currentSurvey;
    }

    constructor(t) {
      super(), this.view = t, t.controller = this, this.handle = e$1.nextHandle;
    }

    registerRoute(e) {
      e.on("/survey", this.mainRouteHandler.bind(this, "survey", "", ""), {}), e.on("/survey/new", this.newSurveyHandler.bind(this, "survey", "new", ""), {
        before: this.beforeNewHandler.bind(this)
      }), e.on("/survey/reset", this.mainRouteHandler.bind(this, "survey", "reset", ""), {
        before: this.beforeResetHandler.bind(this)
      }), e.on("/survey/save", this.mainRouteHandler.bind(this, "survey", "save", ""), {
        before: this.beforeSaveAllHandler.bind(this)
      }), e.on("/survey/add/:surveyId", this.addSurveyHandler.bind(this, "survey", "add", "")), this.app.addListener(b$1.EVENT_ADD_SURVEY_USER_REQUEST, this.addNewSurveyHandler.bind(this)), this.app.addListener(b$1.EVENT_RESET_SURVEYS, this.resetSurveysHandler.bind(this));
    }

    beforeNewHandler(e) {
      this.view.newSurveyDialog(), this.app.router.pause(), console.log({
        "route history": this.app.routeHistory
      }), window.history.state && window.history.back(), this.app.router.resume(), e(!1);
    }

    beforeResetHandler(e) {
      this.view.showResetDialog(), this.app.router.pause(), window.history.state && window.history.back(), this.app.router.resume(), e(!1);
    }

    beforeSaveAllHandler(e) {
      this.app.syncAll().then(e => {
        console.log({
          "In save all handler, success result": e
        }), Array.isArray(e) ? this.view.showSaveAllSuccess() : this.view.showSaveAllFailure();
      }, e => {
        console.log({
          "In save all handler, failure result": e
        }), this.view.showSaveAllFailure();
      }).finally(() => {}), this.app.router.pause(), window.history.state && window.history.back(), this.app.router.resume(), e(!1);
    }

    newSurveyHandler(e, t, r, n) {}

    addNewSurveyHandler() {
      console.log("reached addNewSurveyHandler"), this.app.currentControllerHandle = this.handle, this.app.clearCurrentSurvey(), this.app.setNewSurvey(), this.app.syncAll(), this.app.router.pause(), this.app.router.navigate("/list/survey/about").resume(), this.app.router.resolve();
    }

    resetSurveysHandler() {
      this.app.clearLocalForage().then(() => {
        this.app.reset(), this.addNewSurveyHandler();
      });
    }

    addSurveyHandler(e, r, n, o) {
      console.log("reached addSurveyHandler"), console.log({
        context: e,
        params: r,
        query: o
      }), this.app.currentControllerHandle = this.handle;
      let i = o.surveyId;
      if (!i || !i.match(c$1)) throw new t$1(`Failed to match survey id '${i}', the id format appears to be incorrect`);
      i = i.toLowerCase(), this.app.restoreOccurrences(i).then(() => {
        this.app.markAllNotPristine(), this.app.router.pause(), this.app.router.navigate("/list").resume(), this.app.router.resolve();
      }, e => {
        console.log({
          "failed survey restoration": e
        });
      });
    }

    mainRouteHandler(e, t, r, n) {
      console.log("reached special route handler for SurveyPickerController.js"), console.log({
        context: e,
        params: t,
        query: n
      });
    }

  }

  class $$8 {
    static callbackStack = [];

    static taxaLoadedEntryPoint() {
      for (h$1.rawTaxa = BsbiDb.TaxonNames; $$8.callbackStack.length;) {
        const e = $$8.callbackStack.shift();

        try {
          e();
        } catch (e) {
          console.log({
            "Exception after taxon load": e
          });
        }
      }
    }

    static onceTaxaLoaded() {
      return BsbiDb.hasOwnProperty("TaxonNames") ? Promise.resolve() : (BsbiDb.taxonNamesLoadedEntryPoint || (BsbiDb.taxonNamesLoadedEntryPoint = $$8.taxaLoadedEntryPoint), new Promise(e => {
        $$8.callbackStack.push(e);
      }));
    }

  }

  var PROJECT_ID_NYPH = 2;
  var FORAGE_NAME = 'Nyph App';
  var NyphApp = /*#__PURE__*/function (_App) {
    _inherits(NyphApp, _App);

    var _super = _createSuper(NyphApp);

    /**
     * @type {number}
     */
    //static LOAD_SURVEYS_ENDPOINT = '/loadsurveys.php';
    //static EVENT_OCCURRENCE_ADDED = 'occurrenceadded';
    //static EVENT_SURVEYS_CHANGED = 'surveyschanged';

    /**
     *
     * @type {boolean}
     */
    function NyphApp() {
      var _this;

      _classCallCheck(this, NyphApp);

      _this = _super.call(this);

      _defineProperty(_assertThisInitialized(_this), "projectId", PROJECT_ID_NYPH);

      _defineProperty(_assertThisInitialized(_this), "_coreSurveyFields", ['recorder', 'email']);

      _defineProperty(_assertThisInitialized(_this), "_coreSurveyFieldCache", []);

      _this.initialiseSurveyFieldsMirror();

      return _this;
    }

    _createClass(NyphApp, [{
      key: "initialiseSurveyFieldsMirror",
      value:
      /**
       * Sets handlers to allow certain survey fields to be duplicated from last current survey to new survey
       * used for email address and primary recorder name
       */
      function initialiseSurveyFieldsMirror() {
        var _this2 = this;

        this.addListener(b$1.EVENT_NEW_SURVEY, function () {
          console.log('Try to initialise core fields of new survey.');

          if (_this2._coreSurveyFieldCache) {
            console.log({
              'Using cached survey values': _this2._coreSurveyFieldCache
            });

            var _iterator = _createForOfIteratorHelper(_this2._coreSurveyFields),
                _step;

            try {
              for (_iterator.s(); !(_step = _iterator.n()).done;) {
                var key = _step.value;
                _this2.currentSurvey.attributes[key] = _this2._coreSurveyFieldCache[key];
              }
            } catch (err) {
              _iterator.e(err);
            } finally {
              _iterator.f();
            }
          }
        });
        this.addListener(b$1.EVENT_SURVEYS_CHANGED, function () {
          if (_this2.currentSurvey && !_this2.currentSurvey.isNew) {
            var _iterator2 = _createForOfIteratorHelper(_this2._coreSurveyFields),
                _step2;

            try {
              for (_iterator2.s(); !(_step2 = _iterator2.n()).done;) {
                var key = _step2.value;
                _this2._coreSurveyFieldCache[key] = _this2.currentSurvey.attributes[key];
              }
            } catch (err) {
              _iterator2.e(err);
            } finally {
              _iterator2.f();
            }

            console.log({
              'Saved core survey fields': _this2._coreSurveyFieldCache
            });
          }
        });
        this.addListener(b$1.EVENT_RESET_SURVEYS, function () {
          _this2._coreSurveyFieldCache = [];
          console.log('Have reset core survey field cache.');
        });
      }
    }, {
      key: "notFoundView",
      value: function notFoundView() {
        var view = new NotFoundView();
        view.display();
      }
    }]);

    return NyphApp;
  }(b$1);

  _defineProperty(NyphApp, "forageName", FORAGE_NAME);

  _defineProperty(NyphApp, "devMode", false);

  var global$7 = global$N;
  var isArray$1 = isArray$3;
  var isConstructor = isConstructor$3;
  var isObject$8 = isObject$i;
  var wellKnownSymbol$5 = wellKnownSymbol$k;

  var SPECIES = wellKnownSymbol$5('species');
  var Array$1 = global$7.Array;

  // a part of `ArraySpeciesCreate` abstract operation
  // https://tc39.es/ecma262/#sec-arrayspeciescreate
  var arraySpeciesConstructor$1 = function (originalArray) {
    var C;
    if (isArray$1(originalArray)) {
      C = originalArray.constructor;
      // cross-realm fallback
      if (isConstructor(C) && (C === Array$1 || isArray$1(C.prototype))) C = undefined;
      else if (isObject$8(C)) {
        C = C[SPECIES];
        if (C === null) C = undefined;
      }
    } return C === undefined ? Array$1 : C;
  };

  var arraySpeciesConstructor = arraySpeciesConstructor$1;

  // `ArraySpeciesCreate` abstract operation
  // https://tc39.es/ecma262/#sec-arrayspeciescreate
  var arraySpeciesCreate$2 = function (originalArray, length) {
    return new (arraySpeciesConstructor(originalArray))(length === 0 ? 0 : length);
  };

  var $$7 = _export;
  var global$6 = global$N;
  var fails$9 = fails$q;
  var isArray = isArray$3;
  var isObject$7 = isObject$i;
  var toObject$3 = toObject$5;
  var lengthOfArrayLike$2 = lengthOfArrayLike$7;
  var createProperty = createProperty$3;
  var arraySpeciesCreate$1 = arraySpeciesCreate$2;
  var arrayMethodHasSpeciesSupport = arrayMethodHasSpeciesSupport$2;
  var wellKnownSymbol$4 = wellKnownSymbol$k;
  var V8_VERSION = engineV8Version;

  var IS_CONCAT_SPREADABLE = wellKnownSymbol$4('isConcatSpreadable');
  var MAX_SAFE_INTEGER = 0x1FFFFFFFFFFFFF;
  var MAXIMUM_ALLOWED_INDEX_EXCEEDED = 'Maximum allowed index exceeded';
  var TypeError$1 = global$6.TypeError;

  // We can't use this feature detection in V8 since it causes
  // deoptimization and serious performance degradation
  // https://github.com/zloirock/core-js/issues/679
  var IS_CONCAT_SPREADABLE_SUPPORT = V8_VERSION >= 51 || !fails$9(function () {
    var array = [];
    array[IS_CONCAT_SPREADABLE] = false;
    return array.concat()[0] !== array;
  });

  var SPECIES_SUPPORT = arrayMethodHasSpeciesSupport('concat');

  var isConcatSpreadable = function (O) {
    if (!isObject$7(O)) return false;
    var spreadable = O[IS_CONCAT_SPREADABLE];
    return spreadable !== undefined ? !!spreadable : isArray(O);
  };

  var FORCED$2 = !IS_CONCAT_SPREADABLE_SUPPORT || !SPECIES_SUPPORT;

  // `Array.prototype.concat` method
  // https://tc39.es/ecma262/#sec-array.prototype.concat
  // with adding support of @@isConcatSpreadable and @@species
  $$7({ target: 'Array', proto: true, forced: FORCED$2 }, {
    // eslint-disable-next-line no-unused-vars -- required for `.length`
    concat: function concat(arg) {
      var O = toObject$3(this);
      var A = arraySpeciesCreate$1(O, 0);
      var n = 0;
      var i, k, length, len, E;
      for (i = -1, length = arguments.length; i < length; i++) {
        E = i === -1 ? O : arguments[i];
        if (isConcatSpreadable(E)) {
          len = lengthOfArrayLike$2(E);
          if (n + len > MAX_SAFE_INTEGER) throw TypeError$1(MAXIMUM_ALLOWED_INDEX_EXCEEDED);
          for (k = 0; k < len; k++, n++) if (k in E) createProperty(A, n, E[k]);
        } else {
          if (n >= MAX_SAFE_INTEGER) throw TypeError$1(MAXIMUM_ALLOWED_INDEX_EXCEEDED);
          createProperty(A, n++, E);
        }
      }
      A.length = n;
      return A;
    }
  });

  var wellKnownSymbol$3 = wellKnownSymbol$k;
  var create$1 = objectCreate;
  var definePropertyModule = objectDefineProperty;

  var UNSCOPABLES = wellKnownSymbol$3('unscopables');
  var ArrayPrototype = Array.prototype;

  // Array.prototype[@@unscopables]
  // https://tc39.es/ecma262/#sec-array.prototype-@@unscopables
  if (ArrayPrototype[UNSCOPABLES] == undefined) {
    definePropertyModule.f(ArrayPrototype, UNSCOPABLES, {
      configurable: true,
      value: create$1(null)
    });
  }

  // add a key to Array.prototype[@@unscopables]
  var addToUnscopables$1 = function (key) {
    ArrayPrototype[UNSCOPABLES][key] = true;
  };

  var fails$8 = fails$q;

  var correctPrototypeGetter = !fails$8(function () {
    function F() { /* empty */ }
    F.prototype.constructor = null;
    // eslint-disable-next-line es/no-object-getprototypeof -- required for testing
    return Object.getPrototypeOf(new F()) !== F.prototype;
  });

  var global$5 = global$N;
  var hasOwn$3 = hasOwnProperty_1;
  var isCallable$4 = isCallable$l;
  var toObject$2 = toObject$5;
  var sharedKey = sharedKey$3;
  var CORRECT_PROTOTYPE_GETTER = correctPrototypeGetter;

  var IE_PROTO = sharedKey('IE_PROTO');
  var Object$1 = global$5.Object;
  var ObjectPrototype = Object$1.prototype;

  // `Object.getPrototypeOf` method
  // https://tc39.es/ecma262/#sec-object.getprototypeof
  var objectGetPrototypeOf = CORRECT_PROTOTYPE_GETTER ? Object$1.getPrototypeOf : function (O) {
    var object = toObject$2(O);
    if (hasOwn$3(object, IE_PROTO)) return object[IE_PROTO];
    var constructor = object.constructor;
    if (isCallable$4(constructor) && object instanceof constructor) {
      return constructor.prototype;
    } return object instanceof Object$1 ? ObjectPrototype : null;
  };

  var fails$7 = fails$q;
  var isCallable$3 = isCallable$l;
  var getPrototypeOf$1 = objectGetPrototypeOf;
  var redefine$2 = redefine$9.exports;
  var wellKnownSymbol$2 = wellKnownSymbol$k;

  var ITERATOR$2 = wellKnownSymbol$2('iterator');
  var BUGGY_SAFARI_ITERATORS$1 = false;

  // `%IteratorPrototype%` object
  // https://tc39.es/ecma262/#sec-%iteratorprototype%-object
  var IteratorPrototype$2, PrototypeOfArrayIteratorPrototype, arrayIterator;

  /* eslint-disable es/no-array-prototype-keys -- safe */
  if ([].keys) {
    arrayIterator = [].keys();
    // Safari 8 has buggy iterators w/o `next`
    if (!('next' in arrayIterator)) BUGGY_SAFARI_ITERATORS$1 = true;
    else {
      PrototypeOfArrayIteratorPrototype = getPrototypeOf$1(getPrototypeOf$1(arrayIterator));
      if (PrototypeOfArrayIteratorPrototype !== Object.prototype) IteratorPrototype$2 = PrototypeOfArrayIteratorPrototype;
    }
  }

  var NEW_ITERATOR_PROTOTYPE = IteratorPrototype$2 == undefined || fails$7(function () {
    var test = {};
    // FF44- legacy iterators case
    return IteratorPrototype$2[ITERATOR$2].call(test) !== test;
  });

  if (NEW_ITERATOR_PROTOTYPE) IteratorPrototype$2 = {};

  // `%IteratorPrototype%[@@iterator]()` method
  // https://tc39.es/ecma262/#sec-%iteratorprototype%-@@iterator
  if (!isCallable$3(IteratorPrototype$2[ITERATOR$2])) {
    redefine$2(IteratorPrototype$2, ITERATOR$2, function () {
      return this;
    });
  }

  var iteratorsCore = {
    IteratorPrototype: IteratorPrototype$2,
    BUGGY_SAFARI_ITERATORS: BUGGY_SAFARI_ITERATORS$1
  };

  var IteratorPrototype$1 = iteratorsCore.IteratorPrototype;
  var create = objectCreate;
  var createPropertyDescriptor$1 = createPropertyDescriptor$5;
  var setToStringTag$2 = setToStringTag$4;
  var Iterators$2 = iterators;

  var returnThis$1 = function () { return this; };

  var createIteratorConstructor$1 = function (IteratorConstructor, NAME, next, ENUMERABLE_NEXT) {
    var TO_STRING_TAG = NAME + ' Iterator';
    IteratorConstructor.prototype = create(IteratorPrototype$1, { next: createPropertyDescriptor$1(+!ENUMERABLE_NEXT, next) });
    setToStringTag$2(IteratorConstructor, TO_STRING_TAG, false);
    Iterators$2[TO_STRING_TAG] = returnThis$1;
    return IteratorConstructor;
  };

  var $$6 = _export;
  var call = functionCall;
  var FunctionName = functionName;
  var isCallable$2 = isCallable$l;
  var createIteratorConstructor = createIteratorConstructor$1;
  var getPrototypeOf = objectGetPrototypeOf;
  var setPrototypeOf$2 = objectSetPrototypeOf;
  var setToStringTag$1 = setToStringTag$4;
  var createNonEnumerableProperty$3 = createNonEnumerableProperty$8;
  var redefine$1 = redefine$9.exports;
  var wellKnownSymbol$1 = wellKnownSymbol$k;
  var Iterators$1 = iterators;
  var IteratorsCore = iteratorsCore;

  var PROPER_FUNCTION_NAME = FunctionName.PROPER;
  var CONFIGURABLE_FUNCTION_NAME = FunctionName.CONFIGURABLE;
  var IteratorPrototype = IteratorsCore.IteratorPrototype;
  var BUGGY_SAFARI_ITERATORS = IteratorsCore.BUGGY_SAFARI_ITERATORS;
  var ITERATOR$1 = wellKnownSymbol$1('iterator');
  var KEYS = 'keys';
  var VALUES = 'values';
  var ENTRIES = 'entries';

  var returnThis = function () { return this; };

  var defineIterator$2 = function (Iterable, NAME, IteratorConstructor, next, DEFAULT, IS_SET, FORCED) {
    createIteratorConstructor(IteratorConstructor, NAME, next);

    var getIterationMethod = function (KIND) {
      if (KIND === DEFAULT && defaultIterator) return defaultIterator;
      if (!BUGGY_SAFARI_ITERATORS && KIND in IterablePrototype) return IterablePrototype[KIND];
      switch (KIND) {
        case KEYS: return function keys() { return new IteratorConstructor(this, KIND); };
        case VALUES: return function values() { return new IteratorConstructor(this, KIND); };
        case ENTRIES: return function entries() { return new IteratorConstructor(this, KIND); };
      } return function () { return new IteratorConstructor(this); };
    };

    var TO_STRING_TAG = NAME + ' Iterator';
    var INCORRECT_VALUES_NAME = false;
    var IterablePrototype = Iterable.prototype;
    var nativeIterator = IterablePrototype[ITERATOR$1]
      || IterablePrototype['@@iterator']
      || DEFAULT && IterablePrototype[DEFAULT];
    var defaultIterator = !BUGGY_SAFARI_ITERATORS && nativeIterator || getIterationMethod(DEFAULT);
    var anyNativeIterator = NAME == 'Array' ? IterablePrototype.entries || nativeIterator : nativeIterator;
    var CurrentIteratorPrototype, methods, KEY;

    // fix native
    if (anyNativeIterator) {
      CurrentIteratorPrototype = getPrototypeOf(anyNativeIterator.call(new Iterable()));
      if (CurrentIteratorPrototype !== Object.prototype && CurrentIteratorPrototype.next) {
        if (getPrototypeOf(CurrentIteratorPrototype) !== IteratorPrototype) {
          if (setPrototypeOf$2) {
            setPrototypeOf$2(CurrentIteratorPrototype, IteratorPrototype);
          } else if (!isCallable$2(CurrentIteratorPrototype[ITERATOR$1])) {
            redefine$1(CurrentIteratorPrototype, ITERATOR$1, returnThis);
          }
        }
        // Set @@toStringTag to native iterators
        setToStringTag$1(CurrentIteratorPrototype, TO_STRING_TAG, true);
      }
    }

    // fix Array.prototype.{ values, @@iterator }.name in V8 / FF
    if (PROPER_FUNCTION_NAME && DEFAULT == VALUES && nativeIterator && nativeIterator.name !== VALUES) {
      if (CONFIGURABLE_FUNCTION_NAME) {
        createNonEnumerableProperty$3(IterablePrototype, 'name', VALUES);
      } else {
        INCORRECT_VALUES_NAME = true;
        defaultIterator = function values() { return call(nativeIterator, this); };
      }
    }

    // export additional methods
    if (DEFAULT) {
      methods = {
        values: getIterationMethod(VALUES),
        keys: IS_SET ? defaultIterator : getIterationMethod(KEYS),
        entries: getIterationMethod(ENTRIES)
      };
      if (FORCED) for (KEY in methods) {
        if (BUGGY_SAFARI_ITERATORS || INCORRECT_VALUES_NAME || !(KEY in IterablePrototype)) {
          redefine$1(IterablePrototype, KEY, methods[KEY]);
        }
      } else $$6({ target: NAME, proto: true, forced: BUGGY_SAFARI_ITERATORS || INCORRECT_VALUES_NAME }, methods);
    }

    // define iterator
    if (IterablePrototype[ITERATOR$1] !== defaultIterator) {
      redefine$1(IterablePrototype, ITERATOR$1, defaultIterator, { name: DEFAULT });
    }
    Iterators$1[NAME] = defaultIterator;

    return methods;
  };

  var toIndexedObject$2 = toIndexedObject$8;
  var addToUnscopables = addToUnscopables$1;
  var Iterators = iterators;
  var InternalStateModule$2 = internalState;
  var defineProperty$1 = objectDefineProperty.f;
  var defineIterator$1 = defineIterator$2;
  var DESCRIPTORS = descriptors;

  var ARRAY_ITERATOR = 'Array Iterator';
  var setInternalState$2 = InternalStateModule$2.set;
  var getInternalState$1 = InternalStateModule$2.getterFor(ARRAY_ITERATOR);

  // `Array.prototype.entries` method
  // https://tc39.es/ecma262/#sec-array.prototype.entries
  // `Array.prototype.keys` method
  // https://tc39.es/ecma262/#sec-array.prototype.keys
  // `Array.prototype.values` method
  // https://tc39.es/ecma262/#sec-array.prototype.values
  // `Array.prototype[@@iterator]` method
  // https://tc39.es/ecma262/#sec-array.prototype-@@iterator
  // `CreateArrayIterator` internal method
  // https://tc39.es/ecma262/#sec-createarrayiterator
  var es_array_iterator = defineIterator$1(Array, 'Array', function (iterated, kind) {
    setInternalState$2(this, {
      type: ARRAY_ITERATOR,
      target: toIndexedObject$2(iterated), // target
      index: 0,                          // next index
      kind: kind                         // kind
    });
  // `%ArrayIteratorPrototype%.next` method
  // https://tc39.es/ecma262/#sec-%arrayiteratorprototype%.next
  }, function () {
    var state = getInternalState$1(this);
    var target = state.target;
    var kind = state.kind;
    var index = state.index++;
    if (!target || index >= target.length) {
      state.target = undefined;
      return { value: undefined, done: true };
    }
    if (kind == 'keys') return { value: index, done: false };
    if (kind == 'values') return { value: target[index], done: false };
    return { value: [index, target[index]], done: false };
  }, 'values');

  // argumentsList[@@iterator] is %ArrayProto_values%
  // https://tc39.es/ecma262/#sec-createunmappedargumentsobject
  // https://tc39.es/ecma262/#sec-createmappedargumentsobject
  var values = Iterators.Arguments = Iterators.Array;

  // https://tc39.es/ecma262/#sec-array.prototype-@@unscopables
  addToUnscopables('keys');
  addToUnscopables('values');
  addToUnscopables('entries');

  // V8 ~ Chrome 45- bug
  if (DESCRIPTORS && values.name !== 'values') try {
    defineProperty$1(values, 'name', { value: 'values' });
  } catch (error) { /* empty */ }

  var charAt = stringMultibyte.charAt;
  var toString$2 = toString$7;
  var InternalStateModule$1 = internalState;
  var defineIterator = defineIterator$2;

  var STRING_ITERATOR = 'String Iterator';
  var setInternalState$1 = InternalStateModule$1.set;
  var getInternalState = InternalStateModule$1.getterFor(STRING_ITERATOR);

  // `String.prototype[@@iterator]` method
  // https://tc39.es/ecma262/#sec-string.prototype-@@iterator
  defineIterator(String, 'String', function (iterated) {
    setInternalState$1(this, {
      type: STRING_ITERATOR,
      string: toString$2(iterated),
      index: 0
    });
  // `%StringIteratorPrototype%.next` method
  // https://tc39.es/ecma262/#sec-%stringiteratorprototype%.next
  }, function next() {
    var state = getInternalState(this);
    var string = state.string;
    var index = state.index;
    var point;
    if (index >= string.length) return { value: undefined, done: true };
    point = charAt(string, index);
    state.index += point.length;
    return { value: point, done: false };
  });

  var internalMetadata = {exports: {}};

  var objectGetOwnPropertyNamesExternal = {};

  /* eslint-disable es/no-object-getownpropertynames -- safe */

  var classof$1 = classofRaw$1;
  var toIndexedObject$1 = toIndexedObject$8;
  var $getOwnPropertyNames = objectGetOwnPropertyNames.f;
  var arraySlice$1 = arraySliceSimple;

  var windowNames = typeof window == 'object' && window && Object.getOwnPropertyNames
    ? Object.getOwnPropertyNames(window) : [];

  var getWindowNames = function (it) {
    try {
      return $getOwnPropertyNames(it);
    } catch (error) {
      return arraySlice$1(windowNames);
    }
  };

  // fallback for IE11 buggy Object.getOwnPropertyNames with iframe and window
  objectGetOwnPropertyNamesExternal.f = function getOwnPropertyNames(it) {
    return windowNames && classof$1(it) == 'Window'
      ? getWindowNames(it)
      : $getOwnPropertyNames(toIndexedObject$1(it));
  };

  // FF26- bug: ArrayBuffers are non-extensible, but Object.isExtensible does not report it
  var fails$6 = fails$q;

  var arrayBufferNonExtensible = fails$6(function () {
    if (typeof ArrayBuffer == 'function') {
      var buffer = new ArrayBuffer(8);
      // eslint-disable-next-line es/no-object-isextensible, es/no-object-defineproperty -- safe
      if (Object.isExtensible(buffer)) Object.defineProperty(buffer, 'a', { value: 8 });
    }
  });

  var fails$5 = fails$q;
  var isObject$6 = isObject$i;
  var classof = classofRaw$1;
  var ARRAY_BUFFER_NON_EXTENSIBLE = arrayBufferNonExtensible;

  // eslint-disable-next-line es/no-object-isextensible -- safe
  var $isExtensible = Object.isExtensible;
  var FAILS_ON_PRIMITIVES = fails$5(function () { $isExtensible(1); });

  // `Object.isExtensible` method
  // https://tc39.es/ecma262/#sec-object.isextensible
  var objectIsExtensible = (FAILS_ON_PRIMITIVES || ARRAY_BUFFER_NON_EXTENSIBLE) ? function isExtensible(it) {
    if (!isObject$6(it)) return false;
    if (ARRAY_BUFFER_NON_EXTENSIBLE && classof(it) == 'ArrayBuffer') return false;
    return $isExtensible ? $isExtensible(it) : true;
  } : $isExtensible;

  var fails$4 = fails$q;

  var freezing = !fails$4(function () {
    // eslint-disable-next-line es/no-object-isextensible, es/no-object-preventextensions -- required for testing
    return Object.isExtensible(Object.preventExtensions({}));
  });

  var $$5 = _export;
  var uncurryThis$7 = functionUncurryThis;
  var hiddenKeys = hiddenKeys$5;
  var isObject$5 = isObject$i;
  var hasOwn$2 = hasOwnProperty_1;
  var defineProperty = objectDefineProperty.f;
  var getOwnPropertyNamesModule = objectGetOwnPropertyNames;
  var getOwnPropertyNamesExternalModule = objectGetOwnPropertyNamesExternal;
  var isExtensible$1 = objectIsExtensible;
  var uid = uid$3;
  var FREEZING = freezing;

  var REQUIRED = false;
  var METADATA = uid('meta');
  var id$1 = 0;

  var setMetadata = function (it) {
    defineProperty(it, METADATA, { value: {
      objectID: 'O' + id$1++, // object ID
      weakData: {}          // weak collections IDs
    } });
  };

  var fastKey = function (it, create) {
    // return a primitive with prefix
    if (!isObject$5(it)) return typeof it == 'symbol' ? it : (typeof it == 'string' ? 'S' : 'P') + it;
    if (!hasOwn$2(it, METADATA)) {
      // can't set metadata to uncaught frozen object
      if (!isExtensible$1(it)) return 'F';
      // not necessary to add metadata
      if (!create) return 'E';
      // add missing metadata
      setMetadata(it);
    // return object ID
    } return it[METADATA].objectID;
  };

  var getWeakData$1 = function (it, create) {
    if (!hasOwn$2(it, METADATA)) {
      // can't set metadata to uncaught frozen object
      if (!isExtensible$1(it)) return true;
      // not necessary to add metadata
      if (!create) return false;
      // add missing metadata
      setMetadata(it);
    // return the store of weak collections IDs
    } return it[METADATA].weakData;
  };

  // add metadata on freeze-family methods calling
  var onFreeze = function (it) {
    if (FREEZING && REQUIRED && isExtensible$1(it) && !hasOwn$2(it, METADATA)) setMetadata(it);
    return it;
  };

  var enable = function () {
    meta.enable = function () { /* empty */ };
    REQUIRED = true;
    var getOwnPropertyNames = getOwnPropertyNamesModule.f;
    var splice = uncurryThis$7([].splice);
    var test = {};
    test[METADATA] = 1;

    // prevent exposing of metadata key
    if (getOwnPropertyNames(test).length) {
      getOwnPropertyNamesModule.f = function (it) {
        var result = getOwnPropertyNames(it);
        for (var i = 0, length = result.length; i < length; i++) {
          if (result[i] === METADATA) {
            splice(result, i, 1);
            break;
          }
        } return result;
      };

      $$5({ target: 'Object', stat: true, forced: true }, {
        getOwnPropertyNames: getOwnPropertyNamesExternalModule.f
      });
    }
  };

  var meta = internalMetadata.exports = {
    enable: enable,
    fastKey: fastKey,
    getWeakData: getWeakData$1,
    onFreeze: onFreeze
  };

  hiddenKeys[METADATA] = true;

  var isCallable$1 = isCallable$l;
  var isObject$4 = isObject$i;
  var setPrototypeOf$1 = objectSetPrototypeOf;

  // makes subclassing work correct for wrapped built-ins
  var inheritIfRequired$2 = function ($this, dummy, Wrapper) {
    var NewTarget, NewTargetPrototype;
    if (
      // it can work only with native `setPrototypeOf`
      setPrototypeOf$1 &&
      // we haven't completely correct pre-ES6 way for getting `new.target`, so use this
      isCallable$1(NewTarget = dummy.constructor) &&
      NewTarget !== Wrapper &&
      isObject$4(NewTargetPrototype = NewTarget.prototype) &&
      NewTargetPrototype !== Wrapper.prototype
    ) setPrototypeOf$1($this, NewTargetPrototype);
    return $this;
  };

  var $$4 = _export;
  var global$4 = global$N;
  var uncurryThis$6 = functionUncurryThis;
  var isForced = isForced_1;
  var redefine = redefine$9.exports;
  var InternalMetadataModule$1 = internalMetadata.exports;
  var iterate$1 = iterate$3;
  var anInstance$1 = anInstance$3;
  var isCallable = isCallable$l;
  var isObject$3 = isObject$i;
  var fails$3 = fails$q;
  var checkCorrectnessOfIteration = checkCorrectnessOfIteration$2;
  var setToStringTag = setToStringTag$4;
  var inheritIfRequired$1 = inheritIfRequired$2;

  var collection$2 = function (CONSTRUCTOR_NAME, wrapper, common) {
    var IS_MAP = CONSTRUCTOR_NAME.indexOf('Map') !== -1;
    var IS_WEAK = CONSTRUCTOR_NAME.indexOf('Weak') !== -1;
    var ADDER = IS_MAP ? 'set' : 'add';
    var NativeConstructor = global$4[CONSTRUCTOR_NAME];
    var NativePrototype = NativeConstructor && NativeConstructor.prototype;
    var Constructor = NativeConstructor;
    var exported = {};

    var fixMethod = function (KEY) {
      var uncurriedNativeMethod = uncurryThis$6(NativePrototype[KEY]);
      redefine(NativePrototype, KEY,
        KEY == 'add' ? function add(value) {
          uncurriedNativeMethod(this, value === 0 ? 0 : value);
          return this;
        } : KEY == 'delete' ? function (key) {
          return IS_WEAK && !isObject$3(key) ? false : uncurriedNativeMethod(this, key === 0 ? 0 : key);
        } : KEY == 'get' ? function get(key) {
          return IS_WEAK && !isObject$3(key) ? undefined : uncurriedNativeMethod(this, key === 0 ? 0 : key);
        } : KEY == 'has' ? function has(key) {
          return IS_WEAK && !isObject$3(key) ? false : uncurriedNativeMethod(this, key === 0 ? 0 : key);
        } : function set(key, value) {
          uncurriedNativeMethod(this, key === 0 ? 0 : key, value);
          return this;
        }
      );
    };

    var REPLACE = isForced(
      CONSTRUCTOR_NAME,
      !isCallable(NativeConstructor) || !(IS_WEAK || NativePrototype.forEach && !fails$3(function () {
        new NativeConstructor().entries().next();
      }))
    );

    if (REPLACE) {
      // create collection constructor
      Constructor = common.getConstructor(wrapper, CONSTRUCTOR_NAME, IS_MAP, ADDER);
      InternalMetadataModule$1.enable();
    } else if (isForced(CONSTRUCTOR_NAME, true)) {
      var instance = new Constructor();
      // early implementations not supports chaining
      var HASNT_CHAINING = instance[ADDER](IS_WEAK ? {} : -0, 1) != instance;
      // V8 ~ Chromium 40- weak-collections throws on primitives, but should return false
      var THROWS_ON_PRIMITIVES = fails$3(function () { instance.has(1); });
      // most early implementations doesn't supports iterables, most modern - not close it correctly
      // eslint-disable-next-line no-new -- required for testing
      var ACCEPT_ITERABLES = checkCorrectnessOfIteration(function (iterable) { new NativeConstructor(iterable); });
      // for early implementations -0 and +0 not the same
      var BUGGY_ZERO = !IS_WEAK && fails$3(function () {
        // V8 ~ Chromium 42- fails only with 5+ elements
        var $instance = new NativeConstructor();
        var index = 5;
        while (index--) $instance[ADDER](index, index);
        return !$instance.has(-0);
      });

      if (!ACCEPT_ITERABLES) {
        Constructor = wrapper(function (dummy, iterable) {
          anInstance$1(dummy, NativePrototype);
          var that = inheritIfRequired$1(new NativeConstructor(), dummy, Constructor);
          if (iterable != undefined) iterate$1(iterable, that[ADDER], { that: that, AS_ENTRIES: IS_MAP });
          return that;
        });
        Constructor.prototype = NativePrototype;
        NativePrototype.constructor = Constructor;
      }

      if (THROWS_ON_PRIMITIVES || BUGGY_ZERO) {
        fixMethod('delete');
        fixMethod('has');
        IS_MAP && fixMethod('get');
      }

      if (BUGGY_ZERO || HASNT_CHAINING) fixMethod(ADDER);

      // weak collections should not contains .clear method
      if (IS_WEAK && NativePrototype.clear) delete NativePrototype.clear;
    }

    exported[CONSTRUCTOR_NAME] = Constructor;
    $$4({ global: true, forced: Constructor != NativeConstructor }, exported);

    setToStringTag(Constructor, CONSTRUCTOR_NAME);

    if (!IS_WEAK) common.setStrong(Constructor, CONSTRUCTOR_NAME, IS_MAP);

    return Constructor;
  };

  var bind = functionBindContext;
  var uncurryThis$5 = functionUncurryThis;
  var IndexedObject$1 = indexedObject;
  var toObject$1 = toObject$5;
  var lengthOfArrayLike$1 = lengthOfArrayLike$7;
  var arraySpeciesCreate = arraySpeciesCreate$2;

  var push$1 = uncurryThis$5([].push);

  // `Array.prototype.{ forEach, map, filter, some, every, find, findIndex, filterReject }` methods implementation
  var createMethod = function (TYPE) {
    var IS_MAP = TYPE == 1;
    var IS_FILTER = TYPE == 2;
    var IS_SOME = TYPE == 3;
    var IS_EVERY = TYPE == 4;
    var IS_FIND_INDEX = TYPE == 6;
    var IS_FILTER_REJECT = TYPE == 7;
    var NO_HOLES = TYPE == 5 || IS_FIND_INDEX;
    return function ($this, callbackfn, that, specificCreate) {
      var O = toObject$1($this);
      var self = IndexedObject$1(O);
      var boundFunction = bind(callbackfn, that);
      var length = lengthOfArrayLike$1(self);
      var index = 0;
      var create = specificCreate || arraySpeciesCreate;
      var target = IS_MAP ? create($this, length) : IS_FILTER || IS_FILTER_REJECT ? create($this, 0) : undefined;
      var value, result;
      for (;length > index; index++) if (NO_HOLES || index in self) {
        value = self[index];
        result = boundFunction(value, index, O);
        if (TYPE) {
          if (IS_MAP) target[index] = result; // map
          else if (result) switch (TYPE) {
            case 3: return true;              // some
            case 5: return value;             // find
            case 6: return index;             // findIndex
            case 2: push$1(target, value);      // filter
          } else switch (TYPE) {
            case 4: return false;             // every
            case 7: push$1(target, value);      // filterReject
          }
        }
      }
      return IS_FIND_INDEX ? -1 : IS_SOME || IS_EVERY ? IS_EVERY : target;
    };
  };

  var arrayIteration = {
    // `Array.prototype.forEach` method
    // https://tc39.es/ecma262/#sec-array.prototype.foreach
    forEach: createMethod(0),
    // `Array.prototype.map` method
    // https://tc39.es/ecma262/#sec-array.prototype.map
    map: createMethod(1),
    // `Array.prototype.filter` method
    // https://tc39.es/ecma262/#sec-array.prototype.filter
    filter: createMethod(2),
    // `Array.prototype.some` method
    // https://tc39.es/ecma262/#sec-array.prototype.some
    some: createMethod(3),
    // `Array.prototype.every` method
    // https://tc39.es/ecma262/#sec-array.prototype.every
    every: createMethod(4),
    // `Array.prototype.find` method
    // https://tc39.es/ecma262/#sec-array.prototype.find
    find: createMethod(5),
    // `Array.prototype.findIndex` method
    // https://tc39.es/ecma262/#sec-array.prototype.findIndex
    findIndex: createMethod(6),
    // `Array.prototype.filterReject` method
    // https://github.com/tc39/proposal-array-filtering
    filterReject: createMethod(7)
  };

  var uncurryThis$4 = functionUncurryThis;
  var redefineAll$1 = redefineAll$3;
  var getWeakData = internalMetadata.exports.getWeakData;
  var anObject = anObject$e;
  var isObject$2 = isObject$i;
  var anInstance = anInstance$3;
  var iterate = iterate$3;
  var ArrayIterationModule = arrayIteration;
  var hasOwn$1 = hasOwnProperty_1;
  var InternalStateModule = internalState;

  var setInternalState = InternalStateModule.set;
  var internalStateGetterFor = InternalStateModule.getterFor;
  var find = ArrayIterationModule.find;
  var findIndex = ArrayIterationModule.findIndex;
  var splice = uncurryThis$4([].splice);
  var id = 0;

  // fallback for uncaught frozen keys
  var uncaughtFrozenStore = function (store) {
    return store.frozen || (store.frozen = new UncaughtFrozenStore());
  };

  var UncaughtFrozenStore = function () {
    this.entries = [];
  };

  var findUncaughtFrozen = function (store, key) {
    return find(store.entries, function (it) {
      return it[0] === key;
    });
  };

  UncaughtFrozenStore.prototype = {
    get: function (key) {
      var entry = findUncaughtFrozen(this, key);
      if (entry) return entry[1];
    },
    has: function (key) {
      return !!findUncaughtFrozen(this, key);
    },
    set: function (key, value) {
      var entry = findUncaughtFrozen(this, key);
      if (entry) entry[1] = value;
      else this.entries.push([key, value]);
    },
    'delete': function (key) {
      var index = findIndex(this.entries, function (it) {
        return it[0] === key;
      });
      if (~index) splice(this.entries, index, 1);
      return !!~index;
    }
  };

  var collectionWeak$2 = {
    getConstructor: function (wrapper, CONSTRUCTOR_NAME, IS_MAP, ADDER) {
      var Constructor = wrapper(function (that, iterable) {
        anInstance(that, Prototype);
        setInternalState(that, {
          type: CONSTRUCTOR_NAME,
          id: id++,
          frozen: undefined
        });
        if (iterable != undefined) iterate(iterable, that[ADDER], { that: that, AS_ENTRIES: IS_MAP });
      });

      var Prototype = Constructor.prototype;

      var getInternalState = internalStateGetterFor(CONSTRUCTOR_NAME);

      var define = function (that, key, value) {
        var state = getInternalState(that);
        var data = getWeakData(anObject(key), true);
        if (data === true) uncaughtFrozenStore(state).set(key, value);
        else data[state.id] = value;
        return that;
      };

      redefineAll$1(Prototype, {
        // `{ WeakMap, WeakSet }.prototype.delete(key)` methods
        // https://tc39.es/ecma262/#sec-weakmap.prototype.delete
        // https://tc39.es/ecma262/#sec-weakset.prototype.delete
        'delete': function (key) {
          var state = getInternalState(this);
          if (!isObject$2(key)) return false;
          var data = getWeakData(key);
          if (data === true) return uncaughtFrozenStore(state)['delete'](key);
          return data && hasOwn$1(data, state.id) && delete data[state.id];
        },
        // `{ WeakMap, WeakSet }.prototype.has(key)` methods
        // https://tc39.es/ecma262/#sec-weakmap.prototype.has
        // https://tc39.es/ecma262/#sec-weakset.prototype.has
        has: function has(key) {
          var state = getInternalState(this);
          if (!isObject$2(key)) return false;
          var data = getWeakData(key);
          if (data === true) return uncaughtFrozenStore(state).has(key);
          return data && hasOwn$1(data, state.id);
        }
      });

      redefineAll$1(Prototype, IS_MAP ? {
        // `WeakMap.prototype.get(key)` method
        // https://tc39.es/ecma262/#sec-weakmap.prototype.get
        get: function get(key) {
          var state = getInternalState(this);
          if (isObject$2(key)) {
            var data = getWeakData(key);
            if (data === true) return uncaughtFrozenStore(state).get(key);
            return data ? data[state.id] : undefined;
          }
        },
        // `WeakMap.prototype.set(key, value)` method
        // https://tc39.es/ecma262/#sec-weakmap.prototype.set
        set: function set(key, value) {
          return define(this, key, value);
        }
      } : {
        // `WeakSet.prototype.add(value)` method
        // https://tc39.es/ecma262/#sec-weakset.prototype.add
        add: function add(value) {
          return define(this, value, true);
        }
      });

      return Constructor;
    }
  };

  var global$3 = global$N;
  var uncurryThis$3 = functionUncurryThis;
  var redefineAll = redefineAll$3;
  var InternalMetadataModule = internalMetadata.exports;
  var collection$1 = collection$2;
  var collectionWeak$1 = collectionWeak$2;
  var isObject$1 = isObject$i;
  var isExtensible = objectIsExtensible;
  var enforceInternalState = internalState.enforce;
  var NATIVE_WEAK_MAP = nativeWeakMap;

  var IS_IE11 = !global$3.ActiveXObject && 'ActiveXObject' in global$3;
  var InternalWeakMap;

  var wrapper = function (init) {
    return function WeakMap() {
      return init(this, arguments.length ? arguments[0] : undefined);
    };
  };

  // `WeakMap` constructor
  // https://tc39.es/ecma262/#sec-weakmap-constructor
  var $WeakMap = collection$1('WeakMap', wrapper, collectionWeak$1);

  // IE11 WeakMap frozen keys fix
  // We can't use feature detection because it crash some old IE builds
  // https://github.com/zloirock/core-js/issues/485
  if (NATIVE_WEAK_MAP && IS_IE11) {
    InternalWeakMap = collectionWeak$1.getConstructor(wrapper, 'WeakMap', true);
    InternalMetadataModule.enable();
    var WeakMapPrototype = $WeakMap.prototype;
    var nativeDelete = uncurryThis$3(WeakMapPrototype['delete']);
    var nativeHas = uncurryThis$3(WeakMapPrototype.has);
    var nativeGet = uncurryThis$3(WeakMapPrototype.get);
    var nativeSet = uncurryThis$3(WeakMapPrototype.set);
    redefineAll(WeakMapPrototype, {
      'delete': function (key) {
        if (isObject$1(key) && !isExtensible(key)) {
          var state = enforceInternalState(this);
          if (!state.frozen) state.frozen = new InternalWeakMap();
          return nativeDelete(this, key) || state.frozen['delete'](key);
        } return nativeDelete(this, key);
      },
      has: function has(key) {
        if (isObject$1(key) && !isExtensible(key)) {
          var state = enforceInternalState(this);
          if (!state.frozen) state.frozen = new InternalWeakMap();
          return nativeHas(this, key) || state.frozen.has(key);
        } return nativeHas(this, key);
      },
      get: function get(key) {
        if (isObject$1(key) && !isExtensible(key)) {
          var state = enforceInternalState(this);
          if (!state.frozen) state.frozen = new InternalWeakMap();
          return nativeHas(this, key) ? nativeGet(this, key) : state.frozen.get(key);
        } return nativeGet(this, key);
      },
      set: function set(key, value) {
        if (isObject$1(key) && !isExtensible(key)) {
          var state = enforceInternalState(this);
          if (!state.frozen) state.frozen = new InternalWeakMap();
          nativeHas(this, key) ? nativeSet(this, key, value) : state.frozen.set(key, value);
        } else nativeSet(this, key, value);
        return this;
      }
    });
  }

  // iterable DOM collections
  // flag - `iterable` interface - 'entries', 'keys', 'values', 'forEach' methods
  var domIterables = {
    CSSRuleList: 0,
    CSSStyleDeclaration: 0,
    CSSValueList: 0,
    ClientRectList: 0,
    DOMRectList: 0,
    DOMStringList: 0,
    DOMTokenList: 1,
    DataTransferItemList: 0,
    FileList: 0,
    HTMLAllCollection: 0,
    HTMLCollection: 0,
    HTMLFormElement: 0,
    HTMLSelectElement: 0,
    MediaList: 0,
    MimeTypeArray: 0,
    NamedNodeMap: 0,
    NodeList: 1,
    PaintRequestList: 0,
    Plugin: 0,
    PluginArray: 0,
    SVGLengthList: 0,
    SVGNumberList: 0,
    SVGPathSegList: 0,
    SVGPointList: 0,
    SVGStringList: 0,
    SVGTransformList: 0,
    SourceBufferList: 0,
    StyleSheetList: 0,
    TextTrackCueList: 0,
    TextTrackList: 0,
    TouchList: 0
  };

  // in old WebKit versions, `element.classList` is not an instance of global `DOMTokenList`
  var documentCreateElement = documentCreateElement$2;

  var classList = documentCreateElement('span').classList;
  var DOMTokenListPrototype$1 = classList && classList.constructor && classList.constructor.prototype;

  var domTokenListPrototype = DOMTokenListPrototype$1 === Object.prototype ? undefined : DOMTokenListPrototype$1;

  var global$2 = global$N;
  var DOMIterables = domIterables;
  var DOMTokenListPrototype = domTokenListPrototype;
  var ArrayIteratorMethods = es_array_iterator;
  var createNonEnumerableProperty$2 = createNonEnumerableProperty$8;
  var wellKnownSymbol = wellKnownSymbol$k;

  var ITERATOR = wellKnownSymbol('iterator');
  var TO_STRING_TAG = wellKnownSymbol('toStringTag');
  var ArrayValues = ArrayIteratorMethods.values;

  var handlePrototype = function (CollectionPrototype, COLLECTION_NAME) {
    if (CollectionPrototype) {
      // some Chrome versions have non-configurable methods on DOMTokenList
      if (CollectionPrototype[ITERATOR] !== ArrayValues) try {
        createNonEnumerableProperty$2(CollectionPrototype, ITERATOR, ArrayValues);
      } catch (error) {
        CollectionPrototype[ITERATOR] = ArrayValues;
      }
      if (!CollectionPrototype[TO_STRING_TAG]) {
        createNonEnumerableProperty$2(CollectionPrototype, TO_STRING_TAG, COLLECTION_NAME);
      }
      if (DOMIterables[COLLECTION_NAME]) for (var METHOD_NAME in ArrayIteratorMethods) {
        // some Chrome versions have non-configurable methods on DOMTokenList
        if (CollectionPrototype[METHOD_NAME] !== ArrayIteratorMethods[METHOD_NAME]) try {
          createNonEnumerableProperty$2(CollectionPrototype, METHOD_NAME, ArrayIteratorMethods[METHOD_NAME]);
        } catch (error) {
          CollectionPrototype[METHOD_NAME] = ArrayIteratorMethods[METHOD_NAME];
        }
      }
    }
  };

  for (var COLLECTION_NAME in DOMIterables) {
    handlePrototype(global$2[COLLECTION_NAME] && global$2[COLLECTION_NAME].prototype, COLLECTION_NAME);
  }

  handlePrototype(DOMTokenListPrototype, 'DOMTokenList');

  var modal$1 = {exports: {}};

  var eventHandler$1 = {exports: {}};

  /*!
    * Bootstrap event-handler.js v5.1.3 (https://getbootstrap.com/)
    * Copyright 2011-2021 The Bootstrap Authors (https://github.com/twbs/bootstrap/graphs/contributors)
    * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
    */

  (function (module, exports) {
  (function (global, factory) {
    module.exports = factory() ;
  })(commonjsGlobal, function () {
    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): util/index.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */

    const getjQuery = () => {
      const {
        jQuery
      } = window;

      if (jQuery && !document.body.hasAttribute('data-bs-no-jquery')) {
        return jQuery;
      }

      return null;
    };
    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): dom/event-handler.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */

    /**
     * ------------------------------------------------------------------------
     * Constants
     * ------------------------------------------------------------------------
     */


    const namespaceRegex = /[^.]*(?=\..*)\.|.*/;
    const stripNameRegex = /\..*/;
    const stripUidRegex = /::\d+$/;
    const eventRegistry = {}; // Events storage

    let uidEvent = 1;
    const customEvents = {
      mouseenter: 'mouseover',
      mouseleave: 'mouseout'
    };
    const customEventsRegex = /^(mouseenter|mouseleave)/i;
    const nativeEvents = new Set(['click', 'dblclick', 'mouseup', 'mousedown', 'contextmenu', 'mousewheel', 'DOMMouseScroll', 'mouseover', 'mouseout', 'mousemove', 'selectstart', 'selectend', 'keydown', 'keypress', 'keyup', 'orientationchange', 'touchstart', 'touchmove', 'touchend', 'touchcancel', 'pointerdown', 'pointermove', 'pointerup', 'pointerleave', 'pointercancel', 'gesturestart', 'gesturechange', 'gestureend', 'focus', 'blur', 'change', 'reset', 'select', 'submit', 'focusin', 'focusout', 'load', 'unload', 'beforeunload', 'resize', 'move', 'DOMContentLoaded', 'readystatechange', 'error', 'abort', 'scroll']);
    /**
     * ------------------------------------------------------------------------
     * Private methods
     * ------------------------------------------------------------------------
     */

    function getUidEvent(element, uid) {
      return uid && `${uid}::${uidEvent++}` || element.uidEvent || uidEvent++;
    }

    function getEvent(element) {
      const uid = getUidEvent(element);
      element.uidEvent = uid;
      eventRegistry[uid] = eventRegistry[uid] || {};
      return eventRegistry[uid];
    }

    function bootstrapHandler(element, fn) {
      return function handler(event) {
        event.delegateTarget = element;

        if (handler.oneOff) {
          EventHandler.off(element, event.type, fn);
        }

        return fn.apply(element, [event]);
      };
    }

    function bootstrapDelegationHandler(element, selector, fn) {
      return function handler(event) {
        const domElements = element.querySelectorAll(selector);

        for (let {
          target
        } = event; target && target !== this; target = target.parentNode) {
          for (let i = domElements.length; i--;) {
            if (domElements[i] === target) {
              event.delegateTarget = target;

              if (handler.oneOff) {
                EventHandler.off(element, event.type, selector, fn);
              }

              return fn.apply(target, [event]);
            }
          }
        } // To please ESLint


        return null;
      };
    }

    function findHandler(events, handler, delegationSelector = null) {
      const uidEventList = Object.keys(events);

      for (let i = 0, len = uidEventList.length; i < len; i++) {
        const event = events[uidEventList[i]];

        if (event.originalHandler === handler && event.delegationSelector === delegationSelector) {
          return event;
        }
      }

      return null;
    }

    function normalizeParams(originalTypeEvent, handler, delegationFn) {
      const delegation = typeof handler === 'string';
      const originalHandler = delegation ? delegationFn : handler;
      let typeEvent = getTypeEvent(originalTypeEvent);
      const isNative = nativeEvents.has(typeEvent);

      if (!isNative) {
        typeEvent = originalTypeEvent;
      }

      return [delegation, originalHandler, typeEvent];
    }

    function addHandler(element, originalTypeEvent, handler, delegationFn, oneOff) {
      if (typeof originalTypeEvent !== 'string' || !element) {
        return;
      }

      if (!handler) {
        handler = delegationFn;
        delegationFn = null;
      } // in case of mouseenter or mouseleave wrap the handler within a function that checks for its DOM position
      // this prevents the handler from being dispatched the same way as mouseover or mouseout does


      if (customEventsRegex.test(originalTypeEvent)) {
        const wrapFn = fn => {
          return function (event) {
            if (!event.relatedTarget || event.relatedTarget !== event.delegateTarget && !event.delegateTarget.contains(event.relatedTarget)) {
              return fn.call(this, event);
            }
          };
        };

        if (delegationFn) {
          delegationFn = wrapFn(delegationFn);
        } else {
          handler = wrapFn(handler);
        }
      }

      const [delegation, originalHandler, typeEvent] = normalizeParams(originalTypeEvent, handler, delegationFn);
      const events = getEvent(element);
      const handlers = events[typeEvent] || (events[typeEvent] = {});
      const previousFn = findHandler(handlers, originalHandler, delegation ? handler : null);

      if (previousFn) {
        previousFn.oneOff = previousFn.oneOff && oneOff;
        return;
      }

      const uid = getUidEvent(originalHandler, originalTypeEvent.replace(namespaceRegex, ''));
      const fn = delegation ? bootstrapDelegationHandler(element, handler, delegationFn) : bootstrapHandler(element, handler);
      fn.delegationSelector = delegation ? handler : null;
      fn.originalHandler = originalHandler;
      fn.oneOff = oneOff;
      fn.uidEvent = uid;
      handlers[uid] = fn;
      element.addEventListener(typeEvent, fn, delegation);
    }

    function removeHandler(element, events, typeEvent, handler, delegationSelector) {
      const fn = findHandler(events[typeEvent], handler, delegationSelector);

      if (!fn) {
        return;
      }

      element.removeEventListener(typeEvent, fn, Boolean(delegationSelector));
      delete events[typeEvent][fn.uidEvent];
    }

    function removeNamespacedHandlers(element, events, typeEvent, namespace) {
      const storeElementEvent = events[typeEvent] || {};
      Object.keys(storeElementEvent).forEach(handlerKey => {
        if (handlerKey.includes(namespace)) {
          const event = storeElementEvent[handlerKey];
          removeHandler(element, events, typeEvent, event.originalHandler, event.delegationSelector);
        }
      });
    }

    function getTypeEvent(event) {
      // allow to get the native events from namespaced events ('click.bs.button' --> 'click')
      event = event.replace(stripNameRegex, '');
      return customEvents[event] || event;
    }

    const EventHandler = {
      on(element, event, handler, delegationFn) {
        addHandler(element, event, handler, delegationFn, false);
      },

      one(element, event, handler, delegationFn) {
        addHandler(element, event, handler, delegationFn, true);
      },

      off(element, originalTypeEvent, handler, delegationFn) {
        if (typeof originalTypeEvent !== 'string' || !element) {
          return;
        }

        const [delegation, originalHandler, typeEvent] = normalizeParams(originalTypeEvent, handler, delegationFn);
        const inNamespace = typeEvent !== originalTypeEvent;
        const events = getEvent(element);
        const isNamespace = originalTypeEvent.startsWith('.');

        if (typeof originalHandler !== 'undefined') {
          // Simplest case: handler is passed, remove that listener ONLY.
          if (!events || !events[typeEvent]) {
            return;
          }

          removeHandler(element, events, typeEvent, originalHandler, delegation ? handler : null);
          return;
        }

        if (isNamespace) {
          Object.keys(events).forEach(elementEvent => {
            removeNamespacedHandlers(element, events, elementEvent, originalTypeEvent.slice(1));
          });
        }

        const storeElementEvent = events[typeEvent] || {};
        Object.keys(storeElementEvent).forEach(keyHandlers => {
          const handlerKey = keyHandlers.replace(stripUidRegex, '');

          if (!inNamespace || originalTypeEvent.includes(handlerKey)) {
            const event = storeElementEvent[keyHandlers];
            removeHandler(element, events, typeEvent, event.originalHandler, event.delegationSelector);
          }
        });
      },

      trigger(element, event, args) {
        if (typeof event !== 'string' || !element) {
          return null;
        }

        const $ = getjQuery();
        const typeEvent = getTypeEvent(event);
        const inNamespace = event !== typeEvent;
        const isNative = nativeEvents.has(typeEvent);
        let jQueryEvent;
        let bubbles = true;
        let nativeDispatch = true;
        let defaultPrevented = false;
        let evt = null;

        if (inNamespace && $) {
          jQueryEvent = $.Event(event, args);
          $(element).trigger(jQueryEvent);
          bubbles = !jQueryEvent.isPropagationStopped();
          nativeDispatch = !jQueryEvent.isImmediatePropagationStopped();
          defaultPrevented = jQueryEvent.isDefaultPrevented();
        }

        if (isNative) {
          evt = document.createEvent('HTMLEvents');
          evt.initEvent(typeEvent, bubbles, true);
        } else {
          evt = new CustomEvent(event, {
            bubbles,
            cancelable: true
          });
        } // merge custom information in our event


        if (typeof args !== 'undefined') {
          Object.keys(args).forEach(key => {
            Object.defineProperty(evt, key, {
              get() {
                return args[key];
              }

            });
          });
        }

        if (defaultPrevented) {
          evt.preventDefault();
        }

        if (nativeDispatch) {
          element.dispatchEvent(evt);
        }

        if (evt.defaultPrevented && typeof jQueryEvent !== 'undefined') {
          jQueryEvent.preventDefault();
        }

        return evt;
      }

    };
    return EventHandler;
  }); 
  }(eventHandler$1));

  var manipulator$1 = {exports: {}};

  /*!
    * Bootstrap manipulator.js v5.1.3 (https://getbootstrap.com/)
    * Copyright 2011-2021 The Bootstrap Authors (https://github.com/twbs/bootstrap/graphs/contributors)
    * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
    */

  (function (module, exports) {
  (function (global, factory) {
    module.exports = factory() ;
  })(commonjsGlobal, function () {
    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): dom/manipulator.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */

    function normalizeData(val) {
      if (val === 'true') {
        return true;
      }

      if (val === 'false') {
        return false;
      }

      if (val === Number(val).toString()) {
        return Number(val);
      }

      if (val === '' || val === 'null') {
        return null;
      }

      return val;
    }

    function normalizeDataKey(key) {
      return key.replace(/[A-Z]/g, chr => `-${chr.toLowerCase()}`);
    }

    const Manipulator = {
      setDataAttribute(element, key, value) {
        element.setAttribute(`data-bs-${normalizeDataKey(key)}`, value);
      },

      removeDataAttribute(element, key) {
        element.removeAttribute(`data-bs-${normalizeDataKey(key)}`);
      },

      getDataAttributes(element) {
        if (!element) {
          return {};
        }

        const attributes = {};
        Object.keys(element.dataset).filter(key => key.startsWith('bs')).forEach(key => {
          let pureKey = key.replace(/^bs/, '');
          pureKey = pureKey.charAt(0).toLowerCase() + pureKey.slice(1, pureKey.length);
          attributes[pureKey] = normalizeData(element.dataset[key]);
        });
        return attributes;
      },

      getDataAttribute(element, key) {
        return normalizeData(element.getAttribute(`data-bs-${normalizeDataKey(key)}`));
      },

      offset(element) {
        const rect = element.getBoundingClientRect();
        return {
          top: rect.top + window.pageYOffset,
          left: rect.left + window.pageXOffset
        };
      },

      position(element) {
        return {
          top: element.offsetTop,
          left: element.offsetLeft
        };
      }

    };
    return Manipulator;
  }); 
  }(manipulator$1));

  var selectorEngine$1 = {exports: {}};

  /*!
    * Bootstrap selector-engine.js v5.1.3 (https://getbootstrap.com/)
    * Copyright 2011-2021 The Bootstrap Authors (https://github.com/twbs/bootstrap/graphs/contributors)
    * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
    */

  (function (module, exports) {
  (function (global, factory) {
    module.exports = factory() ;
  })(commonjsGlobal, function () {
    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): util/index.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */

    const isElement = obj => {
      if (!obj || typeof obj !== 'object') {
        return false;
      }

      if (typeof obj.jquery !== 'undefined') {
        obj = obj[0];
      }

      return typeof obj.nodeType !== 'undefined';
    };

    const isVisible = element => {
      if (!isElement(element) || element.getClientRects().length === 0) {
        return false;
      }

      return getComputedStyle(element).getPropertyValue('visibility') === 'visible';
    };

    const isDisabled = element => {
      if (!element || element.nodeType !== Node.ELEMENT_NODE) {
        return true;
      }

      if (element.classList.contains('disabled')) {
        return true;
      }

      if (typeof element.disabled !== 'undefined') {
        return element.disabled;
      }

      return element.hasAttribute('disabled') && element.getAttribute('disabled') !== 'false';
    };
    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): dom/selector-engine.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */


    const NODE_TEXT = 3;
    const SelectorEngine = {
      find(selector, element = document.documentElement) {
        return [].concat(...Element.prototype.querySelectorAll.call(element, selector));
      },

      findOne(selector, element = document.documentElement) {
        return Element.prototype.querySelector.call(element, selector);
      },

      children(element, selector) {
        return [].concat(...element.children).filter(child => child.matches(selector));
      },

      parents(element, selector) {
        const parents = [];
        let ancestor = element.parentNode;

        while (ancestor && ancestor.nodeType === Node.ELEMENT_NODE && ancestor.nodeType !== NODE_TEXT) {
          if (ancestor.matches(selector)) {
            parents.push(ancestor);
          }

          ancestor = ancestor.parentNode;
        }

        return parents;
      },

      prev(element, selector) {
        let previous = element.previousElementSibling;

        while (previous) {
          if (previous.matches(selector)) {
            return [previous];
          }

          previous = previous.previousElementSibling;
        }

        return [];
      },

      next(element, selector) {
        let next = element.nextElementSibling;

        while (next) {
          if (next.matches(selector)) {
            return [next];
          }

          next = next.nextElementSibling;
        }

        return [];
      },

      focusableChildren(element) {
        const focusables = ['a', 'button', 'input', 'textarea', 'select', 'details', '[tabindex]', '[contenteditable="true"]'].map(selector => `${selector}:not([tabindex^="-"])`).join(', ');
        return this.find(focusables, element).filter(el => !isDisabled(el) && isVisible(el));
      }

    };
    return SelectorEngine;
  }); 
  }(selectorEngine$1));

  var baseComponent$1 = {exports: {}};

  var data$1 = {exports: {}};

  /*!
    * Bootstrap data.js v5.1.3 (https://getbootstrap.com/)
    * Copyright 2011-2021 The Bootstrap Authors (https://github.com/twbs/bootstrap/graphs/contributors)
    * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
    */

  (function (module, exports) {
  (function (global, factory) {
    module.exports = factory() ;
  })(commonjsGlobal, function () {
    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): dom/data.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */

    /**
     * ------------------------------------------------------------------------
     * Constants
     * ------------------------------------------------------------------------
     */

    const elementMap = new Map();
    const data = {
      set(element, key, instance) {
        if (!elementMap.has(element)) {
          elementMap.set(element, new Map());
        }

        const instanceMap = elementMap.get(element); // make it clear we only want one instance per element
        // can be removed later when multiple key/instances are fine to be used

        if (!instanceMap.has(key) && instanceMap.size !== 0) {
          // eslint-disable-next-line no-console
          console.error(`Bootstrap doesn't allow more than one instance per element. Bound instance: ${Array.from(instanceMap.keys())[0]}.`);
          return;
        }

        instanceMap.set(key, instance);
      },

      get(element, key) {
        if (elementMap.has(element)) {
          return elementMap.get(element).get(key) || null;
        }

        return null;
      },

      remove(element, key) {
        if (!elementMap.has(element)) {
          return;
        }

        const instanceMap = elementMap.get(element);
        instanceMap.delete(key); // free up element references if there are no instances left for an element

        if (instanceMap.size === 0) {
          elementMap.delete(element);
        }
      }

    };
    return data;
  }); 
  }(data$1));

  /*!
    * Bootstrap base-component.js v5.1.3 (https://getbootstrap.com/)
    * Copyright 2011-2021 The Bootstrap Authors (https://github.com/twbs/bootstrap/graphs/contributors)
    * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
    */

  (function (module, exports) {
  (function (global, factory) {
    module.exports = factory(data$1.exports, eventHandler$1.exports) ;
  })(commonjsGlobal, function (Data, EventHandler) {

    const _interopDefaultLegacy = e => e && typeof e === 'object' && 'default' in e ? e : {
      default: e
    };

    const Data__default = /*#__PURE__*/_interopDefaultLegacy(Data);

    const EventHandler__default = /*#__PURE__*/_interopDefaultLegacy(EventHandler);
    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): util/index.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */


    const MILLISECONDS_MULTIPLIER = 1000;
    const TRANSITION_END = 'transitionend'; // Shoutout AngusCroll (https://goo.gl/pxwQGp)

    const getTransitionDurationFromElement = element => {
      if (!element) {
        return 0;
      } // Get transition-duration of the element


      let {
        transitionDuration,
        transitionDelay
      } = window.getComputedStyle(element);
      const floatTransitionDuration = Number.parseFloat(transitionDuration);
      const floatTransitionDelay = Number.parseFloat(transitionDelay); // Return 0 if element or transition duration is not found

      if (!floatTransitionDuration && !floatTransitionDelay) {
        return 0;
      } // If multiple durations are defined, take the first


      transitionDuration = transitionDuration.split(',')[0];
      transitionDelay = transitionDelay.split(',')[0];
      return (Number.parseFloat(transitionDuration) + Number.parseFloat(transitionDelay)) * MILLISECONDS_MULTIPLIER;
    };

    const triggerTransitionEnd = element => {
      element.dispatchEvent(new Event(TRANSITION_END));
    };

    const isElement = obj => {
      if (!obj || typeof obj !== 'object') {
        return false;
      }

      if (typeof obj.jquery !== 'undefined') {
        obj = obj[0];
      }

      return typeof obj.nodeType !== 'undefined';
    };

    const getElement = obj => {
      if (isElement(obj)) {
        // it's a jQuery object or a node element
        return obj.jquery ? obj[0] : obj;
      }

      if (typeof obj === 'string' && obj.length > 0) {
        return document.querySelector(obj);
      }

      return null;
    };

    const execute = callback => {
      if (typeof callback === 'function') {
        callback();
      }
    };

    const executeAfterTransition = (callback, transitionElement, waitForTransition = true) => {
      if (!waitForTransition) {
        execute(callback);
        return;
      }

      const durationPadding = 5;
      const emulatedDuration = getTransitionDurationFromElement(transitionElement) + durationPadding;
      let called = false;

      const handler = ({
        target
      }) => {
        if (target !== transitionElement) {
          return;
        }

        called = true;
        transitionElement.removeEventListener(TRANSITION_END, handler);
        execute(callback);
      };

      transitionElement.addEventListener(TRANSITION_END, handler);
      setTimeout(() => {
        if (!called) {
          triggerTransitionEnd(transitionElement);
        }
      }, emulatedDuration);
    };
    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): base-component.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */

    /**
     * ------------------------------------------------------------------------
     * Constants
     * ------------------------------------------------------------------------
     */


    const VERSION = '5.1.3';

    class BaseComponent {
      constructor(element) {
        element = getElement(element);

        if (!element) {
          return;
        }

        this._element = element;
        Data__default.default.set(this._element, this.constructor.DATA_KEY, this);
      }

      dispose() {
        Data__default.default.remove(this._element, this.constructor.DATA_KEY);
        EventHandler__default.default.off(this._element, this.constructor.EVENT_KEY);
        Object.getOwnPropertyNames(this).forEach(propertyName => {
          this[propertyName] = null;
        });
      }

      _queueCallback(callback, element, isAnimated = true) {
        executeAfterTransition(callback, element, isAnimated);
      }
      /** Static */


      static getInstance(element) {
        return Data__default.default.get(getElement(element), this.DATA_KEY);
      }

      static getOrCreateInstance(element, config = {}) {
        return this.getInstance(element) || new this(element, typeof config === 'object' ? config : null);
      }

      static get VERSION() {
        return VERSION;
      }

      static get NAME() {
        throw new Error('You have to implement the static method "NAME", for each component!');
      }

      static get DATA_KEY() {
        return `bs.${this.NAME}`;
      }

      static get EVENT_KEY() {
        return `.${this.DATA_KEY}`;
      }

    }

    return BaseComponent;
  }); 
  }(baseComponent$1));

  /*!
    * Bootstrap modal.js v5.1.3 (https://getbootstrap.com/)
    * Copyright 2011-2021 The Bootstrap Authors (https://github.com/twbs/bootstrap/graphs/contributors)
    * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
    */

  (function (module, exports) {
  (function (global, factory) {
    module.exports = factory(eventHandler$1.exports, manipulator$1.exports, selectorEngine$1.exports, baseComponent$1.exports) ;
  })(commonjsGlobal, function (EventHandler, Manipulator, SelectorEngine, BaseComponent) {

    const _interopDefaultLegacy = e => e && typeof e === 'object' && 'default' in e ? e : {
      default: e
    };

    const EventHandler__default = /*#__PURE__*/_interopDefaultLegacy(EventHandler);

    const Manipulator__default = /*#__PURE__*/_interopDefaultLegacy(Manipulator);

    const SelectorEngine__default = /*#__PURE__*/_interopDefaultLegacy(SelectorEngine);

    const BaseComponent__default = /*#__PURE__*/_interopDefaultLegacy(BaseComponent);
    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): util/index.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */


    const MILLISECONDS_MULTIPLIER = 1000;
    const TRANSITION_END = 'transitionend'; // Shoutout AngusCroll (https://goo.gl/pxwQGp)

    const toType = obj => {
      if (obj === null || obj === undefined) {
        return `${obj}`;
      }

      return {}.toString.call(obj).match(/\s([a-z]+)/i)[1].toLowerCase();
    };

    const getSelector = element => {
      let selector = element.getAttribute('data-bs-target');

      if (!selector || selector === '#') {
        let hrefAttr = element.getAttribute('href'); // The only valid content that could double as a selector are IDs or classes,
        // so everything starting with `#` or `.`. If a "real" URL is used as the selector,
        // `document.querySelector` will rightfully complain it is invalid.
        // See https://github.com/twbs/bootstrap/issues/32273

        if (!hrefAttr || !hrefAttr.includes('#') && !hrefAttr.startsWith('.')) {
          return null;
        } // Just in case some CMS puts out a full URL with the anchor appended


        if (hrefAttr.includes('#') && !hrefAttr.startsWith('#')) {
          hrefAttr = `#${hrefAttr.split('#')[1]}`;
        }

        selector = hrefAttr && hrefAttr !== '#' ? hrefAttr.trim() : null;
      }

      return selector;
    };

    const getElementFromSelector = element => {
      const selector = getSelector(element);
      return selector ? document.querySelector(selector) : null;
    };

    const getTransitionDurationFromElement = element => {
      if (!element) {
        return 0;
      } // Get transition-duration of the element


      let {
        transitionDuration,
        transitionDelay
      } = window.getComputedStyle(element);
      const floatTransitionDuration = Number.parseFloat(transitionDuration);
      const floatTransitionDelay = Number.parseFloat(transitionDelay); // Return 0 if element or transition duration is not found

      if (!floatTransitionDuration && !floatTransitionDelay) {
        return 0;
      } // If multiple durations are defined, take the first


      transitionDuration = transitionDuration.split(',')[0];
      transitionDelay = transitionDelay.split(',')[0];
      return (Number.parseFloat(transitionDuration) + Number.parseFloat(transitionDelay)) * MILLISECONDS_MULTIPLIER;
    };

    const triggerTransitionEnd = element => {
      element.dispatchEvent(new Event(TRANSITION_END));
    };

    const isElement = obj => {
      if (!obj || typeof obj !== 'object') {
        return false;
      }

      if (typeof obj.jquery !== 'undefined') {
        obj = obj[0];
      }

      return typeof obj.nodeType !== 'undefined';
    };

    const getElement = obj => {
      if (isElement(obj)) {
        // it's a jQuery object or a node element
        return obj.jquery ? obj[0] : obj;
      }

      if (typeof obj === 'string' && obj.length > 0) {
        return document.querySelector(obj);
      }

      return null;
    };

    const typeCheckConfig = (componentName, config, configTypes) => {
      Object.keys(configTypes).forEach(property => {
        const expectedTypes = configTypes[property];
        const value = config[property];
        const valueType = value && isElement(value) ? 'element' : toType(value);

        if (!new RegExp(expectedTypes).test(valueType)) {
          throw new TypeError(`${componentName.toUpperCase()}: Option "${property}" provided type "${valueType}" but expected type "${expectedTypes}".`);
        }
      });
    };

    const isVisible = element => {
      if (!isElement(element) || element.getClientRects().length === 0) {
        return false;
      }

      return getComputedStyle(element).getPropertyValue('visibility') === 'visible';
    };

    const isDisabled = element => {
      if (!element || element.nodeType !== Node.ELEMENT_NODE) {
        return true;
      }

      if (element.classList.contains('disabled')) {
        return true;
      }

      if (typeof element.disabled !== 'undefined') {
        return element.disabled;
      }

      return element.hasAttribute('disabled') && element.getAttribute('disabled') !== 'false';
    };
    /**
     * Trick to restart an element's animation
     *
     * @param {HTMLElement} element
     * @return void
     *
     * @see https://www.charistheo.io/blog/2021/02/restart-a-css-animation-with-javascript/#restarting-a-css-animation
     */


    const reflow = element => {
      // eslint-disable-next-line no-unused-expressions
      element.offsetHeight;
    };

    const getjQuery = () => {
      const {
        jQuery
      } = window;

      if (jQuery && !document.body.hasAttribute('data-bs-no-jquery')) {
        return jQuery;
      }

      return null;
    };

    const DOMContentLoadedCallbacks = [];

    const onDOMContentLoaded = callback => {
      if (document.readyState === 'loading') {
        // add listener on the first call when the document is in loading state
        if (!DOMContentLoadedCallbacks.length) {
          document.addEventListener('DOMContentLoaded', () => {
            DOMContentLoadedCallbacks.forEach(callback => callback());
          });
        }

        DOMContentLoadedCallbacks.push(callback);
      } else {
        callback();
      }
    };

    const isRTL = () => document.documentElement.dir === 'rtl';

    const defineJQueryPlugin = plugin => {
      onDOMContentLoaded(() => {
        const $ = getjQuery();
        /* istanbul ignore if */

        if ($) {
          const name = plugin.NAME;
          const JQUERY_NO_CONFLICT = $.fn[name];
          $.fn[name] = plugin.jQueryInterface;
          $.fn[name].Constructor = plugin;

          $.fn[name].noConflict = () => {
            $.fn[name] = JQUERY_NO_CONFLICT;
            return plugin.jQueryInterface;
          };
        }
      });
    };

    const execute = callback => {
      if (typeof callback === 'function') {
        callback();
      }
    };

    const executeAfterTransition = (callback, transitionElement, waitForTransition = true) => {
      if (!waitForTransition) {
        execute(callback);
        return;
      }

      const durationPadding = 5;
      const emulatedDuration = getTransitionDurationFromElement(transitionElement) + durationPadding;
      let called = false;

      const handler = ({
        target
      }) => {
        if (target !== transitionElement) {
          return;
        }

        called = true;
        transitionElement.removeEventListener(TRANSITION_END, handler);
        execute(callback);
      };

      transitionElement.addEventListener(TRANSITION_END, handler);
      setTimeout(() => {
        if (!called) {
          triggerTransitionEnd(transitionElement);
        }
      }, emulatedDuration);
    };
    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): util/scrollBar.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */


    const SELECTOR_FIXED_CONTENT = '.fixed-top, .fixed-bottom, .is-fixed, .sticky-top';
    const SELECTOR_STICKY_CONTENT = '.sticky-top';

    class ScrollBarHelper {
      constructor() {
        this._element = document.body;
      }

      getWidth() {
        // https://developer.mozilla.org/en-US/docs/Web/API/Window/innerWidth#usage_notes
        const documentWidth = document.documentElement.clientWidth;
        return Math.abs(window.innerWidth - documentWidth);
      }

      hide() {
        const width = this.getWidth();

        this._disableOverFlow(); // give padding to element to balance the hidden scrollbar width


        this._setElementAttributes(this._element, 'paddingRight', calculatedValue => calculatedValue + width); // trick: We adjust positive paddingRight and negative marginRight to sticky-top elements to keep showing fullwidth


        this._setElementAttributes(SELECTOR_FIXED_CONTENT, 'paddingRight', calculatedValue => calculatedValue + width);

        this._setElementAttributes(SELECTOR_STICKY_CONTENT, 'marginRight', calculatedValue => calculatedValue - width);
      }

      _disableOverFlow() {
        this._saveInitialAttribute(this._element, 'overflow');

        this._element.style.overflow = 'hidden';
      }

      _setElementAttributes(selector, styleProp, callback) {
        const scrollbarWidth = this.getWidth();

        const manipulationCallBack = element => {
          if (element !== this._element && window.innerWidth > element.clientWidth + scrollbarWidth) {
            return;
          }

          this._saveInitialAttribute(element, styleProp);

          const calculatedValue = window.getComputedStyle(element)[styleProp];
          element.style[styleProp] = `${callback(Number.parseFloat(calculatedValue))}px`;
        };

        this._applyManipulationCallback(selector, manipulationCallBack);
      }

      reset() {
        this._resetElementAttributes(this._element, 'overflow');

        this._resetElementAttributes(this._element, 'paddingRight');

        this._resetElementAttributes(SELECTOR_FIXED_CONTENT, 'paddingRight');

        this._resetElementAttributes(SELECTOR_STICKY_CONTENT, 'marginRight');
      }

      _saveInitialAttribute(element, styleProp) {
        const actualValue = element.style[styleProp];

        if (actualValue) {
          Manipulator__default.default.setDataAttribute(element, styleProp, actualValue);
        }
      }

      _resetElementAttributes(selector, styleProp) {
        const manipulationCallBack = element => {
          const value = Manipulator__default.default.getDataAttribute(element, styleProp);

          if (typeof value === 'undefined') {
            element.style.removeProperty(styleProp);
          } else {
            Manipulator__default.default.removeDataAttribute(element, styleProp);
            element.style[styleProp] = value;
          }
        };

        this._applyManipulationCallback(selector, manipulationCallBack);
      }

      _applyManipulationCallback(selector, callBack) {
        if (isElement(selector)) {
          callBack(selector);
        } else {
          SelectorEngine__default.default.find(selector, this._element).forEach(callBack);
        }
      }

      isOverflowing() {
        return this.getWidth() > 0;
      }

    }
    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): util/backdrop.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */


    const Default$2 = {
      className: 'modal-backdrop',
      isVisible: true,
      // if false, we use the backdrop helper without adding any element to the dom
      isAnimated: false,
      rootElement: 'body',
      // give the choice to place backdrop under different elements
      clickCallback: null
    };
    const DefaultType$2 = {
      className: 'string',
      isVisible: 'boolean',
      isAnimated: 'boolean',
      rootElement: '(element|string)',
      clickCallback: '(function|null)'
    };
    const NAME$2 = 'backdrop';
    const CLASS_NAME_FADE$1 = 'fade';
    const CLASS_NAME_SHOW$1 = 'show';
    const EVENT_MOUSEDOWN = `mousedown.bs.${NAME$2}`;

    class Backdrop {
      constructor(config) {
        this._config = this._getConfig(config);
        this._isAppended = false;
        this._element = null;
      }

      show(callback) {
        if (!this._config.isVisible) {
          execute(callback);
          return;
        }

        this._append();

        if (this._config.isAnimated) {
          reflow(this._getElement());
        }

        this._getElement().classList.add(CLASS_NAME_SHOW$1);

        this._emulateAnimation(() => {
          execute(callback);
        });
      }

      hide(callback) {
        if (!this._config.isVisible) {
          execute(callback);
          return;
        }

        this._getElement().classList.remove(CLASS_NAME_SHOW$1);

        this._emulateAnimation(() => {
          this.dispose();
          execute(callback);
        });
      } // Private


      _getElement() {
        if (!this._element) {
          const backdrop = document.createElement('div');
          backdrop.className = this._config.className;

          if (this._config.isAnimated) {
            backdrop.classList.add(CLASS_NAME_FADE$1);
          }

          this._element = backdrop;
        }

        return this._element;
      }

      _getConfig(config) {
        config = { ...Default$2,
          ...(typeof config === 'object' ? config : {})
        }; // use getElement() with the default "body" to get a fresh Element on each instantiation

        config.rootElement = getElement(config.rootElement);
        typeCheckConfig(NAME$2, config, DefaultType$2);
        return config;
      }

      _append() {
        if (this._isAppended) {
          return;
        }

        this._config.rootElement.append(this._getElement());

        EventHandler__default.default.on(this._getElement(), EVENT_MOUSEDOWN, () => {
          execute(this._config.clickCallback);
        });
        this._isAppended = true;
      }

      dispose() {
        if (!this._isAppended) {
          return;
        }

        EventHandler__default.default.off(this._element, EVENT_MOUSEDOWN);

        this._element.remove();

        this._isAppended = false;
      }

      _emulateAnimation(callback) {
        executeAfterTransition(callback, this._getElement(), this._config.isAnimated);
      }

    }
    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): util/focustrap.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */


    const Default$1 = {
      trapElement: null,
      // The element to trap focus inside of
      autofocus: true
    };
    const DefaultType$1 = {
      trapElement: 'element',
      autofocus: 'boolean'
    };
    const NAME$1 = 'focustrap';
    const DATA_KEY$1 = 'bs.focustrap';
    const EVENT_KEY$1 = `.${DATA_KEY$1}`;
    const EVENT_FOCUSIN = `focusin${EVENT_KEY$1}`;
    const EVENT_KEYDOWN_TAB = `keydown.tab${EVENT_KEY$1}`;
    const TAB_KEY = 'Tab';
    const TAB_NAV_FORWARD = 'forward';
    const TAB_NAV_BACKWARD = 'backward';

    class FocusTrap {
      constructor(config) {
        this._config = this._getConfig(config);
        this._isActive = false;
        this._lastTabNavDirection = null;
      }

      activate() {
        const {
          trapElement,
          autofocus
        } = this._config;

        if (this._isActive) {
          return;
        }

        if (autofocus) {
          trapElement.focus();
        }

        EventHandler__default.default.off(document, EVENT_KEY$1); // guard against infinite focus loop

        EventHandler__default.default.on(document, EVENT_FOCUSIN, event => this._handleFocusin(event));
        EventHandler__default.default.on(document, EVENT_KEYDOWN_TAB, event => this._handleKeydown(event));
        this._isActive = true;
      }

      deactivate() {
        if (!this._isActive) {
          return;
        }

        this._isActive = false;
        EventHandler__default.default.off(document, EVENT_KEY$1);
      } // Private


      _handleFocusin(event) {
        const {
          target
        } = event;
        const {
          trapElement
        } = this._config;

        if (target === document || target === trapElement || trapElement.contains(target)) {
          return;
        }

        const elements = SelectorEngine__default.default.focusableChildren(trapElement);

        if (elements.length === 0) {
          trapElement.focus();
        } else if (this._lastTabNavDirection === TAB_NAV_BACKWARD) {
          elements[elements.length - 1].focus();
        } else {
          elements[0].focus();
        }
      }

      _handleKeydown(event) {
        if (event.key !== TAB_KEY) {
          return;
        }

        this._lastTabNavDirection = event.shiftKey ? TAB_NAV_BACKWARD : TAB_NAV_FORWARD;
      }

      _getConfig(config) {
        config = { ...Default$1,
          ...(typeof config === 'object' ? config : {})
        };
        typeCheckConfig(NAME$1, config, DefaultType$1);
        return config;
      }

    }
    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): util/component-functions.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */


    const enableDismissTrigger = (component, method = 'hide') => {
      const clickEvent = `click.dismiss${component.EVENT_KEY}`;
      const name = component.NAME;
      EventHandler__default.default.on(document, clickEvent, `[data-bs-dismiss="${name}"]`, function (event) {
        if (['A', 'AREA'].includes(this.tagName)) {
          event.preventDefault();
        }

        if (isDisabled(this)) {
          return;
        }

        const target = getElementFromSelector(this) || this.closest(`.${name}`);
        const instance = component.getOrCreateInstance(target); // Method argument is left, for Alert and only, as it doesn't implement the 'hide' method

        instance[method]();
      });
    };
    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): modal.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */

    /**
     * ------------------------------------------------------------------------
     * Constants
     * ------------------------------------------------------------------------
     */


    const NAME = 'modal';
    const DATA_KEY = 'bs.modal';
    const EVENT_KEY = `.${DATA_KEY}`;
    const DATA_API_KEY = '.data-api';
    const ESCAPE_KEY = 'Escape';
    const Default = {
      backdrop: true,
      keyboard: true,
      focus: true
    };
    const DefaultType = {
      backdrop: '(boolean|string)',
      keyboard: 'boolean',
      focus: 'boolean'
    };
    const EVENT_HIDE = `hide${EVENT_KEY}`;
    const EVENT_HIDE_PREVENTED = `hidePrevented${EVENT_KEY}`;
    const EVENT_HIDDEN = `hidden${EVENT_KEY}`;
    const EVENT_SHOW = `show${EVENT_KEY}`;
    const EVENT_SHOWN = `shown${EVENT_KEY}`;
    const EVENT_RESIZE = `resize${EVENT_KEY}`;
    const EVENT_CLICK_DISMISS = `click.dismiss${EVENT_KEY}`;
    const EVENT_KEYDOWN_DISMISS = `keydown.dismiss${EVENT_KEY}`;
    const EVENT_MOUSEUP_DISMISS = `mouseup.dismiss${EVENT_KEY}`;
    const EVENT_MOUSEDOWN_DISMISS = `mousedown.dismiss${EVENT_KEY}`;
    const EVENT_CLICK_DATA_API = `click${EVENT_KEY}${DATA_API_KEY}`;
    const CLASS_NAME_OPEN = 'modal-open';
    const CLASS_NAME_FADE = 'fade';
    const CLASS_NAME_SHOW = 'show';
    const CLASS_NAME_STATIC = 'modal-static';
    const OPEN_SELECTOR = '.modal.show';
    const SELECTOR_DIALOG = '.modal-dialog';
    const SELECTOR_MODAL_BODY = '.modal-body';
    const SELECTOR_DATA_TOGGLE = '[data-bs-toggle="modal"]';
    /**
     * ------------------------------------------------------------------------
     * Class Definition
     * ------------------------------------------------------------------------
     */

    class Modal extends BaseComponent__default.default {
      constructor(element, config) {
        super(element);
        this._config = this._getConfig(config);
        this._dialog = SelectorEngine__default.default.findOne(SELECTOR_DIALOG, this._element);
        this._backdrop = this._initializeBackDrop();
        this._focustrap = this._initializeFocusTrap();
        this._isShown = false;
        this._ignoreBackdropClick = false;
        this._isTransitioning = false;
        this._scrollBar = new ScrollBarHelper();
      } // Getters


      static get Default() {
        return Default;
      }

      static get NAME() {
        return NAME;
      } // Public


      toggle(relatedTarget) {
        return this._isShown ? this.hide() : this.show(relatedTarget);
      }

      show(relatedTarget) {
        if (this._isShown || this._isTransitioning) {
          return;
        }

        const showEvent = EventHandler__default.default.trigger(this._element, EVENT_SHOW, {
          relatedTarget
        });

        if (showEvent.defaultPrevented) {
          return;
        }

        this._isShown = true;

        if (this._isAnimated()) {
          this._isTransitioning = true;
        }

        this._scrollBar.hide();

        document.body.classList.add(CLASS_NAME_OPEN);

        this._adjustDialog();

        this._setEscapeEvent();

        this._setResizeEvent();

        EventHandler__default.default.on(this._dialog, EVENT_MOUSEDOWN_DISMISS, () => {
          EventHandler__default.default.one(this._element, EVENT_MOUSEUP_DISMISS, event => {
            if (event.target === this._element) {
              this._ignoreBackdropClick = true;
            }
          });
        });

        this._showBackdrop(() => this._showElement(relatedTarget));
      }

      hide() {
        if (!this._isShown || this._isTransitioning) {
          return;
        }

        const hideEvent = EventHandler__default.default.trigger(this._element, EVENT_HIDE);

        if (hideEvent.defaultPrevented) {
          return;
        }

        this._isShown = false;

        const isAnimated = this._isAnimated();

        if (isAnimated) {
          this._isTransitioning = true;
        }

        this._setEscapeEvent();

        this._setResizeEvent();

        this._focustrap.deactivate();

        this._element.classList.remove(CLASS_NAME_SHOW);

        EventHandler__default.default.off(this._element, EVENT_CLICK_DISMISS);
        EventHandler__default.default.off(this._dialog, EVENT_MOUSEDOWN_DISMISS);

        this._queueCallback(() => this._hideModal(), this._element, isAnimated);
      }

      dispose() {
        [window, this._dialog].forEach(htmlElement => EventHandler__default.default.off(htmlElement, EVENT_KEY));

        this._backdrop.dispose();

        this._focustrap.deactivate();

        super.dispose();
      }

      handleUpdate() {
        this._adjustDialog();
      } // Private


      _initializeBackDrop() {
        return new Backdrop({
          isVisible: Boolean(this._config.backdrop),
          // 'static' option will be translated to true, and booleans will keep their value
          isAnimated: this._isAnimated()
        });
      }

      _initializeFocusTrap() {
        return new FocusTrap({
          trapElement: this._element
        });
      }

      _getConfig(config) {
        config = { ...Default,
          ...Manipulator__default.default.getDataAttributes(this._element),
          ...(typeof config === 'object' ? config : {})
        };
        typeCheckConfig(NAME, config, DefaultType);
        return config;
      }

      _showElement(relatedTarget) {
        const isAnimated = this._isAnimated();

        const modalBody = SelectorEngine__default.default.findOne(SELECTOR_MODAL_BODY, this._dialog);

        if (!this._element.parentNode || this._element.parentNode.nodeType !== Node.ELEMENT_NODE) {
          // Don't move modal's DOM position
          document.body.append(this._element);
        }

        this._element.style.display = 'block';

        this._element.removeAttribute('aria-hidden');

        this._element.setAttribute('aria-modal', true);

        this._element.setAttribute('role', 'dialog');

        this._element.scrollTop = 0;

        if (modalBody) {
          modalBody.scrollTop = 0;
        }

        if (isAnimated) {
          reflow(this._element);
        }

        this._element.classList.add(CLASS_NAME_SHOW);

        const transitionComplete = () => {
          if (this._config.focus) {
            this._focustrap.activate();
          }

          this._isTransitioning = false;
          EventHandler__default.default.trigger(this._element, EVENT_SHOWN, {
            relatedTarget
          });
        };

        this._queueCallback(transitionComplete, this._dialog, isAnimated);
      }

      _setEscapeEvent() {
        if (this._isShown) {
          EventHandler__default.default.on(this._element, EVENT_KEYDOWN_DISMISS, event => {
            if (this._config.keyboard && event.key === ESCAPE_KEY) {
              event.preventDefault();
              this.hide();
            } else if (!this._config.keyboard && event.key === ESCAPE_KEY) {
              this._triggerBackdropTransition();
            }
          });
        } else {
          EventHandler__default.default.off(this._element, EVENT_KEYDOWN_DISMISS);
        }
      }

      _setResizeEvent() {
        if (this._isShown) {
          EventHandler__default.default.on(window, EVENT_RESIZE, () => this._adjustDialog());
        } else {
          EventHandler__default.default.off(window, EVENT_RESIZE);
        }
      }

      _hideModal() {
        this._element.style.display = 'none';

        this._element.setAttribute('aria-hidden', true);

        this._element.removeAttribute('aria-modal');

        this._element.removeAttribute('role');

        this._isTransitioning = false;

        this._backdrop.hide(() => {
          document.body.classList.remove(CLASS_NAME_OPEN);

          this._resetAdjustments();

          this._scrollBar.reset();

          EventHandler__default.default.trigger(this._element, EVENT_HIDDEN);
        });
      }

      _showBackdrop(callback) {
        EventHandler__default.default.on(this._element, EVENT_CLICK_DISMISS, event => {
          if (this._ignoreBackdropClick) {
            this._ignoreBackdropClick = false;
            return;
          }

          if (event.target !== event.currentTarget) {
            return;
          }

          if (this._config.backdrop === true) {
            this.hide();
          } else if (this._config.backdrop === 'static') {
            this._triggerBackdropTransition();
          }
        });

        this._backdrop.show(callback);
      }

      _isAnimated() {
        return this._element.classList.contains(CLASS_NAME_FADE);
      }

      _triggerBackdropTransition() {
        const hideEvent = EventHandler__default.default.trigger(this._element, EVENT_HIDE_PREVENTED);

        if (hideEvent.defaultPrevented) {
          return;
        }

        const {
          classList,
          scrollHeight,
          style
        } = this._element;
        const isModalOverflowing = scrollHeight > document.documentElement.clientHeight; // return if the following background transition hasn't yet completed

        if (!isModalOverflowing && style.overflowY === 'hidden' || classList.contains(CLASS_NAME_STATIC)) {
          return;
        }

        if (!isModalOverflowing) {
          style.overflowY = 'hidden';
        }

        classList.add(CLASS_NAME_STATIC);

        this._queueCallback(() => {
          classList.remove(CLASS_NAME_STATIC);

          if (!isModalOverflowing) {
            this._queueCallback(() => {
              style.overflowY = '';
            }, this._dialog);
          }
        }, this._dialog);

        this._element.focus();
      } // ----------------------------------------------------------------------
      // the following methods are used to handle overflowing modals
      // ----------------------------------------------------------------------


      _adjustDialog() {
        const isModalOverflowing = this._element.scrollHeight > document.documentElement.clientHeight;

        const scrollbarWidth = this._scrollBar.getWidth();

        const isBodyOverflowing = scrollbarWidth > 0;

        if (!isBodyOverflowing && isModalOverflowing && !isRTL() || isBodyOverflowing && !isModalOverflowing && isRTL()) {
          this._element.style.paddingLeft = `${scrollbarWidth}px`;
        }

        if (isBodyOverflowing && !isModalOverflowing && !isRTL() || !isBodyOverflowing && isModalOverflowing && isRTL()) {
          this._element.style.paddingRight = `${scrollbarWidth}px`;
        }
      }

      _resetAdjustments() {
        this._element.style.paddingLeft = '';
        this._element.style.paddingRight = '';
      } // Static


      static jQueryInterface(config, relatedTarget) {
        return this.each(function () {
          const data = Modal.getOrCreateInstance(this, config);

          if (typeof config !== 'string') {
            return;
          }

          if (typeof data[config] === 'undefined') {
            throw new TypeError(`No method named "${config}"`);
          }

          data[config](relatedTarget);
        });
      }

    }
    /**
     * ------------------------------------------------------------------------
     * Data Api implementation
     * ------------------------------------------------------------------------
     */


    EventHandler__default.default.on(document, EVENT_CLICK_DATA_API, SELECTOR_DATA_TOGGLE, function (event) {
      const target = getElementFromSelector(this);

      if (['A', 'AREA'].includes(this.tagName)) {
        event.preventDefault();
      }

      EventHandler__default.default.one(target, EVENT_SHOW, showEvent => {
        if (showEvent.defaultPrevented) {
          // only register focus restorer if modal will actually get shown
          return;
        }

        EventHandler__default.default.one(target, EVENT_HIDDEN, () => {
          if (isVisible(this)) {
            this.focus();
          }
        });
      }); // avoid conflict when clicking moddal toggler while another one is open

      const allReadyOpen = SelectorEngine__default.default.findOne(OPEN_SELECTOR);

      if (allReadyOpen) {
        Modal.getInstance(allReadyOpen).hide();
      }

      const data = Modal.getOrCreateInstance(target);
      data.toggle(this);
    });
    enableDismissTrigger(Modal);
    /**
     * ------------------------------------------------------------------------
     * jQuery
     * ------------------------------------------------------------------------
     * add .Modal to jQuery only if jQuery is present
     */

    defineJQueryPlugin(Modal);
    return Modal;
  }); 
  }(modal$1));

  var e = modal$1.exports;

  var t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e;}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e;};function i(){return !("undefined"==typeof window||!window.history||!window.history.pushState);}function r(e,t,r){this.root=null,this._routes=[],this._useHash=t,this._hash=void 0===r?"#":r,this._paused=!1,this._destroyed=!1,this._lastRouteResolved=null,this._notFoundHandler=null,this._defaultHandler=null,this._usePushState=!t&&i(),this._onLocationChange=this._onLocationChange.bind(this),this._genericHooks=null,this._historyAPIUpdateMethod="pushState",e?this.root=t?e.replace(/\/$/,"/"+this._hash):e.replace(/\/$/,""):t&&(this.root=this._cLoc().split(this._hash)[0].replace(/\/$/,"/"+this._hash)),this._listen(),this.updatePageLinks();}function n(e){return e instanceof RegExp?e:e.replace(/\/+$/,"").replace(/^\/+/,"^/");}function o(e,t){return 0===t.length?null:e?e.slice(1,e.length).reduce(function(e,i,r){return null===e&&(e={}),e[t[r]]=decodeURIComponent(i),e;},null):null;}function s(e){var t=[];return {regexp:e instanceof RegExp?e:new RegExp(e.replace(r.PARAMETER_REGEXP,function(e,i,n){return t.push(n),r.REPLACE_VARIABLE_REGEXP;}).replace(r.WILDCARD_REGEXP,r.REPLACE_WILDCARD)+r.FOLLOWED_BY_SLASH_REGEXP,r.MATCH_REGEXP_FLAGS),paramNames:t};}function a(e){return e.replace(/\/$/,"").split("/").length;}function l(e,t){return a(t)-a(e);}function c(e,t){return function(e){return (arguments.length>1&&void 0!==arguments[1]?arguments[1]:[]).map(function(t){var i=s(n(t.route)),r=i.regexp,a=i.paramNames,l=e.replace(/^\/+/,"/").match(r),c=o(l,a);return !!l&&{match:l,route:t,params:c};}).filter(function(e){return e;});}(e,t)[0]||!1;}function h(e,t){var i=t.map(function(t){return ""===t.route||"*"===t.route?e:e.split(new RegExp(t.route+"($|/)"))[0];}),r=n(e);return i.length>1?i.reduce(function(e,t){return e.length>t.length&&(e=t),e;},i[0]):1===i.length?i[0]:r;}function u(e,t,r){var n,o=function(e){return e.split(/\?(.*)?$/)[0];};return void 0===r&&(r="#"),i()&&!t?o(e).split(r)[0]:(n=e.split(r)).length>1?o(n[1]):o(n[0]);}function d(e,i,r){if(i&&"object"===(void 0===i?"undefined":t(i))){if(i.before)return void i.before(function(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];t&&(e(),i.after&&i.after(r));},r);if(i.after)return e(),void(i.after&&i.after(r));}e();}function p(e){return !!(e.detail&&e.detail>1)&&(e.preventDefault(),e.stopPropagation(),!0);}r.prototype={helpers:{match:c,root:h,clean:n,getOnlyURL:u},navigate:function(e,t){var i;return e=e||"",this._usePushState?(i=(i=(t?"":this._getRoot()+"/")+e.replace(/^\/+/,"/")).replace(/([^:])(\/{2,})/g,"$1/"),history[this._historyAPIUpdateMethod]({},"",i),this.resolve()):"undefined"!=typeof window&&(e=e.replace(new RegExp("^"+this._hash),""),window.location.href=window.location.href.replace(/#$/,"").replace(new RegExp(this._hash+".*$"),"")+this._hash+e),this;},on:function(){for(var e=this,i=arguments.length,r=Array(i),n=0;n<i;n++)r[n]=arguments[n];if("function"==typeof r[0])this._defaultHandler={handler:r[0],hooks:r[1]};else if(r.length>=2){if("/"===r[0]){var o=r[1];"object"===t(r[1])&&(o=r[1].uses),this._defaultHandler={handler:o,hooks:r[2]};}else this._add(r[0],r[1],r[2]);}else if("object"===t(r[0])){var s=Object.keys(r[0]).sort(l);s.forEach(function(t){e.on(t,r[0][t]);});}return this;},off:function(e){return null!==this._defaultHandler&&e===this._defaultHandler.handler?this._defaultHandler=null:null!==this._notFoundHandler&&e===this._notFoundHandler.handler&&(this._notFoundHandler=null),this._routes=this._routes.reduce(function(t,i){return i.handler!==e&&t.push(i),t;},[]),this;},notFound:function(e,t){return this._notFoundHandler={handler:e,hooks:t},this;},resolve:function(e){var t,r,n=this,o=(e||this._cLoc()).replace(this._getRoot(),"");this._useHash&&(o=o.replace(new RegExp("^/"+this._hash),"/"));var s=function(e){return e.split(/\?(.*)?$/).slice(1).join("");}(e||this._cLoc()),a=u(o,this._useHash,this._hash);return !this._paused&&(this._lastRouteResolved&&a===this._lastRouteResolved.url&&s===this._lastRouteResolved.query?(this._lastRouteResolved.hooks&&this._lastRouteResolved.hooks.already&&this._lastRouteResolved.hooks.already(this._lastRouteResolved.params),!1):(r=c(a,this._routes))?(this._callLeave(),this._lastRouteResolved={url:a,query:s,hooks:r.route.hooks,params:r.params,name:r.route.name},t=r.route.handler,d(function(){d(function(){r.route.route instanceof RegExp?t.apply(void 0,r.match.slice(1,r.match.length)):t(r.params,s);},r.route.hooks,r.params,n._genericHooks);},this._genericHooks,r.params),r):this._defaultHandler&&(""===a||"/"===a||a===this._hash||function(e,t,r){if(i()&&!t)return !1;if(!e.match(r))return !1;var n=e.split(r);return n.length<2||""===n[1];}(a,this._useHash,this._hash))?(d(function(){d(function(){n._callLeave(),n._lastRouteResolved={url:a,query:s,hooks:n._defaultHandler.hooks},n._defaultHandler.handler(s);},n._defaultHandler.hooks);},this._genericHooks),!0):(this._notFoundHandler&&d(function(){d(function(){n._callLeave(),n._lastRouteResolved={url:a,query:s,hooks:n._notFoundHandler.hooks},n._notFoundHandler.handler(s);},n._notFoundHandler.hooks);},this._genericHooks),!1));},destroy:function(){this._routes=[],this._destroyed=!0,this._lastRouteResolved=null,this._genericHooks=null,clearTimeout(this._listeningInterval),"undefined"!=typeof window&&(window.removeEventListener("popstate",this._onLocationChange),window.removeEventListener("hashchange",this._onLocationChange));},updatePageLinks:function(){var e=this;"undefined"!=typeof document&&this._findLinks().forEach(function(t){t.hasListenerAttached||(t.addEventListener("click",function(i){if((i.ctrlKey||i.metaKey)&&"a"==i.target.tagName.toLowerCase())return !1;var r=e.getLinkPath(t);e._destroyed||(i.preventDefault(),e.navigate(r.replace(/\/+$/,"").replace(/^\/+/,"/")));}),t.hasListenerAttached=!0);});},generate:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=this._routes.reduce(function(i,r){var n;if(r.name===e)for(n in i=r.route,t)i=i.toString().replace(":"+n,t[n]);return i;},"");return this._useHash?this._hash+i:i;},link:function(e){return this._getRoot()+e;},pause:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._paused=e,this._historyAPIUpdateMethod=e?"replaceState":"pushState";},resume:function(){this.pause(!1);},historyAPIUpdateMethod:function(e){return void 0===e?this._historyAPIUpdateMethod:(this._historyAPIUpdateMethod=e,e);},disableIfAPINotAvailable:function(){i()||this.destroy();},lastRouteResolved:function(){return this._lastRouteResolved;},getLinkPath:function(e){return e.getAttribute("href");},hooks:function(e){this._genericHooks=e;},_add:function(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return "string"==typeof e&&(e=encodeURI(e)),this._routes.push("object"===(void 0===i?"undefined":t(i))?{route:e,handler:i.uses,name:i.as,hooks:r||i.hooks}:{route:e,handler:i,hooks:r}),this._add;},_getRoot:function(){return null!==this.root||(this.root=h(this._cLoc().split("?")[0],this._routes)),this.root;},_listen:function(){var e=this;if(this._usePushState)window.addEventListener("popstate",this._onLocationChange);else if("undefined"!=typeof window&&"onhashchange"in window)window.addEventListener("hashchange",this._onLocationChange);else {var t=this._cLoc(),i=void 0,r=void 0;(r=function(){i=e._cLoc(),t!==i&&(t=i,e.resolve()),e._listeningInterval=setTimeout(r,200);})();}},_cLoc:function(){return "undefined"!=typeof window?void 0!==window.__NAVIGO_WINDOW_LOCATION_MOCK__?window.__NAVIGO_WINDOW_LOCATION_MOCK__:n(window.location.href):"";},_findLinks:function(){return [].slice.call(document.querySelectorAll("[data-navigo]"));},_onLocationChange:function(){this.resolve();},_callLeave:function(){var e=this._lastRouteResolved;e&&e.hooks&&e.hooks.leave&&e.hooks.leave(e.params);}},r.PARAMETER_REGEXP=/([:*])(\w+)/g,r.WILDCARD_REGEXP=/\*/g,r.REPLACE_VARIABLE_REGEXP="([^/]+)",r.REPLACE_WILDCARD="(?:.*)",r.FOLLOWED_BY_SLASH_REGEXP="(?:/$|$)",r.MATCH_REGEXP_FLAGS="";class f extends r{updatePageLinks(){if("undefined"==typeof document)return;const e=document.createElement("a");e.href=this.root;const t=e.pathname;this._findLinks().forEach(e=>{e.hasListenerAttached||(e.addEventListener("click",i=>{if(!p(i)){if((i.ctrlKey||i.metaKey)&&"a"===i.target.tagName.toLowerCase())return !1;if(!this._destroyed){const r=e.pathname.replace(t,"");i.preventDefault(),this.navigate(r);}}}),e.hasListenerAttached=!0);});}}class m{#e=[];static STOP_PROPAGATION="STOP_PROPAGATION";bindListener(e,t,i,r){this.#e=this.#e||[];const n=function(e,n,o){return i.call(t,e,n,o,r);};return this.#e[e]?this.#e[e].push(n)-1:(this.#e[e]=[n],0);}addListener(e,t,i={}){this.#e=this.#e||[];const r=function(e,r,n={}){return t({context:e,eventName:r,...n,...i});};return this.#e[e]?this.#e[e].push(r)-1:(this.#e[e]=[r],0);}removeListener(e,t){this.#e[e]&&this.#e[e][t]?delete this.#e[e][t]:console.log("trying to remove non-existent event handler, event = "+e+" handle = "+t);}destructor(){this.#e=null;}fireEvent(e,t){if(this.#e)for(let t in this.#e[e])if(this.#e[e].hasOwnProperty(t)&&this.#e[e][t](this,e,arguments[1])===m.STOP_PROPAGATION)break;}}var _="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function g(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.');}var y=function e(t,i,r){function n(s,a){if(!i[s]){if(!t[s]){if(!a&&g)return g(s);if(o)return o(s,!0);var l=new Error("Cannot find module '"+s+"'");throw l.code="MODULE_NOT_FOUND",l;}var c=i[s]={exports:{}};t[s][0].call(c.exports,function(e){return n(t[s][1][e]||e);},c,c.exports,e,t,i,r);}return i[s].exports;}for(var o=g,s=0;s<r.length;s++)n(r[s]);return n;}({1:[function(e,t,i){(function(e){var i,r,n=e.MutationObserver||e.WebKitMutationObserver;if(n){var o=0,s=new n(h),a=e.document.createTextNode("");s.observe(a,{characterData:!0}),i=function(){a.data=o=++o%2;};}else if(e.setImmediate||void 0===e.MessageChannel)i="document"in e&&"onreadystatechange"in e.document.createElement("script")?function(){var t=e.document.createElement("script");t.onreadystatechange=function(){h(),t.onreadystatechange=null,t.parentNode.removeChild(t),t=null;},e.document.documentElement.appendChild(t);}:function(){setTimeout(h,0);};else {var l=new e.MessageChannel();l.port1.onmessage=h,i=function(){l.port2.postMessage(0);};}var c=[];function h(){var e,t;r=!0;for(var i=c.length;i;){for(t=c,c=[],e=-1;++e<i;)t[e]();i=c.length;}r=!1;}t.exports=function(e){1!==c.push(e)||r||i();};}).call(this,void 0!==_?_:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{});},{}],2:[function(e,t,i){var r=e(1);function n(){}var o={},s=["REJECTED"],a=["FULFILLED"],l=["PENDING"];function c(e){if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=l,this.queue=[],this.outcome=void 0,e!==n&&p(this,e);}function h(e,t,i){this.promise=e,"function"==typeof t&&(this.onFulfilled=t,this.callFulfilled=this.otherCallFulfilled),"function"==typeof i&&(this.onRejected=i,this.callRejected=this.otherCallRejected);}function u(e,t,i){r(function(){var r;try{r=t(i);}catch(t){return o.reject(e,t);}r===e?o.reject(e,new TypeError("Cannot resolve promise with itself")):o.resolve(e,r);});}function d(e){var t=e&&e.then;if(e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof t)return function(){t.apply(e,arguments);};}function p(e,t){var i=!1;function r(t){i||(i=!0,o.reject(e,t));}function n(t){i||(i=!0,o.resolve(e,t));}var s=f(function(){t(n,r);});"error"===s.status&&r(s.value);}function f(e,t){var i={};try{i.value=e(t),i.status="success";}catch(e){i.status="error",i.value=e;}return i;}t.exports=c,c.prototype.catch=function(e){return this.then(null,e);},c.prototype.then=function(e,t){if("function"!=typeof e&&this.state===a||"function"!=typeof t&&this.state===s)return this;var i=new this.constructor(n);return this.state!==l?u(i,this.state===a?e:t,this.outcome):this.queue.push(new h(i,e,t)),i;},h.prototype.callFulfilled=function(e){o.resolve(this.promise,e);},h.prototype.otherCallFulfilled=function(e){u(this.promise,this.onFulfilled,e);},h.prototype.callRejected=function(e){o.reject(this.promise,e);},h.prototype.otherCallRejected=function(e){u(this.promise,this.onRejected,e);},o.resolve=function(e,t){var i=f(d,t);if("error"===i.status)return o.reject(e,i.value);var r=i.value;if(r)p(e,r);else {e.state=a,e.outcome=t;for(var n=-1,s=e.queue.length;++n<s;)e.queue[n].callFulfilled(t);}return e;},o.reject=function(e,t){e.state=s,e.outcome=t;for(var i=-1,r=e.queue.length;++i<r;)e.queue[i].callRejected(t);return e;},c.resolve=function(e){return e instanceof this?e:o.resolve(new this(n),e);},c.reject=function(e){var t=new this(n);return o.reject(t,e);},c.all=function(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var i=e.length,r=!1;if(!i)return this.resolve([]);for(var s=new Array(i),a=0,l=-1,c=new this(n);++l<i;)h(e[l],l);return c;function h(e,n){t.resolve(e).then(function(e){s[n]=e,++a!==i||r||(r=!0,o.resolve(c,s));},function(e){r||(r=!0,o.reject(c,e));});}},c.race=function(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var i=e.length,r=!1;if(!i)return this.resolve([]);for(var s=-1,a=new this(n);++s<i;)l(e[s]);return a;function l(e){t.resolve(e).then(function(e){r||(r=!0,o.resolve(a,e));},function(e){r||(r=!0,o.reject(a,e));});}};},{1:1}],3:[function(e,t,i){(function(t){"function"!=typeof t.Promise&&(t.Promise=e(2));}).call(this,void 0!==_?_:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{});},{2:2}],4:[function(e,t,i){var r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e;}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e;};var n=function(){try{if("undefined"!=typeof indexedDB)return indexedDB;if("undefined"!=typeof webkitIndexedDB)return webkitIndexedDB;if("undefined"!=typeof mozIndexedDB)return mozIndexedDB;if("undefined"!=typeof OIndexedDB)return OIndexedDB;if("undefined"!=typeof msIndexedDB)return msIndexedDB;}catch(e){return;}}();function o(e,t){e=e||[],t=t||{};try{return new Blob(e,t);}catch(n){if("TypeError"!==n.name)throw n;for(var i=new("undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder?MozBlobBuilder:WebKitBlobBuilder)(),r=0;r<e.length;r+=1)i.append(e[r]);return i.getBlob(t.type);}}"undefined"==typeof Promise&&e(3);var s=Promise;function a(e,t){t&&e.then(function(e){t(null,e);},function(e){t(e);});}function l(e,t,i){"function"==typeof t&&e.then(t),"function"==typeof i&&e.catch(i);}function c(e){return "string"!=typeof e&&(console.warn(e+" used as a key, but it is not a string."),e=String(e)),e;}function h(){if(arguments.length&&"function"==typeof arguments[arguments.length-1])return arguments[arguments.length-1];}var u="local-forage-detect-blob-support",d=void 0,p={},f=Object.prototype.toString,m="readonly",_="readwrite";function g(e){for(var t=e.length,i=new ArrayBuffer(t),r=new Uint8Array(i),n=0;n<t;n++)r[n]=e.charCodeAt(n);return i;}function y(e){return "boolean"==typeof d?s.resolve(d):function(e){return new s(function(t){var i=e.transaction(u,_),r=o([""]);i.objectStore(u).put(r,"key"),i.onabort=function(e){e.preventDefault(),e.stopPropagation(),t(!1);},i.oncomplete=function(){var e=navigator.userAgent.match(/Chrome\/(\d+)/),i=navigator.userAgent.match(/Edge\//);t(i||!e||parseInt(e[1],10)>=43);};}).catch(function(){return !1;});}(e).then(function(e){return d=e;});}function x(e){var t=p[e.name],i={};i.promise=new s(function(e,t){i.resolve=e,i.reject=t;}),t.deferredOperations.push(i),t.dbReady?t.dbReady=t.dbReady.then(function(){return i.promise;}):t.dbReady=i.promise;}function v(e){var t=p[e.name].deferredOperations.pop();if(t)return t.resolve(),t.promise;}function b(e,t){var i=p[e.name].deferredOperations.pop();if(i)return i.reject(t),i.promise;}function S(e,t){return new s(function(i,r){if(p[e.name]=p[e.name]||{forages:[],db:null,dbReady:null,deferredOperations:[]},e.db){if(!t)return i(e.db);x(e),e.db.close();}var o=[e.name];t&&o.push(e.version);var s=n.open.apply(n,o);t&&(s.onupgradeneeded=function(t){var i=s.result;try{i.createObjectStore(e.storeName),t.oldVersion<=1&&i.createObjectStore(u);}catch(i){if("ConstraintError"!==i.name)throw i;console.warn('The database "'+e.name+'" has been upgraded from version '+t.oldVersion+" to version "+t.newVersion+', but the storage "'+e.storeName+'" already exists.');}}),s.onerror=function(e){e.preventDefault(),r(s.error);},s.onsuccess=function(){var t=s.result;t.onversionchange=function(e){e.target.close();},i(t),v(e);};});}function w(e){return S(e,!1);}function T(e){return S(e,!0);}function E(e,t){if(!e.db)return !0;var i=!e.db.objectStoreNames.contains(e.storeName),r=e.version<e.db.version,n=e.version>e.db.version;if(r&&(e.version!==t&&console.warn('The database "'+e.name+"\" can't be downgraded from version "+e.db.version+" to version "+e.version+"."),e.version=e.db.version),n||i){if(i){var o=e.db.version+1;o>e.version&&(e.version=o);}return !0;}return !1;}function N(e){return o([g(atob(e.data))],{type:e.type});}function I(e){return e&&e.__local_forage_encoded_blob;}function M(e){var t=this,i=t._initReady().then(function(){var e=p[t._dbInfo.name];if(e&&e.dbReady)return e.dbReady;});return l(i,e,e),i;}function C(e,t,i,r){void 0===r&&(r=1);try{var n=e.db.transaction(e.storeName,t);i(null,n);}catch(n){if(r>0&&(!e.db||"InvalidStateError"===n.name||"NotFoundError"===n.name))return s.resolve().then(function(){if(!e.db||"NotFoundError"===n.name&&!e.db.objectStoreNames.contains(e.storeName)&&e.version<=e.db.version)return e.db&&(e.version=e.db.version+1),T(e);}).then(function(){return function(e){x(e);for(var t=p[e.name],i=t.forages,r=0;r<i.length;r++){var n=i[r];n._dbInfo.db&&(n._dbInfo.db.close(),n._dbInfo.db=null);}return e.db=null,w(e).then(function(t){return e.db=t,E(e)?T(e):t;}).then(function(r){e.db=t.db=r;for(var n=0;n<i.length;n++)i[n]._dbInfo.db=r;}).catch(function(t){throw b(e,t),t;});}(e).then(function(){C(e,t,i,r-1);});}).catch(i);i(n);}}var A={_driver:"asyncStorage",_initStorage:function(e){var t=this,i={db:null};if(e)for(var r in e)i[r]=e[r];var n=p[i.name];n||(n={forages:[],db:null,dbReady:null,deferredOperations:[]},p[i.name]=n),n.forages.push(t),t._initReady||(t._initReady=t.ready,t.ready=M);var o=[];function a(){return s.resolve();}for(var l=0;l<n.forages.length;l++){var c=n.forages[l];c!==t&&o.push(c._initReady().catch(a));}var h=n.forages.slice(0);return s.all(o).then(function(){return i.db=n.db,w(i);}).then(function(e){return i.db=e,E(i,t._defaultConfig.version)?T(i):e;}).then(function(e){i.db=n.db=e,t._dbInfo=i;for(var r=0;r<h.length;r++){var o=h[r];o!==t&&(o._dbInfo.db=i.db,o._dbInfo.version=i.version);}});},_support:function(){try{if(!n||!n.open)return !1;var e="undefined"!=typeof openDatabase&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),t="function"==typeof fetch&&-1!==fetch.toString().indexOf("[native code");return (!e||t)&&"undefined"!=typeof indexedDB&&"undefined"!=typeof IDBKeyRange;}catch(e){return !1;}}(),iterate:function(e,t){var i=this,r=new s(function(t,r){i.ready().then(function(){C(i._dbInfo,m,function(n,o){if(n)return r(n);try{var s=o.objectStore(i._dbInfo.storeName).openCursor(),a=1;s.onsuccess=function(){var i=s.result;if(i){var r=i.value;I(r)&&(r=N(r));var n=e(r,i.key,a++);void 0!==n?t(n):i.continue();}else t();},s.onerror=function(){r(s.error);};}catch(e){r(e);}});}).catch(r);});return a(r,t),r;},getItem:function(e,t){var i=this;e=c(e);var r=new s(function(t,r){i.ready().then(function(){C(i._dbInfo,m,function(n,o){if(n)return r(n);try{var s=o.objectStore(i._dbInfo.storeName).get(e);s.onsuccess=function(){var e=s.result;void 0===e&&(e=null),I(e)&&(e=N(e)),t(e);},s.onerror=function(){r(s.error);};}catch(e){r(e);}});}).catch(r);});return a(r,t),r;},setItem:function(e,t,i){var r=this;e=c(e);var n=new s(function(i,n){var o;r.ready().then(function(){return o=r._dbInfo,"[object Blob]"===f.call(t)?y(o.db).then(function(e){return e?t:function(e){return new s(function(t,i){var r=new FileReader();r.onerror=i,r.onloadend=function(i){var r=btoa(i.target.result||"");t({__local_forage_encoded_blob:!0,data:r,type:e.type});},r.readAsBinaryString(e);});}(t);}):t;}).then(function(t){C(r._dbInfo,_,function(o,s){if(o)return n(o);try{var a=s.objectStore(r._dbInfo.storeName);null===t&&(t=void 0);var l=a.put(t,e);s.oncomplete=function(){void 0===t&&(t=null),i(t);},s.onabort=s.onerror=function(){var e=l.error?l.error:l.transaction.error;n(e);};}catch(e){n(e);}});}).catch(n);});return a(n,i),n;},removeItem:function(e,t){var i=this;e=c(e);var r=new s(function(t,r){i.ready().then(function(){C(i._dbInfo,_,function(n,o){if(n)return r(n);try{var s=o.objectStore(i._dbInfo.storeName).delete(e);o.oncomplete=function(){t();},o.onerror=function(){r(s.error);},o.onabort=function(){var e=s.error?s.error:s.transaction.error;r(e);};}catch(e){r(e);}});}).catch(r);});return a(r,t),r;},clear:function(e){var t=this,i=new s(function(e,i){t.ready().then(function(){C(t._dbInfo,_,function(r,n){if(r)return i(r);try{var o=n.objectStore(t._dbInfo.storeName).clear();n.oncomplete=function(){e();},n.onabort=n.onerror=function(){var e=o.error?o.error:o.transaction.error;i(e);};}catch(e){i(e);}});}).catch(i);});return a(i,e),i;},length:function(e){var t=this,i=new s(function(e,i){t.ready().then(function(){C(t._dbInfo,m,function(r,n){if(r)return i(r);try{var o=n.objectStore(t._dbInfo.storeName).count();o.onsuccess=function(){e(o.result);},o.onerror=function(){i(o.error);};}catch(e){i(e);}});}).catch(i);});return a(i,e),i;},key:function(e,t){var i=this,r=new s(function(t,r){e<0?t(null):i.ready().then(function(){C(i._dbInfo,m,function(n,o){if(n)return r(n);try{var s=o.objectStore(i._dbInfo.storeName),a=!1,l=s.openKeyCursor();l.onsuccess=function(){var i=l.result;i?0===e||a?t(i.key):(a=!0,i.advance(e)):t(null);},l.onerror=function(){r(l.error);};}catch(e){r(e);}});}).catch(r);});return a(r,t),r;},keys:function(e){var t=this,i=new s(function(e,i){t.ready().then(function(){C(t._dbInfo,m,function(r,n){if(r)return i(r);try{var o=n.objectStore(t._dbInfo.storeName).openKeyCursor(),s=[];o.onsuccess=function(){var t=o.result;t?(s.push(t.key),t.continue()):e(s);},o.onerror=function(){i(o.error);};}catch(e){i(e);}});}).catch(i);});return a(i,e),i;},dropInstance:function(e,t){t=h.apply(this,arguments);var i=this.config();(e="function"!=typeof e&&e||{}).name||(e.name=e.name||i.name,e.storeName=e.storeName||i.storeName);var r,o=this;if(e.name){var l=e.name===i.name&&o._dbInfo.db?s.resolve(o._dbInfo.db):w(e).then(function(t){var i=p[e.name],r=i.forages;i.db=t;for(var n=0;n<r.length;n++)r[n]._dbInfo.db=t;return t;});r=e.storeName?l.then(function(t){if(t.objectStoreNames.contains(e.storeName)){var i=t.version+1;x(e);var r=p[e.name],o=r.forages;t.close();for(var a=0;a<o.length;a++){var l=o[a];l._dbInfo.db=null,l._dbInfo.version=i;}var c=new s(function(t,r){var o=n.open(e.name,i);o.onerror=function(e){o.result.close(),r(e);},o.onupgradeneeded=function(){o.result.deleteObjectStore(e.storeName);},o.onsuccess=function(){var e=o.result;e.close(),t(e);};});return c.then(function(e){r.db=e;for(var t=0;t<o.length;t++){var i=o[t];i._dbInfo.db=e,v(i._dbInfo);}}).catch(function(t){throw (b(e,t)||s.resolve()).catch(function(){}),t;});}}):l.then(function(t){x(e);var i=p[e.name],r=i.forages;t.close();for(var o=0;o<r.length;o++)r[o]._dbInfo.db=null;var a=new s(function(t,i){var r=n.deleteDatabase(e.name);r.onerror=function(){var e=r.result;e&&e.close(),i(r.error);},r.onblocked=function(){console.warn('dropInstance blocked for database "'+e.name+'" until all open connections are closed');},r.onsuccess=function(){var e=r.result;e&&e.close(),t(e);};});return a.then(function(e){i.db=e;for(var t=0;t<r.length;t++)v(r[t]._dbInfo);}).catch(function(t){throw (b(e,t)||s.resolve()).catch(function(){}),t;});});}else r=s.reject("Invalid arguments");return a(r,t),r;}};var P="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",L=/^~~local_forage_type~([^~]+)~/,D="__lfsc__:",k=D.length,z="arbf",R="blob",O="si08",F="ui08",B="uic8",U="si16",V="si32",G="ur16",j="ui32",$="fl32",H="fl64",q=k+z.length,Z=Object.prototype.toString;function X(e){var t,i,r,n,o,s=.75*e.length,a=e.length,l=0;"="===e[e.length-1]&&(s--,"="===e[e.length-2]&&s--);var c=new ArrayBuffer(s),h=new Uint8Array(c);for(t=0;t<a;t+=4)i=P.indexOf(e[t]),r=P.indexOf(e[t+1]),n=P.indexOf(e[t+2]),o=P.indexOf(e[t+3]),h[l++]=i<<2|r>>4,h[l++]=(15&r)<<4|n>>2,h[l++]=(3&n)<<6|63&o;return c;}function W(e){var t,i=new Uint8Array(e),r="";for(t=0;t<i.length;t+=3)r+=P[i[t]>>2],r+=P[(3&i[t])<<4|i[t+1]>>4],r+=P[(15&i[t+1])<<2|i[t+2]>>6],r+=P[63&i[t+2]];return i.length%3==2?r=r.substring(0,r.length-1)+"=":i.length%3==1&&(r=r.substring(0,r.length-2)+"=="),r;}var Y={serialize:function(e,t){var i="";if(e&&(i=Z.call(e)),e&&("[object ArrayBuffer]"===i||e.buffer&&"[object ArrayBuffer]"===Z.call(e.buffer))){var r,n=D;e instanceof ArrayBuffer?(r=e,n+=z):(r=e.buffer,"[object Int8Array]"===i?n+=O:"[object Uint8Array]"===i?n+=F:"[object Uint8ClampedArray]"===i?n+=B:"[object Int16Array]"===i?n+=U:"[object Uint16Array]"===i?n+=G:"[object Int32Array]"===i?n+=V:"[object Uint32Array]"===i?n+=j:"[object Float32Array]"===i?n+=$:"[object Float64Array]"===i?n+=H:t(new Error("Failed to get type for BinaryArray"))),t(n+W(r));}else if("[object Blob]"===i){var o=new FileReader();o.onload=function(){var i="~~local_forage_type~"+e.type+"~"+W(this.result);t(D+R+i);},o.readAsArrayBuffer(e);}else try{t(JSON.stringify(e));}catch(i){console.error("Couldn't convert value into a JSON string: ",e),t(null,i);}},deserialize:function(e){if(e.substring(0,k)!==D)return JSON.parse(e);var t,i=e.substring(q),r=e.substring(k,q);if(r===R&&L.test(i)){var n=i.match(L);t=n[1],i=i.substring(n[0].length);}var s=X(i);switch(r){case z:return s;case R:return o([s],{type:t});case O:return new Int8Array(s);case F:return new Uint8Array(s);case B:return new Uint8ClampedArray(s);case U:return new Int16Array(s);case G:return new Uint16Array(s);case V:return new Int32Array(s);case j:return new Uint32Array(s);case $:return new Float32Array(s);case H:return new Float64Array(s);default:throw new Error("Unkown type: "+r);}},stringToBuffer:X,bufferToString:W};function J(e,t,i,r){e.executeSql("CREATE TABLE IF NOT EXISTS "+t.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],i,r);}function K(e,t,i,r,n,o){e.executeSql(i,r,n,function(e,s){s.code===s.SYNTAX_ERR?e.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[t.storeName],function(e,a){a.rows.length?o(e,s):J(e,t,function(){e.executeSql(i,r,n,o);},o);},o):o(e,s);},o);}function Q(e,t,i,r){var n=this;e=c(e);var o=new s(function(o,s){n.ready().then(function(){void 0===t&&(t=null);var a=t,l=n._dbInfo;l.serializer.serialize(t,function(t,c){c?s(c):l.db.transaction(function(i){K(i,l,"INSERT OR REPLACE INTO "+l.storeName+" (key, value) VALUES (?, ?)",[e,t],function(){o(a);},function(e,t){s(t);});},function(t){if(t.code===t.QUOTA_ERR){if(r>0)return void o(Q.apply(n,[e,a,i,r-1]));s(t);}});});}).catch(s);});return a(o,i),o;}function ee(e){return new s(function(t,i){e.transaction(function(r){r.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],function(i,r){for(var n=[],o=0;o<r.rows.length;o++)n.push(r.rows.item(o).name);t({db:e,storeNames:n});},function(e,t){i(t);});},function(e){i(e);});});}var te={_driver:"webSQLStorage",_initStorage:function(e){var t=this,i={db:null};if(e)for(var r in e)i[r]="string"!=typeof e[r]?e[r].toString():e[r];var n=new s(function(e,r){try{i.db=openDatabase(i.name,String(i.version),i.description,i.size);}catch(e){return r(e);}i.db.transaction(function(n){J(n,i,function(){t._dbInfo=i,e();},function(e,t){r(t);});},r);});return i.serializer=Y,n;},_support:"function"==typeof openDatabase,iterate:function(e,t){var i=this,r=new s(function(t,r){i.ready().then(function(){var n=i._dbInfo;n.db.transaction(function(i){K(i,n,"SELECT * FROM "+n.storeName,[],function(i,r){for(var o=r.rows,s=o.length,a=0;a<s;a++){var l=o.item(a),c=l.value;if(c&&(c=n.serializer.deserialize(c)),void 0!==(c=e(c,l.key,a+1)))return void t(c);}t();},function(e,t){r(t);});});}).catch(r);});return a(r,t),r;},getItem:function(e,t){var i=this;e=c(e);var r=new s(function(t,r){i.ready().then(function(){var n=i._dbInfo;n.db.transaction(function(i){K(i,n,"SELECT * FROM "+n.storeName+" WHERE key = ? LIMIT 1",[e],function(e,i){var r=i.rows.length?i.rows.item(0).value:null;r&&(r=n.serializer.deserialize(r)),t(r);},function(e,t){r(t);});});}).catch(r);});return a(r,t),r;},setItem:function(e,t,i){return Q.apply(this,[e,t,i,1]);},removeItem:function(e,t){var i=this;e=c(e);var r=new s(function(t,r){i.ready().then(function(){var n=i._dbInfo;n.db.transaction(function(i){K(i,n,"DELETE FROM "+n.storeName+" WHERE key = ?",[e],function(){t();},function(e,t){r(t);});});}).catch(r);});return a(r,t),r;},clear:function(e){var t=this,i=new s(function(e,i){t.ready().then(function(){var r=t._dbInfo;r.db.transaction(function(t){K(t,r,"DELETE FROM "+r.storeName,[],function(){e();},function(e,t){i(t);});});}).catch(i);});return a(i,e),i;},length:function(e){var t=this,i=new s(function(e,i){t.ready().then(function(){var r=t._dbInfo;r.db.transaction(function(t){K(t,r,"SELECT COUNT(key) as c FROM "+r.storeName,[],function(t,i){var r=i.rows.item(0).c;e(r);},function(e,t){i(t);});});}).catch(i);});return a(i,e),i;},key:function(e,t){var i=this,r=new s(function(t,r){i.ready().then(function(){var n=i._dbInfo;n.db.transaction(function(i){K(i,n,"SELECT key FROM "+n.storeName+" WHERE id = ? LIMIT 1",[e+1],function(e,i){var r=i.rows.length?i.rows.item(0).key:null;t(r);},function(e,t){r(t);});});}).catch(r);});return a(r,t),r;},keys:function(e){var t=this,i=new s(function(e,i){t.ready().then(function(){var r=t._dbInfo;r.db.transaction(function(t){K(t,r,"SELECT key FROM "+r.storeName,[],function(t,i){for(var r=[],n=0;n<i.rows.length;n++)r.push(i.rows.item(n).key);e(r);},function(e,t){i(t);});});}).catch(i);});return a(i,e),i;},dropInstance:function(e,t){t=h.apply(this,arguments);var i=this.config();(e="function"!=typeof e&&e||{}).name||(e.name=e.name||i.name,e.storeName=e.storeName||i.storeName);var r,n=this;return a(r=e.name?new s(function(t){var r;r=e.name===i.name?n._dbInfo.db:openDatabase(e.name,"","",0),e.storeName?t({db:r,storeNames:[e.storeName]}):t(ee(r));}).then(function(e){return new s(function(t,i){e.db.transaction(function(r){function n(e){return new s(function(t,i){r.executeSql("DROP TABLE IF EXISTS "+e,[],function(){t();},function(e,t){i(t);});});}for(var o=[],a=0,l=e.storeNames.length;a<l;a++)o.push(n(e.storeNames[a]));s.all(o).then(function(){t();}).catch(function(e){i(e);});},function(e){i(e);});});}):s.reject("Invalid arguments"),t),r;}};function ie(e,t){var i=e.name+"/";return e.storeName!==t.storeName&&(i+=e.storeName+"/"),i;}function re(){return !function(){var e="_localforage_support_test";try{return localStorage.setItem(e,!0),localStorage.removeItem(e),!1;}catch(e){return !0;}}()||localStorage.length>0;}var ne={_driver:"localStorageWrapper",_initStorage:function(e){var t={};if(e)for(var i in e)t[i]=e[i];return t.keyPrefix=ie(e,this._defaultConfig),re()?(this._dbInfo=t,t.serializer=Y,s.resolve()):s.reject();},_support:function(){try{return "undefined"!=typeof localStorage&&"setItem"in localStorage&&!!localStorage.setItem;}catch(e){return !1;}}(),iterate:function(e,t){var i=this,r=i.ready().then(function(){for(var t=i._dbInfo,r=t.keyPrefix,n=r.length,o=localStorage.length,s=1,a=0;a<o;a++){var l=localStorage.key(a);if(0===l.indexOf(r)){var c=localStorage.getItem(l);if(c&&(c=t.serializer.deserialize(c)),void 0!==(c=e(c,l.substring(n),s++)))return c;}}});return a(r,t),r;},getItem:function(e,t){var i=this;e=c(e);var r=i.ready().then(function(){var t=i._dbInfo,r=localStorage.getItem(t.keyPrefix+e);return r&&(r=t.serializer.deserialize(r)),r;});return a(r,t),r;},setItem:function(e,t,i){var r=this;e=c(e);var n=r.ready().then(function(){void 0===t&&(t=null);var i=t;return new s(function(n,o){var s=r._dbInfo;s.serializer.serialize(t,function(t,r){if(r)o(r);else try{localStorage.setItem(s.keyPrefix+e,t),n(i);}catch(e){"QuotaExceededError"!==e.name&&"NS_ERROR_DOM_QUOTA_REACHED"!==e.name||o(e),o(e);}});});});return a(n,i),n;},removeItem:function(e,t){var i=this;e=c(e);var r=i.ready().then(function(){var t=i._dbInfo;localStorage.removeItem(t.keyPrefix+e);});return a(r,t),r;},clear:function(e){var t=this,i=t.ready().then(function(){for(var e=t._dbInfo.keyPrefix,i=localStorage.length-1;i>=0;i--){var r=localStorage.key(i);0===r.indexOf(e)&&localStorage.removeItem(r);}});return a(i,e),i;},length:function(e){var t=this.keys().then(function(e){return e.length;});return a(t,e),t;},key:function(e,t){var i=this,r=i.ready().then(function(){var t,r=i._dbInfo;try{t=localStorage.key(e);}catch(e){t=null;}return t&&(t=t.substring(r.keyPrefix.length)),t;});return a(r,t),r;},keys:function(e){var t=this,i=t.ready().then(function(){for(var e=t._dbInfo,i=localStorage.length,r=[],n=0;n<i;n++){var o=localStorage.key(n);0===o.indexOf(e.keyPrefix)&&r.push(o.substring(e.keyPrefix.length));}return r;});return a(i,e),i;},dropInstance:function(e,t){if(t=h.apply(this,arguments),!(e="function"!=typeof e&&e||{}).name){var i=this.config();e.name=e.name||i.name,e.storeName=e.storeName||i.storeName;}var r,n=this;return r=e.name?new s(function(t){e.storeName?t(ie(e,n._defaultConfig)):t(e.name+"/");}).then(function(e){for(var t=localStorage.length-1;t>=0;t--){var i=localStorage.key(t);0===i.indexOf(e)&&localStorage.removeItem(i);}}):s.reject("Invalid arguments"),a(r,t),r;}},oe=function(e,t){return e===t||"number"==typeof e&&"number"==typeof t&&isNaN(e)&&isNaN(t);},se=function(e,t){for(var i=e.length,r=0;r<i;){if(oe(e[r],t))return !0;r++;}return !1;},ae=Array.isArray||function(e){return "[object Array]"===Object.prototype.toString.call(e);},le={},ce={},he={INDEXEDDB:A,WEBSQL:te,LOCALSTORAGE:ne},ue=[he.INDEXEDDB._driver,he.WEBSQL._driver,he.LOCALSTORAGE._driver],de=["dropInstance"],pe=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(de),fe={description:"",driver:ue.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function me(e,t){e[t]=function(){var i=arguments;return e.ready().then(function(){return e[t].apply(e,i);});};}function _e(){for(var e=1;e<arguments.length;e++){var t=arguments[e];if(t)for(var i in t)t.hasOwnProperty(i)&&(ae(t[i])?arguments[0][i]=t[i].slice():arguments[0][i]=t[i]);}return arguments[0];}var ge=function(){function e(t){for(var i in function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function");}(this,e),he)if(he.hasOwnProperty(i)){var r=he[i],n=r._driver;this[i]=n,le[n]||this.defineDriver(r);}this._defaultConfig=_e({},fe),this._config=_e({},this._defaultConfig,t),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch(function(){});}return e.prototype.config=function(e){if("object"===(void 0===e?"undefined":r(e))){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var t in e){if("storeName"===t&&(e[t]=e[t].replace(/\W/g,"_")),"version"===t&&"number"!=typeof e[t])return new Error("Database version must be a number.");this._config[t]=e[t];}return !("driver"in e)||!e.driver||this.setDriver(this._config.driver);}return "string"==typeof e?this._config[e]:this._config;},e.prototype.defineDriver=function(e,t,i){var r=new s(function(t,i){try{var r=e._driver,n=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!e._driver)return void i(n);for(var o=pe.concat("_initStorage"),l=0,c=o.length;l<c;l++){var h=o[l];if((!se(de,h)||e[h])&&"function"!=typeof e[h])return void i(n);}!function(){for(var t=function(e){return function(){var t=new Error("Method "+e+" is not implemented by the current driver"),i=s.reject(t);return a(i,arguments[arguments.length-1]),i;};},i=0,r=de.length;i<r;i++){var n=de[i];e[n]||(e[n]=t(n));}}();var u=function(i){le[r]&&console.info("Redefining LocalForage driver: "+r),le[r]=e,ce[r]=i,t();};"_support"in e?e._support&&"function"==typeof e._support?e._support().then(u,i):u(!!e._support):u(!0);}catch(e){i(e);}});return l(r,t,i),r;},e.prototype.driver=function(){return this._driver||null;},e.prototype.getDriver=function(e,t,i){var r=le[e]?s.resolve(le[e]):s.reject(new Error("Driver not found."));return l(r,t,i),r;},e.prototype.getSerializer=function(e){var t=s.resolve(Y);return l(t,e),t;},e.prototype.ready=function(e){var t=this,i=t._driverSet.then(function(){return null===t._ready&&(t._ready=t._initDriver()),t._ready;});return l(i,e,e),i;},e.prototype.setDriver=function(e,t,i){var r=this;ae(e)||(e=[e]);var n=this._getSupportedDrivers(e);function o(){r._config.driver=r.driver();}function a(e){return r._extend(e),o(),r._ready=r._initStorage(r._config),r._ready;}var c=null!==this._driverSet?this._driverSet.catch(function(){return s.resolve();}):s.resolve();return this._driverSet=c.then(function(){var e=n[0];return r._dbInfo=null,r._ready=null,r.getDriver(e).then(function(e){r._driver=e._driver,o(),r._wrapLibraryMethodsWithReady(),r._initDriver=function(e){return function(){var t=0;return function i(){for(;t<e.length;){var n=e[t];return t++,r._dbInfo=null,r._ready=null,r.getDriver(n).then(a).catch(i);}o();var l=new Error("No available storage method found.");return r._driverSet=s.reject(l),r._driverSet;}();};}(n);});}).catch(function(){o();var e=new Error("No available storage method found.");return r._driverSet=s.reject(e),r._driverSet;}),l(this._driverSet,t,i),this._driverSet;},e.prototype.supports=function(e){return !!ce[e];},e.prototype._extend=function(e){_e(this,e);},e.prototype._getSupportedDrivers=function(e){for(var t=[],i=0,r=e.length;i<r;i++){var n=e[i];this.supports(n)&&t.push(n);}return t;},e.prototype._wrapLibraryMethodsWithReady=function(){for(var e=0,t=pe.length;e<t;e++)me(this,pe[e]);},e.prototype.createInstance=function(t){return new e(t);},e;}(),ye=new ge();t.exports=ye;},{3:3}]},{},[4])(4);/*!
      localForage -- Offline Storage, Improved
      Version 1.10.0
      https://localforage.github.io/localForage
      (c) 2013-2017 Mozilla, Apache License 2.0
  */function x(e){return e?(e^16*Math.random()>>e/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,x);}class v extends m{_id;_savedRemotely=!1;static EVENT_SAVED_REMOTELY="savedremotely";set savedRemotely(e){this._savedRemotely!==e&&(this._savedRemotely=!!e,this._savedRemotely&&this.fireEvent(v.EVENT_SAVED_REMOTELY,{id:this.id}));}_savedLocally=!1;deleted=!1;createdStamp;modifiedStamp;projectId;isPristine=!1;constructor(){super(),this.createdStamp=Math.floor(Date.now()/1e3);}unsaved(){return !(this._savedLocally&&this._savedRemotely);}get id(){return this._id?"undefined"===this._id&&(console.error("id is literal 'undefined', am forcing new id"),this._id=x()):this._id=x(),this._id;}set id(e){if(this._id&&e!==this._id)throw new Error(`Occurrence id has already been set, when trying to set new id '${e}'.`);this._id=e;}static _tasks=[];queuePost(e){return new Promise((t,i)=>{const r=()=>(console.log({"posting form data":e}),this.post(e).then(t,i));v._tasks.push(r),v._tasks.length>1?console.log("Added post request to the queue."):(console.log("No pending tasks, starting post request immediately."),r().finally(v._next));});}static _next(){if(v._tasks.shift(),v._tasks.length)return console.log("Running the next task."),v._tasks[0]().finally(v._next);}post(e){return fetch(this.SAVE_ENDPOINT,{method:"POST",body:e}).then(e=>e.ok?e.clone().json().then(t=>{switch(console.log({"returned to client after save":t}),t.saveState){case"SAVED_TO_SERVER":this._savedLocally=!0,this.savedRemotely=!0;break;case"SAVED_LOCALLY":this._savedLocally=!0,this.savedRemotely=!1;break;default:console.log(`Unrecognised save state '${t.saveState}'`);}return this.createdStamp=parseInt(t.created,10),this.modifiedStamp=parseInt(t.modified,10),e.json();}):(console.log("Save failed, presumably service worker is missing and there is no network connection. Should write to IndexedDb here."),Promise.reject("IndexedDb storage not yet implemented")));}static retrieveFromLocal(e,t){return y.getItem(`${t.TYPE}.${e}`).then(i=>i?(t.id=e,t._parseDescriptor(i),t):Promise.reject(`Failed to retrieve ${t.TYPE}.${e} locally`));}_parseDescriptor(e){this._parseAttributes(e.attributes),this._parseSavedState(e.saveState),this.deleted=!0===e.deleted||"true"===e.deleted,this.createdStamp=parseInt(e.created,10),this.modifiedStamp=e.modified?parseInt(e.modified,10):0,this.projectId=parseInt(e.projectId,10);}_parseAttributes(e){"string"==typeof e&&(e=JSON.parse(e)),Array.isArray(e)?(console.log("Attributes were spuriously represented as an array rather than as an empty object"),this.attributes={}):this.attributes=e;}_parseSavedState(e){switch(e){case"SAVED_LOCALLY":this.savedRemotely=!1,this._savedLocally=!0;break;case"SAVED_TO_SERVER":this.savedRemotely=!0,this._savedLocally=!0;break;default:throw new Error(`Unrecognised saved state '${e}`);}}touch(){this.modifiedStamp=Math.floor(Date.now()/1e3),this.isPristine&&(this.isPristine=!1,this.createdStamp=this.modifiedStamp),this._savedLocally=!1,this.savedRemotely=!1;}evaluateCompletionStatus(e){const t={};let i=!0;for(let r in e)if(e.hasOwnProperty(r)){let n=e[r];t[r]=n.validator?n.validator(r,n,this.attributes):n.field.isValid(r,n,this.attributes),null!==t[r]&&(i=i&&t[r]);}return {requiredFieldsPresent:i,validity:t};}}class b extends Error{}function S(e){try{const t=document.createElement("textarea");return t.innerHTML=e,t.innerHTML.replace(/"/g,"&quot;");}catch(t){const i=document.createElement("pre");return i.appendChild(document.createTextNode(e)),i.innerHTML.replace(/"/g,"&quot;");}}class w{static rawTaxa;id;nameString="";canonical="";hybridCanonical="";acceptedEntityId="";qualifier="";authority="";vernacular="";vernacularRoot="";used;sortOrder;parentIds=[];static showVernacular=!0;static fromId(e){if(!w.rawTaxa){if(!BsbiDb.TaxonNames)throw new b("Taxon.fromId() called before taxon list has loaded.");w.rawTaxa=BsbiDb.TaxonNames;}if(!w.rawTaxa.hasOwnProperty(e))throw new b(`Taxon id '${e}' not found.`);const t=w.rawTaxa[e],i=new w();return i.id=e,i.nameString=t[0],i.canonical=t[1]||t[0],i.hybridCanonical=t[2]||i.canonical,i.acceptedEntityId=t[3]||e,i.qualifier=t[4],i.authority=t[5],i.vernacular=t[6],i.vernacularRoot=t[7],i.used=t[8],i.sortOrder=t[9],i.parentIds=t[10],i;}formattedHTML(e){let t;return this.id!==this.acceptedEntityId&&(t=w.fromId(this.acceptedEntityId)),e?t?`<q class="taxon-vernacular">${S(this.vernacular)}</q><wbr> <span class="italictaxon">${this.nameString}${this.qualifier?` <span class="taxon-qualifier">${this.qualifier}</span>`:""}</span> <span class="taxauthority">${S(this.authority)}</span> = <span class="italictaxon">${t.nameString}${t.qualifier?` <span class="taxon-qualifier">${t.qualifier}</span>`:""}</span> <span class="taxauthority">${S(t.authority)}</span>`:`<q class="taxon-vernacular">${S(this.vernacular)}</q><wbr> <span class="italictaxon">${this.nameString}${this.qualifier?` <span class="taxon-qualifier">${this.qualifier}</span>`:""}</span> <span class="taxauthority">${S(this.authority)}</span>`:t?`<span class="italictaxon">${this.nameString}${this.qualifier?` <span class="taxon-qualifier">${this.qualifier}</span>`:""}</span> <span class="taxauthority">${this.authority}</span>${this.vernacular?` <wbr><q class="taxon-vernacular">${S(this.vernacular)}</q>`:""} = <span class="italictaxon">${t.nameString}${t.qualifier?` <span class="taxon-qualifier">${t.qualifier}</span>`:""}</span> <span class="taxauthority">${S(t.authority)}</span>`:`<span class="italictaxon">${this.nameString}${this.qualifier?` <span class="taxon-qualifier">${this.qualifier}</span>`:""}</span> <span class="taxauthority">${S(this.authority)}</span>${this.vernacular?` <wbr><q class="taxon-vernacular">${S(this.vernacular)}</q>`:""}`;}}class T extends v{attributes={};SAVE_ENDPOINT="/saveoccurrence.php";TYPE="occurrence";static EVENT_MODIFIED="modified";isNew=!1;get taxon(){return this.attributes.taxon&&this.attributes.taxon.taxonId?w.fromId(this.attributes.taxon.taxonId):null;}formChangedHandler(e){console.log("Occurrence change handler invoked."),e.form.updateModelFromContent(),e.form.conditionallyValidateForm(),this.touch(),this.fireEvent(T.EVENT_MODIFIED,{occurrenceId:this.id});}delete(){this.deleted||(this.touch(),this.deleted=!0,this.fireEvent(T.EVENT_MODIFIED,{occurrenceId:this.id}));}save(e){if(this._savedRemotely)return Promise.reject(`${this.id} has already been saved.`);{const t=new FormData();return !e&&this.surveyId&&(e=this.surveyId),t.append("type",this.TYPE),t.append("surveyId",e),t.append("occurrenceId",this.id),t.append("id",this.id),t.append("projectId",this.projectId.toString()),t.append("attributes",JSON.stringify(this.attributes)),t.append("deleted",this.deleted.toString()),t.append("created",this.createdStamp.toString()),console.log("queueing occurrence post"),this.queuePost(t);}}_parseDescriptor(e){super._parseDescriptor(e),this.surveyId=e.surveyId;}}class E extends Error{}class N extends v{static EVENT_MODIFIED="modified";SAVE_ENDPOINT="/savesurvey.php";TYPE="survey";attributes={};isNew=!1;hasAppModifiedListener=!1;get geoReference(){return this.attributes.georef||{gridRef:"",rawString:"",source:"unknown",latLng:null,precision:null};}get date(){return this.attributes.date||"";}get place(){return this.attributes.place||"";}formChangedHandler(e){console.log("Survey change handler invoked."),e.form.updateModelFromContent(),console.log("Survey calling conditional validation."),e.form.conditionallyValidateForm(),this.touch(),this.fireEvent(N.EVENT_MODIFIED,{surveyId:this.id});}setAttribute(e,t){this.attributes[e]!==t&&(this.attributes[e]=t,this.touch(),this.fireEvent(N.EVENT_MODIFIED,{surveyId:this.id}));}save(){if(this._savedRemotely)return Promise.reject(`${this.id} has already been saved.`);{const e=new FormData();return e.append("type",this.TYPE),e.append("surveyId",this.id),e.append("id",this.id),e.append("projectId",this.projectId.toString()),e.append("attributes",JSON.stringify(this.attributes)),e.append("deleted",this.deleted.toString()),e.append("created",this.createdStamp.toString()),console.log("queueing survey post"),this.queuePost(e);}}generateSurveyName(){let e=(this.attributes.place||this.attributes.georef&&this.attributes.georef.gridRef||"(unlocalised)").trim();const t=this.date;let i;if(t)i=t;else {const e=new Date(1e3*this.createdStamp);try{i=e.toLocaleString("default",{year:"numeric",month:"long",day:"numeric"});}catch(t){i=e.toLocaleString("en-GB",{year:"numeric",month:"long",day:"numeric"});}}return `${S(e)} ${i}`;}}class I extends v{file;static imageCache=new Map();TYPE="image";getUrl(){}SAVE_ENDPOINT="/saveimage.php";static fromFile(e){const t=new I();return t.file=e,t;}save(e,t,i){if(this._savedRemotely)return Promise.reject(`${this.id} has already been saved.`);{const r=new FormData();return r.append("type",this.TYPE),r.append("surveyId",e||""),r.append("occurrenceId",t||this.occurrenceId),r.append("projectId",i?i.toString():""),r.append("imageId",this.id),r.append("id",this.id),r.append("image",this.file),r.append("deleted",this.deleted.toString()),console.log(`queueing image post, image id ${this.id}`),this.queuePost(r);}}static EVENT_MODIFIED="modified";static placeholder(e){let t=new I();return t._id=e,I.imageCache.set(e,t),t;}_parseDescriptor(e){super._parseDescriptor(e),this.surveyId=e.surveyId,this.occurrenceId=e.occurrenceId,this.file=e.image;}static imageLink(e,t,i,r){t=t||0,i=i||0;let n="";return r.className&&(n+=` class="${r.className}"`),`<picture><source srcset="/image.php?imageid=${e}&amp;height=128&amp;format=webp" type="image/webp"><img${n} src="/image.php?imageid=${e}&amp;width=${t}&amp;height=${i}&amp;format=jpeg" ${t>i?`width="${t}"`:`height="${i}"`} alt="photo"></picture>`;}}class M extends m{#t;#i;controllers=[];currentControllerHandle=!1;routeHistory=[];occurrences;surveys;_currentSurvey=null;set currentSurvey(e){if(this._currentSurvey!==e){this._currentSurvey=e||null;let t=e?e.id:null;y.setItem(M.CURRENT_SURVEY_KEY_NAME,t);}}get currentSurvey(){return this._currentSurvey;}getLastSurveyId(){return y.getItem(M.CURRENT_SURVEY_KEY_NAME).catch(e=>(console.log({"Error retrieving last survey id":e}),Promise.resolve(null)));}layout;static EVENT_ADD_SURVEY_USER_REQUEST="useraddsurveyrequest";static EVENT_RESET_SURVEYS="userresetsurveys";static EVENT_NEW_SURVEY="newsurvey";static LOAD_SURVEYS_ENDPOINT="/loadsurveys.php";static EVENT_OCCURRENCE_ADDED="occurrenceadded";static EVENT_SURVEYS_CHANGED="surveyschanged";static EVENT_ALL_SYNCED_TO_SERVER="allsyncedtoserver";static EVENT_SYNC_ALL_FAILED="syncallfailed";static CURRENT_SURVEY_KEY_NAME="currentsurvey";static devMode=!1;constructor(){super(),this.reset();}setLocalForageName(e){y.config({name:e});}reset(){this.surveys=new Map(),this.clearCurrentSurvey();}clearCurrentSurvey(){this.occurrences=new Map(),this.currentSurvey=null;}set router(e){this.#t=e;}get router(){return this.#t;}set containerId(e){const t=document.getElementById(e);if(!t)throw new Error(`App container '${e}' not found.`);this.#i=t;}get container(){return this.#i;}registerController(e){e.handle=this.controllers.length,this.controllers[this.controllers.length]=e,e.app=this,e.registerRoute(this.#t);}initialise(){this.layout.initialise(),this.#t.notFound(e=>{console.log(`no route found for '${e}'`),this.notFoundView();}),this.#t.on(()=>{console.log("redirecting from '/' to '/list'"),this.#t.pause(),this.currentSurvey&&this.currentSurvey.isPristine?this.#t.navigate("/list/survey/welcome").resume():this.#t.navigate("/list").resume(),this.#t.resolve();});for(let e of this.controllers)e.initialise();}display(){console.log("App display"),this.#t.resolve(),this.syncAll();}saveRoute(){const e=this.#t.lastRouteResolved();this.routeHistory.length?this.routeHistory[this.routeHistory.length-1]!==e&&(this.routeHistory[this.routeHistory.length]=e):this.routeHistory[0]=e;}markAllNotPristine(){for(let e of this.occurrences)e[1].isPristine=!1;}setLayout(e){this.layout=e,e.setApp(this);}addSurvey(e){if(e.projectId!==this.projectId)throw new Error(`Survey project id '${e.projectId} does not match with current project ('${this.projectId}')`);e.hasAppModifiedListener||(e.hasAppModifiedListener=!0,console.log("setting survey's modified/save handler"),e.addListener(N.EVENT_MODIFIED,()=>(this.fireEvent(M.EVENT_SURVEYS_CHANGED),e.save()))),this.surveys.set(e.id,e),this.fireEvent(M.EVENT_SURVEYS_CHANGED);}haveExtantOccurrences(){for(let e of this.occurrences)if(!e.deleted)return !0;return !1;}addOccurrence(e){if(!e.surveyId)throw new E("Survey id must set prior to registering occurrence.");0===this.occurrences.size&&(this.surveys.get(e.surveyId).createdStamp=e.createdStamp),console.log(`in addOccurrence setting id '${e.id}'`),this.occurrences.set(e.id,e),e.addListener(T.EVENT_MODIFIED,()=>{const t=this.surveys.get(e.surveyId);if(!t)throw new Error(`Failed to look up survey id ${e.surveyId}`);t.isPristine=!1,t.unsaved()&&t.save(),e.save(t.id);});}refreshFromServer(e){console.log({"Refresh from server, ids":e});const t=new FormData();let i=0;for(let r of e)r&&"undefined"!==r&&t.append(`surveyId[${i++}]`,r);return fetch(M.LOAD_SURVEYS_ENDPOINT,{method:"POST",body:t}).then(e=>e.ok?e.json():Promise.reject("Invalid response from server when refreshing survey ids")).then(e=>{console.log({"refresh from server json response":e});const t=[];for(let i in e)if(e.hasOwnProperty(i))for(let r of e[i])t.push(this._conditionallyReplaceObject(r));return Promise.all(t);});}_conditionallyReplaceObject(e){const t=`${e.type}.${e.id}`;return y.getItem(t).then(i=>i&&!e.deleted&&i.modified>=e.modified?(console.log(`Local copy of ${t} is the same or newer than the server copy. (${i.modified} >= ${e.modified}) `),Promise.resolve()):(console.log(`Adding or replacing local copy of ${t}`),y.setItem(t,e)));}seekKeys(e){return console.log("starting seekKeys"),y.keys().then(t=>{console.log({"in seekKeys: local forage keys":t});for(let i of t)if(i!==M.CURRENT_SURVEY_KEY_NAME){let t,r;[t,r]=i.split(".",2),e.hasOwnProperty(t)?e[t].includes(r)||e[t].push(r):console.log(`Unrecognised stored key type '${t}.`);}return e;});}syncAll(){return this.seekKeys({survey:[],occurrence:[],image:[]}).then(e=>this._syncLocalUnsaved(e).then(e=>(this.fireEvent(M.EVENT_ALL_SYNCED_TO_SERVER),e)),e=>(console.log(`Failed to sync all: ${e}`),this.fireEvent(M.EVENT_SYNC_ALL_FAILED),!1));}_syncLocalUnsaved(e){const t=[];for(let i of e.survey)t.push(N.retrieveFromLocal(i,new N()).then(e=>{if(e.unsaved())return e.save();}));for(let i of e.occurrence)t.push(T.retrieveFromLocal(i,new T()).then(e=>{if(e.unsaved())return e.save();}));for(let i of e.image)t.push(I.retrieveFromLocal(i,new I()).then(e=>{if(e.unsaved())return e.save();}));return Promise.all(t).catch(e=>(console.log(`Save failure: ${e}`),Promise.reject(e)));}restoreOccurrences(e=""){return console.log(`Invoked restoreOccurrences, target survey id: ${e}`),"undefined"===e&&(console.error("Attempt to restore occurrences for literal 'undefined' survey id."),e=""),e?this._restoreOccurrenceImp(e):this.getLastSurveyId().then(e=>(console.log(`Retrieved last used survey id '${e}'`),this._restoreOccurrenceImp(e).catch(()=>(console.log(`Failed to retrieve lastSurveyId ${e}. Resetting current survey and retrying.`),this.currentSurvey=null,this._restoreOccurrenceImp()))),()=>this._restoreOccurrenceImp());}_restoreOccurrenceImp(e){if(e&&this.surveys.has(e)){const t=this.surveys.get(e);if(t.isPristine)return this.clearCurrentSurvey(),this.currentSurvey=t,this.fireEvent(M.EVENT_SURVEYS_CHANGED),Promise.resolve();}const t={survey:[],occurrence:[],image:[]};return e&&(t.survey[0]=e),this.seekKeys(t).then(e=>e.survey.length?this.refreshFromServer(e.survey).finally(()=>this.seekKeys(e)):null).finally(()=>{if(console.log({storedObjectKeys:t}),t&&t.survey&&t.survey.length){const i=[];let r=0;for(let n of t.survey)i.push(this._restoreSurveyFromLocal(n,t,e===n||!e&&0==r++));return Promise.all(i).finally(()=>this.currentSurvey?(this.currentSurvey.deleted?this.setNewSurvey():this.fireEvent(M.EVENT_SURVEYS_CHANGED),Promise.resolve()):(console.log(`Failed to retrieve survey id '${e}'`),Promise.reject(new Error(`Failed to retrieve survey id '${e}'`))));}return console.log("no pre-existing surveys, so creating a new one"),this.setNewSurvey(),Promise.resolve();});}setNewSurvey(){this.currentSurvey=new N(),this.currentSurvey.projectId=this.projectId,this.currentSurvey.isPristine=!0,this.currentSurvey.isNew=!0,this.fireEvent(M.EVENT_NEW_SURVEY),this.addSurvey(this.currentSurvey);}addNewOccurrence(){const e=new T();return e.surveyId=this.currentSurvey.id,e.projectId=this.projectId,e.isNew=!0,e.isPristine=!0,this.addOccurrence(e),this.fireEvent(M.EVENT_OCCURRENCE_ADDED,{occurrenceId:e.id,surveyId:e.surveyId}),e;}_restoreSurveyFromLocal(e,t,i){let r=N.retrieveFromLocal(e,new N()).then(r=>{if(console.log(`retrieving local survey ${e}`),i){this.clearCurrentSurvey(),this.addSurvey(r);const i=[];for(let r of t.occurrence)i.push(T.retrieveFromLocal(r,new T()).then(t=>{t.surveyId===e&&(console.log(`adding occurrence ${r}`),this.addOccurrence(t));}));return Promise.all(i);}this.addSurvey(r);});return i&&r.finally(()=>{const i=[];for(let r of t.image)i.push(I.retrieveFromLocal(r,new I()).then(t=>{console.log(`restoring image id '${r}'`),t.surveyId===e&&I.imageCache.set(r,t);},e=>{console.log(`Failed to retrieve an image: ${e}`);}));return this.currentSurvey=this.surveys.get(t.survey[0]),Promise.all(i);}),r;}clearLocalForage(){return y.clear();}}function C(e,t,i){if(i.length>2){const r=i.pop();return `${i.join(e+" ")} ${t} ${r}`;}return i.join(` ${t} `);}class A{minimumRankSort=null;requireExtantDDbRecords=!1;skipJunk=!0;static showVernacular=!0;static MIN_SEARCH_LENGTH=2;static MAXIMUM_RESULTS=25;constructor(){if(!w.rawTaxa&&(w.rawTaxa=BsbiDb.TaxonNames,!w.rawTaxa))throw new Error("Taxon list has failed to load in TaxonSearch");}static formatter(e,t=""){return e.vernacularMatched?e.acceptedEntityId?`<q><b>${e.vernacular}</b></q> <span class="italictaxon">${e.uname}${e.qualifier?` <b>${e.qualifier}</b>`:""}</span> <span class="taxauthority">${e.authority}</span> = <span class="italictaxon">${e.acceptedNameString}${e.acceptedQualifier?` <b>${e.acceptedQualifier}</b>`:""}</span> <span class="taxauthority">${e.acceptedAuthority}</span>`:`<q><b>${e.vernacular}</b></q> <span class="italictaxon">${e.uname}${e.qualifier?` <b>${e.qualifier}</b>`:""}</span> <span class="taxauthority">${e.authority}</span>`:e.acceptedEntityId?`<span class="italictaxon">${e.uname}${e.qualifier?` <b>${e.qualifier}</b>`:""}</span> <span class="taxauthority">${e.authority}</span>${e.vernacular?` <q><b>${e.vernacular}</b></q>`:""} = <span class="italictaxon">${e.acceptedNameString}${e.acceptedQualifier?` <b>${e.acceptedQualifier}</b>`:""}</span> <span class="taxauthority">${e.acceptedAuthority}</span>`:`<span class="italictaxon">${e.uname}${e.qualifier?` <b>${e.qualifier}</b>`:""}</span> <span class="taxauthority">${e.authority}</span>${e.vernacular?` <q><b>${e.vernacular}</b></q>`:""}`;}static abbreviatedGenusRegex=/^(X\s+)?([a-z])[.\s]+(.*?)$/i;static nameStringColumn=0;static canonicalColumn=1;static hybridCanonicalColumn=2;static acceptedEntityIdColumn=3;static qualifierColumn=4;static authorityColumn=5;static vernacularColumn=6;static vernacularRootColumn=7;static usedColumn=8;static minRankColumn=9;static taxonRankNameSearchRegex=[/\s+sub-?g(?:en(?:us)?)?[.\s]+/i,/\s+sect(?:ion)?[.\s]+/i,/\s+subsect(?:ion)?[.\s]+/i,/\s+ser(?:ies)?[.\s]+/i,/\s+gp[.\s]+/i,/\s+s(?:ub)?-?sp(?:ecies)?[.\s]+/i,/\s+morphotype\s+/i,/\s+var[.\s]+/i,/\s+cv[.\s]+/i,/\s+n(?:otho)?v(?:ar)?[.\s]+/i,/\s+f[.\s]+|\s+forma?\s+/i,/\s+n(?:otho)?ssp[.\s]+/i];static taxonRankNameReplacement=[" subg. "," sect. "," subsect. "," ser. "," group "," subsp. "," morph. "," var. "," cv. "," nothovar. "," f. "," nothosubsp. "];static cleanRankNamesRegex=/\s(subfam\.|subg\.|sect\.|subsect\.|ser\.|subser\.|subsp\.|nothosubsp\.|microsp\.|praesp\.|agsp\.|race|convar\.|nm\.|microgene|f\.|subvar\.|var\.|nothovar\.|cv\.|sublusus|taxon|morph\.|group|sp\.)\s/;static taxonQualifierSearchRegex=[/\s*\(?\bf\s*x\s*m or m\s*x\s*f\)?\s*$/i,/\s*\(?\bm\s*x\s*f or f\s*x\s*m\)?\s*$/i,/\s*\(?\bf\s*x\s*m\)?\s*$/i,/\s*\(?\bm\s*x\s*f\)?\s*$/i,/\s*\(?\bfemale\s*x\s*male\)?\s*$/i,/\s*\(?\bmale\s*x\s*female\)?\s*$/i,/\s*'male'\s*$/i,/\s*'female'\s*$/i,/\b\s*sens\.?\s*lat[.\s]+/i,/\b\s*s\.\s*lat\.?\s*\b/i,/\b\s*s\.?\s*l\.?\s+\b/i,/\b\s*sensu\s*lato\s+\b|\(\s*sensu\s*lato\s*\)/i,/\b\s*sensu\s*stricto\s+\b|\(\s*sensu\s*stricto\s*\)/i,/\b\s*sens\.?\s*strict[.\s]+/i,/\b\s*sens\.?\s*str\.?\s*(?=\))|\b\s*sens\.?\s*str[.\s]+/i,/\b\s*s\.\s*str[.\s]+/i,/\b\s*s\.?\s*s\.?\s+\b/i,/\b\s*sens\.?\s*lat\.?\s*$/i,/\b\s*s\.\s*lat\.?\s*$/i,/\b\s*s\.?\s*l\.?\s*$/i,/\b\s*sensu\s*lato\s*$/i,/\b\s*sensu\s*stricto\s*$/i,/\b\s*sens\.?\s*strict\.?\s*$/i,/\b\s*sens\.?\s*str\.?\s*$/i,/\b\s*s\.\s*str\.?\s*$/i,/\b\s*s\.?\s*s\.?\s*$/i,/\b\s*agg\.?\s*$/i,/\b\s*aggregate\s*$/i,/\b\s*sp\.?\s*cultivar\s*$/i,/\b\s*sp\.?\s*cv\.?\s*$/i,/\b\s*cultivars?\s*$/i,/\b\s*cv\s+$/i,/\b\s*cv$/i,/\b\s*cf\s*$/i,/\b\s*aff\s*$/i,/\b\s*s\.?n\.?\s*$/i,/\b\s*sp\.?\s*nov\.?\s*$/i,/\b\s*auct[.\s]*$/i,/\b\s*ined[.\s]*$/i,/\b\s*nom\.?\snud[.\s]*$/i,/\b\s*p\.p[.\s?]*$/i,/\b\s*spp?\.?[\s?]*$/i,/\b\s*species\s*$/i,/\b\s*spp?\.?\s*\(/i,/\b\s*species\s*\(/i];static taxonQualifierReplacement=[" "," "," (f x m)"," (m x f)"," (f x m)"," (m x f)"," male"," female"," s.l. "," s.l. "," s.l. "," s.l. "," s.s. "," s.s. "," s.s. "," s.s. "," s.s. "," s.l."," s.l."," s.l."," s.l."," s.s."," s.s."," s.s."," s.s."," s.s."," agg."," agg."," cv. "," cv. "," cv. "," cv. "," cv. "," cf."," aff."," sp.nov."," sp.nov."," auct."," ined."," nom. nud."," pro parte","",""," ("," ("];static normaliseTaxonName(e){for(let t=0,i=A.taxonRankNameSearchRegex.length;t<i;t++)e=e.replace(A.taxonRankNameSearchRegex[t],A.taxonRankNameReplacement[t]);for(let t=0,i=A.taxonQualifierSearchRegex.length;t<i;t++)e=e.replace(A.taxonQualifierSearchRegex[t],A.taxonQualifierReplacement[t]);return e;}static escapeRegExp(e){return e.replace(A.cleanRegex,"\\$&");}static cleanRegex=/[.*+?^${}()|[\]\\]/g;static generate_hybrid_combinations_regex(e){const t=A.escapeRegExp(e).split(/\s+x\s+/i);if(t.length<2)return t[0];const i=[],r=function(e,t){if(0===e.length)i[i.length]=t.join("[a-zA-Z]* x ");else for(let i=e.length-1;i>=0;--i){const n=e.slice(0),o=t.slice(0);o.unshift(n.splice(i,1)[0]),r(n,o);}};return r(t,[]),`(?:${i.join("|")})`;}lookup(e){let t,i,r,n,o={};if(i=A.normaliseTaxonName(decodeURIComponent(e).trim()).replace(/\s+x$/i,""),n=/ x\b/.test(i),""!==i){const e=i.match(A.abbreviatedGenusRegex);if(e){let s,a;"X"===e[2]||"x"===e[2]?(s=new RegExp(`^(X\\s|X[a-z]+\\s+)(x )?\\b${A.generate_hybrid_combinations_regex(e[3])}.*`,"i"),a=s):(s=new RegExp(`^(X )?${A.escapeRegExp(e[2])}[a-z]+ (x )?.*\\b${A.generate_hybrid_combinations_regex(e[3])}.*`,"i"),a=new RegExp(`^(X )?${A.escapeRegExp(e[2])}[a-z]+ (x )?\\b${A.generate_hybrid_combinations_regex(e[3])}.*`,"i"));for(let e in w.rawTaxa){let t=w.rawTaxa[e];r=0===t[A.canonicalColumn]?t[A.nameStringColumn]:t[A.canonicalColumn],(s.test(r)||""!==t[A.hybridCanonicalColumn]&&s.test(t[A.hybridCanonicalColumn]))&&(o[e]={exact:t[A.nameStringColumn]===i,near:a.test(t[A.nameStringColumn])});}t=this.compile_results(o,n);}else {let e,s;const a=A.escapeRegExp(i);-1!==i.indexOf(" ")?(e=`${A.escapeRegExp(i.substr(0,i.indexOf(" ")))} (x )?.*\\b${A.generate_hybrid_combinations_regex(i.substr(i.indexOf(" ")+1))}.*`,s=new RegExp(`^(?:Xs+)?${A.escapeRegExp(i.substr(0,i.indexOf(" ")))} (x )?\\b${A.generate_hybrid_combinations_regex(i.substr(i.indexOf(" ")+1))}.*`,"i")):(e=`${a}.*`,s=new RegExp(`^${a}.*`));const l=`^${a}.*`,c=new RegExp(`^(?:Xs+)?${e}`,"i");{const e=new RegExp(l,"i");for(let t in w.rawTaxa){let n=w.rawTaxa[t];r=0===n[A.canonicalColumn]?n[A.nameStringColumn]:n[A.canonicalColumn],c.test(n[A.nameStringColumn])||r!==n[A.nameStringColumn]&&c.test(r)?o[t]={exact:n[A.nameStringColumn]===i,near:s.test(n[A.nameStringColumn])||s.test(r)}:(e.test(n[A.vernacularColumn])||e.test(n[A.vernacularRootColumn]))&&(o[t]={exact:n[A.vernacularColumn]===i,vernacular:!0});}if(t=this.compile_results(o,n),t.length<5){const e=new RegExp(`\\b${a}.*`,"i");for(let t in w.rawTaxa)if(!o.hasOwnProperty(t)){let r=w.rawTaxa[t];e.test(r[A.nameStringColumn])?o[t]={exact:r[A.nameStringColumn]===i}:(0!==r[A.canonicalColumn]&&e.test(r[A.canonicalColumn])||e.test(r[A.vernacularColumn]))&&(o[t]={exact:r[A.nameStringColumn]===i,vernacular:!0});}t=this.compile_results(o,n);}}}}else t=[];return t;}compile_results(e,t){const i=[];for(const t in e)if(e.hasOwnProperty(t)){const r=w.rawTaxa[t];if((!this.requireExtantDDbRecords||this.requireExtantDDbRecords&&1===r[A.usedColumn])&&(!this.minimumRankSort||this.minimumRankSort>0&&r[A.minRankColumn]>=this.minimumRankSort)){const n=r[A.nameStringColumn]+(r[A.qualifierColumn]?` ${r[A.qualifierColumn]}`:""),o={entityId:t,vernacular:r[A.vernacularColumn],qname:n,name:n,qualifier:r[A.qualifierColumn],authority:r[A.authorityColumn],uname:r[A.nameStringColumn],vernacularMatched:e[t].hasOwnProperty("vernacular"),exact:e[t].hasOwnProperty("exact")&&e[t].exact,near:e[t].hasOwnProperty("near")&&e[t].near};if(o.formatted=A.formatter(o),r[A.acceptedEntityIdColumn]){const e=w.rawTaxa[r[A.acceptedEntityIdColumn]];if(!e)throw w.rawTaxa?new Error(`Failed to find taxon for accepted entity id ${r[A.acceptedEntityIdColumn]}`):new Error(`Taxon.rawTaxa set is undefined, when trying to find taxon for accepted entity id ${r[A.acceptedEntityIdColumn]}`);o.acceptedEntityId=r[A.acceptedEntityIdColumn],o.acceptedNameString=e[A.nameStringColumn],o.acceptedQualifier=e[A.qualifierColumn],o.acceptedAuthority=e[A.authorityColumn];}i.push(o);}}return i.length&&(i.sort((e,i)=>{if(e.exact)return i.exact?e.acceptedEntityId?1:0:-1;if(i.exact)return 1;if(e.near){if(!i.near)return -1;}else if(i.near)return 1;let r=null!==e.uname.match(/\bx\b/i),n=null!==i.uname.match(/\bx\b/i);if(r)return n?e.uname===i.uname?e.acceptedEntityId?1:0:e.qname<i.qname?-1:1:t?-1:1;if(n)return t?1:-1;if(e.uname===i.uname){if(!e.acceptedEntityId&&!i.acceptedEntityId||e.acceptedEntityId&&i.acceptedEntityId){let t=["s.s.","",null,"s.l.","agg."].indexOf(e.qualifier),r=["s.s.","",null,"s.l.","agg."].indexOf(i.qualifier);return t===r?0:t<r?1:-1;}return e.acceptedEntityId?1:-1;}return e.vernacularMatched&&i.vernacularMatched&&e.vernacular!==i.vernacular?e.vernacular.length<i.vernacular.length?-1:1:e.uname<i.uname?-1:1;}),i.length>A.MAXIMUM_RESULTS&&(i.length=A.MAXIMUM_RESULTS)),i;}}class P extends m{_value=null;_fieldEl;label="field label";helpText="";validationMessage="";static COMPLETION_COMPULSORY="compulsory";static COMPLETION_DESIRED="desired";static COMPLETION_OPTIONAL="optional";completion=P.COMPLETION_OPTIONAL;static#r=1;static EVENT_CHANGE="fieldChange";constructor(e){super(),e&&(e.label&&(this.label=e.label),e.helpText&&(this.helpText=e.helpText),e.validationMessage&&(this.validationMessage=e.validationMessage),e.completion&&(this.completion=e.completion));}static get nextId(){return `field${P.#r++}_${Date.now()}`;}get value(){return this._value;}set value(e){}get fieldElement(){return this._fieldEl||this.buildField(),this._fieldEl;}parentForm;attributeName;addField(e){e.appendChild(this.fieldElement);}markValidity(e){}static cleanRawInput(e){return e.value.trim().replace(/\s\s+/g," ");}static cleanRawString(e){return e.trim().replace(/\s\s+/g," ");}static isEmpty(e){return ""===e||null==e;}static isValid(e,t,i){return !t.attributes.completion||t.attributes.completion!==P.COMPLETION_COMPULSORY&&t.attributes.completion!==P.COMPLETION_DESIRED?null:!(!i.hasOwnProperty(e)||t.field.isEmpty(i[e]));}static summarise(e,t,i){return !t.summary||t.summary.hasOwnProperty("summarise")&&!0!==t.summary.summarise?"":t.summarise?t.summarise(e,t,i):t.field.summariseImpl(e,t,i);}static summariseImpl(e,t,i){return "";}}class L extends P{#n;#o;_value="";_inputType="date";_autocomplete="";_minDate=null;_maxDate=null;constructor(e){super(e),this._value=new Date().toJSON().slice(0,10),e&&(e.placeholder&&(this.placeholder=e.placeholder),e.autocomplete&&(this._autocomplete=e.autocomplete),e.minDate&&(this._minDate=e.minDate),e.maxDate&&(this._maxDate=e.maxDate));}set value(e){this._value=void 0===e||null==e?L.todaysDate():e.trim(),this.updateView();}static todaysDate(){return new Date().toJSON().slice(0,10);}get value(){return this._value?this._value.slice(0,10):"";}updateView(){if(this._fieldEl){document.getElementById(this.#n).value=P.cleanRawString(this._value);}}buildField(){const e=document.createElement("div");e.className="form-group",this.#o=e.id=P.nextId,this.#n=P.nextId;const t=e.appendChild(document.createElement("label"));t.htmlFor=this.#n,t.textContent=this.label;const i=e.appendChild(document.createElement("input"));i.className="form-control",i.id=this.#n;try{i.type=this._inputType;}catch(e){console.log(`Failed to set type '${this._inputType}'`);}if(this.placeholder&&(i.placeholder=this.placeholder),this._autocomplete&&(i.autocomplete=this._autocomplete,"off"===this._autocomplete&&(i.name=x())),this.completion===P.COMPLETION_COMPULSORY&&(i.required=!0),this.validationMessage){const t=e.appendChild(document.createElement("div"));t.className="invalid-feedback",t.innerHTML=this.validationMessage;}if(this.helpText){e.appendChild(document.createElement("small")).innerHTML=this.helpText;}i.addEventListener("change",this.inputChangeHandler.bind(this)),this._fieldEl=e;}static isValid(e,t,i){if(t.attributes.completion&&(t.attributes.completion===P.COMPLETION_COMPULSORY||t.attributes.completion===P.COMPLETION_DESIRED)){if(!i.hasOwnProperty(e)||t.field.isEmpty(i[e]))return !1;{let r=i[e];if(t.attributes.minDate&&r<t.attributes.minDate)return !1;if(t.attributes.maxDate&&r>t.attributes.maxDate)return !1;if(r>new Date().toJSON().slice(0,10))return !1;}}return null;}markValidity(e){const t=document.getElementById(this.#n);null===e?t.classList.remove("is-invalid","is-valid"):(t.classList.remove(e?"is-invalid":"is-valid"),t.classList.add(e?"is-valid":"is-invalid"));}inputChangeHandler(e){e.stopPropagation(),console.log("got date field change event"),this.value=P.cleanRawString(document.getElementById(this.#n).value),this.fireEvent(P.EVENT_CHANGE);}static summariseImpl(e,t,i){return ""!==i[e]&&null!==i[e]&&void 0!==i[e]?S(i[e].trim()):"";}}class D extends m{static DEVICE_TYPE_UNKNOWN="unknown";static DEVICE_TYPE_UNCHECKED="unchecked";static DEVICE_TYPE_MOBILE="mobile";static DEVICE_TYPE_IMMOBILE="immobile";static EVENT_GPS_PERMISSION_CHANGE="gpspermissionchange";static _deviceType=D.DEVICE_TYPE_UNCHECKED;static getDeviceType(){return D._deviceType===D.DEVICE_TYPE_UNCHECKED&&(navigator.userAgentData?(D._deviceType=navigator.userAgentData.mobile?D.DEVICE_TYPE_MOBILE:D.DEVICE_TYPE_IMMOBILE,console.log(`Evaluated device using mobile flag, result: ${D._deviceType}`)):/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent)?(console.log(`Detected mobile via use-agent string: ${navigator.userAgent}`),D._deviceType=D.DEVICE_TYPE_MOBILE):(console.log("Flagging device type as unknown."),D._deviceType=D.DEVICE_TYPE_UNKNOWN)),D._deviceType;}static GPS_PERMISSION_UNKNOWN="unknown";static GPS_PERMISSION_UNCHECKED="unchecked";static GPS_PERMISSION_GRANTED="granted";static GPS_PERMISSION_DENIED="denied";static GPS_PERMISSION_PROMPT="prompt";static _gpsPermission=D.GPS_PERMISSION_UNCHECKED;static gpsEventObject;static async haveGPSPermission(){return D._gpsPermission===D.GPS_PERMISSION_UNCHECKED&&(D._gpsPermission=D.GPS_PERMISSION_UNKNOWN,D.gpsEventObject=new D(),navigator.permissions&&navigator.permissions.query?await navigator.permissions.query({name:"geolocation"}).then(function(e){e.onchange=function(){console.log("geolocation permission status has changed to ",this.state),D._gpsPermission=this.state,D.gpsEventObject.fireEvent(D.EVENT_GPS_PERMISSION_CHANGE,D._gpsPermission);},D._gpsPermission=e.state;}):D._gpsPermission=D.GPS_PERMISSION_UNKNOWN),D._gpsPermission;}static haveGPSPermissionPromise(){return D._gpsPermission===D.GPS_PERMISSION_UNCHECKED?(D._gpsPermission=D.GPS_PERMISSION_UNKNOWN,D.gpsEventObject=new D(),navigator.permissions&&navigator.permissions.query?navigator.permissions.query({name:"geolocation"}).then(function(e){return e.onchange=function(){console.log("geolocation permission status has changed to ",this.state),D._gpsPermission=this.state,D.gpsEventObject.fireEvent(D.EVENT_GPS_PERMISSION_CHANGE,D._gpsPermission);},D._gpsPermission=e.state,D._gpsPermission;}):(D._gpsPermission=D.GPS_PERMISSION_UNKNOWN,new Promise(()=>D._gpsPermission))):new Promise(()=>D._gpsPermission);}static _setGPSPermission(e){D._gpsPermission!==e&&(D._gpsPermission=e,D.gpsEventObject&&D.gpsEventObject.fireEvent(D.EVENT_GPS_PERMISSION_CHANGE,D._gpsPermission));}static seekGPS(e){D.haveGPSPermission();let t,i=e?document.getElementById(e):null,r=i?function(){i.style.display="block";}:function(){},n=i?function(){i.style.display="none";}:function(){};return t=i&&D._gpsPermission!==D.GPS_PERMISSION_GRANTED?setTimeout(r,5e3):null,new Promise((e,t)=>navigator.geolocation.getCurrentPosition(e,t,{enableHighAccuracy:!0,timeout:3e4,maximumAge:2e4})).then(e=>{const r=e.coords.latitude,o=e.coords.longitude;return console.log(`Got GPS fix ${r} , ${o}`),i&&(clearTimeout(t),n()),D._setGPSPermission(D.GPS_PERMISSION_GRANTED),e;},e=>{switch(console.log({"gps look-up failed":e}),e.code){case e.TIMEOUT:case e.PERMISSION_DENIED:i&&r();}return null;});}}class k extends m{static CHANGE_EVENT="change";static EVENT_INITIALISE_NEW="initialisenew";static EVENT_INITIALISED="initialised";static EVENT_CAMERA="cameraimage";#s;static#a=0;_formId;_formContentContainer;fields;liveValidation=!1;isValid=null;nextButtonId=null;_formFieldsBuilt=!1;static EVENT_VALIDATION_STATE_CHANGE="validationstatechange";get formElement(){return this.#s||(this.#s=document.createElement("form"),this.#s.id=this._formId="form"+k.#a++,this.#s.noValidate=!0,this.liveValidation&&(this.#s.className="needs-validation"),this.buildContentContainer(this.#s),this.#s.addEventListener("change",e=>{this.changeHandler(e);},{capture:!1})),this.#s;}buildContentContainer(e){return this._formContentContainer=e,this._formContentContainer;}changeHandler(e){console.log({"form change event":e});}destructor(){super.destructor(),this.#s=null;}static#l=0;static get nextId(){return "id"+k.#l++;}static COMPLETION_STATUS_UNSTARTED="unstarted";static COMPLETION_STATUS_COMPLETE="complete";static COMPLETION_STATUS_IN_PROGRESS="inProgress";buildFormFields(){this.initialiseFormFields();for(let e in this.fields)if(this.fields.hasOwnProperty(e)){let t=this.fields[e];t.parentForm=this,t.attributeName=e,t.addField(this._formContentContainer),t.addListener(P.EVENT_CHANGE,this.changeHandler.bind(this));}this._formFieldsBuilt=!0;}conditionallyValidateForm(){console.log("called conditionallyValidateForm"),this.liveValidation&&(console.log("doing validation conditionallyValidateForm"),this.validateForm());}testRequiredComplete(){const e=this.model.evaluateCompletionStatus(this.getFormSectionProperties()).requiredFieldsPresent;return this.isValid!==e&&(this.isValid=e,this.fireEvent(k.EVENT_VALIDATION_STATE_CHANGE,{isValid:this.isValid})),e;}validateForm(){this.liveValidation&&this.formElement.classList.add("needs-validation");const e=this.model.evaluateCompletionStatus(this.getFormSectionProperties());for(let t in this.fields)if(this.fields.hasOwnProperty(t)){this.fields[t].markValidity(e.validity[t]);}return this.isValid!==e.requiredFieldsPresent&&(this.isValid=e.requiredFieldsPresent,this.fireEvent(k.EVENT_VALIDATION_STATE_CHANGE,{isValid:this.isValid})),e.requiredFieldsPresent;}populateFormContent(){if(this._formFieldsBuilt){const e=this.model;for(let t in this.fields)if(this.fields.hasOwnProperty(t)){this.fields[t].value=e.attributes[t];}this.conditionallyValidateForm();}}updateModelFromContent(){}}class B extends P{#n;#o;#c;parentForm;_value={images:[]};includeCamera=!0;placeholder="";static LICENSE_MODAL="imagelicensemodal";static ORIGIN_CAMERA="cameraimage";static ORIGIN_FILE="fileimage";constructor(e){super(e),e&&(e.hasOwnProperty("includeCamera")&&(this.includeCamera=e.includeCamera),e.placeholder&&(this.placeholder=e.placeholder));}set value(e){if(this._value={images:[]},e)for(let t of e)I.imageCache.has(t)?this._value.images.push(I.imageCache.get(t)):(console.log(`Creating placeholder image object '${t}'`),this._value.images.push(I.placeholder(t)));this.updateView();}static isEmpty(e){return !e||0===e.length;}get value(){let e=[];if(this._value&&this._value.images)for(let t of this._value.images)e[e.length]=t.id;return e;}updateView(){if(this._fieldEl){const e=[];for(let t of this._value.images)e.push(`<picture style="cursor: pointer;" data-imageid="${t.id}"><source srcset="/image.php?imageid=${t.id}&amp;height=128&amp;format=webp" type="image/webp"><img data-imageid="${t.id}" src="/image.php?imageid=${t.id}&amp;height=128&amp;format=jpeg" height="128" alt="photo"></picture>`);document.getElementById(this.#c).innerHTML=e.join("\n");}}buildField(){const e=document.createElement("div");e.className="form-group",this.#o=e.id=P.nextId,this.#n=P.nextId;const t=e.appendChild(document.createElement("label"));t.htmlFor=this.#n,t.textContent=this.label;const i=e.appendChild(document.createElement("div"));i.className="input-group";const r=document.createElement("div");r.className="custom-file",i.appendChild(r);const n=r.appendChild(document.createElement("input"));if(n.type="file",n.className="custom-file-input",n.id=this.#n,n.accept=".jpeg, .jpg, image/png, image/jpeg",n.multiple=!0,this.placeholder){const e=r.appendChild(document.createElement("label"));e.className="custom-file-label",e.htmlFor=this.#n,e.textContent=this.placeholder;}if(this.includeCamera&&D.getDeviceType()!==D.DEVICE_TYPE_IMMOBILE){const e=document.createElement("div");e.className="input-group-append";const t=e.appendChild(document.createElement("span"));t.className="input-group-text";const r=t.appendChild(document.createElement("label"));r.className="ps-0 pe-0 ms-0 me-0 mt-0 mb-0 pt-0 pb-0 material-icons";const n=r.appendChild(document.createElement("i"));n.className="material-icons ps-0 pe-0 ms-0 me-0 mt-0 mb-0 pt-0 pb-0",n.textContent="add_a_photo";const o=r.appendChild(document.createElement("input"));o.type="file",o.capture="environment",o.accept="image/*",o.style.display="none",o.id=P.nextId,i.appendChild(e),o.addEventListener("change",this.inputChangeHandler.bind(this,{inputId:o.id,origin:B.ORIGIN_CAMERA}));}if(this.helpText){e.appendChild(document.createElement("small")).innerHTML=this.helpText;}const o=e.appendChild(document.createElement("p"));if(this.#c=o.id=P.nextId,o.addEventListener("click",this.imageClickHandler.bind(this)),this.validationMessage){const t=e.appendChild(document.createElement("div"));t.className="invalid-feedback",t.innerHTML=this.validationMessage;}n.addEventListener("change",this.inputChangeHandler.bind(this,{inputId:n.id,origin:B.ORIGIN_FILE})),this._fieldEl=e,this.parentForm.addListener("deleteimage",this.deleteImageHandler.bind(this));}deleteImageHandler(e){let t;console.log(`delete image ${e.imageId}`);for(let i in this._value.images)if(this._value.images.hasOwnProperty(i)&&this._value.images[i].id===e.imageId){t=this._value.images.splice(i,1)[0];break;}t?(t.deleted=!0,this.#h([t]),this.updateView(),this.fireEvent(P.EVENT_CHANGE)):console.log(`Failed to find image id ${e.imageId}`);}imageClickHandler(e){if(p(e))return;let t=e.target.closest("picture");t||(t=e.target.closest("img"));const i=t.getAttribute("data-imageid");if(i){document.getElementById("imagemodal").getElementsByTagName("picture")[0].innerHTML=`<source srcset="/image.php?imageid=${i}&amp;width=${window.innerWidth}&amp;format=webp" type="image/webp">\n                <img src="/image.php?imageid=${i}&amp;width=${window.innerWidth}&amp;format=jpeg" width="auto" style="max-height: 48vh; max-width: 100%;" alt="photo">`;document.getElementById("imagemodaldelete").setAttribute("data-imageid",i),B.imageModal.show();}}inputChangeHandler(e,t){t.stopPropagation(),console.log({"got image field input change event":e});let i=document.getElementById(e.inputId);i.files.length?(this.#u(i.files).then(()=>{this.fireEvent(P.EVENT_CHANGE);}),e.origin===B.ORIGIN_CAMERA&&this.parentForm.fireEvent(k.EVENT_CAMERA)):this.fireEvent(P.EVENT_CHANGE);}#u(e){this.parentForm.pingOccurrence();const t=[];for(let i of e)t.push(I.fromFile(i));return this.#h(t);}#h(e){if(e.length){const t=e.shift();return t.save(this.parentForm.surveyId,this.parentForm.occurrenceId,this.parentForm.projectId).then(e=>{t.deleted?console.log({"deleted image":t.id}):(console.log(`Added image '${t.id}'`),console.log({jsonDescription:e}),this._value.images.push(t),this.updateView());},e=>{console.log(`Failed to add image ${t.id}`),console.log({"Failure reason":e});}).finally(()=>this.#h(e));}return Promise.resolve();}static imageModal;static registerImageModalElement(t,i){const r=document.createElement("div");r.innerHTML='<div class="modal fade" id="imagemodal" tabindex="-1" role="dialog" aria-labelledby="imagemodalTitle" aria-hidden="true">\n  <div class="modal-dialog modal-dialog-centered" role="document">\n    <div class="modal-content">\n      <div class="modal-header d-none d-md-flex">\n        <h5 class="modal-title" id="imagemodalTitle">Photo</h5>\n        <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">\n          <span aria-hidden="true">&times;</span>\n        </button>\n      </div>\n      <div class="modal-body" style="position: relative;">\n        <picture>\n        </picture>\n      </div>\n      <div class="modal-footer">\n        <button type="button" id="imagemodaldelete" class="btn btn-outline-danger delete-occurrence-button me-3" data-bs-toggle="modal" data-bs-target="#deleteimagemodal" data-imageid=""><i class="material-icons">delete</i></button>\n        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>\n      </div>\n    </div>\n  </div>\n</div>',t.appendChild(r.firstChild),B.imageModal=e.getOrCreateInstance(document.getElementById("imagemodal")),document.getElementById("imagemodaldelete").addEventListener("click",e=>{if(p(e))return;const t=e.target.closest("button");if(t&&t.hasAttribute("data-imageid")){const e=t.getAttribute("data-imageid");i.getOccurrenceForm().fireEvent("deleteimage",{imageId:e}),B.imageModal.hide();}});}static licenseModal;static registerLicenseModal(t){const i=document.createElement("div");i.innerHTML=`<div class="modal fade" id="${B.LICENSE_MODAL}" tabindex="-1" role="dialog" aria-labelledby="${B.LICENSE_MODAL}Title" aria-hidden="true">\n  <div class="modal-dialog modal-dialog-centered" role="document">\n    <div class="modal-content">\n      <div class="modal-header">\n        <h5 class="modal-title" id="${B.LICENSE_MODAL}Title">Image licensing</h5>\n        <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">\n          <span aria-hidden="true">&times;</span>\n        </button>\n      </div>\n      <div class="modal-body">\n        <p>By choosing to submit images with your Garden Wildflower Hunt records you agree to license the image under the terms of the Creative Common Attribution 4.0 International license (CC BY 4.0).</p>\n        <p>The following is a summary of (and not a substitute for) the <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank">license</a>.</p>\n        <p>Licensees are free to:</p>\n        <ul class="license-properties">\n<li>\n<strong>Share</strong> â copy and redistribute the material in any medium or format\n</li>\n<li>\n<strong>Adapt</strong> â remix, transform, and build upon the material for any purpose, even commercially.\n</li>\n</ul>\n<p>Licensees are most follow these term:</p>\n<ul>\n<li>\n<p>\n<strong>Attribution</strong> â licensees must give appropriate credit, provide a link to the license, and indicate if changes were made.\n</p>\n</li>\n</ul>\n<p>Full details of the license are here: <a href="https://creativecommons.org/licenses/by/4.0/" target="_blank">CC BY 4.0 license</a></p>\n\n      </div>\n      <div class="modal-footer">\n        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>\n      </div>\n    </div>\n  </div>\n</div>`,t.appendChild(i.firstChild),B.licenseModal=e.getOrCreateInstance(document.getElementById(B.LICENSE_MODAL));}}var U=/^[-!#$%&'*+\/0-9=?A-Z^_a-z{|}~](\.?[-!#$%&'*+\/0-9=?A-Z^_a-z`{|}~])*@[a-zA-Z0-9](-*\.?[a-zA-Z0-9])*\.[a-zA-Z](-?[a-zA-Z0-9])+$/;class V extends P{#n;#o;_value="";_inputType="text";_autocomplete="";constructor(e){super(e),e&&(e.type&&(this._inputType=e.type),e.placeholder&&(this.placeholder=e.placeholder),e.autocomplete&&(this._autocomplete=e.autocomplete));}static emailValidator(e,t,i){return !t.attributes.completion||t.attributes.completion!==P.COMPLETION_COMPULSORY&&t.attributes.completion!==P.COMPLETION_DESIRED?null:i.hasOwnProperty(e)&&!t.field.isEmpty(i[e])&&function(e){if(!e)return !1;if(e.length>254)return !1;if(!U.test(e))return !1;var t=e.split("@");return !(t[0].length>64||t[1].split(".").some(function(e){return e.length>63;}));}(i[e]);}set value(e){this._value=void 0===e||null==e?"":e.trim(),this.updateView();}get value(){return this._value;}updateView(){if(this._fieldEl){document.getElementById(this.#n).value=P.cleanRawString(this._value);}}buildField(){const e=document.createElement("div");e.className="form-group",this.#o=e.id=P.nextId,this.#n=P.nextId;const t=e.appendChild(document.createElement("label"));t.htmlFor=this.#n,t.textContent=this.label;const i=e.appendChild(document.createElement("input"));i.className="form-control",i.id=this.#n;try{i.type=this._inputType;}catch(e){console.log(`Failed to set type '${this._inputType}'`);}if(this.placeholder&&(i.placeholder=this.placeholder),this._autocomplete&&(i.autocomplete=this._autocomplete,"off"===this._autocomplete&&(i.name=x())),this.completion===P.COMPLETION_COMPULSORY&&(i.required=!0),this.validationMessage){const t=e.appendChild(document.createElement("div"));t.className="invalid-feedback",t.innerHTML=this.validationMessage;}if(this.helpText){e.appendChild(document.createElement("small")).innerHTML=this.helpText;}i.addEventListener("change",this.inputChangeHandler.bind(this)),this._fieldEl=e;}markValidity(e){const t=document.getElementById(this.#n);null===e?t.classList.remove("is-invalid","is-valid"):(t.classList.remove(e?"is-invalid":"is-valid"),t.classList.add(e?"is-valid":"is-invalid"));}inputChangeHandler(e){e.stopPropagation(),console.log("got input field change event"),this.value=P.cleanRawString(document.getElementById(this.#n).value),this.fireEvent(P.EVENT_CHANGE);}static summariseImpl(e,t,i){return ""!==i[e]&&null!==i[e]&&void 0!==i[e]?S(i[e].trim()):"";}}class G extends P{#o;#d;options={};includeOtherFreeText=!0;_value={selection:[],other:null};static KEY_OTHER="other";static#p="fieldset";constructor(e){super(e),e&&(e.options&&(this.options=e.options),e.hasOwnProperty("includeOtherFreeText")&&(this.includeOtherFreeText=e.includeOtherFreeText));}set value(e){this._value=e||{selection:[],other:null},this.updateView();}get value(){return this._value;}updateView(){if(this._fieldEl)for(let e of document.querySelectorAll(`${G.#p}#${this.#o} input[type="checkbox"]`)){let t=e.checked=this._value.selection.includes(e.name);if(e.name===G.KEY_OTHER&&this.#d){let e=document.getElementById(this.#d);e.style.display=t?"block":"none",e.value=null===this._value.other?"":this._value.other.trim();}}}buildField(){if(!this.options)throw new Error("Options have not been set before call to buildField()");const e=document.createElement(G.#p);e.className="form-group",this.#o=e.id=P.nextId;const t=e.appendChild(document.createElement("label"));if(t.style.display="block",t.textContent=this.label,this.helpText){e.appendChild(document.createElement("small")).innerHTML=this.helpText;}for(let t in this.options)this.options.hasOwnProperty(t)&&this.#f(e,t,this.options[t]);if(this.validationMessage){const t=e.appendChild(document.createElement("div"));t.className="invalid-feedback",t.innerHTML=this.validationMessage;}e.addEventListener("change",this.inputChangeHandler.bind(this)),this._fieldEl=e;}#f(e,t,i){const r=e.appendChild(document.createElement("div"));r.className="form-check";const n=r.appendChild(document.createElement("input"));n.type="checkbox",n.className="form-check-input",n.id=P.nextId,n.name=t;const o=r.appendChild(document.createElement("label"));if(o.htmlFor=n.id,o.className="form-check-label",o.textContent=i.label,G.KEY_OTHER===t&&this.includeOtherFreeText){const e=r.appendChild(document.createElement("input"));e.id=this.#d=P.nextId,e.className="form-control",e.style.display="none";}}inputChangeHandler(e){e.stopPropagation();let t,i={selection:[],other:null};this.#d&&(t=document.getElementById(this.#d));const r=document.querySelectorAll(`${G.#p}#${this.#o} input[type="checkbox"]:checked`);for(let e of r)i.selection[i.selection.length]=e.name,e.name===G.KEY_OTHER&&this.#d&&(i.other=P.cleanRawInput(t));this.value=i,this.fireEvent(P.EVENT_CHANGE);}static summariseImpl(e,t,i){const r=t.summary,n=[];if(i[e].selection.length){for(let r of i[e].selection)"other"===r&&i[e].other?n[n.length]=`${t.attributes.options[r].summary||t.attributes.options[r].label} (${i[e].other})`:n[n.length]=t.attributes.options[r].summary||t.attributes.options[r].label;return S(`${r.summaryPrefix} ${C(",","or",n)}`);}return "";}}class j extends P{#o;#m;#d;options={};placeholder="";includeOtherFreeText=!0;_value={selection:[],other:null};static#p="fieldset";constructor(e){super(e),e&&(e.options&&(this.options=e.options),e.hasOwnProperty("includeOtherFreeText")&&(this.includeOtherFreeText=e.includeOtherFreeText),e.placeholder&&(this.placeholder=e.placeholder));}set value(e){this._value=e||{selection:[],other:null},this.updateView();}get value(){return this._value;}static isEmpty(e){return 0===e.selection.length||""===e.selection[0];}markValidity(e){const t=document.getElementById(this.#m);null===e?t.classList.remove("is-invalid","is-valid"):(t.classList.remove(e?"is-invalid":"is-valid"),t.classList.add(e?"is-valid":"is-invalid"));}updateView(){if(this._fieldEl)for(let e of document.querySelectorAll(`select#${this.#m} option`))if(""!==e.value){let t=e.selected=this._value.selection.includes(e.value);if(e.value===G.KEY_OTHER&&this.#d){let e=document.getElementById(this.#d);e.style.display=t?"block":"none",e.value=null===this._value.other?"":this._value.other.trim();}}else e.selected=0===this._value.selection.length;}buildField(){if(!this.options)throw new Error("Options have not been set before call to buildField()");const e=document.createElement(j.#p);e.className="form-group",this.#o=e.id=P.nextId,this.#m=P.nextId;const t=e.appendChild(document.createElement("label"));t.htmlFor=this.#m,t.style.display="block",t.innerHTML=this.label;const i=document.createElement("select");if(i.id=this.#m,i.className="custom-select",this.helpText){e.appendChild(document.createElement("small")).innerHTML=this.helpText;}this.placeholder&&this.#f(e,i,"",{label:this.placeholder});for(let t in this.options)this.options.hasOwnProperty(t)&&this.#f(e,i,t,this.options[t]);if(e.appendChild(i),this.validationMessage){const t=e.appendChild(document.createElement("div"));t.className="invalid-feedback",t.innerHTML=this.validationMessage;}e.addEventListener("change",this.inputChangeHandler.bind(this)),this._fieldEl=e;}#f(e,t,i,r){const n=t.appendChild(document.createElement("option"));if(n.value=i,n.innerText=r.label,G.KEY_OTHER===i&&this.includeOtherFreeText){const t=e.appendChild(document.createElement("input"));t.id=this.#d=P.nextId,t.className="form-control";}}inputChangeHandler(e){e.stopPropagation();let t,i={selection:[],other:null};this.#d&&(t=document.getElementById(this.#d));const r=document.querySelectorAll(`select#${this.#m} option:checked`);for(let e of r)""!==e.value&&(i.selection[i.selection.length]=e.value,e.name===G.KEY_OTHER&&this.#d&&(i.other=P.cleanRawInput(t)));this.value=i,this.fireEvent(P.EVENT_CHANGE);}static summariseImpl(e,t,i){const r=t.summary,n=[];if(i[e].selection.length){for(let r of i[e].selection)"other"===r&&i[e].other?n[n.length]=`${t.attributes.options[r].summary||t.attributes.options[r].label} (${i[e].other})`:n[n.length]=t.attributes.options[r].summary||t.attributes.options[r].label;return S(`${r.summaryPrefix} ${C(",","or",n)}`);}return "";}}class $$3 extends P{taxonSearch;#_;#g;#y;#o;#x=null;#v=null;#b=null;_lastInputValue="";#S=[];_value={taxonId:"",taxonName:"",vernacularMatch:!1};static timeoutDelay=50;constructor(e){super(e),this.taxonSearch=new A();}set value(e){let t;e&&e.taxonId?(t=w.fromId(e.taxonId),this._value={taxonId:t.id,taxonName:e.vernacularMatch?t.vernacular:t.nameString,vernacularMatch:e.vernacularMatch}):this._value={taxonId:"",taxonName:e&&e.taxonName?e.taxonName:"",vernacularMatch:null},this.updateView();}get value(){return this._value;}static isEmpty(e){return !e||e&&!e.taxonName;}updateView(){if(this._fieldEl){document.getElementById(this.#_).value=this._value.taxonName,this._lastInputValue=this._value.taxonName;}}markValidity(e){const t=document.getElementById(this.#_);null===e?t.classList.remove("is-invalid","is-valid"):(t.classList.remove(e?"is-invalid":"is-valid"),t.classList.add(e?"is-valid":"is-invalid"));}buildField(){const e=document.createElement("div");e.className="form-group",this.#o=e.id=P.nextId,this.#_=P.nextId;const t=e.appendChild(document.createElement("label"));t.htmlFor=this.#_,t.textContent=this.label;const i=e.appendChild(document.createElement("div"));i.className="dropdown-wrapper";const r=i.appendChild(document.createElement("input"));if(r.className="form-control dropdown-input",r.id=this.#_,r.autocomplete="off",r.spellcheck=!1,this.validationMessage){const e=i.appendChild(document.createElement("div"));e.className="invalid-feedback",e.innerHTML=this.validationMessage;}const n=i.appendChild(document.createElement("div"));if(n.className="dropdown-list",this.#g=n.id=P.nextId,this.#y=P.nextId,this.helpText){e.appendChild(document.createElement("small")).innerHTML=this.helpText;}r.addEventListener("keydown",this.keydownHandler.bind(this)),r.addEventListener("input",this.inputHandler.bind(this)),r.addEventListener("change",this.inputChangeHandler.bind(this)),e.addEventListener("focusin",this.focusHandler.bind(this)),e.addEventListener("focusout",this.blurHandler.bind(this)),n.addEventListener("click",this.dropboxClickHandler.bind(this)),this._fieldEl=e;}keydownHandler(e){switch(this._lastInputValue=e.target.value.trimLeft(),e.key){case"Enter":case"ArrowUp":case"ArrowDown":e.preventDefault();}}inputHandler(e){e.target.value.trimLeft()!==this._lastInputValue&&this.#w(e.target);}keyupHandler(e){!e.key||1!==e.key.length&&"Backspace"!==e.key&&"Delete"!==e.key||this.#w(e.target);}#w(e){let t=P.cleanRawInput(e);this.#x&&clearTimeout(this.#x),t.length>=A.MIN_SEARCH_LENGTH?this.#x=setTimeout(()=>{this.#S=this.taxonSearch.lookup(P.cleanRawInput(document.getElementById(this.#_))),this.refreshSearchResultsList(),this.#x=null;},$$3.timeoutDelay):(this.#S=[],this.refreshSearchResultsList());}focusHandler(e){console.log("focused");const t=document.getElementById(this.#g);if(!t.classList.contains("dropdown-focused")){const e=document.getElementById(this.#_);this.#w(e),t.classList.add("dropdown-focused");}}blurHandler(e){this.#x&&(clearTimeout(this.#x),this.#x=null),setTimeout(()=>{document.getElementById(this.#g).classList.remove("dropdown-focused");},500);}refreshSearchResultsList(){const e=document.getElementById(this.#g);if(this.#S.length){const t=[];let i=0;for(let e of this.#S)t[t.length]=`<a class="list-group-item list-group-item-action" href="#" data-occurrenceId="${e.entityId}" data-resultnumber="${i}">${A.formatter(e)}</a>`,++i;e.innerHTML=`<div class="list-group" id="${this.#y}">${t.join("")}</div>`;}else e.innerHTML="";this.#b=null;}static cleanRawInput(e){return e.value.trim().replace(/\s\s+/g," ");}dropboxClickHandler(e){if(p(e))return;const t=e.target.closest("a");if(this.#v&&(clearTimeout(this.#v),this.#v=null,console.log("cleared a pending change event")),t&&t.dataset.occurrenceid){e.preventDefault();const i=this.#S[t.dataset.resultnumber];this.value={taxonId:i.entityId,taxonName:i.vernacularMatched?i.vernacular:i.qname,vernacularMatch:i.vernacularMatched},this.fireEvent(P.EVENT_CHANGE);}}inputChangeHandler(e){e.stopPropagation(),console.log("got taxon field input change event"),this.#v&&clearTimeout(this.#v),this.#v=setTimeout(()=>{console.log("processing taxon field input change event");const e=this.#S.find(e=>e.exact);e?(console.log("exact match"),this.value={taxonId:e.entityId,taxonName:e.vernacularMatched?e.vernacular:e.qname,vernacularMatch:e.vernacularMatched}):(console.log("no match"),this.value={taxonId:"",taxonName:document.getElementById(this.#_).value.trim(),vernacularMatch:null}),console.log(this._value),this.fireEvent(P.EVENT_CHANGE);},500);}}class H extends P{#T;#o;_value="";_autocomplete="";constructor(e){super(e),e&&(e.options&&(this.options=e.options),e.placeholder&&(this.placeholder=e.placeholder),e.autocomplete&&(this._autocomplete=e.autocomplete));}set value(e){this._value=void 0===e||null==e?"":e.trim(),this.updateView();}get value(){return this._value;}updateView(){if(this._fieldEl){document.getElementById(this.#T).value=P.cleanRawString(this._value);}}buildField(){const e=document.createElement("div");e.className="form-group",this.#o=e.id=P.nextId,this.#T=P.nextId;const t=e.appendChild(document.createElement("label"));t.htmlFor=this.#T,t.textContent=this.label;const i=e.appendChild(document.createElement("textarea"));if(i.className="form-control",i.id=this.#T,this.helpText){e.appendChild(document.createElement("small")).innerHTML=this.helpText;}if(this._autocomplete&&(i.autocomplete=this._autocomplete,"off"===this._autocomplete&&(i.name=x())),this.validationMessage){const t=e.appendChild(document.createElement("div"));t.className="invalid-feedback",t.innerHTML=this.validationMessage;}i.addEventListener("change",this.inputChangeHandler.bind(this)),this._fieldEl=e;}inputChangeHandler(e){e.stopPropagation(),console.log("got text area field input change event"),this.value=P.cleanRawString(document.getElementById(this.#T).value),this.fireEvent(P.EVENT_CHANGE);}static summariseImpl(e,t,i){return ""!==i[e]&&null!==i[e]&&void 0!==i[e]?S(i[e].trim()):"";}}class q{static tetradOffsets={E:[0,8e3],J:[2e3,8e3],P:[4e3,8e3],U:[6e3,8e3],Z:[8e3,8e3],D:[0,6e3],I:[2e3,6e3],N:[4e3,6e3],T:[6e3,6e3],Y:[8e3,6e3],C:[0,4e3],H:[2e3,4e3],M:[4e3,4e3],S:[6e3,4e3],X:[8e3,4e3],B:[0,2e3],G:[2e3,2e3],L:[4e3,2e3],R:[6e3,2e3],W:[8e3,2e3],A:[0,0],F:[2e3,0],K:[4e3,0],Q:[6e3,0],V:[8e3,0]};static quadrantOffsets={NW:[0,5e3],NE:[5e3,5e3],SW:[0,0],SE:[5e3,0]};static letterMapping={A:0,B:1,C:2,D:3,E:4,F:5,G:6,H:7,J:8,K:9,L:10,M:11,N:12,O:13,P:14,Q:15,R:16,S:17,T:18,U:19,V:20,W:21,X:22,Y:23,Z:24};static tetradLetters="ABCDEFGHIJKLMNPQRSTUVWXYZ";preciseGridRef="";length=0;hectad="";tetrad="";tetradLetter="";quadrant="";quadrantCode="";gridCoords=null;error=!1;errorMessage="";set_tetrad(){if(this.tetradLetter=q.tetradLetters.charAt(5*(Math.floor(this.gridCoords.x%1e4/1e3)>>1)+(Math.floor(this.gridCoords.y%1e4/1e3)>>1)),!this.tetradLetter)throw new Error("Failed to get tetrad letter when processing '"+this.preciseGridRef+"', easting="+this.gridCoords.x+" northing="+this.gridCoords.y);this.tetrad=this.hectad+this.tetradLetter;}static get_normalized_precision(e,t){return e>2e3?1e4:e>1e3?2e3:e>100?1e3:e>10?100:e>1?10:t||1;}}const Z=Math.PI/180,X=180/Math.PI;class W{lat;lng;constructor(e,t){this.lat=e,this.lng=t;}static _transform(e,t,i,r,n,o,s,a,l,c,h,u,d,p){const f=1e-6*p;let m=i/Math.sqrt(1-r*(Math.sin(e)*Math.sin(e)));const _=(m+n)*Math.cos(e)*Math.cos(t),g=(m+n)*Math.cos(e)*Math.sin(t),y=((1-r)*m+n)*Math.sin(e),x=h/3600*Z,v=u/3600*Z,b=d/3600*Z,S=_+_*f-g*b+y*v+a,w=_*b+g+g*f-y*x+l,T=-1*_*v+g*x+y+y*f+c;t=Math.atan(w/S);const E=Math.sqrt(S*S+w*w);e=Math.atan(T/(E*(1-s))),m=o/Math.sqrt(1-s*(Math.sin(e)*Math.sin(e)));let N=1,I=0;for(;N>.001;)I=Math.atan((T+s*m*Math.sin(e))/E),N=Math.abs(I-e),e=I;return new W(e,t);}static _Marc(e,t,i,r){return e*((1+t+5/4*(t*t)+5/4*(t*t*t))*(r-i)-(3*t+t*t*3+21/8*(t*t*t))*Math.sin(r-i)*Math.cos(r+i)+(15/8*(t*t)+15/8*(t*t*t))*Math.sin(2*(r-i))*Math.cos(2*(r+i))-35/24*(t*t*t)*Math.sin(3*(r-i))*Math.cos(3*(r+i)));}}class Y extends W{constructor(e,t){super(e,t);}}class J extends W{constructor(e,t){super(e,t);}to_WGS84(){let e=6377563.396,t=.00667054007;const i=this.lat*Z,r=Math.sin(i),n=this.lng*Z,o=e/Math.sqrt(1-t*(r*r)),s=o*Math.cos(i)*Math.cos(n),a=o*Math.cos(i)*Math.sin(n),l=(1-t)*o*r,c=-204894e-10,h=7.28190110241429e-7,u=119748977294801e-20,d=446.448+s*(1+c)+-h*a+u*l,p=408261589226812e-20*s-124.157+a*(1+c)+-h*l,f=542.06+-u*s+h*a+l*(1+c);e=6378137,t=.00669438003;const m=Math.sqrt(d*d+p*p);let _=Math.atan(f/(m*(1-t)));for(let i=1;i<10;++i){let i=Math.sin(_);_=Math.atan((f+t*(e/Math.sqrt(1-t*(i*i)))*i)/m);}return new Y(X*_,X*Math.atan(p/d));}static from_wgs84(e){const t=e.lat*Z,i=e.lng*Z,r=.00669438037928458,n=.0066705397616,o=20.4894*1e-6;let s=6378137/Math.sqrt(1-r*Math.sin(t)*Math.sin(t));const a=(s+0)*Math.cos(t)*Math.cos(i),l=(s+0)*Math.cos(t)*Math.sin(i),c=((1-r)*s+0)*Math.sin(t),h=-.1502/3600*Z,u=-.247/3600*Z,d=-.8421/3600*Z,p=a+a*o-l*d+c*u-446.448,f=a*d+l+l*o-c*h+125.157,m=-1*a*u+l*h+c+c*o+-542.06,_=Math.atan(f/p),g=Math.sqrt(p*p+f*f);let y=Math.atan(m/(g*(1-n)));s=6377563.396/Math.sqrt(1-n*(Math.sin(y)*Math.sin(y)));let x=1,v=0;for(;x>.001;)v=Math.atan((m+n*s*Math.sin(y))/g),x=Math.abs(v-y),y=v;return new J(y*X,_*X);}}class K extends W{constructor(e,t){super(e,t);}to_WGS84(){const e=W._transform(this.lat*Z,this.lng*Z,6377340.189,.00667054015,0,6378137,.00669438037928458,482.53,-130.596,564.557,-1.042,-.214,-.631,-8.15);return new Y(e.lat*X,e.lng*X);}static from_wgs84(e){const t=e.lat*Z,i=e.lng*Z,r=W._transform(t,i,6378137,.00669438037928458,0,6377340.189,.00667054015,-482.53,130.596,-564.557,1.042,.214,.631,8.15);return new K(r.lat*X,r.lng*X);}}class Q extends W{constructor(e,t){super(e,t);}static from_wgs84(e){const t=e.lat*Z,i=e.lng*Z,r=W._transform(t,i,6378137,.00669438037928458,0,6378388,.0067226700223333,83.901,98.127,118.635,0,0,0,0);return new Q(r.lat*X,r.lng*X);}}class ee{x;y;constructor(){}to_latLng(){}to_gridref(e){}static tetradLetters="ABCDEFGHIJKLMNPQRSTUVWXYZ";static tetradLettersRowFirst="AFKQVBGLRWCHMSXDINTYEJPUZ";static from_latlng(e,t){if(t>=-8.74&&e>49.88){const i=ee._from_gb_latlng(J.from_wgs84(new Y(e,t)));if(i.x>=0&&i.is_gb_hectad())return i;}if(t<-5.3&&e>51.34&&t>-11&&e<55.73){const i=ee._from_ie_latlng(K.from_wgs84(new Y(e,t)));return i.x<0||i.y<0?null:i;}{const i=ee._from_ci_latlng(Q.from_wgs84(new Y(e,t)));if(i.x>=5e5&&i.x<6e5&&i.y>=54e5&&i.y<56e5)return i;}return null;}static _from_gb_latlng(e){const t=e.lat*Z,i=e.lng*Z,r=.0066705397616,n=Math.sin(t)*Math.sin(t),o=6375020.480988971/Math.sqrt(1-r*n),s=o*(1-r)/(1-r*n),a=o/s-1,l=i- -.03490658503988659,c=o*Math.cos(t),h=Math.pow(Math.cos(t),3),u=Math.tan(t)*Math.tan(t),d=o/6*h*(o/s-u),p=Math.pow(Math.cos(t),5),f=Math.pow(Math.tan(t),4),m=o/120*p*(5-18*u+f+14*a-58*u*a),_=4e5+l*c+Math.pow(l,3)*d+Math.pow(l,5)*m,g=W._Marc(6353722.490487913,.0016732202503250907,.8552113334772214,t)+-1e5,y=o/2*Math.sin(t)*Math.cos(t),x=o/24*Math.sin(t)*Math.pow(Math.cos(t),3)*(5-Math.pow(Math.tan(t),2)+9*a),v=o/720*Math.sin(t)*p*(61-58*u+f),b=g+l*l*y+Math.pow(l,4)*x+Math.pow(l,6)*v;return new ie(Math.round(_),Math.round(b));}static _from_ie_latlng(e){const t=e.lat*Z,i=e.lng*Z,r=.00667054015,n=Math.sin(t)*Math.sin(t),o=6377563.395906615/Math.sqrt(1-r*n),s=o*(1-r)/(1-r*n),a=o/s-1,l=i- -.13962634015954636,c=o*Math.cos(t),h=Math.pow(Math.cos(t),3),u=Math.tan(t)*Math.tan(t),d=o/6*h*(o/s-u),p=Math.pow(Math.cos(t),5),f=Math.pow(Math.tan(t),4),m=o/120*p*(5-18*u+f+14*a-58*u*a),_=2e5+l*c+Math.pow(l,3)*d+Math.pow(l,5)*m,g=W._Marc(6356256.908205645,.0016732203841520518,.9337511498169663,t)+25e4,y=o/2*Math.sin(t)*Math.cos(t),x=o/24*Math.sin(t)*Math.pow(Math.cos(t),3)*(5-Math.pow(Math.tan(t),2)+9*a),v=o/720*Math.sin(t)*p*(61-58*u+f),b=g+l*l*y+Math.pow(l,4)*x+Math.pow(l,6)*v;return new re(Math.round(_),Math.round(b));}static _from_ci_latlng(e){const t=e.lat*Z,i=e.lng*Z,r=.0067226700223333,n=Math.sin(t)*Math.sin(t),o=6375836.6448/Math.sqrt(1-r*n),s=o*(1-r)/(1-r*n),a=o/s-1,l=i- -.0523598775598,c=o*Math.cos(t),h=Math.pow(Math.cos(t),3),u=Math.tan(t)*Math.tan(t),d=o/6*h*(o/s-u),p=Math.pow(Math.cos(t),5),f=Math.pow(Math.tan(t),4),m=o/120*p*(5-18*u+f+14*a-58*u*a),_=5e5+l*c+Math.pow(l,3)*d+Math.pow(l,5)*m,g=W._Marc(6354369.181221601,.0016863406508729017,0,t)+0,y=o/2*Math.sin(t)*Math.cos(t),x=o/24*Math.sin(t)*Math.pow(Math.cos(t),3)*(5-Math.pow(Math.tan(t),2)+9*a),v=o/720*Math.sin(t)*p*(61-58*u+f),b=g+l*l*y+Math.pow(l,4)*x+Math.pow(l,6)*v;return new ne(Math.round(_),Math.round(b));}static calculate_tetrad(e,t){return e>=0&&t>=0?ee.tetradLetters.charAt(5*Math.floor(e%1e4/2e3)+Math.floor(t%1e4/2e3)):"";}toString(){return this.x+","+this.y;}}const te=function(e,t,i,r){let n="00000"+Math.floor(t),o="00000"+Math.floor(i);if(2e3===r)return e+n.charAt(n.length-5)+o.charAt(o.length-5)+ee.calculate_tetrad(t,i);if(1e5===r)return e;{5e3===r&&(r=1e4);let t=Math.round(Math.log10(r));return e+(t?n.slice(-5,-t)+o.slice(-5,-t):n.slice(-5)+o.slice(-5));}};class ie extends ee{gridCoords=null;constructor(e,t){super(),this.x=e,this.y=t;}country="GB";static gbHectads="SV80SV81SV90SV91SW32SW33SW42SW43SW44SW52SW53SW54SW61SW62SW63SW64SW65SW71SW72SW73SW74SW75SW76SW81SW82SW83SW84SW85SW86SW87SW95SW96SW97SS10SS11SS20SS21SS30SW83SW84SW85SW93SW94SW95SW96SW97SW98SX03SX04SX05SX06SX07SX08SX09SX14SX15SX16SX17SX18SX19SX25SX26SX27SX28SX29SX35SX36SX37SX38SX39SX44SX45SX46SX47SS70SS80SS81SS90SS91ST00ST01ST10ST11ST20ST21ST30SX37SX44SX45SX46SX47SX48SX54SX55SX56SX57SX58SX63SX64SX65SX66SX67SX68SX69SX73SX74SX75SX76SX77SX78SX79SX83SX84SX85SX86SX87SX88SX89SX94SX95SX96SX97SX98SX99SY07SY08SY09SY18SY19SY28SY29SY38SY39SS14SS20SS21SS22SS30SS31SS32SS40SS41SS42SS43SS44SS50SS51SS52SS53SS54SS60SS61SS62SS63SS64SS70SS71SS72SS73SS74SS75SS80SS81SS82SS83SS91SS92ST01ST02SX28SX29SX37SX38SX39SX48SX49SX58SX59SX68SX69SX79SS73SS74SS82SS83SS84SS92SS93SS94ST01ST02ST03ST04ST11ST12ST13ST14ST20ST21ST22ST23ST24ST25ST30ST31ST32ST33ST34ST40ST41ST42ST50ST51ST52ST61ST62ST71ST72ST24ST25ST26ST32ST33ST34ST35ST36ST37ST42ST43ST44ST45ST46ST47ST52ST53ST54ST55ST56ST57ST62ST63ST64ST65ST66ST67ST72ST73ST74ST75ST76ST77ST83ST84ST85ST86SP00SP10ST76ST77ST85ST86ST87ST88ST89ST96ST97ST98ST99SU06SU07SU08SU09SU16SU17SU18SU19SU26SU27SU28SU29SU36SU37ST73ST74ST75ST76ST82ST83ST84ST85ST86ST91ST92ST93ST94ST95ST96SU01SU02SU03SU04SU05SU06SU11SU12SU13SU14SU15SU16SU21SU22SU23SU24SU25SU26SU31SU32SU34SU35SU36ST20ST30ST40ST50ST51ST60ST61ST70ST71ST72ST73ST80ST81ST82ST83ST90ST91ST92SU00SU01SU02SU10SU11SY39SY48SY49SY58SY59SY66SY67SY68SY69SY77SY78SY79SY87SY88SY89SY97SY98SY99SZ07SZ08SZ09SZ28SZ38SZ39SZ47SZ48SZ49SZ57SZ58SZ59SZ68SZ69SU00SU01SU02SU10SU11SU12SU20SU21SU22SU23SU30SU31SU32SU33SU40SU41SU42SU43SU50SU51SU52SU60SU61SU62SU70SU71SU72SZ08SZ09SZ19SZ29SZ38SZ39SZ49SZ59SZ69SZ79SU23SU24SU25SU33SU34SU35SU36SU42SU43SU44SU45SU46SU52SU53SU54SU55SU56SU62SU63SU64SU65SU66SU72SU73SU74SU75SU76SU82SU83SU84SU85SU86SU70SU71SU72SU80SU81SU82SU83SU90SU91SU92SU93SZ79SZ89SZ99TQ00TQ01TQ02TQ03TQ10TQ11TQ12TQ13TQ20TQ21TQ22TQ23TQ30TQ31TQ32TQ20TQ21TQ22TQ23TQ30TQ31TQ32TQ33TQ40TQ41TQ42TQ43TQ44TQ50TQ51TQ52TQ53TQ54TQ60TQ61TQ62TQ63TQ70TQ71TQ72TQ80TQ81TQ82TQ91TQ92TV49TV59TV69TQ65TQ72TQ73TQ74TQ75TQ76TQ77TQ82TQ83TQ84TQ85TQ86TQ87TQ91TQ92TQ93TQ94TQ95TQ96TQ97TR01TR02TR03TR04TR05TR06TR07TR12TR13TR14TR15TR16TR23TR24TR25TR26TR27TR33TR34TR35TR36TR37TR46TR47TQ35TQ36TQ37TQ38TQ43TQ44TQ45TQ46TQ47TQ48TQ53TQ54TQ55TQ56TQ57TQ58TQ63TQ64TQ65TQ66TQ67TQ72TQ73TQ74TQ75TQ76TQ77TQ78TQ87TQ88TQ97SU83SU84SU85SU86SU93SU94SU95SU96SU97TQ03TQ04TQ05TQ06TQ07TQ13TQ14TQ15TQ16TQ17TQ23TQ24TQ25TQ26TQ27TQ33TQ34TQ35TQ36TQ37TQ38TQ43TQ44TQ45TL30TL40TL50TL60TL70TL80TL90TM00TQ38TQ39TQ47TQ48TQ49TQ57TQ58TQ59TQ67TQ68TQ69TQ77TQ78TQ79TQ88TQ89TQ98TQ99TR08TR09TR19TL30TL31TL34TL40TL41TL42TL43TL44TL50TL51TL52TL53TL54TL60TL61TL62TL63TL64TL70TL71TL72TL73TL74TL80TL81TL82TL83TL84TL90TL91TL92TL93TM01TM02TM03TM11TM12TM13TM21TM22TM23TQ49SP81SP90SP91TL00TL01TL02TL10TL11TL12TL13TL20TL21TL22TL23TL24TL30TL31TL32TL33TL34TL41TL42TL43TL44TL51TL52TQ09TQ19TQ29TQ39TL20TL30TQ06TQ07TQ08TQ09TQ16TQ17TQ18TQ19TQ27TQ28TQ29TQ37TQ38TQ39SP20SP30SP40SP41SP50SU19SU26SU27SU28SU29SU36SU37SU38SU39SU46SU47SU48SU49SU56SU57SU58SU59SU66SU67SU68SU69SU76SU77SU78SU86SU87SU88SU96SU97SU98SP10SP20SP21SP22SP23SP30SP31SP32SP33SP34SP40SP41SP42SP43SP44SP45SP50SP51SP52SP53SP54SP60SP61SP62SP63SP70SU29SU39SU49SU57SU58SU59SU67SU68SU69SU77SU78SU79SP51SP53SP60SP61SP62SP63SP64SP70SP71SP72SP73SP74SP80SP81SP82SP83SP84SP85SP90SP91SP92SP93SP94SP95SU78SU79SU88SU89SU97SU98SU99TL00TL01TQ07TQ08TQ09TG40TG50TM03TM04TM05TM06TM07TM13TM14TM15TM16TM17TM23TM24TM25TM26TM27TM28TM33TM34TM35TM36TM37TM38TM39TM44TM45TM46TM47TM48TM49TM57TM58TM59TL64TL65TL66TL67TL68TL74TL75TL76TL77TL78TL83TL84TL85TL86TL87TL88TL93TL94TL95TL96TL97TL98TM03TM04TM05TM06TM07TM08TG00TG01TG02TG03TG04TG10TG11TG12TG13TG14TG20TG21TG22TG23TG24TG30TG31TG32TG33TG40TG41TG42TG50TG51TM07TM08TM09TM17TM18TM19TM27TM28TM29TM38TM39TM49TM59TF40TF41TF42TF50TF51TF52TF53TF60TF61TF62TF63TF64TF70TF71TF72TF73TF74TF80TF81TF82TF83TF84TF90TF91TF92TF93TF94TG00TG01TG02TG03TG04TL49TL59TL68TL69TL78TL79TL87TL88TL89TL98TL99TM07TM08TM09TF20TF30TF31TF40TF41TF50TL15TL19TL23TL24TL25TL26TL28TL29TL33TL34TL35TL36TL37TL38TL39TL44TL45TL46TL47TL48TL49TL54TL55TL56TL57TL58TL59TL63TL64TL65TL66TL67TL68TL69TL75TL76SP91SP92SP93SP94SP95SP96TL01TL02TL03TL04TL05TL06TL07TL11TL12TL13TL14TL15TL16TL23TL24TL25TL06TL07TL08TL09TL15TL16TL17TL18TL19TL25TL26TL27TL28TL29TL36TL37TL38TL39SK90SP43SP44SP45SP46SP53SP54SP55SP56SP57SP58SP63SP64SP65SP66SP67SP68SP73SP74SP75SP76SP77SP78SP79SP84SP85SP86SP87SP88SP89SP95SP96SP97SP98SP99TF00TF10TF20TL06TL07TL08TL09TL18TL19TL29SO70SO71SO80SO81SO82SO83SO90SO91SO92SO93SO94SP00SP01SP02SP03SP04SP10SP11SP12SP13SP14SP15SP20SP21SP22SP23SP24SP25ST99SU09SU19SU29SO50SO51SO60SO61SO62SO63SO70SO71SO72SO73SO80SO81SO82SO83SO90ST57ST58ST59ST66ST67ST68ST69ST76ST77ST78ST79ST87ST88ST89ST98ST99SO10SO11SO20SO21SO22SO23SO30SO31SO32SO40SO41SO42SO50SO51ST18ST19ST27ST28ST29ST37ST38ST39ST47ST48ST49ST58ST59SO22SO23SO24SO25SO26SO32SO33SO34SO35SO36SO37SO41SO42SO43SO44SO45SO46SO47SO51SO52SO53SO54SO55SO56SO57SO61SO62SO63SO64SO65SO66SO73SO74SO75SO76SO56SO64SO65SO66SO67SO72SO73SO74SO75SO76SO77SO78SO82SO83SO84SO85SO86SO87SO88SO93SO94SO95SO96SO97SO98SO99SP03SP04SP05SP06SP07SP08SP13SP14SP16SP17SP18SK10SK20SK30SP04SP05SP06SP07SP08SP09SP14SP15SP16SP17SP18SP19SP22SP23SP24SP25SP26SP27SP28SP29SP33SP34SP35SP36SP37SP38SP39SP44SP45SP46SP47SP48SP49SP55SP56SP57SP58SJ63SJ70SJ71SJ72SJ73SJ74SJ75SJ80SJ81SJ82SJ83SJ84SJ85SJ86SJ90SJ91SJ92SJ93SJ94SJ95SJ96SK00SK01SK02SK03SK04SK05SK06SK10SK11SK12SK13SK14SK15SK16SK20SK21SK22SO77SO78SO79SO88SO89SO98SO99SP08SP09SP19SP29SJ20SJ21SJ22SJ23SJ30SJ31SJ32SJ33SJ34SJ40SJ41SJ42SJ43SJ50SJ51SJ52SJ53SJ54SJ60SJ61SJ62SJ63SJ64SJ70SJ71SJ72SJ73SJ74SJ80SO17SO18SO27SO28SO29SO37SO38SO39SO46SO47SO48SO49SO56SO57SO58SO59SO66SO67SO68SO69SO77SO78SO79SO88SO89SN50SN60SN61SN70SN71SN80SN81SN90SO00SO01SO10SO11SS38SS39SS48SS49SS58SS59SS68SS69SS77SS78SS79SS87SS88SS89SS96SS97SS98SS99ST06ST07ST08ST09ST16ST17ST18ST19ST26ST27ST28SN70SN71SN74SN80SN81SN82SN83SN84SN85SN86SN90SN91SN92SN93SN94SN95SN96SO00SO01SO02SO03SO04SO05SO06SO10SO11SO12SO13SO14SO21SO22SO23SO24SN86SN87SN96SN97SO04SO05SO06SO07SO08SO13SO14SO15SO16SO17SO18SO24SO25SO26SO27SO36SO37SN01SN02SN10SN11SN12SN20SN21SN22SN23SN24SN30SN31SN32SN33SN34SN40SN41SN42SN43SN44SN50SN51SN52SN53SN54SN60SN61SN62SN63SN64SN65SN71SN72SN73SN74SN75SN81SN82SN83SN84SS39SS49SS59SM50SM62SM70SM71SM72SM73SM80SM81SM82SM83SM84SM90SM91SM92SM93SM94SN00SN01SN02SN03SN04SN10SN11SN12SN13SN14SN22SN23SN24SR89SR99SS09SS19SN14SN15SN24SN25SN33SN34SN35SN36SN44SN45SN46SN54SN55SN56SN57SN58SN64SN65SN66SN67SN68SN69SN74SN75SN76SN77SN78SN79SN84SN85SN86SN87SN88SN89SH70SH71SH80SH81SH90SH91SH92SJ00SJ01SJ02SJ03SJ10SJ11SJ12SJ20SJ21SJ22SJ31SN69SN78SN79SN87SN88SN89SN97SN98SN99SO07SO08SO09SO18SO19SO28SO29SO39SH50SH51SH52SH53SH54SH60SH61SH62SH63SH64SH70SH71SH72SH73SH74SH80SH81SH82SH83SH84SH91SH92SH93SH94SH95SJ03SJ04SJ05SJ13SJ14SN59SN69SN79SH12SH13SH22SH23SH24SH32SH33SH34SH43SH44SH45SH46SH53SH54SH55SH56SH57SH64SH65SH66SH67SH74SH75SH76SH77SH78SH84SH85SH86SH87SH88SH74SH75SH76SH77SH84SH85SH86SH87SH88SH94SH95SH96SH97SH98SJ02SJ03SJ04SJ05SJ06SJ07SJ08SJ12SJ13SJ14SJ15SJ16SJ17SJ22SJ23SJ24SJ25SJ26SJ33SJ34SJ35SJ43SJ44SJ45SJ53SJ54SH97SH98SJ06SJ07SJ08SJ15SJ16SJ17SJ18SJ25SJ26SJ27SJ35SJ36SJ37SH27SH28SH29SH36SH37SH38SH39SH46SH47SH48SH49SH56SH57SH58SH59SH67SH68SK81SK82SK83SK84SK85SK86SK87SK90SK91SK92SK93SK94SK95SK96SK97TF00TF01TF02TF03TF04TF05TF06TF07TF10TF11TF12TF13TF14TF15TF16TF17TF20TF21TF22TF23TF24TF25TF30TF31TF32TF33TF34TF41TF42TF43TF44TF52SE60SE70SE71SE80SE81SE82SE90SE91SE92SK78SK79SK87SK88SK89SK97SK98SK99TA00TA01TA02TA10TA11TA12TA20TA21TA30TA31TA40TF07TF08TF09TF15TF16TF17TF18TF19TF24TF25TF26TF27TF28TF29TF33TF34TF35TF36TF37TF38TF39TF43TF44TF45TF46TF47TF48TF49TF54TF55TF56TF57TF58SK20SK21SK30SK31SK32SK40SK41SK42SK43SK50SK51SK52SK60SK61SK62SK70SK71SK72SK73SK74SK80SK81SK82SK83SK84SK90SK91SP39SP48SP49SP57SP58SP59SP68SP69SP78SP79SP89SP99TF00TF01SE60SE70SK42SK43SK44SK45SK46SK52SK53SK54SK55SK56SK57SK58SK59SK62SK63SK64SK65SK66SK67SK68SK69SK72SK73SK74SK75SK76SK77SK78SK79SK84SK85SK86SK87SK88SK89SK97SJ98SJ99SK03SK06SK07SK08SK09SK11SK12SK13SK14SK15SK16SK17SK18SK19SK21SK22SK23SK24SK25SK26SK27SK28SK31SK32SK33SK34SK35SK36SK37SK38SK42SK43SK44SK45SK46SK47SK48SK53SK56SK57SD90SE00SE10SJ18SJ19SJ27SJ28SJ29SJ35SJ36SJ37SJ38SJ39SJ44SJ45SJ46SJ47SJ48SJ54SJ55SJ56SJ57SJ58SJ63SJ64SJ65SJ66SJ67SJ68SJ69SJ74SJ75SJ76SJ77SJ78SJ79SJ85SJ86SJ87SJ88SJ89SJ96SJ97SJ98SJ99SK06SK07SK08SK09SK19SD20SD21SD22SD30SD31SD32SD40SD41SD42SD50SD51SD52SD53SD60SD61SD62SD63SD70SD71SD72SD73SD74SD80SD81SD82SD83SD84SD90SD91SD92SD93SD94SJ29SJ38SJ39SJ48SJ49SJ58SJ59SJ68SJ69SJ79SJ88SJ89SJ99SD22SD23SD32SD33SD34SD35SD36SD42SD43SD44SD45SD46SD47SD52SD53SD54SD55SD56SD57SD63SD64SD65SD66SD67SD68SD73SD78SE53SE54SE62SE63SE64SE65SE72SE73SE74SE75SE76SE82SE83SE84SE85SE86SE87SE92SE93SE94SE95SE96SE97SE98TA02TA03TA04TA05TA06TA07TA08TA12TA13TA14TA15TA16TA17TA18TA21TA22TA23TA24TA26TA27TA31TA32TA33TA41TA42NZ30NZ31NZ40NZ41NZ42NZ50NZ51NZ52NZ60NZ61NZ62NZ70NZ71NZ72NZ80NZ81NZ90NZ91SE37SE38SE39SE46SE47SE48SE49SE55SE56SE57SE58SE59SE64SE65SE66SE67SE68SE69SE75SE76SE77SE78SE79SE86SE87SE88SE89SE97SE98SE99TA08TA09TA18SD84SD90SD91SD92SD93SD94SD95SE00SE01SE02SE03SE04SE10SE11SE12SE13SE14SE20SE21SE22SE23SE30SE31SE32SE33SE40SE41SE42SE50SE51SE52SE60SE61SE62SE70SE71SE72SE81SE82SK18SK19SK28SK29SK38SK39SK47SK48SK49SK57SK58SK59SK69SD54SD55SD64SD65SD66SD67SD68SD73SD74SD75SD76SD77SD78SD84SD85SD86SD87SD88SD94SD95SD96SD97SD98SE04SE05SE06SE07SE13SE14SE15SE16SE17SE23SE24SE25SE26SE27SE32SE33SE34SE35SE36SE37SE42SE43SE44SE45SE46SE52SE53SE54SE55SE56SE62SE63SE64SE65SE72NY72NY80NY81NY82NY90NY91NY92NZ00NZ01NZ02NZ10NZ11NZ20NZ21NZ30NZ31SD68SD69SD78SD79SD88SD89SD97SD98SD99SE07SE08SE09SE17SE18SE19SE27SE28SE29SE36SE37SE38SE39SE46SE47NY73NY74NY82NY83NY84NY92NY93NY94NY95NZ01NZ02NZ03NZ04NZ05NZ11NZ12NZ13NZ14NZ15NZ16NZ20NZ21NZ22NZ23NZ24NZ25NZ26NZ30NZ31NZ32NZ33NZ34NZ35NZ36NZ41NZ42NZ43NZ44NZ45NZ46NZ52NZ53NT60NT70NT80NT90NU00NU10NU20NY58NY59NY64NY65NY66NY67NY68NY69NY74NY75NY76NY77NY78NY79NY84NY85NY86NY87NY88NY89NY94NY95NY96NY97NY98NY99NZ04NZ05NZ06NZ07NZ08NZ09NZ15NZ16NZ17NZ18NZ19NZ26NZ27NZ28NZ29NZ36NZ37NZ38NZ39NT70NT71NT73NT80NT81NT82NT83NT84NT90NT91NT92NT93NT94NT95NU00NU01NU02NU03NU04NU05NU10NU11NU12NU13NU14NU20NU21NU22NU23NZ09NZ19NY20NY21NY30NY31NY40NY41NY42NY50NY51NY52NY53NY60NY61NY62NY63NY70NY71NY72NY73NY80NY81NY82NY83SD16SD17SD18SD19SD26SD27SD28SD29SD36SD37SD38SD39SD46SD47SD48SD49SD57SD58SD59SD67SD68SD69SD78SD79SD89NX90NX91NX92NX93NY00NY01NY02NY03NY04NY05NY10NY11NY12NY13NY14NY15NY16NY20NY21NY22NY23NY24NY25NY26NY31NY32NY33NY34NY35NY36NY37NY41NY42NY43NY44NY45NY46NY47NY48NY52NY53NY54NY55NY56NY57NY58NY62NY63NY64NY65NY66NY67NY68NY73NY74NY75NY84SD08SD09SD17SD18SD19SD28SD29NX30NX40SC16SC17SC26SC27SC28SC36SC37SC38SC39SC47SC48SC49NS60NS61NS70NS71NS72NS80NS81NS90NT00NT01NT10NT11NT20NT21NT30NX69NX78NX79NX88NX89NX96NX97NX98NX99NY05NY06NY07NY08NY09NY16NY17NY18NY19NY26NY27NY28NY29NY36NY37NY38NY39NY47NY48NY49NS50NS60NX36NX37NX38NX45NX46NX47NX48NX49NX54NX55NX56NX57NX58NX59NX64NX65NX66NX67NX68NX69NX74NX75NX76NX77NX78NX79NX84NX85NX86NX87NX88NX95NX96NX97NX98NY05NY06NW95NW96NW97NX03NX04NX05NX06NX07NX13NX14NX15NX16NX17NX24NX25NX26NX27NX33NX34NX35NX36NX37NX43NX44NX45NX46NS00NS10NS14NS15NS16NS20NS21NS23NS24NS25NS26NS30NS31NS32NS33NS34NS35NS36NS40NS41NS42NS43NS44NS45NS50NS51NS52NS53NS54NS55NS60NS61NS62NS63NS64NS71NS72NS73NX07NX08NX09NX17NX18NX19NX27NX28NX29NX37NX38NX39NX48NX49NX59NS16NS17NS26NS27NS35NS36NS37NS44NS45NS46NS47NS54NS55NS56NS64NS65NS66NS53NS54NS55NS56NS57NS63NS64NS65NS66NS67NS71NS72NS73NS74NS75NS76NS77NS80NS81NS82NS83NS84NS85NS86NS87NS90NS91NS92NS93NS94NS95NS96NT00NT01NT02NT03NT04NT05NT14NT01NT02NT03NT04NT05NT11NT12NT13NT14NT15NT21NT22NT23NT24NT25NT32NT33NT34NT10NT11NT20NT21NT22NT23NT30NT31NT32NT33NT34NT41NT42NT43NT44NT53NT20NT30NT31NT40NT41NT42NT43NT44NT50NT51NT52NT53NT54NT60NT61NT62NT63NT64NT70NT71NT72NT73NT74NT81NT82NT83NY39NY47NY48NY49NY58NY59NY69NT44NT45NT46NT53NT54NT55NT56NT63NT64NT65NT66NT73NT74NT75NT76NT77NT83NT84NT85NT86NT87NT94NT95NT96NT36NT37NT45NT46NT47NT48NT55NT56NT57NT58NT65NT66NT67NT68NT76NT77NS95NS96NT05NT06NT15NT16NT17NT24NT25NT26NT27NT34NT35NT36NT37NT43NT44NT45NT46NS86NS87NS95NS96NS97NS98NT06NT07NT08NT16NT17NO00NO01NO10NO11NO20NO21NO22NO30NO31NO32NO40NO41NO42NO50NO51NO52NO60NO61NS99NT08NT09NT18NT19NT28NT29NT39NT49NT59NT69NN30NN31NN40NN41NS38NS39NS47NS48NS49NS57NS58NS59NS67NS68NS69NS77NS78NS79NS86NS87NS88NS89NS97NS98NN21NN22NN30NN31NN32NN40NN41NN42NN50NN51NN52NN60NN61NN70NN71NN80NN81NN90NN91NO00NS49NS59NS69NS79NS88NS89NS98NS99NT08NT09NN22NN23NN32NN33NN34NN35NN42NN43NN44NN45NN46NN47NN51NN52NN53NN54NN55NN56NN57NN61NN62NN63NN64NN65NN66NN67NN71NN72NN73NN74NN75NN76NN77NN81NN82NN83NN84NN85NN86NN90NN91NN92NN93NN94NN95NN96NO00NO01NO02NO03NO04NO11NO12NO13NO21NN56NN57NN66NN67NN68NN76NN77NN78NN86NN87NN88NN94NN95NN96NN97NN98NO02NO03NO04NO05NO06NO07NO08NO11NO12NO13NO14NO15NO16NO17NO21NO22NO23NO24NO25NO32NO33NO34NO15NO16NO17NO23NO24NO25NO26NO27NO28NO32NO33NO34NO35NO36NO37NO38NO42NO43NO44NO45NO46NO47NO48NO53NO54NO55NO56NO57NO58NO63NO64NO65NO66NO67NO74NO75NO76NJ60NJ70NJ80NJ90NO57NO58NO66NO67NO68NO69NO76NO77NO78NO79NO86NO87NO88NO89NO99NH90NJ00NJ10NJ11NJ20NJ21NJ30NJ31NJ32NJ40NJ41NJ42NJ50NJ51NJ52NJ60NJ61NJ62NJ70NJ71NJ72NJ80NJ81NJ82NJ90NJ91NJ92NK02NN98NN99NO07NO08NO09NO17NO18NO19NO27NO28NO29NO37NO38NO39NO48NO49NO58NO59NO68NO69NO79NO89NJ31NJ32NJ33NJ34NJ42NJ43NJ44NJ52NJ53NJ54NJ55NJ62NJ63NJ64NJ65NJ72NJ73NJ74NJ75NJ76NJ82NJ83NJ84NJ85NJ86NJ92NJ93NJ94NJ95NJ96NK02NK03NK04NK05NK06NK13NK14NK15NH90NJ00NJ01NJ10NJ11NJ12NJ13NJ14NJ21NJ22NJ23NJ24NJ25NJ32NJ33NJ34NJ35NJ36NJ42NJ43NJ44NJ45NJ46NJ54NJ55NJ56NJ64NJ65NJ66NJ74NJ75NJ76NJ86NN99NH72NH81NH82NH91NH92NH93NH94NH95NH96NJ00NJ01NJ02NJ03NJ04NJ05NJ06NJ11NJ12NJ13NJ14NJ15NJ16NJ17NJ23NJ24NJ25NJ26NJ27NJ34NJ35NJ36NJ45NH01NH02NH10NH11NH12NH13NH14NH20NH21NH22NH23NH24NH30NH31NH32NH33NH34NH40NH41NH42NH43NH44NH50NH51NH52NH53NH54NH60NH61NH62NH63NH64NH70NH71NH72NH73NH74NH75NH80NH81NH82NH83NH84NH85NH90NH91NH92NH93NH94NH95NH96NJ00NJ01NN39NN46NN47NN48NN49NN56NN57NN58NN59NN67NN68NN69NN77NN78NN79NN88NN89NN98NN99NG60NG70NG71NG72NG80NG81NG82NG90NG91NH00NH01NH10NH20NH30NM46NM47NM54NM55NM56NM57NM64NM65NM66NM67NM68NM69NM74NM75NM76NM77NM78NM79NM84NM85NM86NM87NM88NM89NM95NM96NM97NM98NM99NN05NN06NN07NN08NN09NN16NN17NN18NN19NN26NN27NN28NN29NN35NN36NN37NN38NN39NN46NN47NN48NN49NN57NN58NN59NM70NM71NM72NM73NM80NM81NM82NM83NM84NM90NM91NM92NM93NM94NM95NN00NN01NN02NN03NN04NN05NN10NN11NN12NN13NN14NN15NN16NN20NN21NN22NN23NN24NN25NN26NN30NN33NN34NN35NN36NN44NN45NN46NR79NR88NR89NR96NR97NR98NR99NS06NS07NS08NS09NS16NS17NS18NS19NS28NS29NN20NN21NN30NN31NS28NS29NS37NS38NS39NS46NS47NS48NS56NS57NR82NR83NR84NR92NR93NR94NR95NR96NR97NS01NS02NS03NS04NS05NS06NS07NS15NS16NR50NR51NR60NR61NR62NR63NR64NR65NR67NR68NR70NR71NR72NR73NR74NR75NR76NR77NR78NR79NR83NR84NR85NR86NR87NR88NR89NR95NR96NM40NM60NM61NM70NM71NR15NR16NR24NR25NR26NR27NR34NR35NR36NR37NR38NR39NR44NR45NR46NR47NR48NR49NR56NR57NR58NR59NR67NR68NR69NR79NL93NL94NM04NM05NM15NM16NM21NM22NM23NM24NM25NM26NM31NM32NM33NM34NM35NM41NM42NM43NM44NM45NM51NM52NM53NM54NM55NM61NM62NM63NM64NM72NM73NG13NG14NG15NG20NG23NG24NG25NG26NG30NG31NG32NG33NG34NG35NG36NG37NG38NG40NG41NG42NG43NG44NG45NG46NG47NG50NG51NG52NG53NG54NG55NG56NG60NG61NG62NG63NG64NG65NG66NG71NG72NG82NM19NM29NM37NM38NM39NM47NM48NM49NM59NB90NB91NC00NC01NC10NC11NC20NC21NG63NG64NG65NG72NG73NG74NG75NG76NG77NG78NG79NG82NG83NG84NG85NG86NG87NG88NG89NG91NG92NG93NG94NG95NG96NG97NG98NG99NH00NH01NH02NH03NH04NH05NH06NH07NH08NH09NH10NH11NH15NH16NH17NH18NH19NH27NH28NH29NC10NC20NC21NC30NC31NC40NH02NH03NH04NH05NH06NH07NH12NH13NH14NH15NH16NH17NH19NH23NH24NH25NH26NH27NH28NH29NH34NH35NH36NH37NH38NH39NH44NH45NH46NH47NH48NH49NH54NH55NH56NH57NH58NH59NH64NH65NH66NH67NH68NH69NH75NH76NH77NH78NH86NH87NH88NH97NH98NC22NC30NC31NC32NC33NC40NC41NC42NC43NC50NC51NC52NC60NC61NC62NC63NC70NC71NC72NC73NC74NC80NC81NC82NC83NC84NC90NC91NC92NC93ND01ND02NH49NH59NH68NH69NH78NH79NH88NH89NC01NC02NC03NC10NC11NC12NC13NC14NC15NC16NC20NC21NC22NC23NC24NC25NC26NC27NC31NC32NC33NC34NC35NC36NC37NC42NC43NC44NC45NC46NC52NC53NC54NC55NC56NC62NC63NC64NC65NC66NC73NC74NC75NC76NC83NC84NC85NC86NC93NC94NC95NC96NC92NC93NC94NC95NC96ND01ND02ND03ND04ND05ND06ND07ND12ND13ND14ND15ND16ND17ND23ND24ND25ND26ND27ND33ND34ND35ND36ND37ND47HW63HW83HX62NA00NA10NA64NA74NA81NA90NA91NA92NA93NB00NB01NB02NB03NB10NB11NB12NB13NB14NB20NB21NB22NB23NB24NB30NB31NB32NB33NB34NB35NB40NB41NB42NB43NB44NB45NB46NB52NB53NB54NB55NB56NF09NF19NF56NF58NF60NF61NF66NF67NF68NF70NF71NF72NF73NF74NF75NF76NF77NF80NF81NF82NF83NF84NF85NF86NF87NF88NF89NF95NF96NF97NF98NF99NG07NG08NG09NG18NG19NG29NG49NL57NL58NL68NL69NL79HY10HY20HY21HY22HY23HY30HY31HY32HY33HY34HY35HY40HY41HY42HY43HY44HY45HY50HY51HY52HY53HY54HY55HY60HY61HY62HY63HY64HY73HY74HY75ND19ND28ND29ND38ND39ND47ND48ND49ND59HP40HP50HP51HP60HP61HT93HT94HU14HU15HU16HU24HU25HU26HU27HU28HU30HU31HU32HU33HU34HU35HU36HU37HU38HU39HU40HU41HU42HU43HU44HU45HU46HU47HU48HU49HU53HU54HU55HU56HU57HU58HU59HU66HU67HU68HU69HZ16HZ17HZ26HZ27";to_gridref(e){const t=this.x/1e5|0,i=this.y/1e5|0;let r;r=i<5?t<5?"S":"T":i<10?t<5?"N":"O":t<5?"H":"J";let n=65+5*(4-i%5)+t%5;n>=73&&n++;const o=String.fromCharCode(n);return te(r+o,this.x-1e5*t,this.y-1e5*i,e||1);}to_hectad(){const e=this.x/1e5|0,t=this.y/1e5|0;let i;i=t<5?e<5?"S":"T":t<10?e<5?"N":"O":e<5?"H":"J";let r=65+5*(4-t%5)+e%5;return r>=73&&r++,i+String.fromCharCode(r)+((this.x-1e5*e)/1e4|0)+((this.y-1e5*t)/1e4|0);}is_gb_hectad(){return -1!==ie.gbHectads.indexOf(this.to_hectad());}to_latLng(){const e=4e5,t=.85521133347722,i=6377563.396,r=.00667054007,n=this.x,o=this.y,s=.0016732203289875;let a,l=(o+1e5)/(.9996012717*i)+t;do{a=o+1e5-6353722.489*(1.0016767257674*(l-t)-.00502807228247412*Math.sin(l-t)*Math.cos(l+t)+(1.875*s*s+1.875*s*s*s)*Math.sin(2*(l-t))*Math.cos(2*(l+t))-35/24*s*s*s*Math.sin(3*(l-t))*Math.cos(3*(l+t))),l+=a/6375020.48098897;}while(a>=.001);const c=Math.sin(l)*Math.sin(l),h=Math.tan(l)*Math.tan(l),u=1/Math.cos(l),d=.9996012717*i*Math.pow(1-r*c,-.5),p=6332495.651423464*Math.pow(1-r*c,-1.5),f=d/p-1,m=Math.tan(l)/(2*p*d),_=Math.tan(l)/(24*p*Math.pow(d,3))*(5+3*h+f-9*h*f),g=Math.tan(l)/(720*p*Math.pow(d,5))*(61+90*h+45*h*h),y=u/d,x=u/(6*d*d*d)*(d/p+2*h),v=u/(120*Math.pow(d,5))*(5+28*h+24*h*h),b=u/(5040*Math.pow(d,7))*(61+662*h+1320*h*h+720*h*h*h),S=l-m*Math.pow(n-e,2)+_*Math.pow(n-e,4)-g*Math.pow(n-e,6),w=y*(n-e)-.034906585039887-x*Math.pow(n-e,3)+v*Math.pow(n-e,5)-b*Math.pow(n-e,7);return new J(X*S,X*w).to_WGS84();}}class re extends ee{country="IE";gridCoords=null;constructor(e,t){super(),this.x=e,this.y=t;}static irishGrid={0:["V","Q","L","F","A"],1:["W","R","M","G","B"],2:["X","S","N","H","C"],3:["Y","T","O","J","D"]};to_latLng(){const e=1.000035,t=6377340.189,i=.0066705402933363,r=.0016732203841521,n=this.x-2e5,o=.0067153352074207,s=(5929615.3530033+(this.y-25e4)/e)/6366691.7742864415,a=s+.002509826623715886*Math.sin(2*s)+36745487490091978e-22*Math.sin(4*s)+151*r*r*r/96*Math.sin(6*s),l=t/Math.sqrt(1-i*Math.sin(a)*Math.sin(a)),c=Math.tan(a)*Math.tan(a),h=o*Math.cos(a)*Math.cos(a),u=t*(1-i)/Math.pow(1-i*Math.sin(a)*Math.sin(a),1.5),d=n/(l*e);let p=a-l*Math.tan(a)/u*(d*d/2-(5+3*c+10*h-4*h*h-9*o)*d*d*d*d/24+(61+90*c+298*h+45*c*c-1.6922644722700164-3*h*h)*d*d*d*d*d*d/720);p*=X;let f=(d-(1+2*c+h)*d*d*d/6+(5-2*h+28*c-3*h*h+8*o+24*c*c)*d*d*d*d*d/120)/Math.cos(a);return f=f*X-8,new K(p,f).to_WGS84();}to_gridref(e){const t=Math.floor(this.x/1e5),i=Math.floor(this.y/1e5);return re.irishGrid[t]&&re.irishGrid[t][i]?te(re.irishGrid[t][i],this.x-1e5*t,this.y-1e5*i,e||1):null;}to_hectad(){const e=Math.floor(this.x/1e5),t=Math.floor(this.y/1e5);return re.irishGrid[e]&&re.irishGrid[e][t]?re.irishGrid[e][t]+Math.floor(this.x%1e5/1e4)+Math.floor(this.y%1e5/1e4):"";}}class ne extends ee{country="CI";constructor(e,t){super(),this.x=e,this.y=t;}to_latLng(){const e=.9996,t=.0067226700223333,i=6378388*e,r=this.x-5e5,n=se(this.y,0,i,0,.0016863406508729017,6354369.181221601),o=i/Math.sqrt(1-t*(Math.sin(n)*Math.sin(n))),s=o*(1-t)/(1-t*Math.sin(n)*Math.sin(n)),a=o/s-1,l=Math.tan(n)*Math.tan(n),c=Math.pow(Math.tan(n),4),h=Math.pow(Math.tan(n),6),u=Math.pow(Math.cos(n),-1),d=Math.tan(n)/(2*s*o),p=Math.tan(n)/(24*s*(o*o*o))*(5+3*l+a-9*a*l),f=Math.tan(n)/(720*s*Math.pow(o,5))*(61+90*l+45*c),m=n-r*r*d+Math.pow(r,4)*p-Math.pow(r,6)*f,_=Math.pow(Math.cos(n),-1)/o,g=u/(o*o*o*6)*(o/s+2*l),y=u/(120*Math.pow(o,5))*(5+28*l+24*c),x=u/(5040*Math.pow(o,7))*(61+662*l+1320*c+720*h),v=r*_-.0523598775598-r*r*r*g+Math.pow(r,5)*y-Math.pow(r,7)*x,b=oe(m,v);return new Y(b.lat*X,b.lng*X);}to_gridref(e){return this.y>=55e5?te("WA",this.x-5e5,this.y-55e5,e||1):this.y<55e5?te("WV",this.x-5e5,this.y-54e5,e||1):null;}to_hectad(){return this.y>55e5?"WA"+this.x.toString().substring(1,2)+this.y.toString().substring(2,3):this.y<55e5?"WV"+this.x.toString().substring(1,2)+this.y.toString().substring(2,3):null;}}const oe=function(e,t){return W._transform(e,t,6378388,.0067226700223333,10,6378137,.00669438037928458,-83.901,-98.127,-118.635,0,0,0,0);},se=function(e,t,i,r,n,o){let s=(e-t)/i+r,a=W._Marc(o,n,r,s),l=(e-t-a)/i+s,c=0;for(;Math.abs(e-t-a)>1e-5&&c<20;)c+=1,l=(e-t-a)/i+s,a=W._Marc(o,n,r,l),s=l;return l;};class ae extends q{country="CI";GridCoords=ne;gridCoords=null;constructor(){super(),this.parse_well_formed=this.from_string;}from_string(e){let t,i=e.replace(/[\[\]\s\t.\/-]+/g,"").toUpperCase(),r="";/[ABCDEFGHIJKLMNPQRSTUVWXYZ]$/.test(i)&&(q.quadrantOffsets.hasOwnProperty(i.substring(i.length-2))?(this.quadrantCode=i.substring(i.length-2),i=i.substring(0,i.length-2)):(r=i.charAt(i.length-1),i=i.substring(0,i.length-1))),/^(W[AV](?:\d\d){1,5})$/.test(i)?(t=ae.gridref_string_to_e_n_l(i))?(this.length=t.length,this.gridCoords=new ne(t.e,t.n),this.hectad=this.gridCoords.to_gridref(1e4),1e4===this.length&&(r||this.quadrantCode)?r?(this.preciseGridRef=i+r,this.tetrad=this.hectad+r,this.tetradLetter=r,this.length=2e3,this.gridCoords.x+=q.tetradOffsets[r][0],this.gridCoords.y+=q.tetradOffsets[r][1]):(this.preciseGridRef=i+this.quadrantCode,this.tetradLetter="",this.tetrad="",this.quadrant=this.preciseGridRef,this.length=5e3,this.gridCoords.x+=q.quadrantOffsets[this.quadrantCode][0],this.gridCoords.y+=q.quadrantOffsets[this.quadrantCode][1]):(this.preciseGridRef=i,this.length<=1e3&&this.set_tetrad())):(this.error=!0,this.errorMessage="Grid reference format not understood (odd length)."):(this.error=!0,this.errorMessage="Channel Island grid reference format not understood. ('"+e+"')");}static gridref_string_to_e_n_l(e){let t,i,r,n,o=e.substring(0,2);if("WA"===o)t=55e5;else {if("WV"!==o)return console.log("Bad Channel Island grid letters: '"+o+"'"),!1;t=54e5;}let s=e.substring(2);switch(s.length){case 2:i=1e4*s.charAt(0),r=1e4*s.charAt(1),n=1e4;break;case 4:i=1e3*s.substring(0,2),r=1e3*s.substring(2),n=1e3;break;case 6:i=100*s.substring(0,3),r=100*s.substring(3),n=100;break;case 8:i=10*s.substring(0,4),r=10*s.substring(4),n=10;break;case 10:i=parseInt(s.substring(0,5),10),r=parseInt(s.substring(5),10),n=1;break;default:return console.log("Bad length for Channel Island grid ref '"+e+"'"),!1;}return {e:i+5e5,n:r+t,length:n};}}class le extends q{country="GB";GridCoords=ie;gridCoords=null;constructor(){super();}parse_well_formed(e){e.length>=5&&/^[A-Z]/.test(e.charAt(4))&&(q.quadrantOffsets.hasOwnProperty(e.substring(e.length-2))?this.quadrantCode=e.substring(e.length-2):this.tetradLetter=e.charAt(4),e=e.substring(0,4)),this.parse_wellformed_gb_gr_string_no_tetrads(e),this.tetradLetter||this.quadrantCode?this.tetradLetter?(this.preciseGridRef=this.tetrad=this.hectad+this.tetradLetter,this.length=2e3,this.gridCoords.x+=q.tetradOffsets[this.tetradLetter][0],this.gridCoords.y+=q.tetradOffsets[this.tetradLetter][1]):(this.preciseGridRef=this.quadrant=e+this.quadrantCode,this.length=5e3,this.gridCoords.x+=q.quadrantOffsets[this.quadrantCode][0],this.gridCoords.y+=q.quadrantOffsets[this.quadrantCode][1]):(this.preciseGridRef=e,this.length<=1e3&&this.set_tetrad());}from_string(e){let t,i=e.replace(/[\[\]\s\t.-]+/g,"").toUpperCase(),r="";if(/[ABCDEFGHIJKLMNPQRSTUVWXYZ]$/.test(i)&&(q.quadrantOffsets.hasOwnProperty(i.substring(i.length-2))?(this.quadrantCode=i.substring(i.length-2),i=i.substring(0,i.length-2)):(r=i.charAt(i.length-1),i=i.substring(0,i.length-1))),i===parseInt(i,10).toString()?i=i.substring(0,2)+"/"+i.substring(2):i.length>3&&"/"===i.charAt(2)&&/^[A-Z]{2}$/.test(i.substring(0,2))&&(i=i.replace("/","")),"VC"===i.substring(0,2))this.error=!0,this.errorMessage="Misplaced vice-county code in grid-reference field. ('"+i+"')",this.gridCoords=null,this.length=0;else if(null!==(t=i.match(/^([HJNOST][ABCDEFGHJKLMNOPQRSTUVWXYZ](?:\d\d){1,5})$/)))i=t[0],this.parse_wellformed_gb_gr_string_no_tetrads(i),this.length>0?1e4===this.length&&(r||this.quadrantCode)?r?(this.preciseGridRef=i+r,this.tetradLetter=r,this.tetrad=this.hectad+r,this.length=2e3,this.gridCoords.x+=q.tetradOffsets[r][0],this.gridCoords.y+=q.tetradOffsets[r][1]):(this.preciseGridRef=i+this.quadrantCode,this.tetradLetter="",this.tetrad="",this.quadrant=this.preciseGridRef,this.length=5e3,this.gridCoords.x+=q.quadrantOffsets[this.quadrantCode][0],this.gridCoords.y+=q.quadrantOffsets[this.quadrantCode][1]):(this.preciseGridRef=i,this.length<=1e3&&this.set_tetrad()):(this.error=!0,this.errorMessage="GB grid reference format not understood (strange length).");else if(/^([\d]{2})\/((?:\d\d){1,5})$/.test(i)){switch(this.parse_gr_string_without_tetrads(i),this.length){case 1e4:i=this.gridCoords.to_gridref(1e4),this.hectad=i,r?(i+=r,this.tetradLetter=r,this.tetrad=this.hectad+r,this.length=2e3,this.gridCoords.x+=q.tetradOffsets[r][0],this.gridCoords.y+=q.tetradOffsets[r][1]):this.quadrantCode&&(i+=this.quadrantCode,this.quadrant=i,this.length=5e3,this.gridCoords.x+=q.quadrantOffsets[this.quadrantCode][0],this.gridCoords.y+=q.quadrantOffsets[this.quadrantCode][1]);break;case 1e3:case 100:case 10:case 1:i=this.gridCoords.to_gridref(this.length),this.hectad=this.gridCoords.to_gridref(1e4),this.set_tetrad();break;default:this.error=!0,this.errorMessage="Bad grid square dimension ("+this.length+" m).",this.gridCoords=null,this.length=0;}this.preciseGridRef=i;}else this.gridCoords=null,this.length=0,this.error=!0,this.errorMessage="Grid reference format not understood. ('"+e+"')";}parse_gr_string_without_tetrads(e){let t,i,r,n;if(null!==(t=e.match(/^(\d{2})\/((?:\d\d){1,5})$/))){switch(t[1]){case"57":i=3e5,r=1e6;break;case"67":i=4e5,r=1e6;break;case"58":i=3e5,r=11e5;break;case"68":i=4e5,r=11e5;break;case"69":i=4e5,r=12e5;break;default:i=1e5*e.charAt(0),r=1e5*e.charAt(1);}n=t[2];}else {if(!q.letterMapping.hasOwnProperty(e.charAt(0))||!q.letterMapping.hasOwnProperty(e.charAt(1)))return this.length=0,void(this.gridCoords=null);let t=q.letterMapping[e.charAt(0)],o=q.letterMapping[e.charAt(1)];n=e.substring(2),i=t%5*5e5+o%5*1e5-1e6,r=5e5*-Math.floor(t/5)-1e5*Math.floor(o/5)+19e5;}switch(n.length){case 2:this.gridCoords=new ie(i+1e4*n.charAt(0),r+1e4*n.charAt(1)),this.length=1e4;break;case 4:this.gridCoords=new ie(i+1e3*Math.floor(n/100),r+n%100*1e3),this.length=1e3;break;case 6:this.gridCoords=new ie(i+100*Math.floor(n/1e3),r+n%1e3*100),this.length=100;break;case 8:this.gridCoords=new ie(i+10*Math.floor(n/1e4),r+n%1e4*10),this.length=10;break;case 10:this.gridCoords=new ie(i+Math.floor(n/1e5),r+n%1e5),this.length=1;break;default:console.log("Bad grid ref length, ref="+e),this.gridCoords=null,this.length=0;}}parse_wellformed_gb_gr_string_no_tetrads(e){let t,i,r,n,o;switch(t=q.letterMapping[e.charAt(0)],i=q.letterMapping[e.charAt(1)],r=e.substring(2),n=t%5*5e5+i%5*1e5-1e6,o=5e5*-Math.floor(t/5)-1e5*Math.floor(i/5)+19e5,r.length){case 2:this.gridCoords=new ie(n+1e4*r.charAt(0),o+1e4*r.charAt(1)),this.length=1e4,this.hectad=e;break;case 4:this.gridCoords=new ie(n+1e3*Math.floor(r/100),o+r%100*1e3),this.length=1e3,this.hectad=e.substring(0,3)+e.charAt(4);break;case 6:this.gridCoords=new ie(n+100*Math.floor(r/1e3),o+r%1e3*100),this.length=100,this.hectad=e.substring(0,3)+e.charAt(5);break;case 8:this.gridCoords=new ie(n+10*Math.floor(r/1e4),o+r%1e4*10),this.length=10,this.hectad=e.substring(0,3)+e.charAt(6);break;case 10:this.gridCoords=new ie(n+Math.floor(r/1e5),o+r%1e5),this.length=1,this.hectad=e.substring(0,3)+e.charAt(7);break;default:throw this.gridCoords=null,new Error("Bad grid ref length when parsing supposedly well-formed ref, ref='"+e+"'");}}}class ce extends q{constructor(){super(),this.parse_well_formed=this.from_string;}country="IE";GridCoords=re;gridCoords=null;static gridLetter={A:[0,4],B:[1,4],C:[2,4],D:[3,4],F:[0,3],G:[1,3],H:[2,3],J:[3,3],L:[0,2],M:[1,2],N:[2,2],O:[3,2],Q:[0,1],R:[1,1],S:[2,1],T:[3,1],V:[0,0],W:[1,0],X:[2,0],Y:[3,0]};from_string(e){let t=e.replace(/[\[\]\s\t.-]+/g,"").toUpperCase();/[ABCDEFGHIJKLMNPQRSTUVWXYZ]$/.test(t)&&(ce.quadrantOffsets.hasOwnProperty(t.substring(t.length-2))?(this.quadrantCode=t.substring(t.length-2),t=t.substring(0,t.length-2)):(this.tetradLetter=t.substring(t.length-1),t=t.substring(0,t.length-1))),this.parse_gr_string_without_tetrads(t),this.length>0?this.tetradLetter||this.quadrantCode?this.tetradLetter?(this.preciseGridRef=this.hectad+this.tetradLetter,this.tetrad=this.preciseGridRef,this.length=2e3,this.gridCoords.x+=ce.tetradOffsets[this.tetradLetter][0],this.gridCoords.y+=ce.tetradOffsets[this.tetradLetter][1]):(this.preciseGridRef=this.hectad+this.quadrantCode,this.quadrant=this.preciseGridRef,this.length=5e3,this.gridCoords.x+=ce.quadrantOffsets[this.quadrantCode][0],this.gridCoords.y+=ce.quadrantOffsets[this.quadrantCode][1]):(this.preciseGridRef=t,this.length<=1e3&&this.set_tetrad()):(this.error=!0,this.errorMessage="Irish grid reference format not understood. ('"+e+"')");}static _IE_GRID_LETTERS="VQLFAWRMGBXSNHCYTOJD";parse_gr_string_without_tetrads(e){let t,i,r,n;if(/^\d{2}\/(?:\d\d){1,5}$/.test(e)){if(t=parseInt(e.charAt(0),10),i=parseInt(e.charAt(1),10),t>3||i>4)return console.log("bad grid square, ref='"+e+"' (Ireland)"),this.length=0,!1;r=e.substring(3),n=ce._IE_GRID_LETTERS.charAt(5*t+i),t*=1e5,i*=1e5;}else {if(e=e.replace("/",""),!/^[ABCDFGHJLMNOQRSTVWXY](?:\d\d){1,5}$/.test(e))return this.length=0,this.gridCoords=null,!1;if(!e)return console.log("Bad (empty) Irish grid ref"),this.length=0,this.gridCoords=null,!1;{n=e.charAt(0);let r=ce._IE_GRID_LETTERS.indexOf(n);if(-1===r)return console.log("Bad grid ref grid-letter, ref='"+e+"' (Ireland)"),this.length=0,this.gridCoords=null,!1;t=1e5*Math.floor(r/5),i=r%5*1e5;}r=e.substring(1);}switch(r.length){case 2:this.gridCoords=new re(t+1e4*r.charAt(0),i+1e4*r.charAt(1)),this.length=1e4,this.hectad=n+r;break;case 4:this.gridCoords=new re(t+1e3*Math.floor(r/100),i+r%100*1e3),this.length=1e3,this.hectad=n+r.charAt(0)+r.charAt(2);break;case 6:this.gridCoords=new re(t+100*Math.floor(r/1e3),i+r%1e3*100),this.length=100,this.hectad=n+r.charAt(0)+r.charAt(3);break;case 8:this.gridCoords=new re(t+10*Math.floor(r/1e4),i+r%1e4*10),this.length=10,this.hectad=n+r.charAt(0)+r.charAt(4);break;case 10:this.gridCoords=new re(t+Math.floor(r/1e5),i+r%1e5),this.length=1,this.hectad=n+r.charAt(0)+r.charAt(5);break;default:return console.log("Bad grid ref length, ref='"+e+"' (Ireland)"),this.length=0,this.gridCoords=null,!1;}return !0;}}q.from_string=function(e){let t,i=e.replace(/\s+/g,"").toUpperCase();if(!i)return !1;if(/^(?:[BCDFGHJLMNOQRSTVWXY]|[HJNOST][ABCDEFGHJKLMNOPQRSTUVWXYZ]|W[VA])\d{2}(?:[A-Z]|[NS][EW]|(?:\d{2}){0,4})?$/.test(i))return t=/^.\d/.test(i)?new ce():"W"===i.charAt(0)?new ae():new le(),t.parse_well_formed(i),!(!t.length||t.error)&&t;if(t=new le(),t.from_string(i),t.length&&!t.error)return t;if("W"===i.charAt(0)){if(t=new ae(),t.from_string(i),t.length&&!t.error)return t;}else if(t=new ce(),t.from_string(i),t.length&&!t.error)return t;return !1;};class he extends P{_inputId;containerId;mapPositionIsCurrent=!1;_value={gridRef:"",rawString:"",source:he.GEOREF_SOURCE_UNKNOWN,latLng:null,precision:null};static GEOREF_SOURCE_UNKNOWN="unknown";static GEOREF_SOURCE_GRIDREF="gridref";static GEOREF_SOURCE_MAP="map";static GEOREF_SOURCE_GPS="gps";static GEOREF_SOURCE_POSTCODE="postcode";static GEOREF_SOURCE_PLACE="place";_inputType="text";_autocomplete="";baseSquareResolution=null;minResolution=2e3;maxResolution=10;gpsTextLabel=!1;gpsPermissionsPromptText='<p class="gps-nudge">Allowing access to GPS will save you time by allowing the app to locate your records automatically.</p>';initialiseFromDefaultSurveyGeoref=!1;showGPSEnableLinkIfNotActiveOnMobile=!0;_gpsPermissionsPromptId=null;constructor(e){super(e),e&&(e.type&&(this._inputType=e.type),e.placeholder&&(this.placeholder=e.placeholder),e.autocomplete&&(this._autocomplete=e.autocomplete),e.baseSquareResolution&&(this.baseSquareResolution=e.baseSquareResolution),e.maxResolution&&(this.maxResolution=e.maxResolution),e.minResolution&&(this.minResolution=e.minResolution),e.gpsPermissionPromptText&&(this.gpsPermissionsPromptText=e.gpsPermissionPromptText),e.gpsTextLabel&&(this.gpsTextLabel=e.gpsTextLabel),e.hasOwnProperty("initialiseFromDefaultSurveyGeoref")&&(this.initialiseFromDefaultSurveyGeoref=e.initialiseFromDefaultSurveyGeoref),e.hasOwnProperty("showGPSEnableLinkIfNotActiveOnMobile")&&(this.showGPSEnableLinkIfNotActiveOnMobile=e.showGPSEnableLinkIfNotActiveOnMobile));}set value(e){this._value=e?"string"==typeof e?{gridRef:e,rawString:e,source:he.GEOREF_SOURCE_UNKNOWN,latLng:null,precision:null}:e:{gridRef:"",rawString:"",source:null,latLng:null,precision:null},this.updateView();}get value(){return this._value;}updateView(){if(this._fieldEl){document.getElementById(this._inputId).value=P.cleanRawString(this._value.gridRef);}}buildField(){const e=document.createElement("div");if(e.className="form-group",this.containerId=e.id=P.nextId,this._inputId=P.nextId,navigator.geolocation&&this.showGPSEnableLinkIfNotActiveOnMobile&&D.getDeviceType()===D.DEVICE_TYPE_MOBILE){const t=document.createElement("a");t.className="no-gps-link-prompt",t.href="#",t.innerText="Please enable GPS",e.appendChild(t),t.addEventListener("click",this.gpsButtonClickHandler.bind(this));}const t=e.appendChild(document.createElement("label"));t.htmlFor=this._inputId,t.textContent=this.label;const i=e.appendChild(document.createElement("div"));i.className="input-group";const r=i.appendChild(document.createElement("input"));r.className="form-control",r.id=this._inputId,r.type="text",this.placeholder&&(r.placeholder=this.placeholder),this._autocomplete&&(r.autocomplete=this._autocomplete,"off"===this._autocomplete&&(r.name=x()));const n=i.appendChild(document.createElement("span"));if(n.className="input-group-btn",navigator.geolocation){const e=n.appendChild(document.createElement("button"));if(e.id=P.nextId,e.type="button",e.className="btn btn-outline-secondary btn-sm",e.title="use GPS",this.gpsTextLabel){const t=e.appendChild(document.createElement("span"));t.style.verticalAlign="middle",t.innerText="GPS ";}const t=e.appendChild(document.createElement("span"));t.className="material-icons",t.innerText="gps_not_fixed",this.gpsTextLabel&&(t.style.verticalAlign="middle"),e.addEventListener("click",this.gpsButtonClickHandler.bind(this));}if(this.completion===P.COMPLETION_COMPULSORY&&(r.required=!0),this.validationMessage){const t=e.appendChild(document.createElement("div"));t.className="invalid-feedback",t.innerHTML=this.validationMessage;}if(this.gpsPermissionsPromptText&&navigator.geolocation){const t=e.appendChild(document.createElement("small"));this._gpsPermissionsPromptId=t.id=P.nextId,t.style.display="none",t.innerHTML=this.gpsPermissionsPromptText;}if(this.helpText){e.appendChild(document.createElement("small")).innerHTML=this.helpText;}r.addEventListener("change",this.inputChangeHandler.bind(this)),this._fieldEl=e;}markValidity(e){const t=document.getElementById(this._inputId);null===e?t.classList.remove("is-invalid","is-valid"):(t.classList.remove(e?"is-invalid":"is-valid"),t.classList.add(e?"is-valid":"is-invalid"));}inputChangeHandler(e){e.stopPropagation();let t=P.cleanRawString(document.getElementById(this._inputId).value);const i=q.from_string(t);this.mapPositionIsCurrent=!1,this.value=i?{gridRef:i.preciseGridRef,rawString:t,source:he.GEOREF_SOURCE_GRIDREF,latLng:null,precision:null}:{gridRef:"",rawString:t,source:he.GEOREF_SOURCE_UNKNOWN,latLng:null,precision:null},this.fireEvent(P.EVENT_CHANGE);}gpsButtonClickHandler(e){if(p(e))return;let t=document.getElementById(this.containerId);t.classList.add("gps-active"),this.seekGPS().catch(e=>{console.log({"gps look-up failed, error":e});}).finally(()=>{t.classList.remove("gps-active");}),e.preventDefault(),e.stopPropagation();}_seekingGPS=!1;seekGPS(){return this._seekingGPS?Promise.reject():(this._seekingGPS=!0,D.seekGPS(this._gpsPermissionsPromptId).then(e=>{this._seekingGPS=!1,console.log({"gps position":e});let t=2*e.coords.accuracy;this.mapPositionIsCurrent=!1,this.processLatLngPosition(e.coords.latitude,e.coords.longitude,t,he.GEOREF_SOURCE_GPS);},e=>(this._seekingGPS=!1,e)));}processLatLngPosition(e,t,i,r,n=""){const o=ee.from_latlng(e,t);let s=q.get_normalized_precision(i);this.maxResolution&&s<this.maxResolution&&(s=this.maxResolution),this.minResolution&&s>this.minResolution&&(s=this.minResolution);const a=o.to_gridref(s);console.log(`Got grid-ref: ${a}`),this.value={gridRef:a,rawString:n,source:r,latLng:{lat:e,lng:t},precision:i},this.fireEvent(P.EVENT_CHANGE);}static summariseImpl(e,t,i){return ""!==i[e]&&null!==i[e]&&void 0!==i[e]&&i[e].gridRef?`<span>grid-reference <span class="gridref-summary">${S(i[e].gridRef.trim())}</span></span>`:"";}static isEmpty(e){return !(e&&e.gridRef);}static isValid(e,t,i){if(t.attributes.completion&&(t.attributes.completion===P.COMPLETION_COMPULSORY||t.attributes.completion===P.COMPLETION_DESIRED)){if(!i.hasOwnProperty(e)||t.field.isEmpty(i[e]))return !1;{let t=i[e];return console.log({"testing gr validity":t}),!(!t||!t.gridRef);}}return null;}}var de=function(){var e,t,i;function r(r,n){if(e){if(t){var o="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+e+")(sharedChunk); ("+t+")(sharedChunk); self.onerror = null;",s={};e(s),i=n(s),"undefined"!=typeof window&&window&&window.URL&&window.URL.createObjectURL&&(i.workerUrl=window.URL.createObjectURL(new Blob([o],{type:"text/javascript"})));}else t=n;}else e=n;}return r(["exports"],function(e){var t="2.7.1",i=r;function r(e,t,i,r){this.cx=3*e,this.bx=3*(i-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*t,this.by=3*(r-t)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=r,this.p2x=i,this.p2y=r;}r.prototype.sampleCurveX=function(e){return ((this.ax*e+this.bx)*e+this.cx)*e;},r.prototype.sampleCurveY=function(e){return ((this.ay*e+this.by)*e+this.cy)*e;},r.prototype.sampleCurveDerivativeX=function(e){return (3*this.ax*e+2*this.bx)*e+this.cx;},r.prototype.solveCurveX=function(e,t){var i,r,n,o,s;for(void 0===t&&(t=1e-6),n=e,s=0;s<8;s++){if(o=this.sampleCurveX(n)-e,Math.abs(o)<t)return n;var a=this.sampleCurveDerivativeX(n);if(Math.abs(a)<1e-6)break;n-=o/a;}if((n=e)<(i=0))return i;if(n>(r=1))return r;for(;i<r;){if(o=this.sampleCurveX(n),Math.abs(o-e)<t)return n;e>o?i=n:r=n,n=.5*(r-i)+i;}return n;},r.prototype.solve=function(e,t){return this.sampleCurveY(this.solveCurveX(e,t));};var n=o;function o(e,t){this.x=e,this.y=t;}o.prototype={clone:function(){return new o(this.x,this.y);},add:function(e){return this.clone()._add(e);},sub:function(e){return this.clone()._sub(e);},multByPoint:function(e){return this.clone()._multByPoint(e);},divByPoint:function(e){return this.clone()._divByPoint(e);},mult:function(e){return this.clone()._mult(e);},div:function(e){return this.clone()._div(e);},rotate:function(e){return this.clone()._rotate(e);},rotateAround:function(e,t){return this.clone()._rotateAround(e,t);},matMult:function(e){return this.clone()._matMult(e);},unit:function(){return this.clone()._unit();},perp:function(){return this.clone()._perp();},round:function(){return this.clone()._round();},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y);},equals:function(e){return this.x===e.x&&this.y===e.y;},dist:function(e){return Math.sqrt(this.distSqr(e));},distSqr:function(e){var t=e.x-this.x,i=e.y-this.y;return t*t+i*i;},angle:function(){return Math.atan2(this.y,this.x);},angleTo:function(e){return Math.atan2(this.y-e.y,this.x-e.x);},angleWith:function(e){return this.angleWithSep(e.x,e.y);},angleWithSep:function(e,t){return Math.atan2(this.x*t-this.y*e,this.x*e+this.y*t);},_matMult:function(e){var t=e[2]*this.x+e[3]*this.y;return this.x=e[0]*this.x+e[1]*this.y,this.y=t,this;},_add:function(e){return this.x+=e.x,this.y+=e.y,this;},_sub:function(e){return this.x-=e.x,this.y-=e.y,this;},_mult:function(e){return this.x*=e,this.y*=e,this;},_div:function(e){return this.x/=e,this.y/=e,this;},_multByPoint:function(e){return this.x*=e.x,this.y*=e.y,this;},_divByPoint:function(e){return this.x/=e.x,this.y/=e.y,this;},_unit:function(){return this._div(this.mag()),this;},_perp:function(){var e=this.y;return this.y=this.x,this.x=-e,this;},_rotate:function(e){var t=Math.cos(e),i=Math.sin(e),r=i*this.x+t*this.y;return this.x=t*this.x-i*this.y,this.y=r,this;},_rotateAround:function(e,t){var i=Math.cos(e),r=Math.sin(e),n=t.y+r*(this.x-t.x)+i*(this.y-t.y);return this.x=t.x+i*(this.x-t.x)-r*(this.y-t.y),this.y=n,this;},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this;}},o.convert=function(e){return e instanceof o?e:Array.isArray(e)?new o(e[0],e[1]):e;};var s="undefined"!=typeof self?self:{},a=1e-6,l="undefined"!=typeof Float32Array?Float32Array:Array;function c(){var e=new l(9);return l!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e;}function h(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e;}function u(e,t,i){var r=t[0],n=t[1],o=t[2],s=t[3],a=t[4],l=t[5],c=t[6],h=t[7],u=t[8],d=t[9],p=t[10],f=t[11],m=t[12],_=t[13],g=t[14],y=t[15],x=i[0],v=i[1],b=i[2],S=i[3];return e[0]=x*r+v*a+b*u+S*m,e[1]=x*n+v*l+b*d+S*_,e[2]=x*o+v*c+b*p+S*g,e[3]=x*s+v*h+b*f+S*y,e[4]=(x=i[4])*r+(v=i[5])*a+(b=i[6])*u+(S=i[7])*m,e[5]=x*n+v*l+b*d+S*_,e[6]=x*o+v*c+b*p+S*g,e[7]=x*s+v*h+b*f+S*y,e[8]=(x=i[8])*r+(v=i[9])*a+(b=i[10])*u+(S=i[11])*m,e[9]=x*n+v*l+b*d+S*_,e[10]=x*o+v*c+b*p+S*g,e[11]=x*s+v*h+b*f+S*y,e[12]=(x=i[12])*r+(v=i[13])*a+(b=i[14])*u+(S=i[15])*m,e[13]=x*n+v*l+b*d+S*_,e[14]=x*o+v*c+b*p+S*g,e[15]=x*s+v*h+b*f+S*y,e;}function d(e,t,i){var r,n,o,s,a,l,c,h,u,d,p,f,m=i[0],_=i[1],g=i[2];return t===e?(e[12]=t[0]*m+t[4]*_+t[8]*g+t[12],e[13]=t[1]*m+t[5]*_+t[9]*g+t[13],e[14]=t[2]*m+t[6]*_+t[10]*g+t[14],e[15]=t[3]*m+t[7]*_+t[11]*g+t[15]):(n=t[1],o=t[2],s=t[3],a=t[4],l=t[5],c=t[6],h=t[7],u=t[8],d=t[9],p=t[10],f=t[11],e[0]=r=t[0],e[1]=n,e[2]=o,e[3]=s,e[4]=a,e[5]=l,e[6]=c,e[7]=h,e[8]=u,e[9]=d,e[10]=p,e[11]=f,e[12]=r*m+a*_+u*g+t[12],e[13]=n*m+l*_+d*g+t[13],e[14]=o*m+c*_+p*g+t[14],e[15]=s*m+h*_+f*g+t[15]),e;}function p(e,t,i){var r=i[0],n=i[1],o=i[2];return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*n,e[5]=t[5]*n,e[6]=t[6]*n,e[7]=t[7]*n,e[8]=t[8]*o,e[9]=t[9]*o,e[10]=t[10]*o,e[11]=t[11]*o,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e;}function f(e,t,i){var r=Math.sin(i),n=Math.cos(i),o=t[4],s=t[5],a=t[6],l=t[7],c=t[8],h=t[9],u=t[10],d=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=o*n+c*r,e[5]=s*n+h*r,e[6]=a*n+u*r,e[7]=l*n+d*r,e[8]=c*n-o*r,e[9]=h*n-s*r,e[10]=u*n-a*r,e[11]=d*n-l*r,e;}function m(e,t,i){var r=Math.sin(i),n=Math.cos(i),o=t[0],s=t[1],a=t[2],l=t[3],c=t[8],h=t[9],u=t[10],d=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=o*n-c*r,e[1]=s*n-h*r,e[2]=a*n-u*r,e[3]=l*n-d*r,e[8]=o*r+c*n,e[9]=s*r+h*n,e[10]=a*r+u*n,e[11]=l*r+d*n,e;}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e);});var _=u;function g(){var e=new l(3);return l!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e;}function y(e){var t=new l(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t;}function x(e){return Math.hypot(e[0],e[1],e[2]);}function v(e,t,i){var r=new l(3);return r[0]=e,r[1]=t,r[2]=i,r;}function b(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e;}function S(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e;}function w(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e[2]=t[2]*i[2],e;}function T(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e[2]=Math.max(t[2],i[2]),e;}function E(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e;}function N(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e;}function I(e,t){var i=t[0],r=t[1],n=t[2],o=i*i+r*r+n*n;return o>0&&(o=1/Math.sqrt(o)),e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e;}function M(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2];}function C(e,t,i){var r=t[0],n=t[1],o=t[2],s=i[0],a=i[1],l=i[2];return e[0]=n*l-o*a,e[1]=o*s-r*l,e[2]=r*a-n*s,e;}function A(e,t,i){var r=t[0],n=t[1],o=t[2],s=i[3]*r+i[7]*n+i[11]*o+i[15];return e[0]=(i[0]*r+i[4]*n+i[8]*o+i[12])/(s=s||1),e[1]=(i[1]*r+i[5]*n+i[9]*o+i[13])/s,e[2]=(i[2]*r+i[6]*n+i[10]*o+i[14])/s,e;}function P(e,t,i){var r=i[0],n=i[1],o=i[2],s=t[0],a=t[1],l=t[2],c=n*l-o*a,h=o*s-r*l,u=r*a-n*s,d=n*u-o*h,p=o*c-r*u,f=r*h-n*c,m=2*i[3];return h*=m,u*=m,p*=2,f*=2,e[0]=s+(c*=m)+(d*=2),e[1]=a+h+p,e[2]=l+u+f,e;}var L,D=S,k=w,z=x;function R(e,t,i){var r=t[0],n=t[1],o=t[2],s=t[3];return e[0]=i[0]*r+i[4]*n+i[8]*o+i[12]*s,e[1]=i[1]*r+i[5]*n+i[9]*o+i[13]*s,e[2]=i[2]*r+i[6]*n+i[10]*o+i[14]*s,e[3]=i[3]*r+i[7]*n+i[11]*o+i[15]*s,e;}function O(){var e=new l(4);return l!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e;}function F(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e;}function B(e,t,i){i*=.5;var r=t[0],n=t[1],o=t[2],s=t[3],a=Math.sin(i),l=Math.cos(i);return e[0]=r*l+s*a,e[1]=n*l+o*a,e[2]=o*l-n*a,e[3]=s*l-r*a,e;}function U(e,t){return e[0]===t[0]&&e[1]===t[1];}g(),L=new l(4),l!=Float32Array&&(L[0]=0,L[1]=0,L[2]=0,L[3]=0),g(),v(1,0,0),v(0,1,0),O(),O(),c(),function(){var e;e=new l(2),l!=Float32Array&&(e[0]=0,e[1]=0);}();const V=Math.PI/180,G=180/Math.PI;function j(e){return e*V;}function $(e){return e*G;}const H=[[0,0],[1,0],[1,1],[0,1]];function q(e){if(e<=0)return 0;if(e>=1)return 1;const t=e*e,i=t*e;return 4*(e<.5?i:3*(e-t)+i-.75);}function Z(e,t,r,n){const o=new i(e,t,r,n);return function(e){return o.solve(e);};}const X=Z(.25,.1,.25,1);function W(e,t,i){return Math.min(i,Math.max(t,e));}function Y(e,t,i){return (i=W((i-e)/(t-e),0,1))*i*(3-2*i);}function J(e,t,i){const r=i-t,n=((e-t)%r+r)%r+t;return n===t?i:n;}function K(e,t,i){if(!e.length)return i(null,[]);let r=e.length;const n=new Array(e.length);let o=null;e.forEach((e,s)=>{t(e,(e,t)=>{e&&(o=e),n[s]=t,0==--r&&i(o,n);});});}function Q(e){const t=[];for(const i in e)t.push(e[i]);return t;}function ee(e,...t){for(const i of t)for(const t in i)e[t]=i[t];return e;}let te=1;function ie(){return te++;}function re(){return function e(t){return t?(t^16*Math.random()>>t/4).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,e);}();}function ne(e){return e<=1?1:Math.pow(2,Math.ceil(Math.log(e)/Math.LN2));}function oe(e){return !!e&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(e);}function se(e,t){e.forEach(e=>{t[e]&&(t[e]=t[e].bind(t));});}function ae(e,t){return -1!==e.indexOf(t,e.length-t.length);}function le(e,t,i){const r={};for(const n in e)r[n]=t.call(i||this,e[n],n,e);return r;}function ce(e,t,i){const r={};for(const n in e)t.call(i||this,e[n],n,e)&&(r[n]=e[n]);return r;}function he(e){return Array.isArray(e)?e.map(he):"object"==typeof e&&e?le(e,he):e;}const ue={};function de(e){ue[e]||("undefined"!=typeof console&&console.warn(e),ue[e]=!0);}function pe(e,t,i){return (i.y-e.y)*(t.x-e.x)>(t.y-e.y)*(i.x-e.x);}function fe(e){let t=0;for(let i,r,n=0,o=e.length,s=o-1;n<o;s=n++)i=e[n],r=e[s],t+=(r.x-i.x)*(i.y+r.y);return t;}function me(){return "undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope;}function _e(e){const t={};if(e.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,(e,i,r,n)=>{const o=r||n;return t[i]=!o||o.toLowerCase(),"";}),t["max-age"]){const e=parseInt(t["max-age"],10);isNaN(e)?delete t["max-age"]:t["max-age"]=e;}return t;}let ge,ye,xe,ve=null;function be(e){if(null==ve){const t=e.navigator?e.navigator.userAgent:null;ve=!!e.safari||!(!t||!(/\b(iPad|iPhone|iPod)\b/.test(t)||t.match("Safari")&&!t.match("Chrome")));}return ve;}function Se(e){try{const t=s[e];return t.setItem("_mapbox_test_",1),t.removeItem("_mapbox_test_"),!0;}catch(e){return !1;}}const we={now:()=>void 0!==xe?xe:s.performance.now(),setNow(e){xe=e;},restoreNow(){xe=void 0;},frame(e){const t=s.requestAnimationFrame(e);return {cancel:()=>s.cancelAnimationFrame(t)};},getImageData(e,t=0){const i=s.document.createElement("canvas"),r=i.getContext("2d");if(!r)throw new Error("failed to create canvas 2d context");return i.width=e.width,i.height=e.height,r.drawImage(e,0,0,e.width,e.height),r.getImageData(-t,-t,e.width+2*t,e.height+2*t);},resolveURL:e=>(ge||(ge=s.document.createElement("a")),ge.href=e,ge.href),get devicePixelRatio(){return s.devicePixelRatio;},get prefersReducedMotion(){return !!s.matchMedia&&(null==ye&&(ye=s.matchMedia("(prefers-reduced-motion: reduce)")),ye.matches);}};let Te;const Ee={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){if(null==Te){const e=/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i;try{Te=null!=process.env.API_URL_REGEX?new RegExp(process.env.API_URL_REGEX):e;}catch(t){Te=e;}}return Te;},get EVENTS_URL(){return this.API_URL?0===this.API_URL.indexOf("https://api.mapbox.cn")?"https://events.mapbox.cn/events/v2":0===this.API_URL.indexOf("https://api.mapbox.com")?"https://events.mapbox.com/events/v2":null:null;},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,MAX_PARALLEL_IMAGE_REQUESTS:16},Ne={supported:!1,testSupport:function(e){!Ce&&Me&&(Ae?Pe(e):Ie=e);}};let Ie,Me,Ce=!1,Ae=!1;function Pe(e){const t=e.createTexture();e.bindTexture(e.TEXTURE_2D,t);try{if(e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,Me),e.isContextLost())return;Ne.supported=!0;}catch(e){}e.deleteTexture(t),Ce=!0;}s.document&&(Me=s.document.createElement("img"),Me.onload=function(){Ie&&Pe(Ie),Ie=null,Ae=!0;},Me.onerror=function(){Ce=!0,Ie=null;},Me.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const Le="01",De="NO_ACCESS_TOKEN";function ke(e){return 0===e.indexOf("mapbox:");}function ze(e){return Ee.API_URL_REGEX.test(e);}const Re=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function Oe(e){const t=e.match(Re);if(!t)throw new Error("Unable to parse URL object");return {protocol:t[1],authority:t[2],path:t[3]||"/",params:t[4]?t[4].split("&"):[]};}function Fe(e){const t=e.params.length?`?${e.params.join("&")}`:"";return `${e.protocol}://${e.authority}${e.path}${t}`;}function Be(e){if(!e)return null;const t=e.split(".");if(!t||3!==t.length)return null;try{return JSON.parse(decodeURIComponent(s.atob(t[1]).split("").map(e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)).join("")));}catch(e){return null;}}class Ue{constructor(e){this.type=e,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null;}getStorageKey(e){const t=Be(Ee.ACCESS_TOKEN);let i="";return i=t&&t.u?s.btoa(encodeURIComponent(t.u).replace(/%([0-9A-F]{2})/g,(e,t)=>String.fromCharCode(Number("0x"+t)))):Ee.ACCESS_TOKEN||"",e?`mapbox.eventData.${e}:${i}`:`mapbox.eventData:${i}`;}fetchEventData(){const e=Se("localStorage"),t=this.getStorageKey(),i=this.getStorageKey("uuid");if(e)try{const e=s.localStorage.getItem(t);e&&(this.eventData=JSON.parse(e));const r=s.localStorage.getItem(i);r&&(this.anonId=r);}catch(e){de("Unable to read from LocalStorage");}}saveEventData(){const e=Se("localStorage"),t=this.getStorageKey(),i=this.getStorageKey("uuid");if(e)try{s.localStorage.setItem(i,this.anonId),Object.keys(this.eventData).length>=1&&s.localStorage.setItem(t,JSON.stringify(this.eventData));}catch(e){de("Unable to write to LocalStorage");}}processRequests(e){}postEvent(e,i,r,n){if(!Ee.EVENTS_URL)return;const o=Oe(Ee.EVENTS_URL);o.params.push(`access_token=${n||Ee.ACCESS_TOKEN||""}`);const s={event:this.type,created:new Date(e).toISOString(),sdkIdentifier:"mapbox-gl-js",sdkVersion:t,skuId:Le,userId:this.anonId},a=i?ee(s,i):s,l={url:Fe(o),headers:{"Content-Type":"text/plain"},body:JSON.stringify([a])};this.pendingRequest=at(l,e=>{this.pendingRequest=null,r(e),this.saveEventData(),this.processRequests(n);});}queueRequest(e,t){this.queue.push(e),this.processRequests(t);}}const Ve=new class extends Ue{constructor(e){super("appUserTurnstile"),this._customAccessToken=e;}postTurnstileEvent(e,t){Ee.EVENTS_URL&&Ee.ACCESS_TOKEN&&Array.isArray(e)&&e.some(e=>ke(e)||ze(e))&&this.queueRequest(Date.now(),t);}processRequests(e){if(this.pendingRequest||0===this.queue.length)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const t=Be(Ee.ACCESS_TOKEN),i=t?t.u:Ee.ACCESS_TOKEN;let r=i!==this.eventData.tokenU;oe(this.anonId)||(this.anonId=re(),r=!0);const n=this.queue.shift();if(this.eventData.lastSuccess){const e=new Date(this.eventData.lastSuccess),t=new Date(n),i=(n-this.eventData.lastSuccess)/864e5;r=r||i>=1||i<-1||e.getDate()!==t.getDate();}else r=!0;if(!r)return this.processRequests();this.postEvent(n,{"enabled.telemetry":!1},e=>{e||(this.eventData.lastSuccess=n,this.eventData.tokenU=i);},e);}}(),Ge=Ve.postTurnstileEvent.bind(Ve),je=new class extends Ue{constructor(){super("map.load"),this.success={},this.skuToken="";}postMapLoadEvent(e,t,i,r){this.skuToken=t,this.errorCb=r,Ee.EVENTS_URL&&(i||Ee.ACCESS_TOKEN?this.queueRequest({id:e,timestamp:Date.now()},i):this.errorCb(new Error(De)));}processRequests(e){if(this.pendingRequest||0===this.queue.length)return;const{id:t,timestamp:i}=this.queue.shift();t&&this.success[t]||(this.anonId||this.fetchEventData(),oe(this.anonId)||(this.anonId=re()),this.postEvent(i,{skuToken:this.skuToken},e=>{e?this.errorCb(e):t&&(this.success[t]=!0);},e));}}(),$e=je.postMapLoadEvent.bind(je),He=new class extends Ue{constructor(){super("map.auth"),this.success={},this.skuToken="";}getSession(e,t,i,r){if(!Ee.API_URL||!Ee.SESSION_PATH)return;const n=Oe(Ee.API_URL+Ee.SESSION_PATH);n.params.push(`sku=${t||""}`),n.params.push(`access_token=${r||Ee.ACCESS_TOKEN||""}`);const o={url:Fe(n),headers:{"Content-Type":"text/plain"}};this.pendingRequest=lt(o,e=>{this.pendingRequest=null,i(e),this.saveEventData(),this.processRequests(r);});}getSessionAPI(e,t,i,r){this.skuToken=t,this.errorCb=r,Ee.SESSION_PATH&&Ee.API_URL&&(i||Ee.ACCESS_TOKEN?this.queueRequest({id:e,timestamp:Date.now()},i):this.errorCb(new Error(De)));}processRequests(e){if(this.pendingRequest||0===this.queue.length)return;const{id:t,timestamp:i}=this.queue.shift();t&&this.success[t]||this.getSession(i,this.skuToken,e=>{e?this.errorCb(e):t&&(this.success[t]=!0);},e);}}(),qe=He.getSessionAPI.bind(He),Ze=new Set(),Xe="mapbox-tiles";let We,Ye,Je=500,Ke=50;function Qe(){s.caches&&!We&&(We=s.caches.open(Xe));}function et(e){const t=e.indexOf("?");return t<0?e:e.slice(0,t);}let tt=1/0;const it={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Image:"Image"};"function"==typeof Object.freeze&&Object.freeze(it);class rt extends Error{constructor(e,t,i){401===t&&ze(i)&&(e+=": you may have provided an invalid Mapbox access token. See https://www.mapbox.com/api-documentation/#access-tokens-and-token-scopes"),super(e),this.status=t,this.url=i;}toString(){return `${this.name}: ${this.message} (${this.status}): ${this.url}`;}}const nt=me()?()=>self.worker&&self.worker.referrer:()=>("blob:"===s.location.protocol?s.parent:s).location.href,ot=function(e,t){if(!(/^file:/.test(i=e.url)||/^file:/.test(nt())&&!/^\w+:/.test(i))){if(s.fetch&&s.Request&&s.AbortController&&s.Request.prototype.hasOwnProperty("signal"))return function(e,t){const i=new s.AbortController(),r=new s.Request(e.url,{method:e.method||"GET",body:e.body,credentials:e.credentials,headers:e.headers,referrer:nt(),signal:i.signal});let n=!1,o=!1;const a=(l=r.url).indexOf("sku=")>0&&ze(l);var l;"json"===e.type&&r.headers.set("Accept","application/json");const c=(i,n,l)=>{if(o)return;if(i&&"SecurityError"!==i.message&&de(i),n&&l)return h(n);const c=Date.now();s.fetch(r).then(i=>{if(i.ok){const e=a?i.clone():null;return h(i,e,c);}return t(new rt(i.statusText,i.status,e.url));}).catch(e=>{20!==e.code&&t(new Error(e.message));});},h=(i,a,l)=>{("arrayBuffer"===e.type?i.arrayBuffer():"json"===e.type?i.json():i.text()).then(e=>{o||(a&&l&&function(e,t,i){if(Qe(),!We)return;const r={status:t.status,statusText:t.statusText,headers:new s.Headers()};t.headers.forEach((e,t)=>r.headers.set(t,e));const n=_e(t.headers.get("Cache-Control")||"");n["no-store"]||(n["max-age"]&&r.headers.set("Expires",new Date(i+1e3*n["max-age"]).toUTCString()),new Date(r.headers.get("Expires")).getTime()-i<42e4||function(e,t){if(void 0===Ye)try{new Response(new ReadableStream()),Ye=!0;}catch(e){Ye=!1;}Ye?t(e.body):e.blob().then(t);}(t,t=>{const i=new s.Response(t,r);Qe(),We&&We.then(t=>t.put(et(e.url),i)).catch(e=>de(e.message));}));}(r,a,l),n=!0,t(null,e,i.headers.get("Cache-Control"),i.headers.get("Expires")));}).catch(e=>{o||t(new Error(e.message));});};return a?function(e,t){if(Qe(),!We)return t(null);const i=et(e.url);We.then(e=>{e.match(i).then(r=>{const n=function(e){if(!e)return !1;const t=new Date(e.headers.get("Expires")||0),i=_e(e.headers.get("Cache-Control")||"");return t>Date.now()&&!i["no-cache"];}(r);e.delete(i),n&&e.put(i,r.clone()),t(null,r,n);}).catch(t);}).catch(t);}(r,c):c(null,null),{cancel:()=>{o=!0,n||i.abort();}};}(e,t);if(me()&&self.worker&&self.worker.actor)return self.worker.actor.send("getResource",e,t,void 0,!0);}var i;return function(e,t){const i=new s.XMLHttpRequest();i.open(e.method||"GET",e.url,!0),"arrayBuffer"===e.type&&(i.responseType="arraybuffer");for(const t in e.headers)i.setRequestHeader(t,e.headers[t]);return "json"===e.type&&(i.responseType="text",i.setRequestHeader("Accept","application/json")),i.withCredentials="include"===e.credentials,i.onerror=()=>{t(new Error(i.statusText));},i.onload=()=>{if((i.status>=200&&i.status<300||0===i.status)&&null!==i.response){let r=i.response;if("json"===e.type)try{r=JSON.parse(i.response);}catch(e){return t(e);}t(null,r,i.getResponseHeader("Cache-Control"),i.getResponseHeader("Expires"));}else t(new rt(i.statusText,i.status,e.url));},i.send(e.body),{cancel:()=>i.abort()};}(e,t);},st=function(e,t){return ot(ee(e,{type:"arrayBuffer"}),t);},at=function(e,t){return ot(ee(e,{method:"POST"}),t);},lt=function(e,t){return ot(ee(e,{method:"GET"}),t);};function ct(e){const t=s.document.createElement("a");return t.href=e,t.protocol===s.document.location.protocol&&t.host===s.document.location.host;}const ht="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let ut,dt;ut=[],dt=0;const pt=function(e,t){if(Ne.supported&&(e.headers||(e.headers={}),e.headers.accept="image/webp,*/*"),dt>=Ee.MAX_PARALLEL_IMAGE_REQUESTS){const i={requestParameters:e,callback:t,cancelled:!1,cancel(){this.cancelled=!0;}};return ut.push(i),i;}dt++;let i=!1;const r=()=>{if(!i)for(i=!0,dt--;ut.length&&dt<Ee.MAX_PARALLEL_IMAGE_REQUESTS;){const e=ut.shift(),{requestParameters:t,callback:i,cancelled:r}=e;r||(e.cancel=pt(t,i).cancel);}},n=st(e,(e,i,n,o)=>{r(),e?t(e):i&&(s.createImageBitmap?function(e,t){const i=new s.Blob([new Uint8Array(e)],{type:"image/png"});s.createImageBitmap(i).then(e=>{t(null,e);}).catch(e=>{t(new Error(`Could not load image because of ${e.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`));});}(i,(e,i)=>t(e,i,n,o)):function(e,t){const i=new s.Image(),r=s.URL;i.onload=()=>{t(null,i),r.revokeObjectURL(i.src),i.onload=null,s.requestAnimationFrame(()=>{i.src=ht;});},i.onerror=()=>t(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const n=new s.Blob([new Uint8Array(e)],{type:"image/png"});i.src=e.byteLength?r.createObjectURL(n):ht;}(i,(e,i)=>t(e,i,n,o)));});return {cancel:()=>{n.cancel(),r();}};};function ft(e,t,i){i[e]&&-1!==i[e].indexOf(t)||(i[e]=i[e]||[],i[e].push(t));}function mt(e,t,i){if(i&&i[e]){const r=i[e].indexOf(t);-1!==r&&i[e].splice(r,1);}}class _t{constructor(e,t={}){ee(this,t),this.type=e;}}class gt extends _t{constructor(e,t={}){super("error",ee({error:e},t));}}class yt{on(e,t){return this._listeners=this._listeners||{},ft(e,t,this._listeners),this;}off(e,t){return mt(e,t,this._listeners),mt(e,t,this._oneTimeListeners),this;}once(e,t){return t?(this._oneTimeListeners=this._oneTimeListeners||{},ft(e,t,this._oneTimeListeners),this):new Promise(t=>this.once(e,t));}fire(e,t){"string"==typeof e&&(e=new _t(e,t||{}));const i=e.type;if(this.listens(i)){e.target=this;const t=this._listeners&&this._listeners[i]?this._listeners[i].slice():[];for(const i of t)i.call(this,e);const r=this._oneTimeListeners&&this._oneTimeListeners[i]?this._oneTimeListeners[i].slice():[];for(const t of r)mt(i,t,this._oneTimeListeners),t.call(this,e);const n=this._eventedParent;n&&(ee(e,"function"==typeof this._eventedParentData?this._eventedParentData():this._eventedParentData),n.fire(e));}else e instanceof gt&&console.error(e.error);return this;}listens(e){return !!(this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e));}setEventedParent(e,t){return this._eventedParent=e,this._eventedParentData=t,this;}}var xt=JSON.parse('{"$version":8,"$root":{"version":{"required":true,"type":"enum","values":[8]},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360,"units":"degrees"},"pitch":{"type":"number","default":0,"units":"degrees"},"light":{"type":"light"},"terrain":{"type":"terrain"},"fog":{"type":"fog"},"sources":{"required":true,"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"required":true,"type":"array","value":"layer"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_geojson","source_video","source_image"],"source_vector":{"type":{"required":true,"type":"enum","values":{"vector":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"scheme":{"type":"enum","values":{"xyz":{},"tms":{}},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"required":true,"type":"enum","values":{"raster":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512,"units":"pixels"},"scheme":{"type":"enum","values":{"xyz":{},"tms":{}},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"required":true,"type":"enum","values":{"raster-dem":{}}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512,"units":"pixels"},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":{},"mapbox":{}},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"required":true,"type":"enum","values":{"geojson":{}}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"}},"source_video":{"type":{"required":true,"type":"enum","values":{"video":{}}},"urls":{"required":true,"type":"array","value":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"required":true,"type":"enum","values":{"image":{}}},"url":{"required":true,"type":"string"},"coordinates":{"required":true,"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"layer":{"id":{"type":"string","required":true},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"raster":{},"hillshade":{},"background":{},"sky":{}},"required":true},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"}},"layout":["layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_symbol","layout_raster","layout_hillshade","layout_background","layout_sky"],"layout_background":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":{},"round":{},"square":{}},"default":"butt","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":{},"round":{},"miter":{}},"default":"miter","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"requires":[{"line-join":"miter"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-round-limit":{"type":"number","default":1.05,"requires":[{"line-join":"round"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":{},"line":{},"line-center":{}},"default":"point","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-spacing":{"type":"number","default":250,"minimum":1,"units":"pixels","requires":[{"symbol-placement":"line"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"symbol-sort-key":{"type":"number","expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":{},"viewport-y":{},"source":{}},"default":"auto","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-allow-overlap":{"type":"boolean","default":false,"requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-ignore-placement":{"type":"boolean","default":false,"requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-optional":{"type":"boolean","default":false,"requires":["icon-image","text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-rotation-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-size":{"type":"number","default":1,"minimum":0,"units":"factor of the original icon size","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit":{"type":"enum","values":{"none":{},"width":{},"height":{},"both":{}},"default":"none","requires":["icon-image","text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"units":"pixels","requires":["icon-image","text-field",{"icon-text-fit":["both","width","height"]}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-image":{"type":"resolvedImage","tokens":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"units":"degrees","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-keep-upright":{"type":"boolean","default":false,"requires":["icon-image",{"icon-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"default":"center","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-rotation-alignment":{"type":"enum","values":{"map":{},"viewport":{},"auto":{}},"default":"auto","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-width":{"type":"number","default":10,"minimum":0,"units":"ems","requires":["text-field",{"symbol-placement":["point"]}],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"units":"ems","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"units":"ems","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":{},"left":{},"center":{},"right":{}},"default":"center","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","units":"ems","default":0,"requires":["text-field"],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"requires":["text-field",{"symbol-placement":["point"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-anchor":{"type":"enum","values":{"center":{},"left":{},"right":{},"top":{},"bottom":{},"top-left":{},"top-right":{},"bottom-left":{},"bottom-right":{}},"default":"center","requires":["text-field",{"!":"text-variable-anchor"}],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"units":"degrees","requires":["text-field",{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":{},"vertical":{}},"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-rotate":{"type":"number","default":0,"period":360,"units":"degrees","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-keep-upright":{"type":"boolean","default":true,"requires":["text-field",{"text-rotation-alignment":"map"},{"symbol-placement":["line","line-center"]}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-transform":{"type":"enum","values":{"none":{},"uppercase":{},"lowercase":{}},"default":"none","requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","units":"ems","length":2,"default":[0,0],"requires":["text-field",{"!":"text-radial-offset"}],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-ignore-placement":{"type":"boolean","default":false,"requires":["text-field"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-optional":{"type":"boolean","default":false,"requires":["text-field","icon-image"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":{},"none":{}},"default":"visible","property-type":"constant"}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"transition":false,"property-type":"data-driven","expression":{"interpolated":false,"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":{},"!=":{},">":{},">=":{},"<":{},"<=":{},"in":{},"!in":{},"all":{},"any":{},"none":{},"has":{},"!has":{},"within":{}}},"geometry_type":{"type":"enum","values":{"Point":{},"LineString":{},"Polygon":{}}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":{},"exponential":{},"interval":{},"categorical":{}},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":{},"lab":{},"hcl":{}},"default":"rgb"},"default":{"type":"*","required":false}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"horizon-blend":{"type":"number","property-type":"data-constant","default":0.1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":{},"viewport":{}},"property-type":"data-constant","transition":false,"expression":{"interpolated":false,"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","property-type":"data-constant","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","property-type":"data-constant","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"intensity":{"type":"number","property-type":"data-constant","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":{},"equalEarth":{},"equirectangular":{},"lambertConformalConic":{},"mercator":{},"naturalEarth":{},"winkelTripel":{}},"default":"mercator","required":true},"center":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":false,"requires":[{"name":["albers","lambertConformalConic"]}]},"parallels":{"type":"array","length":2,"value":"number","property-type":"data-constant","transition":false,"requires":[{"name":["albers","lambertConformalConic"]}]}},"terrain":{"source":{"type":"string","required":true},"exaggeration":{"type":"number","property-type":"data-constant","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_symbol","paint_raster","paint_hillshade","paint_background","paint_sky"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"fill-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","transition":true,"requires":[{"!":"fill-pattern"},{"fill-antialias":true}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["fill-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"fill-extrusion-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["fill-extrusion-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"fill-extrusion-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"units":"meters","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"units":"meters","transition":true,"requires":["fill-extrusion-height"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"line-pattern"}],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"line-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["line-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"transition":true,"units":"line widths","requires":[{"!":"line-pattern"}],"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom","feature"]},"property-type":"cross-faded-data-driven"},"line-gradient":{"type":"color","transition":false,"requires":[{"!":"line-pattern"},{"source":"geojson","has":{"lineMetrics":true}}],"expression":{"interpolated":true,"parameters":["line-progress"]},"property-type":"color-ramp"}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"circle-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["circle-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-scale":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-pitch-alignment":{"type":"enum","values":{"map":{},"viewport":{}},"default":"viewport","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"units":"pixels","expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"transition":false,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"transition":false,"expression":{"interpolated":true,"parameters":["heatmap-density"]},"property-type":"color-ramp"},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","requires":["icon-image"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"icon-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["icon-image","icon-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","transition":true,"overridable":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","transition":true,"requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"units":"pixels","requires":["text-field"],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"text-translate-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"map","requires":["text-field","text-translate"],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"units":"degrees","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"raster-resampling":{"type":"enum","values":{"linear":{},"nearest":{}},"default":"linear","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"transition":false,"units":"milliseconds","expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"transition":false,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-illumination-anchor":{"type":"enum","values":{"map":{},"viewport":{}},"default":"viewport","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-shadow-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"hillshade-accent-color":{"type":"color","default":"#000000","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_background":{"background-color":{"type":"color","default":"#000000","transition":true,"requires":[{"!":"background-pattern"}],"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"},"background-pattern":{"type":"resolvedImage","transition":true,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"cross-faded"},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":{},"atmosphere":{}},"default":"atmosphere","expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"units":"degrees","minimum":[0,0],"maximum":[360,180],"transition":false,"requires":[{"sky-type":"atmosphere"}],"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-atmosphere-sun-intensity":{"type":"number","requires":[{"sky-type":"atmosphere"}],"default":10,"minimum":0,"maximum":100,"transition":false,"property-type":"data-constant"},"sky-gradient-center":{"type":"array","requires":[{"sky-type":"gradient"}],"value":"number","default":[0,0],"length":2,"units":"degrees","minimum":[0,0],"maximum":[360,180],"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient-radius":{"type":"number","requires":[{"sky-type":"gradient"}],"default":90,"minimum":0,"maximum":180,"transition":false,"expression":{"interpolated":false,"parameters":["zoom"]},"property-type":"data-constant"},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"transition":false,"requires":[{"sky-type":"gradient"}],"expression":{"interpolated":true,"parameters":["sky-radial-progress"]},"property-type":"color-ramp"},"sky-atmosphere-halo-color":{"type":"color","default":"white","transition":false,"requires":[{"sky-type":"atmosphere"}],"property-type":"data-constant"},"sky-atmosphere-color":{"type":"color","default":"white","transition":false,"requires":[{"sky-type":"atmosphere"}],"property-type":"data-constant"},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"property-type":"data-constant"}},"transition":{"duration":{"type":"number","default":300,"minimum":0,"units":"milliseconds"},"delay":{"type":"number","default":0,"minimum":0,"units":"milliseconds"}},"property-type":{"data-driven":{"type":"property-type"},"cross-faded":{"type":"property-type"},"cross-faded-data-driven":{"type":"property-type"},"color-ramp":{"type":"property-type"},"data-constant":{"type":"property-type"},"constant":{"type":"property-type"}},"promoteId":{"*":{"type":"string"}}}');class vt{constructor(e,t,i,r){this.message=(e?`${e}: `:"")+i,r&&(this.identifier=r),null!=t&&t.__line__&&(this.line=t.__line__);}}function bt(e){const t=e.value;return t?[new vt(e.key,t,"constants have been deprecated as of v8")]:[];}function St(e,...t){for(const i of t)for(const t in i)e[t]=i[t];return e;}function wt(e){return e instanceof Number||e instanceof String||e instanceof Boolean?e.valueOf():e;}function Tt(e){if(Array.isArray(e))return e.map(Tt);if(e instanceof Object&&!(e instanceof Number||e instanceof String||e instanceof Boolean)){const t={};for(const i in e)t[i]=Tt(e[i]);return t;}return wt(e);}class Et extends Error{constructor(e,t){super(t),this.message=t,this.key=e;}}class Nt{constructor(e,t=[]){this.parent=e,this.bindings={};for(const[e,i]of t)this.bindings[e]=i;}concat(e){return new Nt(this,e);}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`);}has(e){return !!this.bindings[e]||!!this.parent&&this.parent.has(e);}}const It={kind:"null"},Mt={kind:"number"},Ct={kind:"string"},At={kind:"boolean"},Pt={kind:"color"},Lt={kind:"object"},Dt={kind:"value"},kt={kind:"collator"},zt={kind:"formatted"},Rt={kind:"resolvedImage"};function Ot(e,t){return {kind:"array",itemType:e,N:t};}function Ft(e){if("array"===e.kind){const t=Ft(e.itemType);return "number"==typeof e.N?`array<${t}, ${e.N}>`:"value"===e.itemType.kind?"array":`array<${t}>`;}return e.kind;}const Bt=[It,Mt,Ct,At,Pt,zt,Lt,Ot(Dt),Rt];function Ut(e,t){if("error"===t.kind)return null;if("array"===e.kind){if("array"===t.kind&&(0===t.N&&"value"===t.itemType.kind||!Ut(e.itemType,t.itemType))&&("number"!=typeof e.N||e.N===t.N))return null;}else {if(e.kind===t.kind)return null;if("value"===e.kind)for(const e of Bt)if(!Ut(e,t))return null;}return `Expected ${Ft(e)} but found ${Ft(t)} instead.`;}function Vt(e,t){return t.some(t=>t.kind===e.kind);}function Gt(e,t){return t.some(t=>"null"===t?null===e:"array"===t?Array.isArray(e):"object"===t?e&&!Array.isArray(e)&&"object"==typeof e:t===typeof e);}function jt(e){var t={exports:{}};return e(t,t.exports),t.exports;}var $t=jt(function(e,t){var i={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function r(e){return (e=Math.round(e))<0?0:e>255?255:e;}function n(e){return r("%"===e[e.length-1]?parseFloat(e)/100*255:parseInt(e));}function o(e){return (t="%"===e[e.length-1]?parseFloat(e)/100:parseFloat(e))<0?0:t>1?1:t;var t;}function s(e,t,i){return i<0?i+=1:i>1&&(i-=1),6*i<1?e+(t-e)*i*6:2*i<1?t:3*i<2?e+(t-e)*(2/3-i)*6:e;}try{t.parseCSSColor=function(e){var t,a=e.replace(/ /g,"").toLowerCase();if(a in i)return i[a].slice();if("#"===a[0])return 4===a.length?(t=parseInt(a.substr(1),16))>=0&&t<=4095?[(3840&t)>>4|(3840&t)>>8,240&t|(240&t)>>4,15&t|(15&t)<<4,1]:null:7===a.length&&(t=parseInt(a.substr(1),16))>=0&&t<=16777215?[(16711680&t)>>16,(65280&t)>>8,255&t,1]:null;var l=a.indexOf("("),c=a.indexOf(")");if(-1!==l&&c+1===a.length){var h=a.substr(0,l),u=a.substr(l+1,c-(l+1)).split(","),d=1;switch(h){case"rgba":if(4!==u.length)return null;d=o(u.pop());case"rgb":return 3!==u.length?null:[n(u[0]),n(u[1]),n(u[2]),d];case"hsla":if(4!==u.length)return null;d=o(u.pop());case"hsl":if(3!==u.length)return null;var p=(parseFloat(u[0])%360+360)%360/360,f=o(u[1]),m=o(u[2]),_=m<=.5?m*(f+1):m+f-m*f,g=2*m-_;return [r(255*s(g,_,p+1/3)),r(255*s(g,_,p)),r(255*s(g,_,p-1/3)),d];default:return null;}}return null;};}catch(e){}});class Ht{constructor(e,t,i,r=1){this.r=e,this.g=t,this.b=i,this.a=r;}static parse(e){if(!e)return;if(e instanceof Ht)return e;if("string"!=typeof e)return;const t=$t.parseCSSColor(e);return t?new Ht(t[0]/255*t[3],t[1]/255*t[3],t[2]/255*t[3],t[3]):void 0;}toString(){const[e,t,i,r]=this.toArray();return `rgba(${Math.round(e)},${Math.round(t)},${Math.round(i)},${r})`;}toArray(){const{r:e,g:t,b:i,a:r}=this;return 0===r?[0,0,0,0]:[255*e/r,255*t/r,255*i/r,r];}}Ht.black=new Ht(0,0,0,1),Ht.white=new Ht(1,1,1,1),Ht.transparent=new Ht(0,0,0,0),Ht.red=new Ht(1,0,0,1),Ht.blue=new Ht(0,0,1,1);class qt{constructor(e,t,i){this.sensitivity=e?t?"variant":"case":t?"accent":"base",this.locale=i,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"});}compare(e,t){return this.collator.compare(e,t);}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale;}}class Zt{constructor(e,t,i,r,n){this.text=e.normalize?e.normalize():e,this.image=t,this.scale=i,this.fontStack=r,this.textColor=n;}}class Xt{constructor(e){this.sections=e;}static fromString(e){return new Xt([new Zt(e,null,null,null,null)]);}isEmpty(){return 0===this.sections.length||!this.sections.some(e=>0!==e.text.length||e.image&&0!==e.image.name.length);}static factory(e){return e instanceof Xt?e:Xt.fromString(e);}toString(){return 0===this.sections.length?"":this.sections.map(e=>e.text).join("");}serialize(){const e=["format"];for(const t of this.sections){if(t.image){e.push(["image",t.image.name]);continue;}e.push(t.text);const i={};t.fontStack&&(i["text-font"]=["literal",t.fontStack.split(",")]),t.scale&&(i["font-scale"]=t.scale),t.textColor&&(i["text-color"]=["rgba"].concat(t.textColor.toArray())),e.push(i);}return e;}}class Wt{constructor(e){this.name=e.name,this.available=e.available;}toString(){return this.name;}static fromString(e){return e?new Wt({name:e,available:!1}):null;}serialize(){return ["image",this.name];}}function Yt(e,t,i,r){return "number"==typeof e&&e>=0&&e<=255&&"number"==typeof t&&t>=0&&t<=255&&"number"==typeof i&&i>=0&&i<=255?void 0===r||"number"==typeof r&&r>=0&&r<=1?null:`Invalid rgba value [${[e,t,i,r].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${("number"==typeof r?[e,t,i,r]:[e,t,i]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`;}function Jt(e){if(null===e)return !0;if("string"==typeof e)return !0;if("boolean"==typeof e)return !0;if("number"==typeof e)return !0;if(e instanceof Ht)return !0;if(e instanceof qt)return !0;if(e instanceof Xt)return !0;if(e instanceof Wt)return !0;if(Array.isArray(e)){for(const t of e)if(!Jt(t))return !1;return !0;}if("object"==typeof e){for(const t in e)if(!Jt(e[t]))return !1;return !0;}return !1;}function Kt(e){if(null===e)return It;if("string"==typeof e)return Ct;if("boolean"==typeof e)return At;if("number"==typeof e)return Mt;if(e instanceof Ht)return Pt;if(e instanceof qt)return kt;if(e instanceof Xt)return zt;if(e instanceof Wt)return Rt;if(Array.isArray(e)){const t=e.length;let i;for(const t of e){const e=Kt(t);if(i){if(i===e)continue;i=Dt;break;}i=e;}return Ot(i||Dt,t);}return Lt;}function Qt(e){const t=typeof e;return null===e?"":"string"===t||"number"===t||"boolean"===t?String(e):e instanceof Ht||e instanceof Xt||e instanceof Wt?e.toString():JSON.stringify(e);}class ei{constructor(e,t){this.type=e,this.value=t;}static parse(e,t){if(2!==e.length)return t.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!Jt(e[1]))return t.error("invalid value");const i=e[1];let r=Kt(i);const n=t.expectedType;return "array"!==r.kind||0!==r.N||!n||"array"!==n.kind||"number"==typeof n.N&&0!==n.N||(r=n),new ei(r,i);}evaluate(){return this.value;}eachChild(){}outputDefined(){return !0;}serialize(){return "array"===this.type.kind||"object"===this.type.kind?["literal",this.value]:this.value instanceof Ht?["rgba"].concat(this.value.toArray()):this.value instanceof Xt?this.value.serialize():this.value;}}class ti{constructor(e){this.name="ExpressionEvaluationError",this.message=e;}toJSON(){return this.message;}}const ii={string:Ct,number:Mt,boolean:At,object:Lt};class ri{constructor(e,t){this.type=e,this.args=t;}static parse(e,t){if(e.length<2)return t.error("Expected at least one argument.");let i,r=1;const n=e[0];if("array"===n){let n,o;if(e.length>2){const i=e[1];if("string"!=typeof i||!(i in ii)||"object"===i)return t.error('The item type argument of "array" must be one of string, number, boolean',1);n=ii[i],r++;}else n=Dt;if(e.length>3){if(null!==e[2]&&("number"!=typeof e[2]||e[2]<0||e[2]!==Math.floor(e[2])))return t.error('The length argument to "array" must be a positive integer literal',2);o=e[2],r++;}i=Ot(n,o);}else i=ii[n];const o=[];for(;r<e.length;r++){const i=t.parse(e[r],r,Dt);if(!i)return null;o.push(i);}return new ri(i,o);}evaluate(e){for(let t=0;t<this.args.length;t++){const i=this.args[t].evaluate(e);if(!Ut(this.type,Kt(i)))return i;if(t===this.args.length-1)throw new ti(`Expected value to be of type ${Ft(this.type)}, but found ${Ft(Kt(i))} instead.`);}return null;}eachChild(e){this.args.forEach(e);}outputDefined(){return this.args.every(e=>e.outputDefined());}serialize(){const e=this.type,t=[e.kind];if("array"===e.kind){const i=e.itemType;if("string"===i.kind||"number"===i.kind||"boolean"===i.kind){t.push(i.kind);const r=e.N;("number"==typeof r||this.args.length>1)&&t.push(r);}}return t.concat(this.args.map(e=>e.serialize()));}}class ni{constructor(e){this.type=zt,this.sections=e;}static parse(e,t){if(e.length<2)return t.error("Expected at least one argument.");const i=e[1];if(!Array.isArray(i)&&"object"==typeof i)return t.error("First argument must be an image or text section.");const r=[];let n=!1;for(let i=1;i<=e.length-1;++i){const o=e[i];if(n&&"object"==typeof o&&!Array.isArray(o)){n=!1;let e=null;if(o["font-scale"]&&(e=t.parse(o["font-scale"],1,Mt),!e))return null;let i=null;if(o["text-font"]&&(i=t.parse(o["text-font"],1,Ot(Ct)),!i))return null;let s=null;if(o["text-color"]&&(s=t.parse(o["text-color"],1,Pt),!s))return null;const a=r[r.length-1];a.scale=e,a.font=i,a.textColor=s;}else {const o=t.parse(e[i],1,Dt);if(!o)return null;const s=o.type.kind;if("string"!==s&&"value"!==s&&"null"!==s&&"resolvedImage"!==s)return t.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");n=!0,r.push({content:o,scale:null,font:null,textColor:null});}}return new ni(r);}evaluate(e){return new Xt(this.sections.map(t=>{const i=t.content.evaluate(e);return Kt(i)===Rt?new Zt("",i,null,null,null):new Zt(Qt(i),null,t.scale?t.scale.evaluate(e):null,t.font?t.font.evaluate(e).join(","):null,t.textColor?t.textColor.evaluate(e):null);}));}eachChild(e){for(const t of this.sections)e(t.content),t.scale&&e(t.scale),t.font&&e(t.font),t.textColor&&e(t.textColor);}outputDefined(){return !1;}serialize(){const e=["format"];for(const t of this.sections){e.push(t.content.serialize());const i={};t.scale&&(i["font-scale"]=t.scale.serialize()),t.font&&(i["text-font"]=t.font.serialize()),t.textColor&&(i["text-color"]=t.textColor.serialize()),e.push(i);}return e;}}class oi{constructor(e){this.type=Rt,this.input=e;}static parse(e,t){if(2!==e.length)return t.error("Expected two arguments.");const i=t.parse(e[1],1,Ct);return i?new oi(i):t.error("No image name provided.");}evaluate(e){const t=this.input.evaluate(e),i=Wt.fromString(t);return i&&e.availableImages&&(i.available=e.availableImages.indexOf(t)>-1),i;}eachChild(e){e(this.input);}outputDefined(){return !1;}serialize(){return ["image",this.input.serialize()];}}const si={"to-boolean":At,"to-color":Pt,"to-number":Mt,"to-string":Ct};class ai{constructor(e,t){this.type=e,this.args=t;}static parse(e,t){if(e.length<2)return t.error("Expected at least one argument.");const i=e[0];if(("to-boolean"===i||"to-string"===i)&&2!==e.length)return t.error("Expected one argument.");const r=si[i],n=[];for(let i=1;i<e.length;i++){const r=t.parse(e[i],i,Dt);if(!r)return null;n.push(r);}return new ai(r,n);}evaluate(e){if("boolean"===this.type.kind)return Boolean(this.args[0].evaluate(e));if("color"===this.type.kind){let t,i;for(const r of this.args){if(t=r.evaluate(e),i=null,t instanceof Ht)return t;if("string"==typeof t){const i=e.parseColor(t);if(i)return i;}else if(Array.isArray(t)&&(i=t.length<3||t.length>4?`Invalid rbga value ${JSON.stringify(t)}: expected an array containing either three or four numeric values.`:Yt(t[0],t[1],t[2],t[3]),!i))return new Ht(t[0]/255,t[1]/255,t[2]/255,t[3]);}throw new ti(i||`Could not parse color from value '${"string"==typeof t?t:String(JSON.stringify(t))}'`);}if("number"===this.type.kind){let t=null;for(const i of this.args){if(t=i.evaluate(e),null===t)return 0;const r=Number(t);if(!isNaN(r))return r;}throw new ti(`Could not convert ${JSON.stringify(t)} to number.`);}return "formatted"===this.type.kind?Xt.fromString(Qt(this.args[0].evaluate(e))):"resolvedImage"===this.type.kind?Wt.fromString(Qt(this.args[0].evaluate(e))):Qt(this.args[0].evaluate(e));}eachChild(e){this.args.forEach(e);}outputDefined(){return this.args.every(e=>e.outputDefined());}serialize(){if("formatted"===this.type.kind)return new ni([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if("resolvedImage"===this.type.kind)return new oi(this.args[0]).serialize();const e=[`to-${this.type.kind}`];return this.eachChild(t=>{e.push(t.serialize());}),e;}}const li=["Unknown","Point","LineString","Polygon"];class ci{constructor(){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null;}id(){return this.feature&&"id"in this.feature?this.feature.id:null;}geometryType(){return this.feature?"number"==typeof this.feature.type?li[this.feature.type]:this.feature.type:null;}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null;}canonicalID(){return this.canonical;}properties(){return this.feature&&this.feature.properties||{};}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const e=this.featureDistanceData.center,t=this.featureDistanceData.scale,{x:i,y:r}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(i*t-e[0])+this.featureDistanceData.bearing[1]*(r*t-e[1]);}return 0;}parseColor(e){let t=this._parseColorCache[e];return t||(t=this._parseColorCache[e]=Ht.parse(e)),t;}}class hi{constructor(e,t,i,r){this.name=e,this.type=t,this._evaluate=i,this.args=r;}evaluate(e){return this._evaluate(e,this.args);}eachChild(e){this.args.forEach(e);}outputDefined(){return !1;}serialize(){return [this.name].concat(this.args.map(e=>e.serialize()));}static parse(e,t){const i=e[0],r=hi.definitions[i];if(!r)return t.error(`Unknown expression "${i}". If you wanted a literal array, use ["literal", [...]].`,0);const n=Array.isArray(r)?r[0]:r.type,o=Array.isArray(r)?[[r[1],r[2]]]:r.overloads,s=o.filter(([t])=>!Array.isArray(t)||t.length===e.length-1);let a=null;for(const[r,o]of s){a=new Di(t.registry,t.path,null,t.scope);const s=[];let l=!1;for(let t=1;t<e.length;t++){const i=e[t],n=Array.isArray(r)?r[t-1]:r.type,o=a.parse(i,1+s.length,n);if(!o){l=!0;break;}s.push(o);}if(!l)if(Array.isArray(r)&&r.length!==s.length)a.error(`Expected ${r.length} arguments, but found ${s.length} instead.`);else {for(let e=0;e<s.length;e++){const t=Array.isArray(r)?r[e]:r.type,i=s[e];a.concat(e+1).checkSubtype(t,i.type);}if(0===a.errors.length)return new hi(i,n,o,s);}}if(1===s.length)t.errors.push(...a.errors);else {const i=(s.length?s:o).map(([e])=>{return t=e,Array.isArray(t)?`(${t.map(Ft).join(", ")})`:`(${Ft(t.type)}...)`;var t;}).join(" | "),r=[];for(let i=1;i<e.length;i++){const n=t.parse(e[i],1+r.length);if(!n)return null;r.push(Ft(n.type));}t.error(`Expected arguments of type ${i}, but found (${r.join(", ")}) instead.`);}return null;}static register(e,t){hi.definitions=t;for(const i in t)e[i]=hi;}}class ui{constructor(e,t,i){this.type=kt,this.locale=i,this.caseSensitive=e,this.diacriticSensitive=t;}static parse(e,t){if(2!==e.length)return t.error("Expected one argument.");const i=e[1];if("object"!=typeof i||Array.isArray(i))return t.error("Collator options argument must be an object.");const r=t.parse(void 0!==i["case-sensitive"]&&i["case-sensitive"],1,At);if(!r)return null;const n=t.parse(void 0!==i["diacritic-sensitive"]&&i["diacritic-sensitive"],1,At);if(!n)return null;let o=null;return i.locale&&(o=t.parse(i.locale,1,Ct),!o)?null:new ui(r,n,o);}evaluate(e){return new qt(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null);}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale);}outputDefined(){return !1;}serialize(){const e={};return e["case-sensitive"]=this.caseSensitive.serialize(),e["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(e.locale=this.locale.serialize()),["collator",e];}}const di=8192;function pi(e,t){e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[2]=Math.max(e[2],t[0]),e[3]=Math.max(e[3],t[1]);}function fi(e,t){return !(e[0]<=t[0]||e[2]>=t[2]||e[1]<=t[1]||e[3]>=t[3]);}function mi(e,t){const i=(180+e[0])/360,r=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+e[1]*Math.PI/360)))/360,n=Math.pow(2,t.z);return [Math.round(i*n*di),Math.round(r*n*di)];}function _i(e,t,i){const r=e[0]-t[0],n=e[1]-t[1],o=e[0]-i[0],s=e[1]-i[1];return r*s-o*n==0&&r*o<=0&&n*s<=0;}function gi(e,t){let i=!1;for(let s=0,a=t.length;s<a;s++){const a=t[s];for(let t=0,s=a.length;t<s-1;t++){if(_i(e,a[t],a[t+1]))return !1;(n=a[t])[1]>(r=e)[1]!=(o=a[t+1])[1]>r[1]&&r[0]<(o[0]-n[0])*(r[1]-n[1])/(o[1]-n[1])+n[0]&&(i=!i);}}var r,n,o;return i;}function yi(e,t){for(let i=0;i<t.length;i++)if(gi(e,t[i]))return !0;return !1;}function xi(e,t,i,r){const n=r[0]-i[0],o=r[1]-i[1],s=(e[0]-i[0])*o-n*(e[1]-i[1]),a=(t[0]-i[0])*o-n*(t[1]-i[1]);return s>0&&a<0||s<0&&a>0;}function vi(e,t,i){for(const c of i)for(let i=0;i<c.length-1;++i)if(0!=(a=[(s=c[i+1])[0]-(o=c[i])[0],s[1]-o[1]])[0]*(l=[(n=t)[0]-(r=e)[0],n[1]-r[1]])[1]-a[1]*l[0]&&xi(r,n,o,s)&&xi(o,s,r,n))return !0;var r,n,o,s,a,l;return !1;}function bi(e,t){for(let i=0;i<e.length;++i)if(!gi(e[i],t))return !1;for(let i=0;i<e.length-1;++i)if(vi(e[i],e[i+1],t))return !1;return !0;}function Si(e,t){for(let i=0;i<t.length;i++)if(bi(e,t[i]))return !0;return !1;}function wi(e,t,i){const r=[];for(let n=0;n<e.length;n++){const o=[];for(let r=0;r<e[n].length;r++){const s=mi(e[n][r],i);pi(t,s),o.push(s);}r.push(o);}return r;}function Ti(e,t,i){const r=[];for(let n=0;n<e.length;n++){const o=wi(e[n],t,i);r.push(o);}return r;}function Ei(e,t,i,r){if(e[0]<i[0]||e[0]>i[2]){const t=.5*r;let n=e[0]-i[0]>t?-r:i[0]-e[0]>t?r:0;0===n&&(n=e[0]-i[2]>t?-r:i[2]-e[0]>t?r:0),e[0]+=n;}pi(t,e);}function Ni(e,t,i,r){const n=Math.pow(2,r.z)*di,o=[r.x*di,r.y*di],s=[];for(const r of e)for(const e of r){const r=[e.x+o[0],e.y+o[1]];Ei(r,t,i,n),s.push(r);}return s;}function Ii(e,t,i,r){const n=Math.pow(2,r.z)*di,o=[r.x*di,r.y*di],s=[];for(const i of e){const e=[];for(const r of i){const i=[r.x+o[0],r.y+o[1]];pi(t,i),e.push(i);}s.push(e);}if(t[2]-t[0]<=n/2){(a=t)[0]=a[1]=1/0,a[2]=a[3]=-1/0;for(const e of s)for(const r of e)Ei(r,t,i,n);}var a;return s;}class Mi{constructor(e,t){this.type=At,this.geojson=e,this.geometries=t;}static parse(e,t){if(2!==e.length)return t.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(Jt(e[1])){const t=e[1];if("FeatureCollection"===t.type)for(let e=0;e<t.features.length;++e){const i=t.features[e].geometry.type;if("Polygon"===i||"MultiPolygon"===i)return new Mi(t,t.features[e].geometry);}else if("Feature"===t.type){const e=t.geometry.type;if("Polygon"===e||"MultiPolygon"===e)return new Mi(t,t.geometry);}else if("Polygon"===t.type||"MultiPolygon"===t.type)return new Mi(t,t);}return t.error("'within' expression requires valid geojson object that contains polygon geometry type.");}evaluate(e){if(null!=e.geometry()&&null!=e.canonicalID()){if("Point"===e.geometryType())return function(e,t){const i=[1/0,1/0,-1/0,-1/0],r=[1/0,1/0,-1/0,-1/0],n=e.canonicalID();if("Polygon"===t.type){const o=wi(t.coordinates,r,n),s=Ni(e.geometry(),i,r,n);if(!fi(i,r))return !1;for(const e of s)if(!gi(e,o))return !1;}if("MultiPolygon"===t.type){const o=Ti(t.coordinates,r,n),s=Ni(e.geometry(),i,r,n);if(!fi(i,r))return !1;for(const e of s)if(!yi(e,o))return !1;}return !0;}(e,this.geometries);if("LineString"===e.geometryType())return function(e,t){const i=[1/0,1/0,-1/0,-1/0],r=[1/0,1/0,-1/0,-1/0],n=e.canonicalID();if("Polygon"===t.type){const o=wi(t.coordinates,r,n),s=Ii(e.geometry(),i,r,n);if(!fi(i,r))return !1;for(const e of s)if(!bi(e,o))return !1;}if("MultiPolygon"===t.type){const o=Ti(t.coordinates,r,n),s=Ii(e.geometry(),i,r,n);if(!fi(i,r))return !1;for(const e of s)if(!Si(e,o))return !1;}return !0;}(e,this.geometries);}return !1;}eachChild(){}outputDefined(){return !0;}serialize(){return ["within",this.geojson];}}function Ci(e){if(e instanceof hi){if("get"===e.name&&1===e.args.length)return !1;if("feature-state"===e.name)return !1;if("has"===e.name&&1===e.args.length)return !1;if("properties"===e.name||"geometry-type"===e.name||"id"===e.name)return !1;if(/^filter-/.test(e.name))return !1;}if(e instanceof Mi)return !1;let t=!0;return e.eachChild(e=>{t&&!Ci(e)&&(t=!1);}),t;}function Ai(e){if(e instanceof hi&&"feature-state"===e.name)return !1;let t=!0;return e.eachChild(e=>{t&&!Ai(e)&&(t=!1);}),t;}function Pi(e,t){if(e instanceof hi&&t.indexOf(e.name)>=0)return !1;let i=!0;return e.eachChild(e=>{i&&!Pi(e,t)&&(i=!1);}),i;}class Li{constructor(e,t){this.type=t.type,this.name=e,this.boundExpression=t;}static parse(e,t){if(2!==e.length||"string"!=typeof e[1])return t.error("'var' expression requires exactly one string literal argument.");const i=e[1];return t.scope.has(i)?new Li(i,t.scope.get(i)):t.error(`Unknown variable "${i}". Make sure "${i}" has been bound in an enclosing "let" expression before using it.`,1);}evaluate(e){return this.boundExpression.evaluate(e);}eachChild(){}outputDefined(){return !1;}serialize(){return ["var",this.name];}}class Di{constructor(e,t=[],i,r=new Nt(),n=[]){this.registry=e,this.path=t,this.key=t.map(e=>`[${e}]`).join(""),this.scope=r,this.errors=n,this.expectedType=i;}parse(e,t,i,r,n={}){return t?this.concat(t,i,r)._parse(e,n):this._parse(e,n);}_parse(e,t){function i(e,t,i){return "assert"===i?new ri(t,[e]):"coerce"===i?new ai(t,[e]):e;}if(null!==e&&"string"!=typeof e&&"boolean"!=typeof e&&"number"!=typeof e||(e=["literal",e]),Array.isArray(e)){if(0===e.length)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const r=e[0];if("string"!=typeof r)return this.error(`Expression name must be a string, but found ${typeof r} instead. If you wanted a literal array, use ["literal", [...]].`,0),null;const n=this.registry[r];if(n){let r=n.parse(e,this);if(!r)return null;if(this.expectedType){const e=this.expectedType,n=r.type;if("string"!==e.kind&&"number"!==e.kind&&"boolean"!==e.kind&&"object"!==e.kind&&"array"!==e.kind||"value"!==n.kind){if("color"!==e.kind&&"formatted"!==e.kind&&"resolvedImage"!==e.kind||"value"!==n.kind&&"string"!==n.kind){if(this.checkSubtype(e,n))return null;}else r=i(r,e,t.typeAnnotation||"coerce");}else r=i(r,e,t.typeAnnotation||"assert");}if(!(r instanceof ei)&&"resolvedImage"!==r.type.kind&&ki(r)){const t=new ci();try{r=new ei(r.type,r.evaluate(t));}catch(e){return this.error(e.message),null;}}return r;}return this.error(`Unknown expression "${r}". If you wanted a literal array, use ["literal", [...]].`,0);}return this.error(void 0===e?"'undefined' value invalid. Use null instead.":"object"==typeof e?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`);}concat(e,t,i){const r="number"==typeof e?this.path.concat(e):this.path,n=i?this.scope.concat(i):this.scope;return new Di(this.registry,r,t||null,n,this.errors);}error(e,...t){const i=`${this.key}${t.map(e=>`[${e}]`).join("")}`;this.errors.push(new Et(i,e));}checkSubtype(e,t){const i=Ut(e,t);return i&&this.error(i),i;}}function ki(e){if(e instanceof Li)return ki(e.boundExpression);if(e instanceof hi&&"error"===e.name)return !1;if(e instanceof ui)return !1;if(e instanceof Mi)return !1;const t=e instanceof ai||e instanceof ri;let i=!0;return e.eachChild(e=>{i=t?i&&ki(e):i&&e instanceof ei;}),!!i&&Ci(e)&&Pi(e,["zoom","heatmap-density","line-progress","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center"]);}function zi(e,t){const i=e.length-1;let r,n,o=0,s=i,a=0;for(;o<=s;)if(a=Math.floor((o+s)/2),r=e[a],n=e[a+1],r<=t){if(a===i||t<n)return a;o=a+1;}else {if(!(r>t))throw new ti("Input is not a number.");s=a-1;}return 0;}class Ri{constructor(e,t,i){this.type=e,this.input=t,this.labels=[],this.outputs=[];for(const[e,t]of i)this.labels.push(e),this.outputs.push(t);}static parse(e,t){if(e.length-1<4)return t.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return t.error("Expected an even number of arguments.");const i=t.parse(e[1],1,Mt);if(!i)return null;const r=[];let n=null;t.expectedType&&"value"!==t.expectedType.kind&&(n=t.expectedType);for(let i=1;i<e.length;i+=2){const o=1===i?-1/0:e[i],s=e[i+1],a=i,l=i+1;if("number"!=typeof o)return t.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',a);if(r.length&&r[r.length-1][0]>=o)return t.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',a);const c=t.parse(s,l,n);if(!c)return null;n=n||c.type,r.push([o,c]);}return new Ri(n,i,r);}evaluate(e){const t=this.labels,i=this.outputs;if(1===t.length)return i[0].evaluate(e);const r=this.input.evaluate(e);if(r<=t[0])return i[0].evaluate(e);const n=t.length;return r>=t[n-1]?i[n-1].evaluate(e):i[zi(t,r)].evaluate(e);}eachChild(e){e(this.input);for(const t of this.outputs)e(t);}outputDefined(){return this.outputs.every(e=>e.outputDefined());}serialize(){const e=["step",this.input.serialize()];for(let t=0;t<this.labels.length;t++)t>0&&e.push(this.labels[t]),e.push(this.outputs[t].serialize());return e;}}function Oi(e,t,i){return e*(1-i)+t*i;}var Fi=Object.freeze({__proto__:null,number:Oi,color:function(e,t,i){return new Ht(Oi(e.r,t.r,i),Oi(e.g,t.g,i),Oi(e.b,t.b,i),Oi(e.a,t.a,i));},array:function(e,t,i){return e.map((e,r)=>Oi(e,t[r],i));}});const Bi=.95047,Ui=1.08883,Vi=4/29,Gi=6/29,ji=3*Gi*Gi,$i=Math.PI/180,Hi=180/Math.PI;function qi(e){return e>.008856451679035631?Math.pow(e,1/3):e/ji+Vi;}function Zi(e){return e>Gi?e*e*e:ji*(e-Vi);}function Xi(e){return 255*(e<=.0031308?12.92*e:1.055*Math.pow(e,1/2.4)-.055);}function Wi(e){return (e/=255)<=.04045?e/12.92:Math.pow((e+.055)/1.055,2.4);}function Yi(e){const t=Wi(e.r),i=Wi(e.g),r=Wi(e.b),n=qi((.4124564*t+.3575761*i+.1804375*r)/Bi),o=qi((.2126729*t+.7151522*i+.072175*r)/1);return {l:116*o-16,a:500*(n-o),b:200*(o-qi((.0193339*t+.119192*i+.9503041*r)/Ui)),alpha:e.a};}function Ji(e){let t=(e.l+16)/116,i=isNaN(e.a)?t:t+e.a/500,r=isNaN(e.b)?t:t-e.b/200;return t=1*Zi(t),i=Bi*Zi(i),r=Ui*Zi(r),new Ht(Xi(3.2404542*i-1.5371385*t-.4985314*r),Xi(-.969266*i+1.8760108*t+.041556*r),Xi(.0556434*i-.2040259*t+1.0572252*r),e.alpha);}function Ki(e,t,i){const r=t-e;return e+i*(r>180||r<-180?r-360*Math.round(r/360):r);}const Qi={forward:Yi,reverse:Ji,interpolate:function(e,t,i){return {l:Oi(e.l,t.l,i),a:Oi(e.a,t.a,i),b:Oi(e.b,t.b,i),alpha:Oi(e.alpha,t.alpha,i)};}},er={forward:function(e){const{l:t,a:i,b:r}=Yi(e),n=Math.atan2(r,i)*Hi;return {h:n<0?n+360:n,c:Math.sqrt(i*i+r*r),l:t,alpha:e.a};},reverse:function(e){const t=e.h*$i,i=e.c;return Ji({l:e.l,a:Math.cos(t)*i,b:Math.sin(t)*i,alpha:e.alpha});},interpolate:function(e,t,i){return {h:Ki(e.h,t.h,i),c:Oi(e.c,t.c,i),l:Oi(e.l,t.l,i),alpha:Oi(e.alpha,t.alpha,i)};}};var tr=Object.freeze({__proto__:null,lab:Qi,hcl:er});class ir{constructor(e,t,i,r,n){this.type=e,this.operator=t,this.interpolation=i,this.input=r,this.labels=[],this.outputs=[];for(const[e,t]of n)this.labels.push(e),this.outputs.push(t);}static interpolationFactor(e,t,r,n){let o=0;if("exponential"===e.name)o=rr(t,e.base,r,n);else if("linear"===e.name)o=rr(t,1,r,n);else if("cubic-bezier"===e.name){const s=e.controlPoints;o=new i(s[0],s[1],s[2],s[3]).solve(rr(t,1,r,n));}return o;}static parse(e,t){let[i,r,n,...o]=e;if(!Array.isArray(r)||0===r.length)return t.error("Expected an interpolation type expression.",1);if("linear"===r[0])r={name:"linear"};else if("exponential"===r[0]){const e=r[1];if("number"!=typeof e)return t.error("Exponential interpolation requires a numeric base.",1,1);r={name:"exponential",base:e};}else {if("cubic-bezier"!==r[0])return t.error(`Unknown interpolation type ${String(r[0])}`,1,0);{const e=r.slice(1);if(4!==e.length||e.some(e=>"number"!=typeof e||e<0||e>1))return t.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);r={name:"cubic-bezier",controlPoints:e};}}if(e.length-1<4)return t.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return t.error("Expected an even number of arguments.");if(n=t.parse(n,2,Mt),!n)return null;const s=[];let a=null;"interpolate-hcl"===i||"interpolate-lab"===i?a=Pt:t.expectedType&&"value"!==t.expectedType.kind&&(a=t.expectedType);for(let e=0;e<o.length;e+=2){const i=o[e],r=o[e+1],n=e+3,l=e+4;if("number"!=typeof i)return t.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',n);if(s.length&&s[s.length-1][0]>=i)return t.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',n);const c=t.parse(r,l,a);if(!c)return null;a=a||c.type,s.push([i,c]);}return "number"===a.kind||"color"===a.kind||"array"===a.kind&&"number"===a.itemType.kind&&"number"==typeof a.N?new ir(a,i,r,n,s):t.error(`Type ${Ft(a)} is not interpolatable.`);}evaluate(e){const t=this.labels,i=this.outputs;if(1===t.length)return i[0].evaluate(e);const r=this.input.evaluate(e);if(r<=t[0])return i[0].evaluate(e);const n=t.length;if(r>=t[n-1])return i[n-1].evaluate(e);const o=zi(t,r),s=ir.interpolationFactor(this.interpolation,r,t[o],t[o+1]),a=i[o].evaluate(e),l=i[o+1].evaluate(e);return "interpolate"===this.operator?Fi[this.type.kind.toLowerCase()](a,l,s):"interpolate-hcl"===this.operator?er.reverse(er.interpolate(er.forward(a),er.forward(l),s)):Qi.reverse(Qi.interpolate(Qi.forward(a),Qi.forward(l),s));}eachChild(e){e(this.input);for(const t of this.outputs)e(t);}outputDefined(){return this.outputs.every(e=>e.outputDefined());}serialize(){let e;e="linear"===this.interpolation.name?["linear"]:"exponential"===this.interpolation.name?1===this.interpolation.base?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier"].concat(this.interpolation.controlPoints);const t=[this.operator,e,this.input.serialize()];for(let e=0;e<this.labels.length;e++)t.push(this.labels[e],this.outputs[e].serialize());return t;}}function rr(e,t,i,r){const n=r-i,o=e-i;return 0===n?0:1===t?o/n:(Math.pow(t,o)-1)/(Math.pow(t,n)-1);}class nr{constructor(e,t){this.type=e,this.args=t;}static parse(e,t){if(e.length<2)return t.error("Expectected at least one argument.");let i=null;const r=t.expectedType;r&&"value"!==r.kind&&(i=r);const n=[];for(const r of e.slice(1)){const e=t.parse(r,1+n.length,i,void 0,{typeAnnotation:"omit"});if(!e)return null;i=i||e.type,n.push(e);}const o=r&&n.some(e=>Ut(r,e.type));return new nr(o?Dt:i,n);}evaluate(e){let t,i=null,r=0;for(const n of this.args){if(r++,i=n.evaluate(e),i&&i instanceof Wt&&!i.available&&(t||(t=i),i=null,r===this.args.length))return t;if(null!==i)break;}return i;}eachChild(e){this.args.forEach(e);}outputDefined(){return this.args.every(e=>e.outputDefined());}serialize(){const e=["coalesce"];return this.eachChild(t=>{e.push(t.serialize());}),e;}}class or{constructor(e,t){this.type=t.type,this.bindings=[].concat(e),this.result=t;}evaluate(e){return this.result.evaluate(e);}eachChild(e){for(const t of this.bindings)e(t[1]);e(this.result);}static parse(e,t){if(e.length<4)return t.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const i=[];for(let r=1;r<e.length-1;r+=2){const n=e[r];if("string"!=typeof n)return t.error(`Expected string, but found ${typeof n} instead.`,r);if(/[^a-zA-Z0-9_]/.test(n))return t.error("Variable names must contain only alphanumeric characters or '_'.",r);const o=t.parse(e[r+1],r+1);if(!o)return null;i.push([n,o]);}const r=t.parse(e[e.length-1],e.length-1,t.expectedType,i);return r?new or(i,r):null;}outputDefined(){return this.result.outputDefined();}serialize(){const e=["let"];for(const[t,i]of this.bindings)e.push(t,i.serialize());return e.push(this.result.serialize()),e;}}class sr{constructor(e,t,i){this.type=e,this.index=t,this.input=i;}static parse(e,t){if(3!==e.length)return t.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const i=t.parse(e[1],1,Mt),r=t.parse(e[2],2,Ot(t.expectedType||Dt));return i&&r?new sr(r.type.itemType,i,r):null;}evaluate(e){const t=this.index.evaluate(e),i=this.input.evaluate(e);if(t<0)throw new ti(`Array index out of bounds: ${t} < 0.`);if(t>=i.length)throw new ti(`Array index out of bounds: ${t} > ${i.length-1}.`);if(t!==Math.floor(t))throw new ti(`Array index must be an integer, but found ${t} instead.`);return i[t];}eachChild(e){e(this.index),e(this.input);}outputDefined(){return !1;}serialize(){return ["at",this.index.serialize(),this.input.serialize()];}}class ar{constructor(e,t){this.type=At,this.needle=e,this.haystack=t;}static parse(e,t){if(3!==e.length)return t.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const i=t.parse(e[1],1,Dt),r=t.parse(e[2],2,Dt);return i&&r?Vt(i.type,[At,Ct,Mt,It,Dt])?new ar(i,r):t.error(`Expected first argument to be of type boolean, string, number or null, but found ${Ft(i.type)} instead`):null;}evaluate(e){const t=this.needle.evaluate(e),i=this.haystack.evaluate(e);if(!i)return !1;if(!Gt(t,["boolean","string","number","null"]))throw new ti(`Expected first argument to be of type boolean, string, number or null, but found ${Ft(Kt(t))} instead.`);if(!Gt(i,["string","array"]))throw new ti(`Expected second argument to be of type array or string, but found ${Ft(Kt(i))} instead.`);return i.indexOf(t)>=0;}eachChild(e){e(this.needle),e(this.haystack);}outputDefined(){return !0;}serialize(){return ["in",this.needle.serialize(),this.haystack.serialize()];}}class lr{constructor(e,t,i){this.type=Mt,this.needle=e,this.haystack=t,this.fromIndex=i;}static parse(e,t){if(e.length<=2||e.length>=5)return t.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const i=t.parse(e[1],1,Dt),r=t.parse(e[2],2,Dt);if(!i||!r)return null;if(!Vt(i.type,[At,Ct,Mt,It,Dt]))return t.error(`Expected first argument to be of type boolean, string, number or null, but found ${Ft(i.type)} instead`);if(4===e.length){const n=t.parse(e[3],3,Mt);return n?new lr(i,r,n):null;}return new lr(i,r);}evaluate(e){const t=this.needle.evaluate(e),i=this.haystack.evaluate(e);if(!Gt(t,["boolean","string","number","null"]))throw new ti(`Expected first argument to be of type boolean, string, number or null, but found ${Ft(Kt(t))} instead.`);if(!Gt(i,["string","array"]))throw new ti(`Expected second argument to be of type array or string, but found ${Ft(Kt(i))} instead.`);if(this.fromIndex){const r=this.fromIndex.evaluate(e);return i.indexOf(t,r);}return i.indexOf(t);}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex);}outputDefined(){return !1;}serialize(){if(null!=this.fromIndex&&void 0!==this.fromIndex){const e=this.fromIndex.serialize();return ["index-of",this.needle.serialize(),this.haystack.serialize(),e];}return ["index-of",this.needle.serialize(),this.haystack.serialize()];}}class cr{constructor(e,t,i,r,n,o){this.inputType=e,this.type=t,this.input=i,this.cases=r,this.outputs=n,this.otherwise=o;}static parse(e,t){if(e.length<5)return t.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return t.error("Expected an even number of arguments.");let i,r;t.expectedType&&"value"!==t.expectedType.kind&&(r=t.expectedType);const n={},o=[];for(let s=2;s<e.length-1;s+=2){let a=e[s];const l=e[s+1];Array.isArray(a)||(a=[a]);const c=t.concat(s);if(0===a.length)return c.error("Expected at least one branch label.");for(const e of a){if("number"!=typeof e&&"string"!=typeof e)return c.error("Branch labels must be numbers or strings.");if("number"==typeof e&&Math.abs(e)>Number.MAX_SAFE_INTEGER)return c.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if("number"==typeof e&&Math.floor(e)!==e)return c.error("Numeric branch labels must be integer values.");if(i){if(c.checkSubtype(i,Kt(e)))return null;}else i=Kt(e);if(void 0!==n[String(e)])return c.error("Branch labels must be unique.");n[String(e)]=o.length;}const h=t.parse(l,s,r);if(!h)return null;r=r||h.type,o.push(h);}const s=t.parse(e[1],1,Dt);if(!s)return null;const a=t.parse(e[e.length-1],e.length-1,r);return a?"value"!==s.type.kind&&t.concat(1).checkSubtype(i,s.type)?null:new cr(i,r,s,n,o,a):null;}evaluate(e){const t=this.input.evaluate(e);return (Kt(t)===this.inputType&&this.outputs[this.cases[t]]||this.otherwise).evaluate(e);}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise);}outputDefined(){return this.outputs.every(e=>e.outputDefined())&&this.otherwise.outputDefined();}serialize(){const e=["match",this.input.serialize()],t=Object.keys(this.cases).sort(),i=[],r={};for(const e of t){const t=r[this.cases[e]];void 0===t?(r[this.cases[e]]=i.length,i.push([this.cases[e],[e]])):i[t][1].push(e);}const n=e=>"number"===this.inputType.kind?Number(e):e;for(const[t,r]of i)e.push(1===r.length?n(r[0]):r.map(n)),e.push(this.outputs[t].serialize());return e.push(this.otherwise.serialize()),e;}}class hr{constructor(e,t,i){this.type=e,this.branches=t,this.otherwise=i;}static parse(e,t){if(e.length<4)return t.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return t.error("Expected an odd number of arguments.");let i;t.expectedType&&"value"!==t.expectedType.kind&&(i=t.expectedType);const r=[];for(let n=1;n<e.length-1;n+=2){const o=t.parse(e[n],n,At);if(!o)return null;const s=t.parse(e[n+1],n+1,i);if(!s)return null;r.push([o,s]),i=i||s.type;}const n=t.parse(e[e.length-1],e.length-1,i);return n?new hr(i,r,n):null;}evaluate(e){for(const[t,i]of this.branches)if(t.evaluate(e))return i.evaluate(e);return this.otherwise.evaluate(e);}eachChild(e){for(const[t,i]of this.branches)e(t),e(i);e(this.otherwise);}outputDefined(){return this.branches.every(([e,t])=>t.outputDefined())&&this.otherwise.outputDefined();}serialize(){const e=["case"];return this.eachChild(t=>{e.push(t.serialize());}),e;}}class ur{constructor(e,t,i,r){this.type=e,this.input=t,this.beginIndex=i,this.endIndex=r;}static parse(e,t){if(e.length<=2||e.length>=5)return t.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const i=t.parse(e[1],1,Dt),r=t.parse(e[2],2,Mt);if(!i||!r)return null;if(!Vt(i.type,[Ot(Dt),Ct,Dt]))return t.error(`Expected first argument to be of type array or string, but found ${Ft(i.type)} instead`);if(4===e.length){const n=t.parse(e[3],3,Mt);return n?new ur(i.type,i,r,n):null;}return new ur(i.type,i,r);}evaluate(e){const t=this.input.evaluate(e),i=this.beginIndex.evaluate(e);if(!Gt(t,["string","array"]))throw new ti(`Expected first argument to be of type array or string, but found ${Ft(Kt(t))} instead.`);if(this.endIndex){const r=this.endIndex.evaluate(e);return t.slice(i,r);}return t.slice(i);}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex);}outputDefined(){return !1;}serialize(){if(null!=this.endIndex&&void 0!==this.endIndex){const e=this.endIndex.serialize();return ["slice",this.input.serialize(),this.beginIndex.serialize(),e];}return ["slice",this.input.serialize(),this.beginIndex.serialize()];}}function dr(e,t){return "=="===e||"!="===e?"boolean"===t.kind||"string"===t.kind||"number"===t.kind||"null"===t.kind||"value"===t.kind:"string"===t.kind||"number"===t.kind||"value"===t.kind;}function pr(e,t,i,r){return 0===r.compare(t,i);}function fr(e,t,i){const r="=="!==e&&"!="!==e;return class n{constructor(e,t,i){this.type=At,this.lhs=e,this.rhs=t,this.collator=i,this.hasUntypedArgument="value"===e.type.kind||"value"===t.type.kind;}static parse(e,t){if(3!==e.length&&4!==e.length)return t.error("Expected two or three arguments.");const i=e[0];let o=t.parse(e[1],1,Dt);if(!o)return null;if(!dr(i,o.type))return t.concat(1).error(`"${i}" comparisons are not supported for type '${Ft(o.type)}'.`);let s=t.parse(e[2],2,Dt);if(!s)return null;if(!dr(i,s.type))return t.concat(2).error(`"${i}" comparisons are not supported for type '${Ft(s.type)}'.`);if(o.type.kind!==s.type.kind&&"value"!==o.type.kind&&"value"!==s.type.kind)return t.error(`Cannot compare types '${Ft(o.type)}' and '${Ft(s.type)}'.`);r&&("value"===o.type.kind&&"value"!==s.type.kind?o=new ri(s.type,[o]):"value"!==o.type.kind&&"value"===s.type.kind&&(s=new ri(o.type,[s])));let a=null;if(4===e.length){if("string"!==o.type.kind&&"string"!==s.type.kind&&"value"!==o.type.kind&&"value"!==s.type.kind)return t.error("Cannot use collator to compare non-string types.");if(a=t.parse(e[3],3,kt),!a)return null;}return new n(o,s,a);}evaluate(n){const o=this.lhs.evaluate(n),s=this.rhs.evaluate(n);if(r&&this.hasUntypedArgument){const t=Kt(o),i=Kt(s);if(t.kind!==i.kind||"string"!==t.kind&&"number"!==t.kind)throw new ti(`Expected arguments for "${e}" to be (string, string) or (number, number), but found (${t.kind}, ${i.kind}) instead.`);}if(this.collator&&!r&&this.hasUntypedArgument){const e=Kt(o),i=Kt(s);if("string"!==e.kind||"string"!==i.kind)return t(n,o,s);}return this.collator?i(n,o,s,this.collator.evaluate(n)):t(n,o,s);}eachChild(e){e(this.lhs),e(this.rhs),this.collator&&e(this.collator);}outputDefined(){return !0;}serialize(){const t=[e];return this.eachChild(e=>{t.push(e.serialize());}),t;}};}const mr=fr("==",function(e,t,i){return t===i;},pr),_r=fr("!=",function(e,t,i){return t!==i;},function(e,t,i,r){return !pr(0,t,i,r);}),gr=fr("<",function(e,t,i){return t<i;},function(e,t,i,r){return r.compare(t,i)<0;}),yr=fr(">",function(e,t,i){return t>i;},function(e,t,i,r){return r.compare(t,i)>0;}),xr=fr("<=",function(e,t,i){return t<=i;},function(e,t,i,r){return r.compare(t,i)<=0;}),vr=fr(">=",function(e,t,i){return t>=i;},function(e,t,i,r){return r.compare(t,i)>=0;});class br{constructor(e,t,i,r,n){this.type=Ct,this.number=e,this.locale=t,this.currency=i,this.minFractionDigits=r,this.maxFractionDigits=n;}static parse(e,t){if(3!==e.length)return t.error("Expected two arguments.");const i=t.parse(e[1],1,Mt);if(!i)return null;const r=e[2];if("object"!=typeof r||Array.isArray(r))return t.error("NumberFormat options argument must be an object.");let n=null;if(r.locale&&(n=t.parse(r.locale,1,Ct),!n))return null;let o=null;if(r.currency&&(o=t.parse(r.currency,1,Ct),!o))return null;let s=null;if(r["min-fraction-digits"]&&(s=t.parse(r["min-fraction-digits"],1,Mt),!s))return null;let a=null;return r["max-fraction-digits"]&&(a=t.parse(r["max-fraction-digits"],1,Mt),!a)?null:new br(i,n,o,s,a);}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:this.currency?"currency":"decimal",currency:this.currency?this.currency.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e));}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits);}outputDefined(){return !1;}serialize(){const e={};return this.locale&&(e.locale=this.locale.serialize()),this.currency&&(e.currency=this.currency.serialize()),this.minFractionDigits&&(e["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(e["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),e];}}class Sr{constructor(e){this.type=Mt,this.input=e;}static parse(e,t){if(2!==e.length)return t.error(`Expected 1 argument, but found ${e.length-1} instead.`);const i=t.parse(e[1],1);return i?"array"!==i.type.kind&&"string"!==i.type.kind&&"value"!==i.type.kind?t.error(`Expected argument of type string or array, but found ${Ft(i.type)} instead.`):new Sr(i):null;}evaluate(e){const t=this.input.evaluate(e);if("string"==typeof t)return t.length;if(Array.isArray(t))return t.length;throw new ti(`Expected value to be of type string or array, but found ${Ft(Kt(t))} instead.`);}eachChild(e){e(this.input);}outputDefined(){return !1;}serialize(){const e=["length"];return this.eachChild(t=>{e.push(t.serialize());}),e;}}const wr={"==":mr,"!=":_r,">":yr,"<":gr,">=":vr,"<=":xr,array:ri,at:sr,boolean:ri,case:hr,coalesce:nr,collator:ui,format:ni,image:oi,in:ar,"index-of":lr,interpolate:ir,"interpolate-hcl":ir,"interpolate-lab":ir,length:Sr,let:or,literal:ei,match:cr,number:ri,"number-format":br,object:ri,slice:ur,step:Ri,string:ri,"to-boolean":ai,"to-color":ai,"to-number":ai,"to-string":ai,var:Li,within:Mi};function Tr(e,[t,i,r,n]){t=t.evaluate(e),i=i.evaluate(e),r=r.evaluate(e);const o=n?n.evaluate(e):1,s=Yt(t,i,r,o);if(s)throw new ti(s);return new Ht(t/255*o,i/255*o,r/255*o,o);}function Er(e,t){return e in t;}function Nr(e,t){const i=t[e];return void 0===i?null:i;}function Ir(e){return {type:e};}function Mr(e){return {result:"success",value:e};}function Cr(e){return {result:"error",value:e};}function Ar(e){return "data-driven"===e["property-type"]||"cross-faded-data-driven"===e["property-type"];}function Pr(e){return !!e.expression&&e.expression.parameters.indexOf("zoom")>-1;}function Lr(e){return !!e.expression&&e.expression.interpolated;}function Dr(e){return e instanceof Number?"number":e instanceof String?"string":e instanceof Boolean?"boolean":Array.isArray(e)?"array":null===e?"null":typeof e;}function kr(e){return "object"==typeof e&&null!==e&&!Array.isArray(e);}function zr(e){return e;}function Rr(e,t){const i="color"===t.type,r=e.stops&&"object"==typeof e.stops[0][0],n=r||!(r||void 0!==e.property),o=e.type||(Lr(t)?"exponential":"interval");if(i&&((e=St({},e)).stops&&(e.stops=e.stops.map(e=>[e[0],Ht.parse(e[1])])),e.default=Ht.parse(e.default?e.default:t.default)),e.colorSpace&&"rgb"!==e.colorSpace&&!tr[e.colorSpace])throw new Error(`Unknown color space: ${e.colorSpace}`);let s,a,l;if("exponential"===o)s=Ur;else if("interval"===o)s=Br;else if("categorical"===o){s=Fr,a=Object.create(null);for(const t of e.stops)a[t[0]]=t[1];l=typeof e.stops[0][0];}else {if("identity"!==o)throw new Error(`Unknown function type "${o}"`);s=Vr;}if(r){const i={},r=[];for(let t=0;t<e.stops.length;t++){const n=e.stops[t],o=n[0].zoom;void 0===i[o]&&(i[o]={zoom:o,type:e.type,property:e.property,default:e.default,stops:[]},r.push(o)),i[o].stops.push([n[0].value,n[1]]);}const n=[];for(const e of r)n.push([i[e].zoom,Rr(i[e],t)]);const o={name:"linear"};return {kind:"composite",interpolationType:o,interpolationFactor:ir.interpolationFactor.bind(void 0,o),zoomStops:n.map(e=>e[0]),evaluate:({zoom:i},r)=>Ur({stops:n,base:e.base},t,i).evaluate(i,r)};}if(n){const i="exponential"===o?{name:"exponential",base:void 0!==e.base?e.base:1}:null;return {kind:"camera",interpolationType:i,interpolationFactor:ir.interpolationFactor.bind(void 0,i),zoomStops:e.stops.map(e=>e[0]),evaluate:({zoom:i})=>s(e,t,i,a,l)};}return {kind:"source",evaluate(i,r){const n=r&&r.properties?r.properties[e.property]:void 0;return void 0===n?Or(e.default,t.default):s(e,t,n,a,l);}};}function Or(e,t,i){return void 0!==e?e:void 0!==t?t:void 0!==i?i:void 0;}function Fr(e,t,i,r,n){return Or(typeof i===n?r[i]:void 0,e.default,t.default);}function Br(e,t,i){if("number"!==Dr(i))return Or(e.default,t.default);const r=e.stops.length;if(1===r)return e.stops[0][1];if(i<=e.stops[0][0])return e.stops[0][1];if(i>=e.stops[r-1][0])return e.stops[r-1][1];const n=zi(e.stops.map(e=>e[0]),i);return e.stops[n][1];}function Ur(e,t,i){const r=void 0!==e.base?e.base:1;if("number"!==Dr(i))return Or(e.default,t.default);const n=e.stops.length;if(1===n)return e.stops[0][1];if(i<=e.stops[0][0])return e.stops[0][1];if(i>=e.stops[n-1][0])return e.stops[n-1][1];const o=zi(e.stops.map(e=>e[0]),i),s=function(e,t,i,r){const n=r-i,o=e-i;return 0===n?0:1===t?o/n:(Math.pow(t,o)-1)/(Math.pow(t,n)-1);}(i,r,e.stops[o][0],e.stops[o+1][0]),a=e.stops[o][1],l=e.stops[o+1][1];let c=Fi[t.type]||zr;if(e.colorSpace&&"rgb"!==e.colorSpace){const t=tr[e.colorSpace];c=(e,i)=>t.reverse(t.interpolate(t.forward(e),t.forward(i),s));}return "function"==typeof a.evaluate?{evaluate(...e){const t=a.evaluate.apply(void 0,e),i=l.evaluate.apply(void 0,e);if(void 0!==t&&void 0!==i)return c(t,i,s);}}:c(a,l,s);}function Vr(e,t,i){return "color"===t.type?i=Ht.parse(i):"formatted"===t.type?i=Xt.fromString(i.toString()):"resolvedImage"===t.type?i=Wt.fromString(i.toString()):Dr(i)===t.type||"enum"===t.type&&t.values[i]||(i=void 0),Or(i,e.default,t.default);}hi.register(wr,{error:[{kind:"error"},[Ct],(e,[t])=>{throw new ti(t.evaluate(e));}],typeof:[Ct,[Dt],(e,[t])=>Ft(Kt(t.evaluate(e)))],"to-rgba":[Ot(Mt,4),[Pt],(e,[t])=>t.evaluate(e).toArray()],rgb:[Pt,[Mt,Mt,Mt],Tr],rgba:[Pt,[Mt,Mt,Mt,Mt],Tr],has:{type:At,overloads:[[[Ct],(e,[t])=>Er(t.evaluate(e),e.properties())],[[Ct,Lt],(e,[t,i])=>Er(t.evaluate(e),i.evaluate(e))]]},get:{type:Dt,overloads:[[[Ct],(e,[t])=>Nr(t.evaluate(e),e.properties())],[[Ct,Lt],(e,[t,i])=>Nr(t.evaluate(e),i.evaluate(e))]]},"feature-state":[Dt,[Ct],(e,[t])=>Nr(t.evaluate(e),e.featureState||{})],properties:[Lt,[],e=>e.properties()],"geometry-type":[Ct,[],e=>e.geometryType()],id:[Dt,[],e=>e.id()],zoom:[Mt,[],e=>e.globals.zoom],pitch:[Mt,[],e=>e.globals.pitch||0],"distance-from-center":[Mt,[],e=>e.distanceFromCenter()],"heatmap-density":[Mt,[],e=>e.globals.heatmapDensity||0],"line-progress":[Mt,[],e=>e.globals.lineProgress||0],"sky-radial-progress":[Mt,[],e=>e.globals.skyRadialProgress||0],accumulated:[Dt,[],e=>void 0===e.globals.accumulated?null:e.globals.accumulated],"+":[Mt,Ir(Mt),(e,t)=>{let i=0;for(const r of t)i+=r.evaluate(e);return i;}],"*":[Mt,Ir(Mt),(e,t)=>{let i=1;for(const r of t)i*=r.evaluate(e);return i;}],"-":{type:Mt,overloads:[[[Mt,Mt],(e,[t,i])=>t.evaluate(e)-i.evaluate(e)],[[Mt],(e,[t])=>-t.evaluate(e)]]},"/":[Mt,[Mt,Mt],(e,[t,i])=>t.evaluate(e)/i.evaluate(e)],"%":[Mt,[Mt,Mt],(e,[t,i])=>t.evaluate(e)%i.evaluate(e)],ln2:[Mt,[],()=>Math.LN2],pi:[Mt,[],()=>Math.PI],e:[Mt,[],()=>Math.E],"^":[Mt,[Mt,Mt],(e,[t,i])=>Math.pow(t.evaluate(e),i.evaluate(e))],sqrt:[Mt,[Mt],(e,[t])=>Math.sqrt(t.evaluate(e))],log10:[Mt,[Mt],(e,[t])=>Math.log(t.evaluate(e))/Math.LN10],ln:[Mt,[Mt],(e,[t])=>Math.log(t.evaluate(e))],log2:[Mt,[Mt],(e,[t])=>Math.log(t.evaluate(e))/Math.LN2],sin:[Mt,[Mt],(e,[t])=>Math.sin(t.evaluate(e))],cos:[Mt,[Mt],(e,[t])=>Math.cos(t.evaluate(e))],tan:[Mt,[Mt],(e,[t])=>Math.tan(t.evaluate(e))],asin:[Mt,[Mt],(e,[t])=>Math.asin(t.evaluate(e))],acos:[Mt,[Mt],(e,[t])=>Math.acos(t.evaluate(e))],atan:[Mt,[Mt],(e,[t])=>Math.atan(t.evaluate(e))],min:[Mt,Ir(Mt),(e,t)=>Math.min(...t.map(t=>t.evaluate(e)))],max:[Mt,Ir(Mt),(e,t)=>Math.max(...t.map(t=>t.evaluate(e)))],abs:[Mt,[Mt],(e,[t])=>Math.abs(t.evaluate(e))],round:[Mt,[Mt],(e,[t])=>{const i=t.evaluate(e);return i<0?-Math.round(-i):Math.round(i);}],floor:[Mt,[Mt],(e,[t])=>Math.floor(t.evaluate(e))],ceil:[Mt,[Mt],(e,[t])=>Math.ceil(t.evaluate(e))],"filter-==":[At,[Ct,Dt],(e,[t,i])=>e.properties()[t.value]===i.value],"filter-id-==":[At,[Dt],(e,[t])=>e.id()===t.value],"filter-type-==":[At,[Ct],(e,[t])=>e.geometryType()===t.value],"filter-<":[At,[Ct,Dt],(e,[t,i])=>{const r=e.properties()[t.value],n=i.value;return typeof r==typeof n&&r<n;}],"filter-id-<":[At,[Dt],(e,[t])=>{const i=e.id(),r=t.value;return typeof i==typeof r&&i<r;}],"filter->":[At,[Ct,Dt],(e,[t,i])=>{const r=e.properties()[t.value],n=i.value;return typeof r==typeof n&&r>n;}],"filter-id->":[At,[Dt],(e,[t])=>{const i=e.id(),r=t.value;return typeof i==typeof r&&i>r;}],"filter-<=":[At,[Ct,Dt],(e,[t,i])=>{const r=e.properties()[t.value],n=i.value;return typeof r==typeof n&&r<=n;}],"filter-id-<=":[At,[Dt],(e,[t])=>{const i=e.id(),r=t.value;return typeof i==typeof r&&i<=r;}],"filter->=":[At,[Ct,Dt],(e,[t,i])=>{const r=e.properties()[t.value],n=i.value;return typeof r==typeof n&&r>=n;}],"filter-id->=":[At,[Dt],(e,[t])=>{const i=e.id(),r=t.value;return typeof i==typeof r&&i>=r;}],"filter-has":[At,[Dt],(e,[t])=>t.value in e.properties()],"filter-has-id":[At,[],e=>null!==e.id()&&void 0!==e.id()],"filter-type-in":[At,[Ot(Ct)],(e,[t])=>t.value.indexOf(e.geometryType())>=0],"filter-id-in":[At,[Ot(Dt)],(e,[t])=>t.value.indexOf(e.id())>=0],"filter-in-small":[At,[Ct,Ot(Dt)],(e,[t,i])=>i.value.indexOf(e.properties()[t.value])>=0],"filter-in-large":[At,[Ct,Ot(Dt)],(e,[t,i])=>function(e,t,i,r){for(;i<=r;){const n=i+r>>1;if(t[n]===e)return !0;t[n]>e?r=n-1:i=n+1;}return !1;}(e.properties()[t.value],i.value,0,i.value.length-1)],all:{type:At,overloads:[[[At,At],(e,[t,i])=>t.evaluate(e)&&i.evaluate(e)],[Ir(At),(e,t)=>{for(const i of t)if(!i.evaluate(e))return !1;return !0;}]]},any:{type:At,overloads:[[[At,At],(e,[t,i])=>t.evaluate(e)||i.evaluate(e)],[Ir(At),(e,t)=>{for(const i of t)if(i.evaluate(e))return !0;return !1;}]]},"!":[At,[At],(e,[t])=>!t.evaluate(e)],"is-supported-script":[At,[Ct],(e,[t])=>{const i=e.globals&&e.globals.isSupportedScript;return !i||i(t.evaluate(e));}],upcase:[Ct,[Ct],(e,[t])=>t.evaluate(e).toUpperCase()],downcase:[Ct,[Ct],(e,[t])=>t.evaluate(e).toLowerCase()],concat:[Ct,Ir(Dt),(e,t)=>t.map(t=>Qt(t.evaluate(e))).join("")],"resolved-locale":[Ct,[kt],(e,[t])=>t.evaluate(e).resolvedLocale()]});class Gr{constructor(e,t){this.expression=e,this._warningHistory={},this._evaluator=new ci(),this._defaultValue=t?function(e){return "color"===e.type&&kr(e.default)?new Ht(0,0,0,0):"color"===e.type?Ht.parse(e.default)||null:void 0===e.default?null:e.default;}(t):null,this._enumValues=t&&"enum"===t.type?t.values:null;}evaluateWithoutErrorHandling(e,t,i,r,n,o,s,a){return this._evaluator.globals=e,this._evaluator.feature=t,this._evaluator.featureState=i,this._evaluator.canonical=r,this._evaluator.availableImages=n||null,this._evaluator.formattedSection=o,this._evaluator.featureTileCoord=s||null,this._evaluator.featureDistanceData=a||null,this.expression.evaluate(this._evaluator);}evaluate(e,t,i,r,n,o,s,a){this._evaluator.globals=e,this._evaluator.feature=t||null,this._evaluator.featureState=i||null,this._evaluator.canonical=r,this._evaluator.availableImages=n||null,this._evaluator.formattedSection=o||null,this._evaluator.featureTileCoord=s||null,this._evaluator.featureDistanceData=a||null;try{const e=this.expression.evaluate(this._evaluator);if(null==e||"number"==typeof e&&e!=e)return this._defaultValue;if(this._enumValues&&!(e in this._enumValues))throw new ti(`Expected value to be one of ${Object.keys(this._enumValues).map(e=>JSON.stringify(e)).join(", ")}, but found ${JSON.stringify(e)} instead.`);return e;}catch(e){return this._warningHistory[e.message]||(this._warningHistory[e.message]=!0,"undefined"!=typeof console&&console.warn(e.message)),this._defaultValue;}}}function jr(e){return Array.isArray(e)&&e.length>0&&"string"==typeof e[0]&&e[0]in wr;}function $r(e,t){const i=new Di(wr,[],t?function(e){const t={color:Pt,string:Ct,number:Mt,enum:Ct,boolean:At,formatted:zt,resolvedImage:Rt};return "array"===e.type?Ot(t[e.value]||Dt,e.length):t[e.type];}(t):void 0),r=i.parse(e,void 0,void 0,void 0,t&&"string"===t.type?{typeAnnotation:"coerce"}:void 0);return r?Mr(new Gr(r,t)):Cr(i.errors);}class Hr{constructor(e,t){this.kind=e,this._styleExpression=t,this.isStateDependent="constant"!==e&&!Ai(t.expression);}evaluateWithoutErrorHandling(e,t,i,r,n,o){return this._styleExpression.evaluateWithoutErrorHandling(e,t,i,r,n,o);}evaluate(e,t,i,r,n,o){return this._styleExpression.evaluate(e,t,i,r,n,o);}}class qr{constructor(e,t,i,r){this.kind=e,this.zoomStops=i,this._styleExpression=t,this.isStateDependent="camera"!==e&&!Ai(t.expression),this.interpolationType=r;}evaluateWithoutErrorHandling(e,t,i,r,n,o){return this._styleExpression.evaluateWithoutErrorHandling(e,t,i,r,n,o);}evaluate(e,t,i,r,n,o){return this._styleExpression.evaluate(e,t,i,r,n,o);}interpolationFactor(e,t,i){return this.interpolationType?ir.interpolationFactor(this.interpolationType,e,t,i):0;}}function Zr(e,t){if("error"===(e=$r(e,t)).result)return e;const i=e.value.expression,r=Ci(i);if(!r&&!Ar(t))return Cr([new Et("","data expressions not supported")]);const n=Pi(i,["zoom","pitch","distance-from-center"]);if(!n&&!Pr(t))return Cr([new Et("","zoom expressions not supported")]);const o=Wr(i);return o||n?o instanceof Et?Cr([o]):o instanceof ir&&!Lr(t)?Cr([new Et("",'"interpolate" expressions cannot be used with this property')]):Mr(o?new qr(r?"camera":"composite",e.value,o.labels,o instanceof ir?o.interpolation:void 0):new Hr(r?"constant":"source",e.value)):Cr([new Et("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.')]);}class Xr{constructor(e,t){this._parameters=e,this._specification=t,St(this,Rr(this._parameters,this._specification));}static deserialize(e){return new Xr(e._parameters,e._specification);}static serialize(e){return {_parameters:e._parameters,_specification:e._specification};}}function Wr(e){let t=null;if(e instanceof or)t=Wr(e.result);else if(e instanceof nr){for(const i of e.args)if(t=Wr(i),t)break;}else (e instanceof Ri||e instanceof ir)&&e.input instanceof hi&&"zoom"===e.input.name&&(t=e);return t instanceof Et||e.eachChild(e=>{const i=Wr(e);i instanceof Et?t=i:!t&&i?t=new Et("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression.'):t&&i&&t!==i&&(t=new Et("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'));}),t;}function Yr(e){const t=e.key,i=e.value,r=e.valueSpec||{},n=e.objectElementValidators||{},o=e.style,s=e.styleSpec;let a=[];const l=Dr(i);if("object"!==l)return [new vt(t,i,`object expected, ${l} found`)];for(const e in i){const l=e.split(".")[0],c=r[l]||r["*"];let h;if(n[l])h=n[l];else if(r[l])h=An;else if(n["*"])h=n["*"];else {if(!r["*"]){a.push(new vt(t,i[e],`unknown property "${e}"`));continue;}h=An;}a=a.concat(h({key:(t?`${t}.`:t)+e,value:i[e],valueSpec:c,style:o,styleSpec:s,object:i,objectKey:e},i));}for(const e in r)n[e]||r[e].required&&void 0===r[e].default&&void 0===i[e]&&a.push(new vt(t,i,`missing required property "${e}"`));return a;}function Jr(e){const t=e.value,i=e.valueSpec,r=e.style,n=e.styleSpec,o=e.key,s=e.arrayElementValidator||An;if("array"!==Dr(t))return [new vt(o,t,`array expected, ${Dr(t)} found`)];if(i.length&&t.length!==i.length)return [new vt(o,t,`array length ${i.length} expected, length ${t.length} found`)];if(i["min-length"]&&t.length<i["min-length"])return [new vt(o,t,`array length at least ${i["min-length"]} expected, length ${t.length} found`)];let a={type:i.value,values:i.values,minimum:i.minimum,maximum:i.maximum};n.$version<7&&(a.function=i.function),"object"===Dr(i.value)&&(a=i.value);let l=[];for(let e=0;e<t.length;e++)l=l.concat(s({array:t,arrayIndex:e,value:t[e],valueSpec:a,style:r,styleSpec:n,key:`${o}[${e}]`}));return l;}function Kr(e){const t=e.key,i=e.value,r=e.valueSpec;let n=Dr(i);if("number"===n&&i!=i&&(n="NaN"),"number"!==n)return [new vt(t,i,`number expected, ${n} found`)];if("minimum"in r){let n=r.minimum;if("array"===Dr(r.minimum)&&(n=r.minimum[e.arrayIndex]),i<n)return [new vt(t,i,`${i} is less than the minimum value ${n}`)];}if("maximum"in r){let n=r.maximum;if("array"===Dr(r.maximum)&&(n=r.maximum[e.arrayIndex]),i>n)return [new vt(t,i,`${i} is greater than the maximum value ${n}`)];}return [];}function Qr(e){const t=e.valueSpec,i=wt(e.value.type);let r,n,o,s={};const a="categorical"!==i&&void 0===e.value.property,l=!a,c="array"===Dr(e.value.stops)&&"array"===Dr(e.value.stops[0])&&"object"===Dr(e.value.stops[0][0]),h=Yr({key:e.key,value:e.value,valueSpec:e.styleSpec.function,style:e.style,styleSpec:e.styleSpec,objectElementValidators:{stops:function(e){if("identity"===i)return [new vt(e.key,e.value,'identity function may not have a "stops" property')];let t=[];const r=e.value;return t=t.concat(Jr({key:e.key,value:r,valueSpec:e.valueSpec,style:e.style,styleSpec:e.styleSpec,arrayElementValidator:u})),"array"===Dr(r)&&0===r.length&&t.push(new vt(e.key,r,"array must have at least one stop")),t;},default:function(e){return An({key:e.key,value:e.value,valueSpec:t,style:e.style,styleSpec:e.styleSpec});}}});return "identity"===i&&a&&h.push(new vt(e.key,e.value,'missing required property "property"')),"identity"===i||e.value.stops||h.push(new vt(e.key,e.value,'missing required property "stops"')),"exponential"===i&&e.valueSpec.expression&&!Lr(e.valueSpec)&&h.push(new vt(e.key,e.value,"exponential functions not supported")),e.styleSpec.$version>=8&&(l&&!Ar(e.valueSpec)?h.push(new vt(e.key,e.value,"property functions not supported")):a&&!Pr(e.valueSpec)&&h.push(new vt(e.key,e.value,"zoom functions not supported"))),"categorical"!==i&&!c||void 0!==e.value.property||h.push(new vt(e.key,e.value,'"property" property is required')),h;function u(e){let i=[];const r=e.value,a=e.key;if("array"!==Dr(r))return [new vt(a,r,`array expected, ${Dr(r)} found`)];if(2!==r.length)return [new vt(a,r,`array length 2 expected, length ${r.length} found`)];if(c){if("object"!==Dr(r[0]))return [new vt(a,r,`object expected, ${Dr(r[0])} found`)];if(void 0===r[0].zoom)return [new vt(a,r,"object stop key must have zoom")];if(void 0===r[0].value)return [new vt(a,r,"object stop key must have value")];if(o&&o>wt(r[0].zoom))return [new vt(a,r[0].zoom,"stop zoom values must appear in ascending order")];wt(r[0].zoom)!==o&&(o=wt(r[0].zoom),n=void 0,s={}),i=i.concat(Yr({key:`${a}[0]`,value:r[0],valueSpec:{zoom:{}},style:e.style,styleSpec:e.styleSpec,objectElementValidators:{zoom:Kr,value:d}}));}else i=i.concat(d({key:`${a}[0]`,value:r[0],valueSpec:{},style:e.style,styleSpec:e.styleSpec},r));return jr(Tt(r[1]))?i.concat([new vt(`${a}[1]`,r[1],"expressions are not allowed in function stops.")]):i.concat(An({key:`${a}[1]`,value:r[1],valueSpec:t,style:e.style,styleSpec:e.styleSpec}));}function d(e,o){const a=Dr(e.value),l=wt(e.value),c=null!==e.value?e.value:o;if(r){if(a!==r)return [new vt(e.key,c,`${a} stop domain type must match previous stop domain type ${r}`)];}else r=a;if("number"!==a&&"string"!==a&&"boolean"!==a)return [new vt(e.key,c,"stop domain value must be a number, string, or boolean")];if("number"!==a&&"categorical"!==i){let r=`number expected, ${a} found`;return Ar(t)&&void 0===i&&(r+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new vt(e.key,c,r)];}return "categorical"!==i||"number"!==a||isFinite(l)&&Math.floor(l)===l?"categorical"!==i&&"number"===a&&void 0!==n&&l<n?[new vt(e.key,c,"stop domain values must appear in ascending order")]:(n=l,"categorical"===i&&l in s?[new vt(e.key,c,"stop domain values must be unique")]:(s[l]=!0,[])):[new vt(e.key,c,`integer expected, found ${l}`)];}}function en(e){const t=("property"===e.expressionContext?Zr:$r)(Tt(e.value),e.valueSpec);if("error"===t.result)return t.value.map(t=>new vt(`${e.key}${t.key}`,e.value,t.message));const i=t.value.expression||t.value._styleExpression.expression;if("property"===e.expressionContext&&"text-font"===e.propertyKey&&!i.outputDefined())return [new vt(e.key,e.value,`Invalid data expression for "${e.propertyKey}". Output values must be contained as literals within the expression.`)];if("property"===e.expressionContext&&"layout"===e.propertyType&&!Ai(i))return [new vt(e.key,e.value,'"feature-state" data expressions are not supported with layout properties.')];if("filter"===e.expressionContext)return tn(i,e);if(e.expressionContext&&0===e.expressionContext.indexOf("cluster")){if(!Pi(i,["zoom","feature-state"]))return [new vt(e.key,e.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if("cluster-initial"===e.expressionContext&&!Ci(i))return [new vt(e.key,e.value,"Feature data expressions are not supported with initial expression part of cluster properties.")];}return [];}function tn(e,t){const i=new Set(["zoom","feature-state","pitch","distance-from-center"]);for(const e of t.valueSpec.expression.parameters)i.delete(e);if(0===i.size)return [];const r=[];return e instanceof hi&&i.has(e.name)?[new vt(t.key,t.value,`["${e.name}"] expression is not supported in a filter for a ${t.object.type} layer with id: ${t.object.id}`)]:(e.eachChild(e=>{r.push(...tn(e,t));}),r);}function rn(e){const t=e.key,i=e.value,r=e.valueSpec,n=[];return Array.isArray(r.values)?-1===r.values.indexOf(wt(i))&&n.push(new vt(t,i,`expected one of [${r.values.join(", ")}], ${JSON.stringify(i)} found`)):-1===Object.keys(r.values).indexOf(wt(i))&&n.push(new vt(t,i,`expected one of [${Object.keys(r.values).join(", ")}], ${JSON.stringify(i)} found`)),n;}function nn(e){if(!0===e||!1===e)return !0;if(!Array.isArray(e)||0===e.length)return !1;switch(e[0]){case"has":return e.length>=2&&"$id"!==e[1]&&"$type"!==e[1];case"in":return e.length>=3&&("string"!=typeof e[1]||Array.isArray(e[2]));case"!in":case"!has":case"none":return !1;case"==":case"!=":case">":case">=":case"<":case"<=":return 3!==e.length||Array.isArray(e[1])||Array.isArray(e[2]);case"any":case"all":for(const t of e.slice(1))if(!nn(t)&&"boolean"!=typeof t)return !1;return !0;default:return !0;}}function on(e,t="fill"){if(null==e)return {filter:()=>!0,needGeometry:!1,needFeature:!1};nn(e)||(e=dn(e));const i=e;let r=!0;try{r=function(e){if(!ln(e))return e;let t=Tt(e);return an(t),t=sn(t),t;}(i);}catch(e){console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.\nThis is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md\nand paste the contents of this message in the report.\nThank you!\nFilter Expression:\n${JSON.stringify(i,null,2)}\n        `);}const n=xt[`filter_${t}`],o=$r(r,n);let s=null;if("error"===o.result)throw new Error(o.value.map(e=>`${e.key}: ${e.message}`).join(", "));s=(e,t,i)=>o.value.evaluate(e,t,{},i);let a=null,l=null;if(r!==i){const e=$r(i,n);if("error"===e.result)throw new Error(e.value.map(e=>`${e.key}: ${e.message}`).join(", "));a=(t,i,r,n,o)=>e.value.evaluate(t,i,{},r,void 0,void 0,n,o),l=!Ci(e.value.expression);}return s=s,{filter:s,dynamicFilter:a||void 0,needGeometry:un(r),needFeature:!!l};}function sn(e){if(!Array.isArray(e))return e;const t=function(e){if(cn.has(e[0]))for(let t=1;t<e.length;t++)if(ln(e[t]))return !0;return e;}(e);return !0===t?t:t.map(e=>sn(e));}function an(e){let t=!1;const i=[];if("case"===e[0]){for(let r=1;r<e.length-1;r+=2)t=t||ln(e[r]),i.push(e[r+1]);i.push(e[e.length-1]);}else if("match"===e[0]){t=t||ln(e[1]);for(let t=2;t<e.length-1;t+=2)i.push(e[t+1]);i.push(e[e.length-1]);}else if("step"===e[0]){t=t||ln(e[1]);for(let t=1;t<e.length-1;t+=2)i.push(e[t+1]);}t&&(e.length=0,e.push("any",...i));for(let t=1;t<e.length;t++)an(e[t]);}function ln(e){if(!Array.isArray(e))return !1;if("pitch"===(t=e[0])||"distance-from-center"===t)return !0;var t;for(let t=1;t<e.length;t++)if(ln(e[t]))return !0;return !1;}const cn=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function hn(e,t){return e<t?-1:e>t?1:0;}function un(e){if(!Array.isArray(e))return !1;if("within"===e[0])return !0;for(let t=1;t<e.length;t++)if(un(e[t]))return !0;return !1;}function dn(e){if(!e)return !0;const t=e[0];return e.length<=1?"any"!==t:"=="===t?pn(e[1],e[2],"=="):"!="===t?_n(pn(e[1],e[2],"==")):"<"===t||">"===t||"<="===t||">="===t?pn(e[1],e[2],t):"any"===t?(i=e.slice(1),["any"].concat(i.map(dn))):"all"===t?["all"].concat(e.slice(1).map(dn)):"none"===t?["all"].concat(e.slice(1).map(dn).map(_n)):"in"===t?fn(e[1],e.slice(2)):"!in"===t?_n(fn(e[1],e.slice(2))):"has"===t?mn(e[1]):"!has"===t?_n(mn(e[1])):"within"!==t||e;var i;}function pn(e,t,i){switch(e){case"$type":return [`filter-type-${i}`,t];case"$id":return [`filter-id-${i}`,t];default:return [`filter-${i}`,e,t];}}function fn(e,t){if(0===t.length)return !1;switch(e){case"$type":return ["filter-type-in",["literal",t]];case"$id":return ["filter-id-in",["literal",t]];default:return t.length>200&&!t.some(e=>typeof e!=typeof t[0])?["filter-in-large",e,["literal",t.sort(hn)]]:["filter-in-small",e,["literal",t]];}}function mn(e){switch(e){case"$type":return !0;case"$id":return ["filter-has-id"];default:return ["filter-has",e];}}function _n(e){return ["!",e];}function gn(e){if(nn(Tt(e.value))){const t=Tt(e.layerType);return en(St({},e,{expressionContext:"filter",valueSpec:e.styleSpec[`filter_${t||"fill"}`]}));}return yn(e);}function yn(e){const t=e.value,i=e.key;if("array"!==Dr(t))return [new vt(i,t,`array expected, ${Dr(t)} found`)];const r=e.styleSpec;let n,o=[];if(t.length<1)return [new vt(i,t,"filter array must have at least 1 element")];switch(o=o.concat(rn({key:`${i}[0]`,value:t[0],valueSpec:r.filter_operator,style:e.style,styleSpec:e.styleSpec})),wt(t[0])){case"<":case"<=":case">":case">=":t.length>=2&&"$type"===wt(t[1])&&o.push(new vt(i,t,`"$type" cannot be use with operator "${t[0]}"`));case"==":case"!=":3!==t.length&&o.push(new vt(i,t,`filter array for operator "${t[0]}" must have 3 elements`));case"in":case"!in":t.length>=2&&(n=Dr(t[1]),"string"!==n&&o.push(new vt(`${i}[1]`,t[1],`string expected, ${n} found`)));for(let s=2;s<t.length;s++)n=Dr(t[s]),"$type"===wt(t[1])?o=o.concat(rn({key:`${i}[${s}]`,value:t[s],valueSpec:r.geometry_type,style:e.style,styleSpec:e.styleSpec})):"string"!==n&&"number"!==n&&"boolean"!==n&&o.push(new vt(`${i}[${s}]`,t[s],`string, number, or boolean expected, ${n} found`));break;case"any":case"all":case"none":for(let r=1;r<t.length;r++)o=o.concat(yn({key:`${i}[${r}]`,value:t[r],style:e.style,styleSpec:e.styleSpec}));break;case"has":case"!has":n=Dr(t[1]),2!==t.length?o.push(new vt(i,t,`filter array for "${t[0]}" operator must have 2 elements`)):"string"!==n&&o.push(new vt(`${i}[1]`,t[1],`string expected, ${n} found`));break;case"within":n=Dr(t[1]),2!==t.length?o.push(new vt(i,t,`filter array for "${t[0]}" operator must have 2 elements`)):"object"!==n&&o.push(new vt(`${i}[1]`,t[1],`object expected, ${n} found`));}return o;}function xn(e,t){const i=e.key,r=e.style,n=e.styleSpec,o=e.value,s=e.objectKey,a=n[`${t}_${e.layerType}`];if(!a)return [];const l=s.match(/^(.*)-transition$/);if("paint"===t&&l&&a[l[1]]&&a[l[1]].transition)return An({key:i,value:o,valueSpec:n.transition,style:r,styleSpec:n});const c=e.valueSpec||a[s];if(!c)return [new vt(i,o,`unknown property "${s}"`)];let h;if("string"===Dr(o)&&Ar(c)&&!c.tokens&&(h=/^{([^}]+)}$/.exec(o)))return [new vt(i,o,`"${s}" does not support interpolation syntax\nUse an identity property function instead: \`{ "type": "identity", "property": ${JSON.stringify(h[1])} }\`.`)];const u=[];return "symbol"===e.layerType&&("text-field"===s&&r&&!r.glyphs&&u.push(new vt(i,o,'use of "text-field" requires a style "glyphs" property')),"text-font"===s&&kr(Tt(o))&&"identity"===wt(o.type)&&u.push(new vt(i,o,'"text-font" does not support identity functions'))),u.concat(An({key:e.key,value:o,valueSpec:c,style:r,styleSpec:n,expressionContext:"property",propertyType:t,propertyKey:s}));}function vn(e){return xn(e,"paint");}function bn(e){return xn(e,"layout");}function Sn(e){let t=[];const i=e.value,r=e.key,n=e.style,o=e.styleSpec;i.type||i.ref||t.push(new vt(r,i,'either "type" or "ref" is required'));let s=wt(i.type);const a=wt(i.ref);if(i.id){const o=wt(i.id);for(let s=0;s<e.arrayIndex;s++){const e=n.layers[s];wt(e.id)===o&&t.push(new vt(r,i.id,`duplicate layer id "${i.id}", previously used at line ${e.id.__line__}`));}}if("ref"in i){let e;["type","source","source-layer","filter","layout"].forEach(e=>{e in i&&t.push(new vt(r,i[e],`"${e}" is prohibited for ref layers`));}),n.layers.forEach(t=>{wt(t.id)===a&&(e=t);}),e?e.ref?t.push(new vt(r,i.ref,"ref cannot reference another ref layer")):s=wt(e.type):t.push(new vt(r,i.ref,`ref layer "${a}" not found`));}else if("background"!==s&&"sky"!==s)if(i.source){const e=n.sources&&n.sources[i.source],o=e&&wt(e.type);e?"vector"===o&&"raster"===s?t.push(new vt(r,i.source,`layer "${i.id}" requires a raster source`)):"raster"===o&&"raster"!==s?t.push(new vt(r,i.source,`layer "${i.id}" requires a vector source`)):"vector"!==o||i["source-layer"]?"raster-dem"===o&&"hillshade"!==s?t.push(new vt(r,i.source,"raster-dem source can only be used with layer type 'hillshade'.")):"line"!==s||!i.paint||!i.paint["line-gradient"]||"geojson"===o&&e.lineMetrics||t.push(new vt(r,i,`layer "${i.id}" specifies a line-gradient, which requires a GeoJSON source with \`lineMetrics\` enabled.`)):t.push(new vt(r,i,`layer "${i.id}" must specify a "source-layer"`)):t.push(new vt(r,i.source,`source "${i.source}" not found`));}else t.push(new vt(r,i,'missing required property "source"'));return t=t.concat(Yr({key:r,value:i,valueSpec:o.layer,style:e.style,styleSpec:e.styleSpec,objectElementValidators:{"*":()=>[],type:()=>An({key:`${r}.type`,value:i.type,valueSpec:o.layer.type,style:e.style,styleSpec:e.styleSpec,object:i,objectKey:"type"}),filter:e=>gn(St({layerType:s},e)),layout:e=>Yr({layer:i,key:e.key,value:e.value,style:e.style,styleSpec:e.styleSpec,objectElementValidators:{"*":e=>bn(St({layerType:s},e))}}),paint:e=>Yr({layer:i,key:e.key,value:e.value,style:e.style,styleSpec:e.styleSpec,objectElementValidators:{"*":e=>vn(St({layerType:s},e))}})}})),t;}function wn(e){const t=e.value,i=e.key,r=Dr(t);return "string"!==r?[new vt(i,t,`string expected, ${r} found`)]:[];}const Tn={promoteId:function({key:e,value:t}){if("string"===Dr(t))return wn({key:e,value:t});{const i=[];for(const r in t)i.push(...wn({key:`${e}.${r}`,value:t[r]}));return i;}}};function En(e){const t=e.value,i=e.key,r=e.styleSpec,n=e.style;if(!t.type)return [new vt(i,t,'"type" is required')];const o=wt(t.type);let s;switch(o){case"vector":case"raster":case"raster-dem":return s=Yr({key:i,value:t,valueSpec:r[`source_${o.replace("-","_")}`],style:e.style,styleSpec:r,objectElementValidators:Tn}),s;case"geojson":if(s=Yr({key:i,value:t,valueSpec:r.source_geojson,style:n,styleSpec:r,objectElementValidators:Tn}),t.cluster)for(const e in t.clusterProperties){const[r,n]=t.clusterProperties[e],o="string"==typeof r?[r,["accumulated"],["get",e]]:r;s.push(...en({key:`${i}.${e}.map`,value:n,expressionContext:"cluster-map"})),s.push(...en({key:`${i}.${e}.reduce`,value:o,expressionContext:"cluster-reduce"}));}return s;case"video":return Yr({key:i,value:t,valueSpec:r.source_video,style:n,styleSpec:r});case"image":return Yr({key:i,value:t,valueSpec:r.source_image,style:n,styleSpec:r});case"canvas":return [new vt(i,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return rn({key:`${i}.type`,value:t.type,valueSpec:{values:["vector","raster","raster-dem","geojson","video","image"]},style:n,styleSpec:r});}}function Nn(e){const t=e.value,i=e.styleSpec,r=i.light,n=e.style;let o=[];const s=Dr(t);if(void 0===t)return o;if("object"!==s)return o=o.concat([new vt("light",t,`object expected, ${s} found`)]),o;for(const e in t){const s=e.match(/^(.*)-transition$/);o=o.concat(s&&r[s[1]]&&r[s[1]].transition?An({key:e,value:t[e],valueSpec:i.transition,style:n,styleSpec:i}):r[e]?An({key:e,value:t[e],valueSpec:r[e],style:n,styleSpec:i}):[new vt(e,t[e],`unknown property "${e}"`)]);}return o;}function In(e){const t=e.value,i=e.key,r=e.style,n=e.styleSpec,o=n.terrain;let s=[];const a=Dr(t);if(void 0===t)return s;if("object"!==a)return s=s.concat([new vt("terrain",t,`object expected, ${a} found`)]),s;for(const e in t){const i=e.match(/^(.*)-transition$/);s=s.concat(i&&o[i[1]]&&o[i[1]].transition?An({key:e,value:t[e],valueSpec:n.transition,style:r,styleSpec:n}):o[e]?An({key:e,value:t[e],valueSpec:o[e],style:r,styleSpec:n}):[new vt(e,t[e],`unknown property "${e}"`)]);}if(t.source){const e=r.sources&&r.sources[t.source],n=e&&wt(e.type);e?"raster-dem"!==n&&s.push(new vt(i,t.source,`terrain cannot be used with a source of type ${n}, it only be used with a "raster-dem" source type`)):s.push(new vt(i,t.source,`source "${t.source}" not found`));}else s.push(new vt(i,t,'terrain is missing required property "source"'));return s;}function Mn(e){const t=e.value,i=e.style,r=e.styleSpec,n=r.fog;let o=[];const s=Dr(t);if(void 0===t)return o;if("object"!==s)return o=o.concat([new vt("fog",t,`object expected, ${s} found`)]),o;for(const e in t){const s=e.match(/^(.*)-transition$/);o=o.concat(s&&n[s[1]]&&n[s[1]].transition?An({key:e,value:t[e],valueSpec:r.transition,style:i,styleSpec:r}):n[e]?An({key:e,value:t[e],valueSpec:n[e],style:i,styleSpec:r}):[new vt(e,t[e],`unknown property "${e}"`)]);}return o;}const Cn={"*":()=>[],array:Jr,boolean:function(e){const t=e.value,i=e.key,r=Dr(t);return "boolean"!==r?[new vt(i,t,`boolean expected, ${r} found`)]:[];},number:Kr,color:function(e){const t=e.key,i=e.value,r=Dr(i);return "string"!==r?[new vt(t,i,`color expected, ${r} found`)]:null===$t.parseCSSColor(i)?[new vt(t,i,`color expected, "${i}" found`)]:[];},constants:bt,enum:rn,filter:gn,function:Qr,layer:Sn,object:Yr,source:En,light:Nn,terrain:In,fog:Mn,string:wn,formatted:function(e){return 0===wn(e).length?[]:en(e);},resolvedImage:function(e){return 0===wn(e).length?[]:en(e);},projection:function(e){const t=e.value,i=e.styleSpec,r=i.projection,n=e.style;let o=[];const s=Dr(t);if("object"===s)for(const e in t)o=o.concat(An({key:e,value:t[e],valueSpec:r[e],style:n,styleSpec:i}));else "string"!==s&&(o=o.concat([new vt("projection",t,`object or string expected, ${s} found`)]));return o;}};function An(e){const t=e.value,i=e.valueSpec,r=e.styleSpec;return i.expression&&kr(wt(t))?Qr(e):i.expression&&jr(Tt(t))?en(e):i.type&&Cn[i.type]?Cn[i.type](e):Yr(St({},e,{valueSpec:i.type?r[i.type]:i}));}function Pn(e){const t=e.value,i=e.key,r=wn(e);return r.length||(-1===t.indexOf("{fontstack}")&&r.push(new vt(i,t,'"glyphs" url must include a "{fontstack}" token')),-1===t.indexOf("{range}")&&r.push(new vt(i,t,'"glyphs" url must include a "{range}" token'))),r;}function Ln(e,t=xt){let i=[];return i=i.concat(An({key:"",value:e,valueSpec:t.$root,styleSpec:t,style:e,objectElementValidators:{glyphs:Pn,"*":()=>[]}})),e.constants&&(i=i.concat(bt({key:"constants",value:e.constants,style:e,styleSpec:t}))),Dn(i);}function Dn(e){return [].concat(e).sort((e,t)=>e.line-t.line);}function kn(e){return function(...t){return Dn(e.apply(this,t));};}Ln.source=kn(En),Ln.light=kn(Nn),Ln.terrain=kn(In),Ln.fog=kn(Mn),Ln.layer=kn(Sn),Ln.filter=kn(gn),Ln.paintProperty=kn(vn),Ln.layoutProperty=kn(bn);const zn=Ln,Rn=zn.light,On=zn.fog,Fn=zn.paintProperty,Bn=zn.layoutProperty;function Un(e,t){let i=!1;if(t&&t.length)for(const r of t)e.fire(new gt(new Error(r.message))),i=!0;return i;}var Vn=Gn;function Gn(e,t,i){var r=this.cells=[];if(e instanceof ArrayBuffer){this.arrayBuffer=e;var n=new Int32Array(this.arrayBuffer);e=n[0],this.d=(t=n[1])+2*(i=n[2]);for(var o=0;o<this.d*this.d;o++){var s=n[3+o],a=n[3+o+1];r.push(s===a?null:n.subarray(s,a));}var l=n[3+r.length+1];this.keys=n.subarray(n[3+r.length],l),this.bboxes=n.subarray(l),this.insert=this._insertReadonly;}else {this.d=t+2*i;for(var c=0;c<this.d*this.d;c++)r.push([]);this.keys=[],this.bboxes=[];}this.n=t,this.extent=e,this.padding=i,this.scale=t/e,this.uid=0;var h=i/t*e;this.min=-h,this.max=e+h;}Gn.prototype.insert=function(e,t,i,r,n){this._forEachCell(t,i,r,n,this._insertCell,this.uid++),this.keys.push(e),this.bboxes.push(t),this.bboxes.push(i),this.bboxes.push(r),this.bboxes.push(n);},Gn.prototype._insertReadonly=function(){throw "Cannot insert into a GridIndex created from an ArrayBuffer.";},Gn.prototype._insertCell=function(e,t,i,r,n,o){this.cells[n].push(o);},Gn.prototype.query=function(e,t,i,r,n){var o=this.min,s=this.max;if(e<=o&&t<=o&&s<=i&&s<=r&&!n)return Array.prototype.slice.call(this.keys);var a=[];return this._forEachCell(e,t,i,r,this._queryCell,a,{},n),a;},Gn.prototype._queryCell=function(e,t,i,r,n,o,s,a){var l=this.cells[n];if(null!==l)for(var c=this.keys,h=this.bboxes,u=0;u<l.length;u++){var d=l[u];if(void 0===s[d]){var p=4*d;(a?a(h[p+0],h[p+1],h[p+2],h[p+3]):e<=h[p+2]&&t<=h[p+3]&&i>=h[p+0]&&r>=h[p+1])?(s[d]=!0,o.push(c[d])):s[d]=!1;}}},Gn.prototype._forEachCell=function(e,t,i,r,n,o,s,a){for(var l=this._convertToCellCoord(e),c=this._convertToCellCoord(t),h=this._convertToCellCoord(i),u=this._convertToCellCoord(r),d=l;d<=h;d++)for(var p=c;p<=u;p++){var f=this.d*p+d;if((!a||a(this._convertFromCellCoord(d),this._convertFromCellCoord(p),this._convertFromCellCoord(d+1),this._convertFromCellCoord(p+1)))&&n.call(this,e,t,i,r,f,o,s,a))return;}},Gn.prototype._convertFromCellCoord=function(e){return (e-this.padding)/this.scale;},Gn.prototype._convertToCellCoord=function(e){return Math.max(0,Math.min(this.d-1,Math.floor(e*this.scale)+this.padding));},Gn.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var e=this.cells,t=3+this.cells.length+1+1,i=0,r=0;r<this.cells.length;r++)i+=this.cells[r].length;var n=new Int32Array(t+i+this.keys.length+this.bboxes.length);n[0]=this.extent,n[1]=this.n,n[2]=this.padding;for(var o=t,s=0;s<e.length;s++){var a=e[s];n[3+s]=o,n.set(a,o),o+=a.length;}return n[3+e.length]=o,n.set(this.keys,o),n[3+e.length+1]=o+=this.keys.length,n.set(this.bboxes,o),o+=this.bboxes.length,n.buffer;};const{ImageData:jn,ImageBitmap:$n}=s,Hn={};function qn(e,t,i={}){Object.defineProperty(t,"_classRegistryKey",{value:e,writeable:!1}),Hn[e]={klass:t,omit:i.omit||[],shallow:i.shallow||[]};}qn("Object",Object),Vn.serialize=function(e,t){const i=e.toArrayBuffer();return t&&t.push(i),{buffer:i};},Vn.deserialize=function(e){return new Vn(e.buffer);},qn("Grid",Vn),qn("Color",Ht),qn("Error",Error),qn("ResolvedImage",Wt),qn("StylePropertyFunction",Xr),qn("StyleExpression",Gr,{omit:["_evaluator"]}),qn("ZoomDependentExpression",qr),qn("ZoomConstantExpression",Hr),qn("CompoundExpression",hi,{omit:["_evaluate"]});for(const e in wr)wr[e]._classRegistryKey||qn(`Expression_${e}`,wr[e]);function Zn(e){return e&&"undefined"!=typeof ArrayBuffer&&(e instanceof ArrayBuffer||e.constructor&&"ArrayBuffer"===e.constructor.name);}function Xn(e){return $n&&e instanceof $n;}function Wn(e,t){if(null==e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||e instanceof Boolean||e instanceof Number||e instanceof String||e instanceof Date||e instanceof RegExp)return e;if(Zn(e)||Xn(e))return t&&t.push(e),e;if(ArrayBuffer.isView(e)){const i=e;return t&&t.push(i.buffer),i;}if(e instanceof jn)return t&&t.push(e.data.buffer),e;if(Array.isArray(e)){const i=[];for(const r of e)i.push(Wn(r,t));return i;}if("object"==typeof e){const i=e.constructor,r=i._classRegistryKey;if(!r)throw new Error("can't serialize object of unregistered class");const n=i.serialize?i.serialize(e,t):{};if(!i.serialize){for(const i in e){if(!e.hasOwnProperty(i))continue;if(Hn[r].omit.indexOf(i)>=0)continue;const o=e[i];n[i]=Hn[r].shallow.indexOf(i)>=0?o:Wn(o,t);}e instanceof Error&&(n.message=e.message);}if(n.$name)throw new Error("$name property is reserved for worker serialization logic.");return "Object"!==r&&(n.$name=r),n;}throw new Error("can't serialize object of type "+typeof e);}function Yn(e){if(null==e||"boolean"==typeof e||"number"==typeof e||"string"==typeof e||e instanceof Boolean||e instanceof Number||e instanceof String||e instanceof Date||e instanceof RegExp||Zn(e)||Xn(e)||ArrayBuffer.isView(e)||e instanceof jn)return e;if(Array.isArray(e))return e.map(Yn);if("object"==typeof e){const t=e.$name||"Object",{klass:i}=Hn[t];if(!i)throw new Error(`can't deserialize unregistered class ${t}`);if(i.deserialize)return i.deserialize(e);const r=Object.create(i.prototype);for(const i of Object.keys(e)){if("$name"===i)continue;const n=e[i];r[i]=Hn[t].shallow.indexOf(i)>=0?n:Yn(n);}return r;}throw new Error("can't deserialize object of type "+typeof e);}class Jn{constructor(){this.first=!0;}update(e,t){const i=Math.floor(e);return this.first?(this.first=!1,this.lastIntegerZoom=i,this.lastIntegerZoomTime=0,this.lastZoom=e,this.lastFloorZoom=i,!0):(this.lastFloorZoom>i?(this.lastIntegerZoom=i+1,this.lastIntegerZoomTime=t):this.lastFloorZoom<i&&(this.lastIntegerZoom=i,this.lastIntegerZoomTime=t),e!==this.lastZoom&&(this.lastZoom=e,this.lastFloorZoom=i,!0));}}const Kn=e=>e>=1536&&e<=1791,Qn=e=>e>=1872&&e<=1919,eo=e=>e>=2208&&e<=2303,to=e=>e>=11904&&e<=12031,io=e=>e>=12032&&e<=12255,ro=e=>e>=12272&&e<=12287,no=e=>e>=12288&&e<=12351,oo=e=>e>=12352&&e<=12447,so=e=>e>=12448&&e<=12543,ao=e=>e>=12544&&e<=12591,lo=e=>e>=12704&&e<=12735,co=e=>e>=12736&&e<=12783,ho=e=>e>=12784&&e<=12799,uo=e=>e>=12800&&e<=13055,po=e=>e>=13056&&e<=13311,fo=e=>e>=13312&&e<=19903,mo=e=>e>=19968&&e<=40959,_o=e=>e>=40960&&e<=42127,go=e=>e>=42128&&e<=42191,yo=e=>e>=44032&&e<=55215,xo=e=>e>=63744&&e<=64255,vo=e=>e>=64336&&e<=65023,bo=e=>e>=65040&&e<=65055,So=e=>e>=65072&&e<=65103,wo=e=>e>=65104&&e<=65135,To=e=>e>=65136&&e<=65279,Eo=e=>e>=65280&&e<=65519;function No(e){for(const t of e)if(Co(t.charCodeAt(0)))return !0;return !1;}function Io(e){for(const t of e)if(!Mo(t.charCodeAt(0)))return !1;return !0;}function Mo(e){return !(Kn(e)||Qn(e)||eo(e)||vo(e)||To(e));}function Co(e){return !(746!==e&&747!==e&&(e<4352||!(lo(e)||ao(e)||So(e)&&!(e>=65097&&e<=65103)||xo(e)||po(e)||to(e)||co(e)||!(!no(e)||e>=12296&&e<=12305||e>=12308&&e<=12319||12336===e)||fo(e)||mo(e)||uo(e)||(e=>e>=12592&&e<=12687)(e)||(e=>e>=43360&&e<=43391)(e)||(e=>e>=55216&&e<=55295)(e)||(e=>e>=4352&&e<=4607)(e)||yo(e)||oo(e)||ro(e)||(e=>e>=12688&&e<=12703)(e)||io(e)||ho(e)||so(e)&&12540!==e||!(!Eo(e)||65288===e||65289===e||65293===e||e>=65306&&e<=65310||65339===e||65341===e||65343===e||e>=65371&&e<=65503||65507===e||e>=65512&&e<=65519)||!(!wo(e)||e>=65112&&e<=65118||e>=65123&&e<=65126)||(e=>e>=5120&&e<=5759)(e)||(e=>e>=6320&&e<=6399)(e)||bo(e)||(e=>e>=19904&&e<=19967)(e)||_o(e)||go(e))));}function Ao(e){return !(Co(e)||function(e){return !!((e=>e>=128&&e<=255)(e)&&(167===e||169===e||174===e||177===e||188===e||189===e||190===e||215===e||247===e)||(e=>e>=8192&&e<=8303)(e)&&(8214===e||8224===e||8225===e||8240===e||8241===e||8251===e||8252===e||8258===e||8263===e||8264===e||8265===e||8273===e)||(e=>e>=8448&&e<=8527)(e)||(e=>e>=8528&&e<=8591)(e)||(e=>e>=8960&&e<=9215)(e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||9003===e||e>=9085&&e<=9114||e>=9150&&e<=9165||9167===e||e>=9169&&e<=9179||e>=9186&&e<=9215)||(e=>e>=9216&&e<=9279)(e)&&9251!==e||(e=>e>=9280&&e<=9311)(e)||(e=>e>=9312&&e<=9471)(e)||(e=>e>=9632&&e<=9727)(e)||(e=>e>=9728&&e<=9983)(e)&&!(e>=9754&&e<=9759)||(e=>e>=11008&&e<=11263)(e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||no(e)||so(e)||(e=>e>=57344&&e<=63743)(e)||So(e)||wo(e)||Eo(e)||8734===e||8756===e||8757===e||e>=9984&&e<=10087||e>=10102&&e<=10131||65532===e||65533===e);}(e));}function Po(e){return e>=1424&&e<=2303||vo(e)||To(e);}function Lo(e,t){return !(!t&&Po(e)||e>=2304&&e<=3583||e>=3840&&e<=4255||(e=>e>=6016&&e<=6143)(e));}function Do(e){for(const t of e)if(Po(t.charCodeAt(0)))return !0;return !1;}const ko="deferred",zo="loading",Ro="loaded";let Oo=null,Fo="unavailable",Bo=null;const Uo=function(e){e&&"string"==typeof e&&e.indexOf("NetworkError")>-1&&(Fo="error"),Oo&&Oo(e);};function Vo(){Go.fire(new _t("pluginStateChange",{pluginStatus:Fo,pluginURL:Bo}));}const Go=new yt(),jo=function(){return Fo;},$o=function(){if(Fo!==ko||!Bo)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");Fo=zo,Vo(),Bo&&st({url:Bo},e=>{e?Uo(e):(Fo=Ro,Vo());});},Ho={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>Fo===Ro||null!=Ho.applyArabicShaping,isLoading:()=>Fo===zo,setState(e){Fo=e.pluginStatus,Bo=e.pluginURL;},isParsed:()=>null!=Ho.applyArabicShaping&&null!=Ho.processBidirectionalText&&null!=Ho.processStyledBidirectionalText,getPluginURL:()=>Bo};class qo{constructor(e,t){this.zoom=e,t?(this.now=t.now,this.fadeDuration=t.fadeDuration,this.zoomHistory=t.zoomHistory,this.transition=t.transition,this.pitch=t.pitch):(this.now=0,this.fadeDuration=0,this.zoomHistory=new Jn(),this.transition={},this.pitch=0);}isSupportedScript(e){return function(e,t){for(const i of e)if(!Lo(i.charCodeAt(0),t))return !1;return !0;}(e,Ho.isLoaded());}crossFadingFactor(){return 0===this.fadeDuration?1:Math.min((this.now-this.zoomHistory.lastIntegerZoomTime)/this.fadeDuration,1);}getCrossfadeParameters(){const e=this.zoom,t=e-Math.floor(e),i=this.crossFadingFactor();return e>this.zoomHistory.lastIntegerZoom?{fromScale:2,toScale:1,t:t+(1-t)*i}:{fromScale:.5,toScale:1,t:1-(1-i)*t};}}class Zo{constructor(e,t){this.property=e,this.value=t,this.expression=function(e,t){if(kr(e))return new Xr(e,t);if(jr(e)){const i=Zr(e,t);if("error"===i.result)throw new Error(i.value.map(e=>`${e.key}: ${e.message}`).join(", "));return i.value;}{let i=e;return "string"==typeof e&&"color"===t.type&&(i=Ht.parse(e)),{kind:"constant",evaluate:()=>i};}}(void 0===t?e.specification.default:t,e.specification);}isDataDriven(){return "source"===this.expression.kind||"composite"===this.expression.kind;}possiblyEvaluate(e,t,i){return this.property.possiblyEvaluate(this,e,t,i);}}class Xo{constructor(e){this.property=e,this.value=new Zo(e,void 0);}transitioned(e,t){return new Yo(this.property,this.value,t,ee({},e.transition,this.transition),e.now);}untransitioned(){return new Yo(this.property,this.value,null,{},0);}}class Wo{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues);}getValue(e){return he(this._values[e].value.value);}setValue(e,t){this._values.hasOwnProperty(e)||(this._values[e]=new Xo(this._values[e].property)),this._values[e].value=new Zo(this._values[e].property,null===t?void 0:he(t));}getTransition(e){return he(this._values[e].transition);}setTransition(e,t){this._values.hasOwnProperty(e)||(this._values[e]=new Xo(this._values[e].property)),this._values[e].transition=he(t)||void 0;}serialize(){const e={};for(const t of Object.keys(this._values)){const i=this.getValue(t);void 0!==i&&(e[t]=i);const r=this.getTransition(t);void 0!==r&&(e[`${t}-transition`]=r);}return e;}transitioned(e,t){const i=new Jo(this._properties);for(const r of Object.keys(this._values))i._values[r]=this._values[r].transitioned(e,t._values[r]);return i;}untransitioned(){const e=new Jo(this._properties);for(const t of Object.keys(this._values))e._values[t]=this._values[t].untransitioned();return e;}}class Yo{constructor(e,t,i,r,n){const o=r.delay||0,s=r.duration||0;n=n||0,this.property=e,this.value=t,this.begin=n+o,this.end=this.begin+s,e.specification.transition&&(r.delay||r.duration)&&(this.prior=i);}possiblyEvaluate(e,t,i){const r=e.now||0,n=this.value.possiblyEvaluate(e,t,i),o=this.prior;if(o){if(r>this.end)return this.prior=null,n;if(this.value.isDataDriven())return this.prior=null,n;if(r<this.begin)return o.possiblyEvaluate(e,t,i);{const s=(r-this.begin)/(this.end-this.begin);return this.property.interpolate(o.possiblyEvaluate(e,t,i),n,q(s));}}return n;}}class Jo{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues);}possiblyEvaluate(e,t,i){const r=new es(this._properties);for(const n of Object.keys(this._values))r._values[n]=this._values[n].possiblyEvaluate(e,t,i);return r;}hasTransition(){for(const e of Object.keys(this._values))if(this._values[e].prior)return !0;return !1;}}class Ko{constructor(e){this._properties=e,this._values=Object.create(e.defaultPropertyValues);}getValue(e){return he(this._values[e].value);}setValue(e,t){this._values[e]=new Zo(this._values[e].property,null===t?void 0:he(t));}serialize(){const e={};for(const t of Object.keys(this._values)){const i=this.getValue(t);void 0!==i&&(e[t]=i);}return e;}possiblyEvaluate(e,t,i){const r=new es(this._properties);for(const n of Object.keys(this._values))r._values[n]=this._values[n].possiblyEvaluate(e,t,i);return r;}}class Qo{constructor(e,t,i){this.property=e,this.value=t,this.parameters=i;}isConstant(){return "constant"===this.value.kind;}constantOr(e){return "constant"===this.value.kind?this.value.value:e;}evaluate(e,t,i,r){return this.property.evaluate(this.value,this.parameters,e,t,i,r);}}class es{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues);}get(e){return this._values[e];}}class ts{constructor(e){this.specification=e;}possiblyEvaluate(e,t){return e.expression.evaluate(t);}interpolate(e,t,i){const r=Fi[this.specification.type];return r?r(e,t,i):e;}}class is{constructor(e,t){this.specification=e,this.overrides=t;}possiblyEvaluate(e,t,i,r){return new Qo(this,"constant"===e.expression.kind||"camera"===e.expression.kind?{kind:"constant",value:e.expression.evaluate(t,null,{},i,r)}:e.expression,t);}interpolate(e,t,i){if("constant"!==e.value.kind||"constant"!==t.value.kind)return e;if(void 0===e.value.value||void 0===t.value.value)return new Qo(this,{kind:"constant",value:void 0},e.parameters);const r=Fi[this.specification.type];return r?new Qo(this,{kind:"constant",value:r(e.value.value,t.value.value,i)},e.parameters):e;}evaluate(e,t,i,r,n,o){return "constant"===e.kind?e.value:e.evaluate(t,i,r,n,o);}}class rs extends is{possiblyEvaluate(e,t,i,r){if(void 0===e.value)return new Qo(this,{kind:"constant",value:void 0},t);if("constant"===e.expression.kind){const n=e.expression.evaluate(t,null,{},i,r),o="resolvedImage"===e.property.specification.type&&"string"!=typeof n?n.name:n,s=this._calculate(o,o,o,t);return new Qo(this,{kind:"constant",value:s},t);}if("camera"===e.expression.kind){const i=this._calculate(e.expression.evaluate({zoom:t.zoom-1}),e.expression.evaluate({zoom:t.zoom}),e.expression.evaluate({zoom:t.zoom+1}),t);return new Qo(this,{kind:"constant",value:i},t);}return new Qo(this,e.expression,t);}evaluate(e,t,i,r,n,o){if("source"===e.kind){const s=e.evaluate(t,i,r,n,o);return this._calculate(s,s,s,t);}return "composite"===e.kind?this._calculate(e.evaluate({zoom:Math.floor(t.zoom)-1},i,r),e.evaluate({zoom:Math.floor(t.zoom)},i,r),e.evaluate({zoom:Math.floor(t.zoom)+1},i,r),t):e.value;}_calculate(e,t,i,r){return r.zoom>r.zoomHistory.lastIntegerZoom?{from:e,to:t,other:i}:{from:i,to:t,other:e};}interpolate(e){return e;}}class ns{constructor(e){this.specification=e;}possiblyEvaluate(e,t,i,r){if(void 0!==e.value){if("constant"===e.expression.kind){const n=e.expression.evaluate(t,null,{},i,r);return this._calculate(n,n,n,t);}return this._calculate(e.expression.evaluate(new qo(Math.floor(t.zoom-1),t)),e.expression.evaluate(new qo(Math.floor(t.zoom),t)),e.expression.evaluate(new qo(Math.floor(t.zoom+1),t)),t);}}_calculate(e,t,i,r){return r.zoom>r.zoomHistory.lastIntegerZoom?{from:e,to:t}:{from:i,to:t};}interpolate(e){return e;}}class os{constructor(e){this.specification=e;}possiblyEvaluate(e,t,i,r){return !!e.expression.evaluate(t,null,{},i,r);}interpolate(){return !1;}}class ss{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];for(const t in e){const i=e[t];i.specification.overridable&&this.overridableProperties.push(t);const r=this.defaultPropertyValues[t]=new Zo(i,void 0),n=this.defaultTransitionablePropertyValues[t]=new Xo(i);this.defaultTransitioningPropertyValues[t]=n.untransitioned(),this.defaultPossiblyEvaluatedValues[t]=r.possiblyEvaluate({});}}}function as(e,t){return 256*(e=W(Math.floor(e),0,255))+W(Math.floor(t),0,255);}qn("DataDrivenProperty",is),qn("DataConstantProperty",ts),qn("CrossFadedDataDrivenProperty",rs),qn("CrossFadedProperty",ns),qn("ColorRampProperty",os);const ls={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class cs{constructor(e,t){this._structArray=e,this._pos1=t*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8;}}class hs{constructor(){this.isTransferred=!1,this.capacity=-1,this.resize(0);}static serialize(e,t){return e._trim(),t&&(e.isTransferred=!0,t.push(e.arrayBuffer)),{length:e.length,arrayBuffer:e.arrayBuffer};}static deserialize(e){const t=Object.create(this.prototype);return t.arrayBuffer=e.arrayBuffer,t.length=e.length,t.capacity=e.arrayBuffer.byteLength/t.bytesPerElement,t._refreshViews(),t;}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews());}clear(){this.length=0;}resize(e){this.reserve(e),this.length=e;}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const t=this.uint8;this._refreshViews(),t&&this.uint8.set(t);}}_refreshViews(){throw new Error("_refreshViews() must be implemented by each concrete StructArray layout");}}function us(e,t=1){let i=0,r=0;return {members:e.map(e=>{const n=ls[e.type].BYTES_PER_ELEMENT,o=i=ds(i,Math.max(t,n)),s=e.components||1;return r=Math.max(r,n),i+=n*s,{name:e.name,type:e.type,components:s,offset:o};}),size:ds(i,Math.max(r,t)),alignment:t};}function ds(e,t){return Math.ceil(e/t)*t;}class ps extends hs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer);}emplaceBack(e,t){const i=this.length;return this.resize(i+1),this.emplace(i,e,t);}emplace(e,t,i){const r=2*e;return this.int16[r+0]=t,this.int16[r+1]=i,e;}}ps.prototype.bytesPerElement=4,qn("StructArrayLayout2i4",ps);class fs extends hs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer);}emplaceBack(e,t,i,r){const n=this.length;return this.resize(n+1),this.emplace(n,e,t,i,r);}emplace(e,t,i,r,n){const o=4*e;return this.int16[o+0]=t,this.int16[o+1]=i,this.int16[o+2]=r,this.int16[o+3]=n,e;}}fs.prototype.bytesPerElement=8,qn("StructArrayLayout4i8",fs);class ms extends hs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer);}emplaceBack(e,t,i,r,n,o,s){const a=this.length;return this.resize(a+1),this.emplace(a,e,t,i,r,n,o,s);}emplace(e,t,i,r,n,o,s,a){const l=6*e,c=12*e,h=3*e;return this.int16[l+0]=t,this.int16[l+1]=i,this.uint8[c+4]=r,this.uint8[c+5]=n,this.uint8[c+6]=o,this.uint8[c+7]=s,this.float32[h+2]=a,e;}}ms.prototype.bytesPerElement=12,qn("StructArrayLayout2i4ub1f12",ms);class _s extends hs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer);}emplaceBack(e,t,i){const r=this.length;return this.resize(r+1),this.emplace(r,e,t,i);}emplace(e,t,i,r){const n=3*e;return this.float32[n+0]=t,this.float32[n+1]=i,this.float32[n+2]=r,e;}}_s.prototype.bytesPerElement=12,qn("StructArrayLayout3f12",_s);class gs extends hs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer);}emplaceBack(e,t,i,r,n,o,s,a,l,c){const h=this.length;return this.resize(h+1),this.emplace(h,e,t,i,r,n,o,s,a,l,c);}emplace(e,t,i,r,n,o,s,a,l,c,h){const u=10*e;return this.uint16[u+0]=t,this.uint16[u+1]=i,this.uint16[u+2]=r,this.uint16[u+3]=n,this.uint16[u+4]=o,this.uint16[u+5]=s,this.uint16[u+6]=a,this.uint16[u+7]=l,this.uint16[u+8]=c,this.uint16[u+9]=h,e;}}gs.prototype.bytesPerElement=20,qn("StructArrayLayout10ui20",gs);class ys extends hs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer);}emplaceBack(e,t,i,r,n,o,s,a){const l=this.length;return this.resize(l+1),this.emplace(l,e,t,i,r,n,o,s,a);}emplace(e,t,i,r,n,o,s,a,l){const c=8*e;return this.uint16[c+0]=t,this.uint16[c+1]=i,this.uint16[c+2]=r,this.uint16[c+3]=n,this.uint16[c+4]=o,this.uint16[c+5]=s,this.uint16[c+6]=a,this.uint16[c+7]=l,e;}}ys.prototype.bytesPerElement=16,qn("StructArrayLayout8ui16",ys);class xs extends hs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer);}emplaceBack(e,t,i,r,n,o,s,a,l,c,h,u,d,p,f,m){const _=this.length;return this.resize(_+1),this.emplace(_,e,t,i,r,n,o,s,a,l,c,h,u,d,p,f,m);}emplace(e,t,i,r,n,o,s,a,l,c,h,u,d,p,f,m,_){const g=16*e;return this.int16[g+0]=t,this.int16[g+1]=i,this.int16[g+2]=r,this.int16[g+3]=n,this.uint16[g+4]=o,this.uint16[g+5]=s,this.uint16[g+6]=a,this.uint16[g+7]=l,this.int16[g+8]=c,this.int16[g+9]=h,this.int16[g+10]=u,this.int16[g+11]=d,this.int16[g+12]=p,this.int16[g+13]=f,this.int16[g+14]=m,this.int16[g+15]=_,e;}}xs.prototype.bytesPerElement=32,qn("StructArrayLayout4i4ui4i4i32",xs);class vs extends hs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer);}emplaceBack(e){const t=this.length;return this.resize(t+1),this.emplace(t,e);}emplace(e,t){return this.uint32[1*e+0]=t,e;}}vs.prototype.bytesPerElement=4,qn("StructArrayLayout1ul4",vs);class bs extends hs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer);}emplaceBack(e,t,i,r,n,o,s,a,l,c,h,u,d){const p=this.length;return this.resize(p+1),this.emplace(p,e,t,i,r,n,o,s,a,l,c,h,u,d);}emplace(e,t,i,r,n,o,s,a,l,c,h,u,d,p){const f=20*e,m=10*e;return this.int16[f+0]=t,this.int16[f+1]=i,this.int16[f+2]=r,this.int16[f+3]=n,this.int16[f+4]=o,this.float32[m+3]=s,this.float32[m+4]=a,this.float32[m+5]=l,this.float32[m+6]=c,this.int16[f+14]=h,this.uint32[m+8]=u,this.uint16[f+18]=d,this.uint16[f+19]=p,e;}}bs.prototype.bytesPerElement=40,qn("StructArrayLayout5i4f1i1ul2ui40",bs);class Ss extends hs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer);}emplaceBack(e,t,i,r,n,o,s){const a=this.length;return this.resize(a+1),this.emplace(a,e,t,i,r,n,o,s);}emplace(e,t,i,r,n,o,s,a){const l=8*e;return this.int16[l+0]=t,this.int16[l+1]=i,this.int16[l+2]=r,this.int16[l+4]=n,this.int16[l+5]=o,this.int16[l+6]=s,this.int16[l+7]=a,e;}}Ss.prototype.bytesPerElement=16,qn("StructArrayLayout3i2i2i16",Ss);class ws extends hs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer);}emplaceBack(e,t,i,r,n){const o=this.length;return this.resize(o+1),this.emplace(o,e,t,i,r,n);}emplace(e,t,i,r,n,o){const s=4*e,a=8*e;return this.float32[s+0]=t,this.float32[s+1]=i,this.float32[s+2]=r,this.int16[a+6]=n,this.int16[a+7]=o,e;}}ws.prototype.bytesPerElement=16,qn("StructArrayLayout2f1f2i16",ws);class Ts extends hs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer);}emplaceBack(e,t,i,r){const n=this.length;return this.resize(n+1),this.emplace(n,e,t,i,r);}emplace(e,t,i,r,n){const o=12*e,s=3*e;return this.uint8[o+0]=t,this.uint8[o+1]=i,this.float32[s+1]=r,this.float32[s+2]=n,e;}}Ts.prototype.bytesPerElement=12,qn("StructArrayLayout2ub2f12",Ts);class Es extends hs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer);}emplaceBack(e,t,i){const r=this.length;return this.resize(r+1),this.emplace(r,e,t,i);}emplace(e,t,i,r){const n=3*e;return this.uint16[n+0]=t,this.uint16[n+1]=i,this.uint16[n+2]=r,e;}}Es.prototype.bytesPerElement=6,qn("StructArrayLayout3ui6",Es);class Ns extends hs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer);}emplaceBack(e,t,i,r,n,o,s,a,l,c,h,u,d,p,f,m,_,g,y,x,v){const b=this.length;return this.resize(b+1),this.emplace(b,e,t,i,r,n,o,s,a,l,c,h,u,d,p,f,m,_,g,y,x,v);}emplace(e,t,i,r,n,o,s,a,l,c,h,u,d,p,f,m,_,g,y,x,v,b){const S=30*e,w=15*e,T=60*e;return this.int16[S+0]=t,this.int16[S+1]=i,this.int16[S+2]=r,this.float32[w+2]=n,this.float32[w+3]=o,this.uint16[S+8]=s,this.uint16[S+9]=a,this.uint32[w+5]=l,this.uint32[w+6]=c,this.uint32[w+7]=h,this.uint16[S+16]=u,this.uint16[S+17]=d,this.uint16[S+18]=p,this.float32[w+10]=f,this.float32[w+11]=m,this.uint8[T+48]=_,this.uint8[T+49]=g,this.uint8[T+50]=y,this.uint32[w+13]=x,this.int16[S+28]=v,this.uint8[T+58]=b,e;}}Ns.prototype.bytesPerElement=60,qn("StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60",Ns);class Is extends hs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer);}emplaceBack(e,t,i,r,n,o,s,a,l,c,h,u,d,p,f,m,_,g,y,x,v,b,S,w,T,E,N,I,M,C){const A=this.length;return this.resize(A+1),this.emplace(A,e,t,i,r,n,o,s,a,l,c,h,u,d,p,f,m,_,g,y,x,v,b,S,w,T,E,N,I,M,C);}emplace(e,t,i,r,n,o,s,a,l,c,h,u,d,p,f,m,_,g,y,x,v,b,S,w,T,E,N,I,M,C,A){const P=38*e,L=19*e;return this.int16[P+0]=t,this.int16[P+1]=i,this.int16[P+2]=r,this.float32[L+2]=n,this.float32[L+3]=o,this.int16[P+8]=s,this.int16[P+9]=a,this.int16[P+10]=l,this.int16[P+11]=c,this.int16[P+12]=h,this.int16[P+13]=u,this.uint16[P+14]=d,this.uint16[P+15]=p,this.uint16[P+16]=f,this.uint16[P+17]=m,this.uint16[P+18]=_,this.uint16[P+19]=g,this.uint16[P+20]=y,this.uint16[P+21]=x,this.uint16[P+22]=v,this.uint16[P+23]=b,this.uint16[P+24]=S,this.uint16[P+25]=w,this.uint16[P+26]=T,this.uint16[P+27]=E,this.uint16[P+28]=N,this.uint32[L+15]=I,this.float32[L+16]=M,this.float32[L+17]=C,this.float32[L+18]=A,e;}}Is.prototype.bytesPerElement=76,qn("StructArrayLayout3i2f6i15ui1ul3f76",Is);class Ms extends hs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer);}emplaceBack(e){const t=this.length;return this.resize(t+1),this.emplace(t,e);}emplace(e,t){return this.float32[1*e+0]=t,e;}}Ms.prototype.bytesPerElement=4,qn("StructArrayLayout1f4",Ms);class Cs extends hs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer);}emplaceBack(e,t,i){const r=this.length;return this.resize(r+1),this.emplace(r,e,t,i);}emplace(e,t,i,r){const n=3*e;return this.int16[n+0]=t,this.int16[n+1]=i,this.int16[n+2]=r,e;}}Cs.prototype.bytesPerElement=6,qn("StructArrayLayout3i6",Cs);class As extends hs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer);}emplaceBack(e,t,i,r,n,o,s){const a=this.length;return this.resize(a+1),this.emplace(a,e,t,i,r,n,o,s);}emplace(e,t,i,r,n,o,s,a){const l=7*e;return this.float32[l+0]=t,this.float32[l+1]=i,this.float32[l+2]=r,this.float32[l+3]=n,this.float32[l+4]=o,this.float32[l+5]=s,this.float32[l+6]=a,e;}}As.prototype.bytesPerElement=28,qn("StructArrayLayout7f28",As);class Ps extends hs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer);}emplaceBack(e,t,i,r){const n=this.length;return this.resize(n+1),this.emplace(n,e,t,i,r);}emplace(e,t,i,r,n){const o=6*e;return this.uint32[3*e+0]=t,this.uint16[o+2]=i,this.uint16[o+3]=r,this.uint16[o+4]=n,e;}}Ps.prototype.bytesPerElement=12,qn("StructArrayLayout1ul3ui12",Ps);class Ls extends hs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer);}emplaceBack(e,t){const i=this.length;return this.resize(i+1),this.emplace(i,e,t);}emplace(e,t,i){const r=2*e;return this.uint16[r+0]=t,this.uint16[r+1]=i,e;}}Ls.prototype.bytesPerElement=4,qn("StructArrayLayout2ui4",Ls);class Ds extends hs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer);}emplaceBack(e){const t=this.length;return this.resize(t+1),this.emplace(t,e);}emplace(e,t){return this.uint16[1*e+0]=t,e;}}Ds.prototype.bytesPerElement=2,qn("StructArrayLayout1ui2",Ds);class ks extends hs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer);}emplaceBack(e,t){const i=this.length;return this.resize(i+1),this.emplace(i,e,t);}emplace(e,t,i){const r=2*e;return this.float32[r+0]=t,this.float32[r+1]=i,e;}}ks.prototype.bytesPerElement=8,qn("StructArrayLayout2f8",ks);class zs extends hs{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer);}emplaceBack(e,t,i,r){const n=this.length;return this.resize(n+1),this.emplace(n,e,t,i,r);}emplace(e,t,i,r,n){const o=4*e;return this.float32[o+0]=t,this.float32[o+1]=i,this.float32[o+2]=r,this.float32[o+3]=n,e;}}zs.prototype.bytesPerElement=16,qn("StructArrayLayout4f16",zs);class Rs extends cs{get projectedAnchorX(){return this._structArray.int16[this._pos2+0];}get projectedAnchorY(){return this._structArray.int16[this._pos2+1];}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2];}get tileAnchorX(){return this._structArray.int16[this._pos2+3];}get tileAnchorY(){return this._structArray.int16[this._pos2+4];}get x1(){return this._structArray.float32[this._pos4+3];}get y1(){return this._structArray.float32[this._pos4+4];}get x2(){return this._structArray.float32[this._pos4+5];}get y2(){return this._structArray.float32[this._pos4+6];}get padding(){return this._structArray.int16[this._pos2+14];}get featureIndex(){return this._structArray.uint32[this._pos4+8];}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18];}get bucketIndex(){return this._structArray.uint16[this._pos2+19];}}Rs.prototype.size=40;class Os extends bs{get(e){return new Rs(this,e);}}qn("CollisionBoxArray",Os);class Fs extends cs{get projectedAnchorX(){return this._structArray.int16[this._pos2+0];}get projectedAnchorY(){return this._structArray.int16[this._pos2+1];}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2];}get tileAnchorX(){return this._structArray.float32[this._pos4+2];}get tileAnchorY(){return this._structArray.float32[this._pos4+3];}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8];}get numGlyphs(){return this._structArray.uint16[this._pos2+9];}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5];}get lineStartIndex(){return this._structArray.uint32[this._pos4+6];}get lineLength(){return this._structArray.uint32[this._pos4+7];}get segment(){return this._structArray.uint16[this._pos2+16];}get lowerSize(){return this._structArray.uint16[this._pos2+17];}get upperSize(){return this._structArray.uint16[this._pos2+18];}get lineOffsetX(){return this._structArray.float32[this._pos4+10];}get lineOffsetY(){return this._structArray.float32[this._pos4+11];}get writingMode(){return this._structArray.uint8[this._pos1+48];}get placedOrientation(){return this._structArray.uint8[this._pos1+49];}set placedOrientation(e){this._structArray.uint8[this._pos1+49]=e;}get hidden(){return this._structArray.uint8[this._pos1+50];}set hidden(e){this._structArray.uint8[this._pos1+50]=e;}get crossTileID(){return this._structArray.uint32[this._pos4+13];}set crossTileID(e){this._structArray.uint32[this._pos4+13]=e;}get associatedIconIndex(){return this._structArray.int16[this._pos2+28];}get flipState(){return this._structArray.uint8[this._pos1+58];}set flipState(e){this._structArray.uint8[this._pos1+58]=e;}}Fs.prototype.size=60;class Bs extends Ns{get(e){return new Fs(this,e);}}qn("PlacedSymbolArray",Bs);class Us extends cs{get projectedAnchorX(){return this._structArray.int16[this._pos2+0];}get projectedAnchorY(){return this._structArray.int16[this._pos2+1];}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2];}get tileAnchorX(){return this._structArray.float32[this._pos4+2];}get tileAnchorY(){return this._structArray.float32[this._pos4+3];}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8];}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9];}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+10];}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+11];}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+12];}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+13];}get key(){return this._structArray.uint16[this._pos2+14];}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+15];}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+16];}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+17];}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+18];}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+19];}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+20];}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+21];}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+22];}get featureIndex(){return this._structArray.uint16[this._pos2+23];}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+24];}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+25];}get numIconVertices(){return this._structArray.uint16[this._pos2+26];}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+27];}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+28];}get crossTileID(){return this._structArray.uint32[this._pos4+15];}set crossTileID(e){this._structArray.uint32[this._pos4+15]=e;}get textOffset0(){return this._structArray.float32[this._pos4+16];}get textOffset1(){return this._structArray.float32[this._pos4+17];}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+18];}}Us.prototype.size=76;class Vs extends Is{get(e){return new Us(this,e);}}qn("SymbolInstanceArray",Vs);class Gs extends Ms{getoffsetX(e){return this.float32[1*e+0];}}qn("GlyphOffsetArray",Gs);class js extends Cs{getx(e){return this.int16[3*e+0];}gety(e){return this.int16[3*e+1];}gettileUnitDistanceFromAnchor(e){return this.int16[3*e+2];}}qn("SymbolLineVertexArray",js);class $s extends cs{get featureIndex(){return this._structArray.uint32[this._pos4+0];}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2];}get bucketIndex(){return this._structArray.uint16[this._pos2+3];}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4];}}$s.prototype.size=12;class Hs extends Ps{get(e){return new $s(this,e);}}qn("FeatureIndexArray",Hs);class qs extends cs{get a_centroid_pos0(){return this._structArray.uint16[this._pos2+0];}get a_centroid_pos1(){return this._structArray.uint16[this._pos2+1];}}qs.prototype.size=4;class Zs extends Ls{get(e){return new qs(this,e);}}qn("FillExtrusionCentroidArray",Zs);const Xs=us([{name:"a_pattern_to",components:4,type:"Uint16"},{name:"a_pattern_from",components:4,type:"Uint16"},{name:"a_pixel_ratio_to",components:1,type:"Uint16"},{name:"a_pixel_ratio_from",components:1,type:"Uint16"}]),Ws=us([{name:"a_dash_to",components:4,type:"Uint16"},{name:"a_dash_from",components:4,type:"Uint16"}]);var Ys=jt(function(e){e.exports=function(e,t){var i,r,n,o,s,a,l,c;for(r=e.length-(i=3&e.length),n=t,s=3432918353,a=461845907,c=0;c<r;)l=255&e.charCodeAt(c)|(255&e.charCodeAt(++c))<<8|(255&e.charCodeAt(++c))<<16|(255&e.charCodeAt(++c))<<24,++c,n=27492+(65535&(o=5*(65535&(n=(n^=l=(65535&(l=(l=(65535&l)*s+(((l>>>16)*s&65535)<<16)&4294967295)<<15|l>>>17))*a+(((l>>>16)*a&65535)<<16)&4294967295)<<13|n>>>19))+((5*(n>>>16)&65535)<<16)&4294967295))+((58964+(o>>>16)&65535)<<16);switch(l=0,i){case 3:l^=(255&e.charCodeAt(c+2))<<16;case 2:l^=(255&e.charCodeAt(c+1))<<8;case 1:n^=l=(65535&(l=(l=(65535&(l^=255&e.charCodeAt(c)))*s+(((l>>>16)*s&65535)<<16)&4294967295)<<15|l>>>17))*a+(((l>>>16)*a&65535)<<16)&4294967295;}return n^=e.length,n=2246822507*(65535&(n^=n>>>16))+((2246822507*(n>>>16)&65535)<<16)&4294967295,n=3266489909*(65535&(n^=n>>>13))+((3266489909*(n>>>16)&65535)<<16)&4294967295,(n^=n>>>16)>>>0;};}),Js=jt(function(e){e.exports=function(e,t){for(var i,r=e.length,n=t^r,o=0;r>=4;)i=1540483477*(65535&(i=255&e.charCodeAt(o)|(255&e.charCodeAt(++o))<<8|(255&e.charCodeAt(++o))<<16|(255&e.charCodeAt(++o))<<24))+((1540483477*(i>>>16)&65535)<<16),n=1540483477*(65535&n)+((1540483477*(n>>>16)&65535)<<16)^(i=1540483477*(65535&(i^=i>>>24))+((1540483477*(i>>>16)&65535)<<16)),r-=4,++o;switch(r){case 3:n^=(255&e.charCodeAt(o+2))<<16;case 2:n^=(255&e.charCodeAt(o+1))<<8;case 1:n=1540483477*(65535&(n^=255&e.charCodeAt(o)))+((1540483477*(n>>>16)&65535)<<16);}return n=1540483477*(65535&(n^=n>>>13))+((1540483477*(n>>>16)&65535)<<16),(n^=n>>>15)>>>0;};}),Ks=Ys,Qs=Js;Ks.murmur3=Ys,Ks.murmur2=Qs;class ea{constructor(){this.ids=[],this.positions=[],this.indexed=!1;}add(e,t,i,r){this.ids.push(ta(e)),this.positions.push(t,i,r);}getPositions(e){const t=ta(e);let i=0,r=this.ids.length-1;for(;i<r;){const e=i+r>>1;this.ids[e]>=t?r=e:i=e+1;}const n=[];for(;this.ids[i]===t;)n.push({index:this.positions[3*i],start:this.positions[3*i+1],end:this.positions[3*i+2]}),i++;return n;}static serialize(e,t){const i=new Float64Array(e.ids),r=new Uint32Array(e.positions);return ia(i,r,0,i.length-1),t&&t.push(i.buffer,r.buffer),{ids:i,positions:r};}static deserialize(e){const t=new ea();return t.ids=e.ids,t.positions=e.positions,t.indexed=!0,t;}}function ta(e){const t=+e;return !isNaN(t)&&Number.MIN_SAFE_INTEGER<=t&&t<=Number.MAX_SAFE_INTEGER?t:Ks(String(e));}function ia(e,t,i,r){for(;i<r;){const n=e[i+r>>1];let o=i-1,s=r+1;for(;;){do{o++;}while(e[o]<n);do{s--;}while(e[s]>n);if(o>=s)break;ra(e,o,s),ra(t,3*o,3*s),ra(t,3*o+1,3*s+1),ra(t,3*o+2,3*s+2);}s-i<r-s?(ia(e,t,i,s),i=s+1):(ia(e,t,s+1,r),r=s);}}function ra(e,t,i){const r=e[t];e[t]=e[i],e[i]=r;}qn("FeaturePositionMap",ea);class na{constructor(e,t){this.gl=e.gl,this.location=t;}}class oa extends na{constructor(e,t){super(e,t),this.current=0;}set(e){this.current!==e&&(this.current=e,this.gl.uniform1f(this.location,e));}}class sa extends na{constructor(e,t){super(e,t),this.current=[0,0,0,0];}set(e){e[0]===this.current[0]&&e[1]===this.current[1]&&e[2]===this.current[2]&&e[3]===this.current[3]||(this.current=e,this.gl.uniform4f(this.location,e[0],e[1],e[2],e[3]));}}class aa extends na{constructor(e,t){super(e,t),this.current=Ht.transparent;}set(e){e.r===this.current.r&&e.g===this.current.g&&e.b===this.current.b&&e.a===this.current.a||(this.current=e,this.gl.uniform4f(this.location,e.r,e.g,e.b,e.a));}}const la=new Float32Array(16),ca=new Float32Array(9),ha=new Float32Array(4);function ua(e){return [as(255*e.r,255*e.g),as(255*e.b,255*e.a)];}class da{constructor(e,t,i){this.value=e,this.uniformNames=t.map(e=>`u_${e}`),this.type=i;}setUniform(e,t,i){e.set(i.constantOr(this.value));}getBinding(e,t,i){return "color"===this.type?new aa(e,t):new oa(e,t);}}class pa{constructor(e,t){this.uniformNames=t.map(e=>`u_${e}`),this.patternFrom=null,this.patternTo=null,this.pixelRatioFrom=1,this.pixelRatioTo=1;}setConstantPatternPositions(e,t){this.pixelRatioFrom=t.pixelRatio,this.pixelRatioTo=e.pixelRatio,this.patternFrom=t.tl.concat(t.br),this.patternTo=e.tl.concat(e.br);}setUniform(e,t,i,r){const n="u_pattern_to"===r||"u_dash_to"===r?this.patternTo:"u_pattern_from"===r||"u_dash_from"===r?this.patternFrom:"u_pixel_ratio_to"===r?this.pixelRatioTo:"u_pixel_ratio_from"===r?this.pixelRatioFrom:null;n&&e.set(n);}getBinding(e,t,i){return "u_pattern_from"===i||"u_pattern_to"===i||"u_dash_from"===i||"u_dash_to"===i?new sa(e,t):new oa(e,t);}}class fa{constructor(e,t,i,r){this.expression=e,this.type=i,this.maxValue=0,this.paintVertexAttributes=t.map(e=>({name:`a_${e}`,type:"Float32",components:"color"===i?2:1,offset:0})),this.paintVertexArray=new r();}populatePaintArray(e,t,i,r,n,o){const s=this.paintVertexArray.length,a=this.expression.evaluate(new qo(0),t,{},n,r,o);this.paintVertexArray.resize(e),this._setPaintValue(s,e,a);}updatePaintArray(e,t,i,r,n){const o=this.expression.evaluate({zoom:0},i,r,void 0,n);this._setPaintValue(e,t,o);}_setPaintValue(e,t,i){if("color"===this.type){const r=ua(i);for(let i=e;i<t;i++)this.paintVertexArray.emplace(i,r[0],r[1]);}else {for(let r=e;r<t;r++)this.paintVertexArray.emplace(r,i);this.maxValue=Math.max(this.maxValue,Math.abs(i));}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent));}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy();}}class ma{constructor(e,t,i,r,n,o){this.expression=e,this.uniformNames=t.map(e=>`u_${e}_t`),this.type=i,this.useIntegerZoom=r,this.zoom=n,this.maxValue=0,this.paintVertexAttributes=t.map(e=>({name:`a_${e}`,type:"Float32",components:"color"===i?4:2,offset:0})),this.paintVertexArray=new o();}populatePaintArray(e,t,i,r,n,o){const s=this.expression.evaluate(new qo(this.zoom),t,{},n,r,o),a=this.expression.evaluate(new qo(this.zoom+1),t,{},n,r,o),l=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(l,e,s,a);}updatePaintArray(e,t,i,r,n){const o=this.expression.evaluate({zoom:this.zoom},i,r,void 0,n),s=this.expression.evaluate({zoom:this.zoom+1},i,r,void 0,n);this._setPaintValue(e,t,o,s);}_setPaintValue(e,t,i,r){if("color"===this.type){const n=ua(i),o=ua(r);for(let i=e;i<t;i++)this.paintVertexArray.emplace(i,n[0],n[1],o[0],o[1]);}else {for(let n=e;n<t;n++)this.paintVertexArray.emplace(n,i,r);this.maxValue=Math.max(this.maxValue,Math.abs(i),Math.abs(r));}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent));}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy();}setUniform(e,t){const i=this.useIntegerZoom?Math.floor(t.zoom):t.zoom,r=W(this.expression.interpolationFactor(i,this.zoom,this.zoom+1),0,1);e.set(r);}getBinding(e,t,i){return new oa(e,t);}}class _a{constructor(e,t,i,r,n,o,s){this.expression=e,this.type=i,this.useIntegerZoom=r,this.zoom=n,this.layerId=s,this.paintVertexAttributes=("array"===i?Ws:Xs).members;for(let e=0;e<t.length;++e);this.zoomInPaintVertexArray=new o(),this.zoomOutPaintVertexArray=new o();}populatePaintArray(e,t,i){const r=this.zoomInPaintVertexArray.length;this.zoomInPaintVertexArray.resize(e),this.zoomOutPaintVertexArray.resize(e),this._setPaintValues(r,e,t.patterns&&t.patterns[this.layerId],i);}updatePaintArray(e,t,i,r,n,o){this._setPaintValues(e,t,i.patterns&&i.patterns[this.layerId],o);}_setPaintValues(e,t,i,r){if(!r||!i)return;const{min:n,mid:o,max:s}=i,a=r[n],l=r[o],c=r[s];if(a&&l&&c)for(let i=e;i<t;i++)this._setPaintValue(this.zoomInPaintVertexArray,i,l,a),this._setPaintValue(this.zoomOutPaintVertexArray,i,l,c);}_setPaintValue(e,t,i,r){e.emplace(t,i.tl[0],i.tl[1],i.br[0],i.br[1],r.tl[0],r.tl[1],r.br[0],r.br[1],i.pixelRatio,r.pixelRatio);}upload(e){this.zoomInPaintVertexArray&&this.zoomInPaintVertexArray.arrayBuffer&&this.zoomOutPaintVertexArray&&this.zoomOutPaintVertexArray.arrayBuffer&&(this.zoomInPaintVertexBuffer=e.createVertexBuffer(this.zoomInPaintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent),this.zoomOutPaintVertexBuffer=e.createVertexBuffer(this.zoomOutPaintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent));}destroy(){this.zoomOutPaintVertexBuffer&&this.zoomOutPaintVertexBuffer.destroy(),this.zoomInPaintVertexBuffer&&this.zoomInPaintVertexBuffer.destroy();}}class ga{constructor(e,t,i=()=>!0){this.binders={},this._buffers=[];const r=[];for(const n in e.paint._values){if(!i(n))continue;const o=e.paint.get(n);if(!(o instanceof Qo&&Ar(o.property.specification)))continue;const s=va(n,e.type),a=o.value,l=o.property.specification.type,c=o.property.useIntegerZoom,h=o.property.specification["property-type"],u="cross-faded"===h||"cross-faded-data-driven"===h,d="line-dasharray"===String(n)&&"constant"!==e.layout.get("line-cap").value.kind;if("constant"!==a.kind||d){if("source"===a.kind||d||u){const i=wa(n,l,"source");this.binders[n]=u?new _a(a,s,l,c,t,i,e.id):new fa(a,s,l,i),r.push(`/a_${n}`);}else {const e=wa(n,l,"composite");this.binders[n]=new ma(a,s,l,c,t,e),r.push(`/z_${n}`);}}else this.binders[n]=u?new pa(a.value,s):new da(a.value,s,l),r.push(`/u_${n}`);}this.cacheKey=r.sort().join("");}getMaxValue(e){const t=this.binders[e];return t instanceof fa||t instanceof ma?t.maxValue:0;}populatePaintArrays(e,t,i,r,n,o){for(const s in this.binders){const a=this.binders[s];(a instanceof fa||a instanceof ma||a instanceof _a)&&a.populatePaintArray(e,t,i,r,n,o);}}setConstantPatternPositions(e,t){for(const i in this.binders){const r=this.binders[i];r instanceof pa&&r.setConstantPatternPositions(e,t);}}updatePaintArrays(e,t,i,r,n,o){let s=!1;for(const a in e){const l=t.getPositions(a);for(const t of l){const l=i.feature(t.index);for(const i in this.binders){const c=this.binders[i];if((c instanceof fa||c instanceof ma||c instanceof _a)&&!0===c.expression.isStateDependent){const h=r.paint.get(i);c.expression=h.value,c.updatePaintArray(t.start,t.end,l,e[a],n,o),s=!0;}}}}return s;}defines(){const e=[];for(const t in this.binders){const i=this.binders[t];(i instanceof da||i instanceof pa)&&e.push(...i.uniformNames.map(e=>`#define HAS_UNIFORM_${e}`));}return e;}getBinderAttributes(){const e=[];for(const t in this.binders){const i=this.binders[t];if(i instanceof fa||i instanceof ma||i instanceof _a)for(let t=0;t<i.paintVertexAttributes.length;t++)e.push(i.paintVertexAttributes[t].name);}return e;}getBinderUniforms(){const e=[];for(const t in this.binders){const i=this.binders[t];if(i instanceof da||i instanceof pa||i instanceof ma)for(const t of i.uniformNames)e.push(t);}return e;}getPaintVertexBuffers(){return this._buffers;}getUniforms(e,t){const i=[];for(const r in this.binders){const n=this.binders[r];if(n instanceof da||n instanceof pa||n instanceof ma)for(const o of n.uniformNames)if(t[o]){const s=n.getBinding(e,t[o],o);i.push({name:o,property:r,binding:s});}}return i;}setUniforms(e,t,i,r){for(const{name:e,property:n,binding:o}of t)this.binders[n].setUniform(o,r,i.get(n),e);}updatePaintBuffers(e){this._buffers=[];for(const t in this.binders){const i=this.binders[t];if(e&&i instanceof _a){const t=2===e.fromScale?i.zoomInPaintVertexBuffer:i.zoomOutPaintVertexBuffer;t&&this._buffers.push(t);}else (i instanceof fa||i instanceof ma)&&i.paintVertexBuffer&&this._buffers.push(i.paintVertexBuffer);}}upload(e){for(const t in this.binders){const i=this.binders[t];(i instanceof fa||i instanceof ma||i instanceof _a)&&i.upload(e);}this.updatePaintBuffers();}destroy(){for(const e in this.binders){const t=this.binders[e];(t instanceof fa||t instanceof ma||t instanceof _a)&&t.destroy();}}}class ya{constructor(e,t,i=()=>!0){this.programConfigurations={};for(const r of e)this.programConfigurations[r.id]=new ga(r,t,i);this.needsUpload=!1,this._featureMap=new ea(),this._bufferOffset=0;}populatePaintArrays(e,t,i,r,n,o,s){for(const i in this.programConfigurations)this.programConfigurations[i].populatePaintArrays(e,t,r,n,o,s);void 0!==t.id&&this._featureMap.add(t.id,i,this._bufferOffset,e),this._bufferOffset=e,this.needsUpload=!0;}updatePaintArrays(e,t,i,r,n){for(const o of i)this.needsUpload=this.programConfigurations[o.id].updatePaintArrays(e,this._featureMap,t,o,r,n)||this.needsUpload;}get(e){return this.programConfigurations[e];}upload(e){if(this.needsUpload){for(const t in this.programConfigurations)this.programConfigurations[t].upload(e);this.needsUpload=!1;}}destroy(){for(const e in this.programConfigurations)this.programConfigurations[e].destroy();}}const xa={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"line-gap-width":["gapwidth"],"line-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"fill-extrusion-pattern":["pattern_to","pattern_from","pixel_ratio_to","pixel_ratio_from"],"line-dasharray":["dash_to","dash_from"]};function va(e,t){return xa[e]||[e.replace(`${t}-`,"").replace(/-/g,"_")];}const ba={"line-pattern":{source:gs,composite:gs},"fill-pattern":{source:gs,composite:gs},"fill-extrusion-pattern":{source:gs,composite:gs},"line-dasharray":{source:ys,composite:ys}},Sa={color:{source:ks,composite:zs},number:{source:Ms,composite:ks}};function wa(e,t,i){const r=ba[e];return r&&r[i]||Sa[t][i];}qn("ConstantBinder",da),qn("CrossFadedConstantBinder",pa),qn("SourceExpressionBinder",fa),qn("CrossFadedCompositeBinder",_a),qn("CompositeExpressionBinder",ma),qn("ProgramConfiguration",ga,{omit:["_buffers"]}),qn("ProgramConfigurationSet",ya);const Ta="-transition";class Ea extends yt{constructor(e,t){if(super(),this.id=e.id,this.type=e.type,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,"custom"!==e.type&&(this.metadata=(e=e).metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,"background"!==e.type&&"sky"!==e.type&&(this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter),t.layout&&(this._unevaluatedLayout=new Ko(t.layout)),t.paint)){this._transitionablePaint=new Wo(t.paint);for(const t in e.paint)this.setPaintProperty(t,e.paint[t],{validate:!1});for(const t in e.layout)this.setLayoutProperty(t,e.layout[t],{validate:!1});this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new es(t.paint);}}getCrossfadeParameters(){return this._crossfadeParameters;}getLayoutProperty(e){return "visibility"===e?this.visibility:this._unevaluatedLayout.getValue(e);}setLayoutProperty(e,t,i={}){null!=t&&this._validate(Bn,`layers.${this.id}.layout.${e}`,e,t,i)||("visibility"!==e?this._unevaluatedLayout.setValue(e,t):this.visibility=t);}getPaintProperty(e){return ae(e,Ta)?this._transitionablePaint.getTransition(e.slice(0,-Ta.length)):this._transitionablePaint.getValue(e);}setPaintProperty(e,t,i={}){if(null!=t&&this._validate(Fn,`layers.${this.id}.paint.${e}`,e,t,i))return !1;if(ae(e,Ta))return this._transitionablePaint.setTransition(e.slice(0,-Ta.length),t||void 0),!1;{const i=this._transitionablePaint._values[e],r="cross-faded-data-driven"===i.property.specification["property-type"],n=i.value.isDataDriven(),o=i.value;this._transitionablePaint.setValue(e,t),this._handleSpecialPaintPropertyUpdate(e);const s=this._transitionablePaint._values[e].value;return s.isDataDriven()||n||r||this._handleOverridablePaintPropertyUpdate(e,o,s);}}_handleSpecialPaintPropertyUpdate(e){}getProgramIds(){return null;}getProgramConfiguration(e){return null;}_handleOverridablePaintPropertyUpdate(e,t,i){return !1;}isHidden(e){return !!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||"none"===this.visibility;}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint);}hasTransition(){return this._transitioningPaint.hasTransition();}recalculate(e,t){e.getCrossfadeParameters&&(this._crossfadeParameters=e.getCrossfadeParameters()),this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,t)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,t);}serialize(){const e={id:this.id,type:this.type,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()};return this.visibility&&(e.layout=e.layout||{},e.layout.visibility=this.visibility),ce(e,(e,t)=>!(void 0===e||"layout"===t&&!Object.keys(e).length||"paint"===t&&!Object.keys(e).length));}_validate(e,t,i,r,n={}){return (!n||!1!==n.validate)&&Un(this,e.call(zn,{key:t,layerType:this.type,objectKey:i,value:r,styleSpec:xt,style:{glyphs:!0,sprite:!0}}));}is3D(){return !1;}isSky(){return !1;}isTileClipped(){return !1;}hasOffscreenPass(){return !1;}resize(){}isStateDependent(){for(const e in this.paint._values){const t=this.paint.get(e);if(t instanceof Qo&&Ar(t.property.specification)&&("source"===t.value.kind||"composite"===t.value.kind)&&t.value.isStateDependent)return !0;}return !1;}compileFilter(){this._filterCompiled||(this._featureFilter=on(this.filter),this._filterCompiled=!0);}invalidateCompiledFilter(){this._filterCompiled=!1;}dynamicFilter(){return this._featureFilter.dynamicFilter;}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature;}}const Na=us([{name:"a_pos",components:2,type:"Int16"}],4),{members:Ia}=Na;class Ma{constructor(e=[]){this.segments=e;}prepareSegment(e,t,i,r){let n=this.segments[this.segments.length-1];return e>Ma.MAX_VERTEX_ARRAY_LENGTH&&de(`Max vertices per segment is ${Ma.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!n||n.vertexLength+e>Ma.MAX_VERTEX_ARRAY_LENGTH||n.sortKey!==r)&&(n={vertexOffset:t.length,primitiveOffset:i.length,vertexLength:0,primitiveLength:0},void 0!==r&&(n.sortKey=r),this.segments.push(n)),n;}get(){return this.segments;}destroy(){for(const e of this.segments)for(const t in e.vaos)e.vaos[t].destroy();}static simpleSegment(e,t,i,r){return new Ma([{vertexOffset:e,primitiveOffset:t,vertexLength:i,primitiveLength:r,vaos:{},sortKey:0}]);}}Ma.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,qn("SegmentVector",Ma);var Ca=8192;class Aa{constructor(e,t){e&&(t?this.setSouthWest(e).setNorthEast(t):4===e.length?this.setSouthWest([e[0],e[1]]).setNorthEast([e[2],e[3]]):this.setSouthWest(e[0]).setNorthEast(e[1]));}setNorthEast(e){return this._ne=e instanceof La?new La(e.lng,e.lat):La.convert(e),this;}setSouthWest(e){return this._sw=e instanceof La?new La(e.lng,e.lat):La.convert(e),this;}extend(e){const t=this._sw,i=this._ne;let r,n;if(e instanceof La)r=e,n=e;else {if(!(e instanceof Aa))return Array.isArray(e)?4===e.length||e.every(Array.isArray)?this.extend(Aa.convert(e)):this.extend(La.convert(e)):this;if(r=e._sw,n=e._ne,!r||!n)return this;}return t||i?(t.lng=Math.min(r.lng,t.lng),t.lat=Math.min(r.lat,t.lat),i.lng=Math.max(n.lng,i.lng),i.lat=Math.max(n.lat,i.lat)):(this._sw=new La(r.lng,r.lat),this._ne=new La(n.lng,n.lat)),this;}getCenter(){return new La((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2);}getSouthWest(){return this._sw;}getNorthEast(){return this._ne;}getNorthWest(){return new La(this.getWest(),this.getNorth());}getSouthEast(){return new La(this.getEast(),this.getSouth());}getWest(){return this._sw.lng;}getSouth(){return this._sw.lat;}getEast(){return this._ne.lng;}getNorth(){return this._ne.lat;}toArray(){return [this._sw.toArray(),this._ne.toArray()];}toString(){return `LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`;}isEmpty(){return !(this._sw&&this._ne);}contains(e){const{lng:t,lat:i}=La.convert(e);let r=this._sw.lng<=t&&t<=this._ne.lng;return this._sw.lng>this._ne.lng&&(r=this._sw.lng>=t&&t>=this._ne.lng),this._sw.lat<=i&&i<=this._ne.lat&&r;}static convert(e){return !e||e instanceof Aa?e:new Aa(e);}}const Pa=6371008.8;class La{constructor(e,t){if(isNaN(e)||isNaN(t))throw new Error(`Invalid LngLat object: (${e}, ${t})`);if(this.lng=+e,this.lat=+t,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90");}wrap(){return new La(J(this.lng,-180,180),this.lat);}toArray(){return [this.lng,this.lat];}toString(){return `LngLat(${this.lng}, ${this.lat})`;}distanceTo(e){const t=Math.PI/180,i=this.lat*t,r=e.lat*t,n=Math.sin(i)*Math.sin(r)+Math.cos(i)*Math.cos(r)*Math.cos((e.lng-this.lng)*t);return Pa*Math.acos(Math.min(n,1));}toBounds(e=0){const t=360*e/40075017,i=t/Math.cos(Math.PI/180*this.lat);return new Aa(new La(this.lng-i,this.lat-t),new La(this.lng+i,this.lat+t));}static convert(e){if(e instanceof La)return e;if(Array.isArray(e)&&(2===e.length||3===e.length))return new La(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&"object"==typeof e&&null!==e)return new La(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]");}}const Da=2*Math.PI*Pa;function ka(e){return Da*Math.cos(e*Math.PI/180);}function za(e){return (180+e)/360;}function Ra(e){return (180-180/Math.PI*Math.log(Math.tan(Math.PI/4+e*Math.PI/360)))/360;}function Oa(e,t){return e/ka(t);}function Fa(e){return 360*e-180;}function Ba(e){return 360/Math.PI*Math.atan(Math.exp((180-360*e)*Math.PI/180))-90;}function Ua(e,t){return e*ka(Ba(t));}const Va=85.051129;class Ga{constructor(e,t,i=0){this.x=+e,this.y=+t,this.z=+i;}static fromLngLat(e,t=0){const i=La.convert(e);return new Ga(za(i.lng),Ra(i.lat),Oa(t,i.lat));}toLngLat(){return new La(Fa(this.x),Ba(this.y));}toAltitude(){return Ua(this.z,this.y);}meterInMercatorCoordinateUnits(){return 1/Da*(e=Ba(this.y),1/Math.cos(e*Math.PI/180));var e;}}function ja(e,t,i,r,o,s,a,l,c){const h=(t+r)/2,u=(i+o)/2,d=new n(h,u);l(d),function(e,t,i,r,n,o){const s=i-n,a=r-o;return Math.abs((r-t)*s-(i-e)*a)/Math.hypot(s,a);}(d.x,d.y,s.x,s.y,a.x,a.y)>=c?(ja(e,t,i,h,u,s,d,l,c),ja(e,h,u,r,o,d,a,l,c)):e.push(a);}function $a(e,t,i){const r=[];let n,o,s;for(const a of e){const{x:e,y:l}=a;t(a),s?ja(r,n,o,e,l,s,a,t,i):r.push(a),n=e,o=l,s=a;}return r;}const Ha=Math.pow(2,14)-1,qa=-Ha-1;function Za(e,t){const i=Math.round(e.x*t),r=Math.round(e.y*t);return e.x=W(i,qa,Ha),e.y=W(r,qa,Ha),(i<e.x||i>e.x+1||r<e.y||r>e.y+1)&&de("Geometry exceeds allowed extent, reduce your vector tile buffer size"),e;}function Xa(e,t,i){const r=e.loadGeometry(),n=e.extent,o=Ca/n;if(t&&i&&i.projection.isReprojectedInTileSpace){const o=1<<t.z,{scale:s,x:a,y:l,projection:c}=i,h=e=>{const i=Fa((t.x+e.x/n)/o),r=Ba((t.y+e.y/n)/o),h=c.project(i,r);e.x=(h.x*s-a)*n,e.y=(h.y*s-l)*n;};for(let t=0;t<r.length;t++)if(1!==e.type)r[t]=$a(r[t],h,1);else {const e=[];for(const i of r[t])i.x<0||i.x>=n||i.y<0||i.y>=n||(h(i),e.push(i));r[t]=e;}}for(const e of r)for(const t of e)Za(t,o);return r;}function Wa(e,t){return {type:e.type,id:e.id,properties:e.properties,geometry:t?Xa(e):[]};}function Ya(e,t,i,r,n){e.emplaceBack(2*t+(r+1)/2,2*i+(n+1)/2);}class Ja{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(e=>e.id),this.index=e.index,this.hasPattern=!1,this.layoutVertexArray=new ps(),this.indexArray=new Es(),this.segments=new Ma(),this.programConfigurations=new ya(e.layers,e.zoom),this.stateDependentLayerIds=this.layers.filter(e=>e.isStateDependent()).map(e=>e.id);}populate(e,t,i,r){const n=this.layers[0],o=[];let s=null;"circle"===n.type&&(s=n.layout.get("circle-sort-key"));for(const{feature:t,id:n,index:a,sourceLayerIndex:l}of e){const e=this.layers[0]._featureFilter.needGeometry,c=Wa(t,e);if(!this.layers[0]._featureFilter.filter(new qo(this.zoom),c,i))continue;const h=s?s.evaluate(c,{},i):void 0,u={id:n,properties:t.properties,type:t.type,sourceLayerIndex:l,index:a,geometry:e?c.geometry:Xa(t,i,r),patterns:{},sortKey:h};o.push(u);}s&&o.sort((e,t)=>e.sortKey-t.sortKey);for(const r of o){const{geometry:n,index:o,sourceLayerIndex:s}=r,a=e[o].feature;this.addFeature(r,n,o,t.availableImages,i),t.featureIndex.insert(a,n,o,s,this.index);}}update(e,t,i,r){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,t,this.stateDependentLayers,i,r);}isEmpty(){return 0===this.layoutVertexArray.length;}uploadPending(){return !this.uploaded||this.programConfigurations.needsUpload;}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Ia),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0;}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy());}addFeature(e,t,i,r,n){for(const i of t)for(const t of i){const i=t.x,r=t.y;if(i<0||i>=Ca||r<0||r>=Ca)continue;const n=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),o=n.vertexLength;Ya(this.layoutVertexArray,i,r,-1,-1),Ya(this.layoutVertexArray,i,r,1,-1),Ya(this.layoutVertexArray,i,r,1,1),Ya(this.layoutVertexArray,i,r,-1,1),this.indexArray.emplaceBack(o,o+1,o+2),this.indexArray.emplaceBack(o,o+3,o+2),n.vertexLength+=4,n.primitiveLength+=2;}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,i,{},r,n);}}function Ka(e,t){for(let i=0;i<e.length;i++)if(al(t,e[i]))return !0;for(let i=0;i<t.length;i++)if(al(e,t[i]))return !0;return !!il(e,t);}function Qa(e,t,i){return !!al(e,t)||!!nl(t,e,i);}function el(e,t){if(1===e.length)return sl(t,e[0]);for(let i=0;i<t.length;i++){const r=t[i];for(let t=0;t<r.length;t++)if(al(e,r[t]))return !0;}for(let i=0;i<e.length;i++)if(sl(t,e[i]))return !0;for(let i=0;i<t.length;i++)if(il(e,t[i]))return !0;return !1;}function tl(e,t,i){if(e.length>1){if(il(e,t))return !0;for(let r=0;r<t.length;r++)if(nl(t[r],e,i))return !0;}for(let r=0;r<e.length;r++)if(nl(e[r],t,i))return !0;return !1;}function il(e,t){if(0===e.length||0===t.length)return !1;for(let i=0;i<e.length-1;i++){const r=e[i],n=e[i+1];for(let e=0;e<t.length-1;e++)if(rl(r,n,t[e],t[e+1]))return !0;}return !1;}function rl(e,t,i,r){return pe(e,i,r)!==pe(t,i,r)&&pe(e,t,i)!==pe(e,t,r);}function nl(e,t,i){const r=i*i;if(1===t.length)return e.distSqr(t[0])<r;for(let i=1;i<t.length;i++)if(ol(e,t[i-1],t[i])<r)return !0;return !1;}function ol(e,t,i){const r=t.distSqr(i);if(0===r)return e.distSqr(t);const n=((e.x-t.x)*(i.x-t.x)+(e.y-t.y)*(i.y-t.y))/r;return e.distSqr(n<0?t:n>1?i:i.sub(t)._mult(n)._add(t));}function sl(e,t){let i,r,n,o=!1;for(let s=0;s<e.length;s++){i=e[s];for(let e=0,s=i.length-1;e<i.length;s=e++)r=i[e],n=i[s],r.y>t.y!=n.y>t.y&&t.x<(n.x-r.x)*(t.y-r.y)/(n.y-r.y)+r.x&&(o=!o);}return o;}function al(e,t){let i=!1;for(let r=0,n=e.length-1;r<e.length;n=r++){const o=e[r],s=e[n];o.y>t.y!=s.y>t.y&&t.x<(s.x-o.x)*(t.y-o.y)/(s.y-o.y)+o.x&&(i=!i);}return i;}function ll(e,t,i,r,o){for(const n of e)if(t<=n.x&&i<=n.y&&r>=n.x&&o>=n.y)return !0;const s=[new n(t,i),new n(t,o),new n(r,o),new n(r,i)];if(e.length>2)for(const t of s)if(al(e,t))return !0;for(let t=0;t<e.length-1;t++)if(cl(e[t],e[t+1],s))return !0;return !1;}function cl(e,t,i){const r=i[0],n=i[2];if(e.x<r.x&&t.x<r.x||e.x>n.x&&t.x>n.x||e.y<r.y&&t.y<r.y||e.y>n.y&&t.y>n.y)return !1;const o=pe(e,t,i[0]);return o!==pe(e,t,i[1])||o!==pe(e,t,i[2])||o!==pe(e,t,i[3]);}function hl(e,t,i){const r=t.paint.get(e).value;return "constant"===r.kind?r.value:i.programConfigurations.get(t.id).getMaxValue(e);}function ul(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1]);}function dl(e,t,i,r,o){if(!t[0]&&!t[1])return e;const s=n.convert(t)._mult(o);"viewport"===i&&s._rotate(-r);const a=[];for(let t=0;t<e.length;t++)a.push(e[t].sub(s));return a;}function pl(e,t,i,r){const o=n.convert(e)._mult(r);return "viewport"===t&&o._rotate(-i),o;}qn("CircleBucket",Ja,{omit:["layers"]});const fl=new ss({"circle-sort-key":new is(xt.layout_circle["circle-sort-key"])});var ml={paint:new ss({"circle-radius":new is(xt.paint_circle["circle-radius"]),"circle-color":new is(xt.paint_circle["circle-color"]),"circle-blur":new is(xt.paint_circle["circle-blur"]),"circle-opacity":new is(xt.paint_circle["circle-opacity"]),"circle-translate":new ts(xt.paint_circle["circle-translate"]),"circle-translate-anchor":new ts(xt.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new ts(xt.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new ts(xt.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new is(xt.paint_circle["circle-stroke-width"]),"circle-stroke-color":new is(xt.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new is(xt.paint_circle["circle-stroke-opacity"])}),layout:fl};class _l{constructor(e,t){this.points=e,this.planes=t;}static fromInvProjectionMatrix(e,t,i,r){const n=Math.pow(2,i),o=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map(i=>{const o=R([],i,e),s=1/o[3]/t*n;return function(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e[2]=t[2]*i[2],e[3]=t[3]*i[3],e;}(o,o,[s,s,r?1/o[3]:s,s]);}),s=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map(e=>{const t=I([],C([],D([],o[e[0]],o[e[1]]),D([],o[e[2]],o[e[1]]))),i=-M(t,o[e[1]]);return t.concat(i);});return new _l(o,s);}}class gl{constructor(e,t){this.min=e,this.max=t,this.center=E([],b([],this.min,this.max),.5);}quadrant(e){const t=[e%2==0,e<2],i=y(this.min),r=y(this.max);for(let e=0;e<t.length;e++)i[e]=t[e]?this.min[e]:this.center[e],r[e]=t[e]?this.center[e]:this.max[e];return r[2]=this.max[2],new gl(i,r);}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0];}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1];}distanceZ(e){return Math.max(Math.min(this.max[2],e[2]),this.min[2])-e[2];}getCorners(){const e=this.min,t=this.max;return [[e[0],e[1],e[2]],[t[0],e[1],e[2]],[t[0],t[1],e[2]],[e[0],t[1],e[2]],[e[0],e[1],t[2]],[t[0],e[1],t[2]],[t[0],t[1],t[2]],[e[0],t[1],t[2]]];}intersects(e){const t=this.getCorners();let i=!0;for(let r=0;r<e.planes.length;r++){const n=e.planes[r];let o=0;for(let e=0;e<t.length;e++)o+=M(n,t[e])+n[3]>=0;if(0===o)return 0;o!==t.length&&(i=!1);}if(i)return 2;for(let t=0;t<3;t++){let i=Number.MAX_VALUE,r=-Number.MAX_VALUE;for(let n=0;n<e.points.length;n++){const o=e.points[n][t]-this.min[t];i=Math.min(i,o),r=Math.max(r,o);}if(r<0||i>this.max[t]-this.min[t])return 0;}return 1;}}function yl(e,t,i,r,n,o,s,a,l){if(o&&e.queryGeometry.isAboveHorizon)return !1;o&&(l*=e.pixelToTileUnitsFactor);for(const c of t)for(const t of c){const c=t.add(a),h=n&&i.elevation?i.elevation.exaggeration()*n.getElevationAt(c.x,c.y,!0):0,u=o?c:xl(c,h,r),d=o?e.tilespaceRays.map(e=>Sl(e,h)):e.queryGeometry.screenGeometry,p=R([],[t.x,t.y,h,1],r);if(!s&&o?l*=p[3]/i.cameraToCenterDistance:s&&!o&&(l*=i.cameraToCenterDistance/p[3]),Qa(d,u,l))return !0;}return !1;}function xl(e,t,i){const r=R([],[e.x,e.y,t,1],i);return new n(r[0]/r[3],r[1]/r[3]);}const vl=v(0,0,0),bl=v(0,0,1);function Sl(e,t){const i=g();return vl[2]=t,e.intersectsPlane(vl,bl,i),new n(i[0],i[1]);}class wl extends Ja{}function Tl(e,{width:t,height:i},r,n){if(n){if(n instanceof Uint8ClampedArray)n=new Uint8Array(n.buffer);else if(n.length!==t*i*r)throw new RangeError("mismatched image size");}else n=new Uint8Array(t*i*r);return e.width=t,e.height=i,e.data=n,e;}function El(e,{width:t,height:i},r){if(t===e.width&&i===e.height)return;const n=Tl({},{width:t,height:i},r);Nl(e,n,{x:0,y:0},{x:0,y:0},{width:Math.min(e.width,t),height:Math.min(e.height,i)},r),e.width=t,e.height=i,e.data=n.data;}function Nl(e,t,i,r,n,o){if(0===n.width||0===n.height)return t;if(n.width>e.width||n.height>e.height||i.x>e.width-n.width||i.y>e.height-n.height)throw new RangeError("out of range source coordinates for image copy");if(n.width>t.width||n.height>t.height||r.x>t.width-n.width||r.y>t.height-n.height)throw new RangeError("out of range destination coordinates for image copy");const s=e.data,a=t.data;for(let l=0;l<n.height;l++){const c=((i.y+l)*e.width+i.x)*o,h=((r.y+l)*t.width+r.x)*o;for(let e=0;e<n.width*o;e++)a[h+e]=s[c+e];}return t;}qn("HeatmapBucket",wl,{omit:["layers"]});class Il{constructor(e,t){Tl(this,e,1,t);}resize(e){El(this,e,1);}clone(){return new Il({width:this.width,height:this.height},new Uint8Array(this.data));}static copy(e,t,i,r,n){Nl(e,t,i,r,n,1);}}class Ml{constructor(e,t){Tl(this,e,4,t);}resize(e){El(this,e,4);}replace(e,t){t?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e;}clone(){return new Ml({width:this.width,height:this.height},new Uint8Array(this.data));}static copy(e,t,i,r,n){Nl(e,t,i,r,n,4);}}qn("AlphaImage",Il),qn("RGBAImage",Ml);var Cl={paint:new ss({"heatmap-radius":new is(xt.paint_heatmap["heatmap-radius"]),"heatmap-weight":new is(xt.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new ts(xt.paint_heatmap["heatmap-intensity"]),"heatmap-color":new os(xt.paint_heatmap["heatmap-color"]),"heatmap-opacity":new ts(xt.paint_heatmap["heatmap-opacity"])})};function Al(e){const t={},i=e.resolution||256,r=e.clips?e.clips.length:1,n=e.image||new Ml({width:i,height:r}),o=(i,r,o)=>{t[e.evaluationKey]=o;const s=e.expression.evaluate(t);n.data[i+r+0]=Math.floor(255*s.r/s.a),n.data[i+r+1]=Math.floor(255*s.g/s.a),n.data[i+r+2]=Math.floor(255*s.b/s.a),n.data[i+r+3]=Math.floor(255*s.a);};if(e.clips)for(let t=0,n=0;t<r;++t,n+=4*i)for(let r=0,s=0;r<i;r++,s+=4){const a=r/(i-1),{start:l,end:c}=e.clips[t];o(n,s,l*(1-a)+c*a);}else for(let e=0,t=0;e<i;e++,t+=4)o(0,t,e/(i-1));return n;}var Pl={paint:new ss({"hillshade-illumination-direction":new ts(xt.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new ts(xt.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new ts(xt.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new ts(xt.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new ts(xt.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new ts(xt.paint_hillshade["hillshade-accent-color"])})};const Ll=us([{name:"a_pos",components:2,type:"Int16"}],4),{members:Dl}=Ll;var kl=Rl,zl=Rl;function Rl(e,t,i){i=i||2;var r,n,o,s,a,l,c,h=t&&t.length,u=h?t[0]*i:e.length,d=Ol(e,0,u,i,!0),p=[];if(!d||d.next===d.prev)return p;if(h&&(d=function(e,t,i,r){var n,o,s,a=[];for(n=0,o=t.length;n<o;n++)(s=Ol(e,t[n]*r,n<o-1?t[n+1]*r:e.length,r,!1))===s.next&&(s.steiner=!0),a.push(Xl(s));for(a.sort($l),n=0;n<a.length;n++)i=Fl(i=Hl(a[n],i),i.next);return i;}(e,t,d,i)),e.length>80*i){r=o=e[0],n=s=e[1];for(var f=i;f<u;f+=i)(a=e[f])<r&&(r=a),(l=e[f+1])<n&&(n=l),a>o&&(o=a),l>s&&(s=l);c=0!==(c=Math.max(o-r,s-n))?1/c:0;}return Bl(d,p,i,r,n,c),p;}function Ol(e,t,i,r,n){var o,s;if(n===ac(e,t,i,r)>0)for(o=t;o<i;o+=r)s=nc(o,e[o],e[o+1],s);else for(o=i-r;o>=t;o-=r)s=nc(o,e[o],e[o+1],s);return s&&Kl(s,s.next)&&(oc(s),s=s.next),s;}function Fl(e,t){if(!e)return e;t||(t=e);var i,r=e;do{if(i=!1,r.steiner||!Kl(r,r.next)&&0!==Jl(r.prev,r,r.next))r=r.next;else {if(oc(r),(r=t=r.prev)===r.next)break;i=!0;}}while(i||r!==t);return t;}function Bl(e,t,i,r,n,o,s){if(e){!s&&o&&function(e,t,i,r){var n=e;do{null===n.z&&(n.z=Zl(n.x,n.y,t,i,r)),n.prevZ=n.prev,n.nextZ=n.next,n=n.next;}while(n!==e);n.prevZ.nextZ=null,n.prevZ=null,function(e){var t,i,r,n,o,s,a,l,c=1;do{for(i=e,e=null,o=null,s=0;i;){for(s++,r=i,a=0,t=0;t<c&&(a++,r=r.nextZ);t++);for(l=c;a>0||l>0&&r;)0!==a&&(0===l||!r||i.z<=r.z)?(n=i,i=i.nextZ,a--):(n=r,r=r.nextZ,l--),o?o.nextZ=n:e=n,n.prevZ=o,o=n;i=r;}o.nextZ=null,c*=2;}while(s>1);}(n);}(e,r,n,o);for(var a,l,c=e;e.prev!==e.next;)if(a=e.prev,l=e.next,o?Vl(e,r,n,o):Ul(e))t.push(a.i/i),t.push(e.i/i),t.push(l.i/i),oc(e),e=l.next,c=l.next;else if((e=l)===c){s?1===s?Bl(e=Gl(Fl(e),t,i),t,i,r,n,o,2):2===s&&jl(e,t,i,r,n,o):Bl(Fl(e),t,i,r,n,o,1);break;}}}function Ul(e){var t=e.prev,i=e,r=e.next;if(Jl(t,i,r)>=0)return !1;for(var n=e.next.next;n!==e.prev;){if(Wl(t.x,t.y,i.x,i.y,r.x,r.y,n.x,n.y)&&Jl(n.prev,n,n.next)>=0)return !1;n=n.next;}return !0;}function Vl(e,t,i,r){var n=e.prev,o=e,s=e.next;if(Jl(n,o,s)>=0)return !1;for(var a=n.x>o.x?n.x>s.x?n.x:s.x:o.x>s.x?o.x:s.x,l=n.y>o.y?n.y>s.y?n.y:s.y:o.y>s.y?o.y:s.y,c=Zl(n.x<o.x?n.x<s.x?n.x:s.x:o.x<s.x?o.x:s.x,n.y<o.y?n.y<s.y?n.y:s.y:o.y<s.y?o.y:s.y,t,i,r),h=Zl(a,l,t,i,r),u=e.prevZ,d=e.nextZ;u&&u.z>=c&&d&&d.z<=h;){if(u!==e.prev&&u!==e.next&&Wl(n.x,n.y,o.x,o.y,s.x,s.y,u.x,u.y)&&Jl(u.prev,u,u.next)>=0)return !1;if(u=u.prevZ,d!==e.prev&&d!==e.next&&Wl(n.x,n.y,o.x,o.y,s.x,s.y,d.x,d.y)&&Jl(d.prev,d,d.next)>=0)return !1;d=d.nextZ;}for(;u&&u.z>=c;){if(u!==e.prev&&u!==e.next&&Wl(n.x,n.y,o.x,o.y,s.x,s.y,u.x,u.y)&&Jl(u.prev,u,u.next)>=0)return !1;u=u.prevZ;}for(;d&&d.z<=h;){if(d!==e.prev&&d!==e.next&&Wl(n.x,n.y,o.x,o.y,s.x,s.y,d.x,d.y)&&Jl(d.prev,d,d.next)>=0)return !1;d=d.nextZ;}return !0;}function Gl(e,t,i){var r=e;do{var n=r.prev,o=r.next.next;!Kl(n,o)&&Ql(n,r,r.next,o)&&ic(n,o)&&ic(o,n)&&(t.push(n.i/i),t.push(r.i/i),t.push(o.i/i),oc(r),oc(r.next),r=e=o),r=r.next;}while(r!==e);return Fl(r);}function jl(e,t,i,r,n,o){var s=e;do{for(var a=s.next.next;a!==s.prev;){if(s.i!==a.i&&Yl(s,a)){var l=rc(s,a);return s=Fl(s,s.next),l=Fl(l,l.next),Bl(s,t,i,r,n,o),void Bl(l,t,i,r,n,o);}a=a.next;}s=s.next;}while(s!==e);}function $l(e,t){return e.x-t.x;}function Hl(e,t){var i=function(e,t){var i,r=t,n=e.x,o=e.y,s=-1/0;do{if(o<=r.y&&o>=r.next.y&&r.next.y!==r.y){var a=r.x+(o-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(a<=n&&a>s){if(s=a,a===n){if(o===r.y)return r;if(o===r.next.y)return r.next;}i=r.x<r.next.x?r:r.next;}}r=r.next;}while(r!==t);if(!i)return null;if(n===s)return i;var l,c=i,h=i.x,u=i.y,d=1/0;r=i;do{n>=r.x&&r.x>=h&&n!==r.x&&Wl(o<u?n:s,o,h,u,o<u?s:n,o,r.x,r.y)&&(l=Math.abs(o-r.y)/(n-r.x),ic(r,e)&&(l<d||l===d&&(r.x>i.x||r.x===i.x&&ql(i,r)))&&(i=r,d=l)),r=r.next;}while(r!==c);return i;}(e,t);if(!i)return t;var r=rc(i,e),n=Fl(i,i.next);return Fl(r,r.next),t===i?n:t;}function ql(e,t){return Jl(e.prev,e,t.prev)<0&&Jl(t.next,e,e.next)<0;}function Zl(e,t,i,r,n){return (e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)*n)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*n)|t<<8))|t<<4))|t<<2))|t<<1))<<1;}function Xl(e){var t=e,i=e;do{(t.x<i.x||t.x===i.x&&t.y<i.y)&&(i=t),t=t.next;}while(t!==e);return i;}function Wl(e,t,i,r,n,o,s,a){return (n-s)*(t-a)-(e-s)*(o-a)>=0&&(e-s)*(r-a)-(i-s)*(t-a)>=0&&(i-s)*(o-a)-(n-s)*(r-a)>=0;}function Yl(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&Ql(i,i.next,e,t))return !0;i=i.next;}while(i!==e);return !1;}(e,t)&&(ic(e,t)&&ic(t,e)&&function(e,t){var i=e,r=!1,n=(e.x+t.x)/2,o=(e.y+t.y)/2;do{i.y>o!=i.next.y>o&&i.next.y!==i.y&&n<(i.next.x-i.x)*(o-i.y)/(i.next.y-i.y)+i.x&&(r=!r),i=i.next;}while(i!==e);return r;}(e,t)&&(Jl(e.prev,e,t.prev)||Jl(e,t.prev,t))||Kl(e,t)&&Jl(e.prev,e,e.next)>0&&Jl(t.prev,t,t.next)>0);}function Jl(e,t,i){return (t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y);}function Kl(e,t){return e.x===t.x&&e.y===t.y;}function Ql(e,t,i,r){var n=tc(Jl(e,t,i)),o=tc(Jl(e,t,r)),s=tc(Jl(i,r,e)),a=tc(Jl(i,r,t));return n!==o&&s!==a||!(0!==n||!ec(e,i,t))||!(0!==o||!ec(e,r,t))||!(0!==s||!ec(i,e,r))||!(0!==a||!ec(i,t,r));}function ec(e,t,i){return t.x<=Math.max(e.x,i.x)&&t.x>=Math.min(e.x,i.x)&&t.y<=Math.max(e.y,i.y)&&t.y>=Math.min(e.y,i.y);}function tc(e){return e>0?1:e<0?-1:0;}function ic(e,t){return Jl(e.prev,e,e.next)<0?Jl(e,t,e.next)>=0&&Jl(e,e.prev,t)>=0:Jl(e,t,e.prev)<0||Jl(e,e.next,t)<0;}function rc(e,t){var i=new sc(e.i,e.x,e.y),r=new sc(t.i,t.x,t.y),n=e.next,o=t.prev;return e.next=t,t.prev=e,i.next=n,n.prev=i,r.next=i,i.prev=r,o.next=r,r.prev=o,r;}function nc(e,t,i,r){var n=new sc(e,t,i);return r?(n.next=r.next,n.prev=r,r.next.prev=n,r.next=n):(n.prev=n,n.next=n),n;}function oc(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ);}function sc(e,t,i){this.i=e,this.x=t,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1;}function ac(e,t,i,r){for(var n=0,o=t,s=i-r;o<i;o+=r)n+=(e[s]-e[o])*(e[o+1]+e[s+1]),s=o;return n;}function lc(e,t,i,r,n){cc(e,t,i||0,r||e.length-1,n||uc);}function cc(e,t,i,r,n){for(;r>i;){if(r-i>600){var o=r-i+1,s=t-i+1,a=Math.log(o),l=.5*Math.exp(2*a/3),c=.5*Math.sqrt(a*l*(o-l)/o)*(s-o/2<0?-1:1);cc(e,t,Math.max(i,Math.floor(t-s*l/o+c)),Math.min(r,Math.floor(t+(o-s)*l/o+c)),n);}var h=e[t],u=i,d=r;for(hc(e,i,t),n(e[r],h)>0&&hc(e,i,r);u<d;){for(hc(e,u,d),u++,d--;n(e[u],h)<0;)u++;for(;n(e[d],h)>0;)d--;}0===n(e[i],h)?hc(e,i,d):hc(e,++d,r),d<=t&&(i=d+1),t<=d&&(r=d-1);}}function hc(e,t,i){var r=e[t];e[t]=e[i],e[i]=r;}function uc(e,t){return e<t?-1:e>t?1:0;}function dc(e,t){const i=e.length;if(i<=1)return [e];const r=[];let n,o;for(let t=0;t<i;t++){const i=fe(e[t]);0!==i&&(e[t].area=Math.abs(i),void 0===o&&(o=i<0),o===i<0?(n&&r.push(n),n=[e[t]]):n.push(e[t]));}if(n&&r.push(n),t>1)for(let e=0;e<r.length;e++)r[e].length<=t||(lc(r[e],t,1,r[e].length-1,pc),r[e]=r[e].slice(0,t));return r;}function pc(e,t){return t.area-e.area;}function fc(e,t,i){const r=i.patternDependencies;let n=!1;for(const i of t){const t=i.paint.get(`${e}-pattern`);t.isConstant()||(n=!0);const o=t.constantOr(null);o&&(n=!0,r[o.to]=!0,r[o.from]=!0);}return n;}function mc(e,t,i,r,n){const o=n.patternDependencies;for(const s of t){const t=s.paint.get(`${e}-pattern`).value;if("constant"!==t.kind){let e=t.evaluate({zoom:r-1},i,{},n.availableImages),a=t.evaluate({zoom:r},i,{},n.availableImages),l=t.evaluate({zoom:r+1},i,{},n.availableImages);e=e&&e.name?e.name:e,a=a&&a.name?a.name:a,l=l&&l.name?l.name:l,o[e]=!0,o[a]=!0,o[l]=!0,i.patterns[s.id]={min:e,mid:a,max:l};}}return i;}Rl.deviation=function(e,t,i,r){var n=t&&t.length,o=Math.abs(ac(e,0,n?t[0]*i:e.length,i));if(n)for(var s=0,a=t.length;s<a;s++)o-=Math.abs(ac(e,t[s]*i,s<a-1?t[s+1]*i:e.length,i));var l=0;for(s=0;s<r.length;s+=3){var c=r[s]*i,h=r[s+1]*i,u=r[s+2]*i;l+=Math.abs((e[c]-e[u])*(e[h+1]-e[c+1])-(e[c]-e[h])*(e[u+1]-e[c+1]));}return 0===o&&0===l?0:Math.abs((l-o)/o);},Rl.flatten=function(e){for(var t=e[0][0].length,i={vertices:[],holes:[],dimensions:t},r=0,n=0;n<e.length;n++){for(var o=0;o<e[n].length;o++)for(var s=0;s<t;s++)i.vertices.push(e[n][o][s]);n>0&&i.holes.push(r+=e[n-1].length);}return i;},kl.default=zl;class _c{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(e=>e.id),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.layoutVertexArray=new ps(),this.indexArray=new Es(),this.indexArray2=new Ls(),this.programConfigurations=new ya(e.layers,e.zoom),this.segments=new Ma(),this.segments2=new Ma(),this.stateDependentLayerIds=this.layers.filter(e=>e.isStateDependent()).map(e=>e.id);}populate(e,t,i,r){this.hasPattern=fc("fill",this.layers,t);const n=this.layers[0].layout.get("fill-sort-key"),o=[];for(const{feature:s,id:a,index:l,sourceLayerIndex:c}of e){const e=this.layers[0]._featureFilter.needGeometry,h=Wa(s,e);if(!this.layers[0]._featureFilter.filter(new qo(this.zoom),h,i))continue;const u=n?n.evaluate(h,{},i,t.availableImages):void 0,d={id:a,properties:s.properties,type:s.type,sourceLayerIndex:c,index:l,geometry:e?h.geometry:Xa(s,i,r),patterns:{},sortKey:u};o.push(d);}n&&o.sort((e,t)=>e.sortKey-t.sortKey);for(const r of o){const{geometry:n,index:o,sourceLayerIndex:s}=r;if(this.hasPattern){const e=mc("fill",this.layers,r,this.zoom,t);this.patternFeatures.push(e);}else this.addFeature(r,n,o,i,{},t.availableImages);t.featureIndex.insert(e[o].feature,n,o,s,this.index);}}update(e,t,i,r){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,t,this.stateDependentLayers,i,r);}addFeatures(e,t,i,r){for(const e of this.patternFeatures)this.addFeature(e,e.geometry,e.index,t,i,r);}isEmpty(){return 0===this.layoutVertexArray.length;}uploadPending(){return !this.uploaded||this.programConfigurations.needsUpload;}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Dl),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.indexBuffer2=e.createIndexBuffer(this.indexArray2)),this.programConfigurations.upload(e),this.uploaded=!0;}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.indexBuffer2.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.segments2.destroy());}addFeature(e,t,i,r,n,o=[]){for(const e of dc(t,500)){let t=0;for(const i of e)t+=i.length;const i=this.segments.prepareSegment(t,this.layoutVertexArray,this.indexArray),r=i.vertexLength,n=[],o=[];for(const t of e){if(0===t.length)continue;t!==e[0]&&o.push(n.length/2);const i=this.segments2.prepareSegment(t.length,this.layoutVertexArray,this.indexArray2),r=i.vertexLength;this.layoutVertexArray.emplaceBack(t[0].x,t[0].y),this.indexArray2.emplaceBack(r+t.length-1,r),n.push(t[0].x),n.push(t[0].y);for(let e=1;e<t.length;e++)this.layoutVertexArray.emplaceBack(t[e].x,t[e].y),this.indexArray2.emplaceBack(r+e-1,r+e),n.push(t[e].x),n.push(t[e].y);i.vertexLength+=t.length,i.primitiveLength+=t.length;}const s=kl(n,o);for(let e=0;e<s.length;e+=3)this.indexArray.emplaceBack(r+s[e],r+s[e+1],r+s[e+2]);i.vertexLength+=t,i.primitiveLength+=s.length/3;}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,i,n,o,r);}}qn("FillBucket",_c,{omit:["layers","patternFeatures"]});const gc=new ss({"fill-sort-key":new is(xt.layout_fill["fill-sort-key"])});var yc={paint:new ss({"fill-antialias":new ts(xt.paint_fill["fill-antialias"]),"fill-opacity":new is(xt.paint_fill["fill-opacity"]),"fill-color":new is(xt.paint_fill["fill-color"]),"fill-outline-color":new is(xt.paint_fill["fill-outline-color"]),"fill-translate":new ts(xt.paint_fill["fill-translate"]),"fill-translate-anchor":new ts(xt.paint_fill["fill-translate-anchor"]),"fill-pattern":new rs(xt.paint_fill["fill-pattern"])}),layout:gc};const xc=us([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),vc=us([{name:"a_centroid_pos",components:2,type:"Uint16"}]),{members:bc}=xc;var Sc=wc;function wc(e,t,i,r,n){this.properties={},this.extent=i,this.type=0,this._pbf=e,this._geometry=-1,this._keys=r,this._values=n,e.readFields(Tc,this,t);}function Tc(e,t,i){1==e?t.id=i.readVarint():2==e?function(e,t){for(var i=e.readVarint()+e.pos;e.pos<i;){var r=t._keys[e.readVarint()],n=t._values[e.readVarint()];t.properties[r]=n;}}(i,t):3==e?t.type=i.readVarint():4==e&&(t._geometry=i.pos);}function Ec(e){for(var t,i,r=0,n=0,o=e.length,s=o-1;n<o;s=n++)r+=((i=e[s]).x-(t=e[n]).x)*(t.y+i.y);return r;}wc.types=["Unknown","Point","LineString","Polygon"],wc.prototype.loadGeometry=function(){var e=this._pbf;e.pos=this._geometry;for(var t,i=e.readVarint()+e.pos,r=1,o=0,s=0,a=0,l=[];e.pos<i;){if(o<=0){var c=e.readVarint();r=7&c,o=c>>3;}if(o--,1===r||2===r)s+=e.readSVarint(),a+=e.readSVarint(),1===r&&(t&&l.push(t),t=[]),t.push(new n(s,a));else {if(7!==r)throw new Error("unknown command "+r);t&&t.push(t[0].clone());}}return t&&l.push(t),l;},wc.prototype.bbox=function(){var e=this._pbf;e.pos=this._geometry;for(var t=e.readVarint()+e.pos,i=1,r=0,n=0,o=0,s=1/0,a=-1/0,l=1/0,c=-1/0;e.pos<t;){if(r<=0){var h=e.readVarint();i=7&h,r=h>>3;}if(r--,1===i||2===i)(n+=e.readSVarint())<s&&(s=n),n>a&&(a=n),(o+=e.readSVarint())<l&&(l=o),o>c&&(c=o);else if(7!==i)throw new Error("unknown command "+i);}return [s,l,a,c];},wc.prototype.toGeoJSON=function(e,t,i){var r,n,o=this.extent*Math.pow(2,i),s=this.extent*e,a=this.extent*t,l=this.loadGeometry(),c=wc.types[this.type];function h(e){for(var t=0;t<e.length;t++){var i=e[t];e[t]=[360*(i.x+s)/o-180,360/Math.PI*Math.atan(Math.exp((180-360*(i.y+a)/o)*Math.PI/180))-90];}}switch(this.type){case 1:var u=[];for(r=0;r<l.length;r++)u[r]=l[r][0];h(l=u);break;case 2:for(r=0;r<l.length;r++)h(l[r]);break;case 3:for(l=function(e){var t=e.length;if(t<=1)return [e];for(var i,r,n=[],o=0;o<t;o++){var s=Ec(e[o]);0!==s&&(void 0===r&&(r=s<0),r===s<0?(i&&n.push(i),i=[e[o]]):i.push(e[o]));}return i&&n.push(i),n;}(l),r=0;r<l.length;r++)for(n=0;n<l[r].length;n++)h(l[r][n]);}1===l.length?l=l[0]:c="Multi"+c;var d={type:"Feature",geometry:{type:c,coordinates:l},properties:this.properties};return "id"in this&&(d.id=this.id),d;};var Nc=Ic;function Ic(e,t){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=e,this._keys=[],this._values=[],this._features=[],e.readFields(Mc,this,t),this.length=this._features.length;}function Mc(e,t,i){15===e?t.version=i.readVarint():1===e?t.name=i.readString():5===e?t.extent=i.readVarint():2===e?t._features.push(i.pos):3===e?t._keys.push(i.readString()):4===e&&t._values.push(function(e){for(var t=null,i=e.readVarint()+e.pos;e.pos<i;){var r=e.readVarint()>>3;t=1===r?e.readString():2===r?e.readFloat():3===r?e.readDouble():4===r?e.readVarint64():5===r?e.readVarint():6===r?e.readSVarint():7===r?e.readBoolean():null;}return t;}(i));}function Cc(e,t,i){if(3===e){var r=new Nc(i,i.readVarint()+i.pos);r.length&&(t[r.name]=r);}}Ic.prototype.feature=function(e){if(e<0||e>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[e];var t=this._pbf.readVarint()+this._pbf.pos;return new Sc(this._pbf,t,this.extent,this._keys,this._values);};var Ac={VectorTile:function(e,t){this.layers=e.readFields(Cc,{},t);},VectorTileFeature:Sc,VectorTileLayer:Nc};const Pc=Ac.VectorTileFeature.types,Lc=Math.pow(2,13);function Dc(e,t,i,r,n,o,s,a){e.emplaceBack((t<<1)+s,(i<<1)+o,(Math.floor(r*Lc)<<1)+n,Math.round(a));}class kc{constructor(){this.acc=new n(0,0),this.polyCount=[];}startRing(e){this.currentPolyCount={edges:0,top:0},this.polyCount.push(this.currentPolyCount),this.min||(this.min=new n(e.x,e.y),this.max=new n(e.x,e.y));}append(e,t){this.currentPolyCount.edges++,this.acc._add(e);let i=!!this.borders;const r=this.min,n=this.max;e.x<r.x?(r.x=e.x,i=!0):e.x>n.x&&(n.x=e.x,i=!0),e.y<r.y?(r.y=e.y,i=!0):e.y>n.y&&(n.y=e.y,i=!0),((0===e.x||e.x===Ca)&&e.x===t.x)!=((0===e.y||e.y===Ca)&&e.y===t.y)&&this.processBorderOverlap(e,t),i&&this.checkBorderIntersection(e,t);}checkBorderIntersection(e,t){t.x<0!=e.x<0&&this.addBorderIntersection(0,Oi(t.y,e.y,(0-t.x)/(e.x-t.x))),t.x>Ca!=e.x>Ca&&this.addBorderIntersection(1,Oi(t.y,e.y,(Ca-t.x)/(e.x-t.x))),t.y<0!=e.y<0&&this.addBorderIntersection(2,Oi(t.x,e.x,(0-t.y)/(e.y-t.y))),t.y>Ca!=e.y>Ca&&this.addBorderIntersection(3,Oi(t.x,e.x,(Ca-t.y)/(e.y-t.y)));}addBorderIntersection(e,t){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const i=this.borders[e];t<i[0]&&(i[0]=t),t>i[1]&&(i[1]=t);}processBorderOverlap(e,t){if(e.x===t.x){if(e.y===t.y)return;const i=0===e.x?0:1;this.addBorderIntersection(i,t.y),this.addBorderIntersection(i,e.y);}else {const i=0===e.y?2:3;this.addBorderIntersection(i,t.x),this.addBorderIntersection(i,e.x);}}centroid(){const e=this.polyCount.reduce((e,t)=>e+t.edges,0);return 0!==e?this.acc.div(e)._round():new n(0,0);}span(){return new n(this.max.x-this.min.x,this.max.y-this.min.y);}intersectsCount(){return this.borders.reduce((e,t)=>e+ +(t[0]!==Number.MAX_VALUE),0);}}class zc{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(e=>e.id),this.index=e.index,this.hasPattern=!1,this.layoutVertexArray=new fs(),this.centroidVertexArray=new Zs(),this.indexArray=new Es(),this.programConfigurations=new ya(e.layers,e.zoom),this.segments=new Ma(),this.stateDependentLayerIds=this.layers.filter(e=>e.isStateDependent()).map(e=>e.id),this.enableTerrain=e.enableTerrain;}populate(e,t,i,r){this.features=[],this.hasPattern=fc("fill-extrusion",this.layers,t),this.featuresOnBorder=[],this.borders=[[],[],[],[]],this.borderDone=[!1,!1,!1,!1],this.tileToMeter=function(e){const t=Math.exp(Math.PI*(1-e.y/(1<<e.z)*2));return 80150034*t/(t*t+1)/Ca/(1<<e.z);}(i);for(const{feature:n,id:o,index:s,sourceLayerIndex:a}of e){const e=this.layers[0]._featureFilter.needGeometry,l=Wa(n,e);if(!this.layers[0]._featureFilter.filter(new qo(this.zoom),l,i))continue;const c={id:o,sourceLayerIndex:a,index:s,geometry:e?l.geometry:Xa(n,i,r),properties:n.properties,type:n.type,patterns:{}},h=this.layoutVertexArray.length;this.hasPattern?this.features.push(mc("fill-extrusion",this.layers,c,this.zoom,t)):this.addFeature(c,c.geometry,s,i,{},t.availableImages),t.featureIndex.insert(n,c.geometry,s,a,this.index,h);}this.sortBorders();}addFeatures(e,t,i,r){for(const e of this.features){const{geometry:n}=e;this.addFeature(e,n,e.index,t,i,r);}this.sortBorders();}update(e,t,i,r){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,t,this.stateDependentLayers,i,r);}isEmpty(){return 0===this.layoutVertexArray.length;}uploadPending(){return !this.uploaded||this.programConfigurations.needsUpload;}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,bc),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0;}uploadCentroid(e){0!==this.centroidVertexArray.length&&(this.centroidVertexBuffer?this.needsCentroidUpdate&&this.centroidVertexBuffer.updateData(this.centroidVertexArray):this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,vc.members,!0),this.needsCentroidUpdate=!1);}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy());}addFeature(e,t,i,r,n,o){const s=this.enableTerrain?new kc():null;for(const i of dc(t,500)){let t=0,r=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray);if(0===i.length||(a=i[0]).every(e=>e.x<=0)||a.every(e=>e.x>=Ca)||a.every(e=>e.y<=0)||a.every(e=>e.y>=Ca))continue;for(let e=0;e<i.length;e++){const n=i[e];if(0===n.length)continue;t+=n.length;let o=0;s&&s.startRing(n[0]);for(let e=0;e<n.length;e++){const t=n[e];if(e>=1){const i=n[e-1];if(!Rc(t,i)){s&&s.append(t,i),r.vertexLength+4>Ma.MAX_VERTEX_ARRAY_LENGTH&&(r=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray));const e=t.sub(i)._perp(),n=e.x/(Math.abs(e.x)+Math.abs(e.y)),a=e.y>0?1:0,l=i.dist(t);o+l>32768&&(o=0),Dc(this.layoutVertexArray,t.x,t.y,n,a,0,0,o),Dc(this.layoutVertexArray,t.x,t.y,n,a,0,1,o),o+=l,Dc(this.layoutVertexArray,i.x,i.y,n,a,0,0,o),Dc(this.layoutVertexArray,i.x,i.y,n,a,0,1,o);const c=r.vertexLength;this.indexArray.emplaceBack(c,c+2,c+1),this.indexArray.emplaceBack(c+1,c+2,c+3),r.vertexLength+=4,r.primitiveLength+=2;}}}}if(r.vertexLength+t>Ma.MAX_VERTEX_ARRAY_LENGTH&&(r=this.segments.prepareSegment(t,this.layoutVertexArray,this.indexArray)),"Polygon"!==Pc[e.type])continue;const n=[],o=[],l=r.vertexLength;for(let e=0;e<i.length;e++){const t=i[e];if(0!==t.length){t!==i[0]&&o.push(n.length/2);for(let e=0;e<t.length;e++){const i=t[e];Dc(this.layoutVertexArray,i.x,i.y,0,0,1,1,0),n.push(i.x),n.push(i.y),s&&s.currentPolyCount.top++;}}}const c=kl(n,o);for(let e=0;e<c.length;e+=3)this.indexArray.emplaceBack(l+c[e],l+c[e+2],l+c[e+1]);r.primitiveLength+=c.length/3,r.vertexLength+=t;}var a;if(s&&s.polyCount.length>0){if(s.borders){s.vertexArrayOffset=this.centroidVertexArray.length;const e=s.borders,t=this.featuresOnBorder.push(s)-1;for(let i=0;i<4;i++)e[i][0]!==Number.MAX_VALUE&&this.borders[i].push(t);}this.encodeCentroid(s.borders?void 0:s.centroid(),s);}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,i,n,o,r);}sortBorders(){for(let e=0;e<4;e++)this.borders[e].sort((t,i)=>this.featuresOnBorder[t].borders[e][0]-this.featuresOnBorder[i].borders[e][0]);}encodeCentroid(e,t,i=!0){let r,n;if(e){if(0!==e.y){const i=t.span()._mult(this.tileToMeter);r=(Math.max(e.x,1)<<3)+Math.min(7,Math.round(i.x/10)),n=(Math.max(e.y,1)<<3)+Math.min(7,Math.round(i.y/10));}else r=Math.ceil(7*(e.x+450)),n=0;}else r=0,n=+i;let o=i?this.centroidVertexArray.length:t.vertexArrayOffset;for(const e of t.polyCount){i&&this.centroidVertexArray.resize(this.centroidVertexArray.length+4*e.edges+e.top);for(let t=0;t<2*e.edges;t++)this.centroidVertexArray.emplace(o++,0,n),this.centroidVertexArray.emplace(o++,r,n);for(let t=0;t<e.top;t++)this.centroidVertexArray.emplace(o++,r,n);}}}function Rc(e,t){return e.x===t.x&&(e.x<0||e.x>Ca)||e.y===t.y&&(e.y<0||e.y>Ca);}qn("FillExtrusionBucket",zc,{omit:["layers","features"]}),qn("PartMetadata",kc);var Oc={paint:new ss({"fill-extrusion-opacity":new ts(xt["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new is(xt["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new ts(xt["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new ts(xt["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new rs(xt["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-height":new is(xt["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new is(xt["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-vertical-gradient":new ts(xt["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"])})};function Fc(e,t){return e.x*t.x+e.y*t.y;}function Bc(e,t){if(1===e.length){let i=0;const r=t[i++];let n;for(;!n||r.equals(n);)if(n=t[i++],!n)return 1/0;for(;i<t.length;i++){const o=t[i],s=e[0],a=n.sub(r),l=o.sub(r),c=s.sub(r),h=Fc(a,a),u=Fc(a,l),d=Fc(l,l),p=Fc(c,a),f=Fc(c,l),m=h*d-u*u,_=(d*p-u*f)/m,g=(h*f-u*p)/m,y=r.z*(1-_-g)+n.z*_+o.z*g;if(isFinite(y))return y;}return 1/0;}{let e=1/0;for(const i of t)e=Math.min(e,i.z);return e;}}function Uc(e){const t=new n(e[0],e[1]);return t.z=e[2],t;}function Vc(e,t,i,r,n,o,s,a){const l=s*n.getElevationAt(e,t,!0,!0),c=0!==o[0],h=c?0===o[1]?s*(o[0]/7-450):s*function(e,t,i){const r=Math.floor(t[0]/8),n=Math.floor(t[1]/8),o=10*(t[0]-8*r),s=10*(t[1]-8*n),a=e.getElevationAt(r,n,!0,!0),l=e.getMeterToDEM(i),c=Math.floor(.5*(o*l-1)),h=Math.floor(.5*(s*l-1)),u=e.tileCoordToPixel(r,n),d=2*c+1,p=2*h+1,f=function(e,t,i,r,n){return [e.getElevationAtPixel(t,i,!0),e.getElevationAtPixel(t+n,i,!0),e.getElevationAtPixel(t,i+n,!0),e.getElevationAtPixel(t+r,i+n,!0)];}(e,u.x-c,u.y-h,d,p),m=Math.abs(f[0]-f[1]),_=Math.abs(f[2]-f[3]),g=Math.abs(f[0]-f[2])+Math.abs(f[1]-f[3]),y=Math.min(.25,.5*l*(m+_)/d),x=Math.min(.25,.5*l*g/p);return a+Math.max(y*o,x*s);}(n,o,a):l;return {base:l+(0===i)?-1:i,top:c?Math.max(h+r,l+i+2):l+r};}const Gc=us([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),{members:jc}=Gc,$c=us([{name:"a_packed",components:3,type:"Float32"}]),{members:Hc}=$c,qc=Ac.VectorTileFeature.types,Zc=Math.cos(Math.PI/180*37.5);class Xc{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(e=>e.id),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach(e=>{this.gradients[e.id]={};}),this.layoutVertexArray=new ms(),this.layoutVertexArray2=new _s(),this.indexArray=new Es(),this.programConfigurations=new ya(e.layers,e.zoom),this.segments=new Ma(),this.maxLineLength=0,this.stateDependentLayerIds=this.layers.filter(e=>e.isStateDependent()).map(e=>e.id);}populate(e,t,i,r){this.hasPattern=fc("line",this.layers,t);const n=this.layers[0].layout.get("line-sort-key"),o=[];for(const{feature:t,id:s,index:a,sourceLayerIndex:l}of e){const e=this.layers[0]._featureFilter.needGeometry,c=Wa(t,e);if(!this.layers[0]._featureFilter.filter(new qo(this.zoom),c,i))continue;const h=n?n.evaluate(c,{},i):void 0,u={id:s,properties:t.properties,type:t.type,sourceLayerIndex:l,index:a,geometry:e?c.geometry:Xa(t,i,r),patterns:{},sortKey:h};o.push(u);}n&&o.sort((e,t)=>e.sortKey-t.sortKey);const{lineAtlas:s,featureIndex:a}=t,l=this.addConstantDashes(s);for(const r of o){const{geometry:n,index:o,sourceLayerIndex:c}=r;if(l&&this.addFeatureDashes(r,s),this.hasPattern){const e=mc("line",this.layers,r,this.zoom,t);this.patternFeatures.push(e);}else this.addFeature(r,n,o,i,s.positions,t.availableImages);a.insert(e[o].feature,n,o,c,this.index);}}addConstantDashes(e){let t=!1;for(const i of this.layers){const r=i.paint.get("line-dasharray").value,n=i.layout.get("line-cap").value;if("constant"!==r.kind||"constant"!==n.kind)t=!0;else {const t=n.value,i=r.value;if(!i)continue;e.addDash(i.from,t),e.addDash(i.to,t),i.other&&e.addDash(i.other,t);}}return t;}addFeatureDashes(e,t){const i=this.zoom;for(const r of this.layers){const n=r.paint.get("line-dasharray").value,o=r.layout.get("line-cap").value;if("constant"===n.kind&&"constant"===o.kind)continue;let s,a,l,c,h,u;if("constant"===n.kind){const e=n.value;if(!e)continue;s=e.other||e.to,a=e.to,l=e.from;}else s=n.evaluate({zoom:i-1},e),a=n.evaluate({zoom:i},e),l=n.evaluate({zoom:i+1},e);"constant"===o.kind?c=h=u=o.value:(c=o.evaluate({zoom:i-1},e),h=o.evaluate({zoom:i},e),u=o.evaluate({zoom:i+1},e)),t.addDash(s,c),t.addDash(a,h),t.addDash(l,u);const d=t.getKey(s,c),p=t.getKey(a,h),f=t.getKey(l,u);e.patterns[r.id]={min:d,mid:p,max:f};}}update(e,t,i,r){this.stateDependentLayers.length&&this.programConfigurations.updatePaintArrays(e,t,this.stateDependentLayers,i,r);}addFeatures(e,t,i,r){for(const e of this.patternFeatures)this.addFeature(e,e.geometry,e.index,t,i,r);}isEmpty(){return 0===this.layoutVertexArray.length;}uploadPending(){return !this.uploaded||this.programConfigurations.needsUpload;}upload(e){this.uploaded||(0!==this.layoutVertexArray2.length&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,Hc)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,jc),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0;}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy());}lineFeatureClips(e){if(e.properties&&e.properties.hasOwnProperty("mapbox_clip_start")&&e.properties.hasOwnProperty("mapbox_clip_end"))return {start:+e.properties.mapbox_clip_start,end:+e.properties.mapbox_clip_end};}addFeature(e,t,i,r,n,o){const s=this.layers[0].layout,a=s.get("line-join").evaluate(e,{}),l=s.get("line-cap").evaluate(e,{}),c=s.get("line-miter-limit"),h=s.get("line-round-limit");this.lineClips=this.lineFeatureClips(e);for(const i of t)this.addLine(i,e,a,l,c,h);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,i,n,o,r);}addLine(e,t,i,r,n,o){if(this.distance=0,this.scaledDistance=0,this.totalDistance=0,this.lineSoFar=0,this.lineClips){this.lineClipsArray.push(this.lineClips);for(let t=0;t<e.length-1;t++)this.totalDistance+=e[t].dist(e[t+1]);this.updateScaledDistance(),this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance);}const s="Polygon"===qc[t.type];let a=e.length;for(;a>=2&&e[a-1].equals(e[a-2]);)a--;let l=0;for(;l<a-1&&e[l].equals(e[l+1]);)l++;if(a<(s?3:2))return;"bevel"===i&&(n=1.05);const c=this.overscaling<=16?122880/(512*this.overscaling):0,h=this.segments.prepareSegment(10*a,this.layoutVertexArray,this.indexArray);let u,d,p,f,m;this.e1=this.e2=-1,s&&(u=e[a-2],m=e[l].sub(u)._unit()._perp());for(let t=l;t<a;t++){if(p=t===a-1?s?e[l+1]:void 0:e[t+1],p&&e[t].equals(p))continue;m&&(f=m),u&&(d=u),u=e[t],m=p?p.sub(u)._unit()._perp():f,f=f||m;let _=f.add(m);0===_.x&&0===_.y||_._unit();const g=f.x*m.x+f.y*m.y,y=_.x*m.x+_.y*m.y,x=0!==y?1/y:1/0,v=2*Math.sqrt(2-2*y),b=y<Zc&&d&&p,S=f.x*m.y-f.y*m.x>0;if(b&&t>l){const e=u.dist(d);if(e>2*c){const t=u.sub(u.sub(d)._mult(c/e)._round());this.updateDistance(d,t),this.addCurrentVertex(t,f,0,0,h),d=t;}}const w=d&&p;let T=w?i:s?"butt":r;if(w&&"round"===T&&(x<o?T="miter":x<=2&&(T="fakeround")),"miter"===T&&x>n&&(T="bevel"),"bevel"===T&&(x>2&&(T="flipbevel"),x<n&&(T="miter")),d&&this.updateDistance(d,u),"miter"===T)_._mult(x),this.addCurrentVertex(u,_,0,0,h);else if("flipbevel"===T){if(x>100)_=m.mult(-1);else {const e=x*f.add(m).mag()/f.sub(m).mag();_._perp()._mult(e*(S?-1:1));}this.addCurrentVertex(u,_,0,0,h),this.addCurrentVertex(u,_.mult(-1),0,0,h);}else if("bevel"===T||"fakeround"===T){const e=-Math.sqrt(x*x-1),t=S?e:0,i=S?0:e;if(d&&this.addCurrentVertex(u,f,t,i,h),"fakeround"===T){const e=Math.round(180*v/Math.PI/20);for(let t=1;t<e;t++){let i=t/e;if(.5!==i){const e=i-.5;i+=i*e*(i-1)*((1.0904+g*(g*(3.55645-1.43519*g)-3.2452))*e*e+(.848013+g*(.215638*g-1.06021)));}const r=m.sub(f)._mult(i)._add(f)._unit()._mult(S?-1:1);this.addHalfVertex(u,r.x,r.y,!1,S,0,h);}}p&&this.addCurrentVertex(u,m,-t,-i,h);}else if("butt"===T)this.addCurrentVertex(u,_,0,0,h);else if("square"===T){const e=d?1:-1;d||this.addCurrentVertex(u,_,e,e,h),this.addCurrentVertex(u,_,0,0,h),d&&this.addCurrentVertex(u,_,e,e,h);}else "round"===T&&(d&&(this.addCurrentVertex(u,f,0,0,h),this.addCurrentVertex(u,f,1,1,h,!0)),p&&(this.addCurrentVertex(u,m,-1,-1,h,!0),this.addCurrentVertex(u,m,0,0,h)));if(b&&t<a-1){const e=u.dist(p);if(e>2*c){const t=u.add(p.sub(u)._mult(c/e)._round());this.updateDistance(u,t),this.addCurrentVertex(t,m,0,0,h),u=t;}}}}addCurrentVertex(e,t,i,r,n,o=!1){const s=t.y*r-t.x,a=-t.y-t.x*r;this.addHalfVertex(e,t.x+t.y*i,t.y-t.x*i,o,!1,i,n),this.addHalfVertex(e,s,a,o,!0,-r,n);}addHalfVertex({x:e,y:t},i,r,n,o,s,a){this.layoutVertexArray.emplaceBack((e<<1)+(n?1:0),(t<<1)+(o?1:0),Math.round(63*i)+128,Math.round(63*r)+128,1+(0===s?0:s<0?-1:1),0,this.lineSoFar),this.lineClips&&this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,this.lineSoFar);const l=a.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,l),a.primitiveLength++),o?this.e2=l:this.e1=l;}updateScaledDistance(){if(this.lineClips){const e=this.totalDistance/(this.lineClips.end-this.lineClips.start);this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=e*this.lineClips.start+this.distance;}else this.lineSoFar=this.distance;}updateDistance(e,t){this.distance+=e.dist(t),this.updateScaledDistance();}}qn("LineBucket",Xc,{omit:["layers","patternFeatures"]});const Wc=new ss({"line-cap":new is(xt.layout_line["line-cap"]),"line-join":new is(xt.layout_line["line-join"]),"line-miter-limit":new ts(xt.layout_line["line-miter-limit"]),"line-round-limit":new ts(xt.layout_line["line-round-limit"]),"line-sort-key":new is(xt.layout_line["line-sort-key"])});var Yc={paint:new ss({"line-opacity":new is(xt.paint_line["line-opacity"]),"line-color":new is(xt.paint_line["line-color"]),"line-translate":new ts(xt.paint_line["line-translate"]),"line-translate-anchor":new ts(xt.paint_line["line-translate-anchor"]),"line-width":new is(xt.paint_line["line-width"]),"line-gap-width":new is(xt.paint_line["line-gap-width"]),"line-offset":new is(xt.paint_line["line-offset"]),"line-blur":new is(xt.paint_line["line-blur"]),"line-dasharray":new rs(xt.paint_line["line-dasharray"]),"line-pattern":new rs(xt.paint_line["line-pattern"]),"line-gradient":new os(xt.paint_line["line-gradient"])}),layout:Wc};const Jc=new class extends is{possiblyEvaluate(e,t){return t=new qo(Math.floor(t.zoom),{now:t.now,fadeDuration:t.fadeDuration,zoomHistory:t.zoomHistory,transition:t.transition}),super.possiblyEvaluate(e,t);}evaluate(e,t,i,r){return t=ee({},t,{zoom:Math.floor(t.zoom)}),super.evaluate(e,t,i,r);}}(Yc.paint.properties["line-width"].specification);function Kc(e,t){return t>0?t+2*e:e;}Jc.useIntegerZoom=!0;const Qc=us([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"},{name:"a_z_tile_anchor",components:4,type:"Int16"}],4),eh=us([{name:"a_projected_pos",components:3,type:"Float32"}],4);us([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const th=us([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"}]),ih=us([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"}]);us([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const rh=us([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),nh=us([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);us([{name:"triangle",components:3,type:"Uint16"}]),us([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),us([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"}]),us([{type:"Float32",name:"offsetX"}]),us([{type:"Int16",name:"x"},{type:"Int16",name:"y"},{type:"Int16",name:"tileUnitDistanceFromAnchor"}]);var oh=24;const sh=128;function ah(e,t){const{expression:i}=t;if("constant"===i.kind)return {kind:"constant",layoutSize:i.evaluate(new qo(e+1))};if("source"===i.kind)return {kind:"source"};{const{zoomStops:t,interpolationType:r}=i;let n=0;for(;n<t.length&&t[n]<=e;)n++;n=Math.max(0,n-1);let o=n;for(;o<t.length&&t[o]<e+1;)o++;o=Math.min(t.length-1,o);const s=t[n],a=t[o];return "composite"===i.kind?{kind:"composite",minZoom:s,maxZoom:a,interpolationType:r}:{kind:"camera",minZoom:s,maxZoom:a,minSize:i.evaluate(new qo(s)),maxSize:i.evaluate(new qo(a)),interpolationType:r};}}function lh(e,{uSize:t,uSizeT:i},{lowerSize:r,upperSize:n}){return "source"===e.kind?r/sh:"composite"===e.kind?Oi(r/sh,n/sh,i):t;}function ch(e,t){let i=0,r=0;if("constant"===e.kind)r=e.layoutSize;else if("source"!==e.kind){const{interpolationType:n,minZoom:o,maxZoom:s}=e,a=n?W(ir.interpolationFactor(n,t,o,s),0,1):0;"camera"===e.kind?r=Oi(e.minSize,e.maxSize,a):i=a;}return {uSizeT:i,uSize:r};}var hh=Object.freeze({__proto__:null,getSizeData:ah,evaluateSizeForFeature:lh,evaluateSizeForZoom:ch,SIZE_PACK_FACTOR:sh});function uh(e,t,i){return e.sections.forEach(e=>{e.text=function(e,t,i){const r=t.layout.get("text-transform").evaluate(i,{});return "uppercase"===r?e=e.toLocaleUpperCase():"lowercase"===r&&(e=e.toLocaleLowerCase()),Ho.applyArabicShaping&&(e=Ho.applyArabicShaping(e)),e;}(e.text,t,i);}),e;}const dh={"!":"ï¸","#":"ï¼",$:"ï¼","%":"ï¼","&":"ï¼","(":"ï¸µ",")":"ï¸¶","*":"ï¼","+":"ï¼",",":"ï¸","-":"ï¸²",".":"ã»","/":"ï¼",":":"ï¸",";":"ï¸","<":"ï¸¿","=":"ï¼",">":"ï¹","?":"ï¸","@":"ï¼ ","[":"ï¹","\\":"ï¼¼","]":"ï¹","^":"ï¼¾",_:"ï¸³","`":"ï½","{":"ï¸·","|":"â","}":"ï¸¸","~":"ï½","Â¢":"ï¿ ","Â£":"ï¿¡","Â¥":"ï¿¥","Â¦":"ï¿¤","Â¬":"ï¿¢","Â¯":"ï¿£","â":"ï¸²","â":"ï¸±","â":"ï¹","â":"ï¹","â":"ï¹","â":"ï¹","â¦":"ï¸","â§":"ã»","â©":"ï¿¦","ã":"ï¸","ã":"ï¸","ã":"ï¸¿","ã":"ï¹","ã":"ï¸½","ã":"ï¸¾","ã":"ï¹","ã":"ï¹","ã":"ï¹","ã":"ï¹","ã":"ï¸»","ã":"ï¸¼","ã":"ï¸¹","ã":"ï¸º","ã":"ï¸","ã":"ï¸","ï¼":"ï¸","ï¼":"ï¸µ","ï¼":"ï¸¶","ï¼":"ï¸","ï¼":"ï¸²","ï¼":"ã»","ï¼":"ï¸","ï¼":"ï¸","ï¼":"ï¸¿","ï¼":"ï¹","ï¼":"ï¸","ï¼»":"ï¹","ï¼½":"ï¹","ï¼¿":"ï¸³","ï½":"ï¸·","ï½":"â","ï½":"ï¸¸","ï½":"ï¸µ","ï½ ":"ï¸¶","ï½¡":"ï¸","ï½¢":"ï¹","ï½£":"ï¹"};function ph(e){return "ï¸¶"===e||"ï¹"===e||"ï¸¸"===e||"ï¹"===e||"ï¹"===e||"ï¸¾"===e||"ï¸¼"===e||"ï¸º"===e||"ï¸"===e||"ï¹"===e||"ï¸"===e||"ï¸"===e||"ï¸"===e||"ï½"===e||"ï¿£"===e||"ï¸"===e||"ï¸"===e;}function fh(e){return "ï¸µ"===e||"ï¹"===e||"ï¸·"===e||"ï¹"===e||"ï¹"===e||"ï¸½"===e||"ï¸»"===e||"ï¸¹"===e||"ï¸"===e||"ï¸¿"===e;}var mh=function(e,t,i,r,n){var o,s,a=8*n-r-1,l=(1<<a)-1,c=l>>1,h=-7,u=i?n-1:0,d=i?-1:1,p=e[t+u];for(u+=d,o=p&(1<<-h)-1,p>>=-h,h+=a;h>0;o=256*o+e[t+u],u+=d,h-=8);for(s=o&(1<<-h)-1,o>>=-h,h+=r;h>0;s=256*s+e[t+u],u+=d,h-=8);if(0===o)o=1-c;else {if(o===l)return s?NaN:1/0*(p?-1:1);s+=Math.pow(2,r),o-=c;}return (p?-1:1)*s*Math.pow(2,o-r);},_h=function(e,t,i,r,n,o){var s,a,l,c=8*o-n-1,h=(1<<c)-1,u=h>>1,d=23===n?Math.pow(2,-24)-Math.pow(2,-77):0,p=r?0:o-1,f=r?1:-1,m=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,s=h):(s=Math.floor(Math.log(t)/Math.LN2),t*(l=Math.pow(2,-s))<1&&(s--,l*=2),(t+=s+u>=1?d/l:d*Math.pow(2,1-u))*l>=2&&(s++,l/=2),s+u>=h?(a=0,s=h):s+u>=1?(a=(t*l-1)*Math.pow(2,n),s+=u):(a=t*Math.pow(2,u-1)*Math.pow(2,n),s=0));n>=8;e[i+p]=255&a,p+=f,a/=256,n-=8);for(s=s<<n|a,c+=n;c>0;e[i+p]=255&s,p+=f,s/=256,c-=8);e[i+p-f]|=128*m;},gh=yh;function yh(e){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(e)?e:new Uint8Array(e||0),this.pos=0,this.type=0,this.length=this.buf.length;}yh.Varint=0,yh.Fixed64=1,yh.Bytes=2,yh.Fixed32=5;var xh=4294967296,vh=1/xh,bh="undefined"==typeof TextDecoder?null:new TextDecoder("utf8");function Sh(e){return e.type===yh.Bytes?e.readVarint()+e.pos:e.pos+1;}function wh(e,t,i){return i?4294967296*t+(e>>>0):4294967296*(t>>>0)+(e>>>0);}function Th(e,t,i){var r=t<=16383?1:t<=2097151?2:t<=268435455?3:Math.floor(Math.log(t)/(7*Math.LN2));i.realloc(r);for(var n=i.pos-1;n>=e;n--)i.buf[n+r]=i.buf[n];}function Eh(e,t){for(var i=0;i<e.length;i++)t.writeVarint(e[i]);}function Nh(e,t){for(var i=0;i<e.length;i++)t.writeSVarint(e[i]);}function Ih(e,t){for(var i=0;i<e.length;i++)t.writeFloat(e[i]);}function Mh(e,t){for(var i=0;i<e.length;i++)t.writeDouble(e[i]);}function Ch(e,t){for(var i=0;i<e.length;i++)t.writeBoolean(e[i]);}function Ah(e,t){for(var i=0;i<e.length;i++)t.writeFixed32(e[i]);}function Ph(e,t){for(var i=0;i<e.length;i++)t.writeSFixed32(e[i]);}function Lh(e,t){for(var i=0;i<e.length;i++)t.writeFixed64(e[i]);}function Dh(e,t){for(var i=0;i<e.length;i++)t.writeSFixed64(e[i]);}function kh(e,t){return (e[t]|e[t+1]<<8|e[t+2]<<16)+16777216*e[t+3];}function zh(e,t,i){e[i]=t,e[i+1]=t>>>8,e[i+2]=t>>>16,e[i+3]=t>>>24;}function Rh(e,t){return (e[t]|e[t+1]<<8|e[t+2]<<16)+(e[t+3]<<24);}function Oh(e,t,i){t.glyphs=[],1===e&&i.readMessage(Fh,t);}function Fh(e,t,i){if(3===e){const{id:e,bitmap:r,width:n,height:o,left:s,top:a,advance:l}=i.readMessage(Bh,{});t.glyphs.push({id:e,bitmap:new Il({width:n+6,height:o+6},r),metrics:{width:n,height:o,left:s,top:a,advance:l}});}else 4===e?t.ascender=i.readSVarint():5===e&&(t.descender=i.readSVarint());}function Bh(e,t,i){1===e?t.id=i.readVarint():2===e?t.bitmap=i.readBytes():3===e?t.width=i.readVarint():4===e?t.height=i.readVarint():5===e?t.left=i.readSVarint():6===e?t.top=i.readSVarint():7===e&&(t.advance=i.readVarint());}function Uh(e){let t=0,i=0;for(const r of e)t+=r.w*r.h,i=Math.max(i,r.w);e.sort((e,t)=>t.h-e.h);const r=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(t/.95)),i),h:1/0}];let n=0,o=0;for(const t of e)for(let e=r.length-1;e>=0;e--){const i=r[e];if(!(t.w>i.w||t.h>i.h)){if(t.x=i.x,t.y=i.y,o=Math.max(o,t.y+t.h),n=Math.max(n,t.x+t.w),t.w===i.w&&t.h===i.h){const t=r.pop();e<r.length&&(r[e]=t);}else t.h===i.h?(i.x+=t.w,i.w-=t.w):t.w===i.w?(i.y+=t.h,i.h-=t.h):(r.push({x:i.x+t.w,y:i.y,w:i.w-t.w,h:t.h}),i.y+=t.h,i.h-=t.h);break;}}return {w:n,h:o,fill:t/(n*o)||0};}yh.prototype={destroy:function(){this.buf=null;},readFields:function(e,t,i){for(i=i||this.length;this.pos<i;){var r=this.readVarint(),n=r>>3,o=this.pos;this.type=7&r,e(n,t,this),this.pos===o&&this.skip(r);}return t;},readMessage:function(e,t){return this.readFields(e,t,this.readVarint()+this.pos);},readFixed32:function(){var e=kh(this.buf,this.pos);return this.pos+=4,e;},readSFixed32:function(){var e=Rh(this.buf,this.pos);return this.pos+=4,e;},readFixed64:function(){var e=kh(this.buf,this.pos)+kh(this.buf,this.pos+4)*xh;return this.pos+=8,e;},readSFixed64:function(){var e=kh(this.buf,this.pos)+Rh(this.buf,this.pos+4)*xh;return this.pos+=8,e;},readFloat:function(){var e=mh(this.buf,this.pos,!0,23,4);return this.pos+=4,e;},readDouble:function(){var e=mh(this.buf,this.pos,!0,52,8);return this.pos+=8,e;},readVarint:function(e){var t,i,r=this.buf;return t=127&(i=r[this.pos++]),i<128?t:(t|=(127&(i=r[this.pos++]))<<7,i<128?t:(t|=(127&(i=r[this.pos++]))<<14,i<128?t:(t|=(127&(i=r[this.pos++]))<<21,i<128?t:function(e,t,i){var r,n,o=i.buf;if(r=(112&(n=o[i.pos++]))>>4,n<128)return wh(e,r,t);if(r|=(127&(n=o[i.pos++]))<<3,n<128)return wh(e,r,t);if(r|=(127&(n=o[i.pos++]))<<10,n<128)return wh(e,r,t);if(r|=(127&(n=o[i.pos++]))<<17,n<128)return wh(e,r,t);if(r|=(127&(n=o[i.pos++]))<<24,n<128)return wh(e,r,t);if(r|=(1&(n=o[i.pos++]))<<31,n<128)return wh(e,r,t);throw new Error("Expected varint not more than 10 bytes");}(t|=(15&(i=r[this.pos]))<<28,e,this))));},readVarint64:function(){return this.readVarint(!0);},readSVarint:function(){var e=this.readVarint();return e%2==1?(e+1)/-2:e/2;},readBoolean:function(){return Boolean(this.readVarint());},readString:function(){var e=this.readVarint()+this.pos,t=this.pos;return this.pos=e,e-t>=12&&bh?function(e,t,i){return bh.decode(e.subarray(t,i));}(this.buf,t,e):function(e,t,i){for(var r="",n=t;n<i;){var o,s,a,l=e[n],c=null,h=l>239?4:l>223?3:l>191?2:1;if(n+h>i)break;1===h?l<128&&(c=l):2===h?128==(192&(o=e[n+1]))&&(c=(31&l)<<6|63&o)<=127&&(c=null):3===h?(s=e[n+2],128==(192&(o=e[n+1]))&&128==(192&s)&&((c=(15&l)<<12|(63&o)<<6|63&s)<=2047||c>=55296&&c<=57343)&&(c=null)):4===h&&(s=e[n+2],a=e[n+3],128==(192&(o=e[n+1]))&&128==(192&s)&&128==(192&a)&&((c=(15&l)<<18|(63&o)<<12|(63&s)<<6|63&a)<=65535||c>=1114112)&&(c=null)),null===c?(c=65533,h=1):c>65535&&(c-=65536,r+=String.fromCharCode(c>>>10&1023|55296),c=56320|1023&c),r+=String.fromCharCode(c),n+=h;}return r;}(this.buf,t,e);},readBytes:function(){var e=this.readVarint()+this.pos,t=this.buf.subarray(this.pos,e);return this.pos=e,t;},readPackedVarint:function(e,t){if(this.type!==yh.Bytes)return e.push(this.readVarint(t));var i=Sh(this);for(e=e||[];this.pos<i;)e.push(this.readVarint(t));return e;},readPackedSVarint:function(e){if(this.type!==yh.Bytes)return e.push(this.readSVarint());var t=Sh(this);for(e=e||[];this.pos<t;)e.push(this.readSVarint());return e;},readPackedBoolean:function(e){if(this.type!==yh.Bytes)return e.push(this.readBoolean());var t=Sh(this);for(e=e||[];this.pos<t;)e.push(this.readBoolean());return e;},readPackedFloat:function(e){if(this.type!==yh.Bytes)return e.push(this.readFloat());var t=Sh(this);for(e=e||[];this.pos<t;)e.push(this.readFloat());return e;},readPackedDouble:function(e){if(this.type!==yh.Bytes)return e.push(this.readDouble());var t=Sh(this);for(e=e||[];this.pos<t;)e.push(this.readDouble());return e;},readPackedFixed32:function(e){if(this.type!==yh.Bytes)return e.push(this.readFixed32());var t=Sh(this);for(e=e||[];this.pos<t;)e.push(this.readFixed32());return e;},readPackedSFixed32:function(e){if(this.type!==yh.Bytes)return e.push(this.readSFixed32());var t=Sh(this);for(e=e||[];this.pos<t;)e.push(this.readSFixed32());return e;},readPackedFixed64:function(e){if(this.type!==yh.Bytes)return e.push(this.readFixed64());var t=Sh(this);for(e=e||[];this.pos<t;)e.push(this.readFixed64());return e;},readPackedSFixed64:function(e){if(this.type!==yh.Bytes)return e.push(this.readSFixed64());var t=Sh(this);for(e=e||[];this.pos<t;)e.push(this.readSFixed64());return e;},skip:function(e){var t=7&e;if(t===yh.Varint)for(;this.buf[this.pos++]>127;);else if(t===yh.Bytes)this.pos=this.readVarint()+this.pos;else if(t===yh.Fixed32)this.pos+=4;else {if(t!==yh.Fixed64)throw new Error("Unimplemented type: "+t);this.pos+=8;}},writeTag:function(e,t){this.writeVarint(e<<3|t);},realloc:function(e){for(var t=this.length||16;t<this.pos+e;)t*=2;if(t!==this.length){var i=new Uint8Array(t);i.set(this.buf),this.buf=i,this.length=t;}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length);},writeFixed32:function(e){this.realloc(4),zh(this.buf,e,this.pos),this.pos+=4;},writeSFixed32:function(e){this.realloc(4),zh(this.buf,e,this.pos),this.pos+=4;},writeFixed64:function(e){this.realloc(8),zh(this.buf,-1&e,this.pos),zh(this.buf,Math.floor(e*vh),this.pos+4),this.pos+=8;},writeSFixed64:function(e){this.realloc(8),zh(this.buf,-1&e,this.pos),zh(this.buf,Math.floor(e*vh),this.pos+4),this.pos+=8;},writeVarint:function(e){(e=+e||0)>268435455||e<0?function(e,t){var i,r;if(e>=0?(i=e%4294967296|0,r=e/4294967296|0):(r=~(-e/4294967296),4294967295^(i=~(-e%4294967296))?i=i+1|0:(i=0,r=r+1|0)),e>=0x10000000000000000||e<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");t.realloc(10),function(e,t,i){i.buf[i.pos++]=127&e|128,e>>>=7,i.buf[i.pos++]=127&e|128,e>>>=7,i.buf[i.pos++]=127&e|128,e>>>=7,i.buf[i.pos++]=127&e|128,i.buf[i.pos]=127&(e>>>=7);}(i,0,t),function(e,t){var i=(7&e)<<4;t.buf[t.pos++]|=i|((e>>>=3)?128:0),e&&(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),e&&(t.buf[t.pos++]=127&e)))));}(r,t);}(e,this):(this.realloc(4),this.buf[this.pos++]=127&e|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=e>>>7&127))));},writeSVarint:function(e){this.writeVarint(e<0?2*-e-1:2*e);},writeBoolean:function(e){this.writeVarint(Boolean(e));},writeString:function(e){e=String(e),this.realloc(4*e.length),this.pos++;var t=this.pos;this.pos=function(e,t,i){for(var r,n,o=0;o<t.length;o++){if((r=t.charCodeAt(o))>55295&&r<57344){if(!n){r>56319||o+1===t.length?(e[i++]=239,e[i++]=191,e[i++]=189):n=r;continue;}if(r<56320){e[i++]=239,e[i++]=191,e[i++]=189,n=r;continue;}r=n-55296<<10|r-56320|65536,n=null;}else n&&(e[i++]=239,e[i++]=191,e[i++]=189,n=null);r<128?e[i++]=r:(r<2048?e[i++]=r>>6|192:(r<65536?e[i++]=r>>12|224:(e[i++]=r>>18|240,e[i++]=r>>12&63|128),e[i++]=r>>6&63|128),e[i++]=63&r|128);}return i;}(this.buf,e,this.pos);var i=this.pos-t;i>=128&&Th(t,i,this),this.pos=t-1,this.writeVarint(i),this.pos+=i;},writeFloat:function(e){this.realloc(4),_h(this.buf,e,this.pos,!0,23,4),this.pos+=4;},writeDouble:function(e){this.realloc(8),_h(this.buf,e,this.pos,!0,52,8),this.pos+=8;},writeBytes:function(e){var t=e.length;this.writeVarint(t),this.realloc(t);for(var i=0;i<t;i++)this.buf[this.pos++]=e[i];},writeRawMessage:function(e,t){this.pos++;var i=this.pos;e(t,this);var r=this.pos-i;r>=128&&Th(i,r,this),this.pos=i-1,this.writeVarint(r),this.pos+=r;},writeMessage:function(e,t,i){this.writeTag(e,yh.Bytes),this.writeRawMessage(t,i);},writePackedVarint:function(e,t){t.length&&this.writeMessage(e,Eh,t);},writePackedSVarint:function(e,t){t.length&&this.writeMessage(e,Nh,t);},writePackedBoolean:function(e,t){t.length&&this.writeMessage(e,Ch,t);},writePackedFloat:function(e,t){t.length&&this.writeMessage(e,Ih,t);},writePackedDouble:function(e,t){t.length&&this.writeMessage(e,Mh,t);},writePackedFixed32:function(e,t){t.length&&this.writeMessage(e,Ah,t);},writePackedSFixed32:function(e,t){t.length&&this.writeMessage(e,Ph,t);},writePackedFixed64:function(e,t){t.length&&this.writeMessage(e,Lh,t);},writePackedSFixed64:function(e,t){t.length&&this.writeMessage(e,Dh,t);},writeBytesField:function(e,t){this.writeTag(e,yh.Bytes),this.writeBytes(t);},writeFixed32Field:function(e,t){this.writeTag(e,yh.Fixed32),this.writeFixed32(t);},writeSFixed32Field:function(e,t){this.writeTag(e,yh.Fixed32),this.writeSFixed32(t);},writeFixed64Field:function(e,t){this.writeTag(e,yh.Fixed64),this.writeFixed64(t);},writeSFixed64Field:function(e,t){this.writeTag(e,yh.Fixed64),this.writeSFixed64(t);},writeVarintField:function(e,t){this.writeTag(e,yh.Varint),this.writeVarint(t);},writeSVarintField:function(e,t){this.writeTag(e,yh.Varint),this.writeSVarint(t);},writeStringField:function(e,t){this.writeTag(e,yh.Bytes),this.writeString(t);},writeFloatField:function(e,t){this.writeTag(e,yh.Fixed32),this.writeFloat(t);},writeDoubleField:function(e,t){this.writeTag(e,yh.Fixed64),this.writeDouble(t);},writeBooleanField:function(e,t){this.writeVarintField(e,Boolean(t));}};class Vh{constructor(e,{pixelRatio:t,version:i,stretchX:r,stretchY:n,content:o}){this.paddedRect=e,this.pixelRatio=t,this.stretchX=r,this.stretchY=n,this.content=o,this.version=i;}get tl(){return [this.paddedRect.x+1,this.paddedRect.y+1];}get br(){return [this.paddedRect.x+this.paddedRect.w-1,this.paddedRect.y+this.paddedRect.h-1];}get displaySize(){return [(this.paddedRect.w-2)/this.pixelRatio,(this.paddedRect.h-2)/this.pixelRatio];}}class Gh{constructor(e,t){const i={},r={};this.haveRenderCallbacks=[];const n=[];this.addImages(e,i,n),this.addImages(t,r,n);const{w:o,h:s}=Uh(n),a=new Ml({width:o||1,height:s||1});for(const t in e){const r=e[t],n=i[t].paddedRect;Ml.copy(r.data,a,{x:0,y:0},{x:n.x+1,y:n.y+1},r.data);}for(const e in t){const i=t[e],n=r[e].paddedRect,o=n.x+1,s=n.y+1,l=i.data.width,c=i.data.height;Ml.copy(i.data,a,{x:0,y:0},{x:o,y:s},i.data),Ml.copy(i.data,a,{x:0,y:c-1},{x:o,y:s-1},{width:l,height:1}),Ml.copy(i.data,a,{x:0,y:0},{x:o,y:s+c},{width:l,height:1}),Ml.copy(i.data,a,{x:l-1,y:0},{x:o-1,y:s},{width:1,height:c}),Ml.copy(i.data,a,{x:0,y:0},{x:o+l,y:s},{width:1,height:c});}this.image=a,this.iconPositions=i,this.patternPositions=r;}addImages(e,t,i){for(const r in e){const n=e[r],o={x:0,y:0,w:n.data.width+2,h:n.data.height+2};i.push(o),t[r]=new Vh(o,n),n.hasRenderCallback&&this.haveRenderCallbacks.push(r);}}patchUpdatedImages(e,t){e.dispatchRenderCallbacks(this.haveRenderCallbacks);for(const i in e.updatedImages)this.patchUpdatedImage(this.iconPositions[i],e.getImage(i),t),this.patchUpdatedImage(this.patternPositions[i],e.getImage(i),t);}patchUpdatedImage(e,t,i){if(!e||!t)return;if(e.version===t.version)return;e.version=t.version;const[r,n]=e.tl;i.update(t.data,void 0,{x:r,y:n});}}qn("ImagePosition",Vh),qn("ImageAtlas",Gh);const jh={horizontal:1,vertical:2,horizontalOnly:3};class $h{constructor(){this.scale=1,this.fontStack="",this.imageName=null;}static forText(e,t){const i=new $h();return i.scale=e||1,i.fontStack=t,i;}static forImage(e){const t=new $h();return t.imageName=e,t;}}class Hh{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null;}static fromFeature(e,t){const i=new Hh();for(let r=0;r<e.sections.length;r++){const n=e.sections[r];n.image?i.addImageSection(n):i.addTextSection(n,t);}return i;}length(){return this.text.length;}getSection(e){return this.sections[this.sectionIndex[e]];}getSections(){return this.sections;}getSectionIndex(e){return this.sectionIndex[e];}getCharCode(e){return this.text.charCodeAt(e);}verticalizePunctuation(e){this.text=function(e,t){let i="";for(let r=0;r<e.length;r++){const n=e.charCodeAt(r+1)||null,o=e.charCodeAt(r-1)||null;i+=!t&&(n&&Ao(n)&&!dh[e[r+1]]||o&&Ao(o)&&!dh[e[r-1]])||!dh[e[r]]?e[r]:dh[e[r]];}return i;}(this.text,e);}trim(){let e=0;for(let t=0;t<this.text.length&&Zh[this.text.charCodeAt(t)];t++)e++;let t=this.text.length;for(let i=this.text.length-1;i>=0&&i>=e&&Zh[this.text.charCodeAt(i)];i--)t--;this.text=this.text.substring(e,t),this.sectionIndex=this.sectionIndex.slice(e,t);}substring(e,t){const i=new Hh();return i.text=this.text.substring(e,t),i.sectionIndex=this.sectionIndex.slice(e,t),i.sections=this.sections,i;}toString(){return this.text;}getMaxScale(){return this.sectionIndex.reduce((e,t)=>Math.max(e,this.sections[t].scale),0);}addTextSection(e,t){this.text+=e.text,this.sections.push($h.forText(e.scale,e.fontStack||t));const i=this.sections.length-1;for(let t=0;t<e.text.length;++t)this.sectionIndex.push(i);}addImageSection(e){const t=e.image?e.image.name:"";if(0===t.length)return void de("Can't add FormattedSection with an empty image.");const i=this.getNextImageSectionCharCode();i?(this.text+=String.fromCharCode(i),this.sections.push($h.forImage(t)),this.sectionIndex.push(this.sections.length-1)):de("Reached maximum number of images 6401");}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID);}}function qh(e,t,i,r,n,o,s,a,l,c,h,u,d,p,f,m){const _=Hh.fromFeature(e,n);let g;u===jh.vertical&&_.verticalizePunctuation(d);const{processBidirectionalText:y,processStyledBidirectionalText:x}=Ho;if(y&&1===_.sections.length){g=[];const e=y(_.toString(),eu(_,c,o,t,r,p,f));for(const t of e){const e=new Hh();e.text=t,e.sections=_.sections;for(let i=0;i<t.length;i++)e.sectionIndex.push(0);g.push(e);}}else if(x){g=[];const e=x(_.text,_.sectionIndex,eu(_,c,o,t,r,p,f));for(const t of e){const e=new Hh();e.text=t[0],e.sectionIndex=t[1],e.sections=_.sections,g.push(e);}}else g=function(e,t){const i=[],r=e.text;let n=0;for(const r of t)i.push(e.substring(n,r)),n=r;return n<r.length&&i.push(e.substring(n,r.length)),i;}(_,eu(_,c,o,t,r,p,f));const v=[],b={positionedLines:v,text:_.toString(),top:h[1],bottom:h[1],left:h[0],right:h[0],writingMode:u,iconsInText:!1,verticalizable:!1,hasBaseline:!1};return function(e,t,i,r,n,o,s,a,l,c,h,u){let d=0,p=0,f=0;const m="right"===a?1:"left"===a?0:.5;let _=!1;for(const e of n){const i=e.getSections();for(const e of i){if(e.imageName)continue;const i=t[e.fontStack];if(i&&(_=void 0!==i.ascender&&void 0!==i.descender,!_))break;}if(!_)break;}let g=0;for(const s of n){s.trim();const n=s.getMaxScale(),a=(n-1)*oh,x={positionedGlyphs:[],lineOffset:0};e.positionedLines[g]=x;const v=x.positionedGlyphs;let b=0;if(!s.length()){p+=o,++g;continue;}let S=0,w=0;for(let o=0;o<s.length();o++){const a=s.getSection(o),f=s.getSectionIndex(o),m=s.getCharCode(o);let g=a.scale,x=null,T=null,E=null,N=oh,I=0;const M=!(l===jh.horizontal||!h&&!Co(m)||h&&(Zh[m]||(y=m,Kn(y)||Qn(y)||eo(y)||vo(y)||To(y))));if(a.imageName){const t=r[a.imageName];if(!t)continue;E=a.imageName,e.iconsInText=e.iconsInText||!0,T=t.paddedRect;const i=t.displaySize;g=g*oh/u,x={width:i[0],height:i[1],left:1,top:-3,advance:M?i[1]:i[0],localGlyph:!1},I=_?-x.height*g:n*oh-17-i[1]*g,N=x.advance;const o=(M?i[0]:i[1])*g-oh*n;o>0&&o>b&&(b=o);}else {const e=i[a.fontStack];if(!e)continue;e[m]&&(T=e[m]);const r=t[a.fontStack];if(!r)continue;const o=r.glyphs[m];if(!o)continue;if(x=o.metrics,N=8203!==m?oh:0,_){const e=void 0!==r.ascender?Math.abs(r.ascender):0,t=void 0!==r.descender?Math.abs(r.descender):0,i=(e+t)*g;S<i&&(S=i,w=(e-t)/2*g),I=-e*g;}else I=(n-g)*oh-17;}M?(e.verticalizable=!0,v.push({glyph:m,imageName:E,x:d,y:p+I,vertical:M,scale:g,localGlyph:x.localGlyph,fontStack:a.fontStack,sectionIndex:f,metrics:x,rect:T}),d+=N*g+c):(v.push({glyph:m,imageName:E,x:d,y:p+I,vertical:M,scale:g,localGlyph:x.localGlyph,fontStack:a.fontStack,sectionIndex:f,metrics:x,rect:T}),d+=x.advance*g+c);}0!==v.length&&(f=Math.max(d-c,f),_?iu(v,m,b,w,o*n/2):iu(v,m,b,0,o/2)),d=0;const T=o*n+b;x.lineOffset=Math.max(b,a),p+=T,++g;}var y;const x=p,{horizontalAlign:v,verticalAlign:b}=tu(s);((function(e,t,i,r,n,o){const s=(t-i)*n,a=-o*r;for(const t of e)for(const e of t.positionedGlyphs)e.x+=s,e.y+=a;}))(e.positionedLines,m,v,b,f,x),e.top+=-b*x,e.bottom=e.top+x,e.left+=-v*f,e.right=e.left+f,e.hasBaseline=_;}(b,t,i,r,g,s,a,l,u,c,d,m),!function(e){for(const t of e)if(0!==t.positionedGlyphs.length)return !1;return !0;}(v)&&b;}const Zh={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},Xh={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function Wh(e,t,i,r,n,o){if(t.imageName){const e=r[t.imageName];return e?e.displaySize[0]*t.scale*oh/o+n:0;}{const r=i[t.fontStack],o=r&&r.glyphs[e];return o?o.metrics.advance*t.scale+n:0;}}function Yh(e,t,i,r){const n=Math.pow(e-t,2);return r?e<t?n/2:2*n:n+Math.abs(i)*i;}function Jh(e,t,i){let r=0;return 10===e&&(r-=1e4),i&&(r+=150),40!==e&&65288!==e||(r+=50),41!==t&&65289!==t||(r+=50),r;}function Kh(e,t,i,r,n,o){let s=null,a=Yh(t,i,n,o);for(const e of r){const r=Yh(t-e.x,i,n,o)+e.badness;r<=a&&(s=e,a=r);}return {index:e,x:t,priorBreak:s,badness:a};}function Qh(e){return e?Qh(e.priorBreak).concat(e.index):[];}function eu(e,t,i,r,n,o,s){if("point"!==o)return [];if(!e)return [];const a=[],l=function(e,t,i,r,n,o){let s=0;for(let i=0;i<e.length();i++){const a=e.getSection(i);s+=Wh(e.getCharCode(i),a,r,n,t,o);}return s/Math.max(1,Math.ceil(s/i));}(e,t,i,r,n,s),c=e.text.indexOf("â")>=0;let h=0;for(let i=0;i<e.length();i++){const o=e.getSection(i),d=e.getCharCode(i);if(Zh[d]||(h+=Wh(d,o,r,n,t,s)),i<e.length()-1){const t=!((u=d)<11904||!(lo(u)||ao(u)||So(u)||xo(u)||po(u)||to(u)||co(u)||no(u)||fo(u)||mo(u)||uo(u)||Eo(u)||oo(u)||ro(u)||io(u)||ho(u)||so(u)||bo(u)||go(u)||_o(u)));(Xh[d]||t||o.imageName)&&a.push(Kh(i+1,h,l,a,Jh(d,e.getCharCode(i+1),t&&c),!1));}}var u;return Qh(Kh(e.length(),h,l,a,0,!0));}function tu(e){let t=.5,i=.5;switch(e){case"right":case"top-right":case"bottom-right":t=1;break;case"left":case"top-left":case"bottom-left":t=0;}switch(e){case"bottom":case"bottom-right":case"bottom-left":i=1;break;case"top":case"top-right":case"top-left":i=0;}return {horizontalAlign:t,verticalAlign:i};}function iu(e,t,i,r,n){if(!(t||i||r||n))return;const o=e.length-1,s=e[o],a=(s.x+s.metrics.advance*s.scale)*t;for(let t=0;t<=o;t++)e[t].x-=a,e[t].y+=i+r+n;}function ru(e,t,i){const{horizontalAlign:r,verticalAlign:n}=tu(i),o=t[0]-e.displaySize[0]*r,s=t[1]-e.displaySize[1]*n;return {image:e,top:s,bottom:s+e.displaySize[1],left:o,right:o+e.displaySize[0]};}function nu(e,t,i,r,n,o){const s=e.image;let a;if(s.content){const e=s.content,t=s.pixelRatio||1;a=[e[0]/t,e[1]/t,s.displaySize[0]-e[2]/t,s.displaySize[1]-e[3]/t];}const l=t.left*o,c=t.right*o;let h,u,d,p;"width"===i||"both"===i?(p=n[0]+l-r[3],u=n[0]+c+r[1]):(p=n[0]+(l+c-s.displaySize[0])/2,u=p+s.displaySize[0]);const f=t.top*o,m=t.bottom*o;return "height"===i||"both"===i?(h=n[1]+f-r[0],d=n[1]+m+r[2]):(h=n[1]+(f+m-s.displaySize[1])/2,d=h+s.displaySize[1]),{image:s,top:h,right:u,bottom:d,left:p,collisionPadding:a};}class ou extends n{constructor(e,t,i,r,n){super(e,t),this.angle=r,this.z=i,void 0!==n&&(this.segment=n);}clone(){return new ou(this.x,this.y,this.z,this.angle,this.segment);}}function su(e,t,i,r,n){if(void 0===t.segment)return !0;let o=t,s=t.segment+1,a=0;for(;a>-i/2;){if(s--,s<0)return !1;a-=e[s].dist(o),o=e[s];}a+=e[s].dist(e[s+1]),s++;const l=[];let c=0;for(;a<i/2;){const t=e[s],i=e[s+1];if(!i)return !1;let o=e[s-1].angleTo(t)-t.angleTo(i);for(o=Math.abs((o+3*Math.PI)%(2*Math.PI)-Math.PI),l.push({distance:a,angleDelta:o}),c+=o;a-l[0].distance>r;)c-=l.shift().angleDelta;if(c>n)return !1;s++,a+=t.dist(i);}return !0;}function au(e){let t=0;for(let i=0;i<e.length-1;i++)t+=e[i].dist(e[i+1]);return t;}function lu(e,t,i){return e?.6*t*i:0;}function cu(e,t){return Math.max(e?e.right-e.left:0,t?t.right-t.left:0);}function hu(e,t,i,r,n,o){const s=lu(i,n,o),a=cu(i,r)*o;let l=0;const c=au(e)/2;for(let i=0;i<e.length-1;i++){const r=e[i],n=e[i+1],o=r.dist(n);if(l+o>c){const h=(c-l)/o,u=Oi(r.x,n.x,h),d=Oi(r.y,n.y,h),p=new ou(u,d,0,n.angleTo(r),i);return !s||su(e,p,a,s,t)?p:void 0;}l+=o;}}function uu(e,t,i,r,n,o,s,a,l){const c=lu(r,o,s),h=cu(r,n),u=h*s,d=0===e[0].x||e[0].x===l||0===e[0].y||e[0].y===l;return t-u<t/4&&(t=u+t/4),du(e,d?t/2*a%t:(h/2+2*o)*s*a%t,t,c,i,u,d,!1,l);}function du(e,t,i,r,n,o,s,a,l){const c=o/2,h=au(e);let u=0,d=t-i,p=[];for(let t=0;t<e.length-1;t++){const s=e[t],a=e[t+1],f=s.dist(a),m=a.angleTo(s);for(;d+i<u+f;){d+=i;const _=(d-u)/f,g=Oi(s.x,a.x,_),y=Oi(s.y,a.y,_);if(g>=0&&g<l&&y>=0&&y<l&&d-c>=0&&d+c<=h){const i=new ou(g,y,0,m,t);i._round(),r&&!su(e,i,o,r,n)||p.push(i);}}u+=f;}return a||p.length||s||(p=du(e,u/2,i,r,n,o,s,!0,l)),p;}function pu(e,t,i,r,o){const s=[];for(let a=0;a<e.length;a++){const l=e[a];let c;for(let e=0;e<l.length-1;e++){let a=l[e],h=l[e+1];a.x<t&&h.x<t||(a.x<t?a=new n(t,a.y+(t-a.x)/(h.x-a.x)*(h.y-a.y))._round():h.x<t&&(h=new n(t,a.y+(t-a.x)/(h.x-a.x)*(h.y-a.y))._round()),a.y<i&&h.y<i||(a.y<i?a=new n(a.x+(i-a.y)/(h.y-a.y)*(h.x-a.x),i)._round():h.y<i&&(h=new n(a.x+(i-a.y)/(h.y-a.y)*(h.x-a.x),i)._round()),a.x>=r&&h.x>=r||(a.x>=r?a=new n(r,a.y+(r-a.x)/(h.x-a.x)*(h.y-a.y))._round():h.x>=r&&(h=new n(r,a.y+(r-a.x)/(h.x-a.x)*(h.y-a.y))._round()),a.y>=o&&h.y>=o||(a.y>=o?a=new n(a.x+(o-a.y)/(h.y-a.y)*(h.x-a.x),o)._round():h.y>=o&&(h=new n(a.x+(o-a.y)/(h.y-a.y)*(h.x-a.x),o)._round()),c&&a.equals(c[c.length-1])||(c=[a],s.push(c)),c.push(h)))));}}return s;}qn("Anchor",ou);const fu=1e20;function mu(e,t,i,r,n,o,s,a,l){for(let c=t;c<t+r;c++)_u(e,i*o+c,o,n,s,a,l);for(let c=i;c<i+n;c++)_u(e,c*o+t,1,r,s,a,l);}function _u(e,t,i,r,n,o,s){o[0]=0,s[0]=-fu,s[1]=fu,n[0]=e[t];for(let a=1,l=0,c=0;a<r;a++){n[a]=e[t+a*i];const r=a*a;do{const e=o[l];c=(n[a]-n[e]+r-e*e)/(a-e)/2;}while(c<=s[l]&&--l>-1);l++,o[l]=a,s[l]=c,s[l+1]=fu;}for(let a=0,l=0;a<r;a++){for(;s[l+1]<a;)l++;const r=o[l],c=a-r;e[t+a*i]=n[r]+c*c;}}const gu={none:0,ideographs:1,all:2};class yu{constructor(e,t,i){this.requestManager=e,this.localGlyphMode=t,this.localFontFamily=i,this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}};}setURL(e){this.url=e;}getGlyphs(e,t){const i=[];for(const t in e)for(const r of e[t])i.push({stack:t,id:r});K(i,({stack:e,id:t},i)=>{let r=this.entries[e];r||(r=this.entries[e]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let n=r.glyphs[t];if(void 0!==n)return void i(null,{stack:e,id:t,glyph:n});if(n=this._tinySDF(r,e,t),n)return r.glyphs[t]=n,void i(null,{stack:e,id:t,glyph:n});const o=Math.floor(t/256);if(256*o>65535)return void i(new Error("glyphs > 65535 not supported"));if(r.ranges[o])return void i(null,{stack:e,id:t,glyph:n});let s=r.requests[o];s||(s=r.requests[o]=[],yu.loadGlyphRange(e,o,this.url,this.requestManager,(e,t)=>{if(t){r.ascender=t.ascender,r.descender=t.descender;for(const e in t.glyphs)this._doesCharSupportLocalGlyph(+e)||(r.glyphs[+e]=t.glyphs[+e]);r.ranges[o]=!0;}for(const i of s)i(e,t);delete r.requests[o];})),s.push((r,n)=>{r?i(r):n&&i(null,{stack:e,id:t,glyph:n.glyphs[t]||null});});},(e,i)=>{if(e)t(e);else if(i){const e={};for(const{stack:t,id:r,glyph:n}of i)void 0===e[t]&&(e[t]={}),void 0===e[t].glyphs&&(e[t].glyphs={}),e[t].glyphs[r]=n&&{id:n.id,bitmap:n.bitmap.clone(),metrics:n.metrics},e[t].ascender=this.entries[t].ascender,e[t].descender=this.entries[t].descender;t(null,e);}});}_doesCharSupportLocalGlyph(e){return this.localGlyphMode!==gu.none&&(this.localGlyphMode===gu.all?!!this.localFontFamily:!!this.localFontFamily&&(mo(e)||yo(e)||oo(e)||so(e))||no(e));}_tinySDF(e,t,i){const r=this.localFontFamily;if(!r||!this._doesCharSupportLocalGlyph(i))return;let n=e.tinySDF;if(!n){let i="400";/bold/i.test(t)?i="900":/medium/i.test(t)?i="500":/light/i.test(t)&&(i="200"),n=e.tinySDF=new yu.TinySDF({fontFamily:r,fontWeight:i,fontSize:48,buffer:6,radius:16}),n.fontWeight=i;}if(this.localGlyphs[n.fontWeight][i])return this.localGlyphs[n.fontWeight][i];const o=String.fromCharCode(i),{data:s,width:a,height:l,glyphWidth:c,glyphHeight:h,glyphLeft:u,glyphTop:d,glyphAdvance:p}=n.draw(o);return this.localGlyphs[n.fontWeight][i]={id:i,bitmap:new Il({width:a,height:l},s),metrics:{width:c/2,height:h/2,left:u/2,top:d/2-27,advance:p/2,localGlyph:!0}};}}function xu(e,t,i,r){const o=[],s=e.image,a=s.pixelRatio,l=s.paddedRect.w-2,c=s.paddedRect.h-2,h=e.right-e.left,u=e.bottom-e.top,d=s.stretchX||[[0,l]],p=s.stretchY||[[0,c]],f=(e,t)=>e+t[1]-t[0],m=d.reduce(f,0),_=p.reduce(f,0),g=l-m,y=c-_;let x=0,v=m,b=0,S=_,w=0,T=g,E=0,N=y;if(s.content&&r){const e=s.content;x=vu(d,0,e[0]),b=vu(p,0,e[1]),v=vu(d,e[0],e[2]),S=vu(p,e[1],e[3]),w=e[0]-x,E=e[1]-b,T=e[2]-e[0]-v,N=e[3]-e[1]-S;}const I=(r,o,l,c)=>{const d=Su(r.stretch-x,v,h,e.left),p=wu(r.fixed-w,T,r.stretch,m),f=Su(o.stretch-b,S,u,e.top),g=wu(o.fixed-E,N,o.stretch,_),y=Su(l.stretch-x,v,h,e.left),I=wu(l.fixed-w,T,l.stretch,m),M=Su(c.stretch-b,S,u,e.top),C=wu(c.fixed-E,N,c.stretch,_),A=new n(d,f),P=new n(y,f),L=new n(y,M),D=new n(d,M),k=new n(p/a,g/a),z=new n(I/a,C/a),R=t*Math.PI/180;if(R){const e=Math.sin(R),t=Math.cos(R),i=[t,-e,e,t];A._matMult(i),P._matMult(i),D._matMult(i),L._matMult(i);}const O=r.stretch+r.fixed,F=o.stretch+o.fixed;return {tl:A,tr:P,bl:D,br:L,tex:{x:s.paddedRect.x+1+O,y:s.paddedRect.y+1+F,w:l.stretch+l.fixed-O,h:c.stretch+c.fixed-F},writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:k,pixelOffsetBR:z,minFontScaleX:T/a/h,minFontScaleY:N/a/u,isSDF:i};};if(r&&(s.stretchX||s.stretchY)){const e=bu(d,g,m),t=bu(p,y,_);for(let i=0;i<e.length-1;i++){const r=e[i],n=e[i+1];for(let e=0;e<t.length-1;e++)o.push(I(r,t[e],n,t[e+1]));}}else o.push(I({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:l+1},{fixed:0,stretch:c+1}));return o;}function vu(e,t,i){let r=0;for(const n of e)r+=Math.max(t,Math.min(i,n[1]))-Math.max(t,Math.min(i,n[0]));return r;}function bu(e,t,i){const r=[{fixed:-1,stretch:0}];for(const[t,i]of e){const e=r[r.length-1];r.push({fixed:t-e.stretch,stretch:e.stretch}),r.push({fixed:t-e.stretch,stretch:e.stretch+(i-t)});}return r.push({fixed:t+1,stretch:i}),r;}function Su(e,t,i,r){return e/t*i+r;}function wu(e,t,i,r){return e-t*i/r;}function Tu(e,t,i,r){const n=t+e.positionedLines[r].lineOffset;return 0===r?i+n/2:i+(n+(t+e.positionedLines[r-1].lineOffset))/2;}yu.loadGlyphRange=function(e,t,i,r,n){const o=256*t,s=o+255,a=r.transformRequest(r.normalizeGlyphsURL(i).replace("{fontstack}",e).replace("{range}",`${o}-${s}`),it.Glyphs);st(a,(e,t)=>{if(e)n(e);else if(t){const e={},i=function(e){return new gh(e).readFields(Oh,{});}(t);for(const t of i.glyphs)e[t.id]=t;n(null,{glyphs:e,ascender:i.ascender,descender:i.descender});}});},yu.TinySDF=class{constructor({fontSize:e=24,buffer:t=3,radius:i=8,cutoff:r=.25,fontFamily:n="sans-serif",fontWeight:o="normal",fontStyle:s="normal"}){this.buffer=t,this.cutoff=r,this.radius=i;const a=this.size=e+4*t,l=this._createCanvas(a),c=this.ctx=l.getContext("2d",{willReadFrequently:!0});c.font=`${s} ${o} ${e}px ${n}`,c.textBaseline="alphabetic",c.textAlign="left",c.fillStyle="black",this.gridOuter=new Float64Array(a*a),this.gridInner=new Float64Array(a*a),this.f=new Float64Array(a),this.z=new Float64Array(a+1),this.v=new Uint16Array(a);}_createCanvas(e){const t=document.createElement("canvas");return t.width=t.height=e,t;}draw(e){const{width:t,actualBoundingBoxAscent:i,actualBoundingBoxDescent:r,actualBoundingBoxLeft:n,actualBoundingBoxRight:o}=this.ctx.measureText(e),s=Math.floor(i),a=Math.min(this.size-this.buffer,Math.ceil(o-n)),l=Math.min(this.size-this.buffer,Math.ceil(i)+Math.ceil(r)),c=a+2*this.buffer,h=l+2*this.buffer,u=c*h,d=new Uint8ClampedArray(u),p={data:d,width:c,height:h,glyphWidth:a,glyphHeight:l,glyphTop:s,glyphLeft:0,glyphAdvance:t};if(0===a||0===l)return p;const{ctx:f,buffer:m,gridInner:_,gridOuter:g}=this;f.clearRect(m,m,a,l),f.fillText(e,m,m+s+1);const y=f.getImageData(m,m,a,l);g.fill(fu,0,u),_.fill(0,0,u);for(let e=0;e<l;e++)for(let t=0;t<a;t++){const i=y.data[4*(e*a+t)+3]/255;if(0===i)continue;const r=(e+m)*c+t+m;if(1===i)g[r]=0,_[r]=fu;else {const e=.5-i;g[r]=e>0?e*e:0,_[r]=e<0?e*e:0;}}mu(g,0,0,c,h,c,this.f,this.v,this.z),mu(_,m,m,a,l,c,this.f,this.v,this.z);for(let e=0;e<u;e++){const t=Math.sqrt(g[e])-Math.sqrt(_[e]);d[e]=Math.round(255-255*(t/this.radius+this.cutoff));}return p;}};class Eu{constructor(e=[],t=Nu){if(this.data=e,this.length=this.data.length,this.compare=t,this.length>0)for(let e=(this.length>>1)-1;e>=0;e--)this._down(e);}push(e){this.data.push(e),this.length++,this._up(this.length-1);}pop(){if(0===this.length)return;const e=this.data[0],t=this.data.pop();return this.length--,this.length>0&&(this.data[0]=t,this._down(0)),e;}peek(){return this.data[0];}_up(e){const{data:t,compare:i}=this,r=t[e];for(;e>0;){const n=e-1>>1,o=t[n];if(i(r,o)>=0)break;t[e]=o,e=n;}t[e]=r;}_down(e){const{data:t,compare:i}=this,r=this.length>>1,n=t[e];for(;e<r;){let r=1+(e<<1),o=t[r];const s=r+1;if(s<this.length&&i(t[s],o)<0&&(r=s,o=t[s]),i(o,n)>=0)break;t[e]=o,e=r;}t[e]=n;}}function Nu(e,t){return e<t?-1:e>t?1:0;}function Iu(e,t=1,i=!1){let r=1/0,o=1/0,s=-1/0,a=-1/0;const l=e[0];for(let e=0;e<l.length;e++){const t=l[e];(!e||t.x<r)&&(r=t.x),(!e||t.y<o)&&(o=t.y),(!e||t.x>s)&&(s=t.x),(!e||t.y>a)&&(a=t.y);}const c=Math.min(s-r,a-o);let h=c/2;const u=new Eu([],Mu);if(0===c)return new n(r,o);for(let t=r;t<s;t+=c)for(let i=o;i<a;i+=c)u.push(new Cu(t+h,i+h,h,e));let d=function(e){let t=0,i=0,r=0;const n=e[0];for(let e=0,o=n.length,s=o-1;e<o;s=e++){const o=n[e],a=n[s],l=o.x*a.y-a.x*o.y;i+=(o.x+a.x)*l,r+=(o.y+a.y)*l,t+=3*l;}return new Cu(i/t,r/t,0,e);}(e),p=u.length;for(;u.length;){const r=u.pop();(r.d>d.d||!d.d)&&(d=r,i&&console.log("found best %d after %d probes",Math.round(1e4*r.d)/1e4,p)),r.max-d.d<=t||(h=r.h/2,u.push(new Cu(r.p.x-h,r.p.y-h,h,e)),u.push(new Cu(r.p.x+h,r.p.y-h,h,e)),u.push(new Cu(r.p.x-h,r.p.y+h,h,e)),u.push(new Cu(r.p.x+h,r.p.y+h,h,e)),p+=4);}return i&&(console.log(`num probes: ${p}`),console.log(`best distance: ${d.d}`)),d.p;}function Mu(e,t){return t.max-e.max;}function Cu(e,t,i,r){this.p=new n(e,t),this.h=i,this.d=function(e,t){let i=!1,r=1/0;for(let n=0;n<t.length;n++){const o=t[n];for(let t=0,n=o.length,s=n-1;t<n;s=t++){const n=o[t],a=o[s];n.y>e.y!=a.y>e.y&&e.x<(a.x-n.x)*(e.y-n.y)/(a.y-n.y)+n.x&&(i=!i),r=Math.min(r,ol(e,n,a));}}return (i?1:-1)*Math.sqrt(r);}(this.p,r),this.max=this.d+this.h*Math.SQRT2;}const Au=Number.POSITIVE_INFINITY,Pu=Math.sqrt(2);function Lu(e,t){return t[1]!==Au?function(e,t,i){let r=0,n=0;switch(t=Math.abs(t),i=Math.abs(i),e){case"top-right":case"top-left":case"top":n=i-7;break;case"bottom-right":case"bottom-left":case"bottom":n=7-i;}switch(e){case"top-right":case"bottom-right":case"right":r=-t;break;case"top-left":case"bottom-left":case"left":r=t;}return [r,n];}(e,t[0],t[1]):function(e,t){let i=0,r=0;t<0&&(t=0);const n=t/Pu;switch(e){case"top-right":case"top-left":r=n-7;break;case"bottom-right":case"bottom-left":r=7-n;break;case"bottom":r=7-t;break;case"top":r=t-7;}switch(e){case"top-right":case"bottom-right":i=-n;break;case"top-left":case"bottom-left":i=n;break;case"left":i=t;break;case"right":i=-t;}return [i,r];}(e,t[0]);}function Du(e,t,i,r,n,o,s,a,l,c){e.createArrays(),e.tilePixelRatio=Ca/(512*e.overscaling),e.compareText={},e.iconsNeedLinear=!1;const h=e.layers[0].layout,u=e.layers[0]._unevaluatedLayout._values,d={};if("composite"===e.textSizeData.kind){const{minZoom:t,maxZoom:i}=e.textSizeData;d.compositeTextSizes=[u["text-size"].possiblyEvaluate(new qo(t),a),u["text-size"].possiblyEvaluate(new qo(i),a)];}if("composite"===e.iconSizeData.kind){const{minZoom:t,maxZoom:i}=e.iconSizeData;d.compositeIconSizes=[u["icon-size"].possiblyEvaluate(new qo(t),a),u["icon-size"].possiblyEvaluate(new qo(i),a)];}d.layoutTextSize=u["text-size"].possiblyEvaluate(new qo(l+1),a),d.layoutIconSize=u["icon-size"].possiblyEvaluate(new qo(l+1),a),d.textMaxSize=u["text-size"].possiblyEvaluate(new qo(18),a);const p="map"===h.get("text-rotation-alignment")&&"point"!==h.get("symbol-placement"),f=h.get("text-size");for(const o of e.features){const l=h.get("text-font").evaluate(o,{},a).join(","),u=f.evaluate(o,{},a),m=d.layoutTextSize.evaluate(o,{},a),_=(d.layoutIconSize.evaluate(o,{},a),{horizontal:{},vertical:void 0}),g=o.text;let y,x=[0,0];if(g){const r=g.toString(),s=h.get("text-letter-spacing").evaluate(o,{},a)*oh,c=h.get("text-line-height").evaluate(o,{},a)*oh,d=Io(r)?s:0,f=h.get("text-anchor").evaluate(o,{},a),y=h.get("text-variable-anchor");if(!y){const e=h.get("text-radial-offset").evaluate(o,{},a);x=e?Lu(f,[e*oh,Au]):h.get("text-offset").evaluate(o,{},a).map(e=>e*oh);}let v=p?"center":h.get("text-justify").evaluate(o,{},a);const b=h.get("symbol-placement"),S="point"===b,w="point"===b?h.get("text-max-width").evaluate(o,{},a)*oh:0,T=o=>{e.allowVerticalPlacement&&No(r)&&(_.vertical=qh(g,t,i,n,l,w,c,f,o,d,x,jh.vertical,!0,b,m,u));};if(!p&&y){const e="auto"===v?y.map(e=>ku(e)):[v];let r=!1;for(let o=0;o<e.length;o++){const s=e[o];if(!_.horizontal[s])if(r)_.horizontal[s]=_.horizontal[0];else {const e=qh(g,t,i,n,l,w,c,"center",s,d,x,jh.horizontal,!1,b,m,u);e&&(_.horizontal[s]=e,r=1===e.positionedLines.length);}}T("left");}else {if("auto"===v&&(v=ku(f)),S||h.get("text-writing-mode").indexOf("horizontal")>=0||!No(r)){const e=qh(g,t,i,n,l,w,c,f,v,d,x,jh.horizontal,!1,b,m,u);e&&(_.horizontal[v]=e);}T("point"===b?"left":v);}}let v=!1;if(o.icon&&o.icon.name){const t=r[o.icon.name];t&&(y=ru(n[o.icon.name],h.get("icon-offset").evaluate(o,{},a),h.get("icon-anchor").evaluate(o,{},a)),v=t.sdf,void 0===e.sdfIcons?e.sdfIcons=t.sdf:e.sdfIcons!==t.sdf&&de("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(t.pixelRatio!==e.pixelRatio||0!==h.get("icon-rotate").constantOr(1))&&(e.iconsNeedLinear=!0));}const b=Fu(_.horizontal)||_.vertical;e.iconsInText||(e.iconsInText=!!b&&b.iconsInText),(b||y)&&zu(e,o,_,y,r,d,m,0,x,v,s,a,c);}o&&e.generateCollisionDebugBuffers(l,e.collisionBoxArray);}function ku(e){switch(e){case"right":case"top-right":case"bottom-right":return "right";case"left":case"top-left":case"bottom-left":return "left";}return "center";}function zu(e,t,i,r,n,o,s,a,l,c,h,u,d){let p=o.textMaxSize.evaluate(t,{},u);void 0===p&&(p=s);const f=e.layers[0].layout,m=f.get("icon-offset").evaluate(t,{},u),_=Fu(i.horizontal)||i.vertical,g=s/24,y=e.tilePixelRatio*p/24,x=e.tilePixelRatio*f.get("symbol-spacing"),v=f.get("text-padding")*e.tilePixelRatio,b=f.get("icon-padding")*e.tilePixelRatio,S=j(f.get("text-max-angle")),w="map"===f.get("text-rotation-alignment")&&"point"!==f.get("symbol-placement"),T="map"===f.get("icon-rotation-alignment")&&"point"!==f.get("symbol-placement"),E=f.get("symbol-placement"),N=x/2,I=f.get("icon-text-fit");let M;r&&"none"!==I&&(e.allowVerticalPlacement&&i.vertical&&(M=nu(r,i.vertical,I,f.get("icon-text-fit-padding"),m,g)),_&&(r=nu(r,_,I,f.get("icon-text-fit-padding"),m,g)));const C=(s,a,p)=>{if(a.x<0||a.x>=Ca||a.y<0||a.y>=Ca)return;const{x:f,y:_,z:g}=d.projectTilePoint(a.x,a.y,p),y=new ou(f,_,g,0,void 0);!function(e,t,i,r,n,o,s,a,l,c,h,u,d,p,f,m,_,g,y,x,v,b,S,w,T){const E=e.addToLineVertexArray(t,r);let N,I,M,C,A,P,L,D=0,k=0,z=0,R=0,O=-1,F=-1;const B={};let U=Ks(""),V=0,G=0;if(void 0===l._unevaluatedLayout.getValue("text-radial-offset")?[V,G]=l.layout.get("text-offset").evaluate(v,{},T).map(e=>e*oh):(V=l.layout.get("text-radial-offset").evaluate(v,{},T)*oh,G=Au),e.allowVerticalPlacement&&n.vertical){const e=n.vertical;if(f)P=Uu(e),a&&(L=Uu(a));else {const r=l.layout.get("text-rotate").evaluate(v,{},T)+90;M=Bu(c,i,t,h,u,d,e,p,r,m),a&&(C=Bu(c,i,t,h,u,d,a,g,r));}}if(o){const r=l.layout.get("icon-rotate").evaluate(v,{},T),n="none"!==l.layout.get("icon-text-fit"),s=xu(o,r,S,n),p=a?xu(a,r,S,n):void 0;I=Bu(c,i,t,h,u,d,o,g,r),D=4*s.length;const f=e.iconSizeData;let m=null;"source"===f.kind?(m=[sh*l.layout.get("icon-size").evaluate(v,{},T)],m[0]>Ru&&de(`${e.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)):"composite"===f.kind&&(m=[sh*b.compositeIconSizes[0].evaluate(v,{},T),sh*b.compositeIconSizes[1].evaluate(v,{},T)],(m[0]>Ru||m[1]>Ru)&&de(`${e.layerIds[0]}: Value for "icon-size" is >= 255. Reduce your "icon-size".`)),e.addSymbols(e.icon,s,m,x,y,v,!1,i,t,E.lineStartIndex,E.lineLength,-1,w,T),O=e.icon.placedSymbolArray.length-1,p&&(k=4*p.length,e.addSymbols(e.icon,p,m,x,y,v,jh.vertical,i,t,E.lineStartIndex,E.lineLength,-1,w,T),F=e.icon.placedSymbolArray.length-1);}for(const r in n.horizontal){const o=n.horizontal[r];N||(U=Ks(o.text),f?A=Uu(o):N=Bu(c,i,t,h,u,d,o,p,l.layout.get("text-rotate").evaluate(v,{},T),m));const a=1===o.positionedLines.length;if(z+=Ou(e,i,t,o,s,l,f,v,m,E,n.vertical?jh.horizontal:jh.horizontalOnly,a?Object.keys(n.horizontal):[r],B,O,b,w,T),a)break;}n.vertical&&(R+=Ou(e,i,t,n.vertical,s,l,f,v,m,E,jh.vertical,["vertical"],B,F,b,w,T));let j=-1;const $=(e,t)=>e?Math.max(e,t):t;j=$(A,j),j=$(P,j),j=$(L,j);const H=j>-1?1:0;e.glyphOffsetArray.length>=Wu.MAX_GLYPHS&&de("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),void 0!==v.sortKey&&e.addToSortKeyRanges(e.symbolInstances.length,v.sortKey),e.symbolInstances.emplaceBack(i.x,i.y,i.z,t.x,t.y,B.right>=0?B.right:-1,B.center>=0?B.center:-1,B.left>=0?B.left:-1,B.vertical>=0?B.vertical:-1,O,F,U,void 0!==N?N:e.collisionBoxArray.length,void 0!==N?N+1:e.collisionBoxArray.length,void 0!==M?M:e.collisionBoxArray.length,void 0!==M?M+1:e.collisionBoxArray.length,void 0!==I?I:e.collisionBoxArray.length,void 0!==I?I+1:e.collisionBoxArray.length,C||e.collisionBoxArray.length,C?C+1:e.collisionBoxArray.length,h,z,R,D,k,H,0,V,G,j);}(e,a,y,s,i,r,n,M,e.layers[0],e.collisionBoxArray,t.index,t.sourceLayerIndex,e.index,v,w,l,0,b,T,m,t,o,c,h,u);};if("line"===E)for(const n of pu(t.geometry,0,0,Ca,Ca)){const t=uu(n,x,S,i.vertical||_,r,24,y,e.overscaling,Ca);for(const i of t){const t=_;t&&Vu(e,t.text,N,i)||C(n,i,u);}}else if("line-center"===E){for(const e of t.geometry)if(e.length>1){const t=hu(e,S,i.vertical||_,r,24,y);t&&C(e,t,u);}}else if("Polygon"===t.type)for(const e of dc(t.geometry,0)){const t=Iu(e,16);C(e[0],new ou(t.x,t.y,0,0,void 0),u);}else if("LineString"===t.type)for(const e of t.geometry)C(e,new ou(e[0].x,e[0].y,0,0,void 0),u);else if("Point"===t.type)for(const e of t.geometry)for(const t of e)C([t],new ou(t.x,t.y,0,0,void 0),u);}const Ru=32640;function Ou(e,t,i,r,o,s,a,l,c,h,u,d,p,f,m,_,g){const y=function(e,t,i,r,o,s,a,l){const c=[];if(0===t.positionedLines.length)return c;const h=r.layout.get("text-rotate").evaluate(s,{})*Math.PI/180,u=function(e){const t=e[0],i=e[1],r=t*i;return r>0?[t,-i]:r<0?[-t,i]:0===t?[i,t]:[i,-t];}(i);let d=Math.abs(t.top-t.bottom);for(const e of t.positionedLines)d-=e.lineOffset;const p=t.positionedLines.length,f=d/p;let m=t.top-i[1];for(let e=0;e<p;++e){const r=t.positionedLines[e];m=Tu(t,f,m,e);for(const e of r.positionedGlyphs){if(!e.rect)continue;const r=e.rect||{};let s=4,d=!0,p=1,f=0;if(e.imageName){const t=a[e.imageName];if(!t)continue;if(t.sdf){de("SDF images are not supported in formatted text and will be ignored.");continue;}d=!1,p=t.pixelRatio,s=1/p;}const _=(o||l)&&e.vertical,g=e.metrics.advance*e.scale/2,y=e.metrics,x=e.rect;if(null===x)continue;l&&t.verticalizable&&(f=e.imageName?g-e.metrics.width*e.scale/2:0);const v=o?[e.x+g,e.y]:[0,0];let b=[0,0],S=[0,0],w=!1;o||(_?(S=[e.x+g+u[0],e.y+u[1]-f],w=!0):b=[e.x+g+i[0],e.y+i[1]-f]);const T=x.w*e.scale/(p*(e.localGlyph?2:1)),E=x.h*e.scale/(p*(e.localGlyph?2:1));let N,I,M,C;if(_){const t=e.y-m,i=new n(-g,g-t),r=-Math.PI/2,o=new n(...S);N=new n(-g+b[0],b[1]),N._rotateAround(r,i)._add(o),N.x+=-t+g,N.y-=(y.left-s)*e.scale;const a=e.imageName?y.advance*e.scale:oh*e.scale,l=String.fromCharCode(e.glyph);ph(l)?N.x+=(1-s)*e.scale:fh(l)?N.x+=a-y.height*e.scale+(-s-1)*e.scale:N.x+=e.imageName||y.width+2*s===x.w&&y.height+2*s===x.h?(a-E)/2:(a-(y.height+2*s)*e.scale)/2,I=new n(N.x,N.y-T),M=new n(N.x+E,N.y),C=new n(N.x+E,N.y-T);}else {const t=(y.left-s)*e.scale-g+b[0],i=(-y.top-s)*e.scale+b[1],r=t+T,o=i+E;N=new n(t,i),I=new n(r,i),M=new n(t,o),C=new n(r,o);}if(h){let e;e=o?new n(0,0):w?new n(u[0],u[1]):new n(i[0],i[1]),N._rotateAround(h,e),I._rotateAround(h,e),M._rotateAround(h,e),C._rotateAround(h,e);}const A=new n(0,0),P=new n(0,0);c.push({tl:N,tr:I,bl:M,br:C,tex:r,writingMode:t.writingMode,glyphOffset:v,sectionIndex:e.sectionIndex,isSDF:d,pixelOffsetTL:A,pixelOffsetBR:P,minFontScaleX:0,minFontScaleY:0});}}return c;}(0,r,c,s,a,l,o,e.allowVerticalPlacement),x=e.textSizeData;let v=null;"source"===x.kind?(v=[sh*s.layout.get("text-size").evaluate(l,{},g)],v[0]>Ru&&de(`${e.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)):"composite"===x.kind&&(v=[sh*m.compositeTextSizes[0].evaluate(l,{},g),sh*m.compositeTextSizes[1].evaluate(l,{},g)],(v[0]>Ru||v[1]>Ru)&&de(`${e.layerIds[0]}: Value for "text-size" is >= 255. Reduce your "text-size".`)),e.addSymbols(e.text,y,v,c,a,l,u,t,i,h.lineStartIndex,h.lineLength,f,_,g);for(const t of d)p[t]=e.text.placedSymbolArray.length-1;return 4*y.length;}function Fu(e){for(const t in e)return e[t];return null;}function Bu(e,t,i,r,o,s,a,l,c,h){let u=a.top,d=a.bottom,p=a.left,f=a.right;const m=a.collisionPadding;if(m&&(p-=m[0],u-=m[1],f+=m[2],d+=m[3]),c){const e=new n(p,u),t=new n(f,u),i=new n(p,d),r=new n(f,d),o=j(c);let s=new n(0,0);h&&(s=new n(h[0],h[1])),e._rotateAround(o,s),t._rotateAround(o,s),i._rotateAround(o,s),r._rotateAround(o,s),p=Math.min(e.x,t.x,i.x,r.x),f=Math.max(e.x,t.x,i.x,r.x),u=Math.min(e.y,t.y,i.y,r.y),d=Math.max(e.y,t.y,i.y,r.y);}return e.emplaceBack(t.x,t.y,t.z,i.x,i.y,p,u,f,d,l,r,o,s),e.length-1;}function Uu(e){e.collisionPadding&&(e.top-=e.collisionPadding[1],e.bottom+=e.collisionPadding[3]);const t=e.bottom-e.top;return t>0?Math.max(10,t):null;}function Vu(e,t,i,r){const n=e.compareText;if(t in n){const e=n[t];for(let t=e.length-1;t>=0;t--)if(r.dist(e[t])<i)return !0;}else n[t]=[];return n[t].push(r),!1;}const Gu=Ac.VectorTileFeature.types,ju=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function $u(e,t,i,r,n,o,s,a,l,c,h,u,d,p,f,m){const _=h?Math.min(Ru,Math.round(h[0])):0,g=h?Math.min(Ru,Math.round(h[1])):0;e.emplaceBack(t,i,Math.round(32*s),Math.round(32*a),l,c,(_<<1)+(u?1:0),g,16*d,16*p,256*f,256*m,r,n,o,0);}function Hu(e,t,i){e.emplaceBack(t.x,t.y,i),e.emplaceBack(t.x,t.y,i),e.emplaceBack(t.x,t.y,i),e.emplaceBack(t.x,t.y,i);}function qu(e){for(const t of e.sections)if(Do(t.text))return !0;return !1;}class Zu{constructor(e){this.layoutVertexArray=new xs(),this.indexArray=new Es(),this.programConfigurations=e,this.segments=new Ma(),this.dynamicLayoutVertexArray=new _s(),this.opacityVertexArray=new vs(),this.placedSymbolArray=new Bs();}isEmpty(){return 0===this.layoutVertexArray.length&&0===this.indexArray.length&&0===this.dynamicLayoutVertexArray.length&&0===this.opacityVertexArray.length;}upload(e,t,i,r){this.isEmpty()||(i&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Qc.members),this.indexBuffer=e.createIndexBuffer(this.indexArray,t),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,eh.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,ju,!0),this.opacityVertexBuffer.itemSize=1),(i||r)&&this.programConfigurations.upload(e));}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy());}}qn("SymbolBuffers",Zu);class Xu{constructor(e,t,i){this.layoutVertexArray=new e(),this.layoutAttributes=t,this.indexArray=new i(),this.segments=new Ma(),this.collisionVertexArray=new Ts(),this.collisionVertexArrayExt=new _s();}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,th.members,!0),this.collisionVertexBufferExt=e.createVertexBuffer(this.collisionVertexArrayExt,ih.members,!0);}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy());}}qn("CollisionBuffers",Xu);class Wu{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map(e=>e.id),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=h([]),this.placementViewportMatrix=h([]);const t=this.layers[0]._unevaluatedLayout._values;this.textSizeData=ah(this.zoom,t["text-size"]),this.iconSizeData=ah(this.zoom,t["icon-size"]);const i=this.layers[0].layout,r=i.get("symbol-sort-key"),n=i.get("symbol-z-order");this.canOverlap=i.get("text-allow-overlap")||i.get("icon-allow-overlap")||i.get("text-ignore-placement")||i.get("icon-ignore-placement"),this.sortFeaturesByKey="viewport-y"!==n&&void 0!==r.constantOr(1),this.sortFeaturesByY=("viewport-y"===n||"auto"===n&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=i.get("text-writing-mode").map(e=>jh[e]),this.stateDependentLayerIds=this.layers.filter(e=>e.isStateDependent()).map(e=>e.id),this.sourceID=e.sourceID;}createArrays(){this.text=new Zu(new ya(this.layers,this.zoom,e=>/^text/.test(e))),this.icon=new Zu(new ya(this.layers,this.zoom,e=>/^icon/.test(e))),this.glyphOffsetArray=new Gs(),this.lineVertexArray=new js(),this.symbolInstances=new Vs();}calculateGlyphDependencies(e,t,i,r,n){for(let i=0;i<e.length;i++)if(t[e.charCodeAt(i)]=!0,r&&n){const r=dh[e.charAt(i)];r&&(t[r.charCodeAt(0)]=!0);}}populate(e,t,i,r){const n=this.layers[0],o=n.layout,s=o.get("text-font"),a=o.get("text-field"),l=o.get("icon-image"),c=("constant"!==a.value.kind||a.value.value instanceof Xt&&!a.value.value.isEmpty()||a.value.value.toString().length>0)&&("constant"!==s.value.kind||s.value.value.length>0),h="constant"!==l.value.kind||!!l.value.value||Object.keys(l.parameters).length>0,u=o.get("symbol-sort-key");if(this.features=[],!c&&!h)return;const d=t.iconDependencies,p=t.glyphDependencies,f=t.availableImages,m=new qo(this.zoom);for(const{feature:t,id:a,index:l,sourceLayerIndex:_}of e){const e=n._featureFilter.needGeometry,g=Wa(t,e);if(!n._featureFilter.filter(m,g,i))continue;let y,x;if(e||(g.geometry=Xa(t,i,r)),c){const e=n.getValueAndResolveTokens("text-field",g,i,f),t=Xt.factory(e);qu(t)&&(this.hasRTLText=!0),(!this.hasRTLText||"unavailable"===jo()||this.hasRTLText&&Ho.isParsed())&&(y=uh(t,n,g));}if(h){const e=n.getValueAndResolveTokens("icon-image",g,i,f);x=e instanceof Wt?e:Wt.fromString(e);}if(!y&&!x)continue;const v=this.sortFeaturesByKey?u.evaluate(g,{},i):void 0;if(this.features.push({id:a,text:y,icon:x,index:l,sourceLayerIndex:_,geometry:g.geometry,properties:t.properties,type:Gu[t.type],sortKey:v}),x&&(d[x.name]=!0),y){const e=s.evaluate(g,{},i).join(","),t="map"===o.get("text-rotation-alignment")&&"point"!==o.get("symbol-placement");this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(jh.vertical)>=0;for(const i of y.sections)if(i.image)d[i.image.name]=!0;else {const r=No(y.toString()),n=i.fontStack||e,o=p[n]=p[n]||{};this.calculateGlyphDependencies(i.text,o,t,this.allowVerticalPlacement,r);}}}"line"===o.get("symbol-placement")&&(this.features=function(e){const t={},i={},r=[];let n=0;function o(t){r.push(e[t]),n++;}function s(e,t,n){const o=i[e];return delete i[e],i[t]=o,r[o].geometry[0].pop(),r[o].geometry[0]=r[o].geometry[0].concat(n[0]),o;}function a(e,i,n){const o=t[i];return delete t[i],t[e]=o,r[o].geometry[0].shift(),r[o].geometry[0]=n[0].concat(r[o].geometry[0]),o;}function l(e,t,i){const r=i?t[0][t[0].length-1]:t[0][0];return `${e}:${r.x}:${r.y}`;}for(let c=0;c<e.length;c++){const h=e[c],u=h.geometry,d=h.text?h.text.toString():null;if(!d){o(c);continue;}const p=l(d,u),f=l(d,u,!0);if(p in i&&f in t&&i[p]!==t[f]){const e=a(p,f,u),n=s(p,f,r[e].geometry);delete t[p],delete i[f],i[l(d,r[n].geometry,!0)]=n,r[e].geometry=null;}else p in i?s(p,f,u):f in t?a(p,f,u):(o(c),t[p]=n-1,i[f]=n-1);}return r.filter(e=>e.geometry);}(this.features)),this.sortFeaturesByKey&&this.features.sort((e,t)=>e.sortKey-t.sortKey);}update(e,t,i,r){this.stateDependentLayers.length&&(this.text.programConfigurations.updatePaintArrays(e,t,this.layers,i,r),this.icon.programConfigurations.updatePaintArrays(e,t,this.layers,i,r));}isEmpty(){return 0===this.symbolInstances.length&&!this.hasRTLText;}uploadPending(){return !this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload;}upload(e){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload),this.uploaded=!0;}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy();}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData();}addToLineVertexArray(e,t){const i=this.lineVertexArray.length;if(void 0!==e.segment){let i=e.dist(t[e.segment+1]),r=e.dist(t[e.segment]);const n={};for(let r=e.segment+1;r<t.length;r++)n[r]={x:t[r].x,y:t[r].y,tileUnitDistanceFromAnchor:i},r<t.length-1&&(i+=t[r+1].dist(t[r]));for(let i=e.segment||0;i>=0;i--)n[i]={x:t[i].x,y:t[i].y,tileUnitDistanceFromAnchor:r},i>0&&(r+=t[i-1].dist(t[i]));for(let e=0;e<t.length;e++){const t=n[e];this.lineVertexArray.emplaceBack(t.x,t.y,t.tileUnitDistanceFromAnchor);}}return {lineStartIndex:i,lineLength:this.lineVertexArray.length-i};}addSymbols(e,t,i,r,n,o,s,a,l,c,h,u,d,p){const f=e.indexArray,m=e.layoutVertexArray,_=e.segments.prepareSegment(4*t.length,m,f,this.canOverlap?o.sortKey:void 0),g=this.glyphOffsetArray.length,y=_.vertexLength,x=this.allowVerticalPlacement&&s===jh.vertical?Math.PI/2:0,v=o.text&&o.text.sections;for(let r=0;r<t.length;r++){const{tl:n,tr:s,bl:c,br:h,tex:u,pixelOffsetTL:g,pixelOffsetBR:y,minFontScaleX:b,minFontScaleY:S,glyphOffset:w,isSDF:T,sectionIndex:E}=t[r],N=_.vertexLength,I=w[1];$u(m,a.x,a.y,a.z,l.x,l.y,n.x,I+n.y,u.x,u.y,i,T,g.x,g.y,b,S),$u(m,a.x,a.y,a.z,l.x,l.y,s.x,I+s.y,u.x+u.w,u.y,i,T,y.x,g.y,b,S),$u(m,a.x,a.y,a.z,l.x,l.y,c.x,I+c.y,u.x,u.y+u.h,i,T,g.x,y.y,b,S),$u(m,a.x,a.y,a.z,l.x,l.y,h.x,I+h.y,u.x+u.w,u.y+u.h,i,T,y.x,y.y,b,S),Hu(e.dynamicLayoutVertexArray,a,x),f.emplaceBack(N,N+1,N+2),f.emplaceBack(N+1,N+2,N+3),_.vertexLength+=4,_.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(w[0]),r!==t.length-1&&E===t[r+1].sectionIndex||e.programConfigurations.populatePaintArrays(m.length,o,o.index,{},d,p,v&&v[E]);}e.placedSymbolArray.emplaceBack(a.x,a.y,a.z,l.x,l.y,g,this.glyphOffsetArray.length-g,y,c,h,l.segment,i?i[0]:0,i?i[1]:0,r[0],r[1],s,0,!1,0,u,0);}_commitLayoutVertex(e,t,i,r,n,o,s){e.emplaceBack(t,i,r,n,o,Math.round(s.x),Math.round(s.y));}_addCollisionDebugVertices(e,t,i,r,o,s,a){const l=i.segments.prepareSegment(4,i.layoutVertexArray,i.indexArray),c=l.vertexLength,h=a.tileAnchorX,u=a.tileAnchorY;for(let e=0;e<4;e++)i.collisionVertexArray.emplaceBack(0,0,0,0);i.collisionVertexArrayExt.emplaceBack(t,-e.padding,-e.padding),i.collisionVertexArrayExt.emplaceBack(t,e.padding,-e.padding),i.collisionVertexArrayExt.emplaceBack(t,e.padding,e.padding),i.collisionVertexArrayExt.emplaceBack(t,-e.padding,e.padding),this._commitLayoutVertex(i.layoutVertexArray,r,o,s,h,u,new n(e.x1,e.y1)),this._commitLayoutVertex(i.layoutVertexArray,r,o,s,h,u,new n(e.x2,e.y1)),this._commitLayoutVertex(i.layoutVertexArray,r,o,s,h,u,new n(e.x2,e.y2)),this._commitLayoutVertex(i.layoutVertexArray,r,o,s,h,u,new n(e.x1,e.y2)),l.vertexLength+=4;const d=i.indexArray;d.emplaceBack(c,c+1),d.emplaceBack(c+1,c+2),d.emplaceBack(c+2,c+3),d.emplaceBack(c+3,c),l.primitiveLength+=4;}_addTextDebugCollisionBoxes(e,t,i,r,n,o){for(let s=r;s<n;s++){const r=i.get(s),n=this.getSymbolInstanceTextSize(e,o,t,s);this._addCollisionDebugVertices(r,n,this.textCollisionBox,r.projectedAnchorX,r.projectedAnchorY,r.projectedAnchorZ,o);}}_addIconDebugCollisionBoxes(e,t,i,r,n,o){for(let s=r;s<n;s++){const r=i.get(s),n=this.getSymbolInstanceIconSize(e,t,s);this._addCollisionDebugVertices(r,n,this.iconCollisionBox,r.projectedAnchorX,r.projectedAnchorY,r.projectedAnchorZ,o);}}generateCollisionDebugBuffers(e,t){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new Xu(Ss,rh.members,Ls),this.iconCollisionBox=new Xu(Ss,rh.members,Ls);const i=ch(this.iconSizeData,e),r=ch(this.textSizeData,e);for(let n=0;n<this.symbolInstances.length;n++){const o=this.symbolInstances.get(n);this._addTextDebugCollisionBoxes(r,e,t,o.textBoxStartIndex,o.textBoxEndIndex,o),this._addTextDebugCollisionBoxes(r,e,t,o.verticalTextBoxStartIndex,o.verticalTextBoxEndIndex,o),this._addIconDebugCollisionBoxes(i,e,t,o.iconBoxStartIndex,o.iconBoxEndIndex,o),this._addIconDebugCollisionBoxes(i,e,t,o.verticalIconBoxStartIndex,o.verticalIconBoxEndIndex,o);}}getSymbolInstanceTextSize(e,t,i,r){const n=this.text.placedSymbolArray.get(t.rightJustifiedTextSymbolIndex>=0?t.rightJustifiedTextSymbolIndex:t.centerJustifiedTextSymbolIndex>=0?t.centerJustifiedTextSymbolIndex:t.leftJustifiedTextSymbolIndex>=0?t.leftJustifiedTextSymbolIndex:t.verticalPlacedTextSymbolIndex>=0?t.verticalPlacedTextSymbolIndex:r),o=lh(this.textSizeData,e,n)/oh;return this.tilePixelRatio*o;}getSymbolInstanceIconSize(e,t,i){const r=this.icon.placedSymbolArray.get(i),n=lh(this.iconSizeData,e,r);return this.tilePixelRatio*n;}_commitDebugCollisionVertexUpdate(e,t,i){e.emplaceBack(t,-i,-i),e.emplaceBack(t,i,-i),e.emplaceBack(t,i,i),e.emplaceBack(t,-i,i);}_updateTextDebugCollisionBoxes(e,t,i,r,n,o){for(let s=r;s<n;s++){const r=i.get(s),n=this.getSymbolInstanceTextSize(e,o,t,s);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,n,r.padding);}}_updateIconDebugCollisionBoxes(e,t,i,r,n){for(let o=r;o<n;o++){const r=i.get(o),n=this.getSymbolInstanceIconSize(e,t,o);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,n,r.padding);}}updateCollisionDebugBuffers(e,t){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const i=ch(this.iconSizeData,e),r=ch(this.textSizeData,e);for(let n=0;n<this.symbolInstances.length;n++){const o=this.symbolInstances.get(n);this._updateTextDebugCollisionBoxes(r,e,t,o.textBoxStartIndex,o.textBoxEndIndex,o),this._updateTextDebugCollisionBoxes(r,e,t,o.verticalTextBoxStartIndex,o.verticalTextBoxEndIndex,o),this._updateIconDebugCollisionBoxes(i,e,t,o.iconBoxStartIndex,o.iconBoxEndIndex),this._updateIconDebugCollisionBoxes(i,e,t,o.verticalIconBoxStartIndex,o.verticalIconBoxEndIndex);}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt);}_deserializeCollisionBoxesForSymbol(e,t,i,r,n,o,s,a,l){const c={};for(let r=t;r<i;r++){const t=e.get(r);c.textBox={x1:t.x1,y1:t.y1,x2:t.x2,y2:t.y2,padding:t.padding,projectedAnchorX:t.projectedAnchorX,projectedAnchorY:t.projectedAnchorY,projectedAnchorZ:t.projectedAnchorZ,tileAnchorX:t.tileAnchorX,tileAnchorY:t.tileAnchorY},c.textFeatureIndex=t.featureIndex;break;}for(let t=r;t<n;t++){const i=e.get(t);c.verticalTextBox={x1:i.x1,y1:i.y1,x2:i.x2,y2:i.y2,padding:i.padding,projectedAnchorX:i.projectedAnchorX,projectedAnchorY:i.projectedAnchorY,projectedAnchorZ:i.projectedAnchorZ,tileAnchorX:i.tileAnchorX,tileAnchorY:i.tileAnchorY},c.verticalTextFeatureIndex=i.featureIndex;break;}for(let t=o;t<s;t++){const i=e.get(t);c.iconBox={x1:i.x1,y1:i.y1,x2:i.x2,y2:i.y2,padding:i.padding,projectedAnchorX:i.projectedAnchorX,projectedAnchorY:i.projectedAnchorY,projectedAnchorZ:i.projectedAnchorZ,tileAnchorX:i.tileAnchorX,tileAnchorY:i.tileAnchorY},c.iconFeatureIndex=i.featureIndex;break;}for(let t=a;t<l;t++){const i=e.get(t);c.verticalIconBox={x1:i.x1,y1:i.y1,x2:i.x2,y2:i.y2,padding:i.padding,projectedAnchorX:i.projectedAnchorX,projectedAnchorY:i.projectedAnchorY,projectedAnchorZ:i.projectedAnchorZ,tileAnchorX:i.tileAnchorX,tileAnchorY:i.tileAnchorY},c.verticalIconFeatureIndex=i.featureIndex;break;}return c;}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let t=0;t<this.symbolInstances.length;t++){const i=this.symbolInstances.get(t);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,i.textBoxStartIndex,i.textBoxEndIndex,i.verticalTextBoxStartIndex,i.verticalTextBoxEndIndex,i.iconBoxStartIndex,i.iconBoxEndIndex,i.verticalIconBoxStartIndex,i.verticalIconBoxEndIndex));}}hasTextData(){return this.text.segments.get().length>0;}hasIconData(){return this.icon.segments.get().length>0;}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox;}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0;}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0;}addIndicesForPlacedSymbol(e,t){const i=e.placedSymbolArray.get(t),r=i.vertexStartIndex+4*i.numGlyphs;for(let t=i.vertexStartIndex;t<r;t+=4)e.indexArray.emplaceBack(t,t+1,t+2),e.indexArray.emplaceBack(t+1,t+2,t+3);}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&void 0!==this.symbolInstanceIndexes)return this.symbolInstanceIndexes;const t=Math.sin(e),i=Math.cos(e),r=[],n=[],o=[];for(let e=0;e<this.symbolInstances.length;++e){o.push(e);const s=this.symbolInstances.get(e);r.push(0|Math.round(t*s.tileAnchorX+i*s.tileAnchorY)),n.push(s.featureIndex);}return o.sort((e,t)=>r[e]-r[t]||n[t]-n[e]),o;}addToSortKeyRanges(e,t){const i=this.sortKeyRanges[this.sortKeyRanges.length-1];i&&i.sortKey===t?i.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:t,symbolInstanceStart:e,symbolInstanceEnd:e+1});}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const e of this.symbolInstanceIndexes){const t=this.symbolInstances.get(e);this.featureSortOrder.push(t.featureIndex),[t.rightJustifiedTextSymbolIndex,t.centerJustifiedTextSymbolIndex,t.leftJustifiedTextSymbolIndex].forEach((e,t,i)=>{e>=0&&i.indexOf(e)===t&&this.addIndicesForPlacedSymbol(this.text,e);}),t.verticalPlacedTextSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.text,t.verticalPlacedTextSymbolIndex),t.placedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,t.placedIconSymbolIndex),t.verticalPlacedIconSymbolIndex>=0&&this.addIndicesForPlacedSymbol(this.icon,t.verticalPlacedIconSymbolIndex);}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray);}}}qn("SymbolBucket",Wu,{omit:["layers","collisionBoxArray","features","compareText"]}),Wu.MAX_GLYPHS=65535,Wu.addDynamicAttributes=Hu;const Yu=new ss({"symbol-placement":new ts(xt.layout_symbol["symbol-placement"]),"symbol-spacing":new ts(xt.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new ts(xt.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new is(xt.layout_symbol["symbol-sort-key"]),"symbol-z-order":new ts(xt.layout_symbol["symbol-z-order"]),"icon-allow-overlap":new ts(xt.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new ts(xt.layout_symbol["icon-ignore-placement"]),"icon-optional":new ts(xt.layout_symbol["icon-optional"]),"icon-rotation-alignment":new ts(xt.layout_symbol["icon-rotation-alignment"]),"icon-size":new is(xt.layout_symbol["icon-size"]),"icon-text-fit":new ts(xt.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new ts(xt.layout_symbol["icon-text-fit-padding"]),"icon-image":new is(xt.layout_symbol["icon-image"]),"icon-rotate":new is(xt.layout_symbol["icon-rotate"]),"icon-padding":new ts(xt.layout_symbol["icon-padding"]),"icon-keep-upright":new ts(xt.layout_symbol["icon-keep-upright"]),"icon-offset":new is(xt.layout_symbol["icon-offset"]),"icon-anchor":new is(xt.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new ts(xt.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new ts(xt.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new ts(xt.layout_symbol["text-rotation-alignment"]),"text-field":new is(xt.layout_symbol["text-field"]),"text-font":new is(xt.layout_symbol["text-font"]),"text-size":new is(xt.layout_symbol["text-size"]),"text-max-width":new is(xt.layout_symbol["text-max-width"]),"text-line-height":new is(xt.layout_symbol["text-line-height"]),"text-letter-spacing":new is(xt.layout_symbol["text-letter-spacing"]),"text-justify":new is(xt.layout_symbol["text-justify"]),"text-radial-offset":new is(xt.layout_symbol["text-radial-offset"]),"text-variable-anchor":new ts(xt.layout_symbol["text-variable-anchor"]),"text-anchor":new is(xt.layout_symbol["text-anchor"]),"text-max-angle":new ts(xt.layout_symbol["text-max-angle"]),"text-writing-mode":new ts(xt.layout_symbol["text-writing-mode"]),"text-rotate":new is(xt.layout_symbol["text-rotate"]),"text-padding":new ts(xt.layout_symbol["text-padding"]),"text-keep-upright":new ts(xt.layout_symbol["text-keep-upright"]),"text-transform":new is(xt.layout_symbol["text-transform"]),"text-offset":new is(xt.layout_symbol["text-offset"]),"text-allow-overlap":new ts(xt.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new ts(xt.layout_symbol["text-ignore-placement"]),"text-optional":new ts(xt.layout_symbol["text-optional"])});var Ju={paint:new ss({"icon-opacity":new is(xt.paint_symbol["icon-opacity"]),"icon-color":new is(xt.paint_symbol["icon-color"]),"icon-halo-color":new is(xt.paint_symbol["icon-halo-color"]),"icon-halo-width":new is(xt.paint_symbol["icon-halo-width"]),"icon-halo-blur":new is(xt.paint_symbol["icon-halo-blur"]),"icon-translate":new ts(xt.paint_symbol["icon-translate"]),"icon-translate-anchor":new ts(xt.paint_symbol["icon-translate-anchor"]),"text-opacity":new is(xt.paint_symbol["text-opacity"]),"text-color":new is(xt.paint_symbol["text-color"],{runtimeType:Pt,getOverride:e=>e.textColor,hasOverride:e=>!!e.textColor}),"text-halo-color":new is(xt.paint_symbol["text-halo-color"]),"text-halo-width":new is(xt.paint_symbol["text-halo-width"]),"text-halo-blur":new is(xt.paint_symbol["text-halo-blur"]),"text-translate":new ts(xt.paint_symbol["text-translate"]),"text-translate-anchor":new ts(xt.paint_symbol["text-translate-anchor"])}),layout:Yu};class Ku{constructor(e){this.type=e.property.overrides?e.property.overrides.runtimeType:It,this.defaultValue=e;}evaluate(e){if(e.formattedSection){const t=this.defaultValue.property.overrides;if(t&&t.hasOverride(e.formattedSection))return t.getOverride(e.formattedSection);}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default;}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression);}outputDefined(){return !1;}serialize(){return null;}}qn("FormatSectionOverride",Ku,{omit:["defaultValue"]});class Qu extends Ea{constructor(e){super(e,Ju);}recalculate(e,t){super.recalculate(e,t),"auto"===this.layout.get("icon-rotation-alignment")&&(this.layout._values["icon-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-rotation-alignment")&&(this.layout._values["text-rotation-alignment"]="point"!==this.layout.get("symbol-placement")?"map":"viewport"),"auto"===this.layout.get("text-pitch-alignment")&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),"auto"===this.layout.get("icon-pitch-alignment")&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const i=this.layout.get("text-writing-mode");if(i){const e=[];for(const t of i)e.indexOf(t)<0&&e.push(t);this.layout._values["text-writing-mode"]=e;}else this.layout._values["text-writing-mode"]="point"===this.layout.get("symbol-placement")?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides();}getValueAndResolveTokens(e,t,i,r){const n=this.layout.get(e).evaluate(t,{},i,r),o=this._unevaluatedLayout._values[e];return o.isDataDriven()||jr(o.value)||!n?n:function(e,t){return t.replace(/{([^{}]+)}/g,(t,i)=>i in e?String(e[i]):"");}(t.properties,n);}createBucket(e){return new Wu(e);}queryRadius(){return 0;}queryIntersectsFeature(){return !1;}_setPaintOverrides(){for(const e of Ju.paint.overridableProperties){if(!Qu.hasPaintOverride(this.layout,e))continue;const t=this.paint.get(e),i=new Ku(t),r=new Gr(i,t.property.specification);let n=null;n="constant"===t.value.kind||"source"===t.value.kind?new Hr("source",r):new qr("composite",r,t.value.zoomStops,t.value._interpolationType),this.paint._values[e]=new Qo(t.property,n,t.parameters);}}_handleOverridablePaintPropertyUpdate(e,t,i){return !(!this.layout||t.isDataDriven()||i.isDataDriven())&&Qu.hasPaintOverride(this.layout,e);}static hasPaintOverride(e,t){const i=e.get("text-field"),r=Ju.paint.properties[t];let n=!1;const o=e=>{for(const t of e)if(r.overrides&&r.overrides.hasOverride(t))return void(n=!0);};if("constant"===i.value.kind&&i.value.value instanceof Xt)o(i.value.value.sections);else if("source"===i.value.kind){const e=t=>{n||(t instanceof ei&&Kt(t.value)===zt?o(t.value.sections):t instanceof ni?o(t.sections):t.eachChild(e));},t=i.value;t._styleExpression&&e(t._styleExpression.expression);}return n;}getProgramConfiguration(e){return new ga(this,e);}}var ed={paint:new ss({"background-color":new ts(xt.paint_background["background-color"]),"background-pattern":new ns(xt.paint_background["background-pattern"]),"background-opacity":new ts(xt.paint_background["background-opacity"])})},td={paint:new ss({"raster-opacity":new ts(xt.paint_raster["raster-opacity"]),"raster-hue-rotate":new ts(xt.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new ts(xt.paint_raster["raster-brightness-min"]),"raster-brightness-max":new ts(xt.paint_raster["raster-brightness-max"]),"raster-saturation":new ts(xt.paint_raster["raster-saturation"]),"raster-contrast":new ts(xt.paint_raster["raster-contrast"]),"raster-resampling":new ts(xt.paint_raster["raster-resampling"]),"raster-fade-duration":new ts(xt.paint_raster["raster-fade-duration"])})};class id extends Ea{constructor(e){super(e,{}),this.implementation=e;}is3D(){return "3d"===this.implementation.renderingMode;}hasOffscreenPass(){return void 0!==this.implementation.prerender;}recalculate(){}updateTransitions(){}hasTransition(){}serialize(){}onAdd(e){this.implementation.onAdd&&this.implementation.onAdd(e,e.painter.context.gl);}onRemove(e){this.implementation.onRemove&&this.implementation.onRemove(e,e.painter.context.gl);}}var rd={paint:new ss({"sky-type":new ts(xt.paint_sky["sky-type"]),"sky-atmosphere-sun":new ts(xt.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new ts(xt.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new ts(xt.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new ts(xt.paint_sky["sky-gradient-radius"]),"sky-gradient":new os(xt.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new ts(xt.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new ts(xt.paint_sky["sky-atmosphere-color"]),"sky-opacity":new ts(xt.paint_sky["sky-opacity"])})};function nd(e,t,i){const r=v(0,0,1),n=F(O());return function(e,t,i){i*=.5;var r=t[0],n=t[1],o=t[2],s=t[3],a=Math.sin(i),l=Math.cos(i);e[0]=r*l-o*a,e[1]=n*l+s*a,e[2]=o*l+r*a,e[3]=s*l-n*a;}(n,n,i?-j(e)+Math.PI:j(e)),B(n,n,-j(t)),P(r,r,n),I(r,r);}const od={circle:class extends Ea{constructor(e){super(e,ml);}createBucket(e){return new Ja(e);}queryRadius(e){const t=e;return hl("circle-radius",this,t)+hl("circle-stroke-width",this,t)+ul(this.paint.get("circle-translate"));}queryIntersectsFeature(e,t,i,r,n,o,s,a){const l=pl(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),o.angle,e.pixelToTileUnitsFactor),c=this.paint.get("circle-radius").evaluate(t,i)+this.paint.get("circle-stroke-width").evaluate(t,i);return yl(e,r,o,s,a,"map"===this.paint.get("circle-pitch-alignment"),"map"===this.paint.get("circle-pitch-scale"),l,c);}getProgramIds(){return ["circle"];}getProgramConfiguration(e){return new ga(this,e);}},heatmap:class extends Ea{createBucket(e){return new wl(e);}constructor(e){super(e,Cl),this._updateColorRamp();}_handleSpecialPaintPropertyUpdate(e){"heatmap-color"===e&&this._updateColorRamp();}_updateColorRamp(){this.colorRamp=Al({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null;}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null);}queryRadius(e){return hl("heatmap-radius",this,e);}queryIntersectsFeature(e,t,i,r,o,s,a,l){const c=this.paint.get("heatmap-radius").evaluate(t,i);return yl(e,r,s,a,l,!0,!0,new n(0,0),c);}hasOffscreenPass(){return 0!==this.paint.get("heatmap-opacity")&&"none"!==this.visibility;}getProgramIds(){return ["heatmap","heatmapTexture"];}getProgramConfiguration(e){return new ga(this,e);}},hillshade:class extends Ea{constructor(e){super(e,Pl);}hasOffscreenPass(){return 0!==this.paint.get("hillshade-exaggeration")&&"none"!==this.visibility;}getProgramIds(){return ["hillshade","hillshadePrepare"];}getProgramConfiguration(e){return new ga(this,e);}},fill:class extends Ea{constructor(e){super(e,yc);}getProgramIds(){const e=this.paint.get("fill-pattern"),t=e&&e.constantOr(1),i=[t?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&i.push(t&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),i;}getProgramConfiguration(e){return new ga(this,e);}recalculate(e,t){super.recalculate(e,t);const i=this.paint._values["fill-outline-color"];"constant"===i.value.kind&&void 0===i.value.value&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"]);}createBucket(e){return new _c(e);}queryRadius(){return ul(this.paint.get("fill-translate"));}queryIntersectsFeature(e,t,i,r,n,o){return !e.queryGeometry.isAboveHorizon&&el(dl(e.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),o.angle,e.pixelToTileUnitsFactor),r);}isTileClipped(){return !0;}},"fill-extrusion":class extends Ea{constructor(e){super(e,Oc);}createBucket(e){return new zc(e);}queryRadius(){return ul(this.paint.get("fill-extrusion-translate"));}is3D(){return !0;}getProgramIds(){return [this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"];}getProgramConfiguration(e){return new ga(this,e);}queryIntersectsFeature(e,t,i,r,o,s,a,l,c){const h=pl(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),s.angle,e.pixelToTileUnitsFactor),u=this.paint.get("fill-extrusion-height").evaluate(t,i),d=this.paint.get("fill-extrusion-base").evaluate(t,i),p=[0,0],f=l&&s.elevation,m=s.elevation?s.elevation.exaggeration():1;if(f){const t=e.tile.getBucket(this).centroidVertexArray,i=c+1;if(i<t.length){const e=t.get(i);p[0]=e.a_centroid_pos0,p[1]=e.a_centroid_pos1;}}if(0===p[0]&&1===p[1])return !1;const _=function(e,t,i,r,o,s,a,l,c){return s?function(e,t,i,r,n,o,s,a,l){const c=[],h=[],u=[0,0,0,1];for(const d of e){const e=[],p=[];for(const c of d){const h=c.x+r.x,d=c.y+r.y,f=Vc(h,d,t,i,o,s,a,l);u[0]=h,u[1]=d,u[2]=f.base,u[3]=1,R(u,u,n),u[3]=Math.max(u[3],1e-5);const m=Uc([u[0]/u[3],u[1]/u[3],u[2]/u[3]]);u[0]=h,u[1]=d,u[2]=f.top,u[3]=1,R(u,u,n),u[3]=Math.max(u[3],1e-5);const _=Uc([u[0]/u[3],u[1]/u[3],u[2]/u[3]]);e.push(m),p.push(_);}c.push(e),h.push(p);}return [c,h];}(e,t,i,r,o,s,a,l,c):function(e,t,i,r,o){const s=[],a=[],l=o[8]*t,c=o[9]*t,h=o[10]*t,u=o[11]*t,d=o[8]*i,p=o[9]*i,f=o[10]*i,m=o[11]*i;for(const t of e){const e=[],i=[];for(const s of t){const t=s.x+r.x,a=s.y+r.y,_=o[0]*t+o[4]*a+o[12],g=o[1]*t+o[5]*a+o[13],y=o[2]*t+o[6]*a+o[14],x=o[3]*t+o[7]*a+o[15],v=_+l,b=g+c,S=y+h,w=Math.max(x+u,1e-5),T=_+d,E=g+p,N=y+f,I=Math.max(x+m,1e-5),M=new n(v/w,b/w);M.z=S/w,e.push(M);const C=new n(T/I,E/I);C.z=N/I,i.push(C);}s.push(e),a.push(i);}return [s,a];}(e,t,i,r,o);}(r,d,u,h,a,f?l:null,p,m,s.center.lat),g=e.queryGeometry;return function(e,t,i){let r=1/0;el(i,t)&&(r=Bc(i,t[0]));for(let n=0;n<t.length;n++){const o=t[n],s=e[n];for(let e=0;e<o.length-1;e++){const t=o[e],n=[t,o[e+1],s[e+1],s[e],t];Ka(i,n)&&(r=Math.min(r,Bc(i,n)));}}return r!==1/0&&r;}(_[0],_[1],g.isPointQuery()?g.screenBounds:g.screenGeometry);}},line:class extends Ea{constructor(e){super(e,Yc),this.gradientVersion=0;}_handleSpecialPaintPropertyUpdate(e){if("line-gradient"===e){const e=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=e._styleExpression&&e._styleExpression.expression instanceof Ri,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER;}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression;}recalculate(e,t){super.recalculate(e,t),this.paint._values["line-floorwidth"]=Jc.possiblyEvaluate(this._transitioningPaint._values["line-width"].value,e);}createBucket(e){return new Xc(e);}getProgramIds(){return [this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"];}getProgramConfiguration(e){return new ga(this,e);}queryRadius(e){const t=e,i=Kc(hl("line-width",this,t),hl("line-gap-width",this,t)),r=hl("line-offset",this,t);return i/2+Math.abs(r)+ul(this.paint.get("line-translate"));}queryIntersectsFeature(e,t,i,r,o,s){if(e.queryGeometry.isAboveHorizon)return !1;const a=dl(e.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),s.angle,e.pixelToTileUnitsFactor),l=e.pixelToTileUnitsFactor/2*Kc(this.paint.get("line-width").evaluate(t,i),this.paint.get("line-gap-width").evaluate(t,i)),c=this.paint.get("line-offset").evaluate(t,i);return c&&(r=function(e,t){const i=[],r=new n(0,0);for(let n=0;n<e.length;n++){const o=e[n],s=[];for(let e=0;e<o.length;e++){const i=o[e-1],n=o[e],a=o[e+1],l=0===e?r:n.sub(i)._unit()._perp(),c=e===o.length-1?r:a.sub(n)._unit()._perp(),h=l._add(c)._unit();h._mult(1/(h.x*c.x+h.y*c.y)),s.push(h._mult(t)._add(n));}i.push(s);}return i;}(r,c*e.pixelToTileUnitsFactor)),function(e,t,i){for(let r=0;r<t.length;r++){const n=t[r];if(e.length>=3)for(let t=0;t<n.length;t++)if(al(e,n[t]))return !0;if(tl(e,n,i))return !0;}return !1;}(a,r,l);}isTileClipped(){return !0;}},symbol:Qu,background:class extends Ea{constructor(e){super(e,ed);}getProgramIds(){return [this.paint.get("background-pattern")?"backgroundPattern":"background"];}},raster:class extends Ea{constructor(e){super(e,td);}getProgramIds(){return ["raster"];}},sky:class extends Ea{constructor(e){super(e,rd),this._updateColorRamp();}_handleSpecialPaintPropertyUpdate(e){"sky-gradient"===e?this._updateColorRamp():"sky-atmosphere-sun"!==e&&"sky-atmosphere-halo-color"!==e&&"sky-atmosphere-color"!==e&&"sky-atmosphere-sun-intensity"!==e||(this._skyboxInvalidated=!0);}_updateColorRamp(){this.colorRamp=Al({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null);}needsSkyboxCapture(e){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return !0;if(!this.paint.get("sky-atmosphere-sun")){const t=e.style.light.properties.get("position");return this._lightPosition.azimuthal!==t.azimuthal||this._lightPosition.polar!==t.polar;}}getCenter(e,t){const i=this.paint.get("sky-type");if("atmosphere"===i){const i=this.paint.get("sky-atmosphere-sun"),r=!i,n=e.style.light,o=n.properties.get("position");return r&&"viewport"===n.properties.get("anchor")&&de("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),r?nd(o.azimuthal,90-o.polar,t):nd(i[0],90-i[1],t);}if("gradient"===i){const e=this.paint.get("sky-gradient-center");return nd(e[0],90-e[1],t);}}is3D(){return !1;}isSky(){return !0;}markSkyboxValid(e){this._skyboxInvalidated=!1,this._lightPosition=e.style.light.properties.get("position");}hasOffscreenPass(){return !0;}getProgramIds(){const e=this.paint.get("sky-type");return "atmosphere"===e?["skyboxCapture","skybox"]:"gradient"===e?["skyboxGradient"]:null;}}},{HTMLImageElement:sd,HTMLCanvasElement:ad,HTMLVideoElement:ld,ImageData:cd,ImageBitmap:hd}=s;class ud{constructor(e,t,i,r){this.context=e,this.format=i,this.texture=e.gl.createTexture(),this.update(t,r);}update(e,t,i){const{width:r,height:n}=e,{context:o}=this,{gl:s}=o;if(s.bindTexture(s.TEXTURE_2D,this.texture),o.pixelStoreUnpackFlipY.set(!1),o.pixelStoreUnpack.set(1),o.pixelStoreUnpackPremultiplyAlpha.set(this.format===s.RGBA&&(!t||!1!==t.premultiply)),i||this.size&&this.size[0]===r&&this.size[1]===n){const{x:t,y:o}=i||{x:0,y:0};e instanceof sd||e instanceof ad||e instanceof ld||e instanceof cd||hd&&e instanceof hd?s.texSubImage2D(s.TEXTURE_2D,0,t,o,s.RGBA,s.UNSIGNED_BYTE,e):s.texSubImage2D(s.TEXTURE_2D,0,t,o,r,n,s.RGBA,s.UNSIGNED_BYTE,e.data);}else this.size=[r,n],e instanceof sd||e instanceof ad||e instanceof ld||e instanceof cd||hd&&e instanceof hd?s.texImage2D(s.TEXTURE_2D,0,this.format,this.format,s.UNSIGNED_BYTE,e):s.texImage2D(s.TEXTURE_2D,0,this.format,r,n,0,this.format,s.UNSIGNED_BYTE,e.data);this.useMipmap=Boolean(t&&t.useMipmap&&this.isSizePowerOfTwo()),this.useMipmap&&s.generateMipmap(s.TEXTURE_2D);}bind(e,t){const{context:i}=this,{gl:r}=i;r.bindTexture(r.TEXTURE_2D,this.texture),e!==this.filter&&(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,e),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,this.useMipmap?e===r.NEAREST?r.NEAREST_MIPMAP_NEAREST:r.LINEAR_MIPMAP_NEAREST:e),this.filter=e),t!==this.wrap&&(r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,t),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,t),this.wrap=t);}isSizePowerOfTwo(){return this.size[0]===this.size[1]&&Math.log(this.size[0])/Math.LN2%1==0;}destroy(){const{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null;}}class dd{constructor(e,t){this.width=e,this.height=t,this.nextRow=0,this.image=new Il({width:e,height:t}),this.positions={},this.uploaded=!1;}getDash(e,t){const i=this.getKey(e,t);return this.positions[i];}trim(){const e=this.width,t=this.height=ne(this.nextRow);this.image.resize({width:e,height:t});}getKey(e,t){return e.join(",")+t;}getDashRanges(e,t,i){const r=[];let n=e.length%2==1?-e[e.length-1]*i:0,o=e[0]*i,s=!0;r.push({left:n,right:o,isDash:s,zeroLength:0===e[0]});let a=e[0];for(let t=1;t<e.length;t++){s=!s;const l=e[t];n=a*i,a+=l,o=a*i,r.push({left:n,right:o,isDash:s,zeroLength:0===l});}return r;}addRoundDash(e,t,i){const r=t/2;for(let t=-i;t<=i;t++){const n=this.width*(this.nextRow+i+t);let o=0,s=e[o];for(let a=0;a<this.width;a++){a/s.right>1&&(s=e[++o]);const l=Math.abs(a-s.left),c=Math.abs(a-s.right),h=Math.min(l,c);let u;const d=t/i*(r+1);if(s.isDash){const e=r-Math.abs(d);u=Math.sqrt(h*h+e*e);}else u=r-Math.sqrt(h*h+d*d);this.image.data[n+a]=Math.max(0,Math.min(255,u+128));}}}addRegularDash(e,t){for(let t=e.length-1;t>=0;--t){const i=e[t],r=e[t+1];i.zeroLength?e.splice(t,1):r&&r.isDash===i.isDash&&(r.left=i.left,e.splice(t,1));}const i=e[0],r=e[e.length-1];i.isDash===r.isDash&&(i.left=r.left-this.width,r.right=i.right+this.width);const n=this.width*this.nextRow;let o=0,s=e[o];for(let i=0;i<this.width;i++){i/s.right>1&&(s=e[++o]);const r=Math.abs(i-s.left),a=Math.abs(i-s.right),l=Math.min(r,a);this.image.data[n+i]=Math.max(0,Math.min(255,(s.isDash?l:-l)+t+128));}}addDash(e,t){const i=this.getKey(e,t);if(this.positions[i])return this.positions[i];const r="round"===t,n=r?7:0,o=2*n+1;if(this.nextRow+o>this.height)return de("LineAtlas out of space"),null;0===e.length&&e.push(1);let s=0;for(let t=0;t<e.length;t++)e[t]<0&&(de("Negative value is found in line dasharray, replacing values with 0"),e[t]=0),s+=e[t];if(0!==s){const i=this.width/s,o=this.getDashRanges(e,this.width,i);r?this.addRoundDash(o,i,n):this.addRegularDash(o,"square"===t?.5*i:0);}const a=this.nextRow+n;this.nextRow+=o;const l={tl:[a,n],br:[s,0]};return this.positions[i]=l,l;}}qn("LineAtlas",dd);class pd{constructor(e){this._callback=e,this._triggered=!1,"undefined"!=typeof MessageChannel&&(this._channel=new MessageChannel(),this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback();});}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout(()=>{this._triggered=!1,this._callback();},0));}remove(){delete this._channel,this._callback=()=>{};}}const fd=s.performance;function md(e){const t=e?e.url.toString():void 0;return fd.getEntriesByName(t);}class _d{constructor(){this.tasks={},this.taskQueue=[],se(["process"],this),this.invoker=new pd(this.process),this.nextId=0;}add(e,t){const i=this.nextId++,r=function({type:e,isSymbolTile:t,zoom:i}){return i=i||0,"message"===e?0:"maybePrepare"!==e||t?"parseTile"!==e||t?"parseTile"===e&&t?300-i:"maybePrepare"===e&&t?400-i:500:200-i:100-i;}(t);if(0===r){me();try{e();}finally{}return {cancel:()=>{}};}return this.tasks[i]={fn:e,metadata:t,priority:r,id:i},this.taskQueue.push(i),this.invoker.trigger(),{cancel:()=>{delete this.tasks[i];}};}process(){me();try{if(this.taskQueue=this.taskQueue.filter(e=>!!this.tasks[e]),!this.taskQueue.length)return;const e=this.pick();if(null===e)return;const t=this.tasks[e];if(delete this.tasks[e],this.taskQueue.length&&this.invoker.trigger(),!t)return;t.fn();}finally{}}pick(){let e=null,t=1/0;for(let i=0;i<this.taskQueue.length;i++){const r=this.tasks[this.taskQueue[i]];r.priority<t&&(t=r.priority,e=i);}if(null===e)return null;const i=this.taskQueue[e];return this.taskQueue.splice(e,1),i;}remove(){this.invoker.remove();}}function gd(e,t,i){var r=2*Math.PI*6378137/256/Math.pow(2,i);return [e*r-2*Math.PI*6378137/2,t*r-2*Math.PI*6378137/2];}class yd{constructor(e,t,i){this.z=e,this.x=t,this.y=i,this.key=bd(0,e,e,t,i);}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y;}url(e,t){const i=function(e,t,i){var r=gd(256*e,256*(t=Math.pow(2,i)-t-1),i),n=gd(256*(e+1),256*(t+1),i);return r[0]+","+r[1]+","+n[0]+","+n[1];}(this.x,this.y,this.z),r=function(e,t,i){let r,n="";for(let o=e;o>0;o--)r=1<<o-1,n+=(t&r?1:0)+(i&r?2:0);return n;}(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace("{z}",String(this.z)).replace("{x}",String(this.x)).replace("{y}",String("tms"===t?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",r).replace("{bbox-epsg-3857}",i);}toString(){return `${this.z}/${this.x}/${this.y}`;}}class xd{constructor(e,t){this.wrap=e,this.canonical=t,this.key=bd(e,t.z,t.z,t.x,t.y);}}class vd{constructor(e,t,i,r,n){this.overscaledZ=e,this.wrap=t,this.canonical=new yd(i,+r,+n),this.key=0===t&&e===i?this.canonical.key:bd(t,e,i,r,n);}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical);}scaledTo(e){const t=this.canonical.z-e;return e>this.canonical.z?new vd(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new vd(e,this.wrap,e,this.canonical.x>>t,this.canonical.y>>t);}calculateScaledKey(e,t=!0){if(this.overscaledZ===e&&t)return this.key;if(e>this.canonical.z)return bd(this.wrap*+t,e,this.canonical.z,this.canonical.x,this.canonical.y);{const i=this.canonical.z-e;return bd(this.wrap*+t,e,e,this.canonical.x>>i,this.canonical.y>>i);}}isChildOf(e){if(e.wrap!==this.wrap)return !1;const t=this.canonical.z-e.canonical.z;return 0===e.overscaledZ||e.overscaledZ<this.overscaledZ&&e.canonical.x===this.canonical.x>>t&&e.canonical.y===this.canonical.y>>t;}children(e){if(this.overscaledZ>=e)return [new vd(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const t=this.canonical.z+1,i=2*this.canonical.x,r=2*this.canonical.y;return [new vd(t,this.wrap,t,i,r),new vd(t,this.wrap,t,i+1,r),new vd(t,this.wrap,t,i,r+1),new vd(t,this.wrap,t,i+1,r+1)];}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y));}wrapped(){return new vd(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y);}unwrapTo(e){return new vd(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y);}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z);}toUnwrapped(){return new xd(this.wrap,this.canonical);}toString(){return `${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`;}}function bd(e,t,i,r,n){const o=1<<Math.min(i,22);let s=o*(n%o)+r%o;return e&&i<22&&(s+=o*o*((e<0?-2*e-1:2*e)%(1<<2*(22-i)))),16*(32*s+i)+(t-i);}qn("CanonicalTileID",yd),qn("OverscaledTileID",vd,{omit:["projMatrix"]});class Sd{constructor(e,t,i){this.func=e,this.mask=t,this.range=i;}}Sd.ReadOnly=!1,Sd.ReadWrite=!0,Sd.disabled=new Sd(519,Sd.ReadOnly,[0,1]);const wd=7680;class Td{constructor(e,t,i,r,n,o){this.test=e,this.ref=t,this.mask=i,this.fail=r,this.depthFail=n,this.pass=o;}}Td.disabled=new Td({func:519,mask:0},0,0,wd,wd,wd);class Ed{constructor(e,t,i){this.blendFunction=e,this.blendColor=t,this.mask=i;}}Ed.Replace=[1,0],Ed.disabled=new Ed(Ed.Replace,Ht.transparent,[!1,!1,!1,!1]),Ed.unblended=new Ed(Ed.Replace,Ht.transparent,[!0,!0,!0,!0]),Ed.alphaBlended=new Ed([1,771],Ht.transparent,[!0,!0,!0,!0]);const Nd=1029,Id=2305;class Md{constructor(e,t,i){this.enable=e,this.mode=t,this.frontFace=i;}}Md.disabled=new Md(!1,Nd,Id),Md.backCCW=new Md(!0,Nd,Id),Md.backCW=new Md(!0,Nd,2304),Md.frontCW=new Md(!0,1028,2304),Md.frontCCW=new Md(!0,1028,Id);class Cd{constructor(e){this._stringToNumber={},this._numberToString=[];for(let t=0;t<e.length;t++){const i=e[t];this._stringToNumber[i]=t,this._numberToString[t]=i;}}encode(e){return this._stringToNumber[e];}decode(e){return this._numberToString[e];}}class Ad{constructor(e,t,i,r,n){this.type="Feature",this._vectorTileFeature=e,e._z=t,e._x=i,e._y=r,this.properties=e.properties,this.id=n;}get geometry(){return void 0===this._geometry&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._vectorTileFeature._x,this._vectorTileFeature._y,this._vectorTileFeature._z).geometry),this._geometry;}set geometry(e){this._geometry=e;}toJSON(){const e={geometry:this.geometry};for(const t in this)"_geometry"!==t&&"_vectorTileFeature"!==t&&(e[t]=this[t]);return e;}}class Pd{constructor(){this.state={},this.stateChanges={},this.deletedStates={};}updateState(e,t,i){const r=String(t);if(this.stateChanges[e]=this.stateChanges[e]||{},this.stateChanges[e][r]=this.stateChanges[e][r]||{},ee(this.stateChanges[e][r],i),null===this.deletedStates[e]){this.deletedStates[e]={};for(const t in this.state[e])t!==r&&(this.deletedStates[e][t]=null);}else if(this.deletedStates[e]&&null===this.deletedStates[e][r]){this.deletedStates[e][r]={};for(const t in this.state[e][r])i[t]||(this.deletedStates[e][r][t]=null);}else for(const t in i)this.deletedStates[e]&&this.deletedStates[e][r]&&null===this.deletedStates[e][r][t]&&delete this.deletedStates[e][r][t];}removeFeatureState(e,t,i){if(null===this.deletedStates[e])return;const r=String(t);if(this.deletedStates[e]=this.deletedStates[e]||{},i&&void 0!==t)null!==this.deletedStates[e][r]&&(this.deletedStates[e][r]=this.deletedStates[e][r]||{},this.deletedStates[e][r][i]=null);else if(void 0!==t){if(this.stateChanges[e]&&this.stateChanges[e][r])for(i in this.deletedStates[e][r]={},this.stateChanges[e][r])this.deletedStates[e][r][i]=null;else this.deletedStates[e][r]=null;}else this.deletedStates[e]=null;}getState(e,t){const i=String(t),r=ee({},(this.state[e]||{})[i],(this.stateChanges[e]||{})[i]);if(null===this.deletedStates[e])return {};if(this.deletedStates[e]){const i=this.deletedStates[e][t];if(null===i)return {};for(const e in i)delete r[e];}return r;}initializeTileState(e,t){e.setFeatureState(this.state,t);}coalesceChanges(e,t){const i={};for(const e in this.stateChanges){this.state[e]=this.state[e]||{};const t={};for(const i in this.stateChanges[e])this.state[e][i]||(this.state[e][i]={}),ee(this.state[e][i],this.stateChanges[e][i]),t[i]=this.state[e][i];i[e]=t;}for(const e in this.deletedStates){this.state[e]=this.state[e]||{};const t={};if(null===this.deletedStates[e])for(const i in this.state[e])t[i]={},this.state[e][i]={};else for(const i in this.deletedStates[e]){if(null===this.deletedStates[e][i])this.state[e][i]={};else for(const t of Object.keys(this.deletedStates[e][i]))delete this.state[e][i][t];t[i]=this.state[e][i];}i[e]=i[e]||{},ee(i[e],t);}if(this.stateChanges={},this.deletedStates={},0!==Object.keys(i).length)for(const r in e)e[r].setFeatureState(i,t);}}class Ld{constructor(e){this.size=e,this.minimums=[],this.maximums=[],this.leaves=[];}getElevation(e,t){const i=this.toIdx(e,t);return {min:this.minimums[i],max:this.maximums[i]};}isLeaf(e,t){return this.leaves[this.toIdx(e,t)];}toIdx(e,t){return t*this.size+e;}}function Dd(e,t,i,r){let n=0,o=Number.MAX_VALUE;for(let s=0;s<3;s++)if(Math.abs(r[s])<1e-15){if(i[s]<e[s]||i[s]>t[s])return null;}else {const a=1/r[s];let l=(e[s]-i[s])*a,c=(t[s]-i[s])*a;if(l>c){const e=l;l=c,c=e;}if(l>n&&(n=l),c<o&&(o=c),n>o)return null;}return n;}function kd(e,t,i,r,n,o,s,a,l,c,h){const u=r-e,d=n-t,p=o-i,f=s-e,m=a-t,_=l-i,g=h[1]*_-h[2]*m,y=h[2]*f-h[0]*_,x=h[0]*m-h[1]*f,v=u*g+d*y+p*x;if(Math.abs(v)<1e-15)return null;const b=1/v,S=c[0]-e,w=c[1]-t,T=c[2]-i,E=(S*g+w*y+T*x)*b;if(E<0||E>1)return null;const N=w*p-T*d,I=T*u-S*p,M=S*d-w*u,C=(h[0]*N+h[1]*I+h[2]*M)*b;return C<0||E+C>1?null:(f*N+m*I+_*M)*b;}function zd(e,t,i){return (e-t)/(i-t);}function Rd(e,t,i,r,n,o,s,a,l){const c=1<<i,h=o-r,u=s-n,d=(e+1)/c*h+r,p=(t+0)/c*u+n,f=(t+1)/c*u+n;a[0]=(e+0)/c*h+r,a[1]=p,l[0]=d,l[1]=f;}class Od{constructor(e){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=e,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const t=function(e){const t=Math.ceil(Math.log2(e.dim/8)),i=[];let r=Math.ceil(Math.pow(2,t));const n=1/r,o=(e,t,i,r,n)=>{const o=r?1:0,s=(e+1)*i-o,a=t*i,l=(t+1)*i-o;n[0]=e*i,n[1]=a,n[2]=s,n[3]=l;};let s=new Ld(r);const a=[];for(let t=0;t<r*r;t++){o(t%r,Math.floor(t/r),n,!1,a);const i=Bd(a[0],a[1],e),l=Bd(a[2],a[1],e),c=Bd(a[2],a[3],e),h=Bd(a[0],a[3],e);s.minimums.push(Math.min(i,l,c,h)),s.maximums.push(Math.max(i,l,c,h)),s.leaves.push(1);}for(i.push(s),r/=2;r>=1;r/=2){const e=i[i.length-1];s=new Ld(r);for(let t=0;t<r*r;t++){o(t%r,Math.floor(t/r),2,!0,a);const i=e.getElevation(a[0],a[1]),n=e.getElevation(a[2],a[1]),l=e.getElevation(a[2],a[3]),c=e.getElevation(a[0],a[3]),h=e.isLeaf(a[0],a[1]),u=e.isLeaf(a[2],a[1]),d=e.isLeaf(a[2],a[3]),p=e.isLeaf(a[0],a[3]),f=Math.min(i.min,n.min,l.min,c.min),m=Math.max(i.max,n.max,l.max,c.max),_=h&&u&&d&&p;s.maximums.push(m),s.minimums.push(f),s.leaves.push(m-f<=5&&_?1:0);}i.push(s);}return i;}(this.dem),i=t.length-1,r=t[i];this._addNode(r.minimums[0],r.maximums[0],r.leaves[0]),this._construct(t,0,0,i,0);}raycastRoot(e,t,i,r,n,o,s=1){return Dd([e,t,-100],[i,r,this.maximums[0]*s],n,o);}raycast(e,t,i,r,n,o,s=1){if(!this.nodeCount)return null;const a=this.raycastRoot(e,t,i,r,n,o,s);if(null==a)return null;const l=[],c=[],h=[],u=[],d=[{idx:0,t:a,nodex:0,nodey:0,depth:0}];for(;d.length>0;){const{idx:a,t:p,nodex:f,nodey:m,depth:_}=d.pop();if(this.leaves[a]){Rd(f,m,_,e,t,i,r,h,u);const a=1<<_,l=(f+0)/a,c=(f+1)/a,d=(m+0)/a,g=(m+1)/a,y=Bd(l,d,this.dem)*s,x=Bd(c,d,this.dem)*s,v=Bd(c,g,this.dem)*s,b=Bd(l,g,this.dem)*s,S=kd(h[0],h[1],y,u[0],h[1],x,u[0],u[1],v,n,o),w=kd(u[0],u[1],v,h[0],u[1],b,h[0],h[1],y,n,o),T=Math.min(null!==S?S:Number.MAX_VALUE,null!==w?w:Number.MAX_VALUE);if(T!==Number.MAX_VALUE)return T;{const e=N([],n,o,p);if(Fd(y,x,b,v,zd(e[0],h[0],u[0]),zd(e[1],h[1],u[1]))>=e[2])return p;}continue;}let g=0;for(let d=0;d<this._siblingOffset.length;d++){Rd((f<<1)+this._siblingOffset[d][0],(m<<1)+this._siblingOffset[d][1],_+1,e,t,i,r,h,u),h[2]=-100,u[2]=this.maximums[this.childOffsets[a]+d]*s;const p=Dd(h,u,n,o);if(null!=p){const e=p;l[d]=e;let t=!1;for(let i=0;i<g&&!t;i++)e>=l[c[i]]&&(c.splice(i,0,d),t=!0);t||(c[g]=d),g++;}}for(let e=0;e<g;e++){const t=c[e];d.push({idx:this.childOffsets[a]+t,t:l[t],nodex:(f<<1)+this._siblingOffset[t][0],nodey:(m<<1)+this._siblingOffset[t][1],depth:_+1});}}return null;}_addNode(e,t,i){return this.minimums.push(e),this.maximums.push(t),this.leaves.push(i),this.childOffsets.push(0),this.nodeCount++;}_construct(e,t,i,r,n){if(1===e[r].isLeaf(t,i))return;this.childOffsets[n]||(this.childOffsets[n]=this.nodeCount);const o=r-1,s=e[o];let a,l=0;for(let e=0;e<this._siblingOffset.length;e++){const r=2*t+this._siblingOffset[e][0],n=2*i+this._siblingOffset[e][1],o=s.getElevation(r,n),c=s.isLeaf(r,n),h=this._addNode(o.min,o.max,c);c&&(l|=1<<e),a||(a=h);}for(let r=0;r<this._siblingOffset.length;r++)l&1<<r||this._construct(e,2*t+this._siblingOffset[r][0],2*i+this._siblingOffset[r][1],o,a+r);}}function Fd(e,t,i,r,n,o){return Oi(Oi(e,i,o),Oi(t,r,o),n);}function Bd(e,t,i){const r=i.dim,n=W(e*r-.5,0,r-1),o=W(t*r-.5,0,r-1),s=Math.floor(n),a=Math.floor(o),l=Math.min(s+1,r-1),c=Math.min(a+1,r-1);return Fd(i.get(s,a),i.get(l,a),i.get(s,c),i.get(l,c),n-s,o-a);}const Ud={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};class Vd{get tree(){return this._tree||this._buildQuadTree(),this._tree;}constructor(e,t,i,r=!1,n=!1){if(this.uid=e,t.height!==t.width)throw new RangeError("DEM tiles must be square");if(i&&"mapbox"!==i&&"terrarium"!==i)return de(`"${i}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=t.height;const o=this.dim=t.height-2;if(this.data=new Uint32Array(t.data.buffer),this.encoding=i||"mapbox",this.borderReady=r,!r){for(let e=0;e<o;e++)this.data[this._idx(-1,e)]=this.data[this._idx(0,e)],this.data[this._idx(o,e)]=this.data[this._idx(o-1,e)],this.data[this._idx(e,-1)]=this.data[this._idx(e,0)],this.data[this._idx(e,o)]=this.data[this._idx(e,o-1)];this.data[this._idx(-1,-1)]=this.data[this._idx(0,0)],this.data[this._idx(o,-1)]=this.data[this._idx(o-1,0)],this.data[this._idx(-1,o)]=this.data[this._idx(0,o-1)],this.data[this._idx(o,o)]=this.data[this._idx(o-1,o-1)],n&&this._buildQuadTree();}}_buildQuadTree(){this._tree=new Od(this);}get(e,t,i=!1){const r=new Uint8Array(this.data.buffer);i&&(e=W(e,-1,this.dim),t=W(t,-1,this.dim));const n=4*this._idx(e,t);return ("terrarium"===this.encoding?this._unpackTerrarium:this._unpackMapbox)(r[n],r[n+1],r[n+2]);}static getUnpackVector(e){return Ud[e];}get unpackVector(){return Ud[this.encoding];}_idx(e,t){if(e<-1||e>=this.dim+1||t<-1||t>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return (t+1)*this.stride+(e+1);}_unpackMapbox(e,t,i){return (256*e*256+256*t+i)/10-1e4;}_unpackTerrarium(e,t,i){return 256*e+t+i/256-32768;}static pack(e,t){const i=[0,0,0,0],r=Vd.getUnpackVector(t);let n=Math.floor((e+r[3])/r[2]);return i[2]=n%256,n=Math.floor(n/256),i[1]=n%256,n=Math.floor(n/256),i[0]=n,i;}getPixels(){return new Ml({width:this.stride,height:this.stride},new Uint8Array(this.data.buffer));}backfillBorder(e,t,i){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let r=t*this.dim,n=t*this.dim+this.dim,o=i*this.dim,s=i*this.dim+this.dim;switch(t){case-1:r=n-1;break;case 1:n=r+1;}switch(i){case-1:o=s-1;break;case 1:s=o+1;}const a=-t*this.dim,l=-i*this.dim;for(let t=o;t<s;t++)for(let i=r;i<n;i++)this.data[this._idx(i,t)]=e.data[this._idx(i+a,t+l)];}onDeserialize(){this._tree&&(this._tree.dem=this);}}qn("DEMData",Vd),qn("DemMinMaxQuadTree",Od,{omit:["dem"]});class Gd{constructor(e,t){this.max=e,this.onRemove=t,this.reset();}reset(){for(const e in this.data)for(const t of this.data[e])t.timeout&&clearTimeout(t.timeout),this.onRemove(t.value);return this.data={},this.order=[],this;}add(e,t,i){const r=e.wrapped().key;void 0===this.data[r]&&(this.data[r]=[]);const n={value:t,timeout:void 0};if(void 0!==i&&(n.timeout=setTimeout(()=>{this.remove(e,n);},i)),this.data[r].push(n),this.order.push(r),this.order.length>this.max){const e=this._getAndRemoveByKey(this.order[0]);e&&this.onRemove(e);}return this;}has(e){return e.wrapped().key in this.data;}getAndRemove(e){return this.has(e)?this._getAndRemoveByKey(e.wrapped().key):null;}_getAndRemoveByKey(e){const t=this.data[e].shift();return t.timeout&&clearTimeout(t.timeout),0===this.data[e].length&&delete this.data[e],this.order.splice(this.order.indexOf(e),1),t.value;}getByKey(e){const t=this.data[e];return t?t[0].value:null;}get(e){return this.has(e)?this.data[e.wrapped().key][0].value:null;}remove(e,t){if(!this.has(e))return this;const i=e.wrapped().key,r=void 0===t?0:this.data[i].indexOf(t),n=this.data[i][r];return this.data[i].splice(r,1),n.timeout&&clearTimeout(n.timeout),0===this.data[i].length&&delete this.data[i],this.onRemove(n.value),this.order.splice(this.order.indexOf(i),1),this;}setMaxSize(e){for(this.max=e;this.order.length>this.max;){const e=this._getAndRemoveByKey(this.order[0]);e&&this.onRemove(e);}return this;}filter(e){const t=[];for(const i in this.data)for(const r of this.data[i])e(r.value)||t.push(r);for(const e of t)this.remove(e.value.tileID,e);}}class jd extends yt{constructor(e,t,i){super(),this.id=e,this._onlySymbols=i,t.on("data",e=>{"source"===e.dataType&&"metadata"===e.sourceDataType&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&"source"===e.dataType&&"content"===e.sourceDataType&&(this.reload(),this.transform&&this.update(this.transform));}),t.on("error",()=>{this._sourceErrored=!0;}),this._source=t,this._tiles={},this._cache=new Gd(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=null,this._maxTileCacheSize=null,this._loadedParentTiles={},this._coveredTiles={},this._state=new Pd();}onAdd(e){this.map=e,this._minTileCacheSize=e?e._minTileCacheSize:null,this._maxTileCacheSize=e?e._maxTileCacheSize:null;}loaded(){if(this._sourceErrored)return !0;if(!this._sourceLoaded)return !1;if(!this._source.loaded())return !1;for(const e in this._tiles){const t=this._tiles[e];if("loaded"!==t.state&&"errored"!==t.state)return !1;}return !0;}getSource(){return this._source;}pause(){this._paused=!0;}resume(){if(!this._paused)return;const e=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,e&&this.reload(),this.transform&&this.update(this.transform);}_loadTile(e,t){return e.isSymbolTile=this._onlySymbols,this._source.loadTile(e,t);}_unloadTile(e){if(this._source.unloadTile)return this._source.unloadTile(e,()=>{});}_abortTile(e){if(this._source.abortTile)return this._source.abortTile(e,()=>{});}serialize(){return this._source.serialize();}prepare(e){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const t in this._tiles){const i=this._tiles[t];i.upload(e),i.prepare(this.map.style.imageManager);}}getIds(){return Q(this._tiles).map(e=>e.tileID).sort($d).map(e=>e.key);}getRenderableIds(e){const t=[];for(const i in this._tiles)this._isIdRenderable(+i,e)&&t.push(this._tiles[i]);return e?t.sort((e,t)=>{const i=e.tileID,r=t.tileID,o=new n(i.canonical.x,i.canonical.y)._rotate(this.transform.angle),s=new n(r.canonical.x,r.canonical.y)._rotate(this.transform.angle);return i.overscaledZ-r.overscaledZ||s.y-o.y||s.x-o.x;}).map(e=>e.tileID.key):t.map(e=>e.tileID).sort($d).map(e=>e.key);}hasRenderableParent(e){const t=this.findLoadedParent(e,0);return !!t&&this._isIdRenderable(t.tileID.key);}_isIdRenderable(e,t){return this._tiles[e]&&this._tiles[e].hasData()&&!this._coveredTiles[e]&&(t||!this._tiles[e].holdingForFade());}reload(){if(this._paused)this._shouldReloadOnResume=!0;else {this._cache.reset();for(const e in this._tiles)"errored"!==this._tiles[e].state&&this._reloadTile(+e,"reloading");}}_reloadTile(e,t){const i=this._tiles[e];i&&("loading"!==i.state&&(i.state=t),this._loadTile(i,this._tileLoaded.bind(this,i,e,t)));}_tileLoaded(e,t,i,r){if(r){if(e.state="errored",404!==r.status)this._source.fire(new gt(r,{tile:e}));else if("raster-dem"===this._source.type&&this.usedForTerrain&&this.map.painter.terrain){const e=this.map.painter.terrain;this.update(this.transform,e.getScaledDemTileSize(),!0),e.resetTileLookupCache(this.id);}else this.update(this.transform);}else e.timeAdded=we.now(),"expired"===i&&(e.refreshedUponExpiration=!0),this._setTileReloadTimer(t,e),"raster-dem"===this._source.type&&e.dem&&this._backfillDEM(e),this._state.initializeTileState(e,this.map?this.map.painter:null),this._source.fire(new _t("data",{dataType:"source",tile:e,coord:e.tileID,sourceCacheId:this.id}));}_backfillDEM(e){const t=this.getRenderableIds();for(let r=0;r<t.length;r++){const n=t[r];if(e.neighboringTiles&&e.neighboringTiles[n]){const t=this.getTileByID(n);i(e,t),i(t,e);}}function i(e,t){if(!e.dem||e.dem.borderReady)return;e.needsHillshadePrepare=!0,e.needsDEMTextureUpload=!0;let i=t.tileID.canonical.x-e.tileID.canonical.x;const r=t.tileID.canonical.y-e.tileID.canonical.y,n=Math.pow(2,e.tileID.canonical.z),o=t.tileID.key;0===i&&0===r||Math.abs(r)>1||(Math.abs(i)>1&&(1===Math.abs(i+n)?i+=n:1===Math.abs(i-n)&&(i-=n)),t.dem&&e.dem&&(e.dem.backfillBorder(t.dem,i,r),e.neighboringTiles&&e.neighboringTiles[o]&&(e.neighboringTiles[o].backfilled=!0)));}}getTile(e){return this.getTileByID(e.key);}getTileByID(e){return this._tiles[e];}_retainLoadedChildren(e,t,i,r){for(const n in this._tiles){let o=this._tiles[n];if(r[n]||!o.hasData()||o.tileID.overscaledZ<=t||o.tileID.overscaledZ>i)continue;let s=o.tileID;for(;o&&o.tileID.overscaledZ>t+1;){const e=o.tileID.scaledTo(o.tileID.overscaledZ-1);o=this._tiles[e.key],o&&o.hasData()&&(s=e);}let a=s;for(;a.overscaledZ>t;)if(a=a.scaledTo(a.overscaledZ-1),e[a.key]){r[s.key]=s;break;}}}findLoadedParent(e,t){if(e.key in this._loadedParentTiles){const i=this._loadedParentTiles[e.key];return i&&i.tileID.overscaledZ>=t?i:null;}for(let i=e.overscaledZ-1;i>=t;i--){const t=e.scaledTo(i),r=this._getLoadedTile(t);if(r)return r;}}_getLoadedTile(e){const t=this._tiles[e.key];return t&&t.hasData()?t:this._cache.getByKey(this._source.reparseOverscaled?e.wrapped().key:e.canonical.key);}updateCacheSize(e,t){t=t||this._source.tileSize;const i=Math.ceil(e.width/t)+1,r=Math.ceil(e.height/t)+1,n=Math.floor(i*r*5),o="number"==typeof this._minTileCacheSize?Math.max(this._minTileCacheSize,n):n,s="number"==typeof this._maxTileCacheSize?Math.min(this._maxTileCacheSize,o):o;this._cache.setMaxSize(s);}handleWrapJump(e){const t=Math.round((e-(void 0===this._prevLng?e:this._prevLng))/360);if(this._prevLng=e,t){const e={};for(const i in this._tiles){const r=this._tiles[i];r.tileID=r.tileID.unwrapTo(r.tileID.wrap+t),e[r.tileID.key]=r;}this._tiles=e;for(const e in this._timers)clearTimeout(this._timers[e]),delete this._timers[e];for(const e in this._tiles)this._setTileReloadTimer(+e,this._tiles[e]);}}update(e,t,i){if(this.transform=e,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage)return;if(this.usedForTerrain&&!i)return;let r;this.updateCacheSize(e,t),"globe"!==this.transform.projection.name&&this.handleWrapJump(this.transform.center.lng),this._coveredTiles={},this.used||this.usedForTerrain?this._source.tileID?r=e.getVisibleUnwrappedCoordinates(this._source.tileID).map(e=>new vd(e.canonical.z,e.wrap,e.canonical.z,e.canonical.x,e.canonical.y)):(r=e.coveringTiles({tileSize:t||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!i,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain}),this._source.hasTile&&(r=r.filter(e=>this._source.hasTile(e)))):r=[];const n=this._updateRetainedTiles(r);if(Hd(this._source.type)&&0!==r.length){const e={},t={},i=Object.keys(n);for(const r of i){const i=n[r],o=this._tiles[r];if(!o||o.fadeEndTime&&o.fadeEndTime<=we.now())continue;const s=this.findLoadedParent(i,Math.max(i.overscaledZ-jd.maxOverzooming,this._source.minzoom));s&&(this._addTile(s.tileID),e[s.tileID.key]=s.tileID),t[r]=i;}const o=r[r.length-1].overscaledZ;for(const e in this._tiles){const i=this._tiles[e];if(n[e]||!i.hasData())continue;let r=i.tileID;for(;r.overscaledZ>o;){r=r.scaledTo(r.overscaledZ-1);const o=this._tiles[r.key];if(o&&o.hasData()&&t[r.key]){n[e]=i.tileID;break;}}}for(const t in e)n[t]||(this._coveredTiles[t]=!0,n[t]=e[t]);}for(const e in n)this._tiles[e].clearFadeHold();const o=function(e,t){const i=[];for(const r in e)r in t||i.push(r);return i;}(this._tiles,n);for(const e of o){const t=this._tiles[e];t.hasSymbolBuckets&&!t.holdingForFade()?t.setHoldDuration(this.map._fadeDuration):t.hasSymbolBuckets&&!t.symbolFadeFinished()||this._removeTile(+e);}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate();}releaseSymbolFadeTiles(){for(const e in this._tiles)this._tiles[e].holdingForFade()&&this._removeTile(+e);}_updateRetainedTiles(e){const t={};if(0===e.length)return t;const i={},r=e.reduce((e,t)=>Math.min(e,t.overscaledZ),1/0),n=e[0].overscaledZ,o=Math.max(n-jd.maxOverzooming,this._source.minzoom),s=Math.max(n+jd.maxUnderzooming,this._source.minzoom),a={};for(const i of e){const e=this._addTile(i);t[i.key]=i,e.hasData()||r<this._source.maxzoom&&(a[i.key]=i);}this._retainLoadedChildren(a,r,s,t);for(const r of e){let e=this._tiles[r.key];if(e.hasData())continue;if(r.canonical.z>=this._source.maxzoom){const e=r.children(this._source.maxzoom)[0],i=this.getTile(e);if(i&&i.hasData()){t[e.key]=e;continue;}}else {const e=r.children(this._source.maxzoom);if(t[e[0].key]&&t[e[1].key]&&t[e[2].key]&&t[e[3].key])continue;}let n=e.wasRequested();for(let s=r.overscaledZ-1;s>=o;--s){const o=r.scaledTo(s);if(i[o.key])break;if(i[o.key]=!0,e=this.getTile(o),!e&&n&&(e=this._addTile(o)),e&&(t[o.key]=o,n=e.wasRequested(),e.hasData()))break;}}return t;}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const e in this._tiles){const t=[];let i,r=this._tiles[e].tileID;for(;r.overscaledZ>0;){if(r.key in this._loadedParentTiles){i=this._loadedParentTiles[r.key];break;}t.push(r.key);const e=r.scaledTo(r.overscaledZ-1);if(i=this._getLoadedTile(e),i)break;r=e;}for(const e of t)this._loadedParentTiles[e]=i;}}_addTile(e){let t=this._tiles[e.key];if(t)return t;t=this._cache.getAndRemove(e),t&&(this._setTileReloadTimer(e.key,t),t.tileID=e,this._state.initializeTileState(t,this.map?this.map.painter:null),this._cacheTimers[e.key]&&(clearTimeout(this._cacheTimers[e.key]),delete this._cacheTimers[e.key],this._setTileReloadTimer(e.key,t)));const i=Boolean(t);if(!i){const i=this.map?this.map.painter:null,r="raster"===this._source.type||"raster-dem"===this._source.type;t=new sp(e,this._source.tileSize*e.overscaleFactor(),this.transform.tileZoom,i,r),this._loadTile(t,this._tileLoaded.bind(this,t,e.key,t.state));}return t?(t.uses++,this._tiles[e.key]=t,i||this._source.fire(new _t("dataloading",{tile:t,coord:t.tileID,dataType:"source"})),t):null;}_setTileReloadTimer(e,t){e in this._timers&&(clearTimeout(this._timers[e]),delete this._timers[e]);const i=t.getExpiryTimeout();i&&(this._timers[e]=setTimeout(()=>{this._reloadTile(e,"expired"),delete this._timers[e];},i));}_removeTile(e){const t=this._tiles[e];t&&(t.uses--,delete this._tiles[e],this._timers[e]&&(clearTimeout(this._timers[e]),delete this._timers[e]),t.uses>0||(t.hasData()&&"reloading"!==t.state?this._cache.add(t.tileID,t,t.getExpiryTimeout()):(t.aborted=!0,this._abortTile(t),this._unloadTile(t))));}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const e in this._tiles)this._removeTile(+e);this._source._clear&&this._source._clear(),this._cache.reset();}tilesIn(e,t,i){const r=[],n=this.transform;if(!n)return r;for(const o in this._tiles){const s=this._tiles[o];if(i&&s.clearQueryDebugViz(),s.holdingForFade())continue;const a=e.containsTile(s,n,t);a&&r.push(a);}return r;}getVisibleCoordinates(e){const t=this.getRenderableIds(e).map(e=>this._tiles[e].tileID);for(const e of t)e.projMatrix=this.transform.calculateProjMatrix(e.toUnwrapped());return t;}hasTransition(){if(this._source.hasTransition())return !0;if(Hd(this._source.type))for(const e in this._tiles){const t=this._tiles[e];if(void 0!==t.fadeEndTime&&t.fadeEndTime>=we.now())return !0;}return !1;}setFeatureState(e,t,i){this._state.updateState(e=e||"_geojsonTileLayer",t,i);}removeFeatureState(e,t,i){this._state.removeFeatureState(e=e||"_geojsonTileLayer",t,i);}getFeatureState(e,t){return this._state.getState(e=e||"_geojsonTileLayer",t);}setDependencies(e,t,i){const r=this._tiles[e];r&&r.setDependencies(t,i);}reloadTilesForDependencies(e,t){for(const i in this._tiles)this._tiles[i].hasDependency(e,t)&&this._reloadTile(+i,"reloading");this._cache.filter(i=>!i.hasDependency(e,t));}_preloadTiles(e,t){const i=new Map(),r=Array.isArray(e)?e:[e],n=this.map.painter.terrain,o=this.usedForTerrain&&n?n.getScaledDemTileSize():this._source.tileSize;for(const e of r){const t=e.coveringTiles({tileSize:o,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const e of t)i.set(e.key,e);this.usedForTerrain&&e.updateElevation(!1);}const s=Array.from(i.values()),a="raster"===this._source.type||"raster-dem"===this._source.type;K(s,(e,t)=>{const i=new sp(e,this._source.tileSize*e.overscaleFactor(),this.transform.tileZoom,this.map.painter,a);this._loadTile(i,e=>{"raster-dem"===this._source.type&&i.dem&&this._backfillDEM(i),t(e,i);});},t);}}function $d(e,t){const i=Math.abs(2*e.wrap)-+(e.wrap<0),r=Math.abs(2*t.wrap)-+(t.wrap<0);return e.overscaledZ-t.overscaledZ||r-i||t.canonical.y-e.canonical.y||t.canonical.x-e.canonical.x;}function Hd(e){return "raster"===e||"image"===e||"video"===e;}jd.maxOverzooming=10,jd.maxUnderzooming=3;class qd{constructor(e,t,i){this._demTile=e,this._dem=this._demTile.dem,this._scale=t,this._offset=i;}static create(e,t,i){const r=i||e.findDEMTileFor(t);if(!r||!r.dem)return;const n=r.dem,o=r.tileID,s=1<<t.canonical.z-o.canonical.z;return new qd(r,r.tileSize/Ca/s,[(t.canonical.x/s-o.canonical.x)*n.dim,(t.canonical.y/s-o.canonical.y)*n.dim]);}tileCoordToPixel(e,t){const i=t*this._scale+this._offset[1],r=Math.floor(e*this._scale+this._offset[0]),o=Math.floor(i);return new n(r,o);}getElevationAt(e,t,i,r){const n=e*this._scale+this._offset[0],o=t*this._scale+this._offset[1],s=Math.floor(n),a=Math.floor(o),l=this._dem;return r=!!r,i?Oi(Oi(l.get(s,a,r),l.get(s,a+1,r),o-a),Oi(l.get(s+1,a,r),l.get(s+1,a+1,r),o-a),n-s):l.get(s,a,r);}getElevationAtPixel(e,t,i){return this._dem.get(e,t,!!i);}getMeterToDEM(e){return (1<<this._demTile.tileID.canonical.z)*Oa(1,e)*this._dem.stride;}}class Zd{constructor(e,t){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new Vn(Ca,16,0),this.featureIndexArray=new Hs(),this.promoteId=t;}insert(e,t,i,r,n,o=0){const s=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(i,r,n,o);const a=this.grid;for(let e=0;e<t.length;e++){const i=t[e],r=[1/0,1/0,-1/0,-1/0];for(let e=0;e<i.length;e++){const t=i[e];r[0]=Math.min(r[0],t.x),r[1]=Math.min(r[1],t.y),r[2]=Math.max(r[2],t.x),r[3]=Math.max(r[3],t.y);}r[0]<Ca&&r[1]<Ca&&r[2]>=0&&r[3]>=0&&a.insert(s,r[0],r[1],r[2],r[3]);}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new Ac.VectorTile(new gh(this.rawTileData)).layers,this.sourceLayerCoder=new Cd(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const e in this.vtLayers)this.vtFeatures[e]=[];}return this.vtLayers;}query(e,t,i,r){this.loadVTLayers();const n=e.params||{},o=on(n.filter),s=e.tileResult,a=e.transform,l=s.bufferedTilespaceBounds,c=this.grid.query(l.min.x,l.min.y,l.max.x,l.max.y,(e,t,i,r)=>ll(s.bufferedTilespaceGeometry,e,t,i,r));c.sort(Wd);let h=null;a.elevation&&c.length>0&&(h=qd.create(a.elevation,this.tileID));const u={};let d;for(let a=0;a<c.length;a++){const l=c[a];if(l===d)continue;d=l;const p=this.featureIndexArray.get(l);let f=null;this.loadMatchingFeature(u,p,o,n.layers,n.availableImages,t,i,r,(t,i,r,n=0)=>(f||(f=Xa(t,this.tileID.canonical,e.tileTransform)),i.queryIntersectsFeature(s,t,r,f,this.z,e.transform,e.pixelPosMatrix,h,n)));}return u;}loadMatchingFeature(e,t,i,r,n,o,s,a,l){const{featureIndex:c,bucketIndex:h,sourceLayerIndex:u,layoutVertexArrayOffset:d}=t,p=this.bucketLayerIDs[h];if(r&&!function(e,t){for(let i=0;i<e.length;i++)if(t.indexOf(e[i])>=0)return !0;return !1;}(r,p))return;const f=this.sourceLayerCoder.decode(u),m=this.vtLayers[f].feature(c);if(i.needGeometry){const e=Wa(m,!0);if(!i.filter(new qo(this.tileID.overscaledZ),e,this.tileID.canonical))return;}else if(!i.filter(new qo(this.tileID.overscaledZ),m))return;const _=this.getId(m,f);for(let t=0;t<p.length;t++){const i=p[t];if(r&&r.indexOf(i)<0)continue;const h=o[i];if(!h)continue;let u={};void 0!==_&&a&&(u=a.getState(h.sourceLayer||"_geojsonTileLayer",_));const f=ee({},s[i]);f.paint=Xd(f.paint,h.paint,m,u,n),f.layout=Xd(f.layout,h.layout,m,u,n);const g=!l||l(m,h,u,d);if(!g)continue;const y=new Ad(m,this.z,this.x,this.y,_);y.layer=f;let x=e[i];void 0===x&&(x=e[i]=[]),x.push({featureIndex:c,feature:y,intersectionZ:g});}}lookupSymbolFeatures(e,t,i,r,n,o,s,a){const l={};this.loadVTLayers();const c=on(n);for(const n of e)this.loadMatchingFeature(l,{bucketIndex:i,sourceLayerIndex:r,featureIndex:n,layoutVertexArrayOffset:0},c,o,s,a,t);return l;}loadFeature(e){const{featureIndex:t,sourceLayerIndex:i}=e;this.loadVTLayers();const r=this.sourceLayerCoder.decode(i),n=this.vtFeatures[r];if(n[t])return n[t];const o=this.vtLayers[r].feature(t);return n[t]=o,o;}hasLayer(e){for(const t of this.bucketLayerIDs)for(const i of t)if(e===i)return !0;return !1;}getId(e,t){let i=e.id;return this.promoteId&&(i=e.properties["string"==typeof this.promoteId?this.promoteId:this.promoteId[t]],"boolean"==typeof i&&(i=Number(i))),i;}}function Xd(e,t,i,r,n){return le(e,(e,o)=>{const s=t instanceof es?t.get(o):null;return s&&s.evaluate?s.evaluate(i,r,n):s;});}function Wd(e,t){return t-e;}qn("FeatureIndex",Zd,{omit:["rawTileData","sourceLayerCoder"]});var Yd=us([{name:"a_pos",type:"Int16",components:2}]);const Jd=32,Kd=33,Qd=new Uint16Array(8184);for(let e=0;e<2046;e++){let t=e+2,i=0,r=0,n=0,o=0,s=0,a=0;for(1&t?n=o=s=Jd:i=r=a=Jd;(t>>=1)>1;){const e=i+n>>1,l=r+o>>1;1&t?(n=i,o=r,i=s,r=a):(i=n,r=o,n=s,o=a),s=e,a=l;}const l=4*e;Qd[l+0]=i,Qd[l+1]=r,Qd[l+2]=n,Qd[l+3]=o;}const ep=new Uint16Array(2178),tp=new Uint8Array(1089),ip=new Uint16Array(1089);function rp(e){return 0===e?-.03125:32===e?.03125:0;}var np=us([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);const op={type:2,extent:Ca,loadGeometry:()=>[[new n(0,0),new n(8193,0),new n(8193,8193),new n(0,8193),new n(0,0)]]};class sp{constructor(e,t,i,r,n){this.tileID=e,this.uid=ie(),this.uses=0,this.tileSize=t,this.tileZoom=i,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=n,this.expiredRequestCount=0,this.state="loading",r&&r.transform&&(this.projection=r.transform.projection);}registerFadeDuration(e){const t=e+this.timeAdded;t<we.now()||this.fadeEndTime&&t<this.fadeEndTime||(this.fadeEndTime=t);}wasRequested(){return "errored"===this.state||"loaded"===this.state||"reloading"===this.state;}get tileTransform(){return this._tileTransform||(this._tileTransform=wp(this.tileID.canonical,this.projection)),this._tileTransform;}loadVectorData(e,t,i){if(this.unloadVectorData(),this.state="loaded",e){e.featureIndex&&(this.latestFeatureIndex=e.featureIndex,e.rawTileData?(this.latestRawTileData=e.rawTileData,this.latestFeatureIndex.rawTileData=e.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=e.collisionBoxArray,this.buckets=function(e,t){const i={};if(!t)return i;for(const r of e){const e=r.layerIds.map(e=>t.getLayer(e)).filter(Boolean);if(0!==e.length){r.layers=e,r.stateDependentLayerIds&&(r.stateDependentLayers=r.stateDependentLayerIds.map(t=>e.filter(e=>e.id===t)[0]));for(const t of e)i[t.id]=r;}}return i;}(e.buckets,t.style),this.hasSymbolBuckets=!1;for(const e in this.buckets){const t=this.buckets[e];if(t instanceof Wu){if(this.hasSymbolBuckets=!0,!i)break;t.justReloaded=!0;}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const e in this.buckets){const t=this.buckets[e];if(t instanceof Wu&&t.hasRTLText){this.hasRTLText=!0,Ho.isLoading()||Ho.isLoaded()||"deferred"!==jo()||$o();break;}}this.queryPadding=0;for(const e in this.buckets){const i=this.buckets[e];this.queryPadding=Math.max(this.queryPadding,t.style.getLayer(e).queryRadius(i));}e.imageAtlas&&(this.imageAtlas=e.imageAtlas),e.glyphAtlasImage&&(this.glyphAtlasImage=e.glyphAtlasImage),e.lineAtlas&&(this.lineAtlas=e.lineAtlas);}else this.collisionBoxArray=new Os();}unloadVectorData(){if(this.hasData()){for(const e in this.buckets)this.buckets[e].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugIndexBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this.globeGridBuffer&&(this.globeGridBuffer.destroy(),this.globeGridBuffer=null),this.globePoleBuffer&&(this.globePoleBuffer.destroy(),this.globePoleBuffer=null),this.latestFeatureIndex=null,this.state="unloaded";}}getBucket(e){return this.buckets[e.id];}upload(e){for(const t in this.buckets){const i=this.buckets[t];i.uploadPending()&&i.upload(e);}const t=e.gl;this.imageAtlas&&!this.imageAtlas.uploaded&&(this.imageAtlasTexture=new ud(e,this.imageAtlas.image,t.RGBA),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new ud(e,this.glyphAtlasImage,t.ALPHA),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new ud(e,this.lineAtlas.image,t.ALPHA),this.lineAtlas.uploaded=!0);}prepare(e){this.imageAtlas&&this.imageAtlas.patchUpdatedImages(e,this.imageAtlasTexture);}queryRenderedFeatures(e,t,i,r,n,o,s,a){return this.latestFeatureIndex&&this.latestFeatureIndex.rawTileData?this.latestFeatureIndex.query({tileResult:r,pixelPosMatrix:s,transform:o,params:n,tileTransform:this.tileTransform},e,t,i):{};}querySourceFeatures(e,t){const i=this.latestFeatureIndex;if(!i||!i.rawTileData)return;const r=i.loadVTLayers(),n=t?t.sourceLayer:"",o=r._geojsonTileLayer||r[n];if(!o)return;const s=on(t&&t.filter),{z:a,x:l,y:c}=this.tileID.canonical,h={z:a,x:l,y:c};for(let t=0;t<o.length;t++){const r=o.feature(t);if(s.needGeometry){const e=Wa(r,!0);if(!s.filter(new qo(this.tileID.overscaledZ),e,this.tileID.canonical))continue;}else if(!s.filter(new qo(this.tileID.overscaledZ),r))continue;const u=i.getId(r,n),d=new Ad(r,a,l,c,u);d.tile=h,e.push(d);}}hasData(){return "loaded"===this.state||"reloading"===this.state||"expired"===this.state;}patternsLoaded(){return this.imageAtlas&&!!Object.keys(this.imageAtlas.patternPositions).length;}setExpiryData(e){const t=this.expirationTime;if(e.cacheControl){const t=_e(e.cacheControl);t["max-age"]&&(this.expirationTime=Date.now()+1e3*t["max-age"]);}else e.expires&&(this.expirationTime=new Date(e.expires).getTime());if(this.expirationTime){const e=Date.now();let i=!1;if(this.expirationTime>e)i=!1;else if(t){if(this.expirationTime<t)i=!0;else {const r=this.expirationTime-t;r?this.expirationTime=e+Math.max(r,3e4):i=!0;}}else i=!0;i?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0;}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1);}setFeatureState(e,t){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData||0===Object.keys(e).length||!t)return;const i=this.latestFeatureIndex.loadVTLayers(),r=t.style.listImages();for(const n in this.buckets){if(!t.style.hasLayer(n))continue;const o=this.buckets[n],s=o.layers[0].sourceLayer||"_geojsonTileLayer",a=i[s],l=e[s];if(!a||!l||0===Object.keys(l).length)continue;if(o.update(l,a,r,this.imageAtlas&&this.imageAtlas.patternPositions||{}),o instanceof Xc||o instanceof _c){const e=t.style._getSourceCache(o.layers[0].source);t._terrain&&t._terrain.enabled&&e&&o.programConfigurations.needsUpload&&t._terrain._clearRenderCacheForTile(e.id,this.tileID);}const c=t&&t.style&&t.style.getLayer(n);c&&(this.queryPadding=Math.max(this.queryPadding,c.queryRadius(o)));}}holdingForFade(){return void 0!==this.symbolFadeHoldUntil;}symbolFadeFinished(){return !this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<we.now();}clearFadeHold(){this.symbolFadeHoldUntil=void 0;}setHoldDuration(e){this.symbolFadeHoldUntil=we.now()+e;}setDependencies(e,t){const i={};for(const e of t)i[e]=!0;this.dependencies[e]=i;}hasDependency(e,t){for(const i of e){const e=this.dependencies[i];if(e)for(const i of t)if(e[i])return !0;}return !1;}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(e,t){if(!t||"mercator"===t.name||this._tileDebugBuffer)return;const i=Xa(op,this.tileID.canonical,this.tileTransform)[0],r=new ps(),n=new Ds();for(let e=0;e<i.length;e++){const{x:t,y:o}=i[e];r.emplaceBack(t,o),n.emplaceBack(e);}n.emplaceBack(0),this._tileDebugIndexBuffer=e.createIndexBuffer(n),this._tileDebugBuffer=e.createVertexBuffer(r,np.members),this._tileDebugSegments=Ma.simpleSegment(0,0,r.length,n.length);}_makeTileBoundsBuffers(e,t){if(this._tileBoundsBuffer||!t||"mercator"===t.name)return;const i=Xa(op,this.tileID.canonical,this.tileTransform)[0];let r,n;if(this.isRaster){const e=function(e,t){const i=wp(e,t),r=Math.pow(2,e.z);for(let n=0;n<Kd;n++)for(let o=0;o<Kd;o++){const s=Fa((e.x+(o+rp(o))/Jd)/r),a=Ba((e.y+(n+rp(n))/Jd)/r),l=t.project(s,a),c=n*Kd+o;ep[2*c+0]=Math.round((l.x*i.scale-i.x)*Ca),ep[2*c+1]=Math.round((l.y*i.scale-i.y)*Ca);}tp.fill(0),ip.fill(0);for(let e=2045;e>=0;e--){const t=4*e,i=Qd[t+0],r=Qd[t+1],n=Qd[t+2],o=Qd[t+3],s=i+n>>1,a=r+o>>1,l=s+a-r,c=a+i-s,h=r*Kd+i,u=o*Kd+n,d=a*Kd+s,p=Math.hypot((ep[2*h+0]+ep[2*u+0])/2-ep[2*d+0],(ep[2*h+1]+ep[2*u+1])/2-ep[2*d+1])>=16;if(tp[d]=tp[d]||(p?1:0),e<1022){const e=(r+c>>1)*Kd+(i+l>>1),t=(o+c>>1)*Kd+(n+l>>1);tp[d]=tp[d]||tp[e]||tp[t];}}const n=new fs(),o=new Es();let s=0;function a(e,t){const i=t*Kd+e;return 0===ip[i]&&(n.emplaceBack(ep[2*i+0],ep[2*i+1],e*Ca/Jd,t*Ca/Jd),ip[i]=++s),ip[i]-1;}function l(e,t,i,r,n,s){const c=e+i>>1,h=t+r>>1;if(Math.abs(e-n)+Math.abs(t-s)>1&&tp[h*Kd+c])l(n,s,e,t,c,h),l(i,r,n,s,c,h);else {const l=a(e,t),c=a(i,r),h=a(n,s);o.emplaceBack(l,c,h);}}return l(0,0,Jd,Jd,Jd,0),l(Jd,Jd,0,0,0,Jd),{vertices:n,indices:o};}(this.tileID.canonical,t);r=e.vertices,n=e.indices;}else {r=new fs(),n=new Es();for(const{x:e,y:t}of i)r.emplaceBack(e,t,0,0);const e=kl(r.int16,void 0,4);for(let t=0;t<e.length;t+=3)n.emplaceBack(e[t],e[t+1],e[t+2]);}this._tileBoundsBuffer=e.createVertexBuffer(r,np.members),this._tileBoundsIndexBuffer=e.createIndexBuffer(n),this._tileBoundsSegments=Ma.simpleSegment(0,0,r.length,n.length);}}const ap=us([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_merc_pos",components:2},{type:"Float32",name:"a_uv",components:2}]),lp=us([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:cp}=ap;function hp(e,t){const i=e.fovAboveCenter,r=e.elevation?e.elevation.getMinElevationBelowMSL()*t:0,n=(e._camera.position[2]*e.worldSize-r)/Math.cos(e._pitch),o=Math.sin(i)*n/Math.sin(Math.max(Math.PI/2-e._pitch-i,.01)),s=Math.sin(e._pitch)*o+n;return Math.min(1.01*s,n*(1/e._horizonShift));}const up=Ca/Math.PI/2,dp=-up,pp=up,fp=[new gl([dp,dp,dp],[pp,pp,pp]),new gl([dp,dp,dp],[0,0,pp]),new gl([0,dp,dp],[pp,0,pp]),new gl([dp,0,dp],[0,pp,pp]),new gl([0,0,dp],[pp,pp,pp])];function mp(e){if(e.z<=1)return fp[e.z+2*e.y+e.x];const[t,i]=_p(e),r=[yp(t[0],t[1]),yp(t[0],i[1]),yp(i[0],t[1]),yp(i[0],i[1])],n=[pp,pp,pp],o=[dp,dp,dp];for(const e of r)n[0]=Math.min(n[0],e[0]),n[1]=Math.min(n[1],e[1]),n[2]=Math.min(n[2],e[2]),o[0]=Math.max(o[0],e[0]),o[1]=Math.max(o[1],e[1]),o[2]=Math.max(o[2],e[2]);return new gl(n,o);}function _p(e){const t=Math.pow(2,e.z),i=e.x/t,r=(e.x+1)/t,n=(e.y+1)/t;return [[Ba(e.y/t),Fa(i)],[Ba(n),Fa(r)]];}function gp(e,t,i,r){return i=j(i),r||(r=up),[e*Math.sin(i)*r,-t*r,e*Math.cos(i)*r];}function yp(e,t,i){return gp(Math.cos(j(e)),Math.sin(j(e)),t,i);}function xp(e){return 16383/Math.max(...D([],e.max,e.min));}function vp(e){const t=h(new Float64Array(16)),i=1/xp(e);return d(t,t,e.min),p(t,t,[i,i,i]),t;}function bp(e,t,i){const r=t/(2*Math.PI),n=function(e){const t=Ca/(2*Math.PI);return e/(2*Math.PI)/t;}(t);if(!i){const r=W(e.center.lat,-85.051129,Va);i=[za(e.center.lng)*t,Ra(r)*t];}const o=h(new Float64Array(16));return d(o,o,[i[0],i[1],-r]),p(o,o,[n,n,n]),f(o,o,j(-e._center.lat)),m(o,o,j(-e._center.lng)),o;}class Sp{constructor(e){const t=this._createGridIndices();this.gridIndexBuffer=e.createIndexBuffer(t,!0),this.gridSegments=Ma.simpleSegment(0,0,4225,8192);const i=this._createPoleTriangleIndices();this.poleIndexBuffer=e.createIndexBuffer(i,!0),this.poleSegments=Ma.simpleSegment(0,0,66,64);const r=new As();r.emplaceBack(-1,1,1,0,0,0,0),r.emplaceBack(1,1,1,0,0,1,0),r.emplaceBack(1,-1,1,0,0,1,1),r.emplaceBack(-1,-1,1,0,0,0,1);const n=new Es();n.emplaceBack(0,1,2),n.emplaceBack(2,3,0),this.atmosphereVertexBuffer=e.createVertexBuffer(r,lp.members),this.atmosphereIndexBuffer=e.createIndexBuffer(n),this.atmosphereSegments=Ma.simpleSegment(0,0,4,2);}destroy(){this.poleIndexBuffer.destroy(),this.gridIndexBuffer.destroy(),this.poleSegments.destroy(),this.gridSegments.destroy(),this.atmosphereVertexBuffer.destroy(),this.atmosphereIndexBuffer.destroy(),this.atmosphereSegments.destroy(),this.wireframeIndexBuffer&&(this.wireframeIndexBuffer.destroy(),this.wireframeSegments.destroy());}static createPoleTriangleVertices(e,t,i){const r=new As(),n=t/Math.PI/2;r.emplaceBack(0,-n,0,0,0,.5,i?0:1);const o=360/e,s=Math.cos(j(85)),a=Math.sin(j(85));for(let e=0;e<=64;e++){const t=e/64,c=gp(s,a,0*(1-(l=t))+o*l,n);r.emplaceBack(c[0],c[1],c[2],0,0,t,i?0:1);}var l;return r;}_createPoleTriangleIndices(){const e=new Es();for(let t=0;t<=64;t++)e.emplaceBack(0,t+1,t+2);return e;}static createGridVertices(e){const t=Math.pow(2,e.z),i=(e,t,i)=>e*(1-i)+t*i,[r,n]=_p(e),o=new As(),s=function(e){const t=h(new Float64Array(16)),i=xp(e);var r,n;return p(t,t,[i,i,i]),d(t,t,((r=[])[0]=-(n=e.min)[0],r[1]=-n[1],r[2]=-n[2],r)),t;}(mp(e));o.reserve(4096);for(let a=0;a<65;a++){const l=i(r[0],n[0],a/64),c=Ra(l),h=c*t-e.y,u=Math.sin(j(l)),d=Math.cos(j(l));for(let e=0;e<65;e++){const t=e/64,a=i(r[1],n[1],t),l=gp(d,u,a);A(l,l,s);const p=za(a);o.emplaceBack(l[0],l[1],l[2],p,c,t,h);}}return o;}_createGridIndices(){const e=new Es(),t=(t,i)=>{const r=65*i+t;e.emplaceBack(r+1,r,r+65),e.emplaceBack(r+65,r+65+1,r+1);};for(let e=0;e<64;e++)for(let i=0;i<64;i++)t(i,e);return e;}getWirefameBuffer(e){if(!this.wireframeSegments){const t=this._createWireframeGrid();this.wireframeIndexBuffer=e.createIndexBuffer(t),this.wireframeSegments=Ma.simpleSegment(0,0,4096,t.length);}return [this.wireframeIndexBuffer,this.wireframeSegments];}_createWireframeGrid(){const e=new Ls(),t=(t,i)=>{const r=65*i+t;e.emplaceBack(r,r+1),e.emplaceBack(r,r+65),e.emplaceBack(r,r+65+1);};for(let e=0;e<64;e++)for(let i=0;i<64;i++)t(i,e);return e;}}function wp(e,t){if(!t.isReprojectedInTileSpace)return {scale:1<<e.z,x:e.x,y:e.y,x2:e.x+1,y2:e.y+1,projection:t};const i=Math.pow(2,-e.z),r=e.x*i,n=(e.x+1)*i,o=e.y*i,s=(e.y+1)*i,a=Fa(r),l=Fa(n),c=Ba(o),h=Ba(s),u=t.project(a,c),d=t.project(l,c),p=t.project(l,h),f=t.project(a,h);let m=Math.min(u.x,d.x,p.x,f.x),_=Math.min(u.y,d.y,p.y,f.y),g=Math.max(u.x,d.x,p.x,f.x),y=Math.max(u.y,d.y,p.y,f.y);const x=i/16;function v(e,i,r,n,o,s){const a=(r+o)/2,l=(n+s)/2,c=t.project(Fa(a),Ba(l)),h=Math.max(0,m-c.x,_-c.y,c.x-g,c.y-y);m=Math.min(m,c.x),g=Math.max(g,c.x),_=Math.min(_,c.y),y=Math.max(y,c.y),h>x&&(v(e,c,r,n,a,l),v(c,i,a,l,o,s));}v(u,d,r,o,n,o),v(d,p,n,o,n,s),v(p,f,n,s,r,s),v(f,u,r,s,r,o),m-=x,_-=x,g+=x,y+=x;const b=1/Math.max(g-m,y-_);return {scale:b,x:m*b,y:_*b,x2:g*b,y2:y*b,projection:t};}class Tp{constructor(e){const t={},i=[];for(const r in e){const n=e[r],o=t[r]={};for(const e in n.glyphs){const t=n.glyphs[+e];if(!t||0===t.bitmap.width||0===t.bitmap.height)continue;const r=t.metrics.localGlyph?2:1,s={x:0,y:0,w:t.bitmap.width+2*r,h:t.bitmap.height+2*r};i.push(s),o[e]=s;}}const{w:r,h:n}=Uh(i),o=new Il({width:r||1,height:n||1});for(const i in e){const r=e[i];for(const e in r.glyphs){const n=r.glyphs[+e];if(!n||0===n.bitmap.width||0===n.bitmap.height)continue;const s=t[i][e],a=n.metrics.localGlyph?2:1;Il.copy(n.bitmap,o,{x:0,y:0},{x:s.x+a,y:s.y+a},n.bitmap);}}this.image=o,this.positions=t;}}qn("GlyphAtlas",Tp);class Ep{constructor(e){this.tileID=new vd(e.tileID.overscaledZ,e.tileID.wrap,e.tileID.canonical.z,e.tileID.canonical.x,e.tileID.canonical.y),this.tileZoom=e.tileZoom,this.uid=e.uid,this.zoom=e.zoom,this.canonical=e.tileID.canonical,this.pixelRatio=e.pixelRatio,this.tileSize=e.tileSize,this.source=e.source,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=e.showCollisionBoxes,this.collectResourceTiming=!!e.collectResourceTiming,this.returnDependencies=!!e.returnDependencies,this.promoteId=e.promoteId,this.enableTerrain=!!e.enableTerrain,this.isSymbolTile=e.isSymbolTile,this.tileTransform=wp(e.tileID.canonical,e.projection),this.projection=e.projection;}parse(e,t,i,r,n){this.status="parsing",this.data=e,this.collisionBoxArray=new Os();const o=new Cd(Object.keys(e.layers).sort()),s=new Zd(this.tileID,this.promoteId);s.bucketLayerIDs=[];const a={},l=new dd(256,256),c={featureIndex:s,iconDependencies:{},patternDependencies:{},glyphDependencies:{},lineAtlas:l,availableImages:i},h=t.familiesBySource[this.source];for(const t in h){const r=e.layers[t];if(!r)continue;let n=!1,l=!1;for(const e of h[t])"symbol"===e[0].type?n=!0:l=!0;if(!0===this.isSymbolTile&&!n)continue;if(!1===this.isSymbolTile&&!l)continue;1===r.version&&de(`Vector tile source "${this.source}" layer "${t}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const u=o.encode(t),d=[];for(let e=0;e<r.length;e++){const i=r.feature(e),n=s.getId(i,t);d.push({feature:i,id:n,index:e,sourceLayerIndex:u});}for(const e of h[t]){const t=e[0];void 0!==this.isSymbolTile&&"symbol"===t.type!==this.isSymbolTile||t.minzoom&&this.zoom<Math.floor(t.minzoom)||t.maxzoom&&this.zoom>=t.maxzoom||"none"!==t.visibility&&(Np(e,this.zoom,i),(a[t.id]=t.createBucket({index:s.bucketLayerIDs.length,layers:e,zoom:this.zoom,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:u,sourceID:this.source,enableTerrain:this.enableTerrain,availableImages:i})).populate(d,c,this.tileID.canonical,this.tileTransform),s.bucketLayerIDs.push(e.map(e=>e.id)));}}let u,d,p,f;l.trim();const m={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},_=le(c.glyphDependencies,e=>Object.keys(e).map(Number));Object.keys(_).length?r.send("getGlyphs",{uid:this.uid,stacks:_},(e,t)=>{u||(u=e,d=t,x.call(this));},void 0,!1,m):d={};const g=Object.keys(c.iconDependencies);g.length?r.send("getImages",{icons:g,source:this.source,tileID:this.tileID,type:"icons"},(e,t)=>{u||(u=e,p=t,x.call(this));},void 0,!1,m):p={};const y=Object.keys(c.patternDependencies);function x(){if(u)return n(u);if(d&&p&&f){const e=new Tp(d),t=new Gh(p,f);for(const r in a){const n=a[r];n instanceof Wu?(Np(n.layers,this.zoom,i),Du(n,d,e.positions,p,t.iconPositions,this.showCollisionBoxes,i,this.tileID.canonical,this.tileZoom,this.projection),n.projection=this.projection.name):n.hasPattern&&(n instanceof Xc||n instanceof _c||n instanceof zc)&&(Np(n.layers,this.zoom,i),n.addFeatures(c,this.tileID.canonical,t.patternPositions,i));}this.status="done",n(null,{buckets:Q(a).filter(e=>!e.isEmpty()),featureIndex:s,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:e.image,lineAtlas:l,imageAtlas:t,glyphMap:this.returnDependencies?d:null,iconMap:this.returnDependencies?p:null,glyphPositions:this.returnDependencies?e.positions:null});}}y.length?r.send("getImages",{icons:y,source:this.source,tileID:this.tileID,type:"patterns"},(e,t)=>{u||(u=e,f=t,x.call(this));},void 0,!1,m):f={},x.call(this);}}function Np(e,t,i){const r=new qo(t);for(const t of e)t.recalculate(r,i);}class Ip{constructor(e){this.entries={},this.scheduler=e;}request(e,t,i,r){const n=this.entries[e]=this.entries[e]||{callbacks:[]};if(n.result){const[e,i]=n.result;return this.scheduler?this.scheduler.add(()=>{r(e,i);},t):r(e,i),()=>{};}return n.callbacks.push(r),n.cancel||(n.cancel=i((i,r)=>{n.result=[i,r];for(const e of n.callbacks)this.scheduler?this.scheduler.add(()=>{e(i,r);},t):e(i,r);setTimeout(()=>delete this.entries[e],3e3);})),()=>{n.result||(n.callbacks=n.callbacks.filter(e=>e!==r),n.callbacks.length||(n.cancel(),delete this.entries[e]));};}}function Mp(e,t,i){const r=JSON.stringify(e.request);return e.data&&(this.deduped.entries[r]={result:[null,e.data]}),this.deduped.request(r,{type:"parseTile",isSymbolTile:e.isSymbolTile,zoom:e.tileZoom},t=>{const r=st(e.request,(e,r,n,o)=>{e?t(e):r&&t(null,{vectorTile:i?void 0:new Ac.VectorTile(new gh(r)),rawData:r,cacheControl:n,expires:o});});return ()=>{r.cancel(),t();};},t);}const Cp=h(new Float64Array(16));class Ap{constructor(e,t){this._tr=e,this._worldSize=t;}createInversionMatrix(){return Cp;}createTileMatrix(e){let t,i,r;const n=e.canonical,o=h(new Float64Array(16)),s=this._tr.projection;if(s.isReprojectedInTileSpace){const a=wp(n,s);t=1,i=a.x+e.wrap*a.scale,r=a.y,p(o,o,[t/a.scale,t/a.scale,this._tr.pixelsPerMeter/this._worldSize]);}else t=this._worldSize/this._tr.zoomScale(n.z),i=(n.x+Math.pow(2,n.z)*e.wrap)*t,r=n.y*t;return d(o,o,[i,r,0]),p(o,o,[t/Ca,t/Ca,1]),o;}pointCoordinate(e,t,i){const r=this._tr.horizonLineFromTop(!1),o=new n(e,Math.max(r,t));return this._tr.rayIntersectionCoordinate(this._tr.pointRayIntersection(o,i));}upVector(){return [0,0,1];}upVectorScale(){return 1;}}var Pp={name:"albers",range:[4,7],center:[-96,37.5],parallels:[29.5,45.5],zAxisUnit:"meters",conic:!0,isReprojectedInTileSpace:!0,unsupportedLayers:["custom"],initializeConstants(){if(this.constants&&U(this.parallels,this.constants.parallels))return;const e=Math.sin(j(this.parallels[0])),t=(e+Math.sin(j(this.parallels[1])))/2,i=1+e*(2*t-e),r=Math.sqrt(i)/t;this.constants={n:t,c:i,r0:r,parallels:this.parallels};},project(e,t){this.initializeConstants();const i=j(e-this.center[0]),r=j(t),{n:n,c:o,r0:s}=this.constants,a=Math.sqrt(o-2*n*Math.sin(r))/n;return {x:a*Math.sin(i*n),y:a*Math.cos(i*n)-s,z:0};},unproject(e,t){this.initializeConstants();const{n:i,c:r,r0:n}=this.constants,o=n+t;let s=Math.atan2(e,Math.abs(o))*Math.sign(o);o*i<0&&(s-=Math.PI*Math.sign(e)*Math.sign(o));const a=j(this.center[0])*i;s=J(s,-Math.PI-a,Math.PI-a);const l=$(s/i)+this.center[0],c=Math.asin(W((r-(e*e+o*o)*i*i)/(2*i),-1,1)),h=W($(c),-85.051129,Va);return new La(l,h);},projectTilePoint:(e,t)=>({x:e,y:t,z:0}),locationPoint:(e,t)=>e._coordinatePoint(e.locationCoordinate(t),!1),pixelsPerMeter:(e,t)=>Oa(1,e)*t,farthestPixelDistance(e){return hp(e,this.pixelsPerMeter(e.center.lat,e.worldSize));},createTileTransform:(e,t)=>new Ap(e,t)};const Lp=1.340264,Dp=-.081106,kp=893e-6,zp=.003796,Rp=Math.sqrt(3)/2;var Op={name:"equalEarth",center:[0,0],range:[3.5,7],zAxisUnit:"meters",isReprojectedInTileSpace:!0,unsupportedLayers:["custom"],project(e,t){t=t/180*Math.PI,e=e/180*Math.PI;const i=Math.asin(Rp*Math.sin(t)),r=i*i,n=r*r*r;return {x:.5*(e*Math.cos(i)/(Rp*(Lp+3*Dp*r+n*(7*kp+9*zp*r)))/Math.PI+.5),y:1-.5*(i*(Lp+Dp*r+n*(kp+zp*r))/Math.PI+1),z:0};},unproject(e,t){e=(2*e-.5)*Math.PI;let i=t=(2*(1-t)-1)*Math.PI,r=i*i,n=r*r*r;for(let e,o,s,a=0;a<12&&(o=i*(Lp+Dp*r+n*(kp+zp*r))-t,s=Lp+3*Dp*r+n*(7*kp+9*zp*r),e=o/s,i=W(i-e,-Math.PI/3,Math.PI/3),r=i*i,n=r*r*r,!(Math.abs(e)<1e-12));++a);const o=Rp*e*(Lp+3*Dp*r+n*(7*kp+9*zp*r))/Math.cos(i),s=Math.asin(Math.sin(i)/Rp),a=W(180*o/Math.PI,-180,180),l=W(180*s/Math.PI,-85.051129,Va);return new La(a,l);},projectTilePoint:(e,t)=>({x:e,y:t,z:0}),locationPoint:(e,t)=>e._coordinatePoint(e.locationCoordinate(t),!1),pixelsPerMeter:(e,t)=>Oa(1,e)*t,farthestPixelDistance(e){return hp(e,this.pixelsPerMeter(e.center.lat,e.worldSize));},createTileTransform:(e,t)=>new Ap(e,t)},Fp={name:"equirectangular",supportsWorldCopies:!0,center:[0,0],range:[3.5,7],zAxisUnit:"meters",wrap:!0,isReprojectedInTileSpace:!0,unsupportedLayers:["custom"],project:(e,t)=>({x:.5+e/360,y:.5-t/360,z:0}),unproject(e,t){const i=360*(e-.5),r=W(360*(.5-t),-85.051129,Va);return new La(i,r);},projectTilePoint:(e,t)=>({x:e,y:t,z:0}),locationPoint:(e,t)=>e._coordinatePoint(e.locationCoordinate(t),!1),pixelsPerMeter:(e,t)=>Oa(1,e)*t,farthestPixelDistance(e){return hp(e,this.pixelsPerMeter(e.center.lat,e.worldSize));},createTileTransform:(e,t)=>new Ap(e,t)};const Bp=Math.PI/2;function Up(e){return Math.tan((Bp+e)/2);}var Vp={name:"lambertConformalConic",range:[3.5,7],zAxisUnit:"meters",center:[0,30],parallels:[30,30],conic:!0,isReprojectedInTileSpace:!0,unsupportedLayers:["custom"],initializeConstants(){if(this.constants&&U(this.parallels,this.constants.parallels))return;const e=j(this.parallels[0]),t=j(this.parallels[1]),i=Math.cos(e),r=e===t?Math.sin(e):Math.log(i/Math.cos(t))/Math.log(Up(t)/Up(e)),n=i*Math.pow(Up(e),r)/r;this.constants={n:r,f:n,parallels:this.parallels};},project(e,t){this.initializeConstants(),t=j(t),e=j(e-this.center[0]);const i=1e-6,{n:r,f:n}=this.constants;n>0?t<-Bp+i&&(t=-Bp+i):t>Bp-i&&(t=Bp-i);const o=n/Math.pow(Up(t),r),s=o*Math.sin(r*e),a=n-o*Math.cos(r*e);return {x:.5*(s/Math.PI+.5),y:1-.5*(a/Math.PI+.5),z:0};},unproject(e,t){this.initializeConstants(),e=(2*e-.5)*Math.PI,t=(2*(1-t)-.5)*Math.PI;const{n:i,f:r}=this.constants,n=r-t,o=Math.sign(n),s=Math.sign(i)*Math.sqrt(e*e+n*n);let a=Math.atan2(e,Math.abs(n))*o;n*i<0&&(a-=Math.PI*Math.sign(e)*o);const l=W($(a/i)+this.center[0],-180,180),c=W($(2*Math.atan(Math.pow(r/s,1/i))-Bp),-85.051129,Va);return new La(l,c);},projectTilePoint:(e,t)=>({x:e,y:t,z:0}),locationPoint:(e,t)=>e._coordinatePoint(e.locationCoordinate(t),!1),pixelsPerMeter:(e,t)=>Oa(1,e)*t,farthestPixelDistance(e){return hp(e,this.pixelsPerMeter(e.center.lat,e.worldSize));},createTileTransform:(e,t)=>new Ap(e,t)},Gp={name:"mercator",wrap:!0,requiresDraping:!1,supportsWorldCopies:!0,supportsTerrain:!0,supportsFog:!0,supportsFreeCamera:!0,zAxisUnit:"meters",center:[0,0],project:(e,t)=>({x:za(e),y:Ra(t),z:0}),unproject(e,t){const i=Fa(e),r=Ba(t);return new La(i,r);},projectTilePoint:(e,t)=>({x:e,y:t,z:0}),locationPoint:(e,t)=>e._coordinatePoint(e.locationCoordinate(t),!1),pixelsPerMeter:(e,t)=>Oa(1,e)*t,farthestPixelDistance(e){return hp(e,this.pixelsPerMeter(e.center.lat,e.worldSize));},createTileTransform:(e,t)=>new Ap(e,t)};const jp=j(Va);var $p={name:"naturalEarth",center:[0,0],range:[3.5,7],isReprojectedInTileSpace:!0,zAxisUnit:"meters",unsupportedLayers:["custom"],project(e,t){const i=(t=j(t))*t,r=i*i;return {x:.5*((e=j(e))*(.8707-.131979*i+r*(r*(.003971*i-.001529*r)-.013791))/Math.PI+.5),y:1-.5*(t*(1.007226+i*(.015085+r*(.028874*i-.044475-.005916*r)))/Math.PI+1),z:0};},unproject(e,t){e=(2*e-.5)*Math.PI;let i=t=(2*(1-t)-1)*Math.PI,r=25,n=0,o=i*i;do{o=i*i;const e=o*o;n=(i*(1.007226+o*(.015085+e*(.028874*o-.044475-.005916*e)))-t)/(1.007226+o*(.045255+e*(.259866*o-.311325-.005916*11*e))),i=W(i-n,-jp,jp);}while(Math.abs(n)>1e-6&&--r>0);o=i*i;const s=W($(e/(.8707+o*(o*(o*o*o*(.003971-.001529*o)-.013791)-.131979))),-180,180),a=$(i);return new La(s,a);},projectTilePoint:(e,t)=>({x:e,y:t,z:0}),locationPoint:(e,t)=>e._coordinatePoint(e.locationCoordinate(t),!1),pixelsPerMeter:(e,t)=>Oa(1,e)*t,farthestPixelDistance(e){return hp(e,this.pixelsPerMeter(e.center.lat,e.worldSize));},createTileTransform:(e,t)=>new Ap(e,t)};const Hp=j(Va),qp={albers:Pp,equalEarth:Op,equirectangular:Fp,lambertConformalConic:Vp,mercator:Gp,naturalEarth:$p,winkelTripel:{name:"winkelTripel",center:[0,0],range:[3.5,7],zAxisUnit:"meters",isReprojectedInTileSpace:!0,unsupportedLayers:["custom"],project(e,t){t=j(t),e=j(e);const i=Math.cos(t),r=2/Math.PI,n=Math.acos(i*Math.cos(e/2)),o=Math.sin(n)/n,s=.5*(e*r+2*i*Math.sin(e/2)/o)||0,a=.5*(t+Math.sin(t)/o)||0;return {x:.5*(s/Math.PI+.5),y:1-.5*(a/Math.PI+1),z:0};},unproject(e,t){let i=e=(2*e-.5)*Math.PI,r=t=(2*(1-t)-1)*Math.PI,n=25;const o=1e-6;let s=0,a=0;do{const n=Math.cos(r),o=Math.sin(r),l=2*o*n,c=o*o,h=n*n,u=Math.cos(i/2),d=Math.sin(i/2),p=2*u*d,f=d*d,m=1-h*u*u,_=m?1/m:0,g=m?Math.acos(n*u)*Math.sqrt(1/m):0,y=.5*(2*g*n*d+2*i/Math.PI)-e,x=.5*(g*o+r)-t,v=.5*_*(h*f+g*n*u*c)+1/Math.PI,b=_*(p*l/4-g*o*d),S=.125*_*(l*d-g*o*h*p),w=.5*_*(c*u+g*f*n)+.5,T=b*S-w*v;s=(x*b-y*w)/T,a=(y*S-x*v)/T,i=W(i-s,-Math.PI,Math.PI),r=W(r-a,-Hp,Hp);}while((Math.abs(s)>o||Math.abs(a)>o)&&--n>0);return new La($(i),$(r));},projectTilePoint:(e,t)=>({x:e,y:t,z:0}),locationPoint:(e,t)=>e._coordinatePoint(e.locationCoordinate(t),!1),pixelsPerMeter:(e,t)=>Oa(1,e)*t,farthestPixelDistance(e){return hp(e,this.pixelsPerMeter(e.center.lat,e.worldSize));},createTileTransform:(e,t)=>new Ap(e,t)}};e.ARRAY_TYPE=l,e.AUTH_ERR_MSG=De,e.Aabb=gl,e.Actor=class{constructor(e,t,i){this.target=e,this.parent=t,this.mapId=i,this.callbacks={},this.cancelCallbacks={},se(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.globalScope=me()?e:s,this.scheduler=new _d();}send(e,t,i,r,n=!1,o){const s=Math.round(1e18*Math.random()).toString(36).substring(0,10);i&&(i.metadata=o,this.callbacks[s]=i);const a=be(this.globalScope)?void 0:[];return this.target.postMessage({id:s,type:e,hasCallback:!!i,targetMapId:r,mustQueue:n,sourceMapId:this.mapId,data:Wn(t,a)},a),{cancel:()=>{i&&delete this.callbacks[s],this.target.postMessage({id:s,type:"<cancel>",targetMapId:r,sourceMapId:this.mapId});}};}receive(e){const t=e.data,i=t.id;if(i&&(!t.targetMapId||this.mapId===t.targetMapId))if("<cancel>"===t.type){const e=this.cancelCallbacks[i];delete this.cancelCallbacks[i],e&&e.cancel();}else if(t.mustQueue||me()){const e=this.callbacks[i];this.cancelCallbacks[i]=this.scheduler.add(()=>this.processTask(i,t),e&&e.metadata||{type:"message"});}else this.processTask(i,t);}processTask(e,t){if("<response>"===t.type){const i=this.callbacks[e];delete this.callbacks[e],i&&(t.error?i(Yn(t.error)):i(null,Yn(t.data)));}else {const i=be(this.globalScope)?void 0:[],r=t.hasCallback?(t,r)=>{delete this.cancelCallbacks[e],this.target.postMessage({id:e,type:"<response>",sourceMapId:this.mapId,error:t?Wn(t):null,data:Wn(r,i)},i);}:e=>{},n=Yn(t.data);if(this.parent[t.type])this.parent[t.type](t.sourceMapId,n,r);else if(this.parent.getWorkerSource){const e=t.type.split(".");this.parent.getWorkerSource(t.sourceMapId,e[0],n.source)[e[1]](n,r);}else r(new Error(`Could not find function ${t.type}`));}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1);}},e.CanonicalTileID=yd,e.Color=Ht,e.ColorMode=Ed,e.CullFaceMode=Md,e.DEMData=Vd,e.DataConstantProperty=ts,e.DedupedRequest=Ip,e.DepthMode=Sd,e.EXTENT=Ca,e.Elevation=class{getAtPointOrZero(e,t=0){return this.getAtPoint(e,t)||0;}getAtPoint(e,t,i=!0){null==t&&(t=null);const r=this._source();if(!r)return t;if(e.y<0||e.y>1)return t;const n=r.getSource().maxzoom,o=1<<n,s=Math.floor(e.x),a=e.x-s,l=new vd(n,s,n,Math.floor(a*o),Math.floor(e.y*o)),c=this.findDEMTileFor(l);if(!c||!c.dem)return t;const h=c.dem,u=1<<c.tileID.canonical.z,d=(a*u-c.tileID.canonical.x)*h.dim,p=(e.y*u-c.tileID.canonical.y)*h.dim,f=Math.floor(d),m=Math.floor(p);return (i?this.exaggeration():1)*Oi(Oi(h.get(f,m),h.get(f,m+1),p-m),Oi(h.get(f+1,m),h.get(f+1,m+1),p-m),d-f);}getAtTileOffset(e,t,i){const r=1<<e.canonical.z;return this.getAtPointOrZero(new Ga(e.wrap+(e.canonical.x+t/Ca)/r,(e.canonical.y+i/Ca)/r));}getAtTileOffsetFunc(e,t){return i=>{const r=this.getAtTileOffset(e,i.x,i.y),n=t.upVector(e.canonical,i.x,i.y);return E(n,n,r*t.upVectorScale(e.canonical)),n;};}getForTilePoints(e,t,i,r){const n=qd.create(this,e,r);return !!n&&(t.forEach(e=>{e[2]=this.exaggeration()*n.getElevationAt(e[0],e[1],i);}),!0);}getMinMaxForTile(e){const t=this.findDEMTileFor(e);if(!t||!t.dem)return null;const i=t.dem.tree,r=t.tileID,n=1<<e.canonical.z-r.canonical.z;let o=e.canonical.x/n-r.canonical.x,s=e.canonical.y/n-r.canonical.y,a=0;for(let t=0;t<e.canonical.z-r.canonical.z&&!i.leaves[a];t++){o*=2,s*=2;const e=2*Math.floor(s)+Math.floor(o);a=i.childOffsets[a]+e,o%=1,s%=1;}return {min:this.exaggeration()*i.minimums[a],max:this.exaggeration()*i.maximums[a]};}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.");}raycast(e,t,i){throw new Error("Pure virtual method called.");}pointCoordinate(e){throw new Error("Pure virtual method called.");}_source(){throw new Error("Pure virtual method called.");}exaggeration(){throw new Error("Pure virtual method called.");}findDEMTileFor(e){throw new Error("Pure virtual method called.");}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.");}},e.ErrorEvent=gt,e.EvaluationParameters=qo,e.Event=_t,e.Evented=yt,e.Frustum=_l,e.GLOBE_ZOOM_THRESHOLD_MAX=6,e.GlobeSharedBuffers=Sp,e.GlyphManager=yu,e.ImagePosition=Vh,e.LineAtlas=dd,e.LngLat=La,e.LngLatBounds=Aa,e.LocalGlyphMode=gu,e.MAX_MERCATOR_LATITUDE=Va,e.MercatorCoordinate=Ga,e.ONE_EM=oh,e.OverscaledTileID=vd,e.Properties=ss,e.RGBAImage=Ml,e.Ray=class{constructor(e,t){this.pos=e,this.dir=t;}intersectsPlane(e,t,i){const r=M(t,this.dir);if(Math.abs(r)<1e-6)return !1;const n=((e[0]-this.pos[0])*t[0]+(e[1]-this.pos[1])*t[1]+(e[2]-this.pos[2])*t[2])/r;return i[0]=this.pos[0]+this.dir[0]*n,i[1]=this.pos[1]+this.dir[1]*n,i[2]=this.pos[2]+this.dir[2]*n,!0;}closestPointOnSphere(e,t,i){if(function(e,t){var i=e[0],r=e[1],n=e[2],o=t[0],s=t[1],l=t[2];return Math.abs(i-o)<=a*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(r-s)<=a*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(n-l)<=a*Math.max(1,Math.abs(n),Math.abs(l));}(this.pos,e)||0===t)return i[0]=i[1]=i[2]=0,!1;const[r,n,o]=this.dir,s=this.pos[0]-e[0],l=this.pos[1]-e[1],c=this.pos[2]-e[2],h=r*r+n*n+o*o,u=2*(s*r+l*n+c*o),d=u*u-4*h*(s*s+l*l+c*c-t*t);if(d<0){const e=Math.max(-u/2,0),a=s+r*e,h=l+n*e,d=c+o*e,p=Math.hypot(a,h,d);return i[0]=a*t/p,i[1]=h*t/p,i[2]=d*t/p,!1;}{const e=(-u-Math.sqrt(d))/(2*h);if(e<0){const e=Math.hypot(s,l,c);return i[0]=s*t/e,i[1]=l*t/e,i[2]=c*t/e,!1;}return i[0]=s+r*e,i[1]=l+n*e,i[2]=c+o*e,!0;}}},e.RequestManager=class{constructor(e,t,i){this._transformRequestFn=e,this._customAccessToken=t,this._silenceAuthErrors=!!i,this._createSkuToken();}_createSkuToken(){const e=function(){let e="";for(let t=0;t<10;t++)e+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return {token:["1",Le,e].join(""),tokenExpiresAt:Date.now()+432e5};}();this._skuToken=e.token,this._skuTokenExpiresAt=e.tokenExpiresAt;}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt;}transformRequest(e,t){return this._transformRequestFn&&this._transformRequestFn(e,t)||{url:e};}normalizeStyleURL(e,t){if(!ke(e))return e;const i=Oe(e);return i.path=`/styles/v1${i.path}`,this._makeAPIURL(i,this._customAccessToken||t);}normalizeGlyphsURL(e,t){if(!ke(e))return e;const i=Oe(e);return i.path=`/fonts/v1${i.path}`,this._makeAPIURL(i,this._customAccessToken||t);}normalizeSourceURL(e,t){if(!ke(e))return e;const i=Oe(e);return i.path=`/v4/${i.authority}.json`,i.params.push("secure"),this._makeAPIURL(i,this._customAccessToken||t);}normalizeSpriteURL(e,t,i,r){const n=Oe(e);return ke(e)?(n.path=`/styles/v1${n.path}/sprite${t}${i}`,this._makeAPIURL(n,this._customAccessToken||r)):(n.path+=`${t}${i}`,Fe(n));}normalizeTileURL(e,t,i){if(this._isSkuTokenExpired()&&this._createSkuToken(),e&&!ke(e))return e;const r=Oe(e);r.path=r.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${t||i&&"raster"!==r.authority&&512===i?"@2x":""}${Ne.supported?".webp":"$1"}`),"raster"===r.authority?r.path=`/${Ee.RASTER_URL_PREFIX}${r.path}`:(r.path=r.path.replace(/^.+\/v4\//,"/"),r.path=`/${Ee.TILE_URL_VERSION}${r.path}`);const n=this._customAccessToken||function(e){for(const t of e){const e=t.match(/^access_token=(.*)$/);if(e)return e[1];}return null;}(r.params)||Ee.ACCESS_TOKEN;return Ee.REQUIRE_ACCESS_TOKEN&&n&&this._skuToken&&r.params.push(`sku=${this._skuToken}`),this._makeAPIURL(r,n);}canonicalizeTileURL(e,t){const i=Oe(e);if(!i.path.match(/^(\/v4\/|\/raster\/v1\/)/)||!i.path.match(/\.[\w]+$/))return e;let r="mapbox://";i.path.match(/^\/raster\/v1\//)?r+=`raster/${i.path.replace(`/${Ee.RASTER_URL_PREFIX}/`,"")}`:r+=`tiles/${i.path.replace(`/${Ee.TILE_URL_VERSION}/`,"")}`;let n=i.params;return t&&(n=n.filter(e=>!e.match(/^access_token=/))),n.length&&(r+=`?${n.join("&")}`),r;}canonicalizeTileset(e,t){const i=!!t&&ke(t),r=[];for(const t of e.tiles||[])ze(t)?r.push(this.canonicalizeTileURL(t,i)):r.push(t);return r;}_makeAPIURL(e,t){const i="See https://www.mapbox.com/api-documentation/#access-tokens-and-token-scopes",r=Oe(Ee.API_URL);if(e.protocol=r.protocol,e.authority=r.authority,"http"===e.protocol){const t=e.params.indexOf("secure");t>=0&&e.params.splice(t,1);}if("/"!==r.path&&(e.path=`${r.path}${e.path}`),!Ee.REQUIRE_ACCESS_TOKEN)return Fe(e);if(t=t||Ee.ACCESS_TOKEN,!this._silenceAuthErrors){if(!t)throw new Error(`An API access token is required to use Mapbox GL. ${i}`);if("s"===t[0])throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${i}`);}return e.params=e.params.filter(e=>-1===e.indexOf("access_token")),e.params.push(`access_token=${t||""}`),Fe(e);}},e.ResourceType=it,e.SegmentVector=Ma,e.SourceCache=jd,e.StencilMode=Td,e.StructArrayLayout1ui2=Ds,e.StructArrayLayout2f1f2i16=ws,e.StructArrayLayout2i4=ps,e.StructArrayLayout2ui4=Ls,e.StructArrayLayout3f12=_s,e.StructArrayLayout3ui6=Es,e.StructArrayLayout4i8=fs,e.Texture=ud,e.Tile=sp,e.Transitionable=Wo,e.Uniform1f=oa,e.Uniform1i=class extends na{constructor(e,t){super(e,t),this.current=0;}set(e){this.current!==e&&(this.current=e,this.gl.uniform1i(this.location,e));}},e.Uniform2f=class extends na{constructor(e,t){super(e,t),this.current=[0,0];}set(e){e[0]===this.current[0]&&e[1]===this.current[1]||(this.current=e,this.gl.uniform2f(this.location,e[0],e[1]));}},e.Uniform3f=class extends na{constructor(e,t){super(e,t),this.current=[0,0,0];}set(e){e[0]===this.current[0]&&e[1]===this.current[1]&&e[2]===this.current[2]||(this.current=e,this.gl.uniform3f(this.location,e[0],e[1],e[2]));}},e.Uniform4f=sa,e.UniformColor=aa,e.UniformMatrix2f=class extends na{constructor(e,t){super(e,t),this.current=ha;}set(e){for(let t=0;t<4;t++)if(e[t]!==this.current[t]){this.current=e,this.gl.uniformMatrix2fv(this.location,!1,e);break;}}},e.UniformMatrix3f=class extends na{constructor(e,t){super(e,t),this.current=ca;}set(e){for(let t=0;t<9;t++)if(e[t]!==this.current[t]){this.current=e,this.gl.uniformMatrix3fv(this.location,!1,e);break;}}},e.UniformMatrix4f=class extends na{constructor(e,t){super(e,t),this.current=la;}set(e){if(e[12]!==this.current[12]||e[0]!==this.current[0])return this.current=e,void this.gl.uniformMatrix4fv(this.location,!1,e);for(let t=1;t<16;t++)if(e[t]!==this.current[t]){this.current=e,this.gl.uniformMatrix4fv(this.location,!1,e);break;}}},e.UnwrappedTileID=xd,e.ValidationError=vt,e.VectorTileWorkerSource=class extends yt{constructor(e,t,i,r,n){super(),this.actor=e,this.layerIndex=t,this.availableImages=i,this.loadVectorData=n||Mp,this.loading={},this.loaded={},this.deduped=new Ip(e.scheduler),this.isSpriteLoaded=r,this.scheduler=e.scheduler;}loadTile(e,t){const i=e.uid,r=e&&e.request,n=r&&r.collectResourceTiming,o=this.loading[i]=new Ep(e);o.abort=this.loadVectorData(e,(s,a)=>{const l=!this.loading[i];if(delete this.loading[i],l||s||!a)return o.status="done",l||(this.loaded[i]=o),t(s);const c=a.rawData,h={};a.expires&&(h.expires=a.expires),a.cacheControl&&(h.cacheControl=a.cacheControl),o.vectorTile=a.vectorTile||new Ac.VectorTile(new gh(c));const u=()=>{o.parse(o.vectorTile,this.layerIndex,this.availableImages,this.actor,(e,i)=>{if(e||!i)return t(e);const o={};if(n){const e=md(r);e.length>0&&(o.resourceTiming=JSON.parse(JSON.stringify(e)));}t(null,ee({rawTileData:c.slice(0)},i,h,o));});};this.isSpriteLoaded?u():this.once("isSpriteLoaded",()=>{this.scheduler?this.scheduler.add(u,{type:"parseTile",isSymbolTile:e.isSymbolTile,zoom:e.tileZoom}):u();}),this.loaded=this.loaded||{},this.loaded[i]=o;});}reloadTile(e,t){const i=this.loaded,r=e.uid,n=this;if(i&&i[r]){const o=i[r];o.showCollisionBoxes=e.showCollisionBoxes,o.enableTerrain=!!e.enableTerrain,o.projection=e.projection;const s=(e,i)=>{const r=o.reloadCallback;r&&(delete o.reloadCallback,o.parse(o.vectorTile,n.layerIndex,this.availableImages,n.actor,r)),t(e,i);};"parsing"===o.status?o.reloadCallback=s:"done"===o.status&&(o.vectorTile?o.parse(o.vectorTile,this.layerIndex,this.availableImages,this.actor,s):s());}}abortTile(e,t){const i=e.uid,r=this.loading[i];r&&(r.abort&&r.abort(),delete this.loading[i]),t();}removeTile(e,t){const i=this.loaded,r=e.uid;i&&i[r]&&delete i[r],t();}},e.WritingMode=jh,e.ZoomHistory=Jn,e.add=b,e.addDynamicAttributes=Hu,e.adjoint=function(e,t){var i=t[0],r=t[1],n=t[2],o=t[3],s=t[4],a=t[5],l=t[6],c=t[7],h=t[8];return e[0]=s*h-a*c,e[1]=n*c-r*h,e[2]=r*a-n*s,e[3]=a*l-o*h,e[4]=i*h-n*l,e[5]=n*o-i*a,e[6]=o*c-s*l,e[7]=r*l-i*c,e[8]=i*s-r*o,e;},e.asyncAll=K,e.bezier=Z,e.bindAll=se,e.boundsAttributes=np,e.bufferConvexPolygon=function(e,t){const i=[];for(let r=0;r<e.length;r++){const n=J(r-1,-1,e.length-1),o=J(r+1,-1,e.length-1),s=e[r],a=e[o],l=e[n].sub(s).unit(),c=a.sub(s).unit(),h=c.angleWithSep(l.x,l.y),u=l.add(c).unit().mult(-1*t/Math.sin(h/2));i.push(s.add(u));}return i;},e.cacheEntryPossiblyAdded=function(e){tt++,tt>Ke&&(e.getActor().send("enforceCacheSizeLimit",Je),tt=0);},e.calculateGlobeMatrix=bp,e.calculateGlobeMercatorMatrix=function(e){const t=e.worldSize,i=W(e.center.lat,-85.051129,Va),r=new n(za(e.center.lng)*t,Ra(i)*t),o=Oa(1,e.center.lat)*t,s=e.pixelsPerMeter,a=t/(o/e.pixelsPerMeter),l=h(new Float64Array(16));return d(l,l,[r.x,r.y,0]),p(l,l,[a,a,s]),l;},e.clamp=W,e.clearTileCache=function(e){const t=s.caches.delete(Xe);e&&t.catch(e).then(()=>e());},e.clipLine=pu,e.clone=function(e){var t=new l(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t;},e.clone$1=he,e.collisionCircleLayout=nh,e.config=Ee,e.conjugate=function(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e;},e.create=function(){var e=new l(16);return l!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e;},e.create$1=c,e.createExpression=$r,e.createLayout=us,e.createStyleLayer=function(e){return "custom"===e.type?new id(e):new od[e.type](e);},e.cross=C,e.degToRad=j,e.div=function(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e[2]=t[2]/i[2],e;},e.dot=M,e.ease=X,e.easeCubicInOut=q,e.emitValidationErrors=Un,e.endsWith=ae,e.enforceCacheSizeLimit=function(e){Qe(),We&&We.then(t=>{t.keys().then(i=>{for(let r=0;r<i.length-e;r++)t.delete(i[r]);});});},e.evaluateSizeForFeature=lh,e.evaluateSizeForZoom=ch,e.evaluateVariableOffset=Lu,e.evented=Go,e.exactEquals=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3];},e.exactEquals$1=function(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2];},e.exported=we,e.exported$1=Ne,e.extend=ee,e.extend$1=St,e.filterObject=ce,e.fromMat4=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e;},e.fromQuat=function(e,t){var i=t[0],r=t[1],n=t[2],o=t[3],s=i+i,a=r+r,l=n+n,c=i*s,h=r*s,u=r*a,d=n*s,p=n*a,f=n*l,m=o*s,_=o*a,g=o*l;return e[0]=1-u-f,e[1]=h+g,e[2]=d-_,e[3]=0,e[4]=h-g,e[5]=1-c-f,e[6]=p+m,e[7]=0,e[8]=d+_,e[9]=p-m,e[10]=1-c-u,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e;},e.fromRotation=function(e,t){var i=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=i,e[2]=0,e[3]=-i,e[4]=r,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e;},e.fromScaling=function(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e;},e.furthestTileCorner=function(e){const t=Math.round((e+45+360)%360/90)%4;return H[t];},e.getAABBPointSquareDist=function(e,t,i){let r=0;for(let n=0;n<2;++n){const o=i?i[n]:0;e[n]>o&&(r+=(e[n]-o)*(e[n]-o)),t[n]<o&&(r+=(o-t[n])*(o-t[n]));}return r;},e.getAnchorAlignment=tu,e.getAnchorJustification=ku,e.getBounds=function(e){let t=1/0,i=1/0,r=-1/0,o=-1/0;for(const n of e)t=Math.min(t,n.x),i=Math.min(i,n.y),r=Math.max(r,n.x),o=Math.max(o,n.y);return {min:new n(t,i),max:new n(r,o)};},e.getColumn=function(e,t){return [e[4*t],e[4*t+1],e[4*t+2],e[4*t+3]];},e.getImage=pt,e.getJSON=function(e,t){return ot(ee(e,{type:"json"}),t);},e.getMapSessionAPI=qe,e.getPerformanceMeasurement=md,e.getProjection=function(e){const t=qp[e.name];if(!t)throw new Error(`Invalid projection name: ${e.name}`);return t.conic?function(e,t){if(t.parallels&&Math.abs(t.parallels[0]+t.parallels[1])<.01){let i=function(e){const t=Math.max(.01,Math.cos(j(e))),i=1/(2*Math.max(Math.PI*t,1/t));return {wrap:!0,supportsWorldCopies:!0,unsupportedLayers:["custom"],project(e,r){const n=j(e)*t,o=Math.sin(j(r))/t;return {x:n*i+.5,y:-o*i+.5,z:0};},unproject(e,r){const n=-(r-.5)/i,o=W($((e-.5)/i)/t,-180,180),s=Math.asin(W(n*t,-1,1)),a=W($(s),-85.051129,Va);return new La(o,a);}};}(t.parallels[0]);if("lambertConformalConic"===t.name){const{project:e,unproject:t}=qp.mercator;i={wrap:!0,supportsWorldCopies:!0,project:e,unproject:t};}return ee({},e,t,i);}return ee({},e,t);}(t,e):t;},e.getRTLTextPluginStatus=jo,e.getReferrer=nt,e.getTilePoint=function(e,{x:t,y:i},r=0){return new n(((t-r)*e.scale-e.x)*Ca,(i*e.scale-e.y)*Ca);},e.getTileVec3=function(e,t,i=0){return v(((t.x-i)*e.scale-e.x)*Ca,(t.y*e.scale-e.y)*Ca,Ua(t.z,t.y));},e.getVideo=function(e,t){const i=s.document.createElement("video");i.muted=!0,i.onloadstart=function(){t(null,i);};for(let t=0;t<e.length;t++){const r=s.document.createElement("source");ct(e[t])||(i.crossOrigin="Anonymous"),r.src=e[t],i.appendChild(r);}return {cancel:()=>{}};},e.globeBuffersForTileMesh=function(e,t,i,r){const n=e.context,o=e.transform;let s=t.globeGridBuffer,a=t.globePoleBuffer;if(!s){const e=Sp.createGridVertices(i.canonical);s=t.globeGridBuffer=n.createVertexBuffer(e,cp,!1);}if(!a){const e=Sp.createPoleTriangleVertices(r,o.tileSize*r,0===i.canonical.y);a=t.globePoleBuffer=n.createVertexBuffer(e,cp,!1);}return [s,a];},e.globeDenormalizeECEF=vp,e.globeMatrixForTile=function(e,t){const i=vp(mp(e)),r=((n=new Float64Array(16))[0]=(o=t)[0],n[1]=o[1],n[2]=o[2],n[3]=o[3],n[4]=o[4],n[5]=o[5],n[6]=o[6],n[7]=o[7],n[8]=o[8],n[9]=o[9],n[10]=o[10],n[11]=o[11],n[12]=o[12],n[13]=o[13],n[14]=o[14],n[15]=o[15],n);var n,o;return _(r,r,i),r;},e.globePoleMatrixForTile=function(e,t,i){const r=h(new Float64Array(16)),n=Math.pow(2,e.z),o=(e.x-n/2)/n*Math.PI*2,s=i.point,a=i.worldSize/(i.tileSize*n);return d(r,r,[s.x,s.y,-i.worldSize/Math.PI/2]),p(r,r,[a,a,a]),f(r,r,j(-i._center.lat)),m(r,r,j(-i._center.lng)),m(r,r,o),t&&p(r,r,[1,-1,1]),r;},e.globeTileBounds=mp,e.globeToMercatorTransition=function(e){return Y(5,6,e);},e.identity=h,e.identity$1=F,e.invert=function(e,t){var i=t[0],r=t[1],n=t[2],o=t[3],s=t[4],a=t[5],l=t[6],c=t[7],h=t[8],u=t[9],d=t[10],p=t[11],f=t[12],m=t[13],_=t[14],g=t[15],y=i*a-r*s,x=i*l-n*s,v=i*c-o*s,b=r*l-n*a,S=r*c-o*a,w=n*c-o*l,T=h*m-u*f,E=h*_-d*f,N=h*g-p*f,I=u*_-d*m,M=u*g-p*m,C=d*g-p*_,A=y*C-x*M+v*I+b*N-S*E+w*T;return A?(e[0]=(a*C-l*M+c*I)*(A=1/A),e[1]=(n*M-r*C-o*I)*A,e[2]=(m*w-_*S+g*b)*A,e[3]=(d*S-u*w-p*b)*A,e[4]=(l*N-s*C-c*E)*A,e[5]=(i*C-n*N+o*E)*A,e[6]=(_*v-f*w-g*x)*A,e[7]=(h*w-d*v+p*x)*A,e[8]=(s*M-a*N+c*T)*A,e[9]=(r*N-i*M-o*T)*A,e[10]=(f*S-m*v+g*y)*A,e[11]=(u*v-h*S-p*y)*A,e[12]=(a*E-s*I-l*T)*A,e[13]=(i*I-r*E+n*T)*A,e[14]=(m*x-f*b-_*y)*A,e[15]=(h*b-u*x+d*y)*A,e):null;},e.isMapAuthenticated=function(e){return Ze.has(e);},e.isMapboxURL=ke,e.isSafariWithAntialiasingBug=function(e){const t=e.navigator?e.navigator.userAgent:null;return !!be(e)&&t&&(t.match("Version/15.4")||t.match("Version/15.5")||t.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/));},e.latFromMercatorY=Ba,e.len=z,e.length=x,e.length$1=function(e){return Math.hypot(e[0],e[1],e[2],e[3]);},e.loadVectorTile=Mp,e.makeRequest=ot,e.mercatorXfromLng=za,e.mercatorYfromLat=Ra,e.mercatorZfromAltitude=Oa,e.mul=_,e.mul$1=k,e.multiply=function(e,t,i){var r=t[0],n=t[1],o=t[2],s=t[3],a=t[4],l=t[5],c=t[6],h=t[7],u=t[8],d=i[0],p=i[1],f=i[2],m=i[3],_=i[4],g=i[5],y=i[6],x=i[7],v=i[8];return e[0]=d*r+p*s+f*c,e[1]=d*n+p*a+f*h,e[2]=d*o+p*l+f*u,e[3]=m*r+_*s+g*c,e[4]=m*n+_*a+g*h,e[5]=m*o+_*l+g*u,e[6]=y*r+x*s+v*c,e[7]=y*n+x*a+v*h,e[8]=y*o+x*l+v*u,e;},e.multiply$1=u,e.multiply$2=w,e.nextPowerOfTwo=ne,e.normalize=I,e.normalize$1=function(e,t){var i=t[0],r=t[1],n=t[2],o=t[3],s=i*i+r*r+n*n+o*o;return s>0&&(s=1/Math.sqrt(s)),e[0]=i*s,e[1]=r*s,e[2]=n*s,e[3]=o*s,e;},e.number=Oi,e.ortho=function(e,t,i,r,n,o,s){var a=1/(t-i),l=1/(r-n),c=1/(o-s);return e[0]=-2*a,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*c,e[11]=0,e[12]=(t+i)*a,e[13]=(n+r)*l,e[14]=(s+o)*c,e[15]=1,e;},e.pbf=gh,e.perspective=function(e,t,i,r,n){var o,s=1/Math.tan(t/2);return e[0]=s/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=s,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=n&&n!==1/0?(e[10]=(n+r)*(o=1/(r-n)),e[14]=2*n*r*o):(e[10]=-1,e[14]=-2*r),e;},e.pick=function(e,t){const i={};for(let r=0;r<t.length;r++){const n=t[r];n in e&&(i[n]=e[n]);}return i;},e.plugin=Ho,e.pointGeometry=n,e.polygonIntersectsBox=ll,e.polygonIntersectsPolygon=Ka,e.polygonizeBounds=function(e,t,i=0,r=!0){const o=new n(i,i),s=e.sub(o),a=t.add(o),l=[s,new n(a.x,s.y),a,new n(s.x,a.y)];return r&&l.push(s),l;},e.posAttributes=Yd,e.postMapLoadEvent=$e,e.postTurnstileEvent=Ge,e.potpack=Uh,e.prevPowerOfTwo=function(e){return e<=1?1:Math.pow(2,Math.floor(Math.log(e)/Math.LN2));},e.radToDeg=$,e.refProperties=["type","source","source-layer","minzoom","maxzoom","filter","layout"],e.registerForPluginStateChange=function(e){return e({pluginStatus:Fo,pluginURL:Bo}),Go.on("pluginStateChange",e),e;},e.removeAuthState=function(e){Ze.delete(e);},e.renderColorRamp=Al,e.rotateX=f,e.rotateX$1=B,e.rotateY=m,e.rotateZ=function(e,t,i){var r=Math.sin(i),n=Math.cos(i),o=t[0],s=t[1],a=t[2],l=t[3],c=t[4],h=t[5],u=t[6],d=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=o*n+c*r,e[1]=s*n+h*r,e[2]=a*n+u*r,e[3]=l*n+d*r,e[4]=c*n-o*r,e[5]=h*n-s*r,e[6]=u*n-a*r,e[7]=d*n-l*r,e;},e.rotateZ$1=function(e,t,i){i*=.5;var r=t[0],n=t[1],o=t[2],s=t[3],a=Math.sin(i),l=Math.cos(i);return e[0]=r*l+n*a,e[1]=n*l-r*a,e[2]=o*l+s*a,e[3]=s*l-o*a,e;},e.scale=p,e.scale$1=function(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e;},e.scale$2=E,e.scaleAndAdd=N,e.setCacheLimits=function(e,t){Je=e,Ke=t;},e.setColumn=function(e,t,i){e[4*t+0]=i[0],e[4*t+1]=i[1],e[4*t+2]=i[2],e[4*t+3]=i[3];},e.setRTLTextPlugin=function(e,t,i=!1){if(Fo===ko||Fo===zo||Fo===Ro)throw new Error("setRTLTextPlugin cannot be called multiple times.");Bo=we.resolveURL(e),Fo=ko,Oo=t,Vo(),i||$o();},e.smoothstep=Y,e.spec=xt,e.storeAuthState=function(e,t){t?Ze.add(e):Ze.delete(e);},e.sub=D,e.subtract=S,e.symbolSize=hh,e.tileAABB=function(e,t,i,r,n,o,s,a,l){if("globe"===l.name){const s=mp(new xd(o,new yd(i,r,n)).canonical).getCorners(),a=Number.MAX_VALUE,l=[-a,-a,-a],d=[a,a,a],p=bp(e,t);for(let e=0;e<s.length;e++)A(s[e],s[e],p),h=d,u=s[e],(c=d)[0]=Math.min(h[0],u[0]),c[1]=Math.min(h[1],u[1]),c[2]=Math.min(h[2],u[2]),T(l,l,s[e]);return new gl(d,l);}var c,h,u;const d=wp({z:i,x:r,y:n},l);return new gl([(o+d.x/d.scale)*t,t*(d.y/d.scale),s],[(o+d.x2/d.scale)*t,t*(d.y2/d.scale),a]);},e.tileTransform=wp,e.transformMat3=function(e,t,i){var r=t[0],n=t[1],o=t[2];return e[0]=r*i[0]+n*i[3]+o*i[6],e[1]=r*i[1]+n*i[4]+o*i[7],e[2]=r*i[2]+n*i[5]+o*i[8],e;},e.transformMat4=A,e.transformMat4$1=R,e.transformQuat=P,e.translate=d,e.transpose=function(e,t){if(e===t){var i=t[1],r=t[2],n=t[5];e[1]=t[3],e[2]=t[6],e[3]=i,e[5]=t[7],e[6]=r,e[7]=n;}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e;},e.triggerPluginCompletionEvent=Uo,e.uniqueId=ie,e.validateCustomStyleLayer=function(e){const t=[],i=e.id;return void 0===i&&t.push({message:`layers.${i}: missing required property "id"`}),void 0===e.render&&t.push({message:`layers.${i}: missing required method "render"`}),e.renderingMode&&"2d"!==e.renderingMode&&"3d"!==e.renderingMode&&t.push({message:`layers.${i}: property "renderingMode" must be either "2d" or "3d"`}),t;},e.validateFog=On,e.validateLight=Rn,e.validateStyle=zn,e.values=Q,e.vectorTile=Ac,e.version=t,e.warnOnce=de,e.window=s,e.wrap=J;}),r(["./shared"],function(e){function t(e){const i=typeof e;if("number"===i||"boolean"===i||"string"===i||null==e)return JSON.stringify(e);if(Array.isArray(e)){let i="[";for(const r of e)i+=`${t(r)},`;return `${i}]`;}const r=Object.keys(e).sort();let n="{";for(let i=0;i<r.length;i++)n+=`${JSON.stringify(r[i])}:${t(e[r[i]])},`;return `${n}}`;}function i(i){let r="";for(const n of e.refProperties)r+=`/${t(i[n])}`;return r;}class r{constructor(e){this.keyCache={},e&&this.replace(e);}replace(e){this._layerConfigs={},this._layers={},this.update(e,[]);}update(t,r){for(const i of t)this._layerConfigs[i.id]=i,(this._layers[i.id]=e.createStyleLayer(i)).compileFilter(),this.keyCache[i.id]&&delete this.keyCache[i.id];for(const e of r)delete this.keyCache[e],delete this._layerConfigs[e],delete this._layers[e];this.familiesBySource={};const n=function(e,t){const r={};for(let n=0;n<e.length;n++){const o=t&&t[e[n].id]||i(e[n]);t&&(t[e[n].id]=o);let s=r[o];s||(s=r[o]=[]),s.push(e[n]);}const n=[];for(const e in r)n.push(r[e]);return n;}(e.values(this._layerConfigs),this.keyCache);for(const e of n){const t=e.map(e=>this._layers[e.id]),i=t[0];if("none"===i.visibility)continue;const r=i.source||"";let n=this.familiesBySource[r];n||(n=this.familiesBySource[r]={});const o=i.sourceLayer||"_geojsonTileLayer";let s=n[o];s||(s=n[o]=[]),s.push(t);}}}const{ImageBitmap:n}=e.window;class o{loadTile(t,i){const{uid:r,encoding:o,rawImageData:s,padding:a,buildQuadTree:l}=t,c=n&&s instanceof n?this.getImageData(s,a):s;i(null,new e.DEMData(r,c,o,a<1,l));}getImageData(t,i){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(t.width,t.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d")),this.offscreenCanvas.width=t.width,this.offscreenCanvas.height=t.height,this.offscreenCanvasContext.drawImage(t,0,0,t.width,t.height);const r=this.offscreenCanvasContext.getImageData(-i,-i,t.width+2*i,t.height+2*i);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),new e.RGBAImage({width:r.width,height:r.height},r.data);}}var s=function e(t,i){var r,n=t&&t.type;if("FeatureCollection"===n)for(r=0;r<t.features.length;r++)e(t.features[r],i);else if("GeometryCollection"===n)for(r=0;r<t.geometries.length;r++)e(t.geometries[r],i);else if("Feature"===n)e(t.geometry,i);else if("Polygon"===n)a(t.coordinates,i);else if("MultiPolygon"===n)for(r=0;r<t.coordinates.length;r++)a(t.coordinates[r],i);return t;};function a(e,t){if(0!==e.length){l(e[0],t);for(var i=1;i<e.length;i++)l(e[i],!t);}}function l(e,t){for(var i=0,r=0,n=0,o=e.length,s=o-1;n<o;s=n++){var a=(e[n][0]-e[s][0])*(e[s][1]+e[n][1]),l=i+a;r+=Math.abs(i)>=Math.abs(a)?i-l+a:a-l+i,i=l;}i+r>=0!=!!t&&e.reverse();}const c=e.vectorTile.VectorTileFeature.prototype.toGeoJSON;class h{constructor(t){this._feature=t,this.extent=e.EXTENT,this.type=t.type,this.properties=t.tags,"id"in t&&!isNaN(t.id)&&(this.id=parseInt(t.id,10));}loadGeometry(){if(1===this._feature.type){const t=[];for(const i of this._feature.geometry)t.push([new e.pointGeometry(i[0],i[1])]);return t;}{const t=[];for(const i of this._feature.geometry){const r=[];for(const t of i)r.push(new e.pointGeometry(t[0],t[1]));t.push(r);}return t;}}toGeoJSON(e,t,i){return c.call(this,e,t,i);}}class u{constructor(t){this.layers={_geojsonTileLayer:this},this.name="_geojsonTileLayer",this.extent=e.EXTENT,this.length=t.length,this._features=t;}feature(e){return new h(this._features[e]);}}var d=e.vectorTile.VectorTileFeature,p=f;function f(e,t){this.options=t||{},this.features=e,this.length=e.length;}function m(e,t){this.id="number"==typeof e.id?e.id:void 0,this.type=e.type,this.rawGeometry=1===e.type?[e.geometry]:e.geometry,this.properties=e.tags,this.extent=t||4096;}f.prototype.feature=function(e){return new m(this.features[e],this.options.extent);},m.prototype.loadGeometry=function(){var t=this.rawGeometry;this.geometry=[];for(var i=0;i<t.length;i++){for(var r=t[i],n=[],o=0;o<r.length;o++)n.push(new e.pointGeometry(r[o][0],r[o][1]));this.geometry.push(n);}return this.geometry;},m.prototype.bbox=function(){this.geometry||this.loadGeometry();for(var e=this.geometry,t=1/0,i=-1/0,r=1/0,n=-1/0,o=0;o<e.length;o++)for(var s=e[o],a=0;a<s.length;a++){var l=s[a];t=Math.min(t,l.x),i=Math.max(i,l.x),r=Math.min(r,l.y),n=Math.max(n,l.y);}return [t,r,i,n];},m.prototype.toGeoJSON=d.prototype.toGeoJSON;var _=y,g=p;function y(t){var i=new e.pbf();return function(e,t){for(var i in e.layers)t.writeMessage(3,x,e.layers[i]);}(t,i),i.finish();}function x(e,t){var i;t.writeVarintField(15,e.version||1),t.writeStringField(1,e.name||""),t.writeVarintField(5,e.extent||4096);var r={keys:[],values:[],keycache:{},valuecache:{}};for(i=0;i<e.length;i++)r.feature=e.feature(i),t.writeMessage(2,v,r);var n=r.keys;for(i=0;i<n.length;i++)t.writeStringField(3,n[i]);var o=r.values;for(i=0;i<o.length;i++)t.writeMessage(4,E,o[i]);}function v(e,t){var i=e.feature;void 0!==i.id&&t.writeVarintField(1,i.id),t.writeMessage(2,b,e),t.writeVarintField(3,i.type),t.writeMessage(4,T,i);}function b(e,t){var i=e.feature,r=e.keys,n=e.values,o=e.keycache,s=e.valuecache;for(var a in i.properties){var l=i.properties[a],c=o[a];if(null!==l){void 0===c&&(r.push(a),o[a]=c=r.length-1),t.writeVarint(c);var h=typeof l;"string"!==h&&"boolean"!==h&&"number"!==h&&(l=JSON.stringify(l));var u=h+":"+l,d=s[u];void 0===d&&(n.push(l),s[u]=d=n.length-1),t.writeVarint(d);}}}function S(e,t){return (t<<3)+(7&e);}function w(e){return e<<1^e>>31;}function T(e,t){for(var i=e.loadGeometry(),r=e.type,n=0,o=0,s=i.length,a=0;a<s;a++){var l=i[a],c=1;1===r&&(c=l.length),t.writeVarint(S(1,c));for(var h=3===r?l.length-1:l.length,u=0;u<h;u++){1===u&&1!==r&&t.writeVarint(S(2,h-1));var d=l[u].x-n,p=l[u].y-o;t.writeVarint(w(d)),t.writeVarint(w(p)),n+=d,o+=p;}3===r&&t.writeVarint(S(7,1));}}function E(e,t){var i=typeof e;"string"===i?t.writeStringField(1,e):"boolean"===i?t.writeBooleanField(7,e):"number"===i&&(e%1!=0?t.writeDoubleField(3,e):e<0?t.writeSVarintField(6,e):t.writeVarintField(5,e));}function N(e,t,i,r,n,o){if(n-r<=i)return;const s=r+n>>1;I(e,t,s,r,n,o%2),N(e,t,i,r,s-1,o+1),N(e,t,i,s+1,n,o+1);}function I(e,t,i,r,n,o){for(;n>r;){if(n-r>600){const s=n-r+1,a=i-r+1,l=Math.log(s),c=.5*Math.exp(2*l/3),h=.5*Math.sqrt(l*c*(s-c)/s)*(a-s/2<0?-1:1);I(e,t,i,Math.max(r,Math.floor(i-a*c/s+h)),Math.min(n,Math.floor(i+(s-a)*c/s+h)),o);}const s=t[2*i+o];let a=r,l=n;for(M(e,t,r,i),t[2*n+o]>s&&M(e,t,r,n);a<l;){for(M(e,t,a,l),a++,l--;t[2*a+o]<s;)a++;for(;t[2*l+o]>s;)l--;}t[2*r+o]===s?M(e,t,r,l):(l++,M(e,t,l,n)),l<=i&&(r=l+1),i<=l&&(n=l-1);}}function M(e,t,i,r){C(e,i,r),C(t,2*i,2*r),C(t,2*i+1,2*r+1);}function C(e,t,i){const r=e[t];e[t]=e[i],e[i]=r;}function A(e,t,i,r){const n=e-i,o=t-r;return n*n+o*o;}_.fromVectorTileJs=y,_.fromGeojsonVt=function(e,t){t=t||{};var i={};for(var r in e)i[r]=new p(e[r].features,t),i[r].name=r,i[r].version=t.version,i[r].extent=t.extent;return y({layers:i});},_.GeoJSONWrapper=g;const P=e=>e[0],L=e=>e[1];class D{constructor(e,t=P,i=L,r=64,n=Float64Array){this.nodeSize=r,this.points=e;const o=e.length<65536?Uint16Array:Uint32Array,s=this.ids=new o(e.length),a=this.coords=new n(2*e.length);for(let r=0;r<e.length;r++)s[r]=r,a[2*r]=t(e[r]),a[2*r+1]=i(e[r]);N(s,a,r,0,s.length-1,0);}range(e,t,i,r){return function(e,t,i,r,n,o,s){const a=[0,e.length-1,0],l=[];let c,h;for(;a.length;){const u=a.pop(),d=a.pop(),p=a.pop();if(d-p<=s){for(let s=p;s<=d;s++)c=t[2*s],h=t[2*s+1],c>=i&&c<=n&&h>=r&&h<=o&&l.push(e[s]);continue;}const f=Math.floor((p+d)/2);c=t[2*f],h=t[2*f+1],c>=i&&c<=n&&h>=r&&h<=o&&l.push(e[f]);const m=(u+1)%2;(0===u?i<=c:r<=h)&&(a.push(p),a.push(f-1),a.push(m)),(0===u?n>=c:o>=h)&&(a.push(f+1),a.push(d),a.push(m));}return l;}(this.ids,this.coords,e,t,i,r,this.nodeSize);}within(e,t,i){return function(e,t,i,r,n,o){const s=[0,e.length-1,0],a=[],l=n*n;for(;s.length;){const c=s.pop(),h=s.pop(),u=s.pop();if(h-u<=o){for(let n=u;n<=h;n++)A(t[2*n],t[2*n+1],i,r)<=l&&a.push(e[n]);continue;}const d=Math.floor((u+h)/2),p=t[2*d],f=t[2*d+1];A(p,f,i,r)<=l&&a.push(e[d]);const m=(c+1)%2;(0===c?i-n<=p:r-n<=f)&&(s.push(u),s.push(d-1),s.push(m)),(0===c?i+n>=p:r+n>=f)&&(s.push(d+1),s.push(h),s.push(m));}return a;}(this.ids,this.coords,e,t,i,this.nodeSize);}}const k={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:e=>e},z=Math.fround||(R=new Float32Array(1),e=>(R[0]=+e,R[0]));var R;class O{constructor(e){this.options=H(Object.create(k),e),this.trees=new Array(this.options.maxZoom+1);}load(e){const{log:t,minZoom:i,maxZoom:r,nodeSize:n}=this.options;t&&console.time("total time");const o=`prepare ${e.length} points`;t&&console.time(o),this.points=e;let s=[];for(let t=0;t<e.length;t++)e[t].geometry&&s.push(B(e[t],t));this.trees[r+1]=new D(s,q,Z,n,Float32Array),t&&console.timeEnd(o);for(let e=r;e>=i;e--){const i=+Date.now();s=this._cluster(s,e),this.trees[e]=new D(s,q,Z,n,Float32Array),t&&console.log("z%d: %d clusters in %dms",e,s.length,+Date.now()-i);}return t&&console.timeEnd("total time"),this;}getClusters(e,t){let i=((e[0]+180)%360+360)%360-180;const r=Math.max(-90,Math.min(90,e[1]));let n=180===e[2]?180:((e[2]+180)%360+360)%360-180;const o=Math.max(-90,Math.min(90,e[3]));if(e[2]-e[0]>=360)i=-180,n=180;else if(i>n){const e=this.getClusters([i,r,180,o],t),s=this.getClusters([-180,r,n,o],t);return e.concat(s);}const s=this.trees[this._limitZoom(t)],a=s.range(G(i),j(o),G(n),j(r)),l=[];for(const e of a){const t=s.points[e];l.push(t.numPoints?U(t):this.points[t.index]);}return l;}getChildren(e){const t=this._getOriginId(e),i=this._getOriginZoom(e),r="No cluster with the specified id.",n=this.trees[i];if(!n)throw new Error(r);const o=n.points[t];if(!o)throw new Error(r);const s=this.options.radius/(this.options.extent*Math.pow(2,i-1)),a=n.within(o.x,o.y,s),l=[];for(const t of a){const i=n.points[t];i.parentId===e&&l.push(i.numPoints?U(i):this.points[i.index]);}if(0===l.length)throw new Error(r);return l;}getLeaves(e,t,i){const r=[];return this._appendLeaves(r,e,t=t||10,i=i||0,0),r;}getTile(e,t,i){const r=this.trees[this._limitZoom(e)],n=Math.pow(2,e),{extent:o,radius:s}=this.options,a=s/o,l=(i-a)/n,c=(i+1+a)/n,h={features:[]};return this._addTileFeatures(r.range((t-a)/n,l,(t+1+a)/n,c),r.points,t,i,n,h),0===t&&this._addTileFeatures(r.range(1-a/n,l,1,c),r.points,n,i,n,h),t===n-1&&this._addTileFeatures(r.range(0,l,a/n,c),r.points,-1,i,n,h),h.features.length?h:null;}getClusterExpansionZoom(e){let t=this._getOriginZoom(e)-1;for(;t<=this.options.maxZoom;){const i=this.getChildren(e);if(t++,1!==i.length)break;e=i[0].properties.cluster_id;}return t;}_appendLeaves(e,t,i,r,n){const o=this.getChildren(t);for(const t of o){const o=t.properties;if(o&&o.cluster?n+o.point_count<=r?n+=o.point_count:n=this._appendLeaves(e,o.cluster_id,i,r,n):n<r?n++:e.push(t),e.length===i)break;}return n;}_addTileFeatures(e,t,i,r,n,o){for(const s of e){const e=t[s],a=e.numPoints;let l,c,h;if(a)l=V(e),c=e.x,h=e.y;else {const t=this.points[e.index];l=t.properties,c=G(t.geometry.coordinates[0]),h=j(t.geometry.coordinates[1]);}const u={type:1,geometry:[[Math.round(this.options.extent*(c*n-i)),Math.round(this.options.extent*(h*n-r))]],tags:l};let d;a?d=e.id:this.options.generateId?d=e.index:this.points[e.index].id&&(d=this.points[e.index].id),void 0!==d&&(u.id=d),o.features.push(u);}}_limitZoom(e){return Math.max(this.options.minZoom,Math.min(+e,this.options.maxZoom+1));}_cluster(e,t){const i=[],{radius:r,extent:n,reduce:o,minPoints:s}=this.options,a=r/(n*Math.pow(2,t));for(let r=0;r<e.length;r++){const n=e[r];if(n.zoom<=t)continue;n.zoom=t;const l=this.trees[t+1],c=l.within(n.x,n.y,a),h=n.numPoints||1;let u=h;for(const e of c){const i=l.points[e];i.zoom>t&&(u+=i.numPoints||1);}if(u>h&&u>=s){let e=n.x*h,s=n.y*h,a=o&&h>1?this._map(n,!0):null;const d=(r<<5)+(t+1)+this.points.length;for(const i of c){const r=l.points[i];if(r.zoom<=t)continue;r.zoom=t;const c=r.numPoints||1;e+=r.x*c,s+=r.y*c,r.parentId=d,o&&(a||(a=this._map(n,!0)),o(a,this._map(r)));}n.parentId=d,i.push(F(e/u,s/u,d,u,a));}else if(i.push(n),u>1)for(const e of c){const r=l.points[e];r.zoom<=t||(r.zoom=t,i.push(r));}}return i;}_getOriginId(e){return e-this.points.length>>5;}_getOriginZoom(e){return (e-this.points.length)%32;}_map(e,t){if(e.numPoints)return t?H({},e.properties):e.properties;const i=this.points[e.index].properties,r=this.options.map(i);return t&&r===i?H({},r):r;}}function F(e,t,i,r,n){return {x:z(e),y:z(t),zoom:1/0,id:i,parentId:-1,numPoints:r,properties:n};}function B(e,t){const[i,r]=e.geometry.coordinates;return {x:z(G(i)),y:z(j(r)),zoom:1/0,index:t,parentId:-1};}function U(e){return {type:"Feature",id:e.id,properties:V(e),geometry:{type:"Point",coordinates:[(t=e.x,360*(t-.5)),$(e.y)]}};var t;}function V(e){const t=e.numPoints,i=t>=1e4?`${Math.round(t/1e3)}k`:t>=1e3?Math.round(t/100)/10+"k":t;return H(H({},e.properties),{cluster:!0,cluster_id:e.id,point_count:t,point_count_abbreviated:i});}function G(e){return e/360+.5;}function j(e){const t=Math.sin(e*Math.PI/180),i=.5-.25*Math.log((1+t)/(1-t))/Math.PI;return i<0?0:i>1?1:i;}function $(e){const t=(180-360*e)*Math.PI/180;return 360*Math.atan(Math.exp(t))/Math.PI-90;}function H(e,t){for(const i in t)e[i]=t[i];return e;}function q(e){return e.x;}function Z(e){return e.y;}function X(e,t,i,r){for(var n,o=r,s=i-t>>1,a=i-t,l=e[t],c=e[t+1],h=e[i],u=e[i+1],d=t+3;d<i;d+=3){var p=W(e[d],e[d+1],l,c,h,u);if(p>o)n=d,o=p;else if(p===o){var f=Math.abs(d-s);f<a&&(n=d,a=f);}}o>r&&(n-t>3&&X(e,t,n,r),e[n+2]=o,i-n>3&&X(e,n,i,r));}function W(e,t,i,r,n,o){var s=n-i,a=o-r;if(0!==s||0!==a){var l=((e-i)*s+(t-r)*a)/(s*s+a*a);l>1?(i=n,r=o):l>0&&(i+=s*l,r+=a*l);}return (s=e-i)*s+(a=t-r)*a;}function Y(e,t,i,r){var n={id:void 0===e?null:e,type:t,geometry:i,tags:r,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return function(e){var t=e.geometry,i=e.type;if("Point"===i||"MultiPoint"===i||"LineString"===i)J(e,t);else if("Polygon"===i||"MultiLineString"===i)for(var r=0;r<t.length;r++)J(e,t[r]);else if("MultiPolygon"===i)for(r=0;r<t.length;r++)for(var n=0;n<t[r].length;n++)J(e,t[r][n]);}(n),n;}function J(e,t){for(var i=0;i<t.length;i+=3)e.minX=Math.min(e.minX,t[i]),e.minY=Math.min(e.minY,t[i+1]),e.maxX=Math.max(e.maxX,t[i]),e.maxY=Math.max(e.maxY,t[i+1]);}function K(e,t,i,r){if(t.geometry){var n=t.geometry.coordinates,o=t.geometry.type,s=Math.pow(i.tolerance/((1<<i.maxZoom)*i.extent),2),a=[],l=t.id;if(i.promoteId?l=t.properties[i.promoteId]:i.generateId&&(l=r||0),"Point"===o)Q(n,a);else if("MultiPoint"===o)for(var c=0;c<n.length;c++)Q(n[c],a);else if("LineString"===o)ee(n,a,s,!1);else if("MultiLineString"===o){if(i.lineMetrics){for(c=0;c<n.length;c++)ee(n[c],a=[],s,!1),e.push(Y(l,"LineString",a,t.properties));return;}te(n,a,s,!1);}else if("Polygon"===o)te(n,a,s,!0);else {if("MultiPolygon"!==o){if("GeometryCollection"===o){for(c=0;c<t.geometry.geometries.length;c++)K(e,{id:l,geometry:t.geometry.geometries[c],properties:t.properties},i,r);return;}throw new Error("Input data is not a valid GeoJSON object.");}for(c=0;c<n.length;c++){var h=[];te(n[c],h,s,!0),a.push(h);}}e.push(Y(l,o,a,t.properties));}}function Q(e,t){t.push(ie(e[0])),t.push(re(e[1])),t.push(0);}function ee(e,t,i,r){for(var n,o,s=0,a=0;a<e.length;a++){var l=ie(e[a][0]),c=re(e[a][1]);t.push(l),t.push(c),t.push(0),a>0&&(s+=r?(n*c-l*o)/2:Math.sqrt(Math.pow(l-n,2)+Math.pow(c-o,2))),n=l,o=c;}var h=t.length-3;t[2]=1,X(t,0,h,i),t[h+2]=1,t.size=Math.abs(s),t.start=0,t.end=t.size;}function te(e,t,i,r){for(var n=0;n<e.length;n++){var o=[];ee(e[n],o,i,r),t.push(o);}}function ie(e){return e/360+.5;}function re(e){var t=Math.sin(e*Math.PI/180),i=.5-.25*Math.log((1+t)/(1-t))/Math.PI;return i<0?0:i>1?1:i;}function ne(e,t,i,r,n,o,s,a){if(r/=t,o>=(i/=t)&&s<r)return e;if(s<i||o>=r)return null;for(var l=[],c=0;c<e.length;c++){var h=e[c],u=h.geometry,d=h.type,p=0===n?h.minX:h.minY,f=0===n?h.maxX:h.maxY;if(p>=i&&f<r)l.push(h);else if(!(f<i||p>=r)){var m=[];if("Point"===d||"MultiPoint"===d)oe(u,m,i,r,n);else if("LineString"===d)se(u,m,i,r,n,!1,a.lineMetrics);else if("MultiLineString"===d)le(u,m,i,r,n,!1);else if("Polygon"===d)le(u,m,i,r,n,!0);else if("MultiPolygon"===d)for(var _=0;_<u.length;_++){var g=[];le(u[_],g,i,r,n,!0),g.length&&m.push(g);}if(m.length){if(a.lineMetrics&&"LineString"===d){for(_=0;_<m.length;_++)l.push(Y(h.id,d,m[_],h.tags));continue;}"LineString"!==d&&"MultiLineString"!==d||(1===m.length?(d="LineString",m=m[0]):d="MultiLineString"),"Point"!==d&&"MultiPoint"!==d||(d=3===m.length?"Point":"MultiPoint"),l.push(Y(h.id,d,m,h.tags));}}}return l.length?l:null;}function oe(e,t,i,r,n){for(var o=0;o<e.length;o+=3){var s=e[o+n];s>=i&&s<=r&&(t.push(e[o]),t.push(e[o+1]),t.push(e[o+2]));}}function se(e,t,i,r,n,o,s){for(var a,l,c=ae(e),h=0===n?he:ue,u=e.start,d=0;d<e.length-3;d+=3){var p=e[d],f=e[d+1],m=e[d+2],_=e[d+3],g=e[d+4],y=0===n?p:f,x=0===n?_:g,v=!1;s&&(a=Math.sqrt(Math.pow(p-_,2)+Math.pow(f-g,2))),y<i?x>i&&(l=h(c,p,f,_,g,i),s&&(c.start=u+a*l)):y>r?x<r&&(l=h(c,p,f,_,g,r),s&&(c.start=u+a*l)):ce(c,p,f,m),x<i&&y>=i&&(l=h(c,p,f,_,g,i),v=!0),x>r&&y<=r&&(l=h(c,p,f,_,g,r),v=!0),!o&&v&&(s&&(c.end=u+a*l),t.push(c),c=ae(e)),s&&(u+=a);}var b=e.length-3;p=e[b],f=e[b+1],m=e[b+2],(y=0===n?p:f)>=i&&y<=r&&ce(c,p,f,m),b=c.length-3,o&&b>=3&&(c[b]!==c[0]||c[b+1]!==c[1])&&ce(c,c[0],c[1],c[2]),c.length&&t.push(c);}function ae(e){var t=[];return t.size=e.size,t.start=e.start,t.end=e.end,t;}function le(e,t,i,r,n,o){for(var s=0;s<e.length;s++)se(e[s],t,i,r,n,o,!1);}function ce(e,t,i,r){e.push(t),e.push(i),e.push(r);}function he(e,t,i,r,n,o){var s=(o-t)/(r-t);return e.push(o),e.push(i+(n-i)*s),e.push(1),s;}function ue(e,t,i,r,n,o){var s=(o-i)/(n-i);return e.push(t+(r-t)*s),e.push(o),e.push(1),s;}function de(e,t){for(var i=[],r=0;r<e.length;r++){var n,o=e[r],s=o.type;if("Point"===s||"MultiPoint"===s||"LineString"===s)n=pe(o.geometry,t);else if("MultiLineString"===s||"Polygon"===s){n=[];for(var a=0;a<o.geometry.length;a++)n.push(pe(o.geometry[a],t));}else if("MultiPolygon"===s)for(n=[],a=0;a<o.geometry.length;a++){for(var l=[],c=0;c<o.geometry[a].length;c++)l.push(pe(o.geometry[a][c],t));n.push(l);}i.push(Y(o.id,s,n,o.tags));}return i;}function pe(e,t){var i=[];i.size=e.size,void 0!==e.start&&(i.start=e.start,i.end=e.end);for(var r=0;r<e.length;r+=3)i.push(e[r]+t,e[r+1],e[r+2]);return i;}function fe(e,t){if(e.transformed)return e;var i,r,n,o=1<<e.z,s=e.x,a=e.y;for(i=0;i<e.features.length;i++){var l=e.features[i],c=l.geometry,h=l.type;if(l.geometry=[],1===h)for(r=0;r<c.length;r+=2)l.geometry.push(me(c[r],c[r+1],t,o,s,a));else for(r=0;r<c.length;r++){var u=[];for(n=0;n<c[r].length;n+=2)u.push(me(c[r][n],c[r][n+1],t,o,s,a));l.geometry.push(u);}}return e.transformed=!0,e;}function me(e,t,i,r,n,o){return [Math.round(i*(e*r-n)),Math.round(i*(t*r-o))];}function _e(e,t,i,r,n){for(var o=t===n.maxZoom?0:n.tolerance/((1<<t)*n.extent),s={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:i,y:r,z:t,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0},a=0;a<e.length;a++){s.numFeatures++,ge(s,e[a],o,n);var l=e[a].minX,c=e[a].minY,h=e[a].maxX,u=e[a].maxY;l<s.minX&&(s.minX=l),c<s.minY&&(s.minY=c),h>s.maxX&&(s.maxX=h),u>s.maxY&&(s.maxY=u);}return s;}function ge(e,t,i,r){var n=t.geometry,o=t.type,s=[];if("Point"===o||"MultiPoint"===o)for(var a=0;a<n.length;a+=3)s.push(n[a]),s.push(n[a+1]),e.numPoints++,e.numSimplified++;else if("LineString"===o)ye(s,n,e,i,!1,!1);else if("MultiLineString"===o||"Polygon"===o)for(a=0;a<n.length;a++)ye(s,n[a],e,i,"Polygon"===o,0===a);else if("MultiPolygon"===o)for(var l=0;l<n.length;l++){var c=n[l];for(a=0;a<c.length;a++)ye(s,c[a],e,i,!0,0===a);}if(s.length){var h=t.tags||null;if("LineString"===o&&r.lineMetrics){for(var u in h={},t.tags)h[u]=t.tags[u];h.mapbox_clip_start=n.start/n.size,h.mapbox_clip_end=n.end/n.size;}var d={geometry:s,type:"Polygon"===o||"MultiPolygon"===o?3:"LineString"===o||"MultiLineString"===o?2:1,tags:h};null!==t.id&&(d.id=t.id),e.features.push(d);}}function ye(e,t,i,r,n,o){var s=r*r;if(r>0&&t.size<(n?s:r))i.numPoints+=t.length/3;else {for(var a=[],l=0;l<t.length;l+=3)(0===r||t[l+2]>s)&&(i.numSimplified++,a.push(t[l]),a.push(t[l+1])),i.numPoints++;n&&function(e,t){for(var i=0,r=0,n=e.length,o=n-2;r<n;o=r,r+=2)i+=(e[r]-e[o])*(e[r+1]+e[o+1]);if(i>0===t)for(r=0,n=e.length;r<n/2;r+=2){var s=e[r],a=e[r+1];e[r]=e[n-2-r],e[r+1]=e[n-1-r],e[n-2-r]=s,e[n-1-r]=a;}}(a,o),e.push(a);}}function xe(e,t){var i=(t=this.options=function(e,t){for(var i in t)e[i]=t[i];return e;}(Object.create(this.options),t)).debug;if(i&&console.time("preprocess data"),t.maxZoom<0||t.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(t.promoteId&&t.generateId)throw new Error("promoteId and generateId cannot be used together.");var r=function(e,t){var i=[];if("FeatureCollection"===e.type)for(var r=0;r<e.features.length;r++)K(i,e.features[r],t,r);else K(i,"Feature"===e.type?e:{geometry:e},t);return i;}(e,t);this.tiles={},this.tileCoords=[],i&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",t.indexMaxZoom,t.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),(r=function(e,t){var i=t.buffer/t.extent,r=e,n=ne(e,1,-1-i,i,0,-1,2,t),o=ne(e,1,1-i,2+i,0,-1,2,t);return (n||o)&&(r=ne(e,1,-i,1+i,0,-1,2,t)||[],n&&(r=de(n,1).concat(r)),o&&(r=r.concat(de(o,-1)))),r;}(r,t)).length&&this.splitTile(r,0,0,0),i&&(r.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)));}function ve(e,t,i){return 32*((1<<e)*i+t)+e;}function be(e,t){const i=e.tileID.canonical;if(!this._geoJSONIndex)return t(null,null);const r=this._geoJSONIndex.getTile(i.z,i.x,i.y);if(!r)return t(null,null);const n=new u(r.features);let o=_(n);0===o.byteOffset&&o.byteLength===o.buffer.byteLength||(o=new Uint8Array(o)),t(null,{vectorTile:n,rawData:o.buffer});}xe.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0},xe.prototype.splitTile=function(e,t,i,r,n,o,s){for(var a=[e,t,i,r],l=this.options,c=l.debug;a.length;){r=a.pop(),i=a.pop(),t=a.pop(),e=a.pop();var h=1<<t,u=ve(t,i,r),d=this.tiles[u];if(!d&&(c>1&&console.time("creation"),d=this.tiles[u]=_e(e,t,i,r,l),this.tileCoords.push({z:t,x:i,y:r}),c)){c>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",t,i,r,d.numFeatures,d.numPoints,d.numSimplified),console.timeEnd("creation"));var p="z"+t;this.stats[p]=(this.stats[p]||0)+1,this.total++;}if(d.source=e,n){if(t===l.maxZoom||t===n)continue;var f=1<<n-t;if(i!==Math.floor(o/f)||r!==Math.floor(s/f))continue;}else if(t===l.indexMaxZoom||d.numPoints<=l.indexMaxPoints)continue;if(d.source=null,0!==e.length){c>1&&console.time("clipping");var m,_,g,y,x,v,b=.5*l.buffer/l.extent,S=.5-b,w=.5+b,T=1+b;m=_=g=y=null,x=ne(e,h,i-b,i+w,0,d.minX,d.maxX,l),v=ne(e,h,i+S,i+T,0,d.minX,d.maxX,l),e=null,x&&(m=ne(x,h,r-b,r+w,1,d.minY,d.maxY,l),_=ne(x,h,r+S,r+T,1,d.minY,d.maxY,l),x=null),v&&(g=ne(v,h,r-b,r+w,1,d.minY,d.maxY,l),y=ne(v,h,r+S,r+T,1,d.minY,d.maxY,l),v=null),c>1&&console.timeEnd("clipping"),a.push(m||[],t+1,2*i,2*r),a.push(_||[],t+1,2*i,2*r+1),a.push(g||[],t+1,2*i+1,2*r),a.push(y||[],t+1,2*i+1,2*r+1);}}},xe.prototype.getTile=function(e,t,i){var r=this.options,n=r.extent,o=r.debug;if(e<0||e>24)return null;var s=1<<e,a=ve(e,t=(t%s+s)%s,i);if(this.tiles[a])return fe(this.tiles[a],n);o>1&&console.log("drilling down to z%d-%d-%d",e,t,i);for(var l,c=e,h=t,u=i;!l&&c>0;)c--,h=Math.floor(h/2),u=Math.floor(u/2),l=this.tiles[ve(c,h,u)];return l&&l.source?(o>1&&console.log("found parent tile z%d-%d-%d",c,h,u),o>1&&console.time("drilling down"),this.splitTile(l.source,c,h,u,e,t,i),o>1&&console.timeEnd("drilling down"),this.tiles[a]?fe(this.tiles[a],n):null):null;};class Se extends e.VectorTileWorkerSource{constructor(e,t,i,r,n){super(e,t,i,r,be),n&&(this.loadGeoJSON=n);}loadData(t,i){const r=t&&t.request,n=r&&r.collectResourceTiming;this.loadGeoJSON(t,(o,a)=>{if(o||!a)return i(o);if("object"!=typeof a)return i(new Error(`Input data given to '${t.source}' is not a valid GeoJSON object.`));{s(a,!0);try{if(t.filter){const i=e.createExpression(t.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if("error"===i.result)throw new Error(i.value.map(e=>`${e.key}: ${e.message}`).join(", "));const r=a.features.filter(e=>i.value.evaluate({zoom:0},e));a={type:"FeatureCollection",features:r};}this._geoJSONIndex=t.cluster?new O(function({superclusterOptions:t,clusterProperties:i}){if(!i||!t)return t;const r={},n={},o={accumulated:null,zoom:0},s={properties:null},a=Object.keys(i);for(const t of a){const[o,s]=i[t],a=e.createExpression(s),l=e.createExpression("string"==typeof o?[o,["accumulated"],["get",t]]:o);r[t]=a.value,n[t]=l.value;}return t.map=e=>{s.properties=e;const t={};for(const e of a)t[e]=r[e].evaluate(o,s);return t;},t.reduce=(e,t)=>{s.properties=t;for(const t of a)o.accumulated=e[t],e[t]=n[t].evaluate(o,s);},t;}(t)).load(a.features):function(e,t){return new xe(e,t);}(a,t.geojsonVtOptions);}catch(o){return i(o);}this.loaded={};const l={};if(n){const i=e.getPerformanceMeasurement(r);i&&(l.resourceTiming={},l.resourceTiming[t.source]=JSON.parse(JSON.stringify(i)));}i(null,l);}});}reloadTile(e,t){const i=this.loaded;return i&&i[e.uid]?super.reloadTile(e,t):this.loadTile(e,t);}loadGeoJSON(t,i){if(t.request)e.getJSON(t.request,i);else {if("string"!=typeof t.data)return i(new Error(`Input data given to '${t.source}' is not a valid GeoJSON object.`));try{return i(null,JSON.parse(t.data));}catch(e){return i(new Error(`Input data given to '${t.source}' is not a valid GeoJSON object.`));}}}getClusterExpansionZoom(e,t){try{t(null,this._geoJSONIndex.getClusterExpansionZoom(e.clusterId));}catch(e){t(e);}}getClusterChildren(e,t){try{t(null,this._geoJSONIndex.getChildren(e.clusterId));}catch(e){t(e);}}getClusterLeaves(e,t){try{t(null,this._geoJSONIndex.getLeaves(e.clusterId,e.limit,e.offset));}catch(e){t(e);}}}class we{constructor(t){this.self=t,this.actor=new e.Actor(t,this),this.layerIndexes={},this.availableImages={},this.isSpriteLoaded={},this.projections={},this.defaultProjection=e.getProjection({name:"mercator"}),this.workerSourceTypes={vector:e.VectorTileWorkerSource,geojson:Se},this.workerSources={},this.demWorkerSources={},this.self.registerWorkerSource=(e,t)=>{if(this.workerSourceTypes[e])throw new Error(`Worker source with name "${e}" already registered.`);this.workerSourceTypes[e]=t;},this.self.registerRTLTextPlugin=t=>{if(e.plugin.isParsed())throw new Error("RTL text plugin already registered.");e.plugin.applyArabicShaping=t.applyArabicShaping,e.plugin.processBidirectionalText=t.processBidirectionalText,e.plugin.processStyledBidirectionalText=t.processStyledBidirectionalText;};}clearCaches(e,t,i){delete this.layerIndexes[e],delete this.availableImages[e],delete this.workerSources[e],delete this.demWorkerSources[e],i();}checkIfReady(e,t,i){i();}setReferrer(e,t){this.referrer=t;}spriteLoaded(t,i){this.isSpriteLoaded[t]=i;for(const r in this.workerSources[t]){const n=this.workerSources[t][r];for(const t in n)n[t]instanceof e.VectorTileWorkerSource&&(n[t].isSpriteLoaded=i,n[t].fire(new e.Event("isSpriteLoaded")));}}setImages(e,t,i){this.availableImages[e]=t;for(const i in this.workerSources[e]){const r=this.workerSources[e][i];for(const e in r)r[e].availableImages=t;}i();}enableTerrain(e,t,i){this.terrain=t,i();}setProjection(t,i){this.projections[t]=e.getProjection(i);}setLayers(e,t,i){this.getLayerIndex(e).replace(t),i();}updateLayers(e,t,i){this.getLayerIndex(e).update(t.layers,t.removedIds),i();}loadTile(t,i,r){const n=this.enableTerrain?e.extend({enableTerrain:this.terrain},i):i;n.projection=this.projections[t]||this.defaultProjection,this.getWorkerSource(t,i.type,i.source).loadTile(n,r);}loadDEMTile(t,i,r){const n=this.enableTerrain?e.extend({buildQuadTree:this.terrain},i):i;this.getDEMWorkerSource(t,i.source).loadTile(n,r);}reloadTile(t,i,r){const n=this.enableTerrain?e.extend({enableTerrain:this.terrain},i):i;n.projection=this.projections[t]||this.defaultProjection,this.getWorkerSource(t,i.type,i.source).reloadTile(n,r);}abortTile(e,t,i){this.getWorkerSource(e,t.type,t.source).abortTile(t,i);}removeTile(e,t,i){this.getWorkerSource(e,t.type,t.source).removeTile(t,i);}removeSource(e,t,i){if(!this.workerSources[e]||!this.workerSources[e][t.type]||!this.workerSources[e][t.type][t.source])return;const r=this.workerSources[e][t.type][t.source];delete this.workerSources[e][t.type][t.source],void 0!==r.removeSource?r.removeSource(t,i):i();}loadWorkerSource(e,t,i){try{this.self.importScripts(t.url),i();}catch(e){i(e.toString());}}syncRTLPluginState(t,i,r){try{e.plugin.setState(i);const t=e.plugin.getPluginURL();if(e.plugin.isLoaded()&&!e.plugin.isParsed()&&null!=t){this.self.importScripts(t);const i=e.plugin.isParsed();r(i?void 0:new Error(`RTL Text Plugin failed to import scripts from ${t}`),i);}}catch(e){r(e.toString());}}getAvailableImages(e){let t=this.availableImages[e];return t||(t=[]),t;}getLayerIndex(e){let t=this.layerIndexes[e];return t||(t=this.layerIndexes[e]=new r()),t;}getWorkerSource(e,t,i){return this.workerSources[e]||(this.workerSources[e]={}),this.workerSources[e][t]||(this.workerSources[e][t]={}),this.workerSources[e][t][i]||(this.workerSources[e][t][i]=new this.workerSourceTypes[t]({send:(t,i,r,n,o,s)=>{this.actor.send(t,i,r,e,o,s);},scheduler:this.actor.scheduler},this.getLayerIndex(e),this.getAvailableImages(e),this.isSpriteLoaded[e])),this.workerSources[e][t][i];}getDEMWorkerSource(e,t){return this.demWorkerSources[e]||(this.demWorkerSources[e]={}),this.demWorkerSources[e][t]||(this.demWorkerSources[e][t]=new o()),this.demWorkerSources[e][t];}enforceCacheSizeLimit(t,i){e.enforceCacheSizeLimit(i);}getWorkerPerformanceMetrics(e,t,i){i(void 0,void 0);}}return "undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope&&(self.worker=new we(self)),we;}),r(["./shared"],function(e){var t=i;function i(e){return !function(e){return "undefined"==typeof window||"undefined"==typeof document?"not a browser":Array.prototype&&Array.prototype.every&&Array.prototype.filter&&Array.prototype.forEach&&Array.prototype.indexOf&&Array.prototype.lastIndexOf&&Array.prototype.map&&Array.prototype.some&&Array.prototype.reduce&&Array.prototype.reduceRight&&Array.isArray?Function.prototype&&Function.prototype.bind?Object.keys&&Object.create&&Object.getPrototypeOf&&Object.getOwnPropertyNames&&Object.isSealed&&Object.isFrozen&&Object.isExtensible&&Object.getOwnPropertyDescriptor&&Object.defineProperty&&Object.defineProperties&&Object.seal&&Object.freeze&&Object.preventExtensions?"JSON"in window&&"parse"in JSON&&"stringify"in JSON?function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return !1;var e,t,i=new Blob([""],{type:"text/javascript"}),r=URL.createObjectURL(i);try{t=new Worker(r),e=!0;}catch(t){e=!1;}return t&&t.terminate(),URL.revokeObjectURL(r),e;}()?"Uint8ClampedArray"in window?ArrayBuffer.isView?function(){var e=document.createElement("canvas");e.width=e.height=1;var t=e.getContext("2d");if(!t)return !1;var i=t.getImageData(0,0,1,1);return i&&i.width===e.width;}()?(void 0===r[t=e&&e.failIfMajorPerformanceCaveat]&&(r[t]=function(e){var t,r=function(e){var t=document.createElement("canvas"),r=Object.create(i.webGLContextAttributes);return r.failIfMajorPerformanceCaveat=e,t.getContext("webgl",r)||t.getContext("experimental-webgl",r);}(e);if(!r)return !1;try{t=r.createShader(r.VERTEX_SHADER);}catch(e){return !1;}return !(!t||r.isContextLost())&&(r.shaderSource(t,"void main() {}"),r.compileShader(t),!0===r.getShaderParameter(t,r.COMPILE_STATUS));}(t)),r[t]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL support"):"insufficient Canvas/getImageData support":"insufficient ArrayBuffer support":"insufficient Uint8ClampedArray support":"insufficient worker support":"insufficient JSON support":"insufficient Object support":"insufficient Function support":"insufficent Array support";var t;}(e);}var r={};function n(e,t){var i=t[0],r=t[1],n=t[2],o=t[3],s=i*o-n*r;return s?(e[0]=o*(s=1/s),e[1]=-r*s,e[2]=-n*s,e[3]=i*s,e):null;}function o(e,t){if(Array.isArray(e)){if(!Array.isArray(t)||e.length!==t.length)return !1;for(let i=0;i<e.length;i++)if(!o(e[i],t[i]))return !1;return !0;}if("object"==typeof e&&null!==e&&null!==t){if("object"!=typeof t)return !1;if(Object.keys(e).length!==Object.keys(t).length)return !1;for(const i in e)if(!o(e[i],t[i]))return !1;return !0;}return e===t;}i.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0};const s={create:function(t,i,r){const n=e.window.document.createElement(t);return void 0!==i&&(n.className=i),r&&r.appendChild(n),n;},createSVG:function(t,i,r){const n=e.window.document.createElementNS("http://www.w3.org/2000/svg",t);for(const e of Object.keys(i))n.setAttributeNS(null,e,i[e]);return r&&r.appendChild(n),n;}},a=e.window.document&&e.window.document.documentElement.style,l=a&&void 0!==a.userSelect?"userSelect":"WebkitUserSelect";let c;s.disableDrag=function(){a&&l&&(c=a[l],a[l]="none");},s.enableDrag=function(){a&&l&&(a[l]=c);};const h=function(t){t.preventDefault(),t.stopPropagation(),e.window.removeEventListener("click",h,!0);};function u(t,i,r){const n=t.offsetWidth===i.width?1:t.offsetWidth/i.width;return new e.pointGeometry((r.clientX-i.left)*n,(r.clientY-i.top)*n);}function d(e){const{userImage:t}=e;return !!(t&&t.render&&t.render())&&(e.data.replace(new Uint8Array(t.data.buffer)),!0);}s.suppressClick=function(){e.window.addEventListener("click",h,!0),e.window.setTimeout(()=>{e.window.removeEventListener("click",h,!0);},0);},s.mousePos=function(e,t){const i=e.getBoundingClientRect();return u(e,i,t);},s.touchPos=function(e,t){const i=e.getBoundingClientRect(),r=[];for(let n=0;n<t.length;n++)r.push(u(e,i,t[n]));return r;},s.mouseButton=function(t){return void 0!==e.window.InstallTrigger&&2===t.button&&t.ctrlKey&&e.window.navigator.platform.toUpperCase().indexOf("MAC")>=0?0:t.button;};class p extends e.Evented{constructor(){super(),this.images={},this.updatedImages={},this.callbackDispatchedThisFrame={},this.loaded=!1,this.requestors=[],this.patterns={},this.atlasImage=new e.RGBAImage({width:1,height:1}),this.dirty=!0;}isLoaded(){return this.loaded;}setLoaded(e){if(this.loaded!==e&&(this.loaded=e,e)){for(const{ids:e,callback:t}of this.requestors)this._notify(e,t);this.requestors=[];}}getImage(e){return this.images[e];}addImage(e,t){this._validate(e,t)&&(this.images[e]=t);}_validate(t,i){let r=!0;return this._validateStretch(i.stretchX,i.data&&i.data.width)||(this.fire(new e.ErrorEvent(new Error(`Image "${t}" has invalid "stretchX" value`))),r=!1),this._validateStretch(i.stretchY,i.data&&i.data.height)||(this.fire(new e.ErrorEvent(new Error(`Image "${t}" has invalid "stretchY" value`))),r=!1),this._validateContent(i.content,i)||(this.fire(new e.ErrorEvent(new Error(`Image "${t}" has invalid "content" value`))),r=!1),r;}_validateStretch(e,t){if(!e)return !0;let i=0;for(const r of e){if(r[0]<i||r[1]<r[0]||t<r[1])return !1;i=r[1];}return !0;}_validateContent(e,t){return !(e&&(4!==e.length||e[0]<0||t.data.width<e[0]||e[1]<0||t.data.height<e[1]||e[2]<0||t.data.width<e[2]||e[3]<0||t.data.height<e[3]||e[2]<e[0]||e[3]<e[1]));}updateImage(e,t){t.version=this.images[e].version+1,this.images[e]=t,this.updatedImages[e]=!0;}removeImage(e){const t=this.images[e];delete this.images[e],delete this.patterns[e],t.userImage&&t.userImage.onRemove&&t.userImage.onRemove();}listImages(){return Object.keys(this.images);}getImages(e,t){let i=!0;if(!this.isLoaded())for(const t of e)this.images[t]||(i=!1);this.isLoaded()||i?this._notify(e,t):this.requestors.push({ids:e,callback:t});}_notify(t,i){const r={};for(const i of t){this.images[i]||this.fire(new e.Event("styleimagemissing",{id:i}));const t=this.images[i];t?r[i]={data:t.data.clone(),pixelRatio:t.pixelRatio,sdf:t.sdf,version:t.version,stretchX:t.stretchX,stretchY:t.stretchY,content:t.content,hasRenderCallback:Boolean(t.userImage&&t.userImage.render)}:e.warnOnce(`Image "${i}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`);}i(null,r);}getPixelSize(){const{width:e,height:t}=this.atlasImage;return {width:e,height:t};}getPattern(t){const i=this.patterns[t],r=this.getImage(t);if(!r)return null;if(i&&i.position.version===r.version)return i.position;if(i)i.position.version=r.version;else {const i={w:r.data.width+2,h:r.data.height+2,x:0,y:0},n=new e.ImagePosition(i,r);this.patterns[t]={bin:i,position:n};}return this._updatePatternAtlas(),this.patterns[t].position;}bind(t){const i=t.gl;this.atlasTexture?this.dirty&&(this.atlasTexture.update(this.atlasImage),this.dirty=!1):this.atlasTexture=new e.Texture(t,this.atlasImage,i.RGBA),this.atlasTexture.bind(i.LINEAR,i.CLAMP_TO_EDGE);}_updatePatternAtlas(){const t=[];for(const e in this.patterns)t.push(this.patterns[e].bin);const{w:i,h:r}=e.potpack(t),n=this.atlasImage;n.resize({width:i||1,height:r||1});for(const t in this.patterns){const{bin:i}=this.patterns[t],r=i.x+1,o=i.y+1,s=this.images[t].data,a=s.width,l=s.height;e.RGBAImage.copy(s,n,{x:0,y:0},{x:r,y:o},{width:a,height:l}),e.RGBAImage.copy(s,n,{x:0,y:l-1},{x:r,y:o-1},{width:a,height:1}),e.RGBAImage.copy(s,n,{x:0,y:0},{x:r,y:o+l},{width:a,height:1}),e.RGBAImage.copy(s,n,{x:a-1,y:0},{x:r-1,y:o},{width:1,height:l}),e.RGBAImage.copy(s,n,{x:0,y:0},{x:r+a,y:o},{width:1,height:l});}this.dirty=!0;}beginFrame(){this.callbackDispatchedThisFrame={};}dispatchRenderCallbacks(e){for(const t of e){if(this.callbackDispatchedThisFrame[t])continue;this.callbackDispatchedThisFrame[t]=!0;const e=this.images[t];d(e)&&this.updateImage(t,e);}}}const f=new e.Properties({anchor:new e.DataConstantProperty(e.spec.light.anchor),position:new class{constructor(){this.specification=e.spec.light.position;}possiblyEvaluate(t,i){return function([t,i,r]){const n=e.degToRad(i+90),o=e.degToRad(r);return {x:t*Math.cos(n)*Math.sin(o),y:t*Math.sin(n)*Math.sin(o),z:t*Math.cos(o),azimuthal:i,polar:r};}(t.expression.evaluate(i));}interpolate(t,i,r){return {x:e.number(t.x,i.x,r),y:e.number(t.y,i.y,r),z:e.number(t.z,i.z,r),azimuthal:e.number(t.azimuthal,i.azimuthal,r),polar:e.number(t.polar,i.polar,r)};}}(),color:new e.DataConstantProperty(e.spec.light.color),intensity:new e.DataConstantProperty(e.spec.light.intensity)}),m="-transition";class _ extends e.Evented{constructor(t){super(),this._transitionable=new e.Transitionable(f),this.setLight(t),this._transitioning=this._transitionable.untransitioned();}getLight(){return this._transitionable.serialize();}setLight(t,i={}){if(!this._validate(e.validateLight,t,i))for(const i in t){const r=t[i];e.endsWith(i,m)?this._transitionable.setTransition(i.slice(0,-m.length),r):this._transitionable.setValue(i,r);}}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning);}hasTransition(){return this._transitioning.hasTransition();}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e);}_validate(t,i,r){return (!r||!1!==r.validate)&&e.emitValidationErrors(this,t.call(e.validateStyle,e.extend({value:i,style:{glyphs:!0,sprite:!0},styleSpec:e.spec})));}}const g=new e.Properties({source:new e.DataConstantProperty(e.spec.terrain.source),exaggeration:new e.DataConstantProperty(e.spec.terrain.exaggeration)}),y="-transition";class x extends e.Evented{constructor(t,i){super(),this._transitionable=new e.Transitionable(g),this.set(t),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=i;}get(){return this._transitionable.serialize();}set(t){for(const i in t){const r=t[i];e.endsWith(i,y)?this._transitionable.setTransition(i.slice(0,-y.length),r):this._transitionable.setValue(i,r);}}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning);}hasTransition(){return this._transitioning.hasTransition();}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e);}}function v(t,i,r,n){const o=e.smoothstep(45,65,r),[s,a]=b(t,n),l=e.length(i);let c=1-Math.min(1,Math.exp((l-s)/(a-s)*-6));return c*=c*c,c=Math.min(1,1.00747*c),c*o*t.alpha;}function b(e,t){const i=.5/Math.tan(.5*t);return [e.range[0]+i,e.range[1]+i];}const S=new e.Properties({range:new e.DataConstantProperty(e.spec.fog.range),color:new e.DataConstantProperty(e.spec.fog.color),"horizon-blend":new e.DataConstantProperty(e.spec.fog["horizon-blend"])}),w="-transition";class T extends e.Evented{constructor(t,i){super(),this._transitionable=new e.Transitionable(S),this.set(t),this._transitioning=this._transitionable.untransitioned(),this._transform=i;}get state(){return {range:this.properties.get("range"),horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a};}get(){return this._transitionable.serialize();}set(t,i={}){if(!this._validate(e.validateFog,t,i))for(const i in t){const r=t[i];e.endsWith(i,w)?this._transitionable.setTransition(i.slice(0,-w.length),r):this._transitionable.setValue(i,r);}}getOpacity(t){if(!this._transform.projection.supportsFog)return 0;const i=this.properties&&this.properties.get("color")||1;return e.smoothstep(45,65,t)*i.a;}getOpacityAtLatLng(t,i){return this._transform.projection.supportsFog?function(t,i,r){const n=e.MercatorCoordinate.fromLngLat(i),o=r.elevation?r.elevation.getAtPointOrZero(n):0,s=[n.x,n.y,o];return e.transformMat4(s,s,r.mercatorFogMatrix),v(t,s,r.pitch,r._fov);}(this.state,t,i):0;}getFovAdjustedRange(e){return this._transform.projection.supportsFog?b(this.state,e):[0,1];}updateTransitions(e){this._transitioning=this._transitionable.transitioned(e,this._transitioning);}hasTransition(){return this._transitioning.hasTransition();}recalculate(e){this.properties=this._transitioning.possiblyEvaluate(e);}_validate(t,i,r){return (!r||!1!==r.validate)&&e.emitValidationErrors(this,t.call(e.validateStyle,e.extend({value:i,style:{glyphs:!0,sprite:!0},styleSpec:e.spec})));}}class E{constructor(t,i){this.workerPool=t,this.actors=[],this.currentActor=0,this.id=e.uniqueId();const r=this.workerPool.acquire(this.id);for(let e=0;e<r.length;e++){const t=new E.Actor(r[e],i,this.id);t.name=`Worker ${e}`,this.actors.push(t);}this.ready=!1,this.broadcast("checkIfReady",null,()=>{this.ready=!0;});}broadcast(t,i,r){e.asyncAll(this.actors,(e,r)=>{e.send(t,i,r);},r=r||function(){});}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor];}remove(){this.actors.forEach(e=>{e.remove();}),this.actors=[],this.workerPool.release(this.id);}}function N(t,i,r){return i*(e.EXTENT/(t.tileSize*Math.pow(2,r-t.tileID.overscaledZ)));}E.Actor=e.Actor;class I{constructor(e,t,i){this.context=e;const r=e.gl;this.buffer=r.createBuffer(),this.dynamicDraw=Boolean(i),this.context.unbindVAO(),e.bindElementBuffer.set(this.buffer),r.bufferData(r.ELEMENT_ARRAY_BUFFER,t.arrayBuffer,this.dynamicDraw?r.DYNAMIC_DRAW:r.STATIC_DRAW),this.dynamicDraw||delete t.arrayBuffer;}bind(){this.context.bindElementBuffer.set(this.buffer);}updateData(e){const t=this.context.gl;this.context.unbindVAO(),this.bind(),t.bufferSubData(t.ELEMENT_ARRAY_BUFFER,0,e.arrayBuffer);}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer);}}const M={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class C{constructor(e,t,i,r){this.length=t.length,this.attributes=i,this.itemSize=t.bytesPerElement,this.dynamicDraw=r,this.context=e;const n=e.gl;this.buffer=n.createBuffer(),e.bindVertexBuffer.set(this.buffer),n.bufferData(n.ARRAY_BUFFER,t.arrayBuffer,this.dynamicDraw?n.DYNAMIC_DRAW:n.STATIC_DRAW),this.dynamicDraw||delete t.arrayBuffer;}bind(){this.context.bindVertexBuffer.set(this.buffer);}updateData(e){const t=this.context.gl;this.bind(),t.bufferSubData(t.ARRAY_BUFFER,0,e.arrayBuffer);}enableAttributes(e,t){for(let i=0;i<this.attributes.length;i++){const r=t.attributes[this.attributes[i].name];void 0!==r&&e.enableVertexAttribArray(r);}}setVertexAttribPointers(e,t,i){for(let r=0;r<this.attributes.length;r++){const n=this.attributes[r],o=t.attributes[n.name];void 0!==o&&e.vertexAttribPointer(o,n.components,e[M[n.type]],!1,this.itemSize,n.offset+this.itemSize*(i||0));}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer);}}class A{constructor(e){this.gl=e.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1;}get(){return this.current;}set(e){}getDefault(){return this.default;}setDefault(){this.set(this.default);}}class P extends A{getDefault(){return e.Color.transparent;}set(e){const t=this.current;(e.r!==t.r||e.g!==t.g||e.b!==t.b||e.a!==t.a||this.dirty)&&(this.gl.clearColor(e.r,e.g,e.b,e.a),this.current=e,this.dirty=!1);}}class L extends A{getDefault(){return 1;}set(e){(e!==this.current||this.dirty)&&(this.gl.clearDepth(e),this.current=e,this.dirty=!1);}}class D extends A{getDefault(){return 0;}set(e){(e!==this.current||this.dirty)&&(this.gl.clearStencil(e),this.current=e,this.dirty=!1);}}class k extends A{getDefault(){return [!0,!0,!0,!0];}set(e){const t=this.current;(e[0]!==t[0]||e[1]!==t[1]||e[2]!==t[2]||e[3]!==t[3]||this.dirty)&&(this.gl.colorMask(e[0],e[1],e[2],e[3]),this.current=e,this.dirty=!1);}}class z extends A{getDefault(){return !0;}set(e){(e!==this.current||this.dirty)&&(this.gl.depthMask(e),this.current=e,this.dirty=!1);}}class R extends A{getDefault(){return 255;}set(e){(e!==this.current||this.dirty)&&(this.gl.stencilMask(e),this.current=e,this.dirty=!1);}}class O extends A{getDefault(){return {func:this.gl.ALWAYS,ref:0,mask:255};}set(e){const t=this.current;(e.func!==t.func||e.ref!==t.ref||e.mask!==t.mask||this.dirty)&&(this.gl.stencilFunc(e.func,e.ref,e.mask),this.current=e,this.dirty=!1);}}class F extends A{getDefault(){const e=this.gl;return [e.KEEP,e.KEEP,e.KEEP];}set(e){const t=this.current;(e[0]!==t[0]||e[1]!==t[1]||e[2]!==t[2]||this.dirty)&&(this.gl.stencilOp(e[0],e[1],e[2]),this.current=e,this.dirty=!1);}}class B extends A{getDefault(){return !1;}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;e?t.enable(t.STENCIL_TEST):t.disable(t.STENCIL_TEST),this.current=e,this.dirty=!1;}}class U extends A{getDefault(){return [0,1];}set(e){const t=this.current;(e[0]!==t[0]||e[1]!==t[1]||this.dirty)&&(this.gl.depthRange(e[0],e[1]),this.current=e,this.dirty=!1);}}class V extends A{getDefault(){return !1;}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;e?t.enable(t.DEPTH_TEST):t.disable(t.DEPTH_TEST),this.current=e,this.dirty=!1;}}class G extends A{getDefault(){return this.gl.LESS;}set(e){(e!==this.current||this.dirty)&&(this.gl.depthFunc(e),this.current=e,this.dirty=!1);}}class j extends A{getDefault(){return !1;}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;e?t.enable(t.BLEND):t.disable(t.BLEND),this.current=e,this.dirty=!1;}}class $ extends A{getDefault(){const e=this.gl;return [e.ONE,e.ZERO];}set(e){const t=this.current;(e[0]!==t[0]||e[1]!==t[1]||this.dirty)&&(this.gl.blendFunc(e[0],e[1]),this.current=e,this.dirty=!1);}}class H extends A{getDefault(){return e.Color.transparent;}set(e){const t=this.current;(e.r!==t.r||e.g!==t.g||e.b!==t.b||e.a!==t.a||this.dirty)&&(this.gl.blendColor(e.r,e.g,e.b,e.a),this.current=e,this.dirty=!1);}}class q extends A{getDefault(){return this.gl.FUNC_ADD;}set(e){(e!==this.current||this.dirty)&&(this.gl.blendEquation(e),this.current=e,this.dirty=!1);}}class Z extends A{getDefault(){return !1;}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;e?t.enable(t.CULL_FACE):t.disable(t.CULL_FACE),this.current=e,this.dirty=!1;}}class X extends A{getDefault(){return this.gl.BACK;}set(e){(e!==this.current||this.dirty)&&(this.gl.cullFace(e),this.current=e,this.dirty=!1);}}class W extends A{getDefault(){return this.gl.CCW;}set(e){(e!==this.current||this.dirty)&&(this.gl.frontFace(e),this.current=e,this.dirty=!1);}}class Y extends A{getDefault(){return null;}set(e){(e!==this.current||this.dirty)&&(this.gl.useProgram(e),this.current=e,this.dirty=!1);}}class J extends A{getDefault(){return this.gl.TEXTURE0;}set(e){(e!==this.current||this.dirty)&&(this.gl.activeTexture(e),this.current=e,this.dirty=!1);}}class K extends A{getDefault(){const e=this.gl;return [0,0,e.drawingBufferWidth,e.drawingBufferHeight];}set(e){const t=this.current;(e[0]!==t[0]||e[1]!==t[1]||e[2]!==t[2]||e[3]!==t[3]||this.dirty)&&(this.gl.viewport(e[0],e[1],e[2],e[3]),this.current=e,this.dirty=!1);}}class Q extends A{getDefault(){return null;}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;t.bindFramebuffer(t.FRAMEBUFFER,e),this.current=e,this.dirty=!1;}}class ee extends A{getDefault(){return null;}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;t.bindRenderbuffer(t.RENDERBUFFER,e),this.current=e,this.dirty=!1;}}class te extends A{getDefault(){return null;}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;t.bindTexture(t.TEXTURE_2D,e),this.current=e,this.dirty=!1;}}class ie extends A{getDefault(){return null;}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;t.bindBuffer(t.ARRAY_BUFFER,e),this.current=e,this.dirty=!1;}}class re extends A{getDefault(){return null;}set(e){const t=this.gl;t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,e),this.current=e,this.dirty=!1;}}class ne extends A{constructor(e){super(e),this.vao=e.extVertexArrayObject;}getDefault(){return null;}set(e){this.vao&&(e!==this.current||this.dirty)&&(this.vao.bindVertexArrayOES(e),this.current=e,this.dirty=!1);}}class oe extends A{getDefault(){return 4;}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;t.pixelStorei(t.UNPACK_ALIGNMENT,e),this.current=e,this.dirty=!1;}}class se extends A{getDefault(){return !1;}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,e),this.current=e,this.dirty=!1;}}class ae extends A{getDefault(){return !1;}set(e){if(e===this.current&&!this.dirty)return;const t=this.gl;t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,e),this.current=e,this.dirty=!1;}}class le extends A{constructor(e,t){super(e),this.context=e,this.parent=t;}getDefault(){return null;}}class ce extends le{setDirty(){this.dirty=!0;}set(e){if(e===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const t=this.gl;t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,e,0),this.current=e,this.dirty=!1;}}class he extends le{attachment(){return this.gl.DEPTH_ATTACHMENT;}set(e){if(e===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const t=this.gl;t.framebufferRenderbuffer(t.FRAMEBUFFER,this.attachment(),t.RENDERBUFFER,e),this.current=e,this.dirty=!1;}}class ue extends he{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT;}}class de{constructor(e,t,i,r){this.context=e,this.width=t,this.height=i;const n=this.framebuffer=e.gl.createFramebuffer();this.colorAttachment=new ce(e,n),r&&(this.depthAttachment=new he(e,n));}destroy(){const e=this.context.gl,t=this.colorAttachment.get();if(t&&e.deleteTexture(t),this.depthAttachment){const t=this.depthAttachment.get();t&&e.deleteRenderbuffer(t);}e.deleteFramebuffer(this.framebuffer);}}class pe{constructor(e){this.gl=e,this.extVertexArrayObject=this.gl.getExtension("OES_vertex_array_object"),this.clearColor=new P(this),this.clearDepth=new L(this),this.clearStencil=new D(this),this.colorMask=new k(this),this.depthMask=new z(this),this.stencilMask=new R(this),this.stencilFunc=new O(this),this.stencilOp=new F(this),this.stencilTest=new B(this),this.depthRange=new U(this),this.depthTest=new V(this),this.depthFunc=new G(this),this.blend=new j(this),this.blendFunc=new $(this),this.blendColor=new H(this),this.blendEquation=new q(this),this.cullFace=new Z(this),this.cullFaceSide=new X(this),this.frontFace=new W(this),this.program=new Y(this),this.activeTexture=new J(this),this.viewport=new K(this),this.bindFramebuffer=new Q(this),this.bindRenderbuffer=new ee(this),this.bindTexture=new te(this),this.bindVertexBuffer=new ie(this),this.bindElementBuffer=new re(this),this.bindVertexArrayOES=this.extVertexArrayObject&&new ne(this),this.pixelStoreUnpack=new oe(this),this.pixelStoreUnpackPremultiplyAlpha=new se(this),this.pixelStoreUnpackFlipY=new ae(this),this.extTextureFilterAnisotropic=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=e.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),this.extTextureFilterAnisotropicForceOff=!1,this.extTextureHalfFloat=e.getExtension("OES_texture_half_float"),this.extTextureHalfFloat&&(e.getExtension("OES_texture_half_float_linear"),this.extRenderToTextureHalfFloat=e.getExtension("EXT_color_buffer_half_float")),this.extTimerQuery=e.getExtension("EXT_disjoint_timer_query"),this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE);}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault();}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.extVertexArrayObject&&(this.bindVertexArrayOES.dirty=!0),this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0;}createIndexBuffer(e,t){return new I(this,e,t);}createVertexBuffer(e,t,i){return new C(this,e,t,i);}createRenderbuffer(e,t,i){const r=this.gl,n=r.createRenderbuffer();return this.bindRenderbuffer.set(n),r.renderbufferStorage(r.RENDERBUFFER,e,t,i),this.bindRenderbuffer.set(null),n;}createFramebuffer(e,t,i){return new de(this,e,t,i);}clear({color:e,depth:t,stencil:i}){const r=this.gl;let n=0;e&&(n|=r.COLOR_BUFFER_BIT,this.clearColor.set(e),this.colorMask.set([!0,!0,!0,!0])),void 0!==t&&(n|=r.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(t),this.depthMask.set(!0)),void 0!==i&&(n|=r.STENCIL_BUFFER_BIT,this.clearStencil.set(i),this.stencilMask.set(255)),r.clear(n);}setCullFace(e){!1===e.enable?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(e.mode),this.frontFace.set(e.frontFace));}setDepthMode(e){e.func!==this.gl.ALWAYS||e.mask?(this.depthTest.set(!0),this.depthFunc.set(e.func),this.depthMask.set(e.mask),this.depthRange.set(e.range)):this.depthTest.set(!1);}setStencilMode(e){e.test.func!==this.gl.ALWAYS||e.mask?(this.stencilTest.set(!0),this.stencilMask.set(e.mask),this.stencilOp.set([e.fail,e.depthFail,e.pass]),this.stencilFunc.set({func:e.test.func,ref:e.ref,mask:e.test.mask})):this.stencilTest.set(!1);}setColorMode(t){o(t.blendFunction,e.ColorMode.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor)),this.colorMask.set(t.mask);}unbindVAO(){this.extVertexArrayObject&&this.bindVertexArrayOES.set(null);}}class fe{constructor(e,t,i,r){this.screenBounds=e,this.cameraPoint=t,this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=i,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this.screenGeometry.map(e=>r.pointCoordinate3D(e)),this.cameraGeometry=this.bufferedCameraGeometry(0);}static createFromScreenPoints(t,i){let r,n;if(t instanceof e.pointGeometry||"number"==typeof t[0]){const o=e.pointGeometry.convert(t);r=[e.pointGeometry.convert(t)],n=i.isPointAboveHorizon(o);}else {const o=e.pointGeometry.convert(t[0]),s=e.pointGeometry.convert(t[1]);r=[o,s],n=e.polygonizeBounds(o,s).every(e=>i.isPointAboveHorizon(e));}return new fe(r,i.getCameraPoint(),n,i);}isPointQuery(){return 1===this.screenBounds.length;}bufferedScreenGeometry(t){return e.polygonizeBounds(this.screenBounds[0],1===this.screenBounds.length?this.screenBounds[0]:this.screenBounds[1],t);}bufferedCameraGeometry(t){const i=this.screenBounds[0],r=1===this.screenBounds.length?this.screenBounds[0].add(new e.pointGeometry(1,1)):this.screenBounds[1],n=e.polygonizeBounds(i,r,0,!1);return this.cameraPoint.y>r.y&&(this.cameraPoint.x>i.x&&this.cameraPoint.x<r.x?n.splice(3,0,this.cameraPoint):this.cameraPoint.x>=r.x?n[2]=this.cameraPoint:this.cameraPoint.x<=i.x&&(n[3]=this.cameraPoint)),e.bufferConvexPolygon(n,t);}containsTile(t,i,r){const n=t.queryPadding+1,o=t.tileID.wrap,s=r?this._bufferedCameraMercator(n,i).map(i=>e.getTilePoint(t.tileTransform,i,o)):this._bufferedScreenMercator(n,i).map(i=>e.getTilePoint(t.tileTransform,i,o)),a=this.screenGeometryMercator.map(i=>e.getTileVec3(t.tileTransform,i,o)),l=a.map(t=>new e.pointGeometry(t[0],t[1])),c=i.getFreeCameraOptions().position||new e.MercatorCoordinate(0,0,0),h=e.getTileVec3(t.tileTransform,c,o),u=a.map(t=>{const i=e.sub(t,t,h);return e.normalize(i,i),new e.Ray(h,i);}),d=N(t,1,i.zoom);if(e.polygonIntersectsBox(s,0,0,e.EXTENT,e.EXTENT))return {queryGeometry:this,tilespaceGeometry:l,tilespaceRays:u,bufferedTilespaceGeometry:s,bufferedTilespaceBounds:(p=e.getBounds(s),p.min.x=e.clamp(p.min.x,0,e.EXTENT),p.min.y=e.clamp(p.min.y,0,e.EXTENT),p.max.x=e.clamp(p.max.x,0,e.EXTENT),p.max.y=e.clamp(p.max.y,0,e.EXTENT),p),tile:t,tileID:t.tileID,pixelToTileUnitsFactor:d};var p;}_bufferedScreenMercator(e,t){const i=me(e);if(this._screenRaycastCache[i])return this._screenRaycastCache[i];{const r=this.bufferedScreenGeometry(e).map(e=>t.pointCoordinate3D(e));return this._screenRaycastCache[i]=r,r;}}_bufferedCameraMercator(e,t){const i=me(e);if(this._cameraRaycastCache[i])return this._cameraRaycastCache[i];{const r=this.bufferedCameraGeometry(e).map(e=>t.pointCoordinate3D(e));return this._cameraRaycastCache[i]=r,r;}}}function me(e){return 100*e|0;}function _e(t,i,r){const n=function(n,o){if(n)return r(n);if(o){const n=e.pick(e.extend(o,t),["tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","scheme","tileSize","encoding"]);o.vector_layers&&(n.vectorLayers=o.vector_layers,n.vectorLayerIds=n.vectorLayers.map(e=>e.id)),n.tiles=i.canonicalizeTileset(n,t.url),r(null,n);}};return t.url?e.getJSON(i.transformRequest(i.normalizeSourceURL(t.url),e.ResourceType.Source),n):e.exported.frame(()=>n(null,t));}class ge{constructor(t,i,r){this.bounds=e.LngLatBounds.convert(this.validateBounds(t)),this.minzoom=i||0,this.maxzoom=r||24;}validateBounds(e){return Array.isArray(e)&&4===e.length?[Math.max(-180,e[0]),Math.max(-90,e[1]),Math.min(180,e[2]),Math.min(90,e[3])]:[-180,-90,180,90];}contains(t){const i=Math.pow(2,t.z),r=Math.floor(e.mercatorXfromLng(this.bounds.getWest())*i),n=Math.floor(e.mercatorYfromLat(this.bounds.getNorth())*i),o=Math.ceil(e.mercatorXfromLng(this.bounds.getEast())*i),s=Math.ceil(e.mercatorYfromLat(this.bounds.getSouth())*i);return t.x>=r&&t.x<o&&t.y>=n&&t.y<s;}}class ye extends e.Evented{constructor(t,i,r,n){super(),this.id=t,this.dispatcher=r,this.setEventedParent(n),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=e.extend({type:"raster"},i),e.extend(this,e.pick(i,["url","scheme","tileSize"]));}load(){this._loaded=!1,this.fire(new e.Event("dataloading",{dataType:"source"})),this._tileJSONRequest=_e(this._options,this.map._requestManager,(t,i)=>{this._tileJSONRequest=null,this._loaded=!0,t?this.fire(new e.ErrorEvent(t)):i&&(e.extend(this,i),i.bounds&&(this.tileBounds=new ge(i.bounds,this.minzoom,this.maxzoom)),e.postTurnstileEvent(i.tiles),this.fire(new e.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new e.Event("data",{dataType:"source",sourceDataType:"content"})));});}loaded(){return this._loaded;}onAdd(e){this.map=e,this.load();}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null);}serialize(){return e.extend({},this._options);}hasTile(e){return !this.tileBounds||this.tileBounds.contains(e.canonical);}loadTile(t,i){const r=e.exported.devicePixelRatio>=2,n=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),r,this.tileSize);t.request=e.getImage(this.map._requestManager.transformRequest(n,e.ResourceType.Tile),(r,n,o,s)=>{if(delete t.request,t.aborted)t.state="unloaded",i(null);else if(r)t.state="errored",i(r);else if(n){this.map._refreshExpiredTiles&&t.setExpiryData({cacheControl:o,expires:s});const r=this.map.painter.context,a=r.gl;t.texture=this.map.painter.getTileTexture(n.width),t.texture?t.texture.update(n,{useMipmap:!0}):(t.texture=new e.Texture(r,n,a.RGBA,{useMipmap:!0}),t.texture.bind(a.LINEAR,a.CLAMP_TO_EDGE),r.extTextureFilterAnisotropic&&a.texParameterf(a.TEXTURE_2D,r.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,r.extTextureFilterAnisotropicMax)),t.state="loaded",e.cacheEntryPossiblyAdded(this.dispatcher),i(null);}});}abortTile(e,t){e.request&&(e.request.cancel(),delete e.request),t();}unloadTile(e,t){e.texture&&this.map.painter.saveTileTexture(e.texture),t();}hasTransition(){return !1;}}let xe;function ve(t,i,r,n,o,s,a,l){const c=[t,r,o,i,n,s,1,1,1],h=[a,l,1],u=e.adjoint([],c),[d,p,f]=e.transformMat3(h,h,e.transpose(u,u));return e.multiply(c,[d,0,0,0,p,0,0,0,f],c);}class be extends e.Evented{constructor(e,t,i,r){super(),this.id=e,this.dispatcher=i,this.coordinates=t.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.setEventedParent(r),this.options=t;}load(t,i){this._loaded=!1,this.fire(new e.Event("dataloading",{dataType:"source"})),this.url=this.options.url,e.getImage(this.map._requestManager.transformRequest(this.url,e.ResourceType.Image),(r,n)=>{this._loaded=!0,r?this.fire(new e.ErrorEvent(r)):n&&(this.image=e.exported.getImageData(n),this.width=this.image.width,this.height=this.image.height,t&&(this.coordinates=t),i&&i(),this._finishLoading());});}loaded(){return this._loaded;}updateImage(e){return this.image&&e.url?(this.options.url=e.url,this.load(e.coordinates,()=>{this.texture=null;}),this):this;}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new e.Event("data",{dataType:"source",sourceDataType:"metadata"})));}onAdd(e){this.map=e,this.load();}setCoordinates(t){this.coordinates=t,delete this._boundsArray;const i=t.map(e.MercatorCoordinate.fromLngLat);return this.tileID=function(t){let i=1/0,r=1/0,n=-1/0,o=-1/0;for(const e of t)i=Math.min(i,e.x),r=Math.min(r,e.y),n=Math.max(n,e.x),o=Math.max(o,e.y);const s=Math.max(n-i,o-r),a=Math.max(0,Math.floor(-Math.log(s)/Math.LN2)),l=Math.pow(2,a);return new e.CanonicalTileID(a,Math.floor((i+n)/2*l),Math.floor((r+o)/2*l));}(i),this.minzoom=this.maxzoom=this.tileID.z,this.fire(new e.Event("data",{dataType:"source",sourceDataType:"content"})),this;}_clear(){delete this._boundsArray;}_makeBoundsArray(){const t=e.tileTransform(this.tileID,this.map.transform.projection),[i,r,n,o]=this.coordinates.map(i=>{const r=t.projection.project(i[0],i[1]);return e.getTilePoint(t,r)._round();});return this.perspectiveTransform=function(t,i,r,n,o,s,a,l,c,h){const u=ve(0,0,t,0,0,i,t,i),d=ve(r,n,o,s,a,l,c,h);return e.multiply(d,e.adjoint(u,u),d),[d[6]/d[8]*t/e.EXTENT,d[7]/d[8]*i/e.EXTENT];}(this.width,this.height,i.x,i.y,r.x,r.y,o.x,o.y,n.x,n.y),this._boundsArray=new e.StructArrayLayout4i8(),this._boundsArray.emplaceBack(i.x,i.y,0,0),this._boundsArray.emplaceBack(r.x,r.y,e.EXTENT,0),this._boundsArray.emplaceBack(o.x,o.y,0,e.EXTENT),this._boundsArray.emplaceBack(n.x,n.y,e.EXTENT,e.EXTENT),this.boundsBuffer&&(this.boundsBuffer.destroy(),delete this.boundsBuffer),this;}prepare(){if(0===Object.keys(this.tiles).length||!this.image)return;const t=this.map.painter.context,i=t.gl;this._boundsArray||this._makeBoundsArray(),this.boundsBuffer||(this.boundsBuffer=t.createVertexBuffer(this._boundsArray,e.boundsAttributes.members)),this.boundsSegments||(this.boundsSegments=e.SegmentVector.simpleSegment(0,0,4,2)),this.texture||(this.texture=new e.Texture(t,this.image,i.RGBA),this.texture.bind(i.LINEAR,i.CLAMP_TO_EDGE));for(const e in this.tiles){const t=this.tiles[e];"loaded"!==t.state&&(t.state="loaded",t.texture=this.texture);}}loadTile(e,t){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={},t(null)):(e.state="errored",t(null));}serialize(){return {type:"image",url:this.options.url,coordinates:this.coordinates};}hasTransition(){return !1;}}const Se={vector:class extends e.Evented{constructor(t,i,r,n){if(super(),this.id=t,this.dispatcher=r,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,e.extend(this,e.pick(i,["url","scheme","tileSize","promoteId"])),this._options=e.extend({type:"vector"},i),this._collectResourceTiming=i.collectResourceTiming,512!==this.tileSize)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(n),this._tileWorkers={},this._deduped=new e.DedupedRequest();}load(){this._loaded=!1,this.fire(new e.Event("dataloading",{dataType:"source"})),this._tileJSONRequest=_e(this._options,this.map._requestManager,(t,i)=>{this._tileJSONRequest=null,this._loaded=!0,t?this.fire(new e.ErrorEvent(t)):i&&(e.extend(this,i),i.bounds&&(this.tileBounds=new ge(i.bounds,this.minzoom,this.maxzoom)),e.postTurnstileEvent(i.tiles,this.map._requestManager._customAccessToken),this.fire(new e.Event("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new e.Event("data",{dataType:"source",sourceDataType:"content"})));});}loaded(){return this._loaded;}hasTile(e){return !this.tileBounds||this.tileBounds.contains(e.canonical);}onAdd(e){this.map=e,this.load();}setSourceProperty(e){this._tileJSONRequest&&this._tileJSONRequest.cancel(),e();const t=this.map.style._getSourceCaches(this.id);for(const e of t)e.clearTiles();this.load();}setTiles(e){return this.setSourceProperty(()=>{this._options.tiles=e;}),this;}setUrl(e){return this.setSourceProperty(()=>{this.url=e,this._options.url=e;}),this;}onRemove(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null);}serialize(){return e.extend({},this._options);}loadTile(t,i){const r=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme)),n={request:this.map._requestManager.transformRequest(r,e.ResourceType.Tile),data:void 0,uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,pixelRatio:e.exported.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:t.isSymbolTile};if(n.request.collectResourceTiming=this._collectResourceTiming,t.actor&&"expired"!==t.state)"loading"===t.state?t.reloadCallback=i:t.request=t.actor.send("reloadTile",n,o.bind(this));else if(t.actor=this._tileWorkers[r]=this._tileWorkers[r]||this.dispatcher.getActor(),this.dispatcher.ready)t.request=t.actor.send("loadTile",n,o.bind(this),void 0,!0);else {const i=e.loadVectorTile.call({deduped:this._deduped},n,(e,i)=>{e||!i?o.call(this,e):(n.data={cacheControl:i.cacheControl,expires:i.expires,rawData:i.rawData.slice(0)},t.actor&&t.actor.send("loadTile",n,o.bind(this),void 0,!0));},!0);t.request={cancel:i};}function o(r,n){return delete t.request,t.aborted?i(null):r&&404!==r.status?i(r):(n&&n.resourceTiming&&(t.resourceTiming=n.resourceTiming),this.map._refreshExpiredTiles&&n&&t.setExpiryData(n),t.loadVectorData(n,this.map.painter),e.cacheEntryPossiblyAdded(this.dispatcher),i(null),void(t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)));}}abortTile(e){e.request&&(e.request.cancel(),delete e.request),e.actor&&e.actor.send("abortTile",{uid:e.uid,type:this.type,source:this.id});}unloadTile(e){e.unloadVectorData(),e.actor&&e.actor.send("removeTile",{uid:e.uid,type:this.type,source:this.id});}hasTransition(){return !1;}afterUpdate(){this._tileWorkers={};}},raster:ye,"raster-dem":class extends ye{constructor(t,i,r,n){super(t,i,r,n),this.type="raster-dem",this.maxzoom=22,this._options=e.extend({type:"raster-dem"},i),this.encoding=i.encoding||"mapbox";}loadTile(t,i){const r=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function n(e,r){e&&(t.state="errored",i(e)),r&&(t.dem=r,t.dem.onDeserialize(),t.needsHillshadePrepare=!0,t.needsDEMTextureUpload=!0,t.state="loaded",i(null));}t.request=e.getImage(this.map._requestManager.transformRequest(r,e.ResourceType.Tile),function(r,o,s,a){if(delete t.request,t.aborted)t.state="unloaded",i(null);else if(r)t.state="errored",i(r);else if(o){this.map._refreshExpiredTiles&&t.setExpiryData({cacheControl:s,expires:a});const i=e.window.ImageBitmap&&o instanceof e.window.ImageBitmap&&(null==xe&&(xe=e.window.OffscreenCanvas&&new e.window.OffscreenCanvas(1,1).getContext("2d")&&"function"==typeof e.window.createImageBitmap),xe),r=1-(o.width-e.prevPowerOfTwo(o.width))/2;r<1||t.neighboringTiles||(t.neighboringTiles=this._getNeighboringTiles(t.tileID));const l=i?o:e.exported.getImageData(o,r),c={uid:t.uid,coord:t.tileID,source:this.id,rawImageData:l,encoding:this.encoding,padding:r};t.actor&&"expired"!==t.state||(t.actor=this.dispatcher.getActor(),t.actor.send("loadDEMTile",c,n.bind(this),void 0,!0));}}.bind(this));}_getNeighboringTiles(t){const i=t.canonical,r=Math.pow(2,i.z),n=(i.x-1+r)%r,o=0===i.x?t.wrap-1:t.wrap,s=(i.x+1+r)%r,a=i.x+1===r?t.wrap+1:t.wrap,l={};return l[new e.OverscaledTileID(t.overscaledZ,o,i.z,n,i.y).key]={backfilled:!1},l[new e.OverscaledTileID(t.overscaledZ,a,i.z,s,i.y).key]={backfilled:!1},i.y>0&&(l[new e.OverscaledTileID(t.overscaledZ,o,i.z,n,i.y-1).key]={backfilled:!1},l[new e.OverscaledTileID(t.overscaledZ,t.wrap,i.z,i.x,i.y-1).key]={backfilled:!1},l[new e.OverscaledTileID(t.overscaledZ,a,i.z,s,i.y-1).key]={backfilled:!1}),i.y+1<r&&(l[new e.OverscaledTileID(t.overscaledZ,o,i.z,n,i.y+1).key]={backfilled:!1},l[new e.OverscaledTileID(t.overscaledZ,t.wrap,i.z,i.x,i.y+1).key]={backfilled:!1},l[new e.OverscaledTileID(t.overscaledZ,a,i.z,s,i.y+1).key]={backfilled:!1}),l;}unloadTile(e){e.demTexture&&this.map.painter.saveTileTexture(e.demTexture),e.fbo&&(e.fbo.destroy(),delete e.fbo),e.dem&&delete e.dem,delete e.neighboringTiles,e.state="unloaded";}},geojson:class extends e.Evented{constructor(t,i,r,n){super(),this.id=t,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=r.getActor(),this.setEventedParent(n),this._data=i.data,this._options=e.extend({},i),this._collectResourceTiming=i.collectResourceTiming,void 0!==i.maxzoom&&(this.maxzoom=i.maxzoom),i.type&&(this.type=i.type),i.attribution&&(this.attribution=i.attribution),this.promoteId=i.promoteId;const o=e.EXTENT/this.tileSize;this.workerOptions=e.extend({source:this.id,cluster:i.cluster||!1,geojsonVtOptions:{buffer:(void 0!==i.buffer?i.buffer:128)*o,tolerance:(void 0!==i.tolerance?i.tolerance:.375)*o,extent:e.EXTENT,maxZoom:this.maxzoom,lineMetrics:i.lineMetrics||!1,generateId:i.generateId||!1},superclusterOptions:{maxZoom:void 0!==i.clusterMaxZoom?i.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,i.clusterMinPoints||2),extent:e.EXTENT,radius:(void 0!==i.clusterRadius?i.clusterRadius:50)*o,log:!1,generateId:i.generateId||!1},clusterProperties:i.clusterProperties,filter:i.filter},i.workerOptions);}onAdd(e){this.map=e,this.setData(this._data);}setData(e){return this._data=e,this._updateWorkerData(),this;}getClusterExpansionZoom(e,t){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:e,source:this.id},t),this;}getClusterChildren(e,t){return this.actor.send("geojson.getClusterChildren",{clusterId:e,source:this.id},t),this;}getClusterLeaves(e,t,i,r){return this.actor.send("geojson.getClusterLeaves",{source:this.id,clusterId:e,limit:t,offset:i},r),this;}_updateWorkerData(){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new e.Event("dataloading",{dataType:"source"})),this._loaded=!1;const t=e.extend({},this.workerOptions),i=this._data;"string"==typeof i?(t.request=this.map._requestManager.transformRequest(e.exported.resolveURL(i),e.ResourceType.Source),t.request.collectResourceTiming=this._collectResourceTiming):t.data=JSON.stringify(i),this._pendingLoad=this.actor.send(`${this.type}.loadData`,t,(t,i)=>{if(this._loaded=!0,this._pendingLoad=null,t)this.fire(new e.ErrorEvent(t));else {const t={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&i&&i.resourceTiming&&i.resourceTiming[this.id]&&(t.resourceTiming=i.resourceTiming[this.id]),this.fire(new e.Event("data",t)),this._metadataFired=!0;}this._coalesce&&(this._updateWorkerData(),this._coalesce=!1);});}loaded(){return this._loaded;}loadTile(t,i){const r=t.actor?"reloadTile":"loadTile";t.actor=this.actor,t.request=this.actor.send(r,{type:this.type,uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,pixelRatio:e.exported.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId},(e,n)=>(delete t.request,t.unloadVectorData(),t.aborted?i(null):e?i(e):(t.loadVectorData(n,this.map.painter,"reloadTile"===r),i(null))),void 0,"loadTile"===r);}abortTile(e){e.request&&(e.request.cancel(),delete e.request),e.aborted=!0;}unloadTile(e){e.unloadVectorData(),this.actor.send("removeTile",{uid:e.uid,type:this.type,source:this.id});}onRemove(){this._pendingLoad&&this._pendingLoad.cancel();}serialize(){return e.extend({},this._options,{type:this.type,data:this._data});}hasTransition(){return !1;}},video:class extends be{constructor(e,t,i,r){super(e,t,i,r),this.roundZoom=!0,this.type="video",this.options=t;}load(){this._loaded=!1;const t=this.options;this.urls=[];for(const i of t.urls)this.urls.push(this.map._requestManager.transformRequest(i,e.ResourceType.Source).url);e.getVideo(this.urls,(t,i)=>{this._loaded=!0,t?this.fire(new e.ErrorEvent(t)):i&&(this.video=i,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",()=>{this.map.triggerRepaint();}),this.map&&this.video.play(),this._finishLoading());});}pause(){this.video&&this.video.pause();}play(){this.video&&this.video.play();}seek(t){if(this.video){const i=this.video.seekable;t<i.start(0)||t>i.end(0)?this.fire(new e.ErrorEvent(new e.ValidationError(`sources.${this.id}`,null,`Playback for this video can be set only between the ${i.start(0)} and ${i.end(0)}-second mark.`))):this.video.currentTime=t;}}getVideo(){return this.video;}onAdd(e){this.map||(this.map=e,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)));}prepare(){if(0===Object.keys(this.tiles).length||this.video.readyState<2)return;const t=this.map.painter.context,i=t.gl;this.texture?this.video.paused||(this.texture.bind(i.LINEAR,i.CLAMP_TO_EDGE),i.texSubImage2D(i.TEXTURE_2D,0,0,0,i.RGBA,i.UNSIGNED_BYTE,this.video)):(this.texture=new e.Texture(t,this.video,i.RGBA),this.texture.bind(i.LINEAR,i.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._boundsArray||this._makeBoundsArray(),this.boundsBuffer||(this.boundsBuffer=t.createVertexBuffer(this._boundsArray,e.boundsAttributes.members)),this.boundsSegments||(this.boundsSegments=e.SegmentVector.simpleSegment(0,0,4,2));for(const e in this.tiles){const t=this.tiles[e];"loaded"!==t.state&&(t.state="loaded",t.texture=this.texture);}}serialize(){return {type:"video",urls:this.urls,coordinates:this.coordinates};}hasTransition(){return this.video&&!this.video.paused;}},image:be,canvas:class extends be{constructor(t,i,r,n){super(t,i,r,n),i.coordinates?Array.isArray(i.coordinates)&&4===i.coordinates.length&&!i.coordinates.some(e=>!Array.isArray(e)||2!==e.length||e.some(e=>"number"!=typeof e))||this.fire(new e.ErrorEvent(new e.ValidationError(`sources.${t}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new e.ErrorEvent(new e.ValidationError(`sources.${t}`,null,'missing required property "coordinates"'))),i.animate&&"boolean"!=typeof i.animate&&this.fire(new e.ErrorEvent(new e.ValidationError(`sources.${t}`,null,'optional "animate" property must be a boolean value'))),i.canvas?"string"==typeof i.canvas||i.canvas instanceof e.window.HTMLCanvasElement||this.fire(new e.ErrorEvent(new e.ValidationError(`sources.${t}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new e.ErrorEvent(new e.ValidationError(`sources.${t}`,null,'missing required property "canvas"'))),this.options=i,this.animate=void 0===i.animate||i.animate;}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof e.window.HTMLCanvasElement?this.options.canvas:e.window.document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new e.ErrorEvent(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint();},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1);},this._finishLoading());}getCanvas(){return this.canvas;}onAdd(e){this.map=e,this.load(),this.canvas&&this.animate&&this.play();}onRemove(){this.pause();}prepare(){let t=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,t=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,t=!0),this._hasInvalidDimensions())return;if(0===Object.keys(this.tiles).length)return;const i=this.map.painter.context,r=i.gl;this._boundsArray||this._makeBoundsArray(),this.boundsBuffer||(this.boundsBuffer=i.createVertexBuffer(this._boundsArray,e.boundsAttributes.members)),this.boundsSegments||(this.boundsSegments=e.SegmentVector.simpleSegment(0,0,4,2)),this.texture?(t||this._playing)&&this.texture.update(this.canvas,{premultiply:!0}):this.texture=new e.Texture(i,this.canvas,r.RGBA,{premultiply:!0});for(const e in this.tiles){const t=this.tiles[e];"loaded"!==t.state&&(t.state="loaded",t.texture=this.texture);}}serialize(){return {type:"canvas",coordinates:this.coordinates};}hasTransition(){return this._playing;}_hasInvalidDimensions(){for(const e of [this.canvas.width,this.canvas.height])if(isNaN(e)||e<=0)return !0;return !1;}}},we=function(t,i,r,n){const o=new Se[i.type](t,i,r,n);if(o.id!==t)throw new Error(`Expected Source id to be ${t} instead of ${o.id}`);return e.bindAll(["load","abort","unload","serialize","prepare"],o),o;};function Te(t,i){const r=e.identity([]);return e.scale(r,r,[.5*t.width,.5*-t.height,1]),e.translate(r,r,[1,-1,0]),e.multiply$1(r,r,t.calculateProjMatrix(i.toUnwrapped()));}function Ee(e,t,i,r,n,o,s,a=!1){const l=e.tilesIn(r,s,a);l.sort(Ie);const c=[];for(const r of l)c.push({wrappedTileID:r.tile.tileID.wrapped().key,queryResults:r.tile.queryRenderedFeatures(t,i,e._state,r,n,o,Te(e.transform,r.tile.tileID),a)});const h=function(e){const t={},i={};for(const r of e){const e=r.queryResults,n=r.wrappedTileID,o=i[n]=i[n]||{};for(const i in e){const r=e[i],n=o[i]=o[i]||{},s=t[i]=t[i]||[];for(const e of r)n[e.featureIndex]||(n[e.featureIndex]=!0,s.push(e));}}return t;}(c);for(const t in h)h[t].forEach(t=>{const i=t.feature,r=e.getFeatureState(i.layer["source-layer"],i.id);i.source=i.layer.source,i.layer["source-layer"]&&(i.sourceLayer=i.layer["source-layer"]),i.state=r;});return h;}function Ne(e,t){const i=e.getRenderableIds().map(t=>e.getTileByID(t)),r=[],n={};for(let e=0;e<i.length;e++){const o=i[e],s=o.tileID.canonical.key;n[s]||(n[s]=!0,o.querySourceFeatures(r,t));}return r;}function Ie(e,t){const i=e.tileID,r=t.tileID;return i.overscaledZ-r.overscaledZ||i.canonical.y-r.canonical.y||i.wrap-r.wrap||i.canonical.x-r.canonical.x;}function Me(){return null!=Yn.workerClass?new Yn.workerClass():new e.window.Worker(Yn.workerUrl);}const Ce="mapboxgl_preloaded_worker_pool";class Ae{constructor(){this.active={};}acquire(e){if(!this.workers)for(this.workers=[];this.workers.length<Ae.workerCount;)this.workers.push(new Me());return this.active[e]=!0,this.workers.slice();}release(e){delete this.active[e],0===this.numActive()&&(this.workers.forEach(e=>{e.terminate();}),this.workers=null);}isPreloaded(){return !!this.active[Ce];}numActive(){return Object.keys(this.active).length;}}let Pe;function Le(){return Pe||(Pe=new Ae()),Pe;}function De(t,i){const r={};for(const e in t)"ref"!==e&&(r[e]=t[e]);return e.refProperties.forEach(e=>{e in i&&(r[e]=i[e]);}),r;}function ke(e){e=e.slice();const t=Object.create(null);for(let i=0;i<e.length;i++)t[e[i].id]=e[i];for(let i=0;i<e.length;i++)"ref"in e[i]&&(e[i]=De(e[i],t[e[i].ref]));return e;}Ae.workerCount=2;const ze={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setProjection:"setProjection"};function Re(e,t,i){i.push({command:ze.addSource,args:[e,t[e]]});}function Oe(e,t,i){t.push({command:ze.removeSource,args:[e]}),i[e]=!0;}function Fe(e,t,i,r){Oe(e,i,r),Re(e,t,i);}function Be(e,t,i){let r;for(r in e[i])if(e[i].hasOwnProperty(r)&&"data"!==r&&!o(e[i][r],t[i][r]))return !1;for(r in t[i])if(t[i].hasOwnProperty(r)&&"data"!==r&&!o(e[i][r],t[i][r]))return !1;return !0;}function Ue(e,t,i,r,n,s){let a;for(a in t=t||{},e=e||{})e.hasOwnProperty(a)&&(o(e[a],t[a])||i.push({command:s,args:[r,a,t[a],n]}));for(a in t)t.hasOwnProperty(a)&&!e.hasOwnProperty(a)&&(o(e[a],t[a])||i.push({command:s,args:[r,a,t[a],n]}));}function Ve(e){return e.id;}function Ge(e,t){return e[t.id]=t,e;}class je{constructor(e,t){this.reset(e,t);}reset(e,t){this.points=e||[],this._distances=[0];for(let e=1;e<this.points.length;e++)this._distances[e]=this._distances[e-1]+this.points[e].dist(this.points[e-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(t||0,.5*this.length),this.paddedLength=this.length-2*this.padding;}lerp(t){if(1===this.points.length)return this.points[0];t=e.clamp(t,0,1);let i=1,r=this._distances[i];const n=t*this.paddedLength+this.padding;for(;r<n&&i<this._distances.length;)r=this._distances[++i];const o=i-1,s=this._distances[o],a=r-s,l=a>0?(n-s)/a:0;return this.points[o].mult(1-l).add(this.points[i].mult(l));}}class $e{constructor(e,t,i){const r=this.boxCells=[],n=this.circleCells=[];this.xCellCount=Math.ceil(e/i),this.yCellCount=Math.ceil(t/i);for(let e=0;e<this.xCellCount*this.yCellCount;e++)r.push([]),n.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=e,this.height=t,this.xScale=this.xCellCount/e,this.yScale=this.yCellCount/t,this.boxUid=0,this.circleUid=0;}keysLength(){return this.boxKeys.length+this.circleKeys.length;}insert(e,t,i,r,n){this._forEachCell(t,i,r,n,this._insertBoxCell,this.boxUid++),this.boxKeys.push(e),this.bboxes.push(t),this.bboxes.push(i),this.bboxes.push(r),this.bboxes.push(n);}insertCircle(e,t,i,r){this._forEachCell(t-r,i-r,t+r,i+r,this._insertCircleCell,this.circleUid++),this.circleKeys.push(e),this.circles.push(t),this.circles.push(i),this.circles.push(r);}_insertBoxCell(e,t,i,r,n,o){this.boxCells[n].push(o);}_insertCircleCell(e,t,i,r,n,o){this.circleCells[n].push(o);}_query(e,t,i,r,n,o){if(i<0||e>this.width||r<0||t>this.height)return !n&&[];const s=[];if(e<=0&&t<=0&&this.width<=i&&this.height<=r){if(n)return !0;for(let e=0;e<this.boxKeys.length;e++)s.push({key:this.boxKeys[e],x1:this.bboxes[4*e],y1:this.bboxes[4*e+1],x2:this.bboxes[4*e+2],y2:this.bboxes[4*e+3]});for(let e=0;e<this.circleKeys.length;e++){const t=this.circles[3*e],i=this.circles[3*e+1],r=this.circles[3*e+2];s.push({key:this.circleKeys[e],x1:t-r,y1:i-r,x2:t+r,y2:i+r});}return o?s.filter(o):s;}return this._forEachCell(e,t,i,r,this._queryCell,s,{hitTest:n,seenUids:{box:{},circle:{}}},o),n?s.length>0:s;}_queryCircle(e,t,i,r,n){const o=e-i,s=e+i,a=t-i,l=t+i;if(s<0||o>this.width||l<0||a>this.height)return !r&&[];const c=[];return this._forEachCell(o,a,s,l,this._queryCellCircle,c,{hitTest:r,circle:{x:e,y:t,radius:i},seenUids:{box:{},circle:{}}},n),r?c.length>0:c;}query(e,t,i,r,n){return this._query(e,t,i,r,!1,n);}hitTest(e,t,i,r,n){return this._query(e,t,i,r,!0,n);}hitTestCircle(e,t,i,r){return this._queryCircle(e,t,i,!0,r);}_queryCell(e,t,i,r,n,o,s,a){const l=s.seenUids,c=this.boxCells[n];if(null!==c){const n=this.bboxes;for(const h of c)if(!l.box[h]){l.box[h]=!0;const c=4*h;if(e<=n[c+2]&&t<=n[c+3]&&i>=n[c+0]&&r>=n[c+1]&&(!a||a(this.boxKeys[h]))){if(s.hitTest)return o.push(!0),!0;o.push({key:this.boxKeys[h],x1:n[c],y1:n[c+1],x2:n[c+2],y2:n[c+3]});}}}const h=this.circleCells[n];if(null!==h){const n=this.circles;for(const c of h)if(!l.circle[c]){l.circle[c]=!0;const h=3*c;if(this._circleAndRectCollide(n[h],n[h+1],n[h+2],e,t,i,r)&&(!a||a(this.circleKeys[c]))){if(s.hitTest)return o.push(!0),!0;{const e=n[h],t=n[h+1],i=n[h+2];o.push({key:this.circleKeys[c],x1:e-i,y1:t-i,x2:e+i,y2:t+i});}}}}}_queryCellCircle(e,t,i,r,n,o,s,a){const l=s.circle,c=s.seenUids,h=this.boxCells[n];if(null!==h){const e=this.bboxes;for(const t of h)if(!c.box[t]){c.box[t]=!0;const i=4*t;if(this._circleAndRectCollide(l.x,l.y,l.radius,e[i+0],e[i+1],e[i+2],e[i+3])&&(!a||a(this.boxKeys[t])))return o.push(!0),!0;}}const u=this.circleCells[n];if(null!==u){const e=this.circles;for(const t of u)if(!c.circle[t]){c.circle[t]=!0;const i=3*t;if(this._circlesCollide(e[i],e[i+1],e[i+2],l.x,l.y,l.radius)&&(!a||a(this.circleKeys[t])))return o.push(!0),!0;}}}_forEachCell(e,t,i,r,n,o,s,a){const l=this._convertToXCellCoord(e),c=this._convertToYCellCoord(t),h=this._convertToXCellCoord(i),u=this._convertToYCellCoord(r);for(let d=l;d<=h;d++)for(let l=c;l<=u;l++)if(n.call(this,e,t,i,r,this.xCellCount*l+d,o,s,a))return;}_convertToXCellCoord(e){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(e*this.xScale)));}_convertToYCellCoord(e){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(e*this.yScale)));}_circlesCollide(e,t,i,r,n,o){const s=r-e,a=n-t,l=i+o;return l*l>s*s+a*a;}_circleAndRectCollide(e,t,i,r,n,o,s){const a=(o-r)/2,l=Math.abs(e-(r+a));if(l>a+i)return !1;const c=(s-n)/2,h=Math.abs(t-(n+c));if(h>c+i)return !1;if(l<=a||h<=c)return !0;const u=l-a,d=h-c;return u*u+d*d<=i*i;}}const He=Math.tan(85*Math.PI/180);function qe(t,i,r,o,s,a){let l=e.create();if(r){if("globe"===s.projection.name)l=e.calculateGlobeMatrix(s,s.worldSize/s._projectionScaler,[0,0]),e.multiply$1(l,l,e.globeDenormalizeECEF(e.globeTileBounds(i)));else {const e=n([],a);l[0]=e[0],l[1]=e[1],l[4]=e[2],l[5]=e[3];}o||e.rotateZ(l,l,s.angle);}else e.multiply$1(l,s.labelPlaneMatrix,t);return l;}function Ze(t,i,r,n,o,s){if(r){if("globe"===o.projection.name){const a=qe(t,i,r,n,o,s);return e.invert(a,a),e.multiply$1(a,t,a),a;}{const i=e.clone(t),r=e.identity([]);return r[0]=s[0],r[1]=s[1],r[4]=s[2],r[5]=s[3],e.multiply$1(i,i,r),n||e.rotateZ(i,i,-o.angle),i;}}return o.glCoordMatrix;}function Xe(t,i,r=0){const n=[t.x,t.y,r,1];r?e.transformMat4$1(n,n,i):st(n,n,i);const o=n[3];return {point:new e.pointGeometry(n[0]/o,n[1]/o),signedDistanceFromCamera:o};}function We(e,t){return Math.min(.5+e/t*.5,1.5);}function Ye(e,t){const i=e[0]/e[3],r=e[1]/e[3];return i>=-t[0]&&i<=t[0]&&r>=-t[1]&&r<=t[1];}function Je(t,i,r,n,o,s,a,l,c,h){const u=r.transform,d=n?t.textSizeData:t.iconSizeData,p=e.evaluateSizeForZoom(d,r.transform.zoom),f=[256/r.width*2+1,256/r.height*2+1],m=n?t.text.dynamicLayoutVertexArray:t.icon.dynamicLayoutVertexArray;m.clear();const _=t.lineVertexArray,g=n?t.text.placedSymbolArray:t.icon.placedSymbolArray,y=r.transform.width/r.transform.height;let x=!1;for(let n=0;n<g.length;n++){const v=g.get(n);if(v.writingMode!==e.WritingMode.vertical||x||0!==n&&g.get(n-1).writingMode===e.WritingMode.horizontal||(x=!0),v.hidden||v.writingMode===e.WritingMode.vertical&&!x){ot(v.numGlyphs,m);continue;}x=!1;const b=new e.pointGeometry(v.tileAnchorX,v.tileAnchorY),S=c?c(b):[0,0,0],w=u.projection.projectTilePoint(b.x,b.y,h.canonical),T=[w.x+S[0],w.y+S[1],w.z+S[2]],E=[...T,1];if(e.transformMat4$1(E,E,i),!Ye(E,f)){ot(v.numGlyphs,m);continue;}const N=We(r.transform.cameraToCenterDistance,E[3]),I=e.evaluateSizeForFeature(d,p,v),M=a?I/N:I*N,C=Xe(new e.pointGeometry(T[0],T[1]),o,T[2]);if(C.signedDistanceFromCamera<=0){ot(v.numGlyphs,m);continue;}let A={};const P=a?null:c,L=et(v,M,!1,l,i,o,s,t.glyphOffsetArray,_,m,C.point,b,A,y,P,u.projection,h);x=L.useVertical,P&&L.needsFlipping&&(A={}),(L.notEnoughRoom||x||L.needsFlipping&&et(v,M,!0,l,i,o,s,t.glyphOffsetArray,_,m,C.point,b,A,y,P,u.projection,h).notEnoughRoom)&&ot(v.numGlyphs,m);}n?t.text.dynamicLayoutVertexBuffer.updateData(m):t.icon.dynamicLayoutVertexBuffer.updateData(m);}function Ke(e,t,i,r,n,o,s,a,l,c,h,u,d,p,f){const m=a.glyphStartIndex+a.numGlyphs,_=a.lineStartIndex,g=a.lineStartIndex+a.lineLength,y=t.getoffsetX(a.glyphStartIndex),x=t.getoffsetX(m-1),v=rt(e*y,i,r,n,o,s,a.segment,_,g,l,c,h,u,d,!0,p,f);if(!v)return null;const b=rt(e*x,i,r,n,o,s,a.segment,_,g,l,c,h,u,d,!0,p,f);return b?{first:v,last:b}:null;}function Qe(t,i,r,n){return t.writingMode===e.WritingMode.horizontal&&Math.abs(r.y-i.y)>Math.abs(r.x-i.x)*n?{useVertical:!0}:t.writingMode===e.WritingMode.vertical?i.y<r.y?{needsFlipping:!0}:null:0!==t.flipState&&function(e,t,i){const r=(t.x-e.x)*i;return 0===r||Math.abs((t.y-e.y)/r)>He;}(i,r,n)?1===t.flipState?{needsFlipping:!0}:null:i.x>r.x?{needsFlipping:!0}:null;}function et(t,i,r,n,o,s,a,l,c,h,u,d,p,f,m,_,g){const y=i/24,x=t.lineOffsetX*y,v=t.lineOffsetY*y;let b;if(t.numGlyphs>1){const e=t.glyphStartIndex+t.numGlyphs,i=t.lineStartIndex,o=t.lineStartIndex+t.lineLength,h=Ke(y,l,x,v,r,u,d,t,c,s,p,m,!1,_,g);if(!h)return {notEnoughRoom:!0};const S=Xe(h.first.point,a).point,w=Xe(h.last.point,a).point;if(n&&!r){const e=Qe(t,S,w,f);if(t.flipState=e&&e.needsFlipping?1:2,e)return e;}b=[h.first];for(let n=t.glyphStartIndex+1;n<e-1;n++)b.push(rt(y*l.getoffsetX(n),x,v,r,u,d,t.segment,i,o,c,s,p,m,!1,!1,_,g));b.push(h.last);}else {if(n&&!r){const i=Xe(d,o).point,r=t.lineStartIndex+t.segment+1,n=new e.pointGeometry(c.getx(r),c.gety(r)),s=Xe(n,o),a=Qe(t,i,s.signedDistanceFromCamera>0?s.point:it(d,n,i,1,o,void 0,_,g.canonical),f);if(t.flipState=a&&a.needsFlipping?1:2,a)return a;}const i=rt(y*l.getoffsetX(t.glyphStartIndex),x,v,r,u,d,t.segment,t.lineStartIndex,t.lineStartIndex+t.lineLength,c,s,p,m,!1,!1,_,g);if(!i)return {notEnoughRoom:!0};b=[i];}for(const t of b)e.addDynamicAttributes(h,t.point,t.angle);return {};}function tt(t,i,r,n,o){const s=n.projectTilePoint(t.x,t.y,i);if(!o)return Xe(s,r,s.z);const a=o(t);return Xe(new e.pointGeometry(s.x+a[0],s.y+a[1]),r,s.z+a[2]);}function it(e,t,i,r,n,o,s,a){const l=tt(e.add(e.sub(t)._unit()),a,n,s,o).point,c=i.sub(l);return i.add(c._mult(r/c.mag()));}function rt(t,i,r,n,o,s,a,l,c,h,u,d,p,f,m,_,g){const y=n?t-i:t+i;let x=y>0?1:-1,v=0;n&&(x*=-1,v=Math.PI),x<0&&(v+=Math.PI);let b=x>0?l+a:l+a+1,S=o,w=o,T=0,E=0;const N=Math.abs(y),I=[],M=[];let C=s;const A=()=>{const t=b-x;return 0===T?s:new e.pointGeometry(h.getx(t),h.gety(t));},P=()=>it(A(),C,w,N-T+1,u,p,_,g.canonical);for(;T+E<=N;){if(b+=x,b<l||b>=c)return null;if(w=S,I.push(S),f&&M.push(C||A()),S=d[b],void 0===S){C=new e.pointGeometry(h.getx(b),h.gety(b));const t=tt(C,g.canonical,u,_,p);S=t.signedDistanceFromCamera>0?d[b]=t.point:P();}else C=null;T+=E,E=w.dist(S);}m&&p&&(C=C||new e.pointGeometry(h.getx(b),h.gety(b)),d[b]=S=void 0===d[b]?S:P(),E=w.dist(S));const L=(N-T)/E,D=S.sub(w),k=D.mult(L)._add(w);r&&k._add(D._unit()._perp()._mult(r*x));const z=v+Math.atan2(S.y-w.y,S.x-w.x);return I.push(k),f&&(C=C||new e.pointGeometry(h.getx(b),h.gety(b)),M.push(function(t,i,r){const n=1-r;return new e.pointGeometry(t.x*n+i.x*r,t.y*n+i.y*r);}(M.length>0?M[M.length-1]:C,C,L))),{point:k,angle:z,path:I,tilePath:M};}const nt=new Float32Array([-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0,-1/0,-1/0,0]);function ot(e,t){for(let i=0;i<e;i++){const e=t.length;t.resize(e+4),t.float32.set(nt,3*e);}}function st(e,t,i){const r=t[0],n=t[1];return e[0]=i[0]*r+i[4]*n+i[12],e[1]=i[1]*r+i[5]*n+i[13],e[3]=i[3]*r+i[7]*n+i[15],e;}const at=100;class lt{constructor(e,t,i=new $e(e.width+200,e.height+200,25),r=new $e(e.width+200,e.height+200,25)){this.transform=e,this.grid=i,this.ignoredGrid=r,this.pitchfactor=Math.cos(e._pitch)*e.cameraToCenterDistance,this.screenRightBoundary=e.width+at,this.screenBottomBoundary=e.height+at,this.gridRightBoundary=e.width+200,this.gridBottomBoundary=e.height+200,this.fogState=t;}placeCollisionBox(e,t,i,r,n,o,s){let a=t.projectedAnchorX,l=t.projectedAnchorY,c=t.projectedAnchorZ;const h=t.elevation,u=t.tileID;if(h&&u){const e=this.transform.projection.createTileTransform(this.transform,this.transform.worldSize),i=e.upVector(u.canonical,t.tileAnchorX,t.tileAnchorY),r=e.upVectorScale(u.canonical);a+=i[0]*h*r,l+=i[1]*h*r,c+=i[2]*h*r;}const d=this.projectAndGetPerspectiveRatio(o,a,l,c,t.tileID),p=n*d.perspectiveRatio,f=(t.x1*e+i.x-t.padding)*p+d.point.x,m=(t.y1*e+i.y-t.padding)*p+d.point.y,_=(t.x2*e+i.x+t.padding)*p+d.point.x,g=(t.y2*e+i.y+t.padding)*p+d.point.y,y=d.perspectiveRatio<=.55||d.aboveHorizon;return !this.isInsideGrid(f,m,_,g)||!r&&this.grid.hitTest(f,m,_,g,s)||y?{box:[],offscreen:!1}:{box:[f,m,_,g],offscreen:this.isOffscreen(f,m,_,g)};}placeCollisionCircles(t,i,r,n,o,s,a,l,c,h,u,d,p,f){const m=[],_=this.transform.elevation,g=this.transform.projection.createTileTransform(this.transform,this.transform.worldSize),y=_?_.getAtTileOffsetFunc(f,g):e=>[0,0,0],x=new e.pointGeometry(i.tileAnchorX,i.tileAnchorY),v=this.transform.projection.projectTilePoint(i.tileAnchorX,i.tileAnchorY,f.canonical),b=y(x),S=[v.x+b[0],v.y+b[1],v.z+b[2]],w=this.projectAndGetPerspectiveRatio(s,S[0],S[1],S[2],f),{perspectiveRatio:T}=w,E=(h?o/T:o*T)/e.ONE_EM,N=Xe(new e.pointGeometry(S[0],S[1]),a,S[2]).point,I=w.signedDistanceFromCamera>0?Ke(E,n,i.lineOffsetX*E,i.lineOffsetY*E,!1,N,x,i,r,a,{},_&&!h?y:null,h&&!!_,this.transform.projection,f):null;let M=!1,C=!1,A=!0;if(I&&!w.aboveHorizon){const i=.5*d*T+p,r=new e.pointGeometry(-100,-100),n=new e.pointGeometry(this.screenRightBoundary,this.screenBottomBoundary),o=new je(),s=I.first,a=I.last;let h=[];for(let e=s.path.length-1;e>=1;e--)h.push(s.path[e]);for(let e=1;e<a.path.length;e++)h.push(a.path[e]);const f=2.5*i;if(l){const e=h.map(_?(e,t)=>{const i=y(t<s.path.length-1?s.tilePath[s.path.length-1-t]:a.tilePath[t-s.path.length+2]);return Xe(e,l,i[2]);}:e=>Xe(e,l));h=e.some(e=>e.signedDistanceFromCamera<=0)?[]:e.map(e=>e.point);}let g=[];if(h.length>0){const t=h[0].clone(),i=h[0].clone();for(let e=1;e<h.length;e++)t.x=Math.min(t.x,h[e].x),t.y=Math.min(t.y,h[e].y),i.x=Math.max(i.x,h[e].x),i.y=Math.max(i.y,h[e].y);g=t.x>=r.x&&i.x<=n.x&&t.y>=r.y&&i.y<=n.y?[h]:i.x<r.x||t.x>n.x||i.y<r.y||t.y>n.y?[]:e.clipLine([h],r.x,r.y,n.x,n.y);}for(const e of g){o.reset(e,.25*i);let r=0;r=o.length<=.5*i?1:Math.ceil(o.paddedLength/f)+1;for(let e=0;e<r;e++){const n=e/Math.max(r-1,1),s=o.lerp(n),a=s.x+at,l=s.y+at;m.push(a,l,i,0);const h=a-i,d=l-i,p=a+i,f=l+i;if(A=A&&this.isOffscreen(h,d,p,f),C=C||this.isInsideGrid(h,d,p,f),!t&&this.grid.hitTestCircle(a,l,i,u)&&(M=!0,!c))return {circles:[],offscreen:!1,collisionDetected:M};}}}return {circles:!c&&M||!C?[]:m,offscreen:A,collisionDetected:M};}queryRenderedSymbols(t){if(0===t.length||0===this.grid.keysLength()&&0===this.ignoredGrid.keysLength())return {};const i=[];let r=1/0,n=1/0,o=-1/0,s=-1/0;for(const a of t){const t=new e.pointGeometry(a.x+at,a.y+at);r=Math.min(r,t.x),n=Math.min(n,t.y),o=Math.max(o,t.x),s=Math.max(s,t.y),i.push(t);}const a=this.grid.query(r,n,o,s).concat(this.ignoredGrid.query(r,n,o,s)),l={},c={};for(const t of a){const r=t.key;if(void 0===l[r.bucketInstanceId]&&(l[r.bucketInstanceId]={}),l[r.bucketInstanceId][r.featureIndex])continue;const n=[new e.pointGeometry(t.x1,t.y1),new e.pointGeometry(t.x2,t.y1),new e.pointGeometry(t.x2,t.y2),new e.pointGeometry(t.x1,t.y2)];e.polygonIntersectsPolygon(i,n)&&(l[r.bucketInstanceId][r.featureIndex]=!0,void 0===c[r.bucketInstanceId]&&(c[r.bucketInstanceId]=[]),c[r.bucketInstanceId].push(r.featureIndex));}return c;}insertCollisionBox(e,t,i,r,n){(t?this.ignoredGrid:this.grid).insert({bucketInstanceId:i,featureIndex:r,collisionGroupID:n},e[0],e[1],e[2],e[3]);}insertCollisionCircles(e,t,i,r,n){const o=t?this.ignoredGrid:this.grid,s={bucketInstanceId:i,featureIndex:r,collisionGroupID:n};for(let t=0;t<e.length;t+=4)o.insertCircle(s,e[t],e[t+1],e[t+2]);}projectAndGetPerspectiveRatio(t,i,r,n,o){const s=[i,r,n||0,1];let a=!1;if(n||this.transform.pitch>0){e.transformMat4$1(s,s,t);let l=!1;this.fogState&&o&&(l=function(t,i,r,n,o,s){const a=s.calculateFogTileMatrix(o),l=[i,r,n];return e.transformMat4(l,l,a),v(t,l,s.pitch,s._fov);}(this.fogState,i,r,n||0,o.toUnwrapped(),this.transform)>.9),a=s[2]>s[3]||l;}else st(s,s,t);return {point:new e.pointGeometry((s[0]/s[3]+1)/2*this.transform.width+at,(-s[1]/s[3]+1)/2*this.transform.height+at),perspectiveRatio:Math.min(.5+this.transform.cameraToCenterDistance/s[3]*.5,1.5),signedDistanceFromCamera:s[3],aboveHorizon:a};}isOffscreen(e,t,i,r){return i<at||e>=this.screenRightBoundary||r<at||t>this.screenBottomBoundary;}isInsideGrid(e,t,i,r){return i>=0&&e<this.gridRightBoundary&&r>=0&&t<this.gridBottomBoundary;}getViewportMatrix(){const t=e.identity([]);return e.translate(t,t,[-100,-100,0]),t;}}class ct{constructor(e,t,i,r){this.opacity=e?Math.max(0,Math.min(1,e.opacity+(e.placed?t:-t))):r&&i?1:0,this.placed=i;}isHidden(){return 0===this.opacity&&!this.placed;}}class ht{constructor(e,t,i,r,n,o=!1){this.text=new ct(e?e.text:null,t,i,n),this.icon=new ct(e?e.icon:null,t,r,n),this.clipped=o;}isHidden(){return this.text.isHidden()&&this.icon.isHidden();}}class ut{constructor(e,t,i,r=!1){this.text=e,this.icon=t,this.skipFade=i,this.clipped=r;}}class dt{constructor(){this.invProjMatrix=e.create(),this.viewportMatrix=e.create(),this.circles=[];}}class pt{constructor(e,t,i,r,n){this.bucketInstanceId=e,this.featureIndex=t,this.sourceLayerIndex=i,this.bucketIndex=r,this.tileID=n;}}class ft{constructor(e){this.crossSourceCollisions=e,this.maxGroupID=0,this.collisionGroups={};}get(e){if(this.crossSourceCollisions)return {ID:0,predicate:null};if(!this.collisionGroups[e]){const t=++this.maxGroupID;this.collisionGroups[e]={ID:t,predicate:e=>e.collisionGroupID===t};}return this.collisionGroups[e];}}function mt(t,i,r,n,o){const{horizontalAlign:s,verticalAlign:a}=e.getAnchorAlignment(t),l=-(s-.5)*i,c=-(a-.5)*r,h=e.evaluateVariableOffset(t,n);return new e.pointGeometry(l+h[0]*o,c+h[1]*o);}function _t(t,i,r,n,o){const s=new e.pointGeometry(t,i);return r&&s._rotate(n?o:-o),s;}class gt{constructor(e,t,i,r,n){this.transform=e.clone(),this.collisionIndex=new lt(this.transform,n),this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=t,this.retainedQueryData={},this.collisionGroups=new ft(i),this.collisionCircleArrays={},this.prevPlacement=r,r&&(r.prevPlacement=void 0),this.placedOrientations={};}getBucketParts(t,i,r,n){const o=r.getBucket(i),s=r.latestFeatureIndex;if(!o||!s||i.id!==o.layerIds[0])return;const a=o.layers[0].layout,l=r.collisionBoxArray,c=Math.pow(2,this.transform.zoom-r.tileID.overscaledZ),h=r.tileSize/e.EXTENT,u=r.tileID.toUnwrapped(),d=this.transform.calculateProjMatrix(u),p="map"===a.get("text-pitch-alignment"),f="map"===a.get("text-rotation-alignment");i.compileFilter();const m=i.dynamicFilter(),_=i.dynamicFilterNeedsFeature(),g=this.transform.calculatePixelsToTileUnitsMatrix(r),y=qe(d,r.tileID.canonical,p,f,this.transform,g);let x=null;if(p){const t=Ze(d,r.tileID.canonical,p,f,this.transform,g);x=e.multiply$1([],this.transform.labelPlaneMatrix,t);}let v=null;m&&r.latestFeatureIndex&&(v={unwrappedTileID:u,dynamicFilter:m,dynamicFilterNeedsFeature:_,featureIndex:r.latestFeatureIndex}),this.retainedQueryData[o.bucketInstanceId]=new pt(o.bucketInstanceId,s,o.sourceLayerIndex,o.index,r.tileID);const b={bucket:o,layout:a,posMatrix:d,textLabelPlaneMatrix:y,labelToScreenMatrix:x,clippingData:v,scale:c,textPixelRatio:h,holdingForFade:r.holdingForFade(),collisionBoxArray:l,partiallyEvaluatedTextSize:e.evaluateSizeForZoom(o.textSizeData,this.transform.zoom),partiallyEvaluatedIconSize:e.evaluateSizeForZoom(o.iconSizeData,this.transform.zoom),collisionGroup:this.collisionGroups.get(o.sourceID)};if(n)for(const e of o.sortKeyRanges){const{sortKey:i,symbolInstanceStart:r,symbolInstanceEnd:n}=e;t.push({sortKey:i,symbolInstanceStart:r,symbolInstanceEnd:n,parameters:b});}else t.push({symbolInstanceStart:0,symbolInstanceEnd:o.symbolInstances.length,parameters:b});}attemptAnchorPlacement(e,t,i,r,n,o,s,a,l,c,h,u,d,p,f,m,_,g){const y=[u.textOffset0,u.textOffset1],x=mt(e,i,r,y,n),v=this.collisionIndex.placeCollisionBox(n,t,_t(x.x,x.y,o,s,this.transform.angle),h,a,l,c.predicate);if((!m||0!==this.collisionIndex.placeCollisionBox(p.getSymbolInstanceIconSize(g,this.transform.zoom,d),m,_t(x.x,x.y,o,s,this.transform.angle),h,a,l,c.predicate).box.length)&&v.box.length>0){let t;return this.prevPlacement&&this.prevPlacement.variableOffsets[u.crossTileID]&&this.prevPlacement.placements[u.crossTileID]&&this.prevPlacement.placements[u.crossTileID].text&&(t=this.prevPlacement.variableOffsets[u.crossTileID].anchor),this.variableOffsets[u.crossTileID]={textOffset:y,width:i,height:r,anchor:e,textScale:n,prevAnchor:t},this.markUsedJustification(p,e,u,f),p.allowVerticalPlacement&&(this.markUsedOrientation(p,f,u),this.placedOrientations[u.crossTileID]=f),{shift:x,placedGlyphBoxes:v};}}placeLayerBucketPart(t,i,r,n){const{bucket:o,layout:s,posMatrix:a,textLabelPlaneMatrix:l,labelToScreenMatrix:c,clippingData:h,textPixelRatio:u,holdingForFade:d,collisionBoxArray:p,partiallyEvaluatedTextSize:f,partiallyEvaluatedIconSize:m,collisionGroup:_}=t.parameters,g=s.get("text-optional"),y=s.get("icon-optional"),x=s.get("text-allow-overlap"),v=s.get("icon-allow-overlap"),b="map"===s.get("text-rotation-alignment"),S="map"===s.get("text-pitch-alignment"),w="none"!==s.get("icon-text-fit"),T="viewport-y"===s.get("symbol-z-order"),E=x&&(v||!o.hasIconData()||y),N=v&&(x||!o.hasTextData()||g);!o.collisionArrays&&p&&o.deserializeCollisionBoxes(p),r&&n&&o.updateCollisionDebugBuffers(this.transform.zoom,p);const I=(t,n,p)=>{if(h){const r={zoom:this.transform.zoom,pitch:this.transform.pitch};let n=null;if(h.dynamicFilterNeedsFeature){const e=this.retainedQueryData[o.bucketInstanceId];n=h.featureIndex.loadFeature({featureIndex:t.featureIndex,bucketIndex:e.bucketIndex,sourceLayerIndex:e.sourceLayerIndex,layoutVertexArrayOffset:0});}if(!(0, h.dynamicFilter)(r,n,this.retainedQueryData[o.bucketInstanceId].tileID.canonical,new e.pointGeometry(t.tileAnchorX,t.tileAnchorY),this.transform.calculateDistanceTileData(h.unwrappedTileID)))return this.placements[t.crossTileID]=new ut(!1,!1,!1,!0),void(i[t.crossTileID]=!0);}if(i[t.crossTileID])return;if(d)return void(this.placements[t.crossTileID]=new ut(!1,!1,!1));let T=!1,I=!1,M=!0,C=null,A={box:null,offscreen:null},P={box:null,offscreen:null},L=null,D=null,k=null,z=0,R=0,O=0;p.textFeatureIndex?z=p.textFeatureIndex:t.useRuntimeCollisionCircles&&(z=t.featureIndex),p.verticalTextFeatureIndex&&(R=p.verticalTextFeatureIndex);const F=e=>{e.tileID=this.retainedQueryData[o.bucketInstanceId].tileID,(this.transform.elevation||e.elevation)&&(e.elevation=this.transform.elevation?this.transform.elevation.getAtTileOffset(this.retainedQueryData[o.bucketInstanceId].tileID,e.tileAnchorX,e.tileAnchorY):0);},B=p.textBox;if(B){F(B);const i=i=>{let r=e.WritingMode.horizontal;if(o.allowVerticalPlacement&&!i&&this.prevPlacement){const e=this.prevPlacement.placedOrientations[t.crossTileID];e&&(this.placedOrientations[t.crossTileID]=e,r=e,this.markUsedOrientation(o,r,t));}return r;},r=(i,r)=>{if(o.allowVerticalPlacement&&t.numVerticalGlyphVertices>0&&p.verticalTextBox){for(const t of o.writingModes)if(t===e.WritingMode.vertical?(A=r(),P=A):A=i(),A&&A.box&&A.box.length)break;}else A=i();};if(s.get("text-variable-anchor")){let l=s.get("text-variable-anchor");if(this.prevPlacement&&this.prevPlacement.variableOffsets[t.crossTileID]){const e=this.prevPlacement.variableOffsets[t.crossTileID];l.indexOf(e.anchor)>0&&(l=l.filter(t=>t!==e.anchor),l.unshift(e.anchor));}const c=(e,i,r)=>{const s=o.getSymbolInstanceTextSize(f,t,this.transform.zoom,n),c=(e.x2-e.x1)*s+2*e.padding,h=(e.y2-e.y1)*s+2*e.padding,d=w&&!v?i:null;d&&F(d);let p={box:[],offscreen:!1};const g=x?2*l.length:l.length;for(let i=0;i<g;++i){const g=this.attemptAnchorPlacement(l[i%l.length],e,c,h,s,b,S,u,a,_,i>=l.length,t,n,o,r,d,f,m);if(g&&(p=g.placedGlyphBoxes,p&&p.box&&p.box.length)){T=!0,C=g.shift;break;}}return p;};r(()=>c(B,p.iconBox,e.WritingMode.horizontal),()=>{const i=p.verticalTextBox;return i&&F(i),o.allowVerticalPlacement&&!(A&&A.box&&A.box.length)&&t.numVerticalGlyphVertices>0&&i?c(i,p.verticalIconBox,e.WritingMode.vertical):{box:null,offscreen:null};}),A&&(T=A.box,M=A.offscreen);const h=i(A&&A.box);if(!T&&this.prevPlacement){const e=this.prevPlacement.variableOffsets[t.crossTileID];e&&(this.variableOffsets[t.crossTileID]=e,this.markUsedJustification(o,e.anchor,t,h));}}else {const s=(i,r)=>{const s=o.getSymbolInstanceTextSize(f,t,this.transform.zoom,n),l=this.collisionIndex.placeCollisionBox(s,i,new e.pointGeometry(0,0),x,u,a,_.predicate);return l&&l.box&&l.box.length&&(this.markUsedOrientation(o,r,t),this.placedOrientations[t.crossTileID]=r),l;};r(()=>s(B,e.WritingMode.horizontal),()=>{const i=p.verticalTextBox;return o.allowVerticalPlacement&&t.numVerticalGlyphVertices>0&&i?(F(i),s(i,e.WritingMode.vertical)):{box:null,offscreen:null};}),i(A&&A.box&&A.box.length);}}if(L=A,T=L&&L.box&&L.box.length>0,M=L&&L.offscreen,t.useRuntimeCollisionCircles){const i=o.text.placedSymbolArray.get(t.centerJustifiedTextSymbolIndex>=0?t.centerJustifiedTextSymbolIndex:t.verticalPlacedTextSymbolIndex),n=e.evaluateSizeForFeature(o.textSizeData,f,i),h=s.get("text-padding");D=this.collisionIndex.placeCollisionCircles(x,i,o.lineVertexArray,o.glyphOffsetArray,n,a,l,c,r,S,_.predicate,t.collisionCircleDiameter*n/e.ONE_EM,h,this.retainedQueryData[o.bucketInstanceId].tileID),T=x||D.circles.length>0&&!D.collisionDetected,M=M&&D.offscreen;}if(p.iconFeatureIndex&&(O=p.iconFeatureIndex),p.iconBox){const t=t=>{F(t);const i=w&&C?_t(C.x,C.y,b,S,this.transform.angle):new e.pointGeometry(0,0),r=o.getSymbolInstanceIconSize(m,this.transform.zoom,n);return this.collisionIndex.placeCollisionBox(r,t,i,v,u,a,_.predicate);};P&&P.box&&P.box.length&&p.verticalIconBox?(k=t(p.verticalIconBox),I=k.box.length>0):(k=t(p.iconBox),I=k.box.length>0),M=M&&k.offscreen;}const U=g||0===t.numHorizontalGlyphVertices&&0===t.numVerticalGlyphVertices,V=y||0===t.numIconVertices;if(U||V?V?U||(I=I&&T):T=I&&T:I=T=I&&T,T&&L&&L.box&&this.collisionIndex.insertCollisionBox(L.box,s.get("text-ignore-placement"),o.bucketInstanceId,P&&P.box&&R?R:z,_.ID),I&&k&&this.collisionIndex.insertCollisionBox(k.box,s.get("icon-ignore-placement"),o.bucketInstanceId,O,_.ID),D&&(T&&this.collisionIndex.insertCollisionCircles(D.circles,s.get("text-ignore-placement"),o.bucketInstanceId,z,_.ID),r)){const e=o.bucketInstanceId;let t=this.collisionCircleArrays[e];void 0===t&&(t=this.collisionCircleArrays[e]=new dt());for(let e=0;e<D.circles.length;e+=4)t.circles.push(D.circles[e+0]),t.circles.push(D.circles[e+1]),t.circles.push(D.circles[e+2]),t.circles.push(D.collisionDetected?1:0);}this.placements[t.crossTileID]=new ut(T||E,I||N,M||o.justReloaded),i[t.crossTileID]=!0;};if(T){const e=o.getSortedSymbolIndexes(this.transform.angle);for(let t=e.length-1;t>=0;--t){const i=e[t];I(o.symbolInstances.get(i),i,o.collisionArrays[i]);}}else for(let e=t.symbolInstanceStart;e<t.symbolInstanceEnd;e++)I(o.symbolInstances.get(e),e,o.collisionArrays[e]);if(r&&o.bucketInstanceId in this.collisionCircleArrays){const t=this.collisionCircleArrays[o.bucketInstanceId];e.invert(t.invProjMatrix,a),t.viewportMatrix=this.collisionIndex.getViewportMatrix();}o.justReloaded=!1;}markUsedJustification(t,i,r,n){let o;o=n===e.WritingMode.vertical?r.verticalPlacedTextSymbolIndex:{left:r.leftJustifiedTextSymbolIndex,center:r.centerJustifiedTextSymbolIndex,right:r.rightJustifiedTextSymbolIndex}[e.getAnchorJustification(i)];const s=[r.leftJustifiedTextSymbolIndex,r.centerJustifiedTextSymbolIndex,r.rightJustifiedTextSymbolIndex,r.verticalPlacedTextSymbolIndex];for(const e of s)e>=0&&(t.text.placedSymbolArray.get(e).crossTileID=o>=0&&e!==o?0:r.crossTileID);}markUsedOrientation(t,i,r){const n=i===e.WritingMode.horizontal||i===e.WritingMode.horizontalOnly?i:0,o=i===e.WritingMode.vertical?i:0,s=[r.leftJustifiedTextSymbolIndex,r.centerJustifiedTextSymbolIndex,r.rightJustifiedTextSymbolIndex];for(const e of s)t.text.placedSymbolArray.get(e).placedOrientation=n;r.verticalPlacedTextSymbolIndex&&(t.text.placedSymbolArray.get(r.verticalPlacedTextSymbolIndex).placedOrientation=o);}commit(e){this.commitTime=e,this.zoomAtLastRecencyCheck=this.transform.zoom;const t=this.prevPlacement;let i=!1;this.prevZoomAdjustment=t?t.zoomAdjustment(this.transform.zoom):0;const r=t?t.symbolFadeChange(e):1,n=t?t.opacities:{},o=t?t.variableOffsets:{},s=t?t.placedOrientations:{};for(const e in this.placements){const t=this.placements[e],o=n[e];o?(this.opacities[e]=new ht(o,r,t.text,t.icon,null,t.clipped),i=i||t.text!==o.text.placed||t.icon!==o.icon.placed):(this.opacities[e]=new ht(null,r,t.text,t.icon,t.skipFade,t.clipped),i=i||t.text||t.icon);}for(const e in n){const t=n[e];if(!this.opacities[e]){const n=new ht(t,r,!1,!1);n.isHidden()||(this.opacities[e]=n,i=i||t.text.placed||t.icon.placed);}}for(const e in o)this.variableOffsets[e]||!this.opacities[e]||this.opacities[e].isHidden()||(this.variableOffsets[e]=o[e]);for(const e in s)this.placedOrientations[e]||!this.opacities[e]||this.opacities[e].isHidden()||(this.placedOrientations[e]=s[e]);i?this.lastPlacementChangeTime=e:"number"!=typeof this.lastPlacementChangeTime&&(this.lastPlacementChangeTime=t?t.lastPlacementChangeTime:e);}updateLayerOpacities(e,t){const i={};for(const r of t){const t=r.getBucket(e);t&&r.latestFeatureIndex&&e.id===t.layerIds[0]&&this.updateBucketOpacities(t,i,r.collisionBoxArray);}}updateBucketOpacities(t,i,r){t.hasTextData()&&t.text.opacityVertexArray.clear(),t.hasIconData()&&t.icon.opacityVertexArray.clear(),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();const n=t.layers[0].layout,o=!!t.layers[0].dynamicFilter(),s=new ht(null,0,!1,!1,!0),a=n.get("text-allow-overlap"),l=n.get("icon-allow-overlap"),c=n.get("text-variable-anchor"),h="map"===n.get("text-rotation-alignment"),u="map"===n.get("text-pitch-alignment"),d="none"!==n.get("icon-text-fit"),p=new ht(null,0,a&&(l||!t.hasIconData()||n.get("icon-optional")),l&&(a||!t.hasTextData()||n.get("text-optional")),!0);!t.collisionArrays&&r&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(r);const f=(e,t,i)=>{for(let r=0;r<t/4;r++)e.opacityVertexArray.emplaceBack(i);};let m=0;for(let r=0;r<t.symbolInstances.length;r++){const n=t.symbolInstances.get(r),{numHorizontalGlyphVertices:a,numVerticalGlyphVertices:l,crossTileID:_}=n;let g=this.opacities[_];i[_]?g=s:g||(g=p,this.opacities[_]=g),i[_]=!0;const y=a>0||l>0,x=n.numIconVertices>0,v=this.placedOrientations[n.crossTileID],b=v===e.WritingMode.vertical,S=v===e.WritingMode.horizontal||v===e.WritingMode.horizontalOnly;if(!y&&!x||g.isHidden()||m++,y){const e=Nt(g.text);f(t.text,a,b?It:e),f(t.text,l,S?It:e);const i=g.text.isHidden();[n.rightJustifiedTextSymbolIndex,n.centerJustifiedTextSymbolIndex,n.leftJustifiedTextSymbolIndex].forEach(e=>{e>=0&&(t.text.placedSymbolArray.get(e).hidden=i||b?1:0);}),n.verticalPlacedTextSymbolIndex>=0&&(t.text.placedSymbolArray.get(n.verticalPlacedTextSymbolIndex).hidden=i||S?1:0);const r=this.variableOffsets[n.crossTileID];r&&this.markUsedJustification(t,r.anchor,n,v);const o=this.placedOrientations[n.crossTileID];o&&(this.markUsedJustification(t,"left",n,o),this.markUsedOrientation(t,o,n));}if(x){const e=Nt(g.icon);n.placedIconSymbolIndex>=0&&(f(t.icon,n.numIconVertices,b?It:e),t.icon.placedSymbolArray.get(n.placedIconSymbolIndex).hidden=g.icon.isHidden()),n.verticalPlacedIconSymbolIndex>=0&&(f(t.icon,n.numVerticalIconVertices,S?It:e),t.icon.placedSymbolArray.get(n.verticalPlacedIconSymbolIndex).hidden=g.icon.isHidden());}if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){const i=t.collisionArrays[r];if(i){let r=new e.pointGeometry(0,0),n=!0;if(i.textBox||i.verticalTextBox){if(c){const e=this.variableOffsets[_];e?(r=mt(e.anchor,e.width,e.height,e.textOffset,e.textScale),h&&r._rotate(u?this.transform.angle:-this.transform.angle)):n=!1;}o&&(n=!g.clipped),i.textBox&&yt(t.textCollisionBox.collisionVertexArray,g.text.placed,!n||b,r.x,r.y),i.verticalTextBox&&yt(t.textCollisionBox.collisionVertexArray,g.text.placed,!n||S,r.x,r.y);}const s=n&&Boolean(!S&&i.verticalIconBox);i.iconBox&&yt(t.iconCollisionBox.collisionVertexArray,g.icon.placed,s,d?r.x:0,d?r.y:0),i.verticalIconBox&&yt(t.iconCollisionBox.collisionVertexArray,g.icon.placed,!s,d?r.x:0,d?r.y:0);}}}if(t.fullyClipped=0===m,t.sortFeatures(this.transform.angle),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.bucketInstanceId in this.collisionCircleArrays){const e=this.collisionCircleArrays[t.bucketInstanceId];t.placementInvProjMatrix=e.invProjMatrix,t.placementViewportMatrix=e.viewportMatrix,t.collisionCircleArray=e.circles,delete this.collisionCircleArrays[t.bucketInstanceId];}}symbolFadeChange(e){return 0===this.fadeDuration?1:(e-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment;}zoomAdjustment(e){return Math.max(0,(this.transform.zoom-e)/1.5);}hasTransitions(e){return this.stale||e-this.lastPlacementChangeTime<this.fadeDuration;}stillRecent(e,t){const i=this.zoomAtLastRecencyCheck===t?1-this.zoomAdjustment(t):1;return this.zoomAtLastRecencyCheck=t,this.commitTime+this.fadeDuration*i>e;}setStale(){this.stale=!0;}}function yt(e,t,i,r,n){e.emplaceBack(t?1:0,i?1:0,r||0,n||0),e.emplaceBack(t?1:0,i?1:0,r||0,n||0),e.emplaceBack(t?1:0,i?1:0,r||0,n||0),e.emplaceBack(t?1:0,i?1:0,r||0,n||0);}const xt=Math.pow(2,25),vt=Math.pow(2,24),bt=Math.pow(2,17),St=Math.pow(2,16),wt=Math.pow(2,9),Tt=Math.pow(2,8),Et=Math.pow(2,1);function Nt(e){if(0===e.opacity&&!e.placed)return 0;if(1===e.opacity&&e.placed)return 4294967295;const t=e.placed?1:0,i=Math.floor(127*e.opacity);return i*xt+t*vt+i*bt+t*St+i*wt+t*Tt+i*Et+t;}const It=0;class Mt{constructor(e){this._sortAcrossTiles="viewport-y"!==e.layout.get("symbol-z-order")&&void 0!==e.layout.get("symbol-sort-key").constantOr(1),this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs={},this._bucketParts=[];}continuePlacement(e,t,i,r,n){const o=this._bucketParts;for(;this._currentTileIndex<e.length;)if(t.getBucketParts(o,r,e[this._currentTileIndex],this._sortAcrossTiles),this._currentTileIndex++,n())return !0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,o.sort((e,t)=>e.sortKey-t.sortKey));this._currentPartIndex<o.length;){const e=o[this._currentPartIndex];if(t.placeLayerBucketPart(e,this._seenCrossTileIDs,i,0===e.symbolInstanceStart),this._currentPartIndex++,n())return !0;}return !1;}}class Ct{constructor(e,t,i,r,n,o,s,a){this.placement=new gt(e,n,o,s,a),this._currentPlacementIndex=t.length-1,this._forceFullPlacement=i,this._showCollisionBoxes=r,this._done=!1;}isDone(){return this._done;}continuePlacement(t,i,r){const n=e.exported.now(),o=()=>{const t=e.exported.now()-n;return !this._forceFullPlacement&&t>2;};for(;this._currentPlacementIndex>=0;){const e=i[t[this._currentPlacementIndex]],n=this.placement.collisionIndex.transform.zoom;if("symbol"===e.type&&(!e.minzoom||e.minzoom<=n)&&(!e.maxzoom||e.maxzoom>n)){if(this._inProgressLayer||(this._inProgressLayer=new Mt(e)),this._inProgressLayer.continuePlacement(r[e.source],this.placement,this._showCollisionBoxes,e,o))return;delete this._inProgressLayer;}this._currentPlacementIndex--;}this._done=!0;}commit(e){return this.placement.commit(e),this.placement;}}const At=512/e.EXTENT/2;class Pt{constructor(e,t,i){this.tileID=e,this.indexedSymbolInstances={},this.bucketInstanceId=i;for(let i=0;i<t.length;i++){const r=t.get(i),n=r.key;this.indexedSymbolInstances[n]||(this.indexedSymbolInstances[n]=[]),this.indexedSymbolInstances[n].push({crossTileID:r.crossTileID,coord:this.getScaledCoordinates(r,e)});}}getScaledCoordinates(t,i){const r=At/Math.pow(2,i.canonical.z-this.tileID.canonical.z);return {x:Math.floor((i.canonical.x*e.EXTENT+t.tileAnchorX)*r),y:Math.floor((i.canonical.y*e.EXTENT+t.tileAnchorY)*r)};}findMatches(e,t,i){const r=this.tileID.canonical.z<t.canonical.z?1:Math.pow(2,this.tileID.canonical.z-t.canonical.z);for(let n=0;n<e.length;n++){const o=e.get(n);if(o.crossTileID)continue;const s=this.indexedSymbolInstances[o.key];if(!s)continue;const a=this.getScaledCoordinates(o,t);for(const e of s)if(Math.abs(e.coord.x-a.x)<=r&&Math.abs(e.coord.y-a.y)<=r&&!i[e.crossTileID]){i[e.crossTileID]=!0,o.crossTileID=e.crossTileID;break;}}}}class Lt{constructor(){this.maxCrossTileID=0;}generate(){return ++this.maxCrossTileID;}}class Dt{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0;}handleWrapJump(e){const t=Math.round((e-this.lng)/360);if(0!==t)for(const e in this.indexes){const i=this.indexes[e],r={};for(const e in i){const n=i[e];n.tileID=n.tileID.unwrapTo(n.tileID.wrap+t),r[n.tileID.key]=n;}this.indexes[e]=r;}this.lng=e;}addBucket(e,t,i){if(this.indexes[e.overscaledZ]&&this.indexes[e.overscaledZ][e.key]){if(this.indexes[e.overscaledZ][e.key].bucketInstanceId===t.bucketInstanceId)return !1;this.removeBucketCrossTileIDs(e.overscaledZ,this.indexes[e.overscaledZ][e.key]);}for(let e=0;e<t.symbolInstances.length;e++)t.symbolInstances.get(e).crossTileID=0;this.usedCrossTileIDs[e.overscaledZ]||(this.usedCrossTileIDs[e.overscaledZ]={});const r=this.usedCrossTileIDs[e.overscaledZ];for(const i in this.indexes){const n=this.indexes[i];if(Number(i)>e.overscaledZ)for(const i in n){const o=n[i];o.tileID.isChildOf(e)&&o.findMatches(t.symbolInstances,e,r);}else {const o=n[e.scaledTo(Number(i)).key];o&&o.findMatches(t.symbolInstances,e,r);}}for(let e=0;e<t.symbolInstances.length;e++){const n=t.symbolInstances.get(e);n.crossTileID||(n.crossTileID=i.generate(),r[n.crossTileID]=!0);}return void 0===this.indexes[e.overscaledZ]&&(this.indexes[e.overscaledZ]={}),this.indexes[e.overscaledZ][e.key]=new Pt(e,t.symbolInstances,t.bucketInstanceId),!0;}removeBucketCrossTileIDs(e,t){for(const i in t.indexedSymbolInstances)for(const r of t.indexedSymbolInstances[i])delete this.usedCrossTileIDs[e][r.crossTileID];}removeStaleBuckets(e){let t=!1;for(const i in this.indexes){const r=this.indexes[i];for(const n in r)e[r[n].bucketInstanceId]||(this.removeBucketCrossTileIDs(i,r[n]),delete r[n],t=!0);}return t;}}class kt{constructor(){this.layerIndexes={},this.crossTileIDs=new Lt(),this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={};}addLayer(e,t,i,r){let n=this.layerIndexes[e.id];void 0===n&&(n=this.layerIndexes[e.id]=new Dt());let o=!1;const s={};"globe"!==r.name&&n.handleWrapJump(i);for(const i of t){const t=i.getBucket(e);t&&e.id===t.layerIds[0]&&(t.bucketInstanceId||(t.bucketInstanceId=++this.maxBucketInstanceId),n.addBucket(i.tileID,t,this.crossTileIDs)&&(o=!0),s[t.bucketInstanceId]=!0);}return n.removeStaleBuckets(s)&&(o=!0),o;}pruneUnusedLayers(e){const t={};e.forEach(e=>{t[e]=!0;});for(const e in this.layerIndexes)t[e]||delete this.layerIndexes[e];}}const zt=(t,i)=>e.emitValidationErrors(t,i&&i.filter(e=>"source.canvas"!==e.identifier)),Rt=e.pick(ze,["addLayer","removeLayer","setPaintProperty","setLayoutProperty","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setProjection"]),Ot=e.pick(ze,["setCenter","setZoom","setBearing","setPitch"]),Ft=function(){const t={},i=e.spec.$version;for(const r in e.spec.$root){const n=e.spec.$root[r];if(n.required){let e=null;e="version"===r?i:"array"===n.type?[]:{},null!=e&&(t[r]=e);}}return t;}(),Bt={fill:!0,line:!0,background:!0,hillshade:!0,raster:!0};class Ut extends e.Evented{constructor(t,i={}){super(),this.map=t,this.dispatcher=new E(Le(),this),this.imageManager=new p(),this.imageManager.setEventedParent(this),this.glyphManager=new e.GlyphManager(t._requestManager,i.localFontFamily?e.LocalGlyphMode.all:i.localIdeographFontFamily?e.LocalGlyphMode.ideographs:e.LocalGlyphMode.none,i.localFontFamily||i.localIdeographFontFamily),this.lineAtlas=new e.LineAtlas(256,512),this.crossTileSymbolIndex=new kt(),this._layers={},this._num3DLayers=0,this._numSymbolLayers=0,this._numCircleLayers=0,this._serializedLayers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this.zoomHistory=new e.ZoomHistory(),this._loaded=!1,this._availableImages=[],this._order=[],this._drapedFirstOrder=[],this._markersNeedUpdate=!1,this._resetUpdates(),this.dispatcher.broadcast("setReferrer",e.getReferrer());const r=this;this._rtlTextPluginCallback=Ut.registerForPluginStateChange(t=>{r.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:t.pluginStatus,pluginURL:t.pluginURL},(t,i)=>{if(e.triggerPluginCompletionEvent(t),i&&i.every(e=>e))for(const e in r._sourceCaches){const t=r._sourceCaches[e],i=t.getSource().type;"vector"!==i&&"geojson"!==i||t.reload();}});}),this.on("data",e=>{if("source"!==e.dataType||"metadata"!==e.sourceDataType)return;const t=this.getSource(e.sourceId);if(t&&t.vectorLayerIds)for(const e in this._layers){const i=this._layers[e];i.source===t.id&&this._validateLayer(i);}});}loadURL(t,i={}){this.fire(new e.Event("dataloading",{dataType:"style"}));const r="boolean"==typeof i.validate?i.validate:!e.isMapboxURL(t);t=this.map._requestManager.normalizeStyleURL(t,i.accessToken);const n=this.map._requestManager.transformRequest(t,e.ResourceType.Style);this._request=e.getJSON(n,(t,i)=>{this._request=null,t?this.fire(new e.ErrorEvent(t)):i&&this._load(i,r);});}loadJSON(t,i={}){this.fire(new e.Event("dataloading",{dataType:"style"})),this._request=e.exported.frame(()=>{this._request=null,this._load(t,!1!==i.validate);});}loadEmpty(){this.fire(new e.Event("dataloading",{dataType:"style"})),this._load(Ft,!1);}_updateLayerCount(e,t){const i=t?1:-1;e.is3D()&&(this._num3DLayers+=i),"circle"===e.type&&(this._numCircleLayers+=i),"symbol"===e.type&&(this._numSymbolLayers+=i);}_load(t,i){if(i&&zt(this,e.validateStyle(t)))return;this._loaded=!0,this.stylesheet=t,this.updateProjection();for(const e in t.sources)this.addSource(e,t.sources[e],{validate:!1});this._changed=!1,t.sprite?this._loadSprite(t.sprite):(this.imageManager.setLoaded(!0),this.dispatcher.broadcast("spriteLoaded",!0)),this.glyphManager.setURL(t.glyphs);const r=ke(this.stylesheet.layers);this._order=r.map(e=>e.id),this._layers={},this._serializedLayers={};for(let t of r)t=e.createStyleLayer(t),t.setEventedParent(this,{layer:{id:t.id}}),this._layers[t.id]=t,this._serializedLayers[t.id]=t.serialize(),this._updateLayerCount(t,!0);this.dispatcher.broadcast("setLayers",this._serializeLayers(this._order)),this.light=new _(this.stylesheet.light),this.stylesheet.terrain&&!this.terrainSetForDrapingOnly()&&this._createTerrain(this.stylesheet.terrain,1),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this._updateDrapeFirstLayers(),this.fire(new e.Event("data",{dataType:"style"})),this.fire(new e.Event("style.load"));}terrainSetForDrapingOnly(){return this.terrain&&0===this.terrain.drapeRenderMode;}setProjection(e){e?this.stylesheet.projection=e:delete this.stylesheet.projection,this.updateProjection();}updateProjection(){const e=this.map.transform.projection,t=this.map.transform.setProjection(this.map._runtimeProjection||(this.stylesheet?this.stylesheet.projection:void 0)),i=this.map.transform.projection;if(this._loaded&&(i.requiresDraping?this.getTerrain()||this.stylesheet.terrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null)),this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),t){if(i.isReprojectedInTileSpace||e.isReprojectedInTileSpace){this.map.painter.clearBackgroundTiles();for(const e in this._sourceCaches)this._sourceCaches[e].clearTiles();}else this._forceSymbolLayerUpdate();this.map._update(!0);}}_loadSprite(t){this._spriteRequest=function(t,i,r){let n,o,s;const a=e.exported.devicePixelRatio>1?"@2x":"";let l=e.getJSON(i.transformRequest(i.normalizeSpriteURL(t,a,".json"),e.ResourceType.SpriteJSON),(e,t)=>{l=null,s||(s=e,n=t,h());}),c=e.getImage(i.transformRequest(i.normalizeSpriteURL(t,a,".png"),e.ResourceType.SpriteImage),(e,t)=>{c=null,s||(s=e,o=t,h());});function h(){if(s)r(s);else if(n&&o){const t=e.exported.getImageData(o),i={};for(const r in n){const{width:o,height:s,x:a,y:l,sdf:c,pixelRatio:h,stretchX:u,stretchY:d,content:p}=n[r],f=new e.RGBAImage({width:o,height:s});e.RGBAImage.copy(t,f,{x:a,y:l},{x:0,y:0},{width:o,height:s}),i[r]={data:f,pixelRatio:h,sdf:c,stretchX:u,stretchY:d,content:p};}r(null,i);}}return {cancel(){l&&(l.cancel(),l=null),c&&(c.cancel(),c=null);}};}(t,this.map._requestManager,(t,i)=>{if(this._spriteRequest=null,t)this.fire(new e.ErrorEvent(t));else if(i)for(const e in i)this.imageManager.addImage(e,i[e]);this.imageManager.setLoaded(!0),this._availableImages=this.imageManager.listImages(),this.dispatcher.broadcast("setImages",this._availableImages),this.dispatcher.broadcast("spriteLoaded",!0),this.fire(new e.Event("data",{dataType:"style"}));});}_validateLayer(t){const i=this.getSource(t.source);if(!i)return;const r=t.sourceLayer;r&&("geojson"===i.type||i.vectorLayerIds&&-1===i.vectorLayerIds.indexOf(r))&&this.fire(new e.ErrorEvent(new Error(`Source layer "${r}" does not exist on source "${i.id}" as specified by style layer "${t.id}"`)));}loaded(){if(!this._loaded)return !1;if(Object.keys(this._updatedSources).length)return !1;for(const e in this._sourceCaches)if(!this._sourceCaches[e].loaded())return !1;return !!this.imageManager.isLoaded();}_serializeLayers(e){const t=[];for(const i of e){const e=this._layers[i];"custom"!==e.type&&t.push(e.serialize());}return t;}hasTransitions(){if(this.light&&this.light.hasTransition())return !0;if(this.fog&&this.fog.hasTransition())return !0;for(const e in this._sourceCaches)if(this._sourceCaches[e].hasTransition())return !0;for(const e in this._layers)if(this._layers[e].hasTransition())return !0;return !1;}get order(){return this.map._optimizeForTerrain&&this.terrain?this._drapedFirstOrder:this._order;}isLayerDraped(e){return !!this.terrain&&Bt[e.type];}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading");}update(t){if(!this._loaded)return;const i=this._changed;if(this._changed){const e=Object.keys(this._updatedLayers),i=Object.keys(this._removedLayers);(e.length||i.length)&&this._updateWorkerLayers(e,i);for(const e in this._updatedSources){const t=this._updatedSources[e];"reload"===t?this._reloadSource(e):"clear"===t&&this._clearSource(e);}this._updateTilesForChangedImages();for(const e in this._updatedPaintProps)this._layers[e].updateTransitions(t);this.light.updateTransitions(t),this.fog&&this.fog.updateTransitions(t),this._resetUpdates();}const r={};for(const e in this._sourceCaches){const t=this._sourceCaches[e];r[e]=t.used,t.used=!1;}for(const e of this._order){const i=this._layers[e];if(i.recalculate(t,this._availableImages),!i.isHidden(t.zoom)){const e=this._getLayerSourceCache(i);e&&(e.used=!0);}const r=this.map.painter;if(r){const e=i.getProgramIds();if(!e)continue;const n=i.getProgramConfiguration(t.zoom);for(const t of e)r.useProgram(t,n);}}for(const t in r){const i=this._sourceCaches[t];r[t]!==i.used&&i.getSource().fire(new e.Event("data",{sourceDataType:"visibility",dataType:"source",sourceId:i.getSource().id}));}this.light.recalculate(t),this.terrain&&this.terrain.recalculate(t),this.fog&&this.fog.recalculate(t),this.z=t.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),i&&this.fire(new e.Event("data",{dataType:"style"}));}_updateTilesForChangedImages(){const e=Object.keys(this._changedImages);if(e.length){for(const t in this._sourceCaches)this._sourceCaches[t].reloadTilesForDependencies(["icons","patterns"],e);this._changedImages={};}}_updateWorkerLayers(e,t){this.dispatcher.broadcast("updateLayers",{layers:this._serializeLayers(e),removedIds:t});}_resetUpdates(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSources={},this._updatedPaintProps={},this._changedImages={};}setState(t){if(this._checkLoaded(),zt(this,e.validateStyle(t)))return !1;(t=e.clone$1(t)).layers=ke(t.layers);const i=function(e,t){if(!e)return [{command:ze.setStyle,args:[t]}];let i=[];try{if(!o(e.version,t.version))return [{command:ze.setStyle,args:[t]}];o(e.center,t.center)||i.push({command:ze.setCenter,args:[t.center]}),o(e.zoom,t.zoom)||i.push({command:ze.setZoom,args:[t.zoom]}),o(e.bearing,t.bearing)||i.push({command:ze.setBearing,args:[t.bearing]}),o(e.pitch,t.pitch)||i.push({command:ze.setPitch,args:[t.pitch]}),o(e.sprite,t.sprite)||i.push({command:ze.setSprite,args:[t.sprite]}),o(e.glyphs,t.glyphs)||i.push({command:ze.setGlyphs,args:[t.glyphs]}),o(e.transition,t.transition)||i.push({command:ze.setTransition,args:[t.transition]}),o(e.light,t.light)||i.push({command:ze.setLight,args:[t.light]}),o(e.fog,t.fog)||i.push({command:ze.setFog,args:[t.fog]}),o(e.projection,t.projection)||i.push({command:ze.setProjection,args:[t.projection]});const r={},n=[];!function(e,t,i,r){let n;for(n in t=t||{},e=e||{})e.hasOwnProperty(n)&&(t.hasOwnProperty(n)||Oe(n,i,r));for(n in t)t.hasOwnProperty(n)&&(e.hasOwnProperty(n)?o(e[n],t[n])||("geojson"===e[n].type&&"geojson"===t[n].type&&Be(e,t,n)?i.push({command:ze.setGeoJSONSourceData,args:[n,t[n].data]}):Fe(n,t,i,r)):Re(n,t,i));}(e.sources,t.sources,n,r);const s=[];e.layers&&e.layers.forEach(e=>{r[e.source]?i.push({command:ze.removeLayer,args:[e.id]}):s.push(e);});let a=e.terrain;a&&r[a.source]&&(i.push({command:ze.setTerrain,args:[void 0]}),a=void 0),i=i.concat(n),o(a,t.terrain)||i.push({command:ze.setTerrain,args:[t.terrain]}),function(e,t,i){t=t||[];const r=(e=e||[]).map(Ve),n=t.map(Ve),s=e.reduce(Ge,{}),a=t.reduce(Ge,{}),l=r.slice(),c=Object.create(null);let h,u,d,p,f,m,_;for(h=0,u=0;h<r.length;h++)d=r[h],a.hasOwnProperty(d)?u++:(i.push({command:ze.removeLayer,args:[d]}),l.splice(l.indexOf(d,u),1));for(h=0,u=0;h<n.length;h++)d=n[n.length-1-h],l[l.length-1-h]!==d&&(s.hasOwnProperty(d)?(i.push({command:ze.removeLayer,args:[d]}),l.splice(l.lastIndexOf(d,l.length-u),1)):u++,m=l[l.length-h],i.push({command:ze.addLayer,args:[a[d],m]}),l.splice(l.length-h,0,d),c[d]=!0);for(h=0;h<n.length;h++)if(d=n[h],p=s[d],f=a[d],!c[d]&&!o(p,f))if(o(p.source,f.source)&&o(p["source-layer"],f["source-layer"])&&o(p.type,f.type)){for(_ in Ue(p.layout,f.layout,i,d,null,ze.setLayoutProperty),Ue(p.paint,f.paint,i,d,null,ze.setPaintProperty),o(p.filter,f.filter)||i.push({command:ze.setFilter,args:[d,f.filter]}),o(p.minzoom,f.minzoom)&&o(p.maxzoom,f.maxzoom)||i.push({command:ze.setLayerZoomRange,args:[d,f.minzoom,f.maxzoom]}),p)p.hasOwnProperty(_)&&"layout"!==_&&"paint"!==_&&"filter"!==_&&"metadata"!==_&&"minzoom"!==_&&"maxzoom"!==_&&(0===_.indexOf("paint.")?Ue(p[_],f[_],i,d,_.slice(6),ze.setPaintProperty):o(p[_],f[_])||i.push({command:ze.setLayerProperty,args:[d,_,f[_]]}));for(_ in f)f.hasOwnProperty(_)&&!p.hasOwnProperty(_)&&"layout"!==_&&"paint"!==_&&"filter"!==_&&"metadata"!==_&&"minzoom"!==_&&"maxzoom"!==_&&(0===_.indexOf("paint.")?Ue(p[_],f[_],i,d,_.slice(6),ze.setPaintProperty):o(p[_],f[_])||i.push({command:ze.setLayerProperty,args:[d,_,f[_]]}));}else i.push({command:ze.removeLayer,args:[d]}),m=l[l.lastIndexOf(d)+1],i.push({command:ze.addLayer,args:[f,m]});}(s,t.layers,i);}catch(e){console.warn("Unable to compute style diff:",e),i=[{command:ze.setStyle,args:[t]}];}return i;}(this.serialize(),t).filter(e=>!(e.command in Ot));if(0===i.length)return !1;const r=i.filter(e=>!(e.command in Rt));if(r.length>0)throw new Error(`Unimplemented: ${r.map(e=>e.command).join(", ")}.`);return i.forEach(e=>{"setTransition"!==e.command&&this[e.command].apply(this,e.args);}),this.stylesheet=t,this.updateProjection(),!0;}addImage(t,i){if(this.getImage(t))return this.fire(new e.ErrorEvent(new Error("An image with this name already exists.")));this.imageManager.addImage(t,i),this._afterImageUpdated(t);}updateImage(e,t){this.imageManager.updateImage(e,t);}getImage(e){return this.imageManager.getImage(e);}removeImage(t){if(!this.getImage(t))return this.fire(new e.ErrorEvent(new Error("No image with this name exists.")));this.imageManager.removeImage(t),this._afterImageUpdated(t);}_afterImageUpdated(t){this._availableImages=this.imageManager.listImages(),this._changedImages[t]=!0,this._changed=!0,this.dispatcher.broadcast("setImages",this._availableImages),this.fire(new e.Event("data",{dataType:"style"}));}listImages(){return this._checkLoaded(),this._availableImages.slice();}addSource(t,i,r={}){if(this._checkLoaded(),void 0!==this.getSource(t))throw new Error("There is already a source with this ID");if(!i.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(i).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(i.type)>=0&&this._validate(e.validateStyle.source,`sources.${t}`,i,null,r))return;this.map&&this.map._collectResourceTiming&&(i.collectResourceTiming=!0);const n=we(t,i,this.dispatcher,this);n.setEventedParent(this,()=>({isSourceLoaded:this.loaded(),source:n.serialize(),sourceId:t}));const o=i=>{const r=(i?"symbol:":"other:")+t,o=this._sourceCaches[r]=new e.SourceCache(r,n,i);(i?this._symbolSourceCaches:this._otherSourceCaches)[t]=o,o.style=this,o.onAdd(this.map);};o(!1),"vector"!==i.type&&"geojson"!==i.type||o(!0),n.onAdd&&n.onAdd(this.map),this._changed=!0;}removeSource(t){this._checkLoaded();const i=this.getSource(t);if(void 0===i)throw new Error("There is no source with this ID");for(const i in this._layers)if(this._layers[i].source===t)return this.fire(new e.ErrorEvent(new Error(`Source "${t}" cannot be removed while layer "${i}" is using it.`)));if(this.terrain&&this.terrain.get().source===t)return this.fire(new e.ErrorEvent(new Error(`Source "${t}" cannot be removed while terrain is using it.`)));const r=this._getSourceCaches(t);for(const t of r)delete this._sourceCaches[t.id],delete this._updatedSources[t.id],t.fire(new e.Event("data",{sourceDataType:"metadata",dataType:"source",sourceId:t.getSource().id})),t.setEventedParent(null),t.clearTiles();delete this._otherSourceCaches[t],delete this._symbolSourceCaches[t],i.setEventedParent(null),i.onRemove&&i.onRemove(this.map),this._changed=!0;}setGeoJSONSourceData(e,t){this._checkLoaded(),this.getSource(e).setData(t),this._changed=!0;}getSource(e){const t=this._getSourceCache(e);return t&&t.getSource();}addLayer(t,i,r={}){this._checkLoaded();const n=t.id;if(this.getLayer(n))return void this.fire(new e.ErrorEvent(new Error(`Layer with id "${n}" already exists on this map`)));let o;if("custom"===t.type){if(zt(this,e.validateCustomStyleLayer(t)))return;o=e.createStyleLayer(t);}else {if("object"==typeof t.source&&(this.addSource(n,t.source),t=e.clone$1(t),t=e.extend(t,{source:n})),this._validate(e.validateStyle.layer,`layers.${n}`,t,{arrayIndex:-1},r))return;o=e.createStyleLayer(t),this._validateLayer(o),o.setEventedParent(this,{layer:{id:n}}),this._serializedLayers[o.id]=o.serialize(),this._updateLayerCount(o,!0);}const s=i?this._order.indexOf(i):this._order.length;if(i&&-1===s)return void this.fire(new e.ErrorEvent(new Error(`Layer with id "${i}" does not exist on this map.`)));this._order.splice(s,0,n),this._layerOrderChanged=!0,this._layers[n]=o;const a=this._getLayerSourceCache(o);if(this._removedLayers[n]&&o.source&&a&&"custom"!==o.type){const e=this._removedLayers[n];delete this._removedLayers[n],e.type!==o.type?this._updatedSources[o.source]="clear":(this._updatedSources[o.source]="reload",a.pause());}this._updateLayer(o),o.onAdd&&o.onAdd(this.map),this._updateDrapeFirstLayers();}moveLayer(t,i){if(this._checkLoaded(),this._changed=!0,!this._layers[t])return void this.fire(new e.ErrorEvent(new Error(`The layer '${t}' does not exist in the map's style and cannot be moved.`)));if(t===i)return;const r=this._order.indexOf(t);this._order.splice(r,1);const n=i?this._order.indexOf(i):this._order.length;i&&-1===n?this.fire(new e.ErrorEvent(new Error(`Layer with id "${i}" does not exist on this map.`))):(this._order.splice(n,0,t),this._layerOrderChanged=!0,this._updateDrapeFirstLayers());}removeLayer(t){this._checkLoaded();const i=this._layers[t];if(!i)return void this.fire(new e.ErrorEvent(new Error(`The layer '${t}' does not exist in the map's style and cannot be removed.`)));i.setEventedParent(null),this._updateLayerCount(i,!1);const r=this._order.indexOf(t);this._order.splice(r,1),this._layerOrderChanged=!0,this._changed=!0,this._removedLayers[t]=i,delete this._layers[t],delete this._serializedLayers[t],delete this._updatedLayers[t],delete this._updatedPaintProps[t],i.onRemove&&i.onRemove(this.map),this._updateDrapeFirstLayers();}getLayer(e){return this._layers[e];}hasLayer(e){return e in this._layers;}hasLayerType(e){for(const t in this._layers)if(this._layers[t].type===e)return !0;return !1;}setLayerZoomRange(t,i,r){this._checkLoaded();const n=this.getLayer(t);n?n.minzoom===i&&n.maxzoom===r||(null!=i&&(n.minzoom=i),null!=r&&(n.maxzoom=r),this._updateLayer(n)):this.fire(new e.ErrorEvent(new Error(`The layer '${t}' does not exist in the map's style and cannot have zoom extent.`)));}setFilter(t,i,r={}){this._checkLoaded();const n=this.getLayer(t);if(n){if(!o(n.filter,i))return null==i?(n.filter=void 0,void this._updateLayer(n)):void(this._validate(e.validateStyle.filter,`layers.${n.id}.filter`,i,{layerType:n.type},r)||(n.filter=e.clone$1(i),this._updateLayer(n)));}else this.fire(new e.ErrorEvent(new Error(`The layer '${t}' does not exist in the map's style and cannot be filtered.`)));}getFilter(t){return e.clone$1(this.getLayer(t).filter);}setLayoutProperty(t,i,r,n={}){this._checkLoaded();const s=this.getLayer(t);s?o(s.getLayoutProperty(i),r)||(s.setLayoutProperty(i,r,n),this._updateLayer(s)):this.fire(new e.ErrorEvent(new Error(`The layer '${t}' does not exist in the map's style and cannot be styled.`)));}getLayoutProperty(t,i){const r=this.getLayer(t);if(r)return r.getLayoutProperty(i);this.fire(new e.ErrorEvent(new Error(`The layer '${t}' does not exist in the map's style.`)));}setPaintProperty(t,i,r,n={}){this._checkLoaded();const s=this.getLayer(t);s?o(s.getPaintProperty(i),r)||(s.setPaintProperty(i,r,n)&&this._updateLayer(s),this._changed=!0,this._updatedPaintProps[t]=!0):this.fire(new e.ErrorEvent(new Error(`The layer '${t}' does not exist in the map's style and cannot be styled.`)));}getPaintProperty(e,t){return this.getLayer(e).getPaintProperty(t);}setFeatureState(t,i){this._checkLoaded();const r=t.source,n=t.sourceLayer,o=this.getSource(r);if(void 0===o)return void this.fire(new e.ErrorEvent(new Error(`The source '${r}' does not exist in the map's style.`)));const s=o.type;if("geojson"===s&&n)return void this.fire(new e.ErrorEvent(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if("vector"===s&&!n)return void this.fire(new e.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")));void 0===t.id&&this.fire(new e.ErrorEvent(new Error("The feature id parameter must be provided.")));const a=this._getSourceCaches(r);for(const e of a)e.setFeatureState(n,t.id,i);}removeFeatureState(t,i){this._checkLoaded();const r=t.source,n=this.getSource(r);if(void 0===n)return void this.fire(new e.ErrorEvent(new Error(`The source '${r}' does not exist in the map's style.`)));const o=n.type,s="vector"===o?t.sourceLayer:void 0;if("vector"===o&&!s)return void this.fire(new e.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")));if(i&&"string"!=typeof t.id&&"number"!=typeof t.id)return void this.fire(new e.ErrorEvent(new Error("A feature id is required to remove its specific state property.")));const a=this._getSourceCaches(r);for(const e of a)e.removeFeatureState(s,t.id,i);}getFeatureState(t){this._checkLoaded();const i=t.source,r=t.sourceLayer,n=this.getSource(i);if(void 0!==n){if("vector"!==n.type||r)return void 0===t.id&&this.fire(new e.ErrorEvent(new Error("The feature id parameter must be provided."))),this._getSourceCaches(i)[0].getFeatureState(r,t.id);this.fire(new e.ErrorEvent(new Error("The sourceLayer parameter must be provided for vector source types.")));}else this.fire(new e.ErrorEvent(new Error(`The source '${i}' does not exist in the map's style.`)));}getTransition(){return e.extend({duration:300,delay:0},this.stylesheet&&this.stylesheet.transition);}serialize(){const t={};for(const e in this._sourceCaches){const i=this._sourceCaches[e].getSource();t[i.id]||(t[i.id]=i.serialize());}return e.filterObject({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,light:this.stylesheet.light,terrain:this.stylesheet.terrain,fog:this.stylesheet.fog,center:this.stylesheet.center,zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:t,layers:this._serializeLayers(this._order)},e=>void 0!==e);}_updateLayer(e){this._updatedLayers[e.id]=!0;const t=this._getLayerSourceCache(e);e.source&&!this._updatedSources[e.source]&&t&&"raster"!==t.getSource().type&&(this._updatedSources[e.source]="reload",t.pause()),this._changed=!0,e.invalidateCompiledFilter();}_flattenAndSortRenderedFeatures(e){const t=e=>"fill-extrusion"===this._layers[e].type,i={},r=[];for(let n=this._order.length-1;n>=0;n--){const o=this._order[n];if(t(o)){i[o]=n;for(const t of e){const e=t[o];if(e)for(const t of e)r.push(t);}}}r.sort((e,t)=>t.intersectionZ-e.intersectionZ);const n=[];for(let o=this._order.length-1;o>=0;o--){const s=this._order[o];if(t(s))for(let e=r.length-1;e>=0;e--){const t=r[e].feature;if(i[t.layer.id]<o)break;n.push(t),r.pop();}else for(const t of e){const e=t[s];if(e)for(const t of e)n.push(t.feature);}}return n;}queryRenderedFeatures(t,i,r){i&&i.filter&&this._validate(e.validateStyle.filter,"queryRenderedFeatures.filter",i.filter,null,i);const n={};if(i&&i.layers){if(!Array.isArray(i.layers))return this.fire(new e.ErrorEvent(new Error("parameters.layers must be an Array."))),[];for(const t of i.layers){const i=this._layers[t];if(!i)return this.fire(new e.ErrorEvent(new Error(`The layer '${t}' does not exist in the map's style and cannot be queried for features.`))),[];n[i.source]=!0;}}const o=[];i.availableImages=this._availableImages;const s=i&&i.layers?i.layers.some(e=>{const t=this.getLayer(e);return t&&t.is3D();}):this.has3DLayers(),a=fe.createFromScreenPoints(t,r);for(const e in this._sourceCaches){const t=this._sourceCaches[e].getSource().id;i.layers&&!n[t]||o.push(Ee(this._sourceCaches[e],this._layers,this._serializedLayers,a,i,r,s,!!this.map._showQueryGeometry));}return this.placement&&o.push(function(e,t,i,r,n,o,s){const a={},l=o.queryRenderedSymbols(r),c=[];for(const e of Object.keys(l).map(Number))c.push(s[e]);c.sort(Ie);for(const i of c){const r=i.featureIndex.lookupSymbolFeatures(l[i.bucketInstanceId],t,i.bucketIndex,i.sourceLayerIndex,n.filter,n.layers,n.availableImages,e);for(const e in r){const t=a[e]=a[e]||[],n=r[e];n.sort((e,t)=>{const r=i.featureSortOrder;if(r){const i=r.indexOf(e.featureIndex);return r.indexOf(t.featureIndex)-i;}return t.featureIndex-e.featureIndex;});for(const e of n)t.push(e);}}for(const t in a)a[t].forEach(r=>{const n=r.feature,o=i(e[t]).getFeatureState(n.layer["source-layer"],n.id);n.source=n.layer.source,n.layer["source-layer"]&&(n.sourceLayer=n.layer["source-layer"]),n.state=o;});return a;}(this._layers,this._serializedLayers,this._getLayerSourceCache.bind(this),a.screenGeometry,i,this.placement.collisionIndex,this.placement.retainedQueryData)),this._flattenAndSortRenderedFeatures(o);}querySourceFeatures(t,i){i&&i.filter&&this._validate(e.validateStyle.filter,"querySourceFeatures.filter",i.filter,null,i);const r=this._getSourceCaches(t);let n=[];for(const e of r)n=n.concat(Ne(e,i));return n;}addSourceType(e,t,i){return Ut.getSourceType(e)?i(new Error(`A source type called "${e}" already exists.`)):(Ut.setSourceType(e,t),t.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:e,url:t.workerSourceURL},i):i(null,null));}getLight(){return this.light.getLight();}setLight(t,i={}){this._checkLoaded();const r=this.light.getLight();let n=!1;for(const e in t)if(!o(t[e],r[e])){n=!0;break;}if(!n)return;const s={now:e.exported.now(),transition:e.extend({duration:300,delay:0},this.stylesheet.transition)};this.light.setLight(t,i),this.light.updateTransitions(s);}getTerrain(){return this.terrain&&1===this.terrain.drapeRenderMode?this.terrain.get():null;}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0);}setTerrain(t,i=1){if(this._checkLoaded(),!t)return delete this.terrain,delete this.stylesheet.terrain,this.dispatcher.broadcast("enableTerrain",!1),this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);if(1===i){if("object"==typeof t.source){const i="terrain-dem-src";this.addSource(i,t.source),t=e.clone$1(t),t=e.extend(t,{source:i});}if(this._validate(e.validateStyle.terrain,"terrain",t))return;}if(!this.terrain||this.terrain&&i!==this.terrain.drapeRenderMode)this._createTerrain(t,i);else {const i=this.terrain,r=i.get();for(const n in t)if(!o(t[n],r[n])){i.set(t),this.stylesheet.terrain=t;const r={now:e.exported.now(),transition:e.extend({duration:0},this.stylesheet.transition)};i.updateTransitions(r);break;}}this._updateDrapeFirstLayers(),this._markersNeedUpdate=!0;}_createFog(t){const i=this.fog=new T(t,this.map.transform);this.stylesheet.fog=t;const r={now:e.exported.now(),transition:e.extend({duration:0},this.stylesheet.transition)};i.updateTransitions(r);}_updateMarkersOpacity(){0!==this.map._markers.length&&this.map._requestDomTask(()=>{for(const e of this.map._markers)e._evaluateOpacity();});}getFog(){return this.fog?this.fog.get():null;}setFog(t){if(this._checkLoaded(),!t)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const i=this.fog,r=i.get();for(const n in t)if(!o(t[n],r[n])){i.set(t),this.stylesheet.fog=t;const r={now:e.exported.now(),transition:e.extend({duration:0},this.stylesheet.transition)};i.updateTransitions(r);break;}}else this._createFog(t);this._markersNeedUpdate=!0;}_updateDrapeFirstLayers(){if(!this.map._optimizeForTerrain||!this.terrain)return;const e=this._order.filter(e=>this.isLayerDraped(this._layers[e])),t=this._order.filter(e=>!this.isLayerDraped(this._layers[e]));this._drapedFirstOrder=[],this._drapedFirstOrder.push(...e),this._drapedFirstOrder.push(...t);}_createTerrain(t,i){const r=this.terrain=new x(t,i);this.stylesheet.terrain=t,this.dispatcher.broadcast("enableTerrain",!0),this._force3DLayerUpdate();const n={now:e.exported.now(),transition:e.extend({duration:0},this.stylesheet.transition)};r.updateTransitions(n);}_force3DLayerUpdate(){for(const e in this._layers){const t=this._layers[e];"fill-extrusion"===t.type&&this._updateLayer(t);}}_forceSymbolLayerUpdate(){for(const e in this._layers){const t=this._layers[e];"symbol"===t.type&&this._updateLayer(t);}}_validate(t,i,r,n,o={}){return (!o||!1!==o.validate)&&zt(this,t.call(e.validateStyle,e.extend({key:i,style:this.serialize(),value:r,styleSpec:e.spec},n)));}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),e.evented.off("pluginStateChange",this._rtlTextPluginCallback);for(const e in this._layers)this._layers[e].setEventedParent(null);for(const e in this._sourceCaches)this._sourceCaches[e].clearTiles(),this._sourceCaches[e].setEventedParent(null);this.imageManager.setEventedParent(null),this.setEventedParent(null),this.dispatcher.remove();}_clearSource(e){const t=this._getSourceCaches(e);for(const e of t)e.clearTiles();}_reloadSource(e){const t=this._getSourceCaches(e);for(const e of t)e.resume(),e.reload();}_updateSources(e){for(const t in this._sourceCaches)this._sourceCaches[t].update(e);}_generateCollisionBoxes(){for(const e in this._sourceCaches){const t=this._sourceCaches[e];t.resume(),t.reload();}}_updatePlacement(t,i,r,n,o=!1){let s=!1,a=!1;const l={};for(const e of this._order){const i=this._layers[e];if("symbol"!==i.type)continue;if(!l[i.source]){const e=this._getLayerSourceCache(i);if(!e)continue;l[i.source]=e.getRenderableIds(!0).map(t=>e.getTileByID(t)).sort((e,t)=>t.tileID.overscaledZ-e.tileID.overscaledZ||(e.tileID.isLessThan(t.tileID)?-1:1));}const r=this.crossTileSymbolIndex.addLayer(i,l[i.source],t.center.lng,t.projection);s=s||r;}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._order),o=o||this._layerOrderChanged||0===r,this._layerOrderChanged&&this.fire(new e.Event("neworder")),(o||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(e.exported.now(),t.zoom))&&(this.pauseablePlacement=new Ct(t,this._order,o,i,r,n,this.placement,this.fog&&t.projection.supportsFog?this.fog.state:null),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._order,this._layers,l),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(e.exported.now()),a=!0),s&&this.pauseablePlacement.placement.setStale()),a||s)for(const e of this._order){const t=this._layers[e];"symbol"===t.type&&this.placement.updateLayerOpacities(t,l[t.source]);}return !this.pauseablePlacement.isDone()||this.placement.hasTransitions(e.exported.now());}_releaseSymbolFadeTiles(){for(const e in this._sourceCaches)this._sourceCaches[e].releaseSymbolFadeTiles();}getImages(e,t,i){this.imageManager.getImages(t.icons,i),this._updateTilesForChangedImages();const r=e=>{e&&e.setDependencies(t.tileID.key,t.type,t.icons);};r(this._otherSourceCaches[t.source]),r(this._symbolSourceCaches[t.source]);}getGlyphs(e,t,i){this.glyphManager.getGlyphs(t.stacks,i);}getResource(t,i,r){return e.makeRequest(i,r);}_getSourceCache(e){return this._otherSourceCaches[e];}_getLayerSourceCache(e){return "symbol"===e.type?this._symbolSourceCaches[e.source]:this._otherSourceCaches[e.source];}_getSourceCaches(e){const t=[];return this._otherSourceCaches[e]&&t.push(this._otherSourceCaches[e]),this._symbolSourceCaches[e]&&t.push(this._symbolSourceCaches[e]),t;}has3DLayers(){return this._num3DLayers>0;}hasSymbolLayers(){return this._numSymbolLayers>0;}hasCircleLayers(){return this._numCircleLayers>0;}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches");}destroy(){this._clearWorkerCaches(),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain);}}Ut.getSourceType=function(e){return Se[e];},Ut.setSourceType=function(e,t){Se[e]=t;},Ut.registerForPluginStateChange=e.registerForPluginStateChange;var Vt="\n#define EPSILON 0.0000001\n#define PI 3.141592653589793\n#define EXTENT 8192.0\n#ifdef FOG\nuniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;varying vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}\n#endif",Gt="attribute highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;varying highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}";let jt={},$t={};jt=Xt("","\n#define ELEVATION_SCALE 7.0\n#define ELEVATION_OFFSET 450.0\n#ifdef PROJECTION_GLOBE_VIEW\nuniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(\nmix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}\n#else\nvec3 elevationVector(vec2 pos) { return vec3(0,0,1); }\n#endif\n#ifdef TERRAIN\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nuniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;\n#else\nuniform sampler2D u_dem;uniform sampler2D u_dem_prev;\n#endif\nuniform vec4 u_dem_unpack;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;uniform sampler2D u_depth;uniform vec2 u_depth_size_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float decodeElevation(vec4 v) {return dot(vec4(v.xyz*255.0,-1.0),u_dem_unpack);}float currentElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture2D(u_dem,pos).a;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=decodeElevation(texture2D(u_dem,pos));\n#ifdef TERRAIN_DEM_NEAREST_FILTER\nreturn u_exaggeration*tl;\n#endif\nfloat tr=decodeElevation(texture2D(u_dem,pos+vec2(dd,0.0)));float bl=decodeElevation(texture2D(u_dem,pos+vec2(0.0,dd)));float br=decodeElevation(texture2D(u_dem,pos+vec2(dd,dd)));return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}float prevElevation(vec2 apos) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nvec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture2D(u_dem_prev,pos).a;\n#else\nfloat dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=decodeElevation(texture2D(u_dem_prev,pos));float tr=decodeElevation(texture2D(u_dem_prev,pos+vec2(dd,0.0)));float bl=decodeElevation(texture2D(u_dem_prev,pos+vec2(0.0,dd)));float br=decodeElevation(texture2D(u_dem_prev,pos+vec2(dd,dd)));return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);\n#endif\n}\n#ifdef TERRAIN_VERTEX_MORPHING\nfloat elevation(vec2 apos) {float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}\n#else\nfloat elevation(vec2 apos) {return currentElevation(apos);}\n#endif\nfloat unpack_depth(vec4 rgba_depth)\n{const vec4 bit_shift=vec4(1.0/(256.0*256.0*256.0),1.0/(256.0*256.0),1.0/256.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;float depth=unpack_depth(texture2D(u_depth,(coord.xy+1.0)*0.5));return coord.z > depth+0.0005;}float occlusionFade(vec4 frag) {vec3 coord=frag.xyz/frag.w;vec3 df=vec3(5.0*u_depth_size_inv,0.0);vec2 uv=0.5*coord.xy+0.5;vec4 depth=vec4(\nunpack_depth(texture2D(u_depth,uv-df.xz)),unpack_depth(texture2D(u_depth,uv+df.xz)),unpack_depth(texture2D(u_depth,uv-df.zy)),unpack_depth(texture2D(u_depth,uv+df.zy))\n);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z-0.001)-depth),0.0,1.0));}vec4 fourSample(vec2 pos,vec2 off) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nfloat tl=texture2D(u_dem,pos).a;float tr=texture2D(u_dem,pos+vec2(off.x,0.0)).a;float bl=texture2D(u_dem,pos+vec2(0.0,off.y)).a;float br=texture2D(u_dem,pos+off).a;\n#else\nvec4 demtl=vec4(texture2D(u_dem,pos).xyz*255.0,-1.0);float tl=dot(demtl,u_dem_unpack);vec4 demtr=vec4(texture2D(u_dem,pos+vec2(off.x,0.0)).xyz*255.0,-1.0);float tr=dot(demtr,u_dem_unpack);vec4 dembl=vec4(texture2D(u_dem,pos+vec2(0.0,off.y)).xyz*255.0,-1.0);float bl=dot(dembl,u_dem_unpack);vec4 dembr=vec4(texture2D(u_dem,pos+off).xyz*255.0,-1.0);float br=dot(dembr,u_dem_unpack);\n#endif\nreturn vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;vec4 bounds=vec4(d,vec2(1.0)-d);h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}\n#else\nfloat elevation(vec2 pos) { return 0.0; }bool isOccluded(vec4 frag) { return false; }float occlusionFade(vec4 frag) { return 1.0; }\n#endif",!0),$t=Xt("#ifdef FOG\nuniform float u_fog_temporal_offset;float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);return mix(color,u_fog_color.rgb,opacity);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec3 fog_dither(vec3 color) {vec2 dither_seed=gl_FragCoord.xy+u_fog_temporal_offset;return dither(color,dither_seed);}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}\n#endif","#ifdef FOG\nuniform mat4 u_fog_matrix;vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}\n#endif",!0);const Ht=Xt("\nhighp vec3 hash(highp vec2 p) {highp vec3 p3=fract(p.xyx*vec3(443.8975,397.2973,491.1871));p3+=dot(p3,p3.yxz+19.19);return fract((p3.xxy+p3.yzz)*p3.zyx);}vec3 dither(vec3 color,highp vec2 seed) {vec3 rnd=hash(seed)+hash(seed+0.59374)-0.5;return color+rnd/255.0;}\n#ifdef TERRAIN\nhighp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(256.0*256.0*256.0,256.0*256.0,256.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/256.0,1.0/256.0,1.0/256.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}\n#endif","\nfloat wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {\n#if defined(PROJECTION_GLOBE_VIEW) && !defined(PROJECTED_POS_ON_VIEWPORT)\nfloat tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;\n#else\nreturn vec3(0.0);\n#endif\n}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {\n#if defined(PROJECTION_GLOBE_VIEW) && !defined(PROJECTED_POS_ON_VIEWPORT)\nreturn mix(globe,mercator,t);\n#else\nreturn globe;\n#endif\n}\n#ifdef PROJECTION_GLOBE_VIEW\nmat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}\n#endif\nvec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(\nunpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0\n);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (tile_units_to_pixels*pos+offset)/pattern_size;}const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);//Normalized device coordinate that is not rendered."),qt=Vt;var Zt={background:Xt("uniform vec4 u_color;uniform float u_opacity;void main() {vec4 out_color=u_color;\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}"),backgroundPattern:Xt("uniform vec2 u_pattern_tl_a;uniform vec2 u_pattern_br_a;uniform vec2 u_pattern_tl_b;uniform vec2 u_pattern_br_b;uniform vec2 u_texsize;uniform float u_mix;uniform float u_opacity;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(u_pattern_tl_a/u_texsize,u_pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(u_pattern_tl_b/u_texsize,u_pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 out_color=mix(color1,color2,u_mix);\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_pattern_size_a;uniform vec2 u_pattern_size_b;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_scale_a;uniform float u_scale_b;uniform float u_tile_units_to_pixels;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_a*u_pattern_size_a,u_tile_units_to_pixels,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_scale_b*u_pattern_size_b,u_tile_units_to_pixels,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}"),circle:Xt("varying vec3 v_data;varying float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=v_data.xy;float extrude_length=length(extrude);lowp float antialiasblur=v_data.z;float antialiased_blur=-max(blur,antialiasblur);float opacity_t=smoothstep(0.0,antialiased_blur,extrude_length-1.0);float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(\nantialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)\n);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);\n#ifdef FOG\nout_color=fog_apply_premultiplied(out_color,v_fog_pos);\n#endif\ngl_FragColor=out_color*(v_visibility*opacity_t);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","#define NUM_VISIBILITY_RINGS 2\n#define INV_SQRT2 0.70710678\n#define ELEVATION_BIAS 0.0001\n#define NUM_SAMPLES_PER_RING 16\nuniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;attribute vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;attribute float a_scale;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nvarying vec3 v_data;varying float v_visibility;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define mediump float radius\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define highp vec4 stroke_color\n#pragma mapbox: define mediump float stroke_width\n#pragma mapbox: define lowp float stroke_opacity\nvec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {\n#if defined(TERRAIN)\nreturn elevation(pos)+ELEVATION_BIAS;\n#else\nreturn 0.0;\n#endif\n}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);\n#ifdef PITCH_WITH_MAP\n#ifdef PROJECTION_GLOBE_VIEW\nreturn u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );\n#else\nreturn u_matrix*( world_center+vec4(sample_offset,0,0) );\n#endif\n#else\nreturn projected_center+vec4(sample_offset,0,0);\n#endif\n}float get_sample_step() {\n#ifdef PITCH_WITH_MAP\nreturn 2.0*PI/float(NUM_SAMPLES_PER_RING);\n#else\nreturn PI/float(NUM_SAMPLES_PER_RING);\n#endif\n}void main(void) {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize mediump float radius\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize highp vec4 stroke_color\n#pragma mapbox: initialize mediump float stroke_width\n#pragma mapbox: initialize lowp float stroke_opacity\nvec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);\n#ifdef PROJECTION_GLOBE_VIEW\nvec2 scaled_extrude=extrude*a_scale;vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=scaled_extrude.x*surface_vectors[0]+scaled_extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);vec4 world_center=vec4(pos,1);\n#else \nmat3 surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);vec4 world_center=vec4(circle_center,height,1);\n#endif\nvec4 projected_center=u_matrix*world_center;float view_scale=0.0;\n#ifdef PITCH_WITH_MAP\n#ifdef SCALE_WITH_MAP\nview_scale=1.0;\n#else\nview_scale=projected_center.w/u_camera_to_center_distance;\n#endif\n#else\n#ifdef SCALE_WITH_MAP\nview_scale=u_camera_to_center_distance;\n#else\nview_scale=projected_center.w;\n#endif\n#endif\n#if defined(SCALE_WITH_MAP) && defined(PROJECTION_GLOBE_VIEW)\nview_scale*=a_scale;\n#endif\ngl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;\n#ifdef TERRAIN\nfloat step=get_sample_step();\n#ifdef PITCH_WITH_MAP\nfloat cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);vec4 occlusion_world_center=vec4(circle_center,cantilevered_height,1);vec4 occlusion_projected_center=u_matrix*occlusion_world_center;\n#else\nvec4 occlusion_world_center=world_center;vec4 occlusion_projected_center=projected_center;\n#endif\nfor(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);\n#else\nvisibility=1.0;\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nvisibility=1.0;\n#endif\nv_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);\n#ifdef FOG\nv_fog_pos=fog_position(world_center.xyz);\n#endif\n}"),clippingMask:Xt("void main() {gl_FragColor=vec4(1.0);}","attribute vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:Xt("uniform highp float u_intensity;varying vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#define GAUSS_COEF 0.3989422804014327\nvoid main() {\n#pragma mapbox: initialize highp float weight\nfloat d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);gl_FragColor=vec4(val,1.0,1.0,1.0);\n#ifdef FOG\ngl_FragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);\n#endif\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;attribute vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;attribute float a_scale;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;\n#endif\nvarying vec2 v_extrude;\n#pragma mapbox: define highp float weight\n#pragma mapbox: define mediump float radius\nconst highp float ZERO=1.0/255.0/16.0;\n#define GAUSS_COEF 0.3989422804014327\nvoid main(void) {\n#pragma mapbox: initialize highp float weight\n#pragma mapbox: initialize mediump float radius\nvec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);\n#ifdef PROJECTION_GLOBE_VIEW\nextrude*=a_scale;vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#else\nvec3 pos=vec3(tilePos+extrude,elevation(tilePos));\n#endif\ngl_Position=u_matrix*vec4(pos,1);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}"),heatmapTexture:Xt("uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;varying vec2 v_pos;void main() {float t=texture2D(u_image,v_pos).r;vec4 color=texture2D(u_color_ramp,vec2(t,0.5));gl_FragColor=color*u_opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(0.0);\n#endif\n}","attribute vec2 a_pos;varying vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:Xt("varying float v_placed;varying float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);gl_FragColor =mix(red,blue,step(0.5,v_placed))*0.5;gl_FragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}","attribute vec3 a_pos;attribute vec2 a_anchor_pos;attribute vec2 a_extrude;attribute vec2 a_placed;attribute vec2 a_shift;attribute float a_size_scale;attribute vec2 a_padding;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;varying float v_placed;varying float v_notUsed;void main() {vec4 projectedPoint=u_matrix*vec4(a_pos+elevationVector(a_anchor_pos)*elevation(a_anchor_pos),1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}"),collisionCircle:Xt("varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);gl_FragColor=color*alpha*opacity_t;}","attribute vec2 a_pos_2f;attribute float a_radius;attribute vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;varying float v_radius;varying vec2 v_extrude;varying float v_perspective_ratio;varying float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(\nmix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(\n0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}"),debug:Xt("uniform highp vec4 u_color;uniform sampler2D u_overlay;varying vec2 v_uv;void main() {vec4 overlay_color=texture2D(u_overlay,v_uv);gl_FragColor=mix(u_color,overlay_color,overlay_color.a);}","attribute vec2 a_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_pos_3;\n#endif\nvarying vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;\n#ifdef PROJECTION_GLOBE_VIEW\ngl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);\n#else\ngl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);\n#endif\n}"),fill:Xt("#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\nvec4 out_color=color;\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","attribute vec2 a_pos;uniform mat4 u_matrix;\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,0,1);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}"),fillOutline:Xt("varying vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","attribute vec2 a_pos;uniform mat4 u_matrix;uniform vec2 u_world;varying vec2 v_pos;\n#pragma mapbox: define highp vec4 outline_color\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 outline_color\n#pragma mapbox: initialize lowp float opacity\ngl_Position=u_matrix*vec4(a_pos,0,1);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}"),fillOutlinePattern:Xt("uniform vec2 u_texsize;uniform sampler2D u_image;uniform float u_fade;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=mix(color1,color2,u_fade);\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec2 v_pos;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;gl_Position=u_matrix*vec4(a_pos,0,1);vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,a_pos);v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}"),fillPattern:Xt("uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 out_color=mix(color1,color2,u_fade);\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color*opacity;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec3 u_scale;attribute vec2 a_pos;varying vec2 v_pos_a;varying vec2 v_pos_b;\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;gl_Position=u_matrix*vec4(a_pos,0,1);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileZoomRatio,a_pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileZoomRatio,a_pos);\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}"),fillExtrusion:Xt("varying vec4 v_color;void main() {vec4 color=v_color;\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ngl_FragColor=color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\nvarying vec4 v_color;\n#pragma mapbox: define highp float base\n#pragma mapbox: define highp float height\n#pragma mapbox: define highp vec4 color\nvoid main() {\n#pragma mapbox: initialize highp float base\n#pragma mapbox: initialize highp float height\n#pragma mapbox: initialize highp vec4 color\nvec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\n#ifdef TERRAIN\nbool flat_roof=centroid_pos.x !=0.0 && t > 0.0;float ele=elevation(pos_nx.xy);float c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;float h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);vec3 pos=vec3(pos_nx.xy,h);\n#else\nvec3 pos=vec3(pos_nx.xy,t > 0.0 ? height : base);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(pos.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);float colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;v_color=vec4(0.0,0.0,0.0,1.0);vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;float directional=clamp(dot(normal,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_color.rgb+=clamp(color.rgb*directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}"),fillExtrusionPattern:Xt("uniform vec2 u_texsize;uniform float u_fade;uniform sampler2D u_image;varying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;\n#pragma mapbox: define lowp float base\n#pragma mapbox: define lowp float height\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float base\n#pragma mapbox: initialize lowp float height\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;vec2 imagecoord=mod(v_pos_a,1.0);vec2 pos=mix(pattern_tl_a/u_texsize,pattern_br_a/u_texsize,imagecoord);vec4 color1=texture2D(u_image,pos);vec2 imagecoord_b=mod(v_pos_b,1.0);vec2 pos2=mix(pattern_tl_b/u_texsize,pattern_br_b/u_texsize,imagecoord_b);vec4 color2=texture2D(u_image,pos2);vec4 out_color=mix(color1,color2,u_fade);out_color=out_color*v_lighting;\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\ngl_FragColor=out_color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform vec3 u_scale;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;attribute vec4 a_pos_normal_ed;attribute vec2 a_centroid_pos;\n#ifdef PROJECTION_GLOBE_VIEW\nattribute vec3 a_pos_3;attribute vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;\n#endif\nvarying vec2 v_pos_a;varying vec2 v_pos_b;varying vec4 v_lighting;\n#pragma mapbox: define lowp float base\n#pragma mapbox: define lowp float height\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float base\n#pragma mapbox: initialize lowp float height\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);\n#if defined(HAS_CENTROID) || defined(TERRAIN)\ncentroid_pos=a_centroid_pos;\n#endif\n#ifdef TERRAIN\nbool flat_roof=centroid_pos.x !=0.0 && t > 0.0;float ele=elevation(pos_nx.xy);float c_ele=flat_roof ? centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos) : ele;float h=flat_roof ? max(c_ele+height,ele+base+2.0) : ele+(t > 0.0 ? height : base==0.0 ?-5.0 : base);vec3 p=vec3(pos_nx.xy,h);\n#else\nvec3 p=vec3(pos_nx.xy,z);\n#endif\n#ifdef PROJECTION_GLOBE_VIEW\nfloat lift=float((t+base) > 0.0)*u_height_lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);\n#endif\nfloat hidden=float(centroid_pos.x==0.0 && centroid_pos.y==1.0);gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0\n? pos_nx.xy\n: vec2(edgedistance,z*u_height_factor);v_pos_a=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,fromScale*display_size_a,tileRatio,pos);v_pos_b=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,toScale*display_size_b,tileRatio,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float directional=clamp(dot(normal,u_lightpos),0.0,1.0);directional=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),directional);if (normal.y !=0.0) {directional*=(\n(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),mix(0.7,0.98,1.0-u_lightintensity),1.0)));}v_lighting.rgb+=clamp(directional*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;\n#ifdef FOG\nv_fog_pos=fog_position(p);\n#endif\n}"),hillshadePrepare:Xt("#ifdef GL_ES\nprecision highp float;\n#endif\nuniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;uniform vec4 u_unpack;float getElevation(vec2 coord) {\n#ifdef TERRAIN_DEM_FLOAT_FORMAT\nreturn texture2D(u_image,coord).a/4.0;\n#else\nvec4 data=texture2D(u_image,coord)*255.0;data.a=-1.0;return dot(data,u_unpack)/4.0;\n#endif\n}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos);float f=getElevation(v_pos+vec2(epsilon.x,0));float g=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float h=getElevation(v_pos+vec2(0,epsilon.y));float i=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(\n(c+f+f+i)-(a+d+d+g),(g+h+h+i)-(a+b+b+c)\n)/pow(2.0,exaggeration+(19.2562-u_zoom));gl_FragColor=clamp(vec4(\nderiv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_dimension;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:Xt("uniform sampler2D u_image;varying vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;void main() {vec4 pixel=texture2D(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);gl_FragColor=accent_color*(1.0-shade_color.a)+shade_color;\n#ifdef FOG\ngl_FragColor=fog_dither(fog_apply_premultiplied(gl_FragColor,v_fog_pos));\n#endif\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}"),line:Xt("uniform lowp float u_device_pixel_ratio;uniform float u_alpha_discard_threshold;varying vec2 v_width2;varying vec2 v_normal;varying float v_gamma_scale;\n#ifdef RENDER_LINE_DASH\nuniform sampler2D u_dash_image;uniform float u_mix;uniform vec3 u_scale;varying vec2 v_tex_a;varying vec2 v_tex_b;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform sampler2D u_gradient_image;varying highp vec2 v_uv;\n#endif\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash_from\n#pragma mapbox: define lowp vec4 dash_to\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash_from\n#pragma mapbox: initialize lowp vec4 dash_to\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\nfloat dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);\n#ifdef RENDER_LINE_DASH\nfloat sdfdist_a=texture2D(u_dash_image,v_tex_a).a;float sdfdist_b=texture2D(u_dash_image,v_tex_b).a;float sdfdist=mix(sdfdist_a,sdfdist_b,u_mix);float sdfwidth=min(dash_from.z*u_scale.y,dash_to.z*u_scale.z);float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/sdfwidth;alpha*=smoothstep(0.5-sdfgamma/floorwidth,0.5+sdfgamma/floorwidth,sdfdist);\n#endif\n#ifdef RENDER_LINE_GRADIENT\nvec4 out_color=texture2D(u_gradient_image,v_uv);\n#else\nvec4 out_color=color;\n#endif\n#ifdef FOG\nout_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));\n#endif\n#ifdef RENDER_LINE_ALPHA_DISCARD\nif (alpha < u_alpha_discard_threshold) {discard;}\n#endif\ngl_FragColor=out_color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","\n#define EXTRUDE_SCALE 0.015873016\nattribute vec2 a_pos_normal;attribute vec4 a_data;\n#ifdef RENDER_LINE_GRADIENT\nattribute vec3 a_packed;\n#else\nattribute float a_linesofar;\n#endif\nuniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_gamma_scale;\n#ifdef RENDER_LINE_DASH\nuniform vec2 u_texsize;uniform mediump vec3 u_scale;varying vec2 v_tex_a;varying vec2 v_tex_b;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nuniform float u_image_height;varying highp vec2 v_uv;\n#endif\n#pragma mapbox: define highp vec4 color\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 dash_from\n#pragma mapbox: define lowp vec4 dash_to\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float width\nvoid main() {\n#pragma mapbox: initialize highp vec4 color\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize lowp vec4 dash_from\n#pragma mapbox: initialize lowp vec4 dash_to\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float width\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#else\nv_gamma_scale=1.0;\n#endif\n#ifdef RENDER_LINE_GRADIENT\nfloat a_uv_x=a_packed[0];float a_split_index=a_packed[1];float a_linesofar=a_packed[2];highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec2(a_uv_x,a_split_index*texel_height-half_texel_height);\n#endif\n#ifdef RENDER_LINE_DASH\nfloat tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;float scaleA=dash_from.z==0.0 ? 0.0 : tileZoomRatio/(dash_from.z*fromScale);float scaleB=dash_to.z==0.0 ? 0.0 : tileZoomRatio/(dash_to.z*toScale);float heightA=dash_from.y;float heightB=dash_to.y;v_tex_a=vec2(a_linesofar*scaleA/floorwidth,(-normal.y*heightA+dash_from.x+0.5)/u_texsize.y);v_tex_b=vec2(a_linesofar*scaleB/floorwidth,(-normal.y*heightB+dash_to.x+0.5)/u_texsize.y);\n#endif\nv_width2=vec2(outset,inset);\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}"),linePattern:Xt("uniform lowp float u_device_pixel_ratio;uniform vec2 u_texsize;uniform float u_fade;uniform mediump vec3 u_scale;uniform sampler2D u_image;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\nvec2 pattern_tl_a=pattern_from.xy;vec2 pattern_br_a=pattern_from.zw;vec2 pattern_tl_b=pattern_to.xy;vec2 pattern_br_b=pattern_to.zw;float tileZoomRatio=u_scale.x;float fromScale=u_scale.y;float toScale=u_scale.z;vec2 display_size_a=(pattern_br_a-pattern_tl_a)/pixel_ratio_from;vec2 display_size_b=(pattern_br_b-pattern_tl_b)/pixel_ratio_to;vec2 pattern_size_a=vec2(display_size_a.x*fromScale/tileZoomRatio,display_size_a.y);vec2 pattern_size_b=vec2(display_size_b.x*toScale/tileZoomRatio,display_size_b.y);float aspect_a=display_size_a.y/v_width;float aspect_b=display_size_b.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);float x_a=mod(v_linesofar/pattern_size_a.x*aspect_a,1.0);float x_b=mod(v_linesofar/pattern_size_b.x*aspect_b,1.0);float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;vec2 pos_a=mix(pattern_tl_a*texel_size-texel_size,pattern_br_a*texel_size+texel_size,vec2(x_a,y));vec2 pos_b=mix(pattern_tl_b*texel_size-texel_size,pattern_br_b*texel_size+texel_size,vec2(x_b,y));vec4 color=mix(texture2D(u_image,pos_a),texture2D(u_image,pos_b),u_fade);\n#ifdef FOG\ncolor=fog_dither(fog_apply_premultiplied(color,v_fog_pos));\n#endif\ngl_FragColor=color*(alpha*opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","\n#define scale 0.015873016\nattribute vec2 a_pos_normal;attribute vec4 a_data;attribute float a_linesofar;uniform mat4 u_matrix;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform lowp float u_device_pixel_ratio;varying vec2 v_normal;varying vec2 v_width2;varying float v_linesofar;varying float v_gamma_scale;varying float v_width;\n#pragma mapbox: define lowp float blur\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float offset\n#pragma mapbox: define mediump float gapwidth\n#pragma mapbox: define mediump float width\n#pragma mapbox: define lowp float floorwidth\n#pragma mapbox: define lowp vec4 pattern_from\n#pragma mapbox: define lowp vec4 pattern_to\n#pragma mapbox: define lowp float pixel_ratio_from\n#pragma mapbox: define lowp float pixel_ratio_to\nvoid main() {\n#pragma mapbox: initialize lowp float blur\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float offset\n#pragma mapbox: initialize mediump float gapwidth\n#pragma mapbox: initialize mediump float width\n#pragma mapbox: initialize lowp float floorwidth\n#pragma mapbox: initialize mediump vec4 pattern_from\n#pragma mapbox: initialize mediump vec4 pattern_to\n#pragma mapbox: initialize lowp float pixel_ratio_from\n#pragma mapbox: initialize lowp float pixel_ratio_to\nfloat ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=width/2.0;offset=-1.0*offset;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*scale;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);vec4 projected_extrude=u_matrix*vec4(dist*u_pixels_to_tile_units,0.0,0.0);gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude;\n#ifndef RENDER_TO_TEXTURE\nfloat extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude.xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=extrude_length_without_perspective/extrude_length_with_perspective;\n#else\nv_gamma_scale=1.0;\n#endif\nv_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=floorwidth;\n#ifdef FOG\nv_fog_pos=fog_position(pos);\n#endif\n}"),raster:Xt("uniform float u_fade_t;uniform float u_opacity;uniform sampler2D u_image0;uniform sampler2D u_image1;varying vec2 v_pos0;varying vec2 v_pos1;uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;void main() {vec4 color0=texture2D(u_image0,v_pos0);vec4 color1=texture2D(u_image1,v_pos1);if (color0.a > 0.0) {color0.rgb=color0.rgb/color0.a;}if (color1.a > 0.0) {color1.rgb=color1.rgb/color1.a;}vec4 color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 rgb=color.rgb;rgb=vec3(\ndot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);\n#ifdef FOG\nout_color=fog_dither(fog_apply(out_color,v_fog_pos));\n#endif\ngl_FragColor=vec4(out_color*color.a,color.a);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;varying vec2 v_pos1;void main() {float w=1.0+dot(a_texture_pos,u_perspective_transform);gl_Position=u_matrix*vec4(a_pos*w,0,w);v_pos0=a_texture_pos/8192.0;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;\n#ifdef FOG\nv_fog_pos=fog_position(a_pos);\n#endif\n}"),symbolIcon:Xt("uniform sampler2D u_texture;varying vec2 v_tex;varying float v_fade_opacity;\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\nlowp float alpha=opacity*v_fade_opacity;gl_FragColor=texture2D(u_texture,v_tex)*alpha;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_pixeloffset;attribute vec4 a_z_tile_anchor;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform highp float u_camera_to_center_distance;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform float u_fade_change;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform vec2 u_texsize;varying vec2 v_tex;varying float v_fade_opacity;\n#pragma mapbox: define lowp float opacity\nvoid main() {\n#pragma mapbox: initialize lowp float opacity\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_minFontScale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}float anchorZ=a_z_tile_anchor.x;vec2 tileAnchor=a_z_tile_anchor.yz;vec3 h=elevationVector(tileAnchor)*elevation(tileAnchor);vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,tileAnchor,u_tile_id,u_merc_center);vec3 world_pos=mix_globe_mercator(vec3(a_pos,anchorZ)+h,mercator_pos,u_zoom_transition);vec4 projectedPoint=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),anchorZ,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec3 proj_pos=mix_globe_mercator(vec3(a_projected_pos.xy,anchorZ),mercator_pos,u_zoom_transition);\n#ifdef PROJECTED_POS_ON_VIEWPORT\nvec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xy,0.0,1.0);\n#else\nvec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xyz+h,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_minFontScale,fontScale)+a_pxoffset/16.0);\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\nfloat occlusion_fade=occlusionFade(projectedPoint);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projectedPoint.w <=0.0 || occlusion_fade==0.0));float projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nv_tex=a_tex/u_texsize;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;v_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change))*projection_transition_fade;}"),symbolSDF:Xt("#define SDF_PX 8.0\nuniform bool u_is_halo;uniform sampler2D u_texture;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;varying vec2 v_data0;varying vec3 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\nfloat EDGE_GAMMA=0.105/u_device_pixel_ratio;vec2 tex=v_data0.xy;float gamma_scale=v_data1.x;float size=v_data1.y;float fade_opacity=v_data1[2];float fontScale=u_is_text ? size/24.0 : size;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_pixeloffset;attribute vec4 a_z_tile_anchor;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_tile_id;uniform float u_zoom_transition;varying vec2 v_data0;varying vec3 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}float anchorZ=a_z_tile_anchor.x;vec2 tileAnchor=a_z_tile_anchor.yz;vec3 h=elevationVector(tileAnchor)*elevation(tileAnchor);vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,tileAnchor,u_tile_id,u_merc_center);vec3 world_pos=mix_globe_mercator(vec3(a_pos,anchorZ)+h,mercator_pos,u_zoom_transition);vec4 projectedPoint=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),anchorZ,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec3 proj_pos=mix_globe_mercator(vec3(a_projected_pos.xy,anchorZ),mercator_pos,u_zoom_transition);\n#ifdef PROJECTED_POS_ON_VIEWPORT\nvec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xy,0.0,1.0);\n#else\nvec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xyz+h,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*fontScale+a_pxoffset);\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\nfloat occlusion_fade=occlusionFade(projectedPoint);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projectedPoint.w <=0.0 || occlusion_fade==0.0));float gamma_scale=gl_Position.w;float projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nvec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));v_data0=a_tex/u_texsize;v_data1=vec3(gamma_scale,size,interpolated_fade_opacity*projection_transition_fade);}"),symbolTextAndIcon:Xt("#define SDF_PX 8.0\n#define SDF 1.0\n#define ICON 0.0\nuniform bool u_is_halo;uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;varying vec4 v_data0;varying vec4 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\nfloat fade_opacity=v_data1[2];if (v_data1.w==ICON) {vec2 tex_icon=v_data0.zw;lowp float alpha=opacity*fade_opacity;gl_FragColor=texture2D(u_texture_icon,tex_icon)*alpha;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\nreturn;}vec2 tex=v_data0.xy;float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_data1.x;float size=v_data1.y;float fontScale=size/24.0;lowp vec4 color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;if (u_is_halo) {color=halo_color;gamma=(halo_blur*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width/fontScale)/SDF_PX;}lowp float dist=texture2D(u_texture,tex).a;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);gl_FragColor=color*(alpha*opacity*fade_opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","attribute vec4 a_pos_offset;attribute vec4 a_tex_size;attribute vec4 a_z_tile_anchor;attribute vec3 a_projected_pos;attribute float a_fade_opacity;uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_pitch_with_map;uniform highp float u_pitch;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec2 u_texsize_icon;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;varying vec4 v_data0;varying vec4 v_data1;\n#pragma mapbox: define highp vec4 fill_color\n#pragma mapbox: define highp vec4 halo_color\n#pragma mapbox: define lowp float opacity\n#pragma mapbox: define lowp float halo_width\n#pragma mapbox: define lowp float halo_blur\nvoid main() {\n#pragma mapbox: initialize highp vec4 fill_color\n#pragma mapbox: initialize highp vec4 halo_color\n#pragma mapbox: initialize lowp float opacity\n#pragma mapbox: initialize lowp float halo_width\n#pragma mapbox: initialize lowp float halo_blur\nvec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);float is_sdf=a_size[0]-2.0*a_size_min;highp float segment_angle=-a_projected_pos[2];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}float anchorZ=a_z_tile_anchor.x;vec2 tileAnchor=a_z_tile_anchor.yz;vec3 h=elevationVector(tileAnchor)*elevation(tileAnchor);vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,tileAnchor,u_tile_id,u_merc_center);vec3 world_pos=mix_globe_mercator(vec3(a_pos,anchorZ)+h,mercator_pos,u_zoom_transition);vec4 projectedPoint=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float distance_ratio=u_pitch_with_map ?\ncamera_to_anchor_distance/u_camera_to_center_distance :\nu_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(\n0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float fontScale=size/24.0;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetProjectedPoint=u_matrix*vec4(a_pos+vec2(1,0),anchorZ,1);vec2 a=projectedPoint.xy/projectedPoint.w;vec2 b=offsetProjectedPoint.xy/offsetProjectedPoint.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec3 proj_pos=mix_globe_mercator(vec3(a_projected_pos.xy,anchorZ),mercator_pos,u_zoom_transition);\n#ifdef PROJECTED_POS_ON_VIEWPORT\nvec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xy,0.0,1.0);\n#else\nvec4 projected_pos=u_label_plane_matrix*vec4(proj_pos.xyz+h,1.0);\n#endif\nhighp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*fontScale);\n#ifdef PITCH_WITH_MAP_TERRAIN\nvec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);\n#endif\nfloat occlusion_fade=occlusionFade(projectedPoint);gl_Position=mix(u_coord_matrix*vec4(projected_pos.xy/projected_pos.w+offset,z,1.0),AWAY,float(projectedPoint.w <=0.0 || occlusion_fade==0.0));float gamma_scale=gl_Position.w;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float interpolated_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));float projection_transition_fade=1.0;\n#if defined(PROJECTED_POS_ON_VIEWPORT) && defined(PROJECTION_GLOBE_VIEW)\nprojection_transition_fade=1.0-step(EPSILON,u_zoom_transition);\n#endif\nv_data0.xy=a_tex/u_texsize;v_data0.zw=a_tex/u_texsize_icon;v_data1=vec4(gamma_scale,size,interpolated_fade_opacity*projection_transition_fade,is_sdf);}"),terrainRaster:Xt("uniform sampler2D u_image0;varying vec2 v_pos0;\n#ifdef FOG\nvarying float v_fog_opacity;\n#endif\nvoid main() {vec4 color=texture2D(u_image0,v_pos0);\n#ifdef FOG\ncolor=fog_dither(fog_apply_from_vert(color,v_fog_opacity));\n#endif\ngl_FragColor=color;\n#ifdef TERRAIN_WIREFRAME\ngl_FragColor=vec4(1.0,0.0,0.0,0.8);\n#endif\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_matrix;uniform float u_skirt_height;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying vec2 v_pos0;\n#ifdef FOG\nvarying float v_fog_opacity;\n#endif\nconst float skirtOffset=24575.0;const float wireframeOffset=0.00015;void main() {v_pos0=a_texture_pos/8192.0;float skirt=float(a_pos.x >=skirtOffset);float elevation=elevation(a_texture_pos)-skirt*u_skirt_height;\n#ifdef TERRAIN_WIREFRAME\nelevation+=u_skirt_height*u_skirt_height*wireframeOffset;\n#endif\nvec2 decodedPos=a_pos-vec2(skirt*skirtOffset,0.0);gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);\n#ifdef FOG\nv_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));\n#endif\n}"),terrainDepth:Xt("#ifdef GL_ES\nprecision highp float;\n#endif\nvarying float v_depth;void main() {gl_FragColor=pack_depth(v_depth);}","uniform mat4 u_matrix;attribute vec2 a_pos;attribute vec2 a_texture_pos;varying float v_depth;void main() {float elevation=elevation(a_texture_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}"),skybox:Xt("\nvarying lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(\ncos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=textureCube(u_cubemap,uv).rgb;\n#ifdef FOG\nsky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);\n#endif\nsky_color.rgb=dither(sky_color.rgb,gl_FragCoord.xy+u_temporal_offset);sky_color+=0.1*sun_disk(v_uv,u_sun_direction);gl_FragColor=vec4(sky_color*u_opacity,u_opacity);\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",Gt),skyboxGradient:Xt("varying highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture2D(u_color_ramp,vec2(progress,0.5));\n#ifdef FOG\ncolor.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;\n#endif\ncolor*=u_opacity;color.rgb=dither(color.rgb,gl_FragCoord.xy+u_temporal_offset);gl_FragColor=color;\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}",Gt),skyboxCapture:Xt("\nvarying highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;\n#ifdef GL_ES\nprecision highp float;\n#endif\n#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)\n#define BETA_M                  vec3(21e-6,21e-6,21e-6)\n#define MIE_G                   0.76\n#define DENSITY_HEIGHT_SCALE_R  8000.0\n#define DENSITY_HEIGHT_SCALE_M  1200.0\n#define PLANET_RADIUS           6360e3\n#define ATMOSPHERE_RADIUS       6420e3\n#define SAMPLE_STEPS            10\n#define DENSITY_STEPS           4\nfloat ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;gl_FragColor=vec4(color,1.0);}","attribute highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;varying highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:Xt("uniform sampler2D u_image0;varying vec2 v_pos0;void main() {gl_FragColor=texture2D(u_image0,v_pos0);\n#ifdef TERRAIN_WIREFRAME\ngl_FragColor=vec4(1.0,0.0,0.0,0.8);\n#endif\n#ifdef OVERDRAW_INSPECTOR\ngl_FragColor=vec4(1.0);\n#endif\n}","uniform mat4 u_proj_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;attribute vec3 a_globe_pos;attribute vec2 a_merc_pos;attribute vec2 a_uv;varying vec2 v_pos0;const float wireframeOffset=1e3;void main() {v_pos0=a_uv;vec2 uv=a_uv*EXTENT;vec4 up_vector=vec4(elevationVector(uv),1.0);float height=elevation(uv);\n#ifdef TERRAIN_WIREFRAME\nheight+=wireframeOffset;\n#endif\nvec4 globe=u_globe_matrix*vec4(a_globe_pos+up_vector.xyz*height,1.0);vec4 mercator=vec4(0.0);if (u_zoom_transition > 0.0) {mercator=vec4(a_merc_pos,height,1.0);mercator.xy-=u_merc_center;mercator.x=wrap(mercator.x,-0.5,0.5);mercator=u_merc_matrix*mercator;}vec3 position=mix(globe.xyz,mercator.xyz,u_zoom_transition);gl_Position=u_proj_matrix*vec4(position,1.0);}"),globeAtmosphere:Xt("uniform vec2 u_center;uniform float u_radius;uniform vec2 u_screen_size;uniform float u_opacity;uniform highp float u_fadeout_range;uniform vec3 u_start_color;uniform vec3 u_end_color;uniform float u_pixel_ratio;void main() {highp vec2 fragCoord=gl_FragCoord.xy/u_pixel_ratio;fragCoord.y=u_screen_size.y-fragCoord.y;float distFromCenter=length(fragCoord-u_center);float normDistFromCenter=length(fragCoord-u_center)/u_radius;if (normDistFromCenter < 1.0)\ndiscard;float t=clamp(1.0-sqrt(normDistFromCenter-1.0)/u_fadeout_range,0.0,1.0);vec3 color=mix(u_start_color,u_end_color,1.0-t);gl_FragColor=vec4(color*t*u_opacity,u_opacity);}","attribute vec3 a_pos;void main() {gl_Position=vec4(a_pos,1.0);}")};function Xt(e,t,i){const r=/#pragma mapbox: ([\w]+) ([\w]+) ([\w]+) ([\w]+)/g,n=/uniform (highp |mediump |lowp )?([\w]+) ([\w]+)([\s]*)([\w]*)/g,o=t.match(/attribute (highp |mediump |lowp )?([\w]+) ([\w]+)/g),s=e.match(n),a=t.match(n),l=Vt.match(n);let c=a?a.concat(s):s;i||(jt.staticUniforms&&(c=jt.staticUniforms.concat(c)),$t.staticUniforms&&(c=$t.staticUniforms.concat(c))),c&&(c=c.concat(l));const h={};return {fragmentSource:e=e.replace(r,(e,t,i,r,n)=>(h[n]=!0,"define"===t?`\n#ifndef HAS_UNIFORM_u_${n}\nvarying ${i} ${r} ${n};\n#else\nuniform ${i} ${r} u_${n};\n#endif\n`:`\n#ifdef HAS_UNIFORM_u_${n}\n    ${i} ${r} ${n} = u_${n};\n#endif\n`)),vertexSource:t=t.replace(r,(e,t,i,r,n)=>{const o="float"===r?"vec2":"vec4",s=n.match(/color/)?"color":o;return h[n]?"define"===t?`\n#ifndef HAS_UNIFORM_u_${n}\nuniform lowp float u_${n}_t;\nattribute ${i} ${o} a_${n};\nvarying ${i} ${r} ${n};\n#else\nuniform ${i} ${r} u_${n};\n#endif\n`:"vec4"===s?`\n#ifndef HAS_UNIFORM_u_${n}\n    ${n} = a_${n};\n#else\n    ${i} ${r} ${n} = u_${n};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${n}\n    ${n} = unpack_mix_${s}(a_${n}, u_${n}_t);\n#else\n    ${i} ${r} ${n} = u_${n};\n#endif\n`:"define"===t?`\n#ifndef HAS_UNIFORM_u_${n}\nuniform lowp float u_${n}_t;\nattribute ${i} ${o} a_${n};\n#else\nuniform ${i} ${r} u_${n};\n#endif\n`:"vec4"===s?`\n#ifndef HAS_UNIFORM_u_${n}\n    ${i} ${r} ${n} = a_${n};\n#else\n    ${i} ${r} ${n} = u_${n};\n#endif\n`:`\n#ifndef HAS_UNIFORM_u_${n}\n    ${i} ${r} ${n} = unpack_mix_${s}(a_${n}, u_${n}_t);\n#else\n    ${i} ${r} ${n} = u_${n};\n#endif\n`;}),staticAttributes:o,staticUniforms:c};}class Wt{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffer=null,this.vao=null;}bind(e,t,i,r,n,o,s,a){this.context=e;let l=this.boundPaintVertexBuffers.length!==r.length;for(let e=0;!l&&e<r.length;e++)this.boundPaintVertexBuffers[e]!==r[e]&&(l=!0);e.extVertexArrayObject&&this.vao&&this.boundProgram===t&&this.boundLayoutVertexBuffer===i&&!l&&this.boundIndexBuffer===n&&this.boundVertexOffset===o&&this.boundDynamicVertexBuffer===s&&this.boundDynamicVertexBuffer2===a?(e.bindVertexArrayOES.set(this.vao),s&&s.bind(),n&&n.dynamicDraw&&n.bind(),a&&a.bind()):this.freshBind(t,i,r,n,o,s,a);}freshBind(e,t,i,r,n,o,s){let a;const l=e.numAttributes,c=this.context,h=c.gl;if(c.extVertexArrayObject)this.vao&&this.destroy(),this.vao=c.extVertexArrayObject.createVertexArrayOES(),c.bindVertexArrayOES.set(this.vao),a=0,this.boundProgram=e,this.boundLayoutVertexBuffer=t,this.boundPaintVertexBuffers=i,this.boundIndexBuffer=r,this.boundVertexOffset=n,this.boundDynamicVertexBuffer=o,this.boundDynamicVertexBuffer2=s;else {a=c.currentNumAttributes||0;for(let e=l;e<a;e++)h.disableVertexAttribArray(e);}t.enableAttributes(h,e);for(const t of i)t.enableAttributes(h,e);o&&o.enableAttributes(h,e),s&&s.enableAttributes(h,e),t.bind(),t.setVertexAttribPointers(h,e,n);for(const t of i)t.bind(),t.setVertexAttribPointers(h,e,n);o&&(o.bind(),o.setVertexAttribPointers(h,e,n)),r&&r.bind(),s&&(s.bind(),s.setVertexAttribPointers(h,e,n)),c.currentNumAttributes=l;}destroy(){this.vao&&(this.context.extVertexArrayObject.deleteVertexArrayOES(this.vao),this.vao=null);}}function Yt(t,i){const r=Math.pow(2,i.canonical.z),n=i.canonical.y;return [new e.MercatorCoordinate(0,n/r).toLngLat().lat,new e.MercatorCoordinate(0,(n+1)/r).toLngLat().lat];}function Jt(t,i,r,n,o,s,a){const l=t.context,c=l.gl,h=r.fbo;if(!h)return;t.prepareDrawTile(i);const u=t.useProgram("hillshade");l.activeTexture.set(c.TEXTURE0),c.bindTexture(c.TEXTURE_2D,h.colorAttachment.get());const d=((e,t,i,r)=>{const n=i.paint.get("hillshade-shadow-color"),o=i.paint.get("hillshade-highlight-color"),s=i.paint.get("hillshade-accent-color");let a=i.paint.get("hillshade-illumination-direction")*(Math.PI/180);"viewport"===i.paint.get("hillshade-illumination-anchor")&&(a-=e.transform.angle);const l=!e.options.moving;return {u_matrix:r||e.transform.calculateProjMatrix(t.tileID.toUnwrapped(),l),u_image:0,u_latrange:Yt(0,t.tileID),u_light:[i.paint.get("hillshade-exaggeration"),a],u_shadow:n,u_highlight:o,u_accent:s};})(t,r,n,t.terrain?i.projMatrix:null);t.prepareDrawProgram(l,u,i.toUnwrapped());const{tileBoundsBuffer:p,tileBoundsIndexBuffer:f,tileBoundsSegments:m}=t.getTileBoundsBuffers(r);u.draw(l,c.TRIANGLES,o,s,a,e.CullFaceMode.disabled,d,n.id,p,f,m);}function Kt(t,i,r){if(!i.needsDEMTextureUpload)return;const n=t.context,o=n.gl;n.pixelStoreUnpackPremultiplyAlpha.set(!1),i.demTexture=i.demTexture||t.getTileTexture(r.stride);const s=r.getPixels();i.demTexture?i.demTexture.update(s,{premultiply:!1}):i.demTexture=new e.Texture(n,s,o.RGBA,{premultiply:!1}),i.needsDEMTextureUpload=!1;}function Qt(t,i,r,n,o,s){const a=t.context,l=a.gl;if(!i.dem)return;const c=i.dem;if(a.activeTexture.set(l.TEXTURE1),Kt(t,i,c),!i.demTexture)return;i.demTexture.bind(l.NEAREST,l.CLAMP_TO_EDGE);const h=c.dim;a.activeTexture.set(l.TEXTURE0);let u=i.fbo;if(!u){const t=new e.Texture(a,{width:h,height:h,data:null},l.RGBA);t.bind(l.LINEAR,l.CLAMP_TO_EDGE),u=i.fbo=a.createFramebuffer(h,h,!0),u.colorAttachment.set(t.texture);}a.bindFramebuffer.set(u.framebuffer),a.viewport.set([0,0,h,h]);const{tileBoundsBuffer:d,tileBoundsIndexBuffer:p,tileBoundsSegments:f}=t.getMercatorTileBoundsBuffers();t.useProgram("hillshadePrepare").draw(a,l.TRIANGLES,n,o,s,e.CullFaceMode.disabled,((t,i)=>{const r=i.stride,n=e.create();return e.ortho(n,0,e.EXTENT,-e.EXTENT,0,0,1),e.translate(n,n,[0,-e.EXTENT,0]),{u_matrix:n,u_image:1,u_dimension:[r,r],u_zoom:t.overscaledZ,u_unpack:i.unpackVector};})(i.tileID,c),r.id,d,p,f),i.needsHillshadePrepare=!1;}const ei=(t,i)=>({u_matrix:new e.UniformMatrix4f(t,i.u_matrix),u_image0:new e.Uniform1i(t,i.u_image0),u_skirt_height:new e.Uniform1f(t,i.u_skirt_height)}),ti=(e,t)=>({u_matrix:e,u_image0:0,u_skirt_height:t}),ii=(e,t,i,r,n)=>({u_proj_matrix:Float32Array.from(e),u_globe_matrix:t,u_merc_matrix:i,u_zoom_transition:r,u_merc_center:n,u_image0:0});function ri(e,t){return null!=e&&null!=t&&!(!e.hasData()||!t.hasData())&&null!=e.demTexture&&null!=t.demTexture&&e.tileID.key!==t.tileID.key;}const ni=new class{constructor(){this.operations={};}newMorphing(e,t,i,r,n){if(e in this.operations){const t=this.operations[e];t.to.tileID.key!==i.tileID.key&&(t.queued=i);}else this.operations[e]={startTime:r,phase:0,duration:n,from:t,to:i,queued:null};}getMorphValuesForProxy(e){if(!(e in this.operations))return null;const t=this.operations[e];return {from:t.from,to:t.to,phase:t.phase};}update(e){for(const t in this.operations){const i=this.operations[t];for(i.phase=(e-i.startTime)/i.duration;i.phase>=1||!this._validOp(i);)if(!this._nextOp(i,e)){delete this.operations[t];break;}}}_nextOp(e,t){return !!e.queued&&(e.from=e.to,e.to=e.queued,e.queued=null,e.phase=0,e.startTime=t,!0);}_validOp(e){return e.from.hasData()&&e.to.hasData();}}(),oi={0:null,1:"TERRAIN_VERTEX_MORPHING",2:"TERRAIN_WIREFRAME"};function si(e,t){const i=1<<e.z;return !t&&(0===e.x||e.x===i-1)||0===e.y||e.y===i-1;}const ai=e=>({u_matrix:e});function li(t,i,r,n,o){if(o>0){const s=e.exported.now(),a=(s-t.timeAdded)/o,l=i?(s-i.timeAdded)/o:-1,c=r.getSource(),h=n.coveringZoomLevel({tileSize:c.tileSize,roundZoom:c.roundZoom}),u=!i||Math.abs(i.tileID.overscaledZ-h)>Math.abs(t.tileID.overscaledZ-h),d=u&&t.refreshedUponExpiration?1:e.clamp(u?a:1-l,0,1);return t.refreshedUponExpiration&&a>=1&&(t.refreshedUponExpiration=!1),i?{opacity:1,mix:1-d}:{opacity:d,mix:0};}return {opacity:1,mix:0};}class ci extends e.SourceCache{constructor(e){const t={type:"raster-dem",maxzoom:e.transform.maxZoom},i=new E(Le(),null),r=we("mock-dem",t,i,e.style);super("mock-dem",r,!1),r.setEventedParent(this),this._sourceLoaded=!0;}_loadTile(e,t){e.state="loaded",t(null);}}class hi extends e.SourceCache{constructor(e){const t=we("proxy",{type:"geojson",maxzoom:e.transform.maxZoom},new E(Le(),null),e.style);super("proxy",t,!1),t.setEventedParent(this),this.map=this.getSource().map=e,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={};}update(t,i,r){if(t.freezeTileCoverage)return;this.transform=t;const n=t.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce((i,r)=>{if(i[r.key]="",!this._tiles[r.key]){const i=new e.Tile(r,this._source.tileSize*r.overscaleFactor(),t.tileZoom);i.state="loaded",this._tiles[r.key]=i;}return i;},{});for(const e in this._tiles)e in n||(this.freeFBO(e),this._tiles[e].unloadVectorData(),delete this._tiles[e]);}freeFBO(e){const t=this.proxyCachedFBO[e];if(void 0!==t){const i=Object.values(t);this.renderCachePool.push(...i),delete this.proxyCachedFBO[e];}}deallocRenderCache(){this.renderCache.forEach(e=>e.fb.destroy()),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={};}}class ui extends e.OverscaledTileID{constructor(e,t,i){super(e.overscaledZ,e.wrap,e.canonical.z,e.canonical.x,e.canonical.y),this.proxyTileKey=t,this.projMatrix=i;}}class di extends e.Elevation{constructor(t,i){super(),this.painter=t,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[r,n,o]=function(t){const i=new e.StructArrayLayout4i8(),r=new e.StructArrayLayout3ui6(),n=131;i.reserve(17161),r.reserve(33800);const o=e.EXTENT/128,s=e.EXTENT+o/2,a=s+o;for(let t=-o;t<a;t+=o)for(let r=-o;r<a;r+=o){const n=r<0||r>s||t<0||t>s?24575:0,o=e.clamp(Math.round(r),0,e.EXTENT),a=e.clamp(Math.round(t),0,e.EXTENT);i.emplaceBack(o+n,a,o,a);}const l=(e,t)=>{const i=t*n+e;r.emplaceBack(i+1,i,i+n),r.emplaceBack(i+n,i+n+1,i+1);};for(let e=1;e<129;e++)for(let t=1;t<129;t++)l(t,e);return [0,129].forEach(e=>{for(let t=0;t<130;t++)l(t,e),l(e,t);}),[i,r,32768];}(),s=t.context;this.gridBuffer=s.createVertexBuffer(r,e.boundsAttributes.members),this.gridIndexBuffer=s.createIndexBuffer(n),this.gridSegments=e.SegmentVector.simpleSegment(0,0,r.length,n.length),this.gridNoSkirtSegments=e.SegmentVector.simpleSegment(0,0,r.length,o),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new hi(i.map),this.orthoMatrix=e.create(),e.ortho(this.orthoMatrix,0,e.EXTENT,0,e.EXTENT,0,1);const a=s.gl;this._overlapStencilMode=new e.StencilMode({func:a.GEQUAL,mask:255},0,255,a.KEEP,a.KEEP,a.REPLACE),this._previousZoom=t.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=i,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new ci(i.map);}set style(e){e.on("data",this._onStyleDataEvent.bind(this)),e.on("neworder",this._checkRenderCacheEfficiency.bind(this)),this._style=e,this._checkRenderCacheEfficiency();}update(t,i,r){if(t&&t.terrain){this._style!==t&&(this.style=t),this.enabled=!0;const n=t.terrain.properties;this.sourceCache=0===t.terrain.drapeRenderMode?this._mockSourceCache:t._getSourceCache(n.get("source")),this._exaggeration=n.get("exaggeration");const o=()=>{this.sourceCache.used&&e.warnOnce(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.\nThis leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const t=this.getScaledDemTileSize();this.sourceCache.update(i,t,!0),this.resetTileLookupCache(this.sourceCache.id);};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,o(),this._initializing=!0),o(),i.updateElevation(!r),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(i),this._emptyDEMTextureDirty=!0;}else this._disable();}resetTileLookupCache(e){this._findCoveringTileCache[e]={};}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize;}_checkRenderCacheEfficiency(){const t=this.renderCacheEfficiency(this._style);this._style.map._optimizeForTerrain||100!==t.efficiency&&e.warnOnce(`Terrain render cache efficiency is not optimal (${t.efficiency}%) and performance\n                may be affected negatively, consider placing all background, fill and line layers before layer\n                with id '${t.firstUndrapedLayer}' or create a map using optimizeForTerrain: true option.`);}_onStyleDataEvent(e){e.coord&&"source"===e.dataType?this._clearRenderCacheForTile(e.sourceCacheId,e.coord):"style"===e.dataType&&(this._invalidateRenderCache=!0);}_disable(){if(this.enabled&&(this.enabled=!1,this._sharedDepthStencil=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const e in this._style._sourceCaches)this._style._sourceCaches[e].usedForTerrain=!1;}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this._emptyDepthBufferTexture&&this._emptyDepthBufferTexture.destroy(),this.pool.forEach(e=>e.fb.destroy()),this.pool=[],this._depthFBO&&(this._depthFBO.destroy(),delete this._depthFBO,delete this._depthTexture);}_source(){return this.enabled?this.sourceCache:null;}exaggeration(){return this._exaggeration;}get visibleDemTiles(){return this._visibleDemTiles;}get drapeBufferSize(){const e=2*this.proxySourceCache.getSource().tileSize;return [e,e];}set useVertexMorphing(e){this._useVertexMorphing=e;}updateTileBinding(t){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const i=this.proxySourceCache,r=this.painter.transform;this._initializing&&(this._initializing=0===r._centerAltitude&&-1===this.getAtPointOrZero(e.MercatorCoordinate.fromLngLat(r.center),-1),this._emptyDEMTextureDirty=!this._initializing);const n=this.proxyCoords=i.getIds().map(e=>{const t=i.getTileByID(e).tileID;return t.projMatrix=r.calculateProjMatrix(t.toUnwrapped()),t;});!function(t,i){const r=i.transform.pointCoordinate(i.transform.getCameraPoint()),n=new e.pointGeometry(r.x,r.y);t.sort((t,i)=>{if(i.overscaledZ-t.overscaledZ)return i.overscaledZ-t.overscaledZ;const r=new e.pointGeometry(t.canonical.x+(1<<t.canonical.z)*t.wrap,t.canonical.y),o=new e.pointGeometry(i.canonical.x+(1<<i.canonical.z)*i.wrap,i.canonical.y),s=n.mult(1<<t.canonical.z);return s.x-=.5,s.y-=.5,s.distSqr(r)-s.distSqr(o);});}(n,this.painter),this._previousZoom=r.zoom;const o=this.proxyToSource||{};this.proxyToSource={},n.forEach(e=>{this.proxyToSource[e.key]={};}),this.terrainTileForTile={};const s=this._style._sourceCaches;for(const e in s){const i=s[e];if(!i.used)continue;if(i!==this.sourceCache&&this.resetTileLookupCache(i.id),this._setupProxiedCoordsForOrtho(i,t[e],o),i.usedForTerrain)continue;const r=t[e];i.getSource().reparseOverscaled&&this._assignTerrainTiles(r);}this.proxiedCoords[i.id]=n.map(e=>new ui(e,e.key,this.orthoMatrix)),this._assignTerrainTiles(n),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(o),this.renderingToTexture=!1,this._updateTimestamp=e.exported.now();const a={};this._visibleDemTiles=[];for(const e of this.proxyCoords){const t=this.terrainTileForTile[e.key];if(!t)continue;const i=t.tileID.key;i in a||(this._visibleDemTiles.push(t),a[i]=i);}}_assignTerrainTiles(e){this._initializing||e.forEach(e=>{if(this.terrainTileForTile[e.key])return;const t=this._findTileCoveringTileID(e,this.sourceCache);t&&(this.terrainTileForTile[e.key]=t);});}_prepareDEMTextures(){const e=this.painter.context,t=e.gl;for(const i in this.terrainTileForTile){const r=this.terrainTileForTile[i],n=r.dem;!n||r.demTexture&&!r.needsDEMTextureUpload||(e.activeTexture.set(t.TEXTURE1),Kt(this.painter,r,n));}}_prepareDemTileUniforms(e,t,i,r){if(!t||null==t.demTexture)return !1;const n=e.tileID.canonical,o=Math.pow(2,t.tileID.canonical.z-n.z),s=r||"";return i[`u_dem_tl${s}`]=[n.x*o%1,n.y*o%1],i[`u_dem_scale${s}`]=o,!0;}get emptyDEMTexture(){return !this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture();}get emptyDepthBufferTexture(){const t=this.painter.context,i=t.gl;if(!this._emptyDepthBufferTexture){const r={width:1,height:1,data:new Uint8Array([255,255,255,255])};this._emptyDepthBufferTexture=new e.Texture(t,r,i.RGBA,{premultiply:!1});}return this._emptyDepthBufferTexture;}_getLoadedAreaMinimum(){let e=0;const t=this._visibleDemTiles.reduce((t,i)=>{if(!i.dem)return t;const r=i.dem.tree.minimums[0];return r>0&&e++,t+r;},0);return e?t/e:0;}_updateEmptyDEMTexture(){const t=this.painter.context,i=t.gl;t.activeTexture.set(i.TEXTURE2);const r=this._getLoadedAreaMinimum(),n={width:1,height:1,data:new Uint8Array(e.DEMData.pack(r,this.sourceCache.getSource().encoding))};this._emptyDEMTextureDirty=!1;let o=this._emptyDEMTexture;return o?o.update(n,{premultiply:!1}):o=this._emptyDEMTexture=new e.Texture(t,n,i.RGBA,{premultiply:!1}),o;}setupElevationDraw(t,i,r){const n=this.painter.context,o=n.gl,s=(a=this.sourceCache.getSource().encoding,{u_dem:2,u_dem_prev:4,u_dem_unpack:e.DEMData.getUnpackVector(a),u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_exaggeration:0,u_tile_tl_up:[0,0,1],u_tile_tr_up:[0,0,1],u_tile_br_up:[0,0,1],u_tile_bl_up:[0,0,1],u_tile_up_scale:1});var a;s.u_dem_size=this.sourceCache.getSource().tileSize,s.u_exaggeration=this.exaggeration();const l=this.painter.transform,c=l.projection.createTileTransform(l,l.worldSize),h=t.tileID.canonical;s.u_tile_tl_up=c.upVector(h,0,0),s.u_tile_tr_up=c.upVector(h,e.EXTENT,0),s.u_tile_br_up=c.upVector(h,e.EXTENT,e.EXTENT),s.u_tile_bl_up=c.upVector(h,0,e.EXTENT),s.u_tile_up_scale=c.upVectorScale(h);let u=null,d=null,p=1;if(r&&r.morphing&&this._useVertexMorphing){const e=r.morphing.srcDemTile,i=r.morphing.dstDemTile;p=r.morphing.phase,e&&i&&(this._prepareDemTileUniforms(t,e,s,"_prev")&&(d=e),this._prepareDemTileUniforms(t,i,s)&&(u=i));}if(d&&u?(n.activeTexture.set(o.TEXTURE2),u.demTexture.bind(o.NEAREST,o.CLAMP_TO_EDGE,o.NEAREST),n.activeTexture.set(o.TEXTURE4),d.demTexture.bind(o.NEAREST,o.CLAMP_TO_EDGE,o.NEAREST),s.u_dem_lerp=p):(u=this.terrainTileForTile[t.tileID.key],n.activeTexture.set(o.TEXTURE2),(this._prepareDemTileUniforms(t,u,s)?u.demTexture:this.emptyDEMTexture).bind(o.NEAREST,o.CLAMP_TO_EDGE)),n.activeTexture.set(o.TEXTURE3),r&&r.useDepthForOcclusion?(this._depthTexture.bind(o.NEAREST,o.CLAMP_TO_EDGE),s.u_depth_size_inv=[1/this._depthFBO.width,1/this._depthFBO.height]):(this.emptyDepthBufferTexture.bind(o.NEAREST,o.CLAMP_TO_EDGE),s.u_depth_size_inv=[1,1]),r&&r.useMeterToDem&&u){const t=(1<<u.tileID.canonical.z)*e.mercatorZfromAltitude(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;s.u_meter_to_dem=t;}r&&r.labelPlaneMatrixInv&&(s.u_label_plane_matrix_inv=r.labelPlaneMatrixInv),i.setTerrainUniformValues(n,s);}renderToBackBuffer(t){const i=this.painter,r=this.painter.context;0!==t.length&&(r.bindFramebuffer.set(null),r.viewport.set([0,0,i.width,i.height]),this.renderingToTexture=!1,function(t,i,r,n,o){if("globe"===t.transform.projection.name)!function(t,i,r,n,o){const s=t.context,a=s.gl;let l,c;const h=t.options.showTerrainWireframe?2:0,u=(e,i)=>{if(c===e)return;const r=[];i&&r.push(oi[h]),r.push(oi[e]),r.push("PROJECTION_GLOBE_VIEW"),l=t.useProgram("globeRaster",null,r),c=e;},d=t.colorModeForRenderPass(),p=new e.DepthMode(a.LEQUAL,e.DepthMode.ReadWrite,t.depthRangeFor3D);ni.update(o);const f=t.transform,m=e.calculateGlobeMatrix(f,f.worldSize),_=e.calculateGlobeMercatorMatrix(f),g=[e.mercatorXfromLng(f.center.lng),e.mercatorYfromLat(f.center.lat)],y=t.globeSharedBuffers;(h?[!1,!0]:[!1]).forEach(h=>{c=-1;const x=h?a.LINES:a.TRIANGLES;for(const c of n){const n=r.getTile(c),v=Math.pow(2,c.canonical.z),[b,S]=e.globeBuffersForTileMesh(t,n,c,v),w=e.StencilMode.disabled,T=i.prevTerrainTileForTile[c.key],E=i.terrainTileForTile[c.key];ri(T,E)&&ni.newMorphing(c.key,T,E,o,250),s.activeTexture.set(a.TEXTURE0),n.texture.bind(a.LINEAR,a.CLAMP_TO_EDGE);const N=ni.getMorphValuesForProxy(c.key),I=N?1:0,M={};N&&e.extend$1(M,{morphing:{srcDemTile:N.from,dstDemTile:N.to,phase:e.easeCubicInOut(N.phase)}});const C=e.globeMatrixForTile(c.canonical,m),A=ii(f.projMatrix,C,_,e.globeToMercatorTransition(f.zoom),g);if(u(I,h),i.setupElevationDraw(n,l,M),t.prepareDrawProgram(s,l,c.toUnwrapped()),y){const[i,r]=h?y.getWirefameBuffer(t.context):[y.gridIndexBuffer,y.gridSegments];l.draw(s,x,p,w,d,e.CullFaceMode.backCCW,A,"globe_raster",b,i,r);}if(!h){const t=[0===c.canonical.y?e.globePoleMatrixForTile(c.canonical,!1,f):null,c.canonical.y===v-1?e.globePoleMatrixForTile(c.canonical,!0,f):null];for(const i of t){if(!i)continue;const t=ii(f.projMatrix,i,i,0,g);y&&l.draw(s,x,p,w,d,e.CullFaceMode.disabled,t,"globe_pole_raster",S,y.poleIndexBuffer,y.poleSegments);}}}});}(t,i,r,n,o);else {const s=t.context,a=s.gl;let l,c;const h=t.options.showTerrainWireframe?2:0,u=(e,i)=>{if(c===e)return;const r=[oi[e]];i&&r.push(oi[h]),l=t.useProgram("terrainRaster",null,r),c=e;},d=t.colorModeForRenderPass(),p=new e.DepthMode(a.LEQUAL,e.DepthMode.ReadWrite,t.depthRangeFor3D);ni.update(o);const f=t.transform,m=6*Math.pow(1.5,22-f.zoom)*i.exaggeration();(h?[!1,!0]:[!1]).forEach(h=>{c=-1;const _=h?a.LINES:a.TRIANGLES,[g,y]=h?i.getWirefameBuffer():[i.gridIndexBuffer,i.gridSegments];for(const c of n){const n=r.getTile(c),x=e.StencilMode.disabled,v=i.prevTerrainTileForTile[c.key],b=i.terrainTileForTile[c.key];ri(v,b)&&ni.newMorphing(c.key,v,b,o,250),s.activeTexture.set(a.TEXTURE0),n.texture.bind(a.LINEAR,a.CLAMP_TO_EDGE,a.LINEAR_MIPMAP_NEAREST);const S=ni.getMorphValuesForProxy(c.key),w=S?1:0;let T;S&&(T={morphing:{srcDemTile:S.from,dstDemTile:S.to,phase:e.easeCubicInOut(S.phase)}});const E=ti(c.projMatrix,si(c.canonical,f.renderWorldCopies)?m/10:m);u(w,h),i.setupElevationDraw(n,l,T),t.prepareDrawProgram(s,l,c.toUnwrapped()),l.draw(s,_,p,x,d,e.CullFaceMode.backCCW,E,"terrain_raster",i.gridBuffer,g,y);}});}}(i,this,this.proxySourceCache,t,this._updateTimestamp),this.renderingToTexture=!0,t.splice(0,t.length));}renderBatch(t){if(0===this._drapedRenderBatches.length)return t+1;this.renderingToTexture=!0;const i=this.painter,r=this.painter.context,n=this.proxySourceCache,o=this.proxiedCoords[n.id],s=this._drapedRenderBatches.shift(),a=[],l=i.style.order;let c=0;for(const h of o){const o=n.getTileByID(h.proxyTileKey),u=n.proxyCachedFBO[h.key]?n.proxyCachedFBO[h.key][t]:void 0,d=void 0!==u?n.renderCache[u]:this.pool[c++],p=void 0!==u;if(o.texture=d.tex,p&&!d.dirty){a.push(o.tileID);continue;}let f;r.bindFramebuffer.set(d.fb.framebuffer),this.renderedToTile=!1,d.dirty&&(r.clear({color:e.Color.transparent,stencil:0}),d.dirty=!1);for(let e=s.start;e<=s.end;++e){const t=i.style._layers[l[e]];if(t.isHidden(i.transform.zoom))continue;const n=i.style._getLayerSourceCache(t),o=n?this.proxyToSource[h.key][n.id]:[h];if(!o)continue;const s=o;r.viewport.set([0,0,d.fb.width,d.fb.height]),f!==(n?n.id:null)&&(this._setupStencil(d,o,t,n),f=n?n.id:null),i.renderLayer(i,n,t,s);}this.renderedToTile?(d.dirty=!0,a.push(o.tileID)):p||--c,5===c&&(c=0,this.renderToBackBuffer(a));}return this.renderToBackBuffer(a),this.renderingToTexture=!1,r.bindFramebuffer.set(null),r.viewport.set([0,0,i.width,i.height]),s.end+1;}postRender(){}renderCacheEfficiency(e){const t=e.order.length;if(0===t)return {efficiency:100};let i,r=0,n=0,o=!1;for(let s=0;s<t;++s){const t=e._layers[e.order[s]];this._style.isLayerDraped(t)?(o&&++r,++n):o||(o=!0,i=t.id);}return 0===n?{efficiency:100}:{efficiency:100*(1-r/n),firstUndrapedLayer:i};}getMinElevationBelowMSL(){let e=0;return this._visibleDemTiles.filter(e=>e.dem).forEach(t=>{e=Math.min(e,t.dem.tree.minimums[0]);}),0===e?e:(e-30)*this._exaggeration;}raycast(e,t,i){if(!this._visibleDemTiles)return null;const r=this._visibleDemTiles.filter(e=>e.dem).map(r=>{const n=r.tileID,o=Math.pow(2,n.overscaledZ),{x:s,y:a}=n.canonical,l=s/o,c=(s+1)/o,h=a/o,u=(a+1)/o;return {minx:l,miny:h,maxx:c,maxy:u,t:r.dem.tree.raycastRoot(l,h,c,u,e,t,i),tile:r};});r.sort((e,t)=>(null!==e.t?e.t:Number.MAX_VALUE)-(null!==t.t?t.t:Number.MAX_VALUE));for(const n of r){if(null==n.t)return null;const r=n.tile.dem.tree.raycast(n.minx,n.miny,n.maxx,n.maxy,e,t,i);if(null!=r)return r;}return null;}_createFBO(){const t=this.painter.context,i=t.gl,r=this.drapeBufferSize;t.activeTexture.set(i.TEXTURE0);const n=new e.Texture(t,{width:r[0],height:r[1],data:null},i.RGBA);n.bind(i.LINEAR,i.CLAMP_TO_EDGE);const o=t.createFramebuffer(r[0],r[1],!1);return o.colorAttachment.set(n.texture),o.depthAttachment=new ue(t,o.framebuffer),void 0===this._sharedDepthStencil?(this._sharedDepthStencil=t.createRenderbuffer(t.gl.DEPTH_STENCIL,r[0],r[1]),this._stencilRef=0,o.depthAttachment.set(this._sharedDepthStencil),t.clear({stencil:0})):o.depthAttachment.set(this._sharedDepthStencil),t.extTextureFilterAnisotropic&&!t.extTextureFilterAnisotropicForceOff&&i.texParameterf(i.TEXTURE_2D,t.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,t.extTextureFilterAnisotropicMax),{fb:o,tex:n,dirty:!1};}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO());}_shouldDisableRenderCache(){if(this._style.light&&this._style.light.hasTransition())return !0;for(const e in this._style._sourceCaches)if(this._style._sourceCaches[e].hasTransition())return !0;return this._style.order.some(e=>{const t=this._style._layers[e],i=t.isHidden(this.painter.transform.zoom),r=t.getCrossfadeParameters(),n=!!r&&1!==r.t,o=t.hasTransition();return "custom"!==t.type&&!i&&(n||o);});}_clearRasterFadeFromRenderCache(){let e=!1;for(const t in this._style._sourceCaches)if(this._style._sourceCaches[t]._source instanceof ye){e=!0;break;}if(e)for(let e=0;e<this._style.order.length;++e){const t=this._style._layers[this._style.order[e]],i=t.isHidden(this.painter.transform.zoom),r=this._style._getLayerSourceCache(t);if("raster"!==t.type||i||!r)continue;const n=t.paint.get("raster-fade-duration");for(const e of this.proxyCoords){const t=this.proxyToSource[e.key][r.id];if(t)for(const e of t){const t=li(r.getTile(e),r.findLoadedParent(e,0),r,this.painter.transform,n);(1!==t.opacity||0!==t.mix)&&this._clearRenderCacheForTile(r.id,e);}}}}_setupDrapedRenderBatches(){const e=this._style.order,t=e.length;if(0===t)return;const i=[];let r,n=0,o=this._style._layers[e[n]];for(;!this._style.isLayerDraped(o)&&o.isHidden(this.painter.transform.zoom)&&++n<t;)o=this._style._layers[e[n]];for(;n<t;++n){const t=this._style._layers[e[n]];t.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(t)?void 0===r&&(r=n):void 0!==r&&(i.push({start:r,end:n-1}),r=void 0));}void 0!==r&&i.push({start:r,end:n-1}),this._drapedRenderBatches=i;}_setupRenderCache(e){const t=this.proxySourceCache;if(this._shouldDisableRenderCache()||this._invalidateRenderCache){if(this._invalidateRenderCache=!1,t.renderCache.length>t.renderCachePool.length){const e=Object.values(t.proxyCachedFBO);t.proxyCachedFBO={};for(let i=0;i<e.length;++i){const r=Object.values(e[i]);t.renderCachePool.push(...r);}}return;}this._clearRasterFadeFromRenderCache();const i=this.proxyCoords,r=this._tilesDirty;for(let n=i.length-1;n>=0;n--){const o=i[n];if(t.getTileByID(o.key),void 0!==t.proxyCachedFBO[o.key]){const i=e[o.key],n=this.proxyToSource[o.key];let s=0;for(const e in n){const t=n[e],o=i[e];if(!o||o.length!==t.length||t.some((t,i)=>t!==o[i]||r[e]&&r[e].hasOwnProperty(t.key))){s=-1;break;}++s;}for(const e in t.proxyCachedFBO[o.key])t.renderCache[t.proxyCachedFBO[o.key][e]].dirty=s<0||s!==Object.values(i).length;}}const n=[...this._drapedRenderBatches];n.sort((e,t)=>t.end-t.start-(e.end-e.start));for(const e of n)for(const r of i){if(t.proxyCachedFBO[r.key])continue;let i=t.renderCachePool.pop();void 0===i&&t.renderCache.length<50&&(i=t.renderCache.length,t.renderCache.push(this._createFBO())),void 0!==i&&(t.proxyCachedFBO[r.key]={},t.proxyCachedFBO[r.key][e.start]=i,t.renderCache[i].dirty=!0);}this._tilesDirty={};}_setupStencil(e,t,i,r){if(!r||!this._sourceTilesOverlap[r.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const n=this.painter.context,o=n.gl;if(t.length<=1)return void(this._overlapStencilType=!1);let s;if(i.isTileClipped())s=t.length,this._overlapStencilMode.test={func:o.EQUAL,mask:255},this._overlapStencilType="Clip";else {if(!(t[0].overscaledZ>t[t.length-1].overscaledZ))return void(this._overlapStencilType=!1);s=1,this._overlapStencilMode.test={func:o.GREATER,mask:255},this._overlapStencilType="Mask";}this._stencilRef+s>255&&(n.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=s,this._overlapStencilMode.ref=this._stencilRef,i.isTileClipped()&&this._renderTileClippingMasks(t,this._overlapStencilMode.ref);}clipOrMaskOverlapStencilType(){return "Clip"===this._overlapStencilType||"Mask"===this._overlapStencilType;}stencilModeForRTTOverlap(t){return this.renderingToTexture&&this._overlapStencilType?("Clip"===this._overlapStencilType&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[t.key]),this._overlapStencilMode):e.StencilMode.disabled;}_renderTileClippingMasks(t,i){const r=this.painter,n=this.painter.context,o=n.gl;r._tileClippingMaskIDs={},n.setColorMode(e.ColorMode.disabled),n.setDepthMode(e.DepthMode.disabled);const s=r.useProgram("clippingMask");for(const a of t){const t=r._tileClippingMaskIDs[a.key]=--i;s.draw(n,o.TRIANGLES,e.DepthMode.disabled,new e.StencilMode({func:o.ALWAYS,mask:0},t,255,o.KEEP,o.KEEP,o.REPLACE),e.ColorMode.disabled,e.CullFaceMode.disabled,ai(a.projMatrix),"$clipping",r.tileExtentBuffer,r.quadTriangleIndexBuffer,r.tileExtentSegments);}}pointCoordinate(t){const i=this.painter.transform;if(t.x<0||t.x>i.width||t.y<0||t.y>i.height)return null;const r=[t.x,t.y,1,1];e.transformMat4$1(r,r,i.pixelMatrixInverse),e.scale$1(r,r,1/r[3]),r[0]/=i.worldSize,r[1]/=i.worldSize;const n=i._camera.position,o=e.mercatorZfromAltitude(1,i.center.lat),s=[n[0],n[1],n[2]/o,0],a=e.subtract([],r.slice(0,3),s);e.normalize(a,a);const l=this.raycast(s,a,this._exaggeration);return null!==l&&l?(e.scaleAndAdd(s,s,a,l),s[3]=s[2],s[2]*=o,s):null;}drawDepth(){const t=this.painter,i=t.context,r=this.proxySourceCache,n=Math.ceil(t.width),o=Math.ceil(t.height);if(!this._depthFBO||this._depthFBO.width===n&&this._depthFBO.height===o||(this._depthFBO.destroy(),delete this._depthFBO,delete this._depthTexture),!this._depthFBO){const t=i.gl,r=i.createFramebuffer(n,o,!0);i.activeTexture.set(t.TEXTURE0);const s=new e.Texture(i,{width:n,height:o,data:null},t.RGBA);s.bind(t.NEAREST,t.CLAMP_TO_EDGE),r.colorAttachment.set(s.texture);const a=i.createRenderbuffer(i.gl.DEPTH_COMPONENT16,n,o);r.depthAttachment.set(a),this._depthFBO=r,this._depthTexture=s;}i.bindFramebuffer.set(this._depthFBO.framebuffer),i.viewport.set([0,0,n,o]),function(t,i,r,n){if("globe"===t.transform.projection.name)return;const o=t.context,s=o.gl;o.clear({depth:1});const a=t.useProgram("terrainDepth"),l=new e.DepthMode(s.LESS,e.DepthMode.ReadWrite,t.depthRangeFor3D);for(const t of n){const n=r.getTile(t),c=ti(t.projMatrix,0);i.setupElevationDraw(n,a),a.draw(o,s.TRIANGLES,l,e.StencilMode.disabled,e.ColorMode.unblended,e.CullFaceMode.backCCW,c,"terrain_depth",i.gridBuffer,i.gridIndexBuffer,i.gridNoSkirtSegments);}}(t,this,r,this.proxyCoords);}_setupProxiedCoordsForOrtho(e,t,i){if(e.getSource()instanceof be)return this._setupProxiedCoordsForImageSource(e,t,i);this._findCoveringTileCache[e.id]=this._findCoveringTileCache[e.id]||{};const r=this.proxiedCoords[e.id]=[],n=this.proxyCoords;for(let t=0;t<n.length;t++){const o=n[t],s=this._findTileCoveringTileID(o,e);if(s){const t=this._createProxiedId(o,s,i[o.key]&&i[o.key][e.id]);r.push(t),this.proxyToSource[o.key][e.id]=[t];}}let o=!1;for(let n=0;n<t.length;n++){const s=e.getTile(t[n]);if(!s||!s.hasData())continue;const a=this._findTileCoveringTileID(s.tileID,this.proxySourceCache);if(a&&a.tileID.canonical.z!==s.tileID.canonical.z){const t=this.proxyToSource[a.tileID.key][e.id],n=this._createProxiedId(a.tileID,s,i[a.tileID.key]&&i[a.tileID.key][e.id]);t?t.splice(t.length-1,0,n):this.proxyToSource[a.tileID.key][e.id]=[n],r.push(n),o=!0;}}this._sourceTilesOverlap[e.id]=o;}_setupProxiedCoordsForImageSource(t,i,r){if(!t.getSource().loaded())return;const n=this.proxiedCoords[t.id]=[],o=this.proxyCoords,s=t.getSource(),a=new e.pointGeometry(s.tileID.x,s.tileID.y)._div(1<<s.tileID.z),l=s.coordinates.map(e.MercatorCoordinate.fromLngLat).reduce((e,t)=>(e.min.x=Math.min(e.min.x,t.x-a.x),e.min.y=Math.min(e.min.y,t.y-a.y),e.max.x=Math.max(e.max.x,t.x-a.x),e.max.y=Math.max(e.max.y,t.y-a.y),e),{min:new e.pointGeometry(Number.MAX_VALUE,Number.MAX_VALUE),max:new e.pointGeometry(-Number.MAX_VALUE,-Number.MAX_VALUE)}),c=(t,i)=>{const r=t.wrap+t.canonical.x/(1<<t.canonical.z),n=t.canonical.y/(1<<t.canonical.z),o=e.EXTENT/(1<<t.canonical.z),s=i.wrap+i.canonical.x/(1<<i.canonical.z),a=i.canonical.y/(1<<i.canonical.z);return r+o<s+l.min.x||r>s+l.max.x||n+o<a+l.min.y||n>a+l.max.y;};for(let e=0;e<o.length;e++){const s=o[e];for(let e=0;e<i.length;e++){const o=t.getTile(i[e]);if(!o||!o.hasData())continue;if(c(s,o.tileID))continue;const a=this._createProxiedId(s,o,r[s.key]&&r[s.key][t.id]),l=this.proxyToSource[s.key][t.id];l?l.push(a):this.proxyToSource[s.key][t.id]=[a],n.push(a);}}}_createProxiedId(t,i,r){let n=this.orthoMatrix;if(r){const e=r.find(e=>e.key===i.tileID.key);if(e)return e;}if(i.tileID.key!==t.key){const r=t.canonical.z-i.tileID.canonical.z;let o,s,a;n=e.create();const l=i.tileID.wrap-t.wrap<<t.overscaledZ;r>0?(o=e.EXTENT>>r,s=o*((i.tileID.canonical.x<<r)-t.canonical.x+l),a=o*((i.tileID.canonical.y<<r)-t.canonical.y)):(o=e.EXTENT<<-r,s=e.EXTENT*(i.tileID.canonical.x-(t.canonical.x+l<<-r)),a=e.EXTENT*(i.tileID.canonical.y-(t.canonical.y<<-r))),e.ortho(n,0,o,0,o,0,1),e.translate(n,n,[s,a,0]);}return new ui(i.tileID,t.key,n);}_findTileCoveringTileID(t,i){let r=i.getTile(t);if(r&&r.hasData())return r;const n=this._findCoveringTileCache[i.id],o=n[t.key];if(r=o?i.getTileByID(o):null,r&&r.hasData()||null===o)return r;let s=r?r.tileID:t,a=s.overscaledZ;const l=i.getSource().minzoom,c=[];if(!o){const n=i.getSource().maxzoom;if(t.canonical.z>=n){const r=t.canonical.z-n;i.getSource().reparseOverscaled?(a=Math.max(t.canonical.z+2,i.transform.tileZoom),s=new e.OverscaledTileID(a,t.wrap,n,t.canonical.x>>r,t.canonical.y>>r)):0!==r&&(a=n,s=new e.OverscaledTileID(a,t.wrap,n,t.canonical.x>>r,t.canonical.y>>r));}s.key!==t.key&&(c.push(s.key),r=i.getTile(s));}const h=e=>{c.forEach(t=>{n[t]=e;}),c.length=0;};for(a-=1;a>=l&&(!r||!r.hasData());a--){r&&h(r.tileID.key);const e=s.calculateScaledKey(a);if(r=i.getTileByID(e),r&&r.hasData())break;const t=n[e];if(null===t)break;void 0===t?c.push(e):r=i.getTileByID(t);}return h(r?r.tileID.key:null),r&&r.hasData()?r:null;}findDEMTileFor(e){return this.enabled?this._findTileCoveringTileID(e,this.sourceCache):null;}prepareDrawTile(e){this.renderedToTile=!0;}_clearRenderCacheForTile(e,t){let i=this._tilesDirty[e];i||(i=this._tilesDirty[e]={}),i[t.key]=!0;}getWirefameBuffer(){if(!this.wireframeSegments){const t=function(t){let i,r,n;const o=new e.StructArrayLayout2ui4(),s=131;for(r=1;r<129;r++){for(i=1;i<129;i++)n=r*s+i,o.emplaceBack(n,n+1),o.emplaceBack(n,n+s),o.emplaceBack(n+1,n+s),128===r&&o.emplaceBack(n+s,n+s+1);o.emplaceBack(n+1,n+1+s);}return o;}();this.wireframeIndexBuffer=this.painter.context.createIndexBuffer(t),this.wireframeSegments=e.SegmentVector.simpleSegment(0,0,this.gridBuffer.length,t.length);}return [this.wireframeIndexBuffer,this.wireframeSegments];}}function pi(e){const t=[];for(let i=0;i<e.length;i++){if(null===e[i])continue;const r=e[i].split(" ");t.push(r.pop());}return t;}class fi{static cacheKey(e,t,i){let r=`${e}${i?i.cacheKey:""}`;for(const e of t)r+=`/${e}`;return r;}constructor(t,i,r,n,o,s){const a=t.gl;this.program=a.createProgram();const l=pi(r.staticAttributes),c=n?n.getBinderAttributes():[],h=l.concat(c),u=r.staticUniforms?pi(r.staticUniforms):[],d=n?n.getBinderUniforms():[],p=u.concat(d),f=[];for(const e of p)f.indexOf(e)<0&&f.push(e);let m=n?n.defines():[];m=m.concat(s.map(e=>`#define ${e}`));const _=m.concat("\n#ifdef GL_ES\nprecision mediump float;\n#else\n\n#if !defined(lowp)\n#define lowp\n#endif\n\n#if !defined(mediump)\n#define mediump\n#endif\n\n#if !defined(highp)\n#define highp\n#endif\n\n#endif",qt,Ht.fragmentSource,$t.fragmentSource,r.fragmentSource).join("\n"),g=m.concat("\n#ifdef GL_ES\nprecision highp float;\n#else\n\n#if !defined(lowp)\n#define lowp\n#endif\n\n#if !defined(mediump)\n#define mediump\n#endif\n\n#if !defined(highp)\n#define highp\n#endif\n\n#endif",qt,Ht.vertexSource,$t.vertexSource,jt.vertexSource,r.vertexSource).join("\n"),y=a.createShader(a.FRAGMENT_SHADER);if(a.isContextLost())return void(this.failedToCreate=!0);a.shaderSource(y,_),a.compileShader(y),a.attachShader(this.program,y);const x=a.createShader(a.VERTEX_SHADER);if(a.isContextLost())return void(this.failedToCreate=!0);a.shaderSource(x,g),a.compileShader(x),a.attachShader(this.program,x),this.attributes={};const v={};this.numAttributes=h.length;for(let e=0;e<this.numAttributes;e++)h[e]&&(a.bindAttribLocation(this.program,e,h[e]),this.attributes[h[e]]=e);a.linkProgram(this.program),a.deleteShader(x),a.deleteShader(y);for(let e=0;e<f.length;e++){const t=f[e];if(t&&!v[t]){const e=a.getUniformLocation(this.program,t);e&&(v[t]=e);}}this.fixedUniforms=o(t,v),this.binderUniforms=n?n.getUniforms(t,v):[],-1!==s.indexOf("TERRAIN")&&(this.terrainUniforms=((t,i)=>({u_dem:new e.Uniform1i(t,i.u_dem),u_dem_prev:new e.Uniform1i(t,i.u_dem_prev),u_dem_unpack:new e.Uniform4f(t,i.u_dem_unpack),u_dem_tl:new e.Uniform2f(t,i.u_dem_tl),u_dem_scale:new e.Uniform1f(t,i.u_dem_scale),u_dem_tl_prev:new e.Uniform2f(t,i.u_dem_tl_prev),u_dem_scale_prev:new e.Uniform1f(t,i.u_dem_scale_prev),u_dem_size:new e.Uniform1f(t,i.u_dem_size),u_dem_lerp:new e.Uniform1f(t,i.u_dem_lerp),u_exaggeration:new e.Uniform1f(t,i.u_exaggeration),u_depth:new e.Uniform1i(t,i.u_depth),u_depth_size_inv:new e.Uniform2f(t,i.u_depth_size_inv),u_meter_to_dem:new e.Uniform1f(t,i.u_meter_to_dem),u_label_plane_matrix_inv:new e.UniformMatrix4f(t,i.u_label_plane_matrix_inv),u_tile_tl_up:new e.Uniform3f(t,i.u_tile_tl_up),u_tile_tr_up:new e.Uniform3f(t,i.u_tile_tr_up),u_tile_br_up:new e.Uniform3f(t,i.u_tile_br_up),u_tile_bl_up:new e.Uniform3f(t,i.u_tile_bl_up),u_tile_up_scale:new e.Uniform1f(t,i.u_tile_up_scale)}))(t,v)),-1!==s.indexOf("FOG")&&(this.fogUniforms=((t,i)=>({u_fog_matrix:new e.UniformMatrix4f(t,i.u_fog_matrix),u_fog_range:new e.Uniform2f(t,i.u_fog_range),u_fog_color:new e.Uniform4f(t,i.u_fog_color),u_fog_horizon_blend:new e.Uniform1f(t,i.u_fog_horizon_blend),u_fog_temporal_offset:new e.Uniform1f(t,i.u_fog_temporal_offset)}))(t,v));}setTerrainUniformValues(e,t){if(!this.terrainUniforms)return;const i=this.terrainUniforms;if(!this.failedToCreate){e.program.set(this.program);for(const e in t)i[e].set(t[e]);}}setFogUniformValues(e,t){if(!this.fogUniforms)return;const i=this.fogUniforms;if(!this.failedToCreate){e.program.set(this.program);for(const e in t)i[e].location&&i[e].set(t[e]);}}draw(e,t,i,r,n,o,s,a,l,c,h,u,d,p,f,m){const _=e.gl;if(this.failedToCreate)return;e.program.set(this.program),e.setDepthMode(i),e.setStencilMode(r),e.setColorMode(n),e.setCullFace(o);for(const e of Object.keys(this.fixedUniforms))this.fixedUniforms[e].set(s[e]);p&&p.setUniforms(e,this.binderUniforms,u,{zoom:d});const g={[_.LINES]:2,[_.TRIANGLES]:3,[_.LINE_STRIP]:1}[t];for(const i of h.get()){const r=i.vaos||(i.vaos={});(r[a]||(r[a]=new Wt())).bind(e,this,l,p?p.getPaintVertexBuffers():[],c,i.vertexOffset,f,m),_.drawElements(t,i.primitiveLength*g,_.UNSIGNED_SHORT,i.primitiveOffset*g*2);}}}function mi(e,t,i){const r=1/N(i,1,t.transform.tileZoom),n=Math.pow(2,i.tileID.overscaledZ),o=i.tileSize*Math.pow(2,t.transform.tileZoom)/n,s=o*(i.tileID.canonical.x+i.tileID.wrap*n),a=o*i.tileID.canonical.y;return {u_image:0,u_texsize:i.imageAtlasTexture.size,u_scale:[r,e.fromScale,e.toScale],u_fade:e.t,u_pixel_coord_upper:[s>>16,a>>16],u_pixel_coord_lower:[65535&s,65535&a]};}const _i=(t,i,r,n)=>{const o=i.style.light,s=o.properties.get("position"),a=[s.x,s.y,s.z],l=e.create$1();"viewport"===o.properties.get("anchor")&&(e.fromRotation(l,-i.transform.angle),e.transformMat3(a,a,l));const c=o.properties.get("color");return {u_matrix:t,u_lightpos:a,u_lightintensity:o.properties.get("intensity"),u_lightcolor:[c.r,c.g,c.b],u_vertical_gradient:+r,u_opacity:n};},gi=(t,i,r,n,o,s,a)=>e.extend(_i(t,i,r,n),mi(s,i,a),{u_height_factor:-Math.pow(2,o.overscaledZ)/a.tileSize/8}),yi=e=>({u_matrix:e}),xi=(t,i,r,n)=>e.extend(yi(t),mi(r,i,n)),vi=(e,t)=>({u_matrix:e,u_world:t}),bi=(t,i,r,n,o)=>e.extend(xi(t,i,r,n),{u_world:o}),Si=(t,i,r,n)=>{const o=t.transform;let s;return s="map"===n.paint.get("circle-pitch-alignment")?o.calculatePixelsToTileUnitsMatrix(r):new Float32Array([o.pixelsToGLUnits[0],0,0,o.pixelsToGLUnits[1]]),{u_camera_to_center_distance:o.cameraToCenterDistance,u_matrix:t.translatePosMatrix(i.projMatrix,r,n.paint.get("circle-translate"),n.paint.get("circle-translate-anchor")),u_device_pixel_ratio:e.exported.devicePixelRatio,u_extrude_scale:s};},wi=e=>{const t=[];return "map"===e.paint.get("circle-pitch-alignment")&&t.push("PITCH_WITH_MAP"),"map"===e.paint.get("circle-pitch-scale")&&t.push("SCALE_WITH_MAP"),t;},Ti=(t,i,r)=>{const n=e.EXTENT/r.tileSize;return {u_matrix:t,u_camera_to_center_distance:i.cameraToCenterDistance,u_extrude_scale:[i.pixelsToGLUnits[0]/n,i.pixelsToGLUnits[1]/n]};},Ei=(e,t,i=1)=>({u_matrix:e,u_color:t,u_overlay:0,u_overlay_scale:i}),Ni=(e,t,i,r)=>({u_matrix:e,u_extrude_scale:N(t,1,i),u_intensity:r}),Ii=(t,i,r,n,o,s)=>{const a=t.transform,l=a.calculatePixelsToTileUnitsMatrix(i),c={u_matrix:Ai(t,i,r,o),u_pixels_to_tile_units:l,u_device_pixel_ratio:e.exported.devicePixelRatio,u_units_to_pixels:[1/a.pixelsToGLUnits[0],1/a.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:s,u_texsize:[0,0],u_scale:[0,0,0],u_mix:0,u_alpha_discard_threshold:0};if(Pi(r)){const e=Ci(i,t.transform);c.u_texsize=i.lineAtlasTexture.size,c.u_scale=[e,n.fromScale,n.toScale],c.u_mix=n.t;}return c;},Mi=(t,i,r,n,o)=>{const s=t.transform,a=Ci(i,s);return {u_matrix:Ai(t,i,r,o),u_texsize:i.imageAtlasTexture.size,u_pixels_to_tile_units:s.calculatePixelsToTileUnitsMatrix(i),u_device_pixel_ratio:e.exported.devicePixelRatio,u_image:0,u_scale:[a,n.fromScale,n.toScale],u_fade:n.t,u_units_to_pixels:[1/s.pixelsToGLUnits[0],1/s.pixelsToGLUnits[1]],u_alpha_discard_threshold:0};};function Ci(e,t){return 1/N(e,1,t.tileZoom);}function Ai(e,t,i,r){return e.translatePosMatrix(r||t.tileID.projMatrix,t,i.paint.get("line-translate"),i.paint.get("line-translate-anchor"));}function Pi(e){const t=e.paint.get("line-dasharray").value;return t.value||"constant"!==t.kind;}const Li=(e,t,i,r,n,o)=>{return {u_matrix:e,u_tl_parent:t,u_scale_parent:i,u_fade_t:r.mix,u_opacity:r.opacity*n.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:n.paint.get("raster-brightness-min"),u_brightness_high:n.paint.get("raster-brightness-max"),u_saturation_factor:(a=n.paint.get("raster-saturation"),a>0?1-1/(1.001-a):-a),u_contrast_factor:(s=n.paint.get("raster-contrast"),s>0?1/(1-s):1+s),u_spin_weights:Di(n.paint.get("raster-hue-rotate")),u_perspective_transform:o};var s,a;};function Di(e){e*=Math.PI/180;const t=Math.sin(e),i=Math.cos(e);return [(2*i+1)/3,(-Math.sqrt(3)*t-i+1)/3,(Math.sqrt(3)*t-i+1)/3];}const ki=(e,t,i,r,n,o,s,a,l,c,h,u,d,p)=>{const f=n.transform;return {u_is_size_zoom_constant:+("constant"===e||"source"===e),u_is_size_feature_constant:+("constant"===e||"camera"===e),u_size_t:t?t.uSizeT:0,u_size:t?t.uSize:0,u_camera_to_center_distance:f.cameraToCenterDistance,u_pitch:f.pitch/360*2*Math.PI,u_rotate_symbol:+i,u_aspect_ratio:f.width/f.height,u_fade_change:n.options.fadeDuration?n.symbolFadeChange:1,u_matrix:o,u_label_plane_matrix:s,u_coord_matrix:a,u_is_text:+l,u_pitch_with_map:+r,u_texsize:c,u_tile_id:h,u_zoom_transition:u,u_inv_rot_matrix:d,u_merc_center:p,u_texture:0};},zi=(t,i,r,n,o,s,a,l,c,h,u,d,p,f,m)=>{const{cameraToCenterDistance:_,_pitch:g}=o.transform;return e.extend(ki(t,i,r,n,o,s,a,l,c,h,d,p,f,m),{u_gamma_scale:n?_*Math.cos(o.terrain?0:g):1,u_device_pixel_ratio:e.exported.devicePixelRatio,u_is_halo:+u});},Ri=(t,i,r,n,o,s,a,l,c,h,u,d,p,f)=>e.extend(zi(t,i,r,n,o,s,a,l,!0,c,!0,u,d,p,f),{u_texsize_icon:h,u_texture_icon:1}),Oi=(e,t,i)=>({u_matrix:e,u_opacity:t,u_color:i}),Fi=(t,i,r,n,o,s)=>e.extend(function(e,t,i,r){const n=i.imageManager.getPattern(e.from.toString()),o=i.imageManager.getPattern(e.to.toString()),{width:s,height:a}=i.imageManager.getPixelSize(),l=Math.pow(2,r.tileID.overscaledZ),c=r.tileSize*Math.pow(2,i.transform.tileZoom)/l,h=c*(r.tileID.canonical.x+r.tileID.wrap*l),u=c*r.tileID.canonical.y;return {u_image:0,u_pattern_tl_a:n.tl,u_pattern_br_a:n.br,u_pattern_tl_b:o.tl,u_pattern_br_b:o.br,u_texsize:[s,a],u_mix:t.t,u_pattern_size_a:n.displaySize,u_pattern_size_b:o.displaySize,u_scale_a:t.fromScale,u_scale_b:t.toScale,u_tile_units_to_pixels:1/N(r,1,i.transform.tileZoom),u_pixel_coord_upper:[h>>16,u>>16],u_pixel_coord_lower:[65535&h,65535&u]};}(n,s,r,o),{u_matrix:t,u_opacity:i}),Bi={fillExtrusion:(t,i)=>({u_matrix:new e.UniformMatrix4f(t,i.u_matrix),u_lightpos:new e.Uniform3f(t,i.u_lightpos),u_lightintensity:new e.Uniform1f(t,i.u_lightintensity),u_lightcolor:new e.Uniform3f(t,i.u_lightcolor),u_vertical_gradient:new e.Uniform1f(t,i.u_vertical_gradient),u_opacity:new e.Uniform1f(t,i.u_opacity)}),fillExtrusionPattern:(t,i)=>({u_matrix:new e.UniformMatrix4f(t,i.u_matrix),u_lightpos:new e.Uniform3f(t,i.u_lightpos),u_lightintensity:new e.Uniform1f(t,i.u_lightintensity),u_lightcolor:new e.Uniform3f(t,i.u_lightcolor),u_vertical_gradient:new e.Uniform1f(t,i.u_vertical_gradient),u_height_factor:new e.Uniform1f(t,i.u_height_factor),u_image:new e.Uniform1i(t,i.u_image),u_texsize:new e.Uniform2f(t,i.u_texsize),u_pixel_coord_upper:new e.Uniform2f(t,i.u_pixel_coord_upper),u_pixel_coord_lower:new e.Uniform2f(t,i.u_pixel_coord_lower),u_scale:new e.Uniform3f(t,i.u_scale),u_fade:new e.Uniform1f(t,i.u_fade),u_opacity:new e.Uniform1f(t,i.u_opacity)}),fill:(t,i)=>({u_matrix:new e.UniformMatrix4f(t,i.u_matrix)}),fillPattern:(t,i)=>({u_matrix:new e.UniformMatrix4f(t,i.u_matrix),u_image:new e.Uniform1i(t,i.u_image),u_texsize:new e.Uniform2f(t,i.u_texsize),u_pixel_coord_upper:new e.Uniform2f(t,i.u_pixel_coord_upper),u_pixel_coord_lower:new e.Uniform2f(t,i.u_pixel_coord_lower),u_scale:new e.Uniform3f(t,i.u_scale),u_fade:new e.Uniform1f(t,i.u_fade)}),fillOutline:(t,i)=>({u_matrix:new e.UniformMatrix4f(t,i.u_matrix),u_world:new e.Uniform2f(t,i.u_world)}),fillOutlinePattern:(t,i)=>({u_matrix:new e.UniformMatrix4f(t,i.u_matrix),u_world:new e.Uniform2f(t,i.u_world),u_image:new e.Uniform1i(t,i.u_image),u_texsize:new e.Uniform2f(t,i.u_texsize),u_pixel_coord_upper:new e.Uniform2f(t,i.u_pixel_coord_upper),u_pixel_coord_lower:new e.Uniform2f(t,i.u_pixel_coord_lower),u_scale:new e.Uniform3f(t,i.u_scale),u_fade:new e.Uniform1f(t,i.u_fade)}),circle:(t,i)=>({u_camera_to_center_distance:new e.Uniform1f(t,i.u_camera_to_center_distance),u_extrude_scale:new e.UniformMatrix2f(t,i.u_extrude_scale),u_device_pixel_ratio:new e.Uniform1f(t,i.u_device_pixel_ratio),u_matrix:new e.UniformMatrix4f(t,i.u_matrix)}),collisionBox:(t,i)=>({u_matrix:new e.UniformMatrix4f(t,i.u_matrix),u_camera_to_center_distance:new e.Uniform1f(t,i.u_camera_to_center_distance),u_extrude_scale:new e.Uniform2f(t,i.u_extrude_scale)}),collisionCircle:(t,i)=>({u_matrix:new e.UniformMatrix4f(t,i.u_matrix),u_inv_matrix:new e.UniformMatrix4f(t,i.u_inv_matrix),u_camera_to_center_distance:new e.Uniform1f(t,i.u_camera_to_center_distance),u_viewport_size:new e.Uniform2f(t,i.u_viewport_size)}),debug:(t,i)=>({u_color:new e.UniformColor(t,i.u_color),u_matrix:new e.UniformMatrix4f(t,i.u_matrix),u_overlay:new e.Uniform1i(t,i.u_overlay),u_overlay_scale:new e.Uniform1f(t,i.u_overlay_scale)}),clippingMask:(t,i)=>({u_matrix:new e.UniformMatrix4f(t,i.u_matrix)}),heatmap:(t,i)=>({u_extrude_scale:new e.Uniform1f(t,i.u_extrude_scale),u_intensity:new e.Uniform1f(t,i.u_intensity),u_matrix:new e.UniformMatrix4f(t,i.u_matrix)}),heatmapTexture:(t,i)=>({u_image:new e.Uniform1i(t,i.u_image),u_color_ramp:new e.Uniform1i(t,i.u_color_ramp),u_opacity:new e.Uniform1f(t,i.u_opacity)}),hillshade:(t,i)=>({u_matrix:new e.UniformMatrix4f(t,i.u_matrix),u_image:new e.Uniform1i(t,i.u_image),u_latrange:new e.Uniform2f(t,i.u_latrange),u_light:new e.Uniform2f(t,i.u_light),u_shadow:new e.UniformColor(t,i.u_shadow),u_highlight:new e.UniformColor(t,i.u_highlight),u_accent:new e.UniformColor(t,i.u_accent)}),hillshadePrepare:(t,i)=>({u_matrix:new e.UniformMatrix4f(t,i.u_matrix),u_image:new e.Uniform1i(t,i.u_image),u_dimension:new e.Uniform2f(t,i.u_dimension),u_zoom:new e.Uniform1f(t,i.u_zoom),u_unpack:new e.Uniform4f(t,i.u_unpack)}),line:(t,i)=>({u_matrix:new e.UniformMatrix4f(t,i.u_matrix),u_pixels_to_tile_units:new e.UniformMatrix2f(t,i.u_pixels_to_tile_units),u_device_pixel_ratio:new e.Uniform1f(t,i.u_device_pixel_ratio),u_units_to_pixels:new e.Uniform2f(t,i.u_units_to_pixels),u_dash_image:new e.Uniform1i(t,i.u_dash_image),u_gradient_image:new e.Uniform1i(t,i.u_gradient_image),u_image_height:new e.Uniform1f(t,i.u_image_height),u_texsize:new e.Uniform2f(t,i.u_texsize),u_scale:new e.Uniform3f(t,i.u_scale),u_mix:new e.Uniform1f(t,i.u_mix),u_alpha_discard_threshold:new e.Uniform1f(t,i.u_alpha_discard_threshold)}),linePattern:(t,i)=>({u_matrix:new e.UniformMatrix4f(t,i.u_matrix),u_texsize:new e.Uniform2f(t,i.u_texsize),u_pixels_to_tile_units:new e.UniformMatrix2f(t,i.u_pixels_to_tile_units),u_device_pixel_ratio:new e.Uniform1f(t,i.u_device_pixel_ratio),u_image:new e.Uniform1i(t,i.u_image),u_units_to_pixels:new e.Uniform2f(t,i.u_units_to_pixels),u_scale:new e.Uniform3f(t,i.u_scale),u_fade:new e.Uniform1f(t,i.u_fade),u_alpha_discard_threshold:new e.Uniform1f(t,i.u_alpha_discard_threshold)}),raster:(t,i)=>({u_matrix:new e.UniformMatrix4f(t,i.u_matrix),u_tl_parent:new e.Uniform2f(t,i.u_tl_parent),u_scale_parent:new e.Uniform1f(t,i.u_scale_parent),u_fade_t:new e.Uniform1f(t,i.u_fade_t),u_opacity:new e.Uniform1f(t,i.u_opacity),u_image0:new e.Uniform1i(t,i.u_image0),u_image1:new e.Uniform1i(t,i.u_image1),u_brightness_low:new e.Uniform1f(t,i.u_brightness_low),u_brightness_high:new e.Uniform1f(t,i.u_brightness_high),u_saturation_factor:new e.Uniform1f(t,i.u_saturation_factor),u_contrast_factor:new e.Uniform1f(t,i.u_contrast_factor),u_spin_weights:new e.Uniform3f(t,i.u_spin_weights),u_perspective_transform:new e.Uniform2f(t,i.u_perspective_transform)}),symbolIcon:(t,i)=>({u_is_size_zoom_constant:new e.Uniform1i(t,i.u_is_size_zoom_constant),u_is_size_feature_constant:new e.Uniform1i(t,i.u_is_size_feature_constant),u_size_t:new e.Uniform1f(t,i.u_size_t),u_size:new e.Uniform1f(t,i.u_size),u_camera_to_center_distance:new e.Uniform1f(t,i.u_camera_to_center_distance),u_pitch:new e.Uniform1f(t,i.u_pitch),u_rotate_symbol:new e.Uniform1i(t,i.u_rotate_symbol),u_aspect_ratio:new e.Uniform1f(t,i.u_aspect_ratio),u_fade_change:new e.Uniform1f(t,i.u_fade_change),u_matrix:new e.UniformMatrix4f(t,i.u_matrix),u_label_plane_matrix:new e.UniformMatrix4f(t,i.u_label_plane_matrix),u_coord_matrix:new e.UniformMatrix4f(t,i.u_coord_matrix),u_is_text:new e.Uniform1i(t,i.u_is_text),u_pitch_with_map:new e.Uniform1i(t,i.u_pitch_with_map),u_texsize:new e.Uniform2f(t,i.u_texsize),u_tile_id:new e.Uniform3f(t,i.u_tile_id),u_zoom_transition:new e.Uniform1f(t,i.u_zoom_transition),u_inv_rot_matrix:new e.UniformMatrix4f(t,i.u_inv_rot_matrix),u_merc_center:new e.Uniform2f(t,i.u_merc_center),u_texture:new e.Uniform1i(t,i.u_texture)}),symbolSDF:(t,i)=>({u_is_size_zoom_constant:new e.Uniform1i(t,i.u_is_size_zoom_constant),u_is_size_feature_constant:new e.Uniform1i(t,i.u_is_size_feature_constant),u_size_t:new e.Uniform1f(t,i.u_size_t),u_size:new e.Uniform1f(t,i.u_size),u_camera_to_center_distance:new e.Uniform1f(t,i.u_camera_to_center_distance),u_pitch:new e.Uniform1f(t,i.u_pitch),u_rotate_symbol:new e.Uniform1i(t,i.u_rotate_symbol),u_aspect_ratio:new e.Uniform1f(t,i.u_aspect_ratio),u_fade_change:new e.Uniform1f(t,i.u_fade_change),u_matrix:new e.UniformMatrix4f(t,i.u_matrix),u_label_plane_matrix:new e.UniformMatrix4f(t,i.u_label_plane_matrix),u_coord_matrix:new e.UniformMatrix4f(t,i.u_coord_matrix),u_is_text:new e.Uniform1i(t,i.u_is_text),u_pitch_with_map:new e.Uniform1i(t,i.u_pitch_with_map),u_texsize:new e.Uniform2f(t,i.u_texsize),u_texture:new e.Uniform1i(t,i.u_texture),u_gamma_scale:new e.Uniform1f(t,i.u_gamma_scale),u_device_pixel_ratio:new e.Uniform1f(t,i.u_device_pixel_ratio),u_tile_id:new e.Uniform3f(t,i.u_tile_id),u_zoom_transition:new e.Uniform1f(t,i.u_zoom_transition),u_inv_rot_matrix:new e.UniformMatrix4f(t,i.u_inv_rot_matrix),u_merc_center:new e.Uniform2f(t,i.u_merc_center),u_is_halo:new e.Uniform1i(t,i.u_is_halo)}),symbolTextAndIcon:(t,i)=>({u_is_size_zoom_constant:new e.Uniform1i(t,i.u_is_size_zoom_constant),u_is_size_feature_constant:new e.Uniform1i(t,i.u_is_size_feature_constant),u_size_t:new e.Uniform1f(t,i.u_size_t),u_size:new e.Uniform1f(t,i.u_size),u_camera_to_center_distance:new e.Uniform1f(t,i.u_camera_to_center_distance),u_pitch:new e.Uniform1f(t,i.u_pitch),u_rotate_symbol:new e.Uniform1i(t,i.u_rotate_symbol),u_aspect_ratio:new e.Uniform1f(t,i.u_aspect_ratio),u_fade_change:new e.Uniform1f(t,i.u_fade_change),u_matrix:new e.UniformMatrix4f(t,i.u_matrix),u_label_plane_matrix:new e.UniformMatrix4f(t,i.u_label_plane_matrix),u_coord_matrix:new e.UniformMatrix4f(t,i.u_coord_matrix),u_is_text:new e.Uniform1i(t,i.u_is_text),u_pitch_with_map:new e.Uniform1i(t,i.u_pitch_with_map),u_texsize:new e.Uniform2f(t,i.u_texsize),u_texsize_icon:new e.Uniform2f(t,i.u_texsize_icon),u_texture:new e.Uniform1i(t,i.u_texture),u_texture_icon:new e.Uniform1i(t,i.u_texture_icon),u_gamma_scale:new e.Uniform1f(t,i.u_gamma_scale),u_device_pixel_ratio:new e.Uniform1f(t,i.u_device_pixel_ratio),u_is_halo:new e.Uniform1i(t,i.u_is_halo)}),background:(t,i)=>({u_matrix:new e.UniformMatrix4f(t,i.u_matrix),u_opacity:new e.Uniform1f(t,i.u_opacity),u_color:new e.UniformColor(t,i.u_color)}),backgroundPattern:(t,i)=>({u_matrix:new e.UniformMatrix4f(t,i.u_matrix),u_opacity:new e.Uniform1f(t,i.u_opacity),u_image:new e.Uniform1i(t,i.u_image),u_pattern_tl_a:new e.Uniform2f(t,i.u_pattern_tl_a),u_pattern_br_a:new e.Uniform2f(t,i.u_pattern_br_a),u_pattern_tl_b:new e.Uniform2f(t,i.u_pattern_tl_b),u_pattern_br_b:new e.Uniform2f(t,i.u_pattern_br_b),u_texsize:new e.Uniform2f(t,i.u_texsize),u_mix:new e.Uniform1f(t,i.u_mix),u_pattern_size_a:new e.Uniform2f(t,i.u_pattern_size_a),u_pattern_size_b:new e.Uniform2f(t,i.u_pattern_size_b),u_scale_a:new e.Uniform1f(t,i.u_scale_a),u_scale_b:new e.Uniform1f(t,i.u_scale_b),u_pixel_coord_upper:new e.Uniform2f(t,i.u_pixel_coord_upper),u_pixel_coord_lower:new e.Uniform2f(t,i.u_pixel_coord_lower),u_tile_units_to_pixels:new e.Uniform1f(t,i.u_tile_units_to_pixels)}),terrainRaster:ei,terrainDepth:ei,skybox:(t,i)=>({u_matrix:new e.UniformMatrix4f(t,i.u_matrix),u_sun_direction:new e.Uniform3f(t,i.u_sun_direction),u_cubemap:new e.Uniform1i(t,i.u_cubemap),u_opacity:new e.Uniform1f(t,i.u_opacity),u_temporal_offset:new e.Uniform1f(t,i.u_temporal_offset)}),skyboxGradient:(t,i)=>({u_matrix:new e.UniformMatrix4f(t,i.u_matrix),u_color_ramp:new e.Uniform1i(t,i.u_color_ramp),u_center_direction:new e.Uniform3f(t,i.u_center_direction),u_radius:new e.Uniform1f(t,i.u_radius),u_opacity:new e.Uniform1f(t,i.u_opacity),u_temporal_offset:new e.Uniform1f(t,i.u_temporal_offset)}),skyboxCapture:(t,i)=>({u_matrix_3f:new e.UniformMatrix3f(t,i.u_matrix_3f),u_sun_direction:new e.Uniform3f(t,i.u_sun_direction),u_sun_intensity:new e.Uniform1f(t,i.u_sun_intensity),u_color_tint_r:new e.Uniform4f(t,i.u_color_tint_r),u_color_tint_m:new e.Uniform4f(t,i.u_color_tint_m),u_luminance:new e.Uniform1f(t,i.u_luminance)}),globeRaster:(t,i)=>({u_proj_matrix:new e.UniformMatrix4f(t,i.u_proj_matrix),u_globe_matrix:new e.UniformMatrix4f(t,i.u_globe_matrix),u_merc_matrix:new e.UniformMatrix4f(t,i.u_merc_matrix),u_zoom_transition:new e.Uniform1f(t,i.u_zoom_transition),u_merc_center:new e.Uniform2f(t,i.u_merc_center),u_image0:new e.Uniform1i(t,i.u_image0)}),globeAtmosphere:(t,i)=>({u_center:new e.Uniform2f(t,i.u_center),u_radius:new e.Uniform1f(t,i.u_radius),u_screen_size:new e.Uniform2f(t,i.u_screen_size),u_pixel_ratio:new e.Uniform1f(t,i.u_pixel_ratio),u_opacity:new e.Uniform1f(t,i.u_opacity),u_fadeout_range:new e.Uniform1f(t,i.u_fadeout_range),u_start_color:new e.Uniform3f(t,i.u_start_color),u_end_color:new e.Uniform3f(t,i.u_end_color)})};let Ui;function Vi(t,i,r,n,o,s,a){const l=t.context,c=l.gl,h=t.useProgram("collisionBox"),u=[];let d=0,p=0;for(let f=0;f<n.length;f++){const m=n[f],_=i.getTile(m),g=_.getBucket(r);if(!g)continue;let y=m.projMatrix;0===o[0]&&0===o[1]||(y=t.translatePosMatrix(m.projMatrix,_,o,s));const x=a?g.textCollisionBox:g.iconCollisionBox,v=g.collisionCircleArray;if(v.length>0){const i=e.create(),r=y;e.mul(i,g.placementInvProjMatrix,t.transform.glCoordMatrix),e.mul(i,i,g.placementViewportMatrix),u.push({circleArray:v,circleOffset:p,transform:r,invTransform:i}),d+=v.length/4,p=d;}x&&(t.terrain&&t.terrain.setupElevationDraw(_,h),h.draw(l,c.LINES,e.DepthMode.disabled,e.StencilMode.disabled,t.colorModeForRenderPass(),e.CullFaceMode.disabled,Ti(y,t.transform,_),r.id,x.layoutVertexBuffer,x.indexBuffer,x.segments,null,t.transform.zoom,null,x.collisionVertexBuffer,x.collisionVertexBufferExt));}if(!a||!u.length)return;const f=t.useProgram("collisionCircle"),m=new e.StructArrayLayout2f1f2i16();m.resize(4*d),m._trim();let _=0;for(const e of u)for(let t=0;t<e.circleArray.length/4;t++){const i=4*t,r=e.circleArray[i+0],n=e.circleArray[i+1],o=e.circleArray[i+2],s=e.circleArray[i+3];m.emplace(_++,r,n,o,s,0),m.emplace(_++,r,n,o,s,1),m.emplace(_++,r,n,o,s,2),m.emplace(_++,r,n,o,s,3);}(!Ui||Ui.length<2*d)&&(Ui=function(t){const i=2*t,r=new e.StructArrayLayout3ui6();r.resize(i),r._trim();for(let e=0;e<i;e++){const t=6*e;r.uint16[t+0]=4*e+0,r.uint16[t+1]=4*e+1,r.uint16[t+2]=4*e+2,r.uint16[t+3]=4*e+2,r.uint16[t+4]=4*e+3,r.uint16[t+5]=4*e+0;}return r;}(d));const g=l.createIndexBuffer(Ui,!0),y=l.createVertexBuffer(m,e.collisionCircleLayout.members,!0);for(const i of u){const n={u_matrix:i.transform,u_inv_matrix:i.invTransform,u_camera_to_center_distance:(x=t.transform).cameraToCenterDistance,u_viewport_size:[x.width,x.height]};f.draw(l,c.TRIANGLES,e.DepthMode.disabled,e.StencilMode.disabled,t.colorModeForRenderPass(),e.CullFaceMode.disabled,n,r.id,y,g,e.SegmentVector.simpleSegment(0,2*i.circleOffset,i.circleArray.length,i.circleArray.length/2),null,t.transform.zoom,null,null,null);}var x;y.destroy(),g.destroy();}const Gi=e.identity(new Float32Array(16));function ji(t,i,r,n,o,s){const{horizontalAlign:a,verticalAlign:l}=e.getAnchorAlignment(t),c=-(a-.5)*i,h=-(l-.5)*r,u=e.evaluateVariableOffset(t,n);return new e.pointGeometry((c/o+u[0])*s,(h/o+u[1])*s);}function $i(t,i,r,n,o,s,a,l,c,h,u,d){const p=t.text.placedSymbolArray,f=t.text.dynamicLayoutVertexArray,m=t.icon.dynamicLayoutVertexArray,_={},g=l.projMatrix,y=s.elevation,x=y?y.getAtTileOffsetFunc(l,d):e=>[0,0,0];f.clear();for(let l=0;l<p.length;l++){const d=p.get(l),m=t.allowVerticalPlacement&&!d.placedOrientation,y=d.hidden||!d.crossTileID||m?null:n[d.crossTileID];if(y){const n=new e.pointGeometry(d.tileAnchorX,d.tileAnchorY),l=x(n),p=Xe(n,r?g:a,l[2]),m=We(s.cameraToCenterDistance,p.signedDistanceFromCamera);let v=o.evaluateSizeForFeature(t.textSizeData,h,d)*m/e.ONE_EM;r&&(v*=t.tilePixelRatio/c);const{width:b,height:S,anchor:w,textOffset:T,textScale:E}=y,N=ji(w,b,S,T,E,v),I=r?Xe(n.add(N),a,l[2]).point:p.point.add(i?N.rotate(-s.angle):N),M=t.allowVerticalPlacement&&d.placedOrientation===e.WritingMode.vertical?Math.PI/2:0;for(let t=0;t<d.numGlyphs;t++)e.addDynamicAttributes(f,I,M);u&&d.associatedIconIndex>=0&&(_[d.associatedIconIndex]={shiftedAnchor:I,angle:M});}else ot(d.numGlyphs,f);}if(u){m.clear();const i=t.icon.placedSymbolArray;for(let t=0;t<i.length;t++){const r=i.get(t);if(r.hidden)ot(r.numGlyphs,m);else {const i=_[t];if(i)for(let t=0;t<r.numGlyphs;t++)e.addDynamicAttributes(m,i.shiftedAnchor,i.angle);else ot(r.numGlyphs,m);}}t.icon.dynamicLayoutVertexBuffer.updateData(m);}t.text.dynamicLayoutVertexBuffer.updateData(f);}function Hi(e,t,i){return i.iconsInText&&t?"symbolTextAndIcon":e?"symbolSDF":"symbolIcon";}function qi(t,i,r,n,o,s,a,l,c,h,u,d){const p=t.context,f=p.gl,m=t.transform,_=m.projection.createTileTransform(m,m.worldSize),g="map"===l,y="map"===c,x=g&&"point"!==r.layout.get("symbol-placement"),v=g&&!y&&!x,b=void 0!==r.layout.get("symbol-sort-key").constantOr(1);let S=!1;const w=t.depthModeForSublayer(0,e.DepthMode.ReadOnly),T=[e.mercatorXfromLng(m.center.lng),e.mercatorYfromLat(m.center.lat)],E=r.layout.get("text-variable-anchor"),N="globe"===m.projection.name,I=N?e.globeToMercatorTransition(m.zoom):0,M=[],C=[];t.terrain&&y&&C.push("PITCH_WITH_MAP_TERRAIN"),N&&C.push("PROJECTION_GLOBE_VIEW"),x&&C.push("PROJECTED_POS_ON_VIEWPORT");for(const l of n){const n=i.getTile(l),c=n.getBucket(r);if(!c||c.projection!==m.projection.name)continue;const u=o?c.text:c.icon;if(!u||c.fullyClipped||!u.segments.get().length)continue;const d=u.programConfigurations.get(r.id),p=o||c.sdfIcons,w=o?c.textSizeData:c.iconSizeData,N=y||0!==m.pitch,A=t.useProgram(Hi(p,o,c),d,C),P=e.evaluateSizeForZoom(w,m.zoom),L=[l.canonical.x,l.canonical.y,1<<l.canonical.z];let D,k,z,R,O=[0,0],F=null;if(o){if(k=n.glyphAtlasTexture,z=f.LINEAR,D=n.glyphAtlasTexture.size,c.iconsInText){O=n.imageAtlasTexture.size,F=n.imageAtlasTexture;const e="composite"===w.kind||"camera"===w.kind;R=N||t.options.rotating||t.options.zooming||e?f.LINEAR:f.NEAREST;}}else {const e=1!==r.layout.get("icon-size").constantOr(0)||c.iconsNeedLinear;k=n.imageAtlasTexture,z=p||t.options.rotating||t.options.zooming||e||N?f.LINEAR:f.NEAREST,D=n.imageAtlasTexture.size;}const B=t.transform.calculatePixelsToTileUnitsMatrix(n),U=qe(l.projMatrix,n.tileID.canonical,y,g,t.transform,B),V=t.terrain&&y&&x?e.invert(new Float32Array(16),U):Gi,G=Ze(l.projMatrix,n.tileID.canonical,y,g,t.transform,B),j=E&&c.hasTextData(),$="none"!==r.layout.get("icon-text-fit")&&j&&c.hasIconData();if(x){const e=m.elevation,i=e?e.getAtTileOffsetFunc(l,_):e=>[0,0,0];Je(c,l.projMatrix,t,o,U,G,y,h,i,l);}const H=t.translatePosMatrix(l.projMatrix,n,s,a),q=x||o&&E||$?Gi:U,Z=t.translatePosMatrix(G,n,s,a,!0),X=p&&0!==r.paint.get(o?"text-halo-width":"icon-halo-width").constantOr(1);let W;const Y=_.createInversionMatrix(l.toUnwrapped());W=p?c.iconsInText?Ri(w.kind,P,v,y,t,H,q,Z,D,O,L,I,Y,T):zi(w.kind,P,v,y,t,H,q,Z,o,D,!0,L,I,Y,T):ki(w.kind,P,v,y,t,H,q,Z,o,D,L,I,Y,T);const J={program:A,buffers:u,uniformValues:W,atlasTexture:k,atlasTextureIcon:F,atlasInterpolation:z,atlasInterpolationIcon:R,isSDF:p,hasHalo:X,tile:n,labelPlaneMatrixInv:V};if(b&&c.canOverlap){S=!0;const t=u.segments.get();for(const i of t)M.push({segments:new e.SegmentVector([i]),sortKey:i.sortKey,state:J});}else M.push({segments:u.segments,sortKey:0,state:J});}S&&M.sort((e,t)=>e.sortKey-t.sortKey);for(const e of M){const i=e.state;if(t.terrain&&t.terrain.setupElevationDraw(i.tile,i.program,{useDepthForOcclusion:!N,labelPlaneMatrixInv:i.labelPlaneMatrixInv}),p.activeTexture.set(f.TEXTURE0),i.atlasTexture.bind(i.atlasInterpolation,f.CLAMP_TO_EDGE),i.atlasTextureIcon&&(p.activeTexture.set(f.TEXTURE1),i.atlasTextureIcon&&i.atlasTextureIcon.bind(i.atlasInterpolationIcon,f.CLAMP_TO_EDGE)),i.isSDF){const n=i.uniformValues;i.hasHalo&&(n.u_is_halo=1,Zi(i.buffers,e.segments,r,t,i.program,w,u,d,n)),n.u_is_halo=0;}Zi(i.buffers,e.segments,r,t,i.program,w,u,d,i.uniformValues);}}function Zi(t,i,r,n,o,s,a,l,c){const h=n.context;o.draw(h,h.gl.TRIANGLES,s,a,l,e.CullFaceMode.disabled,c,r.id,t.layoutVertexBuffer,t.indexBuffer,i,r.paint,n.transform.zoom,t.programConfigurations.get(r.id),t.dynamicLayoutVertexBuffer,t.opacityVertexBuffer);}function Xi(t,i,r,n,o,s,a){const l=t.context.gl,c=r.paint.get("fill-pattern"),h=c&&c.constantOr(1),u=r.getCrossfadeParameters();let d,p,f,m,_;a?(p=h&&!r.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",d=l.LINES):(p=h?"fillPattern":"fill",d=l.TRIANGLES);for(const g of n){const n=i.getTile(g);if(h&&!n.patternsLoaded())continue;const y=n.getBucket(r);if(!y)continue;t.prepareDrawTile(g);const x=y.programConfigurations.get(r.id),v=t.useProgram(p,x);h&&(t.context.activeTexture.set(l.TEXTURE0),n.imageAtlasTexture.bind(l.LINEAR,l.CLAMP_TO_EDGE),x.updatePaintBuffers(u));const b=c.constantOr(null);if(b&&n.imageAtlas){const e=n.imageAtlas,t=e.patternPositions[b.to.toString()],i=e.patternPositions[b.from.toString()];t&&i&&x.setConstantPatternPositions(t,i);}const S=t.translatePosMatrix(g.projMatrix,n,r.paint.get("fill-translate"),r.paint.get("fill-translate-anchor"));if(a){m=y.indexBuffer2,_=y.segments2;const e=t.terrain&&t.terrain.renderingToTexture?t.terrain.drapeBufferSize:[l.drawingBufferWidth,l.drawingBufferHeight];f="fillOutlinePattern"===p&&h?bi(S,t,u,n,e):vi(S,e);}else m=y.indexBuffer,_=y.segments,f=h?xi(S,t,u,n):yi(S);t.prepareDrawProgram(t.context,v,g.toUnwrapped()),v.draw(t.context,d,o,t.stencilModeForClipping(g),s,e.CullFaceMode.disabled,f,r.id,y.layoutVertexBuffer,m,_,r.paint,t.transform.zoom,x);}}function Wi(t,i,r,n,o,s,a){const l=t.context,c=l.gl,h=r.paint.get("fill-extrusion-pattern"),u=h.constantOr(1),d=r.getCrossfadeParameters(),p=r.paint.get("fill-extrusion-opacity");for(const f of n){const n=i.getTile(f),m=n.getBucket(r);if(!m)continue;const _=m.programConfigurations.get(r.id),g=t.useProgram(u?"fillExtrusionPattern":"fillExtrusion",_);if(t.terrain){const e=t.terrain;if(!m.enableTerrain)continue;if(e.setupElevationDraw(n,g,{useMeterToDem:!0}),Yi(l,i,f,m,r,e),!m.centroidVertexBuffer){const e=g.attributes.a_centroid_pos;void 0!==e&&c.vertexAttrib2f(e,0,0);}}u&&(t.context.activeTexture.set(c.TEXTURE0),n.imageAtlasTexture.bind(c.LINEAR,c.CLAMP_TO_EDGE),_.updatePaintBuffers(d));const y=h.constantOr(null);if(y&&n.imageAtlas){const e=n.imageAtlas,t=e.patternPositions[y.to.toString()],i=e.patternPositions[y.from.toString()];t&&i&&_.setConstantPatternPositions(t,i);}const x=t.translatePosMatrix(f.projMatrix,n,r.paint.get("fill-extrusion-translate"),r.paint.get("fill-extrusion-translate-anchor")),v=r.paint.get("fill-extrusion-vertical-gradient"),b=u?gi(x,t,v,p,f,d,n):_i(x,t,v,p);t.prepareDrawProgram(l,g,f.toUnwrapped()),g.draw(l,l.gl.TRIANGLES,o,s,a,e.CullFaceMode.backCCW,b,r.id,m.layoutVertexBuffer,m.indexBuffer,m.segments,r.paint,t.transform.zoom,_,t.terrain?m.centroidVertexBuffer:null);}}function Yi(t,i,r,n,o,s){const a=[t=>{let i=t.canonical.x-1,r=t.wrap;return i<0&&(i=(1<<t.canonical.z)-1,r--),new e.OverscaledTileID(t.overscaledZ,r,t.canonical.z,i,t.canonical.y);},t=>{let i=t.canonical.x+1,r=t.wrap;return i===1<<t.canonical.z&&(i=0,r++),new e.OverscaledTileID(t.overscaledZ,r,t.canonical.z,i,t.canonical.y);},t=>new e.OverscaledTileID(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,(0===t.canonical.y?1<<t.canonical.z:t.canonical.y)-1),t=>new e.OverscaledTileID(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y===(1<<t.canonical.z)-1?0:t.canonical.y+1)],l=e=>{const t=i.getSource().maxzoom,r=e=>{const t=i.getTileByID(e);if(t&&t.hasData())return t.getBucket(o);};let n,s,a;return (e.overscaledZ===e.canonical.z||e.overscaledZ>=t)&&(n=r(e.key)),e.overscaledZ>=t&&(s=r(e.calculateScaledKey(e.overscaledZ+1))),e.overscaledZ>t&&(a=r(e.calculateScaledKey(e.overscaledZ-1))),n||s||a;},c=[0,0,0],h=(t,i)=>(c[0]=Math.min(t.min.y,i.min.y),c[1]=Math.max(t.max.y,i.max.y),c[2]=e.EXTENT-i.min.x>t.max.x?i.min.x-e.EXTENT:t.max.x,c),u=(t,i)=>(c[0]=Math.min(t.min.x,i.min.x),c[1]=Math.max(t.max.x,i.max.x),c[2]=e.EXTENT-i.min.y>t.max.y?i.min.y-e.EXTENT:t.max.y,c),d=[(e,t)=>h(e,t),(e,t)=>h(t,e),(e,t)=>u(e,t),(e,t)=>u(t,e)],p=new e.pointGeometry(0,0);let f,m,_;const g=(t,i,n,o,a)=>{const l=[[o?n:t,o?t:n,0],[o?n:i,o?i:n,0]],c=a<0?e.EXTENT+a:a,h=[o?c:(t+i)/2,o?(t+i)/2:c,0];return 0===n&&a<0||0!==n&&a>0?s.getForTilePoints(_,[h],!0,m):l.push(h),s.getForTilePoints(r,l,!0,f),Math.max(l[0][2],l[1][2],h[2])/s.exaggeration();};for(let t=0;t<4;t++){const i=n.borders[t];if(0===i.length&&(n.borderDone[t]=!0),n.borderDone[t])continue;const o=_=a[t](r),c=l(o);if(!c||!c.enableTerrain)continue;if(m=s.findDEMTileFor(o),!m||!m.dem)continue;if(!f){const e=s.findDEMTileFor(r);if(!e||!e.dem)return;f=e;}const h=(t<2?1:5)-t,u=c.borders[h];let y=0;for(let r=0;r<i.length;r++){const o=n.featuresOnBorder[i[r]],s=o.borders[t];let a;for(;y<u.length&&(a=c.featuresOnBorder[u[y]],!(a.borders[h][1]>s[0]+3));)c.borderDone[h]||c.encodeCentroid(void 0,a,!1),y++;if(a&&y<u.length){const i=y;let r=0;for(;!(a.borders[h][0]>s[1]-3)&&(r++,++y!==u.length);)a=c.featuresOnBorder[u[y]];if(a=c.featuresOnBorder[u[i]],o.intersectsCount()>1||a.intersectsCount()>1||1!==r){1!==r&&(y=i),n.encodeCentroid(void 0,o,!1),c.borderDone[h]||c.encodeCentroid(void 0,a,!1);continue;}const l=d[t](o,a),f=t%2?e.EXTENT-1:0;p.x=g(l[0],Math.min(e.EXTENT-1,l[1]),f,t<2,l[2]),p.y=0,n.encodeCentroid(p,o,!1),c.borderDone[h]||c.encodeCentroid(p,a,!1);}else n.encodeCentroid(void 0,o,!1);}n.borderDone[t]=n.needsCentroidUpdate=!0,c.borderDone[h]||(c.borderDone[h]=c.needsCentroidUpdate=!0);}(n.needsCentroidUpdate||!n.centroidVertexBuffer&&0!==n.centroidVertexArray.length)&&n.uploadCentroid(t);}const Ji=new e.Color(1,0,0,1),Ki=new e.Color(0,1,0,1),Qi=new e.Color(0,0,1,1),er=new e.Color(1,0,1,1),tr=new e.Color(0,1,1,1);function ir(e,t,i,r){nr(e,0,t+i/2,e.transform.width,i,r);}function rr(e,t,i,r){nr(e,t-i/2,0,i,e.transform.height,r);}function nr(t,i,r,n,o,s){const a=t.context,l=a.gl;l.enable(l.SCISSOR_TEST),l.scissor(i*e.exported.devicePixelRatio,r*e.exported.devicePixelRatio,n*e.exported.devicePixelRatio,o*e.exported.devicePixelRatio),a.clear({color:s}),l.disable(l.SCISSOR_TEST);}function or(t,i,r){const n=t.context,o=n.gl,s=r.projMatrix,a=t.useProgram("debug"),l=i.getTileByID(r.key);t.terrain&&t.terrain.setupElevationDraw(l,a);const c=e.DepthMode.disabled,h=e.StencilMode.disabled,u=t.colorModeForRenderPass(),d="$debug";n.activeTexture.set(o.TEXTURE0),t.emptyTexture.bind(o.LINEAR,o.CLAMP_TO_EDGE),l._makeDebugTileBoundsBuffers(t.context,t.transform.projection);const p=l._tileDebugBuffer||t.debugBuffer,f=l._tileDebugIndexBuffer||t.debugIndexBuffer,m=l._tileDebugSegments||t.debugSegments;a.draw(n,o.LINE_STRIP,c,h,u,e.CullFaceMode.disabled,Ei(s,e.Color.red),d,p,f,m);const _=l.latestRawTileData,g=Math.floor((_&&_.byteLength||0)/1024),y=i.getTile(r).tileSize,x=512/Math.min(y,512)*(r.overscaledZ/t.transform.zoom)*.5;let v=r.canonical.toString();r.overscaledZ!==r.canonical.z&&(v+=` => ${r.overscaledZ}`),function(e,t){e.initDebugOverlayCanvas();const i=e.debugOverlayCanvas,r=e.context.gl,n=e.debugOverlayCanvas.getContext("2d");n.clearRect(0,0,i.width,i.height),n.shadowColor="white",n.shadowBlur=2,n.lineWidth=1.5,n.strokeStyle="white",n.textBaseline="top",n.font="bold 36px Open Sans, sans-serif",n.fillText(t,5,5),n.strokeText(t,5,5),e.debugOverlayTexture.update(i),e.debugOverlayTexture.bind(r.LINEAR,r.CLAMP_TO_EDGE);}(t,`${v} ${g}kb`),a.draw(n,o.TRIANGLES,c,h,e.ColorMode.alphaBlended,e.CullFaceMode.disabled,Ei(s,e.Color.transparent,x),d,t.debugBuffer,t.quadTriangleIndexBuffer,t.debugSegments);}const sr=e.createLayout([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:ar}=sr;function lr(e,t,i,r){e.emplaceBack(t,i,r);}class cr{constructor(t){this.vertexArray=new e.StructArrayLayout3f12(),this.indices=new e.StructArrayLayout3ui6(),lr(this.vertexArray,-1,-1,1),lr(this.vertexArray,1,-1,1),lr(this.vertexArray,-1,1,1),lr(this.vertexArray,1,1,1),lr(this.vertexArray,-1,-1,-1),lr(this.vertexArray,1,-1,-1),lr(this.vertexArray,-1,1,-1),lr(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=t.createVertexBuffer(this.vertexArray,ar),this.indexBuffer=t.createIndexBuffer(this.indices),this.segment=e.SegmentVector.simpleSegment(0,0,36,12);}}function hr(t,i,r,n,o,s){const a=t.gl,l=i.paint.get("sky-atmosphere-color"),c=i.paint.get("sky-atmosphere-halo-color"),h=i.paint.get("sky-atmosphere-sun-intensity"),u=((e,t,i,r,n)=>({u_matrix_3f:e,u_sun_direction:t,u_sun_intensity:i,u_color_tint_r:[r.r,r.g,r.b,r.a],u_color_tint_m:[n.r,n.g,n.b,n.a],u_luminance:5e-5}))(e.fromMat4([],n),o,h,l,c);a.framebufferTexture2D(a.FRAMEBUFFER,a.COLOR_ATTACHMENT0,a.TEXTURE_CUBE_MAP_POSITIVE_X+s,i.skyboxTexture,0),r.draw(t,a.TRIANGLES,e.DepthMode.disabled,e.StencilMode.disabled,e.ColorMode.unblended,e.CullFaceMode.frontCW,u,"skyboxCapture",i.skyboxGeometry.vertexBuffer,i.skyboxGeometry.indexBuffer,i.skyboxGeometry.segment);}const ur={symbol:function(t,i,r,n,o){if("translucent"!==t.renderPass)return;const s=e.StencilMode.disabled,a=t.colorModeForRenderPass();r.layout.get("text-variable-anchor")&&function(t,i,r,n,o,s,a){const l=i.transform,c="map"===o,h="map"===s,u=l.projection.createTileTransform(l,l.worldSize);for(const o of t){const t=n.getTile(o),s=t.getBucket(r);if(!s||s.projection!==l.projection.name||!s.text||!s.text.segments.get().length)continue;const d=e.evaluateSizeForZoom(s.textSizeData,l.zoom),p=i.transform.calculatePixelsToTileUnitsMatrix(t),f=qe(o.projMatrix,t.tileID.canonical,h,c,i.transform,p),m="none"!==r.layout.get("icon-text-fit")&&s.hasIconData();if(d){const i=Math.pow(2,l.zoom-t.tileID.overscaledZ);$i(s,c,h,a,e.symbolSize,l,f,o,i,d,m,u);}}}(n,t,r,i,r.layout.get("text-rotation-alignment"),r.layout.get("text-pitch-alignment"),o),0!==r.paint.get("icon-opacity").constantOr(1)&&qi(t,i,r,n,!1,r.paint.get("icon-translate"),r.paint.get("icon-translate-anchor"),r.layout.get("icon-rotation-alignment"),r.layout.get("icon-pitch-alignment"),r.layout.get("icon-keep-upright"),s,a),0!==r.paint.get("text-opacity").constantOr(1)&&qi(t,i,r,n,!0,r.paint.get("text-translate"),r.paint.get("text-translate-anchor"),r.layout.get("text-rotation-alignment"),r.layout.get("text-pitch-alignment"),r.layout.get("text-keep-upright"),s,a),i.map.showCollisionBoxes&&(Vi(t,i,r,n,r.paint.get("text-translate"),r.paint.get("text-translate-anchor"),!0),Vi(t,i,r,n,r.paint.get("icon-translate"),r.paint.get("icon-translate-anchor"),!1));},circle:function(t,i,r,n){if("translucent"!==t.renderPass)return;const o=r.paint.get("circle-opacity"),s=r.paint.get("circle-stroke-width"),a=r.paint.get("circle-stroke-opacity"),l=void 0!==r.layout.get("circle-sort-key").constantOr(1);if(0===o.constantOr(1)&&(0===s.constantOr(1)||0===a.constantOr(1)))return;const c=t.context,h=c.gl,u=t.depthModeForSublayer(0,e.DepthMode.ReadOnly),d=e.StencilMode.disabled,p=t.colorModeForRenderPass(),f=[];for(let o=0;o<n.length;o++){const s=n[o],a=i.getTile(s),c=a.getBucket(r);if(!c)continue;const h=c.programConfigurations.get(r.id),u=wi(r),d={programConfiguration:h,program:t.useProgram("circle",h,u),layoutVertexBuffer:c.layoutVertexBuffer,indexBuffer:c.indexBuffer,uniformValues:Si(t,s,a,r),tile:a};if(l){const t=c.segments.get();for(const i of t)f.push({segments:new e.SegmentVector([i]),sortKey:i.sortKey,state:d});}else f.push({segments:c.segments,sortKey:0,state:d});}l&&f.sort((e,t)=>e.sortKey-t.sortKey);const m={useDepthForOcclusion:!("globe"===t.transform.projection.name)};for(const i of f){const{programConfiguration:n,program:o,layoutVertexBuffer:s,indexBuffer:a,uniformValues:l,tile:f}=i.state,_=i.segments;t.terrain&&t.terrain.setupElevationDraw(f,o,m),t.prepareDrawProgram(c,o,f.tileID.toUnwrapped()),o.draw(c,h.TRIANGLES,u,d,p,e.CullFaceMode.disabled,l,r.id,s,a,_,r.paint,t.transform.zoom,n);}},heatmap:function(t,i,r,n){if(0!==r.paint.get("heatmap-opacity"))if("offscreen"===t.renderPass){const o=t.context,s=o.gl,a=e.StencilMode.disabled,l=new e.ColorMode([s.ONE,s.ONE],e.Color.transparent,[!0,!0,!0,!0]);!function(e,t,i){const r=e.gl;e.activeTexture.set(r.TEXTURE1),e.viewport.set([0,0,t.width/4,t.height/4]);let n=i.heatmapFbo;if(n)r.bindTexture(r.TEXTURE_2D,n.colorAttachment.get()),e.bindFramebuffer.set(n.framebuffer);else {const o=r.createTexture();r.bindTexture(r.TEXTURE_2D,o),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),n=i.heatmapFbo=e.createFramebuffer(t.width/4,t.height/4,!1),function(e,t,i,r){const n=e.gl;n.texImage2D(n.TEXTURE_2D,0,n.RGBA,t.width/4,t.height/4,0,n.RGBA,e.extRenderToTextureHalfFloat?e.extTextureHalfFloat.HALF_FLOAT_OES:n.UNSIGNED_BYTE,null),r.colorAttachment.set(i);}(e,t,o,n);}}(o,t,r),o.clear({color:e.Color.transparent});for(let c=0;c<n.length;c++){const h=n[c];if(i.hasRenderableParent(h))continue;const u=i.getTile(h),d=u.getBucket(r);if(!d)continue;const p=d.programConfigurations.get(r.id),f=t.useProgram("heatmap",p),{zoom:m}=t.transform;t.terrain&&t.terrain.setupElevationDraw(u,f),t.prepareDrawProgram(o,f,h.toUnwrapped()),f.draw(o,s.TRIANGLES,e.DepthMode.disabled,a,l,e.CullFaceMode.disabled,Ni(h.projMatrix,u,m,r.paint.get("heatmap-intensity")),r.id,d.layoutVertexBuffer,d.indexBuffer,d.segments,r.paint,t.transform.zoom,p);}o.viewport.set([0,0,t.width,t.height]);}else "translucent"===t.renderPass&&(t.context.setColorMode(t.colorModeForRenderPass()),function(t,i){const r=t.context,n=r.gl,o=i.heatmapFbo;if(!o)return;r.activeTexture.set(n.TEXTURE0),n.bindTexture(n.TEXTURE_2D,o.colorAttachment.get()),r.activeTexture.set(n.TEXTURE1);let s=i.colorRampTexture;s||(s=i.colorRampTexture=new e.Texture(r,i.colorRamp,n.RGBA)),s.bind(n.LINEAR,n.CLAMP_TO_EDGE),t.useProgram("heatmapTexture").draw(r,n.TRIANGLES,e.DepthMode.disabled,e.StencilMode.disabled,t.colorModeForRenderPass(),e.CullFaceMode.disabled,((e,t,i,r)=>({u_image:0,u_color_ramp:1,u_opacity:t.paint.get("heatmap-opacity")}))(0,i),i.id,t.viewportBuffer,t.quadTriangleIndexBuffer,t.viewportSegments,i.paint,t.transform.zoom);}(t,r));},line:function(t,i,r,n){if("translucent"!==t.renderPass)return;const o=r.paint.get("line-opacity"),s=r.paint.get("line-width");if(0===o.constantOr(1)||0===s.constantOr(1))return;const a=t.depthModeForSublayer(0,e.DepthMode.ReadOnly),l=t.colorModeForRenderPass(),c=r.paint.get("line-dasharray"),h=c.constantOr(1),u=r.layout.get("line-cap"),d=r.paint.get("line-pattern"),p=d.constantOr(1),f=r.paint.get("line-gradient"),m=r.getCrossfadeParameters(),_=p?"linePattern":"line",g=t.context,y=g.gl,x=(e=>{const t=[];Pi(e)&&t.push("RENDER_LINE_DASH"),e.paint.get("line-gradient")&&t.push("RENDER_LINE_GRADIENT");const i=e.paint.get("line-pattern").constantOr(1),r=1!==e.paint.get("line-opacity").constantOr(1);return !i&&r&&t.push("RENDER_LINE_ALPHA_DISCARD"),t;})(r);let v=x.includes("RENDER_LINE_ALPHA_DISCARD");t.terrain&&t.terrain.clipOrMaskOverlapStencilType()&&(v=!1);for(const o of n){const n=i.getTile(o);if(p&&!n.patternsLoaded())continue;const s=n.getBucket(r);if(!s)continue;t.prepareDrawTile(o);const b=s.programConfigurations.get(r.id),S=t.useProgram(_,b,x),w=d.constantOr(null);if(w&&n.imageAtlas){const e=n.imageAtlas,t=e.patternPositions[w.to.toString()],i=e.patternPositions[w.from.toString()];t&&i&&b.setConstantPatternPositions(t,i);}const T=c.constantOr(null),E=u.constantOr(null);if(!p&&T&&E&&n.lineAtlas){const e=n.lineAtlas,t=e.getDash(T.to,E),i=e.getDash(T.from,E);t&&i&&b.setConstantPatternPositions(t,i);}const N=t.terrain?o.projMatrix:null,I=p?Mi(t,n,r,m,N):Ii(t,n,r,m,N,s.lineClipsArray.length);if(f){const n=s.gradients[r.id];let a=n.texture;if(r.gradientVersion!==n.version){let l=256;if(r.stepInterpolant){const r=i.getSource().maxzoom,n=o.canonical.z===r?Math.ceil(1<<t.transform.maxZoom-o.canonical.z):1;l=e.clamp(e.nextPowerOfTwo(s.maxLineLength/e.EXTENT*1024*n),256,g.maxTextureSize);}n.gradient=e.renderColorRamp({expression:r.gradientExpression(),evaluationKey:"lineProgress",resolution:l,image:n.gradient||void 0,clips:s.lineClipsArray}),n.texture?n.texture.update(n.gradient):n.texture=new e.Texture(g,n.gradient,y.RGBA),n.version=r.gradientVersion,a=n.texture;}g.activeTexture.set(y.TEXTURE1),a.bind(r.stepInterpolant?y.NEAREST:y.LINEAR,y.CLAMP_TO_EDGE);}h&&(g.activeTexture.set(y.TEXTURE0),n.lineAtlasTexture.bind(y.LINEAR,y.REPEAT),b.updatePaintBuffers(m)),p&&(g.activeTexture.set(y.TEXTURE0),n.imageAtlasTexture.bind(y.LINEAR,y.CLAMP_TO_EDGE),b.updatePaintBuffers(m)),t.prepareDrawProgram(g,S,o.toUnwrapped());const M=i=>{S.draw(g,y.TRIANGLES,a,i,l,e.CullFaceMode.disabled,I,r.id,s.layoutVertexBuffer,s.indexBuffer,s.segments,r.paint,t.transform.zoom,b,s.layoutVertexBuffer2);};if(v){const i=t.stencilModeForClipping(o).ref;0===i&&t.terrain&&g.clear({stencil:0});const r={func:y.EQUAL,mask:255};I.u_alpha_discard_threshold=.8,M(new e.StencilMode(r,i,255,y.KEEP,y.KEEP,y.INVERT)),I.u_alpha_discard_threshold=0,M(new e.StencilMode(r,i,255,y.KEEP,y.KEEP,y.KEEP));}else M(t.stencilModeForClipping(o));}v&&(t.resetStencilClippingMasks(),t.terrain&&g.clear({stencil:0}));},fill:function(t,i,r,n){const o=r.paint.get("fill-color"),s=r.paint.get("fill-opacity");if(0===s.constantOr(1))return;const a=t.colorModeForRenderPass(),l=r.paint.get("fill-pattern"),c=t.opaquePassEnabledForLayer()&&!l.constantOr(1)&&1===o.constantOr(e.Color.transparent).a&&1===s.constantOr(0)?"opaque":"translucent";if(t.renderPass===c){const o=t.depthModeForSublayer(1,"opaque"===t.renderPass?e.DepthMode.ReadWrite:e.DepthMode.ReadOnly);Xi(t,i,r,n,o,a,!1);}if("translucent"===t.renderPass&&r.paint.get("fill-antialias")){const o=t.depthModeForSublayer(r.getPaintProperty("fill-outline-color")?2:0,e.DepthMode.ReadOnly);Xi(t,i,r,n,o,a,!0);}},"fill-extrusion":function(t,i,r,n){const o=r.paint.get("fill-extrusion-opacity");if(0!==o&&"translucent"===t.renderPass){const s=new e.DepthMode(t.context.gl.LEQUAL,e.DepthMode.ReadWrite,t.depthRangeFor3D);if(1!==o||r.paint.get("fill-extrusion-pattern").constantOr(1))Wi(t,i,r,n,s,e.StencilMode.disabled,e.ColorMode.disabled),Wi(t,i,r,n,s,t.stencilModeFor3D(),t.colorModeForRenderPass()),t.resetStencilClippingMasks();else {const o=t.colorModeForRenderPass();Wi(t,i,r,n,s,e.StencilMode.disabled,o);}}},hillshade:function(t,i,r,n){if("offscreen"!==t.renderPass&&"translucent"!==t.renderPass)return;const o=t.context,s=t.depthModeForSublayer(0,e.DepthMode.ReadOnly),a=t.colorModeForRenderPass(),l=t.terrain&&t.terrain.renderingToTexture,[c,h]="translucent"!==t.renderPass||l?[{},n]:t.stencilConfigForOverlap(n);for(const n of h){const o=i.getTile(n);if(o.needsHillshadePrepare&&"offscreen"===t.renderPass)Qt(t,o,r,s,e.StencilMode.disabled,a);else if("translucent"===t.renderPass){const e=l&&t.terrain?t.terrain.stencilModeForRTTOverlap(n):c[n.overscaledZ];Jt(t,n,o,r,s,e,a);}}o.viewport.set([0,0,t.width,t.height]),t.resetStencilClippingMasks();},raster:function(t,i,r,n,o,s){if("translucent"!==t.renderPass)return;if(0===r.paint.get("raster-opacity"))return;if(!n.length)return;const a=t.context,l=a.gl,c=i.getSource(),h=t.useProgram("raster"),u=t.colorModeForRenderPass(),d=t.terrain&&t.terrain.renderingToTexture,[p,f]=c instanceof be||d?[{},n]:t.stencilConfigForOverlap(n),m=f[f.length-1].overscaledZ,_=!t.options.moving;for(const n of f){const o=d?e.DepthMode.disabled:t.depthModeForSublayer(n.overscaledZ-m,1===r.paint.get("raster-opacity")?e.DepthMode.ReadWrite:e.DepthMode.ReadOnly,l.LESS),f=n.toUnwrapped(),g=i.getTile(n);if(d&&(!g||!g.hasData()))continue;const y=d?n.projMatrix:t.transform.calculateProjMatrix(f,_),x=t.terrain&&d?t.terrain.stencilModeForRTTOverlap(n):p[n.overscaledZ],v=s?0:r.paint.get("raster-fade-duration");g.registerFadeDuration(v);const b=i.findLoadedParent(n,0),S=li(g,b,i,t.transform,v);let w,T;t.terrain&&t.terrain.prepareDrawTile(n);const E="nearest"===r.paint.get("raster-resampling")?l.NEAREST:l.LINEAR;a.activeTexture.set(l.TEXTURE0),g.texture.bind(E,l.CLAMP_TO_EDGE),a.activeTexture.set(l.TEXTURE1),b?(b.texture.bind(E,l.CLAMP_TO_EDGE),w=Math.pow(2,b.tileID.overscaledZ-g.tileID.overscaledZ),T=[g.tileID.canonical.x*w%1,g.tileID.canonical.y*w%1]):g.texture.bind(E,l.CLAMP_TO_EDGE);const N=Li(y,T||[0,0],w||1,S,r,c instanceof be?c.perspectiveTransform:[0,0]);if(t.prepareDrawProgram(a,h,f),c instanceof be)h.draw(a,l.TRIANGLES,o,e.StencilMode.disabled,u,e.CullFaceMode.disabled,N,r.id,c.boundsBuffer,t.quadTriangleIndexBuffer,c.boundsSegments);else {const{tileBoundsBuffer:i,tileBoundsIndexBuffer:n,tileBoundsSegments:s}=t.getTileBoundsBuffers(g);h.draw(a,l.TRIANGLES,o,x,u,e.CullFaceMode.disabled,N,r.id,i,n,s);}}t.resetStencilClippingMasks();},background:function(t,i,r,n){const o=r.paint.get("background-color"),s=r.paint.get("background-opacity");if(0===s)return;const a=t.context,l=a.gl,c=t.transform,h=c.tileSize,u=r.paint.get("background-pattern");if(t.isPatternMissing(u))return;const d=!u&&1===o.a&&1===s&&t.opaquePassEnabledForLayer()?"opaque":"translucent";if(t.renderPass!==d)return;const p=e.StencilMode.disabled,f=t.depthModeForSublayer(0,"opaque"===d?e.DepthMode.ReadWrite:e.DepthMode.ReadOnly),m=t.colorModeForRenderPass(),_=t.useProgram(u?"backgroundPattern":"background");let g,y=n;y||(g=t.getBackgroundTiles(),y=Object.values(g).map(e=>e.tileID)),u&&(a.activeTexture.set(l.TEXTURE0),t.imageManager.bind(t.context));const x=r.getCrossfadeParameters();for(const d of y){const y=d.toUnwrapped(),v=n?d.projMatrix:t.transform.calculateProjMatrix(y);t.prepareDrawTile(d);const b=i?i.getTile(d):g?g[d.key]:new e.Tile(d,h,c.zoom,t),S=u?Fi(v,s,t,u,{tileID:d,tileSize:h},x):Oi(v,s,o);t.prepareDrawProgram(a,_,y);const{tileBoundsBuffer:w,tileBoundsIndexBuffer:T,tileBoundsSegments:E}=t.getTileBoundsBuffers(b);_.draw(a,l.TRIANGLES,f,p,m,e.CullFaceMode.disabled,S,r.id,w,T,E);}},sky:function(t,i,r){const n=t.transform,o="mercator"===n.projection.name||"globe"===n.projection.name?1:e.smoothstep(7,8,n.zoom),s=r.paint.get("sky-opacity")*o;if(0===s)return;const a=t.context,l=r.paint.get("sky-type"),c=new e.DepthMode(a.gl.LEQUAL,e.DepthMode.ReadOnly,[0,1]),h=t.frameCounter/1e3%1;"atmosphere"===l?"offscreen"===t.renderPass?r.needsSkyboxCapture(t)&&(function(t,i,r,n){const o=t.context,s=o.gl;let a=i.skyboxFbo;if(!a){a=i.skyboxFbo=o.createFramebuffer(32,32,!1),i.skyboxGeometry=new cr(o),i.skyboxTexture=o.gl.createTexture(),s.bindTexture(s.TEXTURE_CUBE_MAP,i.skyboxTexture),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_S,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_WRAP_T,s.CLAMP_TO_EDGE),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MIN_FILTER,s.LINEAR),s.texParameteri(s.TEXTURE_CUBE_MAP,s.TEXTURE_MAG_FILTER,s.LINEAR);for(let e=0;e<6;++e)s.texImage2D(s.TEXTURE_CUBE_MAP_POSITIVE_X+e,0,s.RGBA,32,32,0,s.RGBA,s.UNSIGNED_BYTE,null);}o.bindFramebuffer.set(a.framebuffer),o.viewport.set([0,0,32,32]);const l=i.getCenter(t,!0),c=t.useProgram("skyboxCapture"),h=new Float64Array(16);e.identity(h),e.rotateY(h,h,.5*-Math.PI),hr(o,i,c,h,l,0),e.identity(h),e.rotateY(h,h,.5*Math.PI),hr(o,i,c,h,l,1),e.identity(h),e.rotateX(h,h,.5*-Math.PI),hr(o,i,c,h,l,2),e.identity(h),e.rotateX(h,h,.5*Math.PI),hr(o,i,c,h,l,3),e.identity(h),hr(o,i,c,h,l,4),e.identity(h),e.rotateY(h,h,Math.PI),hr(o,i,c,h,l,5),o.viewport.set([0,0,t.width,t.height]);}(t,r),r.markSkyboxValid(t)):"sky"===t.renderPass&&function(t,i,r,n,o){const s=t.context,a=s.gl,l=t.transform,c=t.useProgram("skybox");s.activeTexture.set(a.TEXTURE0),a.bindTexture(a.TEXTURE_CUBE_MAP,i.skyboxTexture);const h=((e,t,i,r,n)=>({u_matrix:e,u_sun_direction:t,u_cubemap:0,u_opacity:r,u_temporal_offset:n}))(l.skyboxMatrix,i.getCenter(t,!1),0,n,o);t.prepareDrawProgram(s,c),c.draw(s,a.TRIANGLES,r,e.StencilMode.disabled,t.colorModeForRenderPass(),e.CullFaceMode.backCW,h,"skybox",i.skyboxGeometry.vertexBuffer,i.skyboxGeometry.indexBuffer,i.skyboxGeometry.segment);}(t,r,c,s,h):"gradient"===l&&"sky"===t.renderPass&&function(t,i,r,n,o){const s=t.context,a=s.gl,l=t.transform,c=t.useProgram("skyboxGradient");i.skyboxGeometry||(i.skyboxGeometry=new cr(s)),s.activeTexture.set(a.TEXTURE0);let h=i.colorRampTexture;h||(h=i.colorRampTexture=new e.Texture(s,i.colorRamp,a.RGBA)),h.bind(a.LINEAR,a.CLAMP_TO_EDGE);const u=((t,i,r,n,o)=>({u_matrix:t,u_color_ramp:0,u_center_direction:i,u_radius:e.degToRad(r),u_opacity:n,u_temporal_offset:o}))(l.skyboxMatrix,i.getCenter(t,!1),i.paint.get("sky-gradient-radius"),n,o);t.prepareDrawProgram(s,c),c.draw(s,a.TRIANGLES,r,e.StencilMode.disabled,t.colorModeForRenderPass(),e.CullFaceMode.backCW,u,"skyboxGradient",i.skyboxGeometry.vertexBuffer,i.skyboxGeometry.indexBuffer,i.skyboxGeometry.segment);}(t,r,c,s,h);},debug:function(e,t,i){for(let r=0;r<i.length;r++)or(e,t,i[r]);},custom:function(t,i,r){const n=t.context,o=r.implementation;if(t.transform.projection.unsupportedLayers&&t.transform.projection.unsupportedLayers.includes("custom"))e.warnOnce("Custom layers are not yet supported with non-mercator projections. Use mercator to enable custom layers.");else if("offscreen"===t.renderPass){const e=o.prerender;e&&(t.setCustomLayerDefaults(),n.setColorMode(t.colorModeForRenderPass()),e.call(o,n.gl,t.transform.customLayerMatrix()),n.setDirty(),t.setBaseState());}else if("translucent"===t.renderPass){t.setCustomLayerDefaults(),n.setColorMode(t.colorModeForRenderPass()),n.setStencilMode(e.StencilMode.disabled);const i="3d"===o.renderingMode?new e.DepthMode(t.context.gl.LEQUAL,e.DepthMode.ReadWrite,t.depthRangeFor3D):t.depthModeForSublayer(0,e.DepthMode.ReadOnly);n.setDepthMode(i),o.render(n.gl,t.transform.customLayerMatrix()),n.setDirty(),t.setBaseState(),n.bindFramebuffer.set(null);}}};class dr{constructor(t,i){this.context=new pe(t),this.transform=i,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.setup(),this.numSublayers=e.SourceCache.maxUnderzooming+e.SourceCache.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.crossTileSymbolIndex=new kt(),this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={};}updateTerrain(e,t){const i=!!e&&!!e.terrain&&this.transform.projection.supportsTerrain;if(!(i||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new di(this,e));const r=this._terrain;this.transform.elevation=i?r:null,r.update(e,this.transform,t);}_updateFog(e){const t=e.fog;if(!t||t.getOpacity(this.transform.pitch)<1||t.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[i,r]=t.getFovAdjustedRange(this.transform._fov);if(i>r)return void(this.transform.fogCullDistSq=null);const n=i+.78*(r-i);this.transform.fogCullDistSq=n*n;}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled?this._terrain:null;}resize(t,i){if(this.width=t*e.exported.devicePixelRatio,this.height=i*e.exported.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const e of this.style.order)this.style._layers[e].resize();}setup(){const t=this.context,i=new e.StructArrayLayout2i4();i.emplaceBack(0,0),i.emplaceBack(e.EXTENT,0),i.emplaceBack(0,e.EXTENT),i.emplaceBack(e.EXTENT,e.EXTENT),this.tileExtentBuffer=t.createVertexBuffer(i,e.posAttributes.members),this.tileExtentSegments=e.SegmentVector.simpleSegment(0,0,4,2);const r=new e.StructArrayLayout2i4();r.emplaceBack(0,0),r.emplaceBack(e.EXTENT,0),r.emplaceBack(0,e.EXTENT),r.emplaceBack(e.EXTENT,e.EXTENT),this.debugBuffer=t.createVertexBuffer(r,e.posAttributes.members),this.debugSegments=e.SegmentVector.simpleSegment(0,0,4,5);const n=new e.StructArrayLayout2i4();n.emplaceBack(-1,-1),n.emplaceBack(1,-1),n.emplaceBack(-1,1),n.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(n,e.posAttributes.members),this.viewportSegments=e.SegmentVector.simpleSegment(0,0,4,2);const o=new e.StructArrayLayout4i8();o.emplaceBack(0,0,0,0),o.emplaceBack(e.EXTENT,0,e.EXTENT,0),o.emplaceBack(0,e.EXTENT,0,e.EXTENT),o.emplaceBack(e.EXTENT,e.EXTENT,e.EXTENT,e.EXTENT),this.mercatorBoundsBuffer=t.createVertexBuffer(o,e.boundsAttributes.members),this.mercatorBoundsSegments=e.SegmentVector.simpleSegment(0,0,4,2);const s=new e.StructArrayLayout3ui6();s.emplaceBack(0,1,2),s.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(s);const a=new e.StructArrayLayout1ui2();for(const e of [0,1,3,2,0])a.emplaceBack(e);this.debugIndexBuffer=t.createIndexBuffer(a),this.emptyTexture=new e.Texture(t,{width:1,height:1,data:new Uint8Array([0,0,0,0])},t.gl.RGBA),this.identityMat=e.create();const l=this.context.gl;this.stencilClearMode=new e.StencilMode({func:l.ALWAYS,mask:0},0,255,l.ZERO,l.ZERO,l.ZERO),this.loadTimeStamps.push(e.window.performance.now());}getMercatorTileBoundsBuffers(){return {tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments};}getTileBoundsBuffers(e){return e._makeTileBoundsBuffers(this.context,this.transform.projection),e._tileBoundsBuffer?{tileBoundsBuffer:e._tileBoundsBuffer,tileBoundsIndexBuffer:e._tileBoundsIndexBuffer,tileBoundsSegments:e._tileBoundsSegments}:this.getMercatorTileBoundsBuffers();}clearStencil(){const t=this.context,i=t.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.useProgram("clippingMask").draw(t,i.TRIANGLES,e.DepthMode.disabled,this.stencilClearMode,e.ColorMode.disabled,e.CullFaceMode.disabled,ai(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments);}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={});}_renderTileClippingMasks(t,i,r){if(!i||this.currentStencilSource===i.id||!t.isTileClipped()||!r||0===r.length)return;if(this._tileClippingMaskIDs&&!this.terrain){let e=!1;for(const t of r)if(void 0===this._tileClippingMaskIDs[t.key]){e=!0;break;}if(!e)return;}this.currentStencilSource=i.id;const n=this.context,o=n.gl;this.nextStencilID+r.length>256&&this.clearStencil(),n.setColorMode(e.ColorMode.disabled),n.setDepthMode(e.DepthMode.disabled);const s=this.useProgram("clippingMask");this._tileClippingMaskIDs={};for(const t of r){const r=i.getTile(t),a=this._tileClippingMaskIDs[t.key]=this.nextStencilID++,{tileBoundsBuffer:l,tileBoundsIndexBuffer:c,tileBoundsSegments:h}=this.getTileBoundsBuffers(r);s.draw(n,o.TRIANGLES,e.DepthMode.disabled,new e.StencilMode({func:o.ALWAYS,mask:0},a,255,o.KEEP,o.KEEP,o.REPLACE),e.ColorMode.disabled,e.CullFaceMode.disabled,ai(t.projMatrix),"$clipping",l,c,h);}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const t=this.nextStencilID++,i=this.context.gl;return new e.StencilMode({func:i.NOTEQUAL,mask:255},t,255,i.KEEP,i.KEEP,i.REPLACE);}stencilModeForClipping(t){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(t);const i=this.context.gl;return new e.StencilMode({func:i.EQUAL,mask:255},this._tileClippingMaskIDs[t.key],0,i.KEEP,i.KEEP,i.REPLACE);}stencilConfigForOverlap(t){const i=this.context.gl,r=t.sort((e,t)=>t.overscaledZ-e.overscaledZ),n=r[r.length-1].overscaledZ,o=r[0].overscaledZ-n+1;if(o>1){this.currentStencilSource=void 0,this.nextStencilID+o>256&&this.clearStencil();const t={};for(let r=0;r<o;r++)t[r+n]=new e.StencilMode({func:i.GEQUAL,mask:255},r+this.nextStencilID,255,i.KEEP,i.KEEP,i.REPLACE);return this.nextStencilID+=o,[t,r];}return [{[n]:e.StencilMode.disabled},r];}colorModeForRenderPass(){const t=this.context.gl;if(this._showOverdrawInspector){const i=1/8;return new e.ColorMode([t.CONSTANT_COLOR,t.ONE],new e.Color(i,i,i,0),[!0,!0,!0,!0]);}return "opaque"===this.renderPass?e.ColorMode.unblended:e.ColorMode.alphaBlended;}depthModeForSublayer(t,i,r){if(!this.opaquePassEnabledForLayer())return e.DepthMode.disabled;const n=1-((1+this.currentLayer)*this.numSublayers+t)*this.depthEpsilon;return new e.DepthMode(r||this.context.gl.LEQUAL,i,[n,n]);}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff;}render(t,i){this.style=t,this.options=i,this.lineAtlas=t.lineAtlas,this.imageManager=t.imageManager,this.glyphManager=t.glyphManager,this.symbolFadeChange=t.placement.symbolFadeChange(e.exported.now()),this.imageManager.beginFrame();const r=this.style.order,n=this.style._sourceCaches;for(const e in n){const t=n[e];t.used&&t.prepare(this.context);}const o={},s={},a={};for(const e in n){const t=n[e];o[e]=t.getVisibleCoordinates(),s[e]=o[e].slice().reverse(),a[e]=t.getVisibleCoordinates(!0).reverse();}this.opaquePassCutoff=1/0;for(let e=0;e<r.length;e++)if(this.style._layers[r[e]].is3D()){this.opaquePassCutoff=e;break;}if(this.terrain&&(this.terrain.updateTileBinding(a),this.opaquePassCutoff=0),"globe"!==this.transform.projection.name||this.globeSharedBuffers||(this.globeSharedBuffers=new e.GlobeSharedBuffers(this.context)),!e.isMapAuthenticated(this.context.gl))return;this.renderPass="offscreen";for(const e of r){const i=this.style._layers[e],r=t._getLayerSourceCache(i);if(!i.hasOffscreenPass()||i.isHidden(this.transform.zoom))continue;const n=r?s[r.id]:void 0;("custom"===i.type||i.isSky()||n&&n.length)&&this.renderLayer(this,r,i,n);}this.depthRangeFor3D=[0,1-(t.order.length+2)*this.numSublayers*this.depthEpsilon],this.terrain&&(this.style.hasSymbolLayers()||this.style.hasCircleLayers())&&this.terrain.drawDepth(),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);let l=e.Color.transparent;if(this.style.fog&&this.style.fog.getOpacity(this.transform.pitch)&&(l=this.style.fog.properties.get("color")),this.context.clear({color:i.showOverdrawInspector?e.Color.black:l,depth:1}),this.clearStencil(),this._showOverdrawInspector=i.showOverdrawInspector,this.renderPass="opaque",!this.terrain)for(this.currentLayer=r.length-1;this.currentLayer>=0;this.currentLayer--){const e=this.style._layers[r[this.currentLayer]],i=t._getLayerSourceCache(e);if(e.isSky())continue;const n=i?s[i.id]:void 0;this._renderTileClippingMasks(e,i,n),this.renderLayer(this,i,e,n);}if(this.renderPass="sky",(e.globeToMercatorTransition(this.transform.zoom)>0||"globe"!==this.transform.projection.name)&&this.transform.isHorizonVisible())for(this.currentLayer=0;this.currentLayer<r.length;this.currentLayer++){const e=this.style._layers[r[this.currentLayer]],i=t._getLayerSourceCache(e);e.isSky()&&this.renderLayer(this,i,e,i?s[i.id]:void 0);}for("globe"===this.transform.projection.name&&function(t){const i=t.context,r=i.gl,n=t.transform,o=new e.DepthMode(r.LEQUAL,e.DepthMode.ReadOnly,[0,1]),s=t.useProgram("globeAtmosphere"),a=n._camera.getWorldToCamera(n.worldSize,1),l=n._camera.getCameraToClipPerspective(n._fov,n.width/n.height,n._nearZ,n._farZ),c=e.mul([],a,e.calculateGlobeMatrix(n,n.worldSize)),h=e.mul([],n.labelPlaneMatrix,l),u=e.transformMat4([],[0,0,0],c),d=e.add([],u,[n.worldSize/Math.PI/2,0,0]),p=e.transformMat4([],u,h),f=e.transformMat4([],d,h),m=e.length(e.sub([],f,p)),_=1-e.globeToMercatorTransition(n.zoom),g={u_center:p,u_radius:m,u_screen_size:[n.width,n.height],u_pixel_ratio:e.exported.devicePixelRatio,u_opacity:_,u_fadeout_range:2,u_start_color:[1,1,1],u_end_color:[.0118,.7451,.9882]};t.prepareDrawProgram(i,s);const y=t.globeSharedBuffers;y&&s.draw(i,r.TRIANGLES,o,e.StencilMode.disabled,e.ColorMode.alphaBlended,e.CullFaceMode.backCW,g,"skybox",y.atmosphereVertexBuffer,y.atmosphereIndexBuffer,y.atmosphereSegments);}(this),this.renderPass="translucent",this.currentLayer=0;this.currentLayer<r.length;){const e=this.style._layers[r[this.currentLayer]],i=t._getLayerSourceCache(e);if(e.isSky()){++this.currentLayer;continue;}if(this.terrain&&this.style.isLayerDraped(e)){if(e.isHidden(this.transform.zoom)){++this.currentLayer;continue;}this.currentLayer=this.terrain.renderBatch(this.currentLayer);continue;}const n=i?("symbol"===e.type?a:s)[i.id]:void 0;this._renderTileClippingMasks(e,i,i?o[i.id]:void 0),this.renderLayer(this,i,e,n),++this.currentLayer;}if(this.terrain&&this.terrain.postRender(),this.options.showTileBoundaries||this.options.showQueryGeometry){let i=null;e.values(this.style._layers).forEach(e=>{const r=t._getLayerSourceCache(e);r&&!e.isHidden(this.transform.zoom)&&(!i||i.getSource().maxzoom<r.getSource().maxzoom)&&(i=r);}),i&&this.options.showTileBoundaries&&ur.debug(this,i,i.getVisibleCoordinates());}this.options.showPadding&&function(e){const t=e.transform.padding;ir(e,e.transform.height-(t.top||0),3,Ji),ir(e,t.bottom||0,3,Ki),rr(e,t.left||0,3,Qi),rr(e,e.transform.width-(t.right||0),3,er);const i=e.transform.centerPoint;!function(e,t,i,r){nr(e,t-1,i-10,2,20,r),nr(e,t-10,i-1,20,2,r);}(e,i.x,e.transform.height-i.y,tr);}(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(e.window.performance.now()),this.saveCanvasCopy());}renderLayer(e,t,i,r){i.isHidden(this.transform.zoom)||("background"===i.type||"sky"===i.type||"custom"===i.type||r&&r.length)&&(this.id=i.id,this.gpuTimingStart(i),e.transform.projection.unsupportedLayers&&e.transform.projection.unsupportedLayers.includes(i.type)||ur[i.type](e,t,i,r,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd());}gpuTimingStart(e){if(!this.options.gpuTiming)return;const t=this.context.extTimerQuery;let i=this.gpuTimers[e.id];i||(i=this.gpuTimers[e.id]={calls:0,cpuTime:0,query:t.createQueryEXT()}),i.calls++,t.beginQueryEXT(t.TIME_ELAPSED_EXT,i.query);}gpuTimingEnd(){if(!this.options.gpuTiming)return;const e=this.context.extTimerQuery;e.endQueryEXT(e.TIME_ELAPSED_EXT);}collectGpuTimers(){const e=this.gpuTimers;return this.gpuTimers={},e;}queryGpuTimers(e){const t={};for(const i in e){const r=e[i],n=this.context.extTimerQuery,o=n.getQueryObjectEXT(r.query,n.QUERY_RESULT_EXT)/1e6;n.deleteQueryEXT(r.query),t[i]=o;}return t;}translatePosMatrix(t,i,r,n,o){if(!r[0]&&!r[1])return t;const s=o?"map"===n?this.transform.angle:0:"viewport"===n?-this.transform.angle:0;if(s){const e=Math.sin(s),t=Math.cos(s);r=[r[0]*t-r[1]*e,r[0]*e+r[1]*t];}const a=[o?r[0]:N(i,r[0],this.transform.zoom),o?r[1]:N(i,r[1],this.transform.zoom),0],l=new Float32Array(16);return e.translate(l,t,a),l;}saveTileTexture(e){const t=this._tileTextures[e.size[0]];t?t.push(e):this._tileTextures[e.size[0]]=[e];}getTileTexture(e){const t=this._tileTextures[e];return t&&t.length>0?t.pop():null;}isPatternMissing(e){if(!e)return !1;if(!e.from||!e.to)return !0;const t=this.imageManager.getPattern(e.from.toString()),i=this.imageManager.getPattern(e.to.toString());return !t||!i;}currentGlobalDefines(){const e=this.terrain&&this.terrain.renderingToTexture,t=this.style&&this.style.fog,i=[];return this.terrain&&!this.terrain.renderingToTexture&&i.push("TERRAIN"),t&&!e&&0!==t.getOpacity(this.transform.pitch)&&i.push("FOG"),e&&i.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&i.push("OVERDRAW_INSPECTOR"),i;}useProgram(e,t,i){this.cache=this.cache||{};const r=i||[],n=this.currentGlobalDefines().concat(r),o=fi.cacheKey(e,n,t);return this.cache[o]||(this.cache[o]=new fi(this.context,e,Zt[e],t,Bi[e],n)),this.cache[o];}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault();}setBaseState(){const e=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(e.FUNC_ADD);}initDebugOverlayCanvas(){null==this.debugOverlayCanvas&&(this.debugOverlayCanvas=e.window.document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new e.Texture(this.context,this.debugOverlayCanvas,this.context.gl.RGBA));}destroy(){this._terrain&&this._terrain.destroy(),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy();}prepareDrawTile(e){this.terrain&&this.terrain.prepareDrawTile(e);}prepareDrawProgram(e,t,i){if(this.terrain&&this.terrain.renderingToTexture)return;const r=this.style.fog;if(r){const n=r.getOpacity(this.transform.pitch);0!==n&&t.setFogUniformValues(e,((e,t,i,r)=>{const n=t.properties.get("color"),o=e.frameCounter/1e3%1,s=[n.r/n.a,n.g/n.a,n.b/n.a,r];return {u_fog_matrix:i?e.transform.calculateFogTileMatrix(i):e.identityMat,u_fog_range:t.getFovAdjustedRange(e.transform._fov),u_fog_color:s,u_fog_horizon_blend:t.properties.get("horizon-blend"),u_fog_temporal_offset:o};})(this,r,i,n));}}setTileLoadedFlag(e){this.tileLoaded=e;}saveCanvasCopy(){this.frameCopies.push(this.canvasCopy()),this.tileLoaded=!1;}canvasCopy(){const e=this.context.gl,t=e.createTexture();return e.bindTexture(e.TEXTURE_2D,t),e.copyTexImage2D(e.TEXTURE_2D,0,e.RGBA,0,0,e.drawingBufferWidth,e.drawingBufferHeight,0),t;}getCanvasCopiesAndTimestamps(){return {canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps};}averageElevationNeedsEasing(){if(!this.transform._elevation)return !1;const e=this.style&&this.style.fog;return !!e&&0!==e.getOpacity(this.transform.pitch);}getBackgroundTiles(){const t=this._backgroundTiles,i=this._backgroundTiles={},r=this.transform.coveringTiles({tileSize:512});for(const n of r)i[n.key]=t[n.key]||new e.Tile(n,512,this.transform.tileZoom,this);return i;}clearBackgroundTiles(){this._backgroundTiles={};}}class pr{constructor(e=0,t=0,i=0,r=0){if(isNaN(e)||e<0||isNaN(t)||t<0||isNaN(i)||i<0||isNaN(r)||r<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=e,this.bottom=t,this.left=i,this.right=r;}interpolate(t,i,r){return null!=i.top&&null!=t.top&&(this.top=e.number(t.top,i.top,r)),null!=i.bottom&&null!=t.bottom&&(this.bottom=e.number(t.bottom,i.bottom,r)),null!=i.left&&null!=t.left&&(this.left=e.number(t.left,i.left,r)),null!=i.right&&null!=t.right&&(this.right=e.number(t.right,i.right,r)),this;}getCenter(t,i){const r=e.clamp((this.left+t-this.right)/2,0,t),n=e.clamp((this.top+i-this.bottom)/2,0,i);return new e.pointGeometry(r,n);}equals(e){return this.top===e.top&&this.bottom===e.bottom&&this.left===e.left&&this.right===e.right;}clone(){return new pr(this.top,this.bottom,this.left,this.right);}toJSON(){return {top:this.top,bottom:this.bottom,left:this.left,right:this.right};}}function fr(t,i){const r=e.getColumn(t,3);e.fromQuat(t,i),e.setColumn(t,3,r);}function mr(t,i){e.setColumn(t,3,[i[0],i[1],i[2],1]);}function _r(t,i){const r=e.identity$1([]);return e.rotateZ$1(r,r,-i),e.rotateX$1(r,r,-t),r;}function gr(t,i){const r=[t[0],t[1],0],n=[i[0],i[1],0];if(e.length(r)>=1e-15){const t=e.normalize([],r);e.scale$2(n,t,e.dot(n,t)),i[0]=n[0],i[1]=n[1];}const o=e.cross([],i,t);if(e.len(o)<1e-15)return null;const s=Math.atan2(-o[1],o[0]);return _r(Math.atan2(Math.sqrt(t[0]*t[0]+t[1]*t[1]),-t[2]),s);}class yr{constructor(e,t){this.position=e,this.orientation=t;}get position(){return this._position;}set position(t){this._position=this._renderWorldCopies?function(t){if(!t)return;const i=Array.isArray(t)?new e.MercatorCoordinate(t[0],t[1],t[2]):t;return i.x=e.wrap(i.x,0,1),i;}(t):t;}lookAtPoint(t,i){if(this.orientation=null,!this.position)return;const r=this._elevation?this._elevation.getAtPointOrZero(e.MercatorCoordinate.fromLngLat(t)):0,n=this.position,o=e.MercatorCoordinate.fromLngLat(t,r),s=[o.x-n.x,o.y-n.y,o.z-n.z];i||(i=[0,0,1]),i[2]=Math.abs(i[2]),this.orientation=gr(s,i);}setPitchBearing(t,i){this.orientation=_r(e.degToRad(t),e.degToRad(-i));}}class xr{constructor(t,i){this._transform=e.identity([]),this._orientation=e.identity$1([]),i&&(this._orientation=i,fr(this._transform,this._orientation)),t&&mr(this._transform,t);}get mercatorPosition(){const t=this.position;return new e.MercatorCoordinate(t[0],t[1],t[2]);}get position(){const t=e.getColumn(this._transform,3);return [t[0],t[1],t[2]];}set position(e){mr(this._transform,e);}get orientation(){return this._orientation;}set orientation(e){this._orientation=e,fr(this._transform,this._orientation);}getPitchBearing(){const e=this.forward(),t=this.right();return {bearing:Math.atan2(-t[1],t[0]),pitch:Math.atan2(Math.sqrt(e[0]*e[0]+e[1]*e[1]),-e[2])};}setPitchBearing(e,t){this._orientation=_r(e,t),fr(this._transform,this._orientation);}forward(){const t=e.getColumn(this._transform,2);return [-t[0],-t[1],-t[2]];}up(){const t=e.getColumn(this._transform,1);return [-t[0],-t[1],-t[2]];}right(){const t=e.getColumn(this._transform,0);return [t[0],t[1],t[2]];}getCameraToWorld(t,i){const r=new Float64Array(16);return e.invert(r,this.getWorldToCamera(t,i)),r;}getWorldToCameraPosition(t,i,r){const n=this.position;e.scale$2(n,n,-t);const o=new Float64Array(16);return e.fromScaling(o,[r,r,r]),e.translate(o,o,n),o[10]*=i,o;}getWorldToCamera(t,i){const r=new Float64Array(16),n=new Float64Array(4),o=this.position;return e.conjugate(n,this._orientation),e.scale$2(o,o,-t),e.fromQuat(r,n),e.translate(r,r,o),r[1]*=-1,r[5]*=-1,r[9]*=-1,r[13]*=-1,r[8]*=i,r[9]*=i,r[10]*=i,r[11]*=i,r;}getCameraToClipPerspective(t,i,r,n){const o=new Float64Array(16);return e.perspective(o,t,i,r,n),o;}getDistanceToElevation(t){const i=0===t?0:e.mercatorZfromAltitude(t,this.position[1]),r=this.forward();return (i-this.position[2])/r[2];}clone(){return new xr([...this.position],[...this.orientation]);}}function vr(t,i){const r=Sr(t),n=function(t,i,r,n,o){const s=new e.LngLat(r.lng-180*wr,r.lat),a=new e.LngLat(r.lng+180*wr,r.lat),l=t.project(s.lng,s.lat),c=t.project(a.lng,a.lat),h=-Math.atan2(c.y-l.y,c.x-l.x),u=e.MercatorCoordinate.fromLngLat(r);u.y=e.clamp(u.y,-.999975,.999975);const d=u.toLngLat(),p=t.project(d.lng,d.lat),f=e.MercatorCoordinate.fromLngLat(d);f.x+=wr;const m=f.toLngLat(),_=t.project(m.lng,m.lat),g=Er(_.x-p.x,_.y-p.y,h),y=e.MercatorCoordinate.fromLngLat(d);y.y+=wr;const x=y.toLngLat(),v=t.project(x.lng,x.lat),b=Er(v.x-p.x,v.y-p.y,h),S=Math.abs(g.x)/Math.abs(b.y),w=e.identity([]);e.rotateZ(w,w,-h*(1-(o?0:n)));const T=e.identity([]);return e.scale(T,T,[1,1-(1-S)*n,1]),T[4]=-b.x/b.y*n,e.rotateZ(T,T,h),e.multiply$1(T,w,T),T;}(t.projection,0,t.center,r,i),o=br(t);return e.scale(n,n,[o,o,1]),n;}function br(t){const i=t.projection,r=Sr(t),n=Tr(i,t.center),o=Tr(i,e.LngLat.convert(i.center));return Math.pow(2,n*r+(1-r)*o);}function Sr(t){const i=t.projection.range;if(!i)return 0;const r=Math.max(t.width,t.height),n=Math.log(r/1024)/Math.LN2;return e.smoothstep(i[0]+n,i[1]+n,t.zoom);}const wr=1/4e4;function Tr(t,i){const r=e.clamp(i.lat,-e.MAX_MERCATOR_LATITUDE,e.MAX_MERCATOR_LATITUDE),n=new e.LngLat(i.lng-180*wr,r),o=new e.LngLat(i.lng+180*wr,r),s=t.project(n.lng,r),a=t.project(o.lng,r),l=e.MercatorCoordinate.fromLngLat(n),c=e.MercatorCoordinate.fromLngLat(o),h=a.x-s.x,u=a.y-s.y,d=c.x-l.x,p=c.y-l.y,f=Math.sqrt((d*d+p*p)/(h*h+u*u));return Math.log(f)/Math.LN2;}function Er(e,t,i){const r=Math.cos(i),n=Math.sin(i);return {x:e*r-t*n,y:e*n+t*r};}class Nr{constructor(t,i,r,n,o){this.tileSize=512,this._renderWorldCopies=void 0===o||o,this._minZoom=t||0,this._maxZoom=i||22,this._minPitch=null==r?0:r,this._maxPitch=null==n?60:n,this.setProjection(),this.setMaxBounds(),this.width=0,this.height=0,this._center=new e.LngLat(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new pr(),this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._distanceTileDataCache={},this._camera=new xr(),this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._projectionScaler=1,this._horizonShift=.1;}clone(){const e=new Nr(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies);return e.setProjection(this.getProjection()),e._elevation=this._elevation,e._centerAltitude=this._centerAltitude,e.tileSize=this.tileSize,e.setMaxBounds(this.getMaxBounds()),e.width=this.width,e.height=this.height,e.cameraElevationReference=this.cameraElevationReference,e._center=this._center,e._setZoom(this.zoom),e._cameraZoom=this._cameraZoom,e.angle=this.angle,e._fov=this._fov,e._pitch=this._pitch,e._nearZ=this._nearZ,e._farZ=this._farZ,e._averageElevation=this._averageElevation,e._unmodified=this._unmodified,e._edgeInsets=this._edgeInsets.clone(),e._camera=this._camera.clone(),e._calcMatrices(),e.freezeTileCoverage=this.freezeTileCoverage,e;}get elevation(){return this._elevation;}set elevation(e){this._elevation!==e&&(this._elevation=e,e?this._updateCenterElevation()&&this._updateCameraOnTerrain():(this._cameraZoom=null,this._centerAltitude=0),this._calcMatrices());}updateElevation(e){this._terrainEnabled()&&null==this._cameraZoom&&this._updateCenterElevation()&&this._updateCameraOnTerrain(),e&&this._constrainCameraAltitude(),this._calcMatrices();}getProjection(){return e.pick(this.projection,["name","center","parallels"]);}setProjection(t){null==t&&(t={name:"mercator"}),this.projectionOptions=t;const i=this.projection?this.getProjection():void 0;return this.projection=e.getProjection(t),!o(i,this.getProjection())&&(this._calcMatrices(),!0);}get minZoom(){return this._minZoom;}set minZoom(e){this._minZoom!==e&&(this._minZoom=e,this.zoom=Math.max(this.zoom,e));}get maxZoom(){return this._maxZoom;}set maxZoom(e){this._maxZoom!==e&&(this._maxZoom=e,this.zoom=Math.min(this.zoom,e));}get minPitch(){return this._minPitch;}set minPitch(e){this._minPitch!==e&&(this._minPitch=e,this.pitch=Math.max(this.pitch,e));}get maxPitch(){return this._maxPitch;}set maxPitch(e){this._maxPitch!==e&&(this._maxPitch=e,this.pitch=Math.min(this.pitch,e));}get renderWorldCopies(){return this._renderWorldCopies&&!0===this.projection.supportsWorldCopies;}set renderWorldCopies(e){void 0===e?e=!0:null===e&&(e=!1),this._renderWorldCopies=e;}get worldSize(){return this.tileSize*this.scale;}get cameraWorldSize(){const e=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(e));}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize);}get cameraPixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.cameraWorldSize);}get centerOffset(){return this.centerPoint._sub(this.size._div(2));}get size(){return new e.pointGeometry(this.width,this.height);}get bearing(){return e.wrap(this.rotation,-180,180);}set bearing(e){this.rotation=e;}get rotation(){return -this.angle/Math.PI*180;}set rotation(t){const i=-t*Math.PI/180;var r;this.angle!==i&&(this._unmodified=!1,this.angle=i,this._calcMatrices(),this.rotationMatrix=(r=new e.ARRAY_TYPE(4),e.ARRAY_TYPE!=Float32Array&&(r[1]=0,r[2]=0),r[0]=1,r[3]=1,r),function(e,t,i){var r=t[0],n=t[1],o=t[2],s=t[3],a=Math.sin(i),l=Math.cos(i);e[0]=r*l+o*a,e[1]=n*l+s*a,e[2]=r*-a+o*l,e[3]=n*-a+s*l;}(this.rotationMatrix,this.rotationMatrix,this.angle));}get pitch(){return this._pitch/Math.PI*180;}set pitch(t){const i=e.clamp(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==i&&(this._unmodified=!1,this._pitch=i,this._calcMatrices());}get fov(){return this._fov/Math.PI*180;}set fov(e){e=Math.max(.01,Math.min(60,e)),this._fov!==e&&(this._unmodified=!1,this._fov=e/180*Math.PI,this._calcMatrices());}get averageElevation(){return this._averageElevation;}set averageElevation(e){this._averageElevation=e,this._calcFogMatrices();}get zoom(){return this._zoom;}set zoom(e){const t=Math.min(Math.max(e,this.minZoom),this.maxZoom);this._zoom!==t&&(this._unmodified=!1,this._setZoom(t),this._terrainEnabled()&&this._updateCameraOnTerrain(),this._constrain(),this._calcMatrices());}_setZoom(e){this._zoom=e,this.scale=this.zoomScale(e),this.tileZoom=Math.floor(e),this.zoomFraction=e-this.tileZoom;}_updateCenterElevation(){if(!this._elevation)return !1;const e=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center),-1);return -1===e?(this._cameraZoom=null,!1):(this._centerAltitude=e,!0);}_updateCameraOnTerrain(){this._cameraZoom=this._zoomFromMercatorZ((this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize);}sampleAverageElevation(){if(!this._elevation)return 0;const t=this._elevation,i=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],r=this.horizonLineFromTop();let n=0,o=0;for(let s=0;s<i.length;s++){const a=new e.pointGeometry(i[s][0]*this.width,r+i[s][1]*(this.height-r)),l=t.pointCoordinate(a);if(!l)continue;const c=1/Math.hypot(l[0]-this._camera.position[0],l[1]-this._camera.position[1]);n+=l[3]*c,o+=c;}return 0===o?NaN:n/o;}get center(){return this._center;}set center(e){e.lat===this._center.lat&&e.lng===this._center.lng||(this._unmodified=!1,this._center=e,this._terrainEnabled()&&("ground"===this.cameraElevationReference?this._updateCenterElevation()?this._updateCameraOnTerrain():this._cameraZoom=null:this._updateZoomFromElevation()),this._constrain(),this._calcMatrices());}_updateZoomFromElevation(){if(null==this._cameraZoom||!this._elevation)return;const e=this._cameraZoom,t=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),i=this.pixelsPerMeter/this.worldSize*t,r=this._mercatorZfromZoom(e),n=this._mercatorZfromZoom(this._maxZoom),o=Math.max(r-i,n);this._setZoom(this._zoomFromMercatorZ(o));}get padding(){return this._edgeInsets.toJSON();}set padding(e){this._edgeInsets.equals(e)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,e,1),this._calcMatrices());}computeZoomRelativeTo(t){const i=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,t.toAltitude()));let r;r=t.z<this._camera.position[2]?[i.x,i.y,i.z]:[t.x,t.y,t.z];const n=e.length(e.sub([],this._camera.position,r));return e.clamp(this._zoomFromMercatorZ(n),this._minZoom,this._maxZoom);}setFreeCameraOptions(t){if(!this.height)return;if(!t.position&&!t.orientation)return;this._updateCameraState();let i=!1;if(t.orientation&&!e.exactEquals(t.orientation,this._camera.orientation)&&(i=this._setCameraOrientation(t.orientation)),t.position){const r=[t.position.x,t.position.y,t.position.z];e.exactEquals$1(r,this._camera.position)||(this._setCameraPosition(r),i=!0);}i&&(this._updateStateFromCamera(),this.recenterOnTerrain());}getFreeCameraOptions(){this._updateCameraState();const t=this._camera.position,i=new yr();return i.position=new e.MercatorCoordinate(t[0],t[1],t[2]),i.orientation=this._camera.orientation,i._elevation=this.elevation,i._renderWorldCopies=this.renderWorldCopies,i;}_setCameraOrientation(t){if(!e.length$1(t))return !1;e.normalize$1(t,t);const i=e.transformQuat([],[0,0,-1],t),r=e.transformQuat([],[0,-1,0],t);if(r[2]<0)return !1;const n=gr(i,r);return !!n&&(this._camera.orientation=n,!0);}_setCameraPosition(t){const i=this.zoomScale(this.minZoom)*this.tileSize,r=this.zoomScale(this.maxZoom)*this.tileSize,n=this.cameraToCenterDistance;t[2]=e.clamp(t[2],n/r,n/i),this._camera.position=t;}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height);}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height);}isPaddingEqual(e){return this._edgeInsets.equals(e);}interpolatePadding(e,t,i){this._unmodified=!1,this._edgeInsets.interpolate(e,t,i),this._constrain(),this._calcMatrices();}coveringZoomLevel(e){const t=(e.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/e.tileSize));return Math.max(0,t);}getVisibleUnwrappedCoordinates(t){const i=[new e.UnwrappedTileID(0,t)];if(this.renderWorldCopies){const r=this.pointCoordinate(new e.pointGeometry(0,0)),n=this.pointCoordinate(new e.pointGeometry(this.width,0)),o=this.pointCoordinate(new e.pointGeometry(this.width,this.height)),s=this.pointCoordinate(new e.pointGeometry(0,this.height)),a=Math.floor(Math.min(r.x,n.x,o.x,s.x)),l=Math.floor(Math.max(r.x,n.x,o.x,s.x)),c=1;for(let r=a-c;r<=l+c;r++)0!==r&&i.push(new e.UnwrappedTileID(r,t));}return i;}coveringTiles(t){let i=this.coveringZoomLevel(t);const r=i,n=this.elevation&&!t.isTerrainDEM,o="mercator"===this.projection.name;if(void 0!==t.minzoom&&i<t.minzoom)return [];void 0!==t.maxzoom&&i>t.maxzoom&&(i=t.maxzoom);const s=this.locationCoordinate(this.center),a=1<<i,l=[a*s.x,a*s.y,0],c=e.Frustum.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,i,"globe"!==this.projection.name),h=this.pointCoordinate(this.getCameraPoint()),u=a*e.mercatorZfromAltitude(1,this.center.lat),d=this._camera.position[2]/e.mercatorZfromAltitude(1,this.center.lat),p=[a*h.x,a*h.y,d],f=this.cameraToCenterDistance/t.tileSize*(t.roundZoom?1:.502),m=this.pitch<=60&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace?i:0,_=t.isTerrainDEM&&this._elevation?1e4*this._elevation.exaggeration():this._centerAltitude,g=t.isTerrainDEM?-_:this._elevation?this._elevation.getMinElevationBelowMSL():0,y=this.projection.isReprojectedInTileSpace?br(this):1,x=t=>{const i=1/4e4,r=new e.MercatorCoordinate(t.x+i,t.y,t.z),n=new e.MercatorCoordinate(t.x,t.y+i,t.z),o=t.toLngLat(),s=r.toLngLat(),a=n.toLngLat(),l=this.locationCoordinate(o),c=this.locationCoordinate(s),h=this.locationCoordinate(a),u=Math.hypot(c.x-l.x,c.y-l.y),d=Math.hypot(h.x-l.x,h.y-l.y);return Math.sqrt(u*d)*y/i;},v=t=>{const i=_,r=g;return {aabb:e.tileAABB(this,a,0,0,0,t,r,i,this.projection),zoom:0,x:0,y:0,minZ:r,maxZ:i,wrap:t,fullyVisible:!1};},b=[];let S=[];const w=i,T=t.reparseOverscaled?r:i,E=e=>e*e,N=E((d-this._centerAltitude)*u),I=e=>{if(!this._elevation||!e.tileID||!o)return;const t=this._elevation.getMinMaxForTile(e.tileID),i=e.aabb;t?(i.min[2]=t.min,i.max[2]=t.max,i.center[2]=(i.min[2]+i.max[2])/2):(e.shouldSplit=M(e),e.shouldSplit||(i.min[2]=i.max[2]=i.center[2]=this._centerAltitude));},M=t=>{if(t.zoom<m)return !0;if(t.zoom===w)return !1;if(null!=t.shouldSplit)return t.shouldSplit;const i=t.aabb.distanceX(p),o=t.aabb.distanceY(p);let s=N;n&&(s=E(t.aabb.distanceZ(p)*u));let a=1;if(this.projection.isReprojectedInTileSpace&&r<=5){const i=Math.pow(2,t.zoom),r=x(new e.MercatorCoordinate((t.x+.5)/i,(t.y+.5)/i));a=r>.85?1:r;}const l=i*i+o*o+s;return l<E((1<<w-t.zoom)*f*a*((e,t)=>{if(t*E(.707)<e)return 1;const i=Math.sqrt(t/e);return i/(1.4144271570014144+(Math.pow(1.1,i-1.4144271570014144+1)-1)/(1.1-1)-1);})(Math.max(s,N),l));};if(this.renderWorldCopies)for(let e=1;e<=3;e++)b.push(v(-e)),b.push(v(e));for(b.push(v(0));b.length>0;){const r=b.pop(),s=r.x,h=r.y;let u=r.fullyVisible;if(!u){const e=r.aabb.intersects(c);if(0===e)continue;u=2===e;}if(r.zoom!==w&&M(r))for(let t=0;t<4;t++){const i=(s<<1)+t%2,l=(h<<1)+(t>>1),c={aabb:o?r.aabb.quadrant(t):e.tileAABB(this,a,r.zoom+1,i,l,r.wrap,r.minZ,r.maxZ,this.projection),zoom:r.zoom+1,x:i,y:l,wrap:r.wrap,fullyVisible:u,tileID:void 0,shouldSplit:void 0,minZ:r.minZ,maxZ:r.maxZ};n&&(c.tileID=new e.OverscaledTileID(r.zoom+1===w?T:r.zoom+1,r.wrap,r.zoom+1,i,l),I(c)),b.push(c);}else {const n=r.zoom===w?T:r.zoom;if(t.minzoom&&t.minzoom>n)continue;const o=l[0]-(.5+s+(r.wrap<<r.zoom))*(1<<i-r.zoom),a=l[1]-.5-h,c=r.tileID?r.tileID:new e.OverscaledTileID(n,r.wrap,r.zoom,s,h);S.push({tileID:c,distanceSq:o*o+a*a});}}if(this.fogCullDistSq){const i=this.fogCullDistSq,r=this.horizonLineFromTop();S=S.filter(n=>{const o=[0,0,0,1],s=[e.EXTENT,e.EXTENT,0,1],a=this.calculateFogTileMatrix(n.tileID.toUnwrapped());e.transformMat4$1(o,o,a),e.transformMat4$1(s,s,a);const l=e.getAABBPointSquareDist(o,s);if(0===l)return !0;let c=!1;const h=this._elevation;if(h&&l>i&&0!==r){const i=this.calculateProjMatrix(n.tileID.toUnwrapped());let o;t.isTerrainDEM||(o=h.getMinMaxForTile(n.tileID)),o||(o={min:g,max:_});const s=e.furthestTileCorner(this.rotation),a=[s[0]*e.EXTENT,s[1]*e.EXTENT,o.max];e.transformMat4(a,a,i),c=(1-a[1])*this.height*.5<r;}return l<i||c;});}return S.sort((e,t)=>e.distanceSq-t.distanceSq).map(e=>e.tileID);}resize(e,t){this.width=e,this.height=t,this.pixelsToGLUnits=[2/e,-2/t],this._constrain(),this._calcMatrices();}get unmodified(){return this._unmodified;}zoomScale(e){return Math.pow(2,e);}scaleZoom(e){return Math.log(e)/Math.LN2;}project(t){const i=e.clamp(t.lat,-e.MAX_MERCATOR_LATITUDE,e.MAX_MERCATOR_LATITUDE),r=this.projection.project(t.lng,i);return new e.pointGeometry(r.x*this.worldSize,r.y*this.worldSize);}unproject(e){return this.projection.unproject(e.x/this.worldSize,e.y/this.worldSize);}get point(){return this.project(this.center);}setLocationAtPoint(t,i){const r=this.pointCoordinate(i),n=this.pointCoordinate(this.centerPoint),o=this.locationCoordinate(t);this.setLocation(new e.MercatorCoordinate(o.x-(r.x-n.x),o.y-(r.y-n.y)));}setLocation(e){this.center=this.coordinateLocation(e),this.projection.wrap&&(this.center=this.center.wrap());}locationPoint(e){return this.projection.locationPoint(this,e);}locationPoint3D(e){return this._coordinatePoint(this.locationCoordinate(e),!0);}pointLocation(e){return this.coordinateLocation(this.pointCoordinate(e));}pointLocation3D(e){return this.coordinateLocation(this.pointCoordinate3D(e));}locationCoordinate(t,i){const r=i?e.mercatorZfromAltitude(i,t.lat):void 0,n=this.projection.project(t.lng,t.lat);return new e.MercatorCoordinate(n.x,n.y,r);}coordinateLocation(e){return this.projection.unproject(e.x,e.y);}pointRayIntersection(t,i){const r=null!=i?i:this._centerAltitude,n=[t.x,t.y,0,1],o=[t.x,t.y,1,1];e.transformMat4$1(n,n,this.pixelMatrixInverse),e.transformMat4$1(o,o,this.pixelMatrixInverse);const s=o[3];e.scale$1(n,n,1/n[3]),e.scale$1(o,o,1/s);const a=n[2],l=o[2];return {p0:n,p1:o,t:a===l?0:(r-a)/(l-a)};}screenPointToMercatorRay(t){const i=[t.x,t.y,0,1],r=[t.x,t.y,1,1];return e.transformMat4$1(i,i,this.pixelMatrixInverse),e.transformMat4$1(r,r,this.pixelMatrixInverse),e.scale$1(i,i,1/i[3]),e.scale$1(r,r,1/r[3]),i[2]=e.mercatorZfromAltitude(i[2],this._center.lat)*this.worldSize,r[2]=e.mercatorZfromAltitude(r[2],this._center.lat)*this.worldSize,e.scale$1(i,i,1/this.worldSize),e.scale$1(r,r,1/this.worldSize),new e.Ray([i[0],i[1],i[2]],e.normalize([],e.sub([],r,i)));}rayIntersectionCoordinate(t){const{p0:i,p1:r,t:n}=t,o=e.mercatorZfromAltitude(i[2],this._center.lat),s=e.mercatorZfromAltitude(r[2],this._center.lat);return new e.MercatorCoordinate(e.number(i[0],r[0],n)/this.worldSize,e.number(i[1],r[1],n)/this.worldSize,e.number(o,s,n));}pointCoordinate(e,t=this._centerAltitude){return this.projection.createTileTransform(this,this.worldSize).pointCoordinate(e.x,e.y,t);}pointCoordinate3D(t){if(!this.elevation)return this.pointCoordinate(t);const i=this.elevation;let r=this.elevation.pointCoordinate(t);if(r)return new e.MercatorCoordinate(r[0],r[1],r[2]);let n=0,o=this.horizonLineFromTop();if(t.y>o)return this.pointCoordinate(t);const s=.02*o,a=t.clone();for(let t=0;t<10&&o-n>s;t++){a.y=e.number(n,o,.66);const t=i.pointCoordinate(a);t?(o=a.y,r=t):n=a.y;}return r?new e.MercatorCoordinate(r[0],r[1],r[2]):this.pointCoordinate(t);}isPointAboveHorizon(e){if(this.elevation)return !this.elevation.pointCoordinate(e);{const t=this.horizonLineFromTop();return e.y<t;}}_coordinatePoint(t,i){const r=i&&this.elevation?this.elevation.getAtPointOrZero(t,this._centerAltitude):this._centerAltitude,n=[t.x*this.worldSize,t.y*this.worldSize,r+t.toAltitude(),1];return e.transformMat4$1(n,n,this.pixelMatrix),n[3]>0?new e.pointGeometry(n[0]/n[3],n[1]/n[3]):new e.pointGeometry(Number.MAX_VALUE,Number.MAX_VALUE);}_getBounds(t,i){const r=new e.pointGeometry(this._edgeInsets.left,this._edgeInsets.top),n=new e.pointGeometry(this.width-this._edgeInsets.right,this._edgeInsets.top),o=new e.pointGeometry(this.width-this._edgeInsets.right,this.height-this._edgeInsets.bottom),s=new e.pointGeometry(this._edgeInsets.left,this.height-this._edgeInsets.bottom);let a=this.pointCoordinate(r,t),l=this.pointCoordinate(n,t);const c=this.pointCoordinate(o,i),h=this.pointCoordinate(s,i),u=(e,t)=>(t.y-e.y)/(t.x-e.x);return a.y>1&&l.y>=0?a=new e.MercatorCoordinate((1-h.y)/u(h,a)+h.x,1):a.y<0&&l.y<=1&&(a=new e.MercatorCoordinate(-h.y/u(h,a)+h.x,0)),l.y>1&&a.y>=0?l=new e.MercatorCoordinate((1-c.y)/u(c,l)+c.x,1):l.y<0&&a.y<=1&&(l=new e.MercatorCoordinate(-c.y/u(c,l)+c.x,0)),new e.LngLatBounds().extend(this.coordinateLocation(a)).extend(this.coordinateLocation(l)).extend(this.coordinateLocation(h)).extend(this.coordinateLocation(c));}_getBounds3D(){const e=this.elevation;if(!e.visibleDemTiles.length)return this._getBounds(0,0);const t=e.visibleDemTiles.reduce((e,t)=>{if(t.dem){const i=t.dem.tree;e.min=Math.min(e.min,i.minimums[0]),e.max=Math.max(e.max,i.maximums[0]);}return e;},{min:Number.MAX_VALUE,max:0});return this._getBounds(t.min*e.exaggeration(),t.max*e.exaggeration());}getBounds(){return this._terrainEnabled()?this._getBounds3D():this._getBounds(0,0);}horizonLineFromTop(e=!0){const t=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))+this.centerOffset.y,i=this.height/2-t*(1-this._horizonShift);return e?Math.max(0,i):i;}getMaxBounds(){return this.maxBounds;}setMaxBounds(t){this.maxBounds=t,this.minLat=-e.MAX_MERCATOR_LATITUDE,this.maxLat=e.MAX_MERCATOR_LATITUDE,this.minLng=-180,this.maxLng=180,t&&(this.minLat=t.getSouth(),this.maxLat=t.getNorth(),this.minLng=t.getWest(),this.maxLng=t.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=e.mercatorXfromLng(this.minLng)*this.tileSize,this.worldMaxX=e.mercatorXfromLng(this.maxLng)*this.tileSize,this.worldMinY=e.mercatorYfromLat(this.maxLat)*this.tileSize,this.worldMaxY=e.mercatorYfromLat(this.minLat)*this.tileSize,this._constrain();}calculatePosMatrix(e,t){return this.projection.createTileTransform(this,t).createTileMatrix(e);}calculateDistanceTileData(t){const i=t.key,r=this._distanceTileDataCache;if(r[i])return r[i];const n=t.canonical,o=1/this.height,s=this.cameraWorldSize/this.zoomScale(n.z),a=(n.x+Math.pow(2,n.z)*t.wrap)*s,l=n.y*s,c=this.point,h=this.angle,u=Math.sin(-h),d=-Math.cos(-h);return r[i]={bearing:[u,d],center:[(c.x-a)*o,(c.y-l)*o],scale:s/e.EXTENT*o},r[i];}calculateFogTileMatrix(t){const i=t.key,r=this._fogTileMatrixCache;if(r[i])return r[i];const n=this.calculatePosMatrix(t,this.cameraWorldSize);return e.multiply$1(n,this.worldToFogMatrix,n),r[i]=new Float32Array(n),r[i];}calculateProjMatrix(t,i=!1){const r=t.key,n=i?this._alignedProjMatrixCache:this._projMatrixCache;if(n[r])return n[r];const o=this.calculatePosMatrix(t,this.worldSize);return e.multiply$1(o,this.projection.isReprojectedInTileSpace?this.mercatorMatrix:i?this.alignedProjMatrix:this.projMatrix,o),n[r]=new Float32Array(o),n[r];}calculatePixelsToTileUnitsMatrix(t){const i=t.tileID.key,r=this._pixelsToTileUnitsCache;if(r[i])return r[i];const n=function(t,i){const{scale:r}=t.tileTransform,n=r*e.EXTENT/(t.tileSize*Math.pow(2,i.zoom-t.tileID.overscaledZ+t.tileID.canonical.z));return o=new Float32Array(4),l=(s=i.inverseAdjustmentMatrix)[1],c=s[2],h=s[3],d=(a=[n,n])[1],o[0]=s[0]*(u=a[0]),o[1]=l*u,o[2]=c*d,o[3]=h*d,o;var o,s,a,l,c,h,u,d;}(t,this);return r[i]=n,r[i];}customLayerMatrix(){return this.mercatorMatrix.slice();}recenterOnTerrain(){if(!this._elevation)return;const t=this._elevation;this._updateCameraState();const i=e.mercatorZfromAltitude(1,this._center.lat)*this.worldSize,r=this._computeCameraPosition(i),n=this._camera.forward(),o=e.mercatorZfromAltitude(1,this._center.lat);r[2]/=o,n[2]/=o,e.normalize(n,n);const s=t.raycast(r,n,t.exaggeration());if(s){const t=e.scaleAndAdd([],r,n,s),i=new e.MercatorCoordinate(t[0],t[1],e.mercatorZfromAltitude(t[2],e.latFromMercatorY(t[1]))),a=(i.z+e.length([i.x-r[0],i.y-r[1],i.z-r[2]*o]))*this._projectionScaler;this._cameraZoom=this._zoomFromMercatorZ(a),this._centerAltitude=i.toAltitude(),this._center=this.coordinateLocation(i),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices();}}_constrainCameraAltitude(){if(!this._elevation)return;const t=this._elevation;this._updateCameraState();const i=e.mercatorZfromAltitude(1,this._center.lat)*this.worldSize,r=this._computeCameraPosition(i),n=t.getAtPointOrZero(new e.MercatorCoordinate(...r)),o=this._minimumHeightOverTerrain()*Math.cos(e.degToRad(this._maxPitch)),s=this._camera.position[2]-this.pixelsPerMeter/this.worldSize*n;if(s<o){const t=this.locationCoordinate(this._center,this._centerAltitude),i=[t.x-r[0],t.y-r[1],t.z-r[2]],n=e.length(i);i[2]-=(o-s)/this._projectionScaler;const a=e.length(i);if(0===a)return;e.scale$2(i,i,n/a*this._projectionScaler),this._camera.position=[t.x-i[0],t.y-i[1],t.z*this._projectionScaler-i[2]],this._camera.orientation=gr(i,this._camera.up()),this._updateStateFromCamera();}}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;if(this._constraining=!0,this.projection.isReprojectedInTileSpace){const t=this.center;return t.lat=e.clamp(t.lat,this.minLat,this.maxLat),!this.maxBounds&&this.renderWorldCopies||(t.lng=e.clamp(t.lng,this.minLng,this.maxLng)),this.center=t,void(this._constraining=!1);}const t=this._unmodified,{x:i,y:r}=this.point;let n=0,o=i,s=r;const a=this.width/2,l=this.height/2,c=this.worldMinY*this.scale,h=this.worldMaxY*this.scale;if(r-l<c&&(s=c+l),r+l>h&&(s=h-l),h-c<this.height&&(n=Math.max(n,this.height/(h-c)),s=(h+c)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const e=this.worldMinX*this.scale,t=this.worldMaxX*this.scale,r=this.worldSize/2-(e+t)/2;o=(i+r+this.worldSize)%this.worldSize-r,o-a<e&&(o=e+a),o+a>t&&(o=t-a),t-e<this.width&&(n=Math.max(n,this.width/(t-e)),o=(t+e)/2);}o===i&&s===r||(this.center=this.unproject(new e.pointGeometry(o,s))),n&&(this.zoom+=this.scaleZoom(n)),this._constrainCameraAltitude(),this._unmodified=t,this._constraining=!1;}_minZoomForBounds(){let e=Math.max(0,this.scaleZoom(this.height/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(e=Math.max(e,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),e;}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds());}_calcMatrices(){if(!this.height)return;const t=this._fov/2,i=this.centerOffset,r=this.pixelsPerMeter;this._projectionScaler=r/(e.mercatorZfromAltitude(1,this.center.lat)*this.worldSize),this.cameraToCenterDistance=.5/Math.tan(t)*this.height*this._projectionScaler,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const o=this._camera.getWorldToCamera(this.worldSize,"meters"===this.projection.zAxisUnit?r:1),s=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);s[8]=2*-i.x/this.width,s[9]=2*i.y/this.height;let a=e.mul([],s,o);if(this.projection.isReprojectedInTileSpace){const t=this.locationCoordinate(this.center),i=e.identity([]);e.translate(i,i,[t.x*this.worldSize,t.y*this.worldSize,0]),e.multiply$1(i,i,vr(this)),e.translate(i,i,[-t.x*this.worldSize,-t.y*this.worldSize,0]),e.multiply$1(a,a,i),this.inverseAdjustmentMatrix=function(e){const t=vr(e,!0);return n([],[t[0],t[1],t[4],t[5]]);}(this);}else this.inverseAdjustmentMatrix=[1,0,0,1];this.mercatorMatrix=e.scale([],a,[this.worldSize,this.worldSize,this.worldSize/r,1]),this.projMatrix=a,this.invProjMatrix=e.invert(new Float64Array(16),this.projMatrix);const l=new Float32Array(16);e.identity(l),e.scale(l,l,[1,-1,1]),e.rotateX(l,l,this._pitch),e.rotateZ(l,l,this.angle);const c=e.perspective(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ),h=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;c[8]=2*-i.x/this.width,c[9]=2*(i.y+h)/this.height,this.skyboxMatrix=e.multiply$1(l,c,l);const u=this.point,d=u.x,p=u.y,f=this.width%2/2,m=this.height%2/2,_=Math.cos(this.angle),g=Math.sin(this.angle),y=d-Math.round(d)+_*f+g*m,x=p-Math.round(p)+_*m+g*f,v=new Float64Array(a);if(e.translate(v,v,[y>.5?y-1:y,x>.5?x-1:x,0]),this.alignedProjMatrix=v,a=e.create(),e.scale(a,a,[this.width/2,-this.height/2,1]),e.translate(a,a,[1,-1,0]),this.labelPlaneMatrix=a,a=e.create(),e.scale(a,a,[1,-1,1]),e.translate(a,a,[-1,-1,0]),e.scale(a,a,[2/this.width,2/this.height,1]),this.glCoordMatrix=a,this.pixelMatrix=e.multiply$1(new Float64Array(16),this.labelPlaneMatrix,this.projMatrix),this._calcFogMatrices(),this._distanceTileDataCache={},a=e.invert(new Float64Array(16),this.pixelMatrix),!a)throw new Error("failed to invert matrix");this.pixelMatrixInverse=a,this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={};}_calcFogMatrices(){this._fogTileMatrixCache={};const t=this.cameraWorldSize,i=this.cameraPixelsPerMeter,r=this._camera.position,n=1/this.height,o=[t,t,i];e.scale$2(o,o,n),e.scale$2(r,r,-1),e.multiply$2(r,r,o);const s=e.create();e.translate(s,s,r),e.scale(s,s,o),this.mercatorFogMatrix=s,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(t,i,n);}_computeCameraPosition(e){const t=(e=e||this.pixelsPerMeter)/this.pixelsPerMeter,i=this._camera.forward(),r=this.point,n=this._mercatorZfromZoom(this._cameraZoom?this._cameraZoom:this._zoom)*t-e/this.worldSize*this._centerAltitude;return [r.x/this.worldSize-i[0]*n,r.y/this.worldSize-i[1]*n,e/this.worldSize*this._centerAltitude-i[2]*n];}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition());}_translateCameraConstrained(t){const i=this._maxCameraBoundsDistance()*Math.cos(this._pitch),r=t[2];let n=1;r>0&&(n=Math.min((i-this._camera.position[2])/r,1)),this._camera.position=e.scaleAndAdd([],this._camera.position,t,n),this._updateStateFromCamera();}_updateStateFromCamera(){const t=this._camera.position,i=this._camera.forward(),{pitch:r,bearing:n}=this._camera.getPitchBearing(),o=e.mercatorZfromAltitude(this._centerAltitude,this.center.lat)*this._projectionScaler,s=this._mercatorZfromZoom(this._maxZoom)*Math.cos(e.degToRad(this._maxPitch)),a=Math.max((t[2]-o)/Math.cos(r),s),l=this._zoomFromMercatorZ(a);e.scaleAndAdd(t,t,i,a),this._pitch=e.clamp(r,e.degToRad(this.minPitch),e.degToRad(this.maxPitch)),this.angle=e.wrap(n,-Math.PI,Math.PI),this._setZoom(e.clamp(l,this._minZoom,this._maxZoom)),this._terrainEnabled()&&this._updateCameraOnTerrain(),this._center=this.coordinateLocation(new e.MercatorCoordinate(t[0],t[1],t[2])),this._unmodified=!1,this._constrain(),this._calcMatrices();}_worldSizeFromZoom(e){return Math.pow(2,e)*this.tileSize;}_mercatorZfromZoom(e){return this.cameraToCenterDistance/this._worldSizeFromZoom(e);}_minimumHeightOverTerrain(){const e=Math.min((null!=this._cameraZoom?this._cameraZoom:this._zoom)+2,this._maxZoom);return this._mercatorZfromZoom(e);}_zoomFromMercatorZ(e){return this.scaleZoom(this.cameraToCenterDistance/(e*this.tileSize));}_terrainEnabled(){return !(!this._elevation||!this.projection.supportsTerrain&&(e.warnOnce("Terrain is not yet supported with alternate projections. Use mercator to enable terrain."),1));}anyCornerOffEdge(t,i){const r=Math.min(t.x,i.x),n=Math.max(t.x,i.x),o=Math.min(t.y,i.y),s=Math.max(t.y,i.y);if(o<this.horizonLineFromTop(!1))return !0;if("mercator"!==this.projection.name)return !1;const a=[new e.pointGeometry(r,o),new e.pointGeometry(n,s),new e.pointGeometry(r,s),new e.pointGeometry(n,o)],l=this.renderWorldCopies?-3:0,c=this.renderWorldCopies?4:1;for(const e of a){const t=this.pointRayIntersection(e);if(t.t<0)return !0;const i=this.rayIntersectionCoordinate(t);if(i.x<l||i.y<0||i.x>c||i.y>1)return !0;}return !1;}isHorizonVisible(){return this.pitch+e.radToDeg(this.fovAboveCenter)>88||this.anyCornerOffEdge(new e.pointGeometry(0,0),new e.pointGeometry(this.width,this.height));}zoomDeltaToMovement(t,i){const r=e.length(e.sub([],this._camera.position,t)),n=this._zoomFromMercatorZ(r)+i;return r-this._mercatorZfromZoom(n);}getCameraPoint(){const t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new e.pointGeometry(0,t));}}function Ir(e,t){let i=!1,r=null;const n=()=>{r=null,i&&(e(),r=setTimeout(n,t),i=!1);};return ()=>(i=!0,r||n(),r);}class Mr{constructor(t){this._hashName=t&&encodeURIComponent(t),e.bindAll(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=Ir(this._updateHashUnthrottled.bind(this),300);}addTo(t){return this._map=t,e.window.addEventListener("hashchange",this._onHashChange,!1),this._map.on("moveend",this._updateHash),this;}remove(){return e.window.removeEventListener("hashchange",this._onHashChange,!1),this._map.off("moveend",this._updateHash),clearTimeout(this._updateHash()),delete this._map,this;}getHashString(t){const i=this._map.getCenter(),r=Math.round(100*this._map.getZoom())/100,n=Math.ceil((r*Math.LN2+Math.log(512/360/.5))/Math.LN10),o=Math.pow(10,n),s=Math.round(i.lng*o)/o,a=Math.round(i.lat*o)/o,l=this._map.getBearing(),c=this._map.getPitch();let h="";if(h+=t?`/${s}/${a}/${r}`:`${r}/${a}/${s}`,(l||c)&&(h+="/"+Math.round(10*l)/10),c&&(h+=`/${Math.round(c)}`),this._hashName){const t=this._hashName;let i=!1;const r=e.window.location.hash.slice(1).split("&").map(e=>{const r=e.split("=")[0];return r===t?(i=!0,`${r}=${h}`):e;}).filter(e=>e);return i||r.push(`${t}=${h}`),`#${r.join("&")}`;}return `#${h}`;}_getCurrentHash(){const t=e.window.location.hash.replace("#","");if(this._hashName){let e;return t.split("&").map(e=>e.split("=")).forEach(t=>{t[0]===this._hashName&&(e=t);}),(e&&e[1]||"").split("/");}return t.split("/");}_onHashChange(){const e=this._getCurrentHash();if(e.length>=3&&!e.some(e=>isNaN(e))){const t=this._map.dragRotate.isEnabled()&&this._map.touchZoomRotate.isEnabled()?+(e[3]||0):this._map.getBearing();return this._map.jumpTo({center:[+e[2],+e[1]],zoom:+e[0],bearing:t,pitch:+(e[4]||0)}),!0;}return !1;}_updateHashUnthrottled(){const t=e.window.location.href.replace(/(#.+)?$/,this.getHashString());e.window.history.replaceState(e.window.history.state,null,t);}}const Cr={linearity:.3,easing:e.bezier(0,0,.3,1)},Ar=e.extend({deceleration:2500,maxSpeed:1400},Cr),Pr=e.extend({deceleration:20,maxSpeed:1400},Cr),Lr=e.extend({deceleration:1e3,maxSpeed:360},Cr),Dr=e.extend({deceleration:1e3,maxSpeed:90},Cr);class kr{constructor(e){this._map=e,this.clear();}clear(){this._inertiaBuffer=[];}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:e.exported.now(),settings:t});}_drainInertiaBuffer(){const t=this._inertiaBuffer,i=e.exported.now();for(;t.length>0&&i-t[0].time>160;)t.shift();}_onMoveEnd(t){if(this._drainInertiaBuffer(),this._inertiaBuffer.length<2)return;const i={zoom:0,bearing:0,pitch:0,pan:new e.pointGeometry(0,0),pinchAround:void 0,around:void 0};for(const{settings:e}of this._inertiaBuffer)i.zoom+=e.zoomDelta||0,i.bearing+=e.bearingDelta||0,i.pitch+=e.pitchDelta||0,e.panDelta&&i.pan._add(e.panDelta),e.around&&(i.around=e.around),e.pinchAround&&(i.pinchAround=e.pinchAround);const r=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,n={};if(i.pan.mag()){const o=Rr(i.pan.mag(),r,e.extend({},Ar,t||{}));n.offset=i.pan.mult(o.amount/i.pan.mag()),n.center=this._map.transform.center,zr(n,o);}if(i.zoom){const e=Rr(i.zoom,r,Pr);n.zoom=this._map.transform.zoom+e.amount,zr(n,e);}if(i.bearing){const t=Rr(i.bearing,r,Lr);n.bearing=this._map.transform.bearing+e.clamp(t.amount,-179,179),zr(n,t);}if(i.pitch){const e=Rr(i.pitch,r,Dr);n.pitch=this._map.transform.pitch+e.amount,zr(n,e);}if(n.zoom||n.bearing){const e=void 0===i.pinchAround?i.around:i.pinchAround;n.around=e?this._map.unproject(e):this._map.getCenter();}return this.clear(),e.extend(n,{noMoveStart:!0});}}function zr(e,t){(!e.duration||e.duration<t.duration)&&(e.duration=t.duration,e.easing=t.easing);}function Rr(t,i,r){const{maxSpeed:n,linearity:o,deceleration:s}=r,a=e.clamp(t*o/(i/1e3),-n,n),l=Math.abs(a)/(s*o);return {easing:r.easing,duration:1e3*l,amount:a*(l/2)};}class Or extends e.Event{preventDefault(){this._defaultPrevented=!0;}get defaultPrevented(){return this._defaultPrevented;}constructor(t,i,r,n={}){const o=s.mousePos(i.getCanvasContainer(),r),a=i.unproject(o);super(t,e.extend({point:o,lngLat:a,originalEvent:r},n)),this._defaultPrevented=!1,this.target=i;}}class Fr extends e.Event{preventDefault(){this._defaultPrevented=!0;}get defaultPrevented(){return this._defaultPrevented;}constructor(t,i,r){const n="touchend"===t?r.changedTouches:r.touches,o=s.touchPos(i.getCanvasContainer(),n),a=o.map(e=>i.unproject(e)),l=o.reduce((e,t,i,r)=>e.add(t.div(r.length)),new e.pointGeometry(0,0));super(t,{points:o,point:l,lngLats:a,lngLat:i.unproject(l),originalEvent:r}),this._defaultPrevented=!1;}}class Br extends e.Event{preventDefault(){this._defaultPrevented=!0;}get defaultPrevented(){return this._defaultPrevented;}constructor(e,t,i){super(e,{originalEvent:i}),this._defaultPrevented=!1;}}class Ur{constructor(e,t){this._map=e,this._clickTolerance=t.clickTolerance;}reset(){delete this._mousedownPos;}wheel(e){return this._firePreventable(new Br(e.type,this._map,e));}mousedown(e,t){return this._mousedownPos=t,this._firePreventable(new Or(e.type,this._map,e));}mouseup(e){this._map.fire(new Or(e.type,this._map,e));}preclick(t){const i=e.extend({},t);i.type="preclick",this._map.fire(new Or(i.type,this._map,i));}click(e,t){this._mousedownPos&&this._mousedownPos.dist(t)>=this._clickTolerance||(this.preclick(e),this._map.fire(new Or(e.type,this._map,e)));}dblclick(e){return this._firePreventable(new Or(e.type,this._map,e));}mouseover(e){this._map.fire(new Or(e.type,this._map,e));}mouseout(e){this._map.fire(new Or(e.type,this._map,e));}touchstart(e){return this._firePreventable(new Fr(e.type,this._map,e));}touchmove(e){this._map.fire(new Fr(e.type,this._map,e));}touchend(e){this._map.fire(new Fr(e.type,this._map,e));}touchcancel(e){this._map.fire(new Fr(e.type,this._map,e));}_firePreventable(e){if(this._map.fire(e),e.defaultPrevented)return {};}isEnabled(){return !0;}isActive(){return !1;}enable(){}disable(){}}class Vr{constructor(e){this._map=e;}reset(){this._delayContextMenu=!1,delete this._contextMenuEvent;}mousemove(e){this._map.fire(new Or(e.type,this._map,e));}mousedown(){this._delayContextMenu=!0;}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new Or("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent);}contextmenu(e){this._delayContextMenu?this._contextMenuEvent=e:this._map.fire(new Or(e.type,this._map,e)),this._map.listens("contextmenu")&&e.preventDefault();}isEnabled(){return !0;}isActive(){return !1;}enable(){}disable(){}}class Gr{constructor(e,t){this._map=e,this._el=e.getCanvasContainer(),this._container=e.getContainer(),this._clickTolerance=t.clickTolerance||1;}isEnabled(){return !!this._enabled;}isActive(){return !!this._active;}enable(){this.isEnabled()||(this._enabled=!0);}disable(){this.isEnabled()&&(this._enabled=!1);}mousedown(e,t){this.isEnabled()&&e.shiftKey&&0===e.button&&(s.disableDrag(),this._startPos=this._lastPos=t,this._active=!0);}mousemoveWindow(e,t){if(!this._active)return;const i=t;if(this._lastPos.equals(i)||!this._box&&i.dist(this._startPos)<this._clickTolerance)return;const r=this._startPos;this._lastPos=i,this._box||(this._box=s.create("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",e));const n=Math.min(r.x,i.x),o=Math.max(r.x,i.x),a=Math.min(r.y,i.y),l=Math.max(r.y,i.y);this._map._requestDomTask(()=>{this._box&&(this._box.style.transform=`translate(${n}px,${a}px)`,this._box.style.width=o-n+"px",this._box.style.height=l-a+"px");});}mouseupWindow(t,i){if(!this._active)return;if(0!==t.button)return;const r=this._startPos,n=i;if(this.reset(),s.suppressClick(),r.x!==n.x||r.y!==n.y)return this._map.fire(new e.Event("boxzoomend",{originalEvent:t})),{cameraAnimation:e=>e.fitScreenCoordinates(r,n,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",t);}keydown(e){this._active&&27===e.keyCode&&(this.reset(),this._fireEvent("boxzoomcancel",e));}blur(){this.reset();}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),s.enableDrag(),delete this._startPos,delete this._lastPos;}_fireEvent(t,i){return this._map.fire(new e.Event(t,{originalEvent:i}));}}function jr(e,t){const i={};for(let r=0;r<e.length;r++)i[e[r].identifier]=t[r];return i;}class $r{constructor(e){this.reset(),this.numTouches=e.numTouches;}reset(){delete this.centroid,delete this.startTime,delete this.touches,this.aborted=!1;}touchstart(t,i,r){(this.centroid||r.length>this.numTouches)&&(this.aborted=!0),this.aborted||(void 0===this.startTime&&(this.startTime=t.timeStamp),r.length===this.numTouches&&(this.centroid=function(t){const i=new e.pointGeometry(0,0);for(const e of t)i._add(e);return i.div(t.length);}(i),this.touches=jr(r,i)));}touchmove(e,t,i){if(this.aborted||!this.centroid)return;const r=jr(i,t);for(const e in this.touches){const t=this.touches[e],i=r[e];(!i||i.dist(t)>30)&&(this.aborted=!0);}}touchend(e,t,i){if((!this.centroid||e.timeStamp-this.startTime>500)&&(this.aborted=!0),0===i.length){const e=!this.aborted&&this.centroid;if(this.reset(),e)return e;}}}class Hr{constructor(e){this.singleTap=new $r(e),this.numTaps=e.numTaps,this.reset();}reset(){this.lastTime=1/0,delete this.lastTap,this.count=0,this.singleTap.reset();}touchstart(e,t,i){this.singleTap.touchstart(e,t,i);}touchmove(e,t,i){this.singleTap.touchmove(e,t,i);}touchend(e,t,i){const r=this.singleTap.touchend(e,t,i);if(r){const t=e.timeStamp-this.lastTime<500,i=!this.lastTap||this.lastTap.dist(r)<30;if(t&&i||this.reset(),this.count++,this.lastTime=e.timeStamp,this.lastTap=r,this.count===this.numTaps)return this.reset(),r;}}}class qr{constructor(){this._zoomIn=new Hr({numTouches:1,numTaps:2}),this._zoomOut=new Hr({numTouches:2,numTaps:1}),this.reset();}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset();}touchstart(e,t,i){this._zoomIn.touchstart(e,t,i),this._zoomOut.touchstart(e,t,i);}touchmove(e,t,i){this._zoomIn.touchmove(e,t,i),this._zoomOut.touchmove(e,t,i);}touchend(e,t,i){const r=this._zoomIn.touchend(e,t,i),n=this._zoomOut.touchend(e,t,i);return r?(this._active=!0,e.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:t=>t.easeTo({duration:300,zoom:t.getZoom()+1,around:t.unproject(r)},{originalEvent:e})}):n?(this._active=!0,e.preventDefault(),setTimeout(()=>this.reset(),0),{cameraAnimation:t=>t.easeTo({duration:300,zoom:t.getZoom()-1,around:t.unproject(n)},{originalEvent:e})}):void 0;}touchcancel(){this.reset();}enable(){this._enabled=!0;}disable(){this._enabled=!1,this.reset();}isEnabled(){return this._enabled;}isActive(){return this._active;}}const Zr={0:1,2:2};class Xr{constructor(e){this.reset(),this._clickTolerance=e.clickTolerance||1;}blur(){this.reset();}reset(){this._active=!1,this._moved=!1,delete this._lastPoint,delete this._eventButton;}_correctButton(e,t){return !1;}_move(e,t){return {};}mousedown(e,t){if(this._lastPoint)return;const i=s.mouseButton(e);this._correctButton(e,i)&&(this._lastPoint=t,this._eventButton=i);}mousemoveWindow(e,t){const i=this._lastPoint;if(i)if(e.preventDefault(),function(e,t){const i=Zr[t];return void 0===e.buttons||(e.buttons&i)!==i;}(e,this._eventButton))this.reset();else if(this._moved||!(t.dist(i)<this._clickTolerance))return this._moved=!0,this._lastPoint=t,this._move(i,t);}mouseupWindow(e){this._lastPoint&&s.mouseButton(e)===this._eventButton&&(this._moved&&s.suppressClick(),this.reset());}enable(){this._enabled=!0;}disable(){this._enabled=!1,this.reset();}isEnabled(){return this._enabled;}isActive(){return this._active;}}class Wr extends Xr{mousedown(e,t){super.mousedown(e,t),this._lastPoint&&(this._active=!0);}_correctButton(e,t){return 0===t&&!e.ctrlKey;}_move(e,t){return {around:t,panDelta:t.sub(e)};}}class Yr extends Xr{_correctButton(e,t){return 0===t&&e.ctrlKey||2===t;}_move(e,t){const i=.8*(t.x-e.x);if(i)return this._active=!0,{bearingDelta:i};}contextmenu(e){e.preventDefault();}}class Jr extends Xr{_correctButton(e,t){return 0===t&&e.ctrlKey||2===t;}_move(e,t){const i=-.5*(t.y-e.y);if(i)return this._active=!0,{pitchDelta:i};}contextmenu(e){e.preventDefault();}}class Kr{constructor(t,i){this._map=t,this._el=t.getCanvasContainer(),this._minTouches=1,this._clickTolerance=i.clickTolerance||1,this.reset(),e.bindAll(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this);}reset(){this._active=!1,this._touches={},this._sum=new e.pointGeometry(0,0);}touchstart(e,t,i){return this._calculateTransform(e,t,i);}touchmove(e,t,i){if(this._active&&!(i.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(1===i.length)return void this._showTouchPanBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer));}return e.preventDefault(),this._calculateTransform(e,t,i);}}touchend(e,t,i){this._calculateTransform(e,t,i),this._active&&i.length<this._minTouches&&this.reset();}touchcancel(){this.reset();}_calculateTransform(t,i,r){r.length>0&&(this._active=!0);const n=jr(r,i),o=new e.pointGeometry(0,0),s=new e.pointGeometry(0,0);let a=0;for(const e in n){const t=n[e],i=this._touches[e];i&&(o._add(t),s._add(t.sub(i)),a++,n[e]=t);}if(this._touches=n,a<this._minTouches||!s.mag())return;const l=s.div(a);return this._sum._add(l),this._sum.mag()<this._clickTolerance?void 0:{around:o.div(a),panDelta:l};}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"));}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset();}isEnabled(){return this._enabled;}isActive(){return this._active;}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=s.create("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`);}_showTouchPanBlockerAlert(){"hidden"===this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="visible"),this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show");},500);}}class Qr{constructor(){this.reset();}reset(){this._active=!1,delete this._firstTwoTouches;}_start(e){}_move(e,t,i){return {};}touchstart(e,t,i){this._firstTwoTouches||i.length<2||(this._firstTwoTouches=[i[0].identifier,i[1].identifier],this._start([t[0],t[1]]));}touchmove(e,t,i){if(!this._firstTwoTouches)return;e.preventDefault();const[r,n]=this._firstTwoTouches,o=en(i,t,r),s=en(i,t,n);if(!o||!s)return;const a=this._aroundCenter?null:o.add(s).div(2);return this._move([o,s],a,e);}touchend(e,t,i){if(!this._firstTwoTouches)return;const[r,n]=this._firstTwoTouches,o=en(i,t,r),a=en(i,t,n);o&&a||(this._active&&s.suppressClick(),this.reset());}touchcancel(){this.reset();}enable(e){this._enabled=!0,this._aroundCenter=!!e&&"center"===e.around;}disable(){this._enabled=!1,this.reset();}isEnabled(){return this._enabled;}isActive(){return this._active;}}function en(e,t,i){for(let r=0;r<e.length;r++)if(e[r].identifier===i)return t[r];}function tn(e,t){return Math.log(e/t)/Math.LN2;}class rn extends Qr{reset(){super.reset(),delete this._distance,delete this._startDistance;}_start(e){this._startDistance=this._distance=e[0].dist(e[1]);}_move(e,t){const i=this._distance;if(this._distance=e[0].dist(e[1]),this._active||!(Math.abs(tn(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:tn(this._distance,i),pinchAround:t};}}function nn(e,t){return 180*e.angleWith(t)/Math.PI;}class on extends Qr{reset(){super.reset(),delete this._minDiameter,delete this._startVector,delete this._vector;}_start(e){this._startVector=this._vector=e[0].sub(e[1]),this._minDiameter=e[0].dist(e[1]);}_move(e,t){const i=this._vector;if(this._vector=e[0].sub(e[1]),this._active||!this._isBelowThreshold(this._vector))return this._active=!0,{bearingDelta:nn(this._vector,i),pinchAround:t};}_isBelowThreshold(e){this._minDiameter=Math.min(this._minDiameter,e.mag());const t=25/(Math.PI*this._minDiameter)*360,i=nn(e,this._startVector);return Math.abs(i)<t;}}function sn(e){return Math.abs(e.y)>Math.abs(e.x);}class an extends Qr{constructor(e){super(),this._map=e;}reset(){super.reset(),this._valid=void 0,delete this._firstMove,delete this._lastPoints;}_start(e){this._lastPoints=e,sn(e[0].sub(e[1]))&&(this._valid=!1);}_move(e,t,i){const r=e[0].sub(this._lastPoints[0]),n=e[1].sub(this._lastPoints[1]);if(!(this._map._cooperativeGestures&&i.touches.length<3)&&(this._valid=this.gestureBeginsVertically(r,n,i.timeStamp),this._valid))return this._lastPoints=e,this._active=!0,{pitchDelta:(r.y+n.y)/2*-.5};}gestureBeginsVertically(e,t,i){if(void 0!==this._valid)return this._valid;const r=e.mag()>=2,n=t.mag()>=2;if(!r&&!n)return;if(!r||!n)return void 0===this._firstMove&&(this._firstMove=i),i-this._firstMove<100&&void 0;const o=e.y>0==t.y>0;return sn(e)&&sn(t)&&o;}}const ln={panStep:100,bearingStep:15,pitchStep:10};class cn{constructor(){const e=ln;this._panStep=e.panStep,this._bearingStep=e.bearingStep,this._pitchStep=e.pitchStep,this._rotationDisabled=!1;}blur(){this.reset();}reset(){this._active=!1;}keydown(e){if(e.altKey||e.ctrlKey||e.metaKey)return;let t=0,i=0,r=0,n=0,o=0;switch(e.keyCode){case 61:case 107:case 171:case 187:t=1;break;case 189:case 109:case 173:t=-1;break;case 37:e.shiftKey?i=-1:(e.preventDefault(),n=-1);break;case 39:e.shiftKey?i=1:(e.preventDefault(),n=1);break;case 38:e.shiftKey?r=1:(e.preventDefault(),o=-1);break;case 40:e.shiftKey?r=-1:(e.preventDefault(),o=1);break;default:return;}return this._rotationDisabled&&(i=0,r=0),{cameraAnimation:s=>{const a=s.getZoom();s.easeTo({duration:300,easeId:"keyboardHandler",easing:hn,zoom:t?Math.round(a)+t*(e.shiftKey?2:1):a,bearing:s.getBearing()+i*this._bearingStep,pitch:s.getPitch()+r*this._pitchStep,offset:[-n*this._panStep,-o*this._panStep],center:s.getCenter()},{originalEvent:e});}};}enable(){this._enabled=!0;}disable(){this._enabled=!1,this.reset();}isEnabled(){return this._enabled;}isActive(){return this._active;}disableRotation(){this._rotationDisabled=!0;}enableRotation(){this._rotationDisabled=!1;}}function hn(e){return e*(2-e);}const un=4.000244140625;class dn{constructor(t,i){this._map=t,this._el=t.getCanvasContainer(),this._handler=i,this._delta=0,this._defaultZoomRate=.01,this._wheelZoomRate=.0022222222222222222,e.bindAll(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert","_isFullscreen"],this);}setZoomRate(e){this._defaultZoomRate=e;}setWheelZoomRate(e){this._wheelZoomRate=e;}isEnabled(){return !!this._enabled;}isActive(){return !!this._active||void 0!==this._finishTimeout;}isZooming(){return !!this._zooming;}enable(e){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!e&&"center"===e.around,this._map._cooperativeGestures&&this._addScrollZoomBlocker());}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()));}wheel(t){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(t.ctrlKey||t.metaKey||this.isZooming()||this._isFullscreen()))return void this._showBlockerAlert();"hidden"!==this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer));}let i=t.deltaMode===e.window.WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY;const r=e.exported.now(),n=r-(this._lastWheelEventTime||0);this._lastWheelEventTime=r,0!==i&&i%un==0?this._type="wheel":0!==i&&Math.abs(i)<4?this._type="trackpad":n>400?(this._type=null,this._lastValue=i,this._timeout=setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(n*i)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,i+=this._lastValue)),t.shiftKey&&i&&(i/=4),this._type&&(this._lastWheelEvent=t,this._delta-=i,this._active||this._start(t)),t.preventDefault();}_onTimeout(e){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(e);}_start(e){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const t=s.mousePos(this._el,e);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:t,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame());}renderFrame(){if(!this._frameId)return;if(this._frameId=null,!this.isActive())return;const t=this._map.transform,i=()=>t._terrainEnabled()&&this._aroundCoord?t.computeZoomRelativeTo(this._aroundCoord):t.zoom;if(0!==this._delta){const e="wheel"===this._type&&Math.abs(this._delta)>un?this._wheelZoomRate:this._defaultZoomRate;let r=2/(1+Math.exp(-Math.abs(this._delta*e)));this._delta<0&&0!==r&&(r=1/r);const n=i(),o=Math.pow(2,n),s="number"==typeof this._targetZoom?t.zoomScale(this._targetZoom):o;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(s*r))),"wheel"===this._type&&(this._startZoom=i(),this._easing=this._smoothOutEasing(200)),this._delta=0;}const r="number"==typeof this._targetZoom?this._targetZoom:i(),n=this._startZoom,o=this._easing;let s,a=!1;if("wheel"===this._type&&n&&o){const t=Math.min((e.exported.now()-this._lastWheelEventTime)/200,1),i=o(t);s=e.number(n,r,i),t<1?this._frameId||(this._frameId=!0):a=!0;}else s=r,a=!0;return this._active=!0,a&&(this._active=!1,this._finishTimeout=setTimeout(()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout;},200)),{noInertia:!0,needsRenderFrame:!a,zoomDelta:s-i(),around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent};}_smoothOutEasing(t){let i=e.ease;if(this._prevEase){const t=this._prevEase,r=(e.exported.now()-t.start)/t.duration,n=t.easing(r+.01)-t.easing(r),o=.27/Math.sqrt(n*n+1e-4)*.01,s=Math.sqrt(.0729-o*o);i=e.bezier(o,s,.25,1);}return this._prevEase={start:e.exported.now(),duration:t,easing:i},i;}blur(){this.reset();}reset(){this._active=!1;}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=s.create("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(e.window.navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`);}_isFullscreen(){return !!e.window.document.fullscreenElement||!!e.window.document.webkitFullscreenElement;}_showBlockerAlert(){"hidden"===this._alertContainer.style.visibility&&(this._alertContainer.style.visibility="visible"),this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),clearTimeout(this._alertTimer),this._alertTimer=setTimeout(()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show");},200);}}class pn{constructor(e,t){this._clickZoom=e,this._tapZoom=t;}enable(){this._clickZoom.enable(),this._tapZoom.enable();}disable(){this._clickZoom.disable(),this._tapZoom.disable();}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled();}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive();}}class fn{constructor(){this.reset();}reset(){this._active=!1;}blur(){this.reset();}dblclick(e,t){return e.preventDefault(),{cameraAnimation:i=>{i.easeTo({duration:300,zoom:i.getZoom()+(e.shiftKey?-1:1),around:i.unproject(t)},{originalEvent:e});}};}enable(){this._enabled=!0;}disable(){this._enabled=!1,this.reset();}isEnabled(){return this._enabled;}isActive(){return this._active;}}class mn{constructor(){this._tap=new Hr({numTouches:1,numTaps:1}),this.reset();}reset(){this._active=!1,delete this._swipePoint,delete this._swipeTouch,delete this._tapTime,this._tap.reset();}touchstart(e,t,i){this._swipePoint||(this._tapTime&&e.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?i.length>0&&(this._swipePoint=t[0],this._swipeTouch=i[0].identifier):this._tap.touchstart(e,t,i));}touchmove(e,t,i){if(this._tapTime){if(this._swipePoint){if(i[0].identifier!==this._swipeTouch)return;const r=t[0],n=r.y-this._swipePoint.y;return this._swipePoint=r,e.preventDefault(),this._active=!0,{zoomDelta:n/128};}}else this._tap.touchmove(e,t,i);}touchend(e,t,i){this._tapTime?this._swipePoint&&0===i.length&&this.reset():this._tap.touchend(e,t,i)&&(this._tapTime=e.timeStamp);}touchcancel(){this.reset();}enable(){this._enabled=!0;}disable(){this._enabled=!1,this.reset();}isEnabled(){return this._enabled;}isActive(){return this._active;}}class _n{constructor(e,t,i){this._el=e,this._mousePan=t,this._touchPan=i;}enable(e){this._inertiaOptions=e||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan");}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan");}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled();}isActive(){return this._mousePan.isActive()||this._touchPan.isActive();}}class gn{constructor(e,t,i){this._pitchWithRotate=e.pitchWithRotate,this._mouseRotate=t,this._mousePitch=i;}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable();}disable(){this._mouseRotate.disable(),this._mousePitch.disable();}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled());}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive();}}class yn{constructor(e,t,i,r){this._el=e,this._touchZoom=t,this._touchRotate=i,this._tapDragZoom=r,this._rotationDisabled=!1,this._enabled=!0;}enable(e){this._touchZoom.enable(e),this._rotationDisabled||this._touchRotate.enable(e),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate");}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate");}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled();}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive();}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable();}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable();}}const xn=e=>e.zoom||e.drag||e.pitch||e.rotate;class vn extends e.Event{}class bn{constructor(){this.constants=[1,1,.01],this.radius=0;}setup(t,i){const r=e.sub([],i,t);this.radius=e.length(r[2]<0?e.div([],r,this.constants):[r[0],r[1],0]);}projectRay(t){e.div(t,t,this.constants),e.normalize(t,t),e.mul$1(t,t,this.constants);const i=e.scale$2([],t,this.radius);if(i[2]>0){const t=e.scale$2([],[0,0,1],e.dot(i,[0,0,1])),r=e.scale$2([],e.normalize([],[i[0],i[1],0]),this.radius),n=e.add([],i,e.scale$2([],e.sub([],e.add([],r,t),i),2));i[0]=n[0],i[1]=n[1];}return i;}}function Sn(e){return e.panDelta&&e.panDelta.mag()||e.zoomDelta||e.bearingDelta||e.pitchDelta;}class wn{constructor(t,i){this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new kr(t),this._bearingSnap=i.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new bn(),this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(i),e.bindAll(["handleEvent","handleWindowEvent"],this);const r=this._el;this._listeners=[[r,"touchstart",{passive:!0}],[r,"touchmove",{passive:!1}],[r,"touchend",void 0],[r,"touchcancel",void 0],[r,"mousedown",void 0],[r,"mousemove",void 0],[r,"mouseup",void 0],[e.window.document,"mousemove",{capture:!0}],[e.window.document,"mouseup",void 0],[r,"mouseover",void 0],[r,"mouseout",void 0],[r,"dblclick",void 0],[r,"click",void 0],[r,"keydown",{capture:!1}],[r,"keyup",void 0],[r,"wheel",{passive:!1}],[r,"contextmenu",void 0],[e.window,"blur",void 0]];for(const[t,i,r]of this._listeners)t.addEventListener(i,t===e.window.document?this.handleWindowEvent:this.handleEvent,r);}destroy(){for(const[t,i,r]of this._listeners)t.removeEventListener(i,t===e.window.document?this.handleWindowEvent:this.handleEvent,r);}_addDefaultHandlers(e){const t=this._map,i=t.getCanvasContainer();this._add("mapEvent",new Ur(t,e));const r=t.boxZoom=new Gr(t,e);this._add("boxZoom",r);const n=new qr(),o=new fn();t.doubleClickZoom=new pn(o,n),this._add("tapZoom",n),this._add("clickZoom",o);const s=new mn();this._add("tapDragZoom",s);const a=t.touchPitch=new an(t);this._add("touchPitch",a);const l=new Yr(e),c=new Jr(e);t.dragRotate=new gn(e,l,c),this._add("mouseRotate",l,["mousePitch"]),this._add("mousePitch",c,["mouseRotate"]);const h=new Wr(e),u=new Kr(t,e);t.dragPan=new _n(i,h,u),this._add("mousePan",h),this._add("touchPan",u,["touchZoom","touchRotate"]);const d=new on(),p=new rn();t.touchZoomRotate=new yn(i,p,d,s),this._add("touchRotate",d,["touchPan","touchZoom"]),this._add("touchZoom",p,["touchPan","touchRotate"]),this._add("blockableMapEvent",new Vr(t));const f=t.scrollZoom=new dn(t,this);this._add("scrollZoom",f,["mousePan"]);const m=t.keyboard=new cn();this._add("keyboard",m);for(const i of ["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])e.interactive&&e[i]&&t[i].enable(e[i]);}_add(e,t,i){this._handlers.push({handlerName:e,handler:t,allowed:i}),this._handlersById[e]=t;}stop(e){if(!this._updatingCamera){for(const{handler:e}of this._handlers)e.reset();this._inertia.clear(),this._fireEvents({},{},e),this._changes=[];}}isActive(){for(const{handler:e}of this._handlers)if(e.isActive())return !0;return !1;}isZooming(){return !!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming();}isRotating(){return !!this._eventsInProgress.rotate;}isMoving(){return Boolean(xn(this._eventsInProgress))||this.isZooming();}_blockedByActive(e,t,i){for(const r in e)if(r!==i&&(!t||t.indexOf(r)<0))return !0;return !1;}handleWindowEvent(e){this.handleEvent(e,`${e.type}Window`);}_getMapTouches(e){const t=[];for(const i of e)this._el.contains(i.target)&&t.push(i);return t;}handleEvent(e,t){this._updatingCamera=!0;const i="renderFrame"===e.type,r=i?void 0:e,n={needsRenderFrame:!1},o={},a={},l=e.touches?this._getMapTouches(e.touches):void 0,c=l?s.touchPos(this._el,l):i?void 0:s.mousePos(this._el,e);for(const{handlerName:i,handler:s,allowed:h}of this._handlers){if(!s.isEnabled())continue;let u;this._blockedByActive(a,h,i)?s.reset():s[t||e.type]&&(u=s[t||e.type](e,c,l),this.mergeHandlerResult(n,o,u,i,r),u&&u.needsRenderFrame&&this._triggerRenderFrame()),(u||s.isActive())&&(a[i]=s);}const h={};for(const e in this._previousActiveHandlers)a[e]||(h[e]=r);this._previousActiveHandlers=a,(Object.keys(h).length||Sn(n))&&(this._changes.push([n,o,h]),this._triggerRenderFrame()),(Object.keys(a).length||Sn(n))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:u}=n;u&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],u(this._map));}mergeHandlerResult(t,i,r,n,o){if(!r)return;e.extend(t,r);const s={handlerName:n,originalEvent:r.originalEvent||o};void 0!==r.zoomDelta&&(i.zoom=s),void 0!==r.panDelta&&(i.drag=s),void 0!==r.pitchDelta&&(i.pitch=s),void 0!==r.bearingDelta&&(i.rotate=s);}_applyChanges(){const t={},i={},r={};for(const[n,o,s]of this._changes)n.panDelta&&(t.panDelta=(t.panDelta||new e.pointGeometry(0,0))._add(n.panDelta)),n.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+n.zoomDelta),n.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+n.bearingDelta),n.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+n.pitchDelta),void 0!==n.around&&(t.around=n.around),void 0!==n.aroundCoord&&(t.aroundCoord=n.aroundCoord),void 0!==n.pinchAround&&(t.pinchAround=n.pinchAround),n.noInertia&&(t.noInertia=n.noInertia),e.extend(i,o),e.extend(r,s);this._updateMapTransform(t,i,r),this._changes=[];}_updateMapTransform(t,i,r){const n=this._map,o=n.transform,s=e=>[e.x,e.y,e.z];if((e=>{const t=this._eventsInProgress.drag;return t&&!this._handlersById[t.handlerName].isActive();})()&&!Sn(t)){const e=o.zoom;o.cameraElevationReference="sea",o.recenterOnTerrain(),o.cameraElevationReference="ground",e!==o.zoom&&this._map._update(!0);}if(!Sn(t))return this._fireEvents(i,r,!0);let{panDelta:a,zoomDelta:l,bearingDelta:c,pitchDelta:h,around:u,aroundCoord:d,pinchAround:p}=t;void 0!==p&&(u=p),(e=>i.drag&&!this._eventsInProgress.drag)()&&u&&(this._dragOrigin=s(o.pointCoordinate3D(u)),this._trackingEllipsoid.setup(o._camera.position,this._dragOrigin)),o.cameraElevationReference="sea",n._stop(!0),u=u||n.transform.centerPoint,c&&(o.bearing+=c),h&&(o.pitch+=h),o._updateCameraState();const f=[0,0,0];if(a){const e=o.pointCoordinate(u),t=o.pointCoordinate(u.sub(a));e&&t&&(f[0]=t.x-e.x,f[1]=t.y-e.y);}const m=o.zoom,_=[0,0,0];if(l){const t=s(d||o.pointCoordinate3D(u)),i={dir:e.normalize([],e.sub([],t,o._camera.position))};if(i.dir[2]<0){const r=o.zoomDeltaToMovement(t,l);e.scale$2(_,i.dir,r);}}const g=e.add(f,f,_);o._translateCameraConstrained(g),l&&Math.abs(o.zoom-m)>1e-4&&o.recenterOnTerrain(),o.cameraElevationReference="ground",this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(i,r,!0);}_fireEvents(t,i,r){const n=xn(this._eventsInProgress),o=xn(t),s={};for(const e in t){const{originalEvent:i}=t[e];this._eventsInProgress[e]||(s[`${e}start`]=i),this._eventsInProgress[e]=t[e];}!n&&o&&this._fireEvent("movestart",o.originalEvent);for(const e in s)this._fireEvent(e,s[e]);o&&this._fireEvent("move",o.originalEvent);for(const e in t){const{originalEvent:i}=t[e];this._fireEvent(e,i);}const a={};let l;for(const e in this._eventsInProgress){const{handlerName:t,originalEvent:r}=this._eventsInProgress[e];this._handlersById[t].isActive()||(delete this._eventsInProgress[e],l=i[t]||r,a[`${e}end`]=l);}for(const e in a)this._fireEvent(e,a[e]);const c=xn(this._eventsInProgress);if(r&&(n||o)&&!c){this._updatingCamera=!0;const t=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),i=e=>0!==e&&-this._bearingSnap<e&&e<this._bearingSnap;t?(i(t.bearing||this._map.getBearing())&&(t.bearing=0),this._map.easeTo(t,{originalEvent:l})):(this._map.fire(new e.Event("moveend",{originalEvent:l})),i(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1;}}_fireEvent(t,i){this._map.fire(new e.Event(t,i?{originalEvent:i}:{}));}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add(e=>{delete this._frameId,this.handleEvent(new vn("renderFrame",{timeStamp:e})),this._applyChanges();});}_triggerRenderFrame(){void 0===this._frameId&&(this._frameId=this._requestFrame());}}const Tn="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class En extends e.Evented{constructor(t,i){super(),this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=i.bearingSnap,e.bindAll(["_renderFrameCallback"],this);}getCenter(){return new e.LngLat(this.transform.center.lng,this.transform.center.lat);}setCenter(e,t){return this.jumpTo({center:e},t);}panBy(t,i,r){return t=e.pointGeometry.convert(t).mult(-1),this.panTo(this.transform.center,e.extend({offset:t},i),r);}panTo(t,i,r){return this.easeTo(e.extend({center:t},i),r);}getZoom(){return this.transform.zoom;}setZoom(e,t){return this.jumpTo({zoom:e},t),this;}zoomTo(t,i,r){return this.easeTo(e.extend({zoom:t},i),r);}zoomIn(e,t){return this.zoomTo(this.getZoom()+1,e,t),this;}zoomOut(e,t){return this.zoomTo(this.getZoom()-1,e,t),this;}getBearing(){return this.transform.bearing;}setBearing(e,t){return this.jumpTo({bearing:e},t),this;}getPadding(){return this.transform.padding;}setPadding(e,t){return this.jumpTo({padding:e},t),this;}rotateTo(t,i,r){return this.easeTo(e.extend({bearing:t},i),r);}resetNorth(t,i){return this.rotateTo(0,e.extend({duration:1e3},t),i),this;}resetNorthPitch(t,i){return this.easeTo(e.extend({bearing:0,pitch:0,duration:1e3},t),i),this;}snapToNorth(e,t){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(e,t):this;}getPitch(){return this.transform.pitch;}setPitch(e,t){return this.jumpTo({pitch:e},t),this;}cameraForBounds(t,i){t=e.LngLatBounds.convert(t);const r=i&&i.bearing||0;return this._cameraForBoxAndBearing(t.getNorthWest(),t.getSouthEast(),r,i);}_extendCameraOptions(t){const i={top:0,bottom:0,right:0,left:0};if("number"==typeof(t=e.extend({padding:i,offset:[0,0],maxZoom:this.transform.maxZoom},t)).padding){const e=t.padding;t.padding={top:e,bottom:e,right:e,left:e};}return t.padding=e.extend(i,t.padding),t;}_cameraForBoxAndBearing(t,i,r,n){const o=this._extendCameraOptions(n),s=this.transform,a=s.padding,l=s.project(e.LngLat.convert(t)),c=s.project(e.LngLat.convert(i)),h=l.rotate(-e.degToRad(r)),u=c.rotate(-e.degToRad(r)),d=new e.pointGeometry(Math.max(h.x,u.x),Math.max(h.y,u.y)),p=new e.pointGeometry(Math.min(h.x,u.x),Math.min(h.y,u.y)),f=d.sub(p),m=(s.width-(a.left+a.right+o.padding.left+o.padding.right))/f.x,_=(s.height-(a.top+a.bottom+o.padding.top+o.padding.bottom))/f.y;if(_<0||m<0)return void e.warnOnce("Map cannot fit within canvas with the given bounds, padding, and/or offset.");const g=Math.min(s.scaleZoom(s.scale*Math.min(m,_)),o.maxZoom),y="number"==typeof o.offset.x?new e.pointGeometry(o.offset.x,o.offset.y):e.pointGeometry.convert(o.offset),x=new e.pointGeometry((o.padding.left-o.padding.right)/2,(o.padding.top-o.padding.bottom)/2).rotate(r*Math.PI/180),v=y.add(x).mult(s.scale/s.zoomScale(g));return {center:s.unproject(l.add(c).div(2).sub(v)),zoom:g,bearing:r};}_cameraForBox(t,i,r,n,o){const s=this._extendCameraOptions(o);r=r||0,n=n||0,t=e.LngLat.convert(t),i=e.LngLat.convert(i);const a=this.transform.clone();a.padding=s.padding;const l=this.getFreeCameraOptions(),c=new e.LngLat(.5*(t.lng+i.lng),.5*(t.lat+i.lat)),h=.5*(r+n);if(a._camera.position[2]<e.mercatorZfromAltitude(h,c.lat))return void e.warnOnce("Map cannot fit within canvas with the given bounds, padding, and/or offset.");l.lookAtPoint(c),a.setFreeCameraOptions(l);const u=e.MercatorCoordinate.fromLngLat(t),d=e.MercatorCoordinate.fromLngLat(i),p=a.pointRayIntersection(a.centerPoint,h),f=[(m=a.rayIntersectionCoordinate(p)).x,m.y,m.z];var m;const _=a.screenPointToMercatorRay(a.centerPoint),g="globe"!==a.projection.name;let y,x=0;do{const i=Math.floor(a.zoom),o=1<<i,s=Math.min(o*u.x,o*d.x),l=Math.min(o*u.y,o*d.y),c=Math.max(o*u.x,o*d.x),h=Math.max(o*u.y,o*d.y),p=new e.Aabb([s,l,r],[c,h,n]),m=e.Frustum.fromInvProjectionMatrix(a.invProjMatrix,a.worldSize,i,g);if(2!==p.intersects(m)){y&&(a._camera.position=e.scaleAndAdd([],a._camera.position,_.dir,-y),a._updateStateFromCamera());break;}const x=e.sub([],a._camera.position,f);y=.5*e.length(x),a._camera.position=e.scaleAndAdd([],a._camera.position,_.dir,y);try{a._updateStateFromCamera();}catch(t){return void e.warnOnce("Map cannot fit within canvas with the given bounds, padding, and/or offset.");}}while(++x<10);return {center:a.center,zoom:a.zoom,bearing:a.bearing,pitch:a.pitch};}fitBounds(e,t,i){return this._fitInternal(this.cameraForBounds(e,t),t,i);}_raycastElevationBox(t,i){const r=this.transform.elevation;if(!r)return;const n=new e.pointGeometry(t.x,i.y),o=new e.pointGeometry(i.x,t.y),s=r.pointCoordinate(t);if(!s)return;const a=r.pointCoordinate(i);if(!a)return;const l=r.pointCoordinate(n);if(!l)return;const c=r.pointCoordinate(o);if(!c)return;const h=new e.MercatorCoordinate(s[0],s[1]).toLngLat(),u=new e.MercatorCoordinate(a[0],a[1]).toLngLat(),d=new e.MercatorCoordinate(l[0],l[1]).toLngLat(),p=new e.MercatorCoordinate(c[0],c[1]).toLngLat(),f=Math.min(h.lng,Math.min(u.lng,Math.min(d.lng,p.lng))),m=Math.min(h.lat,Math.min(u.lat,Math.min(d.lat,p.lat))),_=Math.max(h.lng,Math.max(u.lng,Math.max(d.lng,p.lng))),g=Math.max(h.lat,Math.max(u.lat,Math.max(d.lat,p.lat))),y=Math.min(s[3],Math.min(a[3],Math.min(l[3],c[3]))),x=Math.max(s[3],Math.max(a[3],Math.max(l[3],c[3])));return {minLngLat:new e.LngLat(f,m),maxLngLat:new e.LngLat(_,g),minAltitude:y,maxAltitude:x};}fitScreenCoordinates(t,i,r,n,o){let s,a,l,c;const h=e.pointGeometry.convert(t),u=e.pointGeometry.convert(i),d=this._raycastElevationBox(h,u);if(d)s=d.minLngLat,a=d.maxLngLat,l=d.minAltitude,c=d.maxAltitude;else {if(this.transform.anyCornerOffEdge(h,u))return this;s=this.transform.pointLocation(h),a=this.transform.pointLocation(u);}return this._fitInternal(0===this.transform.pitch?this._cameraForBoxAndBearing(this.transform.pointLocation(e.pointGeometry.convert(t)),this.transform.pointLocation(e.pointGeometry.convert(i)),r,n):this._cameraForBox(s,a,l,c,n),n,o);}_fitInternal(t,i,r){return t?(delete(i=e.extend(t,i)).padding,i.linear?this.easeTo(i,r):this.flyTo(i,r)):this;}jumpTo(t,i){this.stop();const r=t.preloadOnly?this.transform.clone():this.transform;let n=!1,o=!1,s=!1;return "zoom"in t&&r.zoom!==+t.zoom&&(n=!0,r.zoom=+t.zoom),void 0!==t.center&&(r.center=e.LngLat.convert(t.center)),"bearing"in t&&r.bearing!==+t.bearing&&(o=!0,r.bearing=+t.bearing),"pitch"in t&&r.pitch!==+t.pitch&&(s=!0,r.pitch=+t.pitch),null==t.padding||r.isPaddingEqual(t.padding)||(r.padding=t.padding),t.preloadOnly?(this._preloadTiles(r),this):(this.fire(new e.Event("movestart",i)).fire(new e.Event("move",i)),n&&this.fire(new e.Event("zoomstart",i)).fire(new e.Event("zoom",i)).fire(new e.Event("zoomend",i)),o&&this.fire(new e.Event("rotatestart",i)).fire(new e.Event("rotate",i)).fire(new e.Event("rotateend",i)),s&&this.fire(new e.Event("pitchstart",i)).fire(new e.Event("pitch",i)).fire(new e.Event("pitchend",i)),this.fire(new e.Event("moveend",i)));}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||e.warnOnce(Tn),this.transform.getFreeCameraOptions();}setFreeCameraOptions(t,i){const r=this.transform;if(!r.projection.supportsFreeCamera)return void e.warnOnce(Tn);this.stop();const n=r.zoom,o=r.pitch,s=r.bearing;r.setFreeCameraOptions(t);const a=n!==r.zoom,l=o!==r.pitch,c=s!==r.bearing;return this.fire(new e.Event("movestart",i)).fire(new e.Event("move",i)),a&&this.fire(new e.Event("zoomstart",i)).fire(new e.Event("zoom",i)).fire(new e.Event("zoomend",i)),c&&this.fire(new e.Event("rotatestart",i)).fire(new e.Event("rotate",i)).fire(new e.Event("rotateend",i)),l&&this.fire(new e.Event("pitchstart",i)).fire(new e.Event("pitch",i)).fire(new e.Event("pitchend",i)),this.fire(new e.Event("moveend",i)),this;}easeTo(t,i){this._stop(!1,t.easeId),(!1===(t=e.extend({offset:[0,0],duration:500,easing:e.ease},t)).animate||!t.essential&&e.exported.prefersReducedMotion)&&(t.duration=0);const r=this.transform,n=this.getZoom(),o=this.getBearing(),s=this.getPitch(),a=this.getPadding(),l="zoom"in t?+t.zoom:n,c="bearing"in t?this._normalizeBearing(t.bearing,o):o,h="pitch"in t?+t.pitch:s,u="padding"in t?t.padding:r.padding,d=e.pointGeometry.convert(t.offset);let p=r.centerPoint.add(d);const f="globe"===r.projection.name?r.pointCoordinate(p).toLngLat():r.pointLocation(p),m=e.LngLat.convert(t.center||f);this._normalizeCenter(m);const _=r.project(f),g=r.project(m).sub(_),y=r.zoomScale(l-n);let x,v;t.around&&(x=e.LngLat.convert(t.around),v=r.locationPoint(x));const b=this._zooming||l!==n,S=this._rotating||o!==c,w=this._pitching||h!==s,T=!r.isPaddingEqual(u),E=r=>f=>{if(b&&(r.zoom=e.number(n,l,f)),S&&(r.bearing=e.number(o,c,f)),w&&(r.pitch=e.number(s,h,f)),T&&(r.interpolatePadding(a,u,f),p=r.centerPoint.add(d)),x)r.setLocationAtPoint(x,v);else {const e=r.zoomScale(r.zoom-n),t=l>n?Math.min(2,y):Math.max(.5,y),i=Math.pow(t,1-f),o=r.unproject(_.add(g.mult(f*i)).mult(e));r.setLocationAtPoint(r.renderWorldCopies?o.wrap():o,p);}return t.preloadOnly||this._fireMoveEvents(i),r;};if(t.preloadOnly){const e=this._emulate(E,t.duration,r);return this._preloadTiles(e),this;}const N={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=b,this._rotating=S,this._pitching=w,this._padding=T,this._easeId=t.easeId,this._prepareEase(i,t.noMoveStart,N),this._ease(E(r),e=>{r.recenterOnTerrain(),this._afterEase(i,e);},t),this;}_prepareEase(t,i,r={}){this._moving=!0,this.transform.cameraElevationReference="sea",i||r.moving||this.fire(new e.Event("movestart",t)),this._zooming&&!r.zooming&&this.fire(new e.Event("zoomstart",t)),this._rotating&&!r.rotating&&this.fire(new e.Event("rotatestart",t)),this._pitching&&!r.pitching&&this.fire(new e.Event("pitchstart",t));}_fireMoveEvents(t){this.fire(new e.Event("move",t)),this._zooming&&this.fire(new e.Event("zoom",t)),this._rotating&&this.fire(new e.Event("rotate",t)),this._pitching&&this.fire(new e.Event("pitch",t));}_afterEase(t,i){if(this._easeId&&i&&this._easeId===i)return;delete this._easeId,this.transform.cameraElevationReference="ground";const r=this._zooming,n=this._rotating,o=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,r&&this.fire(new e.Event("zoomend",t)),n&&this.fire(new e.Event("rotateend",t)),o&&this.fire(new e.Event("pitchend",t)),this.fire(new e.Event("moveend",t));}flyTo(t,i){if(!t.essential&&e.exported.prefersReducedMotion){const r=e.pick(t,["center","zoom","bearing","pitch","around"]);return this.jumpTo(r,i);}this.stop(),t=e.extend({offset:[0,0],speed:1.2,curve:1.42,easing:e.ease},t);const r=this.transform,n=this.getZoom(),o=this.getBearing(),s=this.getPitch(),a=this.getPadding(),l="zoom"in t?e.clamp(+t.zoom,r.minZoom,r.maxZoom):n,c="bearing"in t?this._normalizeBearing(t.bearing,o):o,h="pitch"in t?+t.pitch:s,u="padding"in t?t.padding:r.padding,d=r.zoomScale(l-n),p=e.pointGeometry.convert(t.offset);let f=r.centerPoint.add(p);const m=r.pointLocation(f),_=e.LngLat.convert(t.center||m);this._normalizeCenter(_);const g=r.project(m),y=r.project(_).sub(g);let x=t.curve;const v=Math.max(r.width,r.height),b=v/d,S=y.mag();if("minZoom"in t){const i=e.clamp(Math.min(t.minZoom,n,l),r.minZoom,r.maxZoom),o=v/r.zoomScale(i-n);x=Math.sqrt(o/S*2);}const w=x*x;function T(e){const t=(b*b-v*v+(e?-1:1)*w*w*S*S)/(2*(e?b:v)*w*S);return Math.log(Math.sqrt(t*t+1)-t);}function E(e){return (Math.exp(e)-Math.exp(-e))/2;}function N(e){return (Math.exp(e)+Math.exp(-e))/2;}const I=T(0);let M=function(e){return N(I)/N(I+x*e);},C=function(e){return v*((N(I)*(E(t=I+x*e)/N(t))-E(I))/w)/S;var t;},A=(T(1)-I)/x;if(Math.abs(S)<1e-6||!isFinite(A)){if(Math.abs(v-b)<1e-6)return this.easeTo(t,i);const e=b<v?-1:1;A=Math.abs(Math.log(b/v))/x,C=function(){return 0;},M=function(t){return Math.exp(e*x*t);};}t.duration="duration"in t?+t.duration:1e3*A/("screenSpeed"in t?+t.screenSpeed/x:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0);const P=o!==c,L=h!==s,D=!r.isPaddingEqual(u),k=r=>d=>{const m=d*A,x=1/M(m);r.zoom=1===d?l:n+r.scaleZoom(x),P&&(r.bearing=e.number(o,c,d)),L&&(r.pitch=e.number(s,h,d)),D&&(r.interpolatePadding(a,u,d),f=r.centerPoint.add(p));const v=1===d?_:r.unproject(g.add(y.mult(C(m))).mult(x));return r.setLocationAtPoint(r.renderWorldCopies?v.wrap():v,f),r._updateCenterElevation(),t.preloadOnly||this._fireMoveEvents(i),r;};if(t.preloadOnly){const e=this._emulate(k,t.duration,r);return this._preloadTiles(e),this;}return this._zooming=!0,this._rotating=P,this._pitching=L,this._padding=D,this._prepareEase(i,!1),this._ease(k(r),()=>this._afterEase(i),t),this;}isEasing(){return !!this._easeFrameId;}stop(){return this._stop();}_stop(e,t){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),delete this._easeFrameId,delete this._onEaseFrame),this._onEaseEnd){const e=this._onEaseEnd;delete this._onEaseEnd,e.call(this,t);}if(!e){const e=this.handlers;e&&e.stop(!1);}return this;}_ease(t,i,r){!1===r.animate||0===r.duration?(t(1),i()):(this._easeStart=e.exported.now(),this._easeOptions=r,this._onEaseFrame=t,this._onEaseEnd=i,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback));}_renderFrameCallback(){const t=Math.min((e.exported.now()-this._easeStart)/this._easeOptions.duration,1);this._onEaseFrame(this._easeOptions.easing(t)),t<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop();}_normalizeBearing(t,i){t=e.wrap(t,-180,180);const r=Math.abs(t-i);return Math.abs(t-360-i)<r&&(t-=360),Math.abs(t+360-i)<r&&(t+=360),t;}_normalizeCenter(e){const t=this.transform;if(!t.renderWorldCopies||t.maxBounds)return;const i=e.lng-t.center.lng;e.lng+=i>180?-360:i<-180?360:0;}_emulate(e,t,i){const r=Math.ceil(15*t/1e3),n=[],o=e(i.clone());for(let e=0;e<=r;e++){const t=o(e/r);n.push(t.clone());}return n;}}class Nn{constructor(t={}){this.options=t,e.bindAll(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this);}getDefaultPosition(){return "bottom-right";}onAdd(e){const t=this.options&&this.options.compact;return this._map=e,this._container=s.create("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=s.create("button","mapboxgl-ctrl-attrib-button",this._container),s.create("span","mapboxgl-ctrl-icon",this._compactButton).setAttribute("aria-hidden",!0),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._setElementTitle(this._compactButton,"ToggleAttribution"),this._innerContainer=s.create("div","mapboxgl-ctrl-attrib-inner",this._container),this._innerContainer.setAttribute("role","list"),t&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),void 0===t&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container;}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0;}_setElementTitle(e,t){const i=this._map._getUIString(`AttributionControl.${t}`);e.setAttribute("aria-label",i),e.removeAttribute("title"),e.firstElementChild&&e.firstElementChild.setAttribute("title",i);}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"));}_updateEditLink(){let t=this._editLink;t||(t=this._editLink=this._container.querySelector(".mapbox-improve-map"));const i=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||e.config.ACCESS_TOKEN}];if(t){const r=i.reduce((e,t,r)=>(t.value&&(e+=`${t.key}=${t.value}${r<i.length-1?"&":""}`),e),"?");t.href=`${e.config.FEEDBACK_URL}/${r}${this._map._hash?this._map._hash.getHashString(!0):""}`,t.rel="noopener nofollow",this._setElementTitle(t,"MapFeedback");}}_updateData(e){!e||"metadata"!==e.sourceDataType&&"visibility"!==e.sourceDataType&&"style"!==e.dataType||(this._updateAttributions(),this._updateEditLink());}_updateAttributions(){if(!this._map.style)return;let e=[];if(this._map.style.stylesheet){const e=this._map.style.stylesheet;this.styleOwner=e.owner,this.styleId=e.id;}const t=this._map.style._sourceCaches;for(const i in t){const r=t[i];if(r.used){const t=r.getSource();t.attribution&&e.indexOf(t.attribution)<0&&e.push(t.attribution);}}e.sort((e,t)=>e.length-t.length),e=e.filter((t,i)=>{for(let r=i+1;r<e.length;r++)if(e[r].indexOf(t)>=0)return !1;return !0;}),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?e=[...this.options.customAttribution,...e]:e.unshift(this.options.customAttribution));const i=e.join(" | ");i!==this._attribHTML&&(this._attribHTML=i,e.length?(this._innerContainer.innerHTML=i,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null);}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show");}}class In{constructor(){e.bindAll(["_updateLogo"],this),e.bindAll(["_updateCompact"],this);}onAdd(e){this._map=e,this._container=s.create("div","mapboxgl-ctrl");const t=s.create("a","mapboxgl-ctrl-logo");return t.target="_blank",t.rel="noopener nofollow",t.href="https://www.mapbox.com/",t.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),t.setAttribute("rel","noopener nofollow"),this._container.appendChild(t),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container;}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact);}getDefaultPosition(){return "bottom-left";}_updateLogo(e){e&&"metadata"!==e.sourceDataType||(this._container.style.display=this._logoRequired()?"block":"none");}_logoRequired(){if(!this._map.style)return !0;const e=this._map.style._sourceCaches;if(0===Object.entries(e).length)return !0;for(const t in e){const i=e[t].getSource();if(i.hasOwnProperty("mapbox_logo")&&!i.mapbox_logo)return !1;}return !0;}_updateCompact(){const e=this._container.children;if(e.length){const t=e[0];this._map.getCanvasContainer().offsetWidth<250?t.classList.add("mapboxgl-compact"):t.classList.remove("mapboxgl-compact");}}}class Mn{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1;}add(e){const t=++this._id;return this._queue.push({callback:e,id:t,cancelled:!1}),t;}remove(e){const t=this._currentlyRunning,i=t?this._queue.concat(t):this._queue;for(const t of i)if(t.id===e)return void(t.cancelled=!0);}run(e=0){const t=this._currentlyRunning=this._queue;this._queue=[];for(const i of t)if(!i.cancelled&&(i.callback(e),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1;}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[];}}function Cn(t,i,r){if(t=new e.LngLat(t.lng,t.lat),i){const n=new e.LngLat(t.lng-360,t.lat),o=new e.LngLat(t.lng+360,t.lat),s=360*Math.ceil(Math.abs(t.lng-r.center.lng)/360),a=r.locationPoint(t).distSqr(i),l=i.x<0||i.y<0||i.x>r.width||i.y>r.height;r.locationPoint(n).distSqr(i)<a&&(l||Math.abs(n.lng-r.center.lng)<s)?t=n:r.locationPoint(o).distSqr(i)<a&&(l||Math.abs(o.lng-r.center.lng)<s)&&(t=o);}for(;Math.abs(t.lng-r.center.lng)>180;){const e=r.locationPoint(t);if(e.x>=0&&e.y>=0&&e.x<=r.width&&e.y<=r.height)break;t.lng>r.center.lng?t.lng-=360:t.lng+=360;}return t;}const An={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"};class Pn extends e.Evented{constructor(t,i){if(super(),(t instanceof e.window.HTMLElement||i)&&(t=e.extend({element:t},i)),e.bindAll(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this),this._anchor=t&&t.anchor||"center",this._color=t&&t.color||"#3FB1CE",this._scale=t&&t.scale||1,this._draggable=t&&t.draggable||!1,this._clickTolerance=t&&t.clickTolerance||0,this._isDragging=!1,this._state="inactive",this._rotation=t&&t.rotation||0,this._rotationAlignment=t&&t.rotationAlignment||"auto",this._pitchAlignment=t&&t.pitchAlignment&&"auto"!==t.pitchAlignment?t.pitchAlignment:this._rotationAlignment,this._updateMoving=()=>this._update(!0),t&&t.element)this._element=t.element,this._offset=e.pointGeometry.convert(t&&t.offset||[0,0]);else {this._defaultMarker=!0,this._element=s.create("div");const i=41,r=27,n=s.createSVG("svg",{display:"block",height:i*this._scale+"px",width:r*this._scale+"px",viewBox:`0 0 ${r} ${i}`},this._element),o=s.createSVG("radialGradient",{id:"shadowGradient"},s.createSVG("defs",{},n));s.createSVG("stop",{offset:"10%","stop-opacity":.4},o),s.createSVG("stop",{offset:"100%","stop-opacity":.05},o),s.createSVG("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},n),s.createSVG("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},n),s.createSVG("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},n),s.createSVG("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},n),this._offset=e.pointGeometry.convert(t&&t.offset||[0,-14]);}this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",e=>{e.preventDefault();}),this._element.addEventListener("mousedown",e=>{e.preventDefault();});const r=this._element.classList;for(const e in An)r.remove(`mapboxgl-marker-anchor-${e}`);r.add(`mapboxgl-marker-anchor-${this._anchor}`),this._popup=null;}addTo(e){return e===this._map||(this.remove(),this._map=e,e.getCanvasContainer().appendChild(this._element),e.on("move",this._updateMoving),e.on("moveend",this._update),e.on("remove",this._clearFadeTimer),e._addMarker(this),this.setDraggable(this._draggable),this._update(),this._map.on("click",this._onMapClick)),this;}remove(){return this._map&&(this._map.off("click",this._onMapClick),this._map.off("move",this._updateMoving),this._map.off("moveend",this._update),this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler),this._map.off("mouseup",this._onUp),this._map.off("touchend",this._onUp),this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),this._map.off("remove",this._clearFadeTimer),this._map._removeMarker(this),delete this._map),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this;}getLngLat(){return this._lngLat;}setLngLat(t){return this._lngLat=e.LngLat.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this;}getElement(){return this._element;}setPopup(e){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),e){if(!("offset"in e.options)){const t=38.1,i=13.5,r=Math.sqrt(Math.pow(i,2)/2);e.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-t],"bottom-left":[r,-1*(t-i+r)],"bottom-right":[-r,-1*(t-i+r)],left:[i,-1*(t-i)],right:[-i,-1*(t-i)]}:this._offset;}this._popup=e,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false");}return this;}_onKeyPress(e){const t=e.code,i=e.charCode||e.keyCode;"Space"!==t&&"Enter"!==t&&32!==i&&13!==i||this.togglePopup();}_onMapClick(e){const t=e.originalEvent.target,i=this._element;this._popup&&(t===i||i.contains(t))&&this.togglePopup();}getPopup(){return this._popup;}togglePopup(){const e=this._popup;return e?(e.isOpen()?(e.remove(),this._element.setAttribute("aria-expanded","false")):(e.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this;}_evaluateOpacity(){const e=this._pos?this._pos.sub(this._transformedOffset()):null;if(!this._withinScreenBounds(e))return void this._clearFadeTimer();const t=this._map.unproject(e);let i=!1;if(this._map.transform._terrainEnabled()&&this._map.getTerrain()){const e=this._map.getFreeCameraOptions();if(e.position){const r=e.position.toLngLat();i=r.distanceTo(t)<.9*r.distanceTo(this._lngLat);}}const r=(1-this._map._queryFogOpacity(t))*(i?.2:1);this._element.style.opacity=`${r}`,this._popup&&this._popup._setOpacity(`${r}`),this._fadeTimer=null;}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null);}_withinScreenBounds(e){const t=this._map.transform;return !!e&&e.x>=0&&e.x<t.width&&e.y>=0&&e.y<t.height;}_updateDOM(){const t=this._pos||new e.pointGeometry(0,0),i=this._calculatePitch(),r=this._calculateRotation();this._element.style.transform=`${An[this._anchor]} translate(${t.x}px, ${t.y}px) rotateX(${i}deg) rotateZ(${r}deg)`;}_calculatePitch(){return "viewport"===this._pitchAlignment||"auto"===this._pitchAlignment?0:"map"===this._pitchAlignment?this._map.getPitch():0;}_calculateRotation(){return "viewport"===this._rotationAlignment||"auto"===this._rotationAlignment?this._rotation:"map"===this._rotationAlignment?this._rotation-this._map.getBearing():0;}_update(t){e.window.cancelAnimationFrame(this._updateFrameId),this._map&&(this._map.transform.renderWorldCopies&&(this._lngLat=Cn(this._lngLat,this._pos,this._map.transform)),this._pos=this._map.project(this._lngLat)._add(this._transformedOffset()),!0===t?this._updateFrameId=e.window.requestAnimationFrame(()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM());}):this._pos=this._pos.round(),this._map._requestDomTask(()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),!this._map.getTerrain()&&!this._map.getFog()||this._fadeTimer||(this._fadeTimer=setTimeout(this._evaluateOpacity.bind(this),60)));}));}_transformedOffset(){if(!this._defaultMarker)return this._offset;const e=this._map.transform,t=this._offset.mult(this._scale);return "map"===this._rotationAlignment&&t._rotate(e.angle),"map"===this._pitchAlignment&&(t.y*=Math.cos(e._pitch)),t;}getOffset(){return this._offset;}setOffset(t){return this._offset=e.pointGeometry.convert(t),this._update(),this;}_onMove(t){if(!this._isDragging){const e=this._clickTolerance||this._map._clickTolerance;this._isDragging=t.point.dist(this._pointerdownPos)>=e;}this._isDragging&&(this._pos=t.point.sub(this._positionDelta),this._lngLat=this._map.unproject(this._pos),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none","pending"===this._state&&(this._state="active",this.fire(new e.Event("dragstart"))),this.fire(new e.Event("drag")));}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1,this._map.off("mousemove",this._onMove),this._map.off("touchmove",this._onMove),"active"===this._state&&this.fire(new e.Event("dragend")),this._state="inactive";}_addDragHandler(e){this._element.contains(e.originalEvent.target)&&(e.preventDefault(),this._positionDelta=e.point.sub(this._pos).add(this._transformedOffset()),this._pointerdownPos=e.point,this._state="pending",this._map.on("mousemove",this._onMove),this._map.on("touchmove",this._onMove),this._map.once("mouseup",this._onUp),this._map.once("touchend",this._onUp));}setDraggable(e){return this._draggable=!!e,this._map&&(e?(this._map.on("mousedown",this._addDragHandler),this._map.on("touchstart",this._addDragHandler)):(this._map.off("mousedown",this._addDragHandler),this._map.off("touchstart",this._addDragHandler))),this;}isDraggable(){return this._draggable;}setRotation(e){return this._rotation=e||0,this._update(),this;}getRotation(){return this._rotation;}setRotationAlignment(e){return this._rotationAlignment=e||"auto",this._update(),this;}getRotationAlignment(){return this._rotationAlignment;}setPitchAlignment(e){return this._pitchAlignment=e&&"auto"!==e?e:this._rotationAlignment,this._update(),this;}getPitchAlignment(){return this._pitchAlignment;}}class Ln{constructor(e){this.jumpTo(e);}getValue(t){if(t<=this._startTime)return this._start;if(t>=this._endTime)return this._end;const i=e.easeCubicInOut((t-this._startTime)/(this._endTime-this._startTime));return this._start*(1-i)+this._end*i;}isEasing(e){return e>=this._startTime&&e<=this._endTime;}jumpTo(e){this._startTime=-1/0,this._endTime=-1/0,this._start=e,this._end=e;}easeTo(e,t,i){this._start=this.getValue(t),this._end=e,this._startTime=t,this._endTime=t+i;}}const Dn={"AttributionControl.ToggleAttribution":"Toggle attribution","AttributionControl.MapFeedback":"Map feedback","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox logo","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScaleControl.Feet":"ft","ScaleControl.Meters":"m","ScaleControl.Kilometers":"km","ScaleControl.Miles":"mi","ScaleControl.NauticalMiles":"nm","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use â + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"},{HTMLImageElement:kn,HTMLElement:zn,ImageBitmap:Rn}=e.window,On={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,optimizeForTerrain:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,crossSourceCollisions:!0};function Fn(e){e.parentNode&&e.parentNode.removeChild(e);}const Bn={showCompass:!0,showZoom:!0,visualizePitch:!1};class Un{constructor(t,i,r=!1){this._clickTolerance=10,this.element=i,this.mouseRotate=new Yr({clickTolerance:t.dragRotate._mouseRotate._clickTolerance}),this.map=t,r&&(this.mousePitch=new Jr({clickTolerance:t.dragRotate._mousePitch._clickTolerance})),e.bindAll(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),i.addEventListener("mousedown",this.mousedown),i.addEventListener("touchstart",this.touchstart,{passive:!1}),i.addEventListener("touchmove",this.touchmove),i.addEventListener("touchend",this.touchend),i.addEventListener("touchcancel",this.reset);}down(e,t){this.mouseRotate.mousedown(e,t),this.mousePitch&&this.mousePitch.mousedown(e,t),s.disableDrag();}move(e,t){const i=this.map,r=this.mouseRotate.mousemoveWindow(e,t);if(r&&r.bearingDelta&&i.setBearing(i.getBearing()+r.bearingDelta),this.mousePitch){const r=this.mousePitch.mousemoveWindow(e,t);r&&r.pitchDelta&&i.setPitch(i.getPitch()+r.pitchDelta);}}off(){const e=this.element;e.removeEventListener("mousedown",this.mousedown),e.removeEventListener("touchstart",this.touchstart,{passive:!1}),e.removeEventListener("touchmove",this.touchmove),e.removeEventListener("touchend",this.touchend),e.removeEventListener("touchcancel",this.reset),this.offTemp();}offTemp(){s.enableDrag(),e.window.removeEventListener("mousemove",this.mousemove),e.window.removeEventListener("mouseup",this.mouseup);}mousedown(t){this.down(e.extend({},t,{ctrlKey:!0,preventDefault:()=>t.preventDefault()}),s.mousePos(this.element,t)),e.window.addEventListener("mousemove",this.mousemove),e.window.addEventListener("mouseup",this.mouseup);}mousemove(e){this.move(e,s.mousePos(this.element,e));}mouseup(e){this.mouseRotate.mouseupWindow(e),this.mousePitch&&this.mousePitch.mouseupWindow(e),this.offTemp();}touchstart(e){1!==e.targetTouches.length?this.reset():(this._startPos=this._lastPos=s.touchPos(this.element,e.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>e.preventDefault()},this._startPos));}touchmove(e){1!==e.targetTouches.length?this.reset():(this._lastPos=s.touchPos(this.element,e.targetTouches)[0],this.move({preventDefault:()=>e.preventDefault()},this._lastPos));}touchend(e){0===e.targetTouches.length&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset();}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp();}}const Vn={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1};let Gn,jn=0,$n=!1;const Hn={maxWidth:100,unit:"metric"};function qn(e,t,i){const r=i&&i.maxWidth||100,n=e._containerHeight/2,o=e.unproject([0,n]),s=e.unproject([r,n]),a=o.distanceTo(s);if(i&&"imperial"===i.unit){const i=3.2808*a;i>5280?Zn(t,r,i/5280,e._getUIString("ScaleControl.Miles"),e):Zn(t,r,i,e._getUIString("ScaleControl.Feet"),e);}else i&&"nautical"===i.unit?Zn(t,r,a/1852,e._getUIString("ScaleControl.NauticalMiles"),e):a>=1e3?Zn(t,r,a/1e3,e._getUIString("ScaleControl.Kilometers"),e):Zn(t,r,a,e._getUIString("ScaleControl.Meters"),e);}function Zn(e,t,i,r,n){const o=function(e){const t=Math.pow(10,`${Math.floor(e)}`.length-1);let i=e/t;return i=i>=10?10:i>=5?5:i>=3?3:i>=2?2:i>=1?1:function(e){const t=Math.pow(10,Math.ceil(-Math.log(e)/Math.LN10));return Math.round(e*t)/t;}(i),t*i;}(i),s=o/i;n._requestDomTask(()=>{e.style.width=t*s+"px",e.innerHTML=`${o}&nbsp;${r}`;});}const Xn={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px"},Wn=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", "),Yn={version:e.version,supported:t,setRTLTextPlugin:e.setRTLTextPlugin,getRTLTextPluginStatus:e.getRTLTextPluginStatus,Map:class extends En{constructor(t){if(null!=(t=e.extend({},On,t)).minZoom&&null!=t.maxZoom&&t.minZoom>t.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(null!=t.minPitch&&null!=t.maxPitch&&t.minPitch>t.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(null!=t.minPitch&&t.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(null!=t.maxPitch&&t.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(t.antialias&&e.isSafariWithAntialiasingBug(e.window)&&(t.antialias=!1,e.warnOnce("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new Nr(t.minZoom,t.maxZoom,t.minPitch,t.maxPitch,t.renderWorldCopies),t),this._interactive=t.interactive,this._minTileCacheSize=t.minTileCacheSize,this._maxTileCacheSize=t.maxTileCacheSize,this._failIfMajorPerformanceCaveat=t.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=t.preserveDrawingBuffer,this._antialias=t.antialias,this._trackResize=t.trackResize,this._bearingSnap=t.bearingSnap,this._refreshExpiredTiles=t.refreshExpiredTiles,this._fadeDuration=t.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=t.crossSourceCollisions,this._crossFadingFactor=1,this._collectResourceTiming=t.collectResourceTiming,this._optimizeForTerrain=t.optimizeForTerrain,this._renderTaskQueue=new Mn(),this._domRenderTaskQueue=new Mn(),this._controls=[],this._markers=[],this._mapId=e.uniqueId(),this._locale=e.extend({},Dn,t.locale),this._clickTolerance=t.clickTolerance,this._cooperativeGestures=t.cooperativeGestures,this._containerWidth=0,this._containerHeight=0,this._averageElevationLastSampledAt=-1/0,this._averageElevation=new Ln(0),this._requestManager=new e.RequestManager(t.transformRequest,t.accessToken,t.testMode),this._silenceAuthErrors=!!t.testMode,"string"==typeof t.container){if(this._container=e.window.document.getElementById(t.container),!this._container)throw new Error(`Container '${t.container}' not found.`);}else {if(!(t.container instanceof zn))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=t.container;}if(this._container.childNodes.length>0&&e.warnOnce("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),t.maxBounds&&this.setMaxBounds(t.maxBounds),e.bindAll(["_onWindowOnline","_onWindowResize","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._setupPainter(),void 0===this.painter)throw new Error("Failed to initialize WebGL.");this.on("move",()=>this._update(!1)),this.on("moveend",()=>this._update(!1)),this.on("zoom",()=>this._update(!0)),void 0!==e.window&&(e.window.addEventListener("online",this._onWindowOnline,!1),e.window.addEventListener("resize",this._onWindowResize,!1),e.window.addEventListener("orientationchange",this._onWindowResize,!1),e.window.addEventListener("webkitfullscreenchange",this._onWindowResize,!1)),this.handlers=new wn(this,t),this._localFontFamily=t.localFontFamily,this._localIdeographFontFamily=t.localIdeographFontFamily,t.style&&this.setStyle(t.style,{localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),t.projection&&this.setProjection(t.projection),this._hash=t.hash&&new Mr("string"==typeof t.hash&&t.hash||void 0).addTo(this),this._hash&&this._hash._onHashChange()||(this.jumpTo({center:t.center,zoom:t.zoom,bearing:t.bearing,pitch:t.pitch}),t.bounds&&(this.resize(),this.fitBounds(t.bounds,e.extend({},t.fitBoundsOptions,{duration:0})))),this.resize(),t.attributionControl&&this.addControl(new Nn({customAttribution:t.customAttribution})),this._logoControl=new In(),this.addControl(this._logoControl,t.logoPosition),this.on("style.load",()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet);}),this.on("data",t=>{this._update("style"===t.dataType),this.fire(new e.Event(`${t.dataType}data`,t));}),this.on("dataloading",t=>{this.fire(new e.Event(`${t.dataType}dataloading`,t));});}_getMapId(){return this._mapId;}addControl(t,i){if(void 0===i&&(i=t.getDefaultPosition?t.getDefaultPosition():"top-right"),!t||!t.onAdd)return this.fire(new e.ErrorEvent(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const r=t.onAdd(this);this._controls.push(t);const n=this._controlPositions[i];return -1!==i.indexOf("bottom")?n.insertBefore(r,n.firstChild):n.appendChild(r),this;}removeControl(t){if(!t||!t.onRemove)return this.fire(new e.ErrorEvent(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const i=this._controls.indexOf(t);return i>-1&&this._controls.splice(i,1),t.onRemove(this),this;}hasControl(e){return this._controls.indexOf(e)>-1;}getContainer(){return this._container;}getCanvasContainer(){return this._canvasContainer;}getCanvas(){return this._canvas;}resize(t){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const i=!this._moving;return i&&this.fire(new e.Event("movestart",t)).fire(new e.Event("move",t)),this.fire(new e.Event("resize",t)),i&&this.fire(new e.Event("moveend",t)),this;}getBounds(){return this.transform.getBounds();}getMaxBounds(){return this.transform.getMaxBounds()||null;}setMaxBounds(t){return this.transform.setMaxBounds(e.LngLatBounds.convert(t)),this._update();}setMinZoom(t){if((t=null==t?-2:t)>=-2&&t<=this.transform.maxZoom)return this.transform.minZoom=t,this._update(),this.getZoom()<t?this.setZoom(t):this.fire(new e.Event("zoomstart")).fire(new e.Event("zoom")).fire(new e.Event("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive");}getMinZoom(){return this.transform.minZoom;}setMaxZoom(t){if((t=null==t?22:t)>=this.transform.minZoom)return this.transform.maxZoom=t,this._update(),this.getZoom()>t?this.setZoom(t):this.fire(new e.Event("zoomstart")).fire(new e.Event("zoom")).fire(new e.Event("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom");}getMaxZoom(){return this.transform.maxZoom;}setMinPitch(t){if((t=null==t?0:t)<0)throw new Error("minPitch must be greater than or equal to 0");if(t>=0&&t<=this.transform.maxPitch)return this.transform.minPitch=t,this._update(),this.getPitch()<t?this.setPitch(t):this.fire(new e.Event("pitchstart")).fire(new e.Event("pitch")).fire(new e.Event("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive");}getMinPitch(){return this.transform.minPitch;}setMaxPitch(t){if((t=null==t?85:t)>85)throw new Error("maxPitch must be less than or equal to 85");if(t>=this.transform.minPitch)return this.transform.maxPitch=t,this._update(),this.getPitch()>t?this.setPitch(t):this.fire(new e.Event("pitchstart")).fire(new e.Event("pitch")).fire(new e.Event("pitchend")),this;throw new Error("maxPitch must be greater than the current minPitch");}getMaxPitch(){return this.transform.maxPitch;}getRenderWorldCopies(){return this.transform.renderWorldCopies;}setRenderWorldCopies(e){return this.transform.renderWorldCopies=e,this._update();}getProjection(){return this.transform.getProjection();}setProjection(e){return this._lazyInitEmptyStyle(),"string"==typeof e&&(e={name:e}),this._runtimeProjection=e,this.style.updateProjection(),this._transitionFromGlobe=!1,this;}project(t){return this.transform.locationPoint3D(e.LngLat.convert(t));}unproject(t){return this.transform.pointLocation3D(e.pointGeometry.convert(t));}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving();}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming();}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating();}_createDelegatedListener(e,t,i){if("mouseenter"===e||"mouseover"===e){let r=!1;const n=n=>{const o=t.filter(e=>this.getLayer(e)),s=o.length?this.queryRenderedFeatures(n.point,{layers:o}):[];s.length?r||(r=!0,i.call(this,new Or(e,this,n.originalEvent,{features:s}))):r=!1;},o=()=>{r=!1;};return {layers:new Set(t),listener:i,delegates:{mousemove:n,mouseout:o}};}if("mouseleave"===e||"mouseout"===e){let r=!1;const n=n=>{const o=t.filter(e=>this.getLayer(e));(o.length?this.queryRenderedFeatures(n.point,{layers:o}):[]).length?r=!0:r&&(r=!1,i.call(this,new Or(e,this,n.originalEvent)));},o=t=>{r&&(r=!1,i.call(this,new Or(e,this,t.originalEvent)));};return {layers:new Set(t),listener:i,delegates:{mousemove:n,mouseout:o}};}{const r=e=>{const r=t.filter(e=>this.getLayer(e)),n=r.length?this.queryRenderedFeatures(e.point,{layers:r}):[];n.length&&(e.features=n,i.call(this,e),delete e.features);};return {layers:new Set(t),listener:i,delegates:{[e]:r}};}}on(e,t,i){if(void 0===i)return super.on(e,t);Array.isArray(t)||(t=[t]);const r=this._createDelegatedListener(e,t,i);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[e]=this._delegatedListeners[e]||[],this._delegatedListeners[e].push(r);for(const e in r.delegates)this.on(e,r.delegates[e]);return this;}once(e,t,i){if(void 0===i)return super.once(e,t);Array.isArray(t)||(t=[t]);const r=this._createDelegatedListener(e,t,i);for(const e in r.delegates)this.once(e,r.delegates[e]);return this;}off(e,t,i){if(void 0===i)return super.off(e,t);t=new Set(Array.isArray(t)?t:[t]);const r=(e,t)=>{if(e.size!==t.size)return !1;for(const i of e)if(!t.has(i))return !1;return !0;},n=this._delegatedListeners?this._delegatedListeners[e]:void 0;return n&&(e=>{for(let n=0;n<e.length;n++){const o=e[n];if(o.listener===i&&r(o.layers,t)){for(const e in o.delegates)this.off(e,o.delegates[e]);return e.splice(n,1),this;}}})(n),this;}queryRenderedFeatures(t,i){return this.style?(void 0!==i||void 0===t||t instanceof e.pointGeometry||Array.isArray(t)||(i=t,t=void 0),this.style.queryRenderedFeatures(t=t||[[0,0],[this.transform.width,this.transform.height]],i=i||{},this.transform)):[];}querySourceFeatures(e,t){return this.style.querySourceFeatures(e,t);}queryTerrainElevation(t,i){const r=this.transform.elevation;return r?(i=e.extend({},{exaggerated:!0},i),r.getAtPoint(e.MercatorCoordinate.fromLngLat(t),null,i.exaggerated)):null;}setStyle(t,i){return !1!==(i=e.extend({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},i)).diff&&i.localIdeographFontFamily===this._localIdeographFontFamily&&i.localFontFamily===this._localFontFamily&&this.style&&t?(this._diffStyle(t,i),this):(this._localIdeographFontFamily=i.localIdeographFontFamily,this._localFontFamily=i.localFontFamily,this._updateStyle(t,i));}_getUIString(e){const t=this._locale[e];if(null==t)throw new Error(`Missing UI string '${e}'`);return t;}_updateStyle(e,t){return this.style&&(this.style.setEventedParent(null),this.style._remove(),delete this.style),e&&(this.style=new Ut(this,t||{}),this.style.setEventedParent(this,{style:this.style}),"string"==typeof e?this.style.loadURL(e):this.style.loadJSON(e)),this._updateTerrain(),this;}_lazyInitEmptyStyle(){this.style||(this.style=new Ut(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty());}_diffStyle(t,i){if("string"==typeof t){const r=this._requestManager.normalizeStyleURL(t),n=this._requestManager.transformRequest(r,e.ResourceType.Style);e.getJSON(n,(t,r)=>{t?this.fire(new e.ErrorEvent(t)):r&&this._updateDiff(r,i);});}else "object"==typeof t&&this._updateDiff(t,i);}_updateDiff(t,i){try{this.style.setState(t)&&this._update(!0);}catch(r){e.warnOnce(`Unable to perform style diff: ${r.message||r.error||r}.  Rebuilding the style from scratch.`),this._updateStyle(t,i);}}getStyle(){if(this.style)return this.style.serialize();}isStyleLoaded(){return this.style?this.style.loaded():e.warnOnce("There is no style added to the map.");}addSource(e,t){return this._lazyInitEmptyStyle(),this.style.addSource(e,t),this._update(!0);}isSourceLoaded(t){const i=this.style&&this.style._getSourceCaches(t);if(0!==i.length)return i.every(e=>e.loaded());this.fire(new e.ErrorEvent(new Error(`There is no source with ID '${t}'`)));}areTilesLoaded(){const e=this.style&&this.style._sourceCaches;for(const t in e){const i=e[t]._tiles;for(const e in i){const t=i[e];if("loaded"!==t.state&&"errored"!==t.state)return !1;}}return !0;}addSourceType(e,t,i){return this._lazyInitEmptyStyle(),this.style.addSourceType(e,t,i);}removeSource(e){return this.style.removeSource(e),this._updateTerrain(),this._update(!0);}getSource(e){return this.style.getSource(e);}addImage(t,i,{pixelRatio:r=1,sdf:n=!1,stretchX:o,stretchY:s,content:a}={}){if(this._lazyInitEmptyStyle(),i instanceof kn||Rn&&i instanceof Rn){const{width:l,height:c,data:h}=e.exported.getImageData(i);this.style.addImage(t,{data:new e.RGBAImage({width:l,height:c},h),pixelRatio:r,stretchX:o,stretchY:s,content:a,sdf:n,version:0});}else {if(void 0===i.width||void 0===i.height)return this.fire(new e.ErrorEvent(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));{const{width:l,height:c,data:h}=i,u=i;this.style.addImage(t,{data:new e.RGBAImage({width:l,height:c},new Uint8Array(h)),pixelRatio:r,stretchX:o,stretchY:s,content:a,sdf:n,version:0,userImage:u}),u.onAdd&&u.onAdd(this,t);}}}updateImage(t,i){const r=this.style.getImage(t);if(!r)return this.fire(new e.ErrorEvent(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const n=i instanceof kn||Rn&&i instanceof Rn?e.exported.getImageData(i):i,{width:o,height:s,data:a}=n;return void 0===o||void 0===s?this.fire(new e.ErrorEvent(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`"))):o!==r.data.width||s!==r.data.height?this.fire(new e.ErrorEvent(new Error("The width and height of the updated image must be that same as the previous version of the image"))):(r.data.replace(a,!(i instanceof kn||Rn&&i instanceof Rn)),void this.style.updateImage(t,r));}hasImage(t){return t?!!this.style.getImage(t):(this.fire(new e.ErrorEvent(new Error("Missing required image id"))),!1);}removeImage(e){this.style.removeImage(e);}loadImage(t,i){e.getImage(this._requestManager.transformRequest(t,e.ResourceType.Image),(t,r)=>{i(t,r instanceof kn?e.exported.getImageData(r):r);});}listImages(){return this.style.listImages();}addLayer(e,t){return this._lazyInitEmptyStyle(),this.style.addLayer(e,t),this._update(!0);}moveLayer(e,t){return this.style.moveLayer(e,t),this._update(!0);}removeLayer(e){return this.style.removeLayer(e),this._update(!0);}getLayer(e){return this.style.getLayer(e);}setLayerZoomRange(e,t,i){return this.style.setLayerZoomRange(e,t,i),this._update(!0);}setFilter(e,t,i={}){return this.style.setFilter(e,t,i),this._update(!0);}getFilter(e){return this.style.getFilter(e);}setPaintProperty(e,t,i,r={}){return this.style.setPaintProperty(e,t,i,r),this._update(!0);}getPaintProperty(e,t){return this.style.getPaintProperty(e,t);}setLayoutProperty(e,t,i,r={}){return this.style.setLayoutProperty(e,t,i,r),this._update(!0);}getLayoutProperty(e,t){return this.style.getLayoutProperty(e,t);}setLight(e,t={}){return this._lazyInitEmptyStyle(),this.style.setLight(e,t),this._update(!0);}getLight(){return this.style.getLight();}setTerrain(e){return this._lazyInitEmptyStyle(),!e&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(e),this._averageElevationLastSampledAt=-1/0,this._update(!0);}_updateProjection(){"globe"===this.transform.projection.name&&this.transform.zoom>=e.GLOBE_ZOOM_THRESHOLD_MAX&&!this._transitionFromGlobe&&(this.setProjection({name:"mercator"}),this._transitionFromGlobe=!0);}getTerrain(){return this.style?this.style.getTerrain():null;}setFog(e){return this._lazyInitEmptyStyle(),this.style.setFog(e),this._update(!0);}getFog(){return this.style?this.style.getFog():null;}_queryFogOpacity(t){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(e.LngLat.convert(t),this.transform):0;}setFeatureState(e,t){return this.style.setFeatureState(e,t),this._update();}removeFeatureState(e,t){return this.style.removeFeatureState(e,t),this._update();}getFeatureState(e){return this.style.getFeatureState(e);}_updateContainerDimensions(){if(!this._container)return;const t=this._container.getBoundingClientRect().width||400,i=this._container.getBoundingClientRect().height||300;let r,n=this._container;for(;n&&!r;){const t=e.window.getComputedStyle(n).transform;t&&"none"!==t&&(r=t.match(/matrix.*\((.+)\)/)[1].split(", ")),n=n.parentElement;}r?(this._containerWidth=r[0]&&"0"!==r[0]?Math.abs(t/r[0]):t,this._containerHeight=r[3]&&"0"!==r[3]?Math.abs(i/r[3]):i):(this._containerWidth=t,this._containerHeight=i);}_detectMissingCSS(){"rgb(250, 128, 114)"!==e.window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")&&e.warnOnce("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.");}_setupContainer(){const e=this._container;e.classList.add("mapboxgl-map"),(this._missingCSSCanary=s.create("div","mapboxgl-canary",e)).style.visibility="hidden",this._detectMissingCSS();const t=this._canvasContainer=s.create("div","mapboxgl-canvas-container",e);this._interactive&&t.classList.add("mapboxgl-interactive"),this._canvas=s.create("canvas","mapboxgl-canvas",t),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("tabindex","0"),this._canvas.setAttribute("aria-label","Map"),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const i=this._controlContainer=s.create("div","mapboxgl-control-container",e),r=this._controlPositions={};["top-left","top-right","bottom-left","bottom-right"].forEach(e=>{r[e]=s.create("div",`mapboxgl-ctrl-${e}`,i);}),this._container.addEventListener("scroll",this._onMapScroll,!1);}_resizeCanvas(t,i){const r=e.exported.devicePixelRatio||1;this._canvas.width=r*Math.ceil(t),this._canvas.height=r*Math.ceil(i),this._canvas.style.width=`${t}px`,this._canvas.style.height=`${i}px`;}_addMarker(e){this._markers.push(e);}_removeMarker(e){const t=this._markers.indexOf(e);-1!==t&&this._markers.splice(t,1);}_setupPainter(){const i=e.extend({},t.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),r=this._canvas.getContext("webgl",i)||this._canvas.getContext("experimental-webgl",i);r?(e.storeAuthState(r,!0),this.painter=new dr(r,this.transform),this.on("data",e=>{"source"===e.dataType&&this.painter.setTileLoadedFlag(!0);}),e.exported$1.testSupport(r)):this.fire(new e.ErrorEvent(new Error("Failed to initialize WebGL")));}_contextLost(t){t.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new e.Event("webglcontextlost",{originalEvent:t}));}_contextRestored(t){this._setupPainter(),this.resize(),this._update(),this.fire(new e.Event("webglcontextrestored",{originalEvent:t}));}_onMapScroll(e){if(e.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1;}loaded(){return !this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded();}_update(e){return this.style?(this._styleDirty=this._styleDirty||e,this._sourcesDirty=!0,this.triggerRepaint(),this):this;}_requestRenderFrame(e){return this._update(),this._renderTaskQueue.add(e);}_cancelRenderFrame(e){this._renderTaskQueue.remove(e);}_requestDomTask(e){!this.loaded()||this.loaded()&&!this.isMoving()?e():this._domRenderTaskQueue.add(e);}_render(t){let i;const r=this.painter.context.extTimerQuery,n=e.exported.now();this.listens("gpu-timing-frame")&&(i=r.createQueryEXT(),r.beginQueryEXT(r.TIME_ELAPSED_EXT,i));let o=this._updateAverageElevation(n);if(this.painter.context.setDirty(),this.painter.setBaseState(),this._renderTaskQueue.run(t),this._domRenderTaskQueue.run(t),this._removed)return;this._updateProjection();let s=!1;const a=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const t=this.transform.zoom,i=this.transform.pitch,r=e.exported.now();this.style.zoomHistory.update(t,r);const n=new e.EvaluationParameters(t,{now:r,fadeDuration:a,pitch:i,zoomHistory:this.style.zoomHistory,transition:this.style.getTransition()}),o=n.crossFadingFactor();1===o&&o===this._crossFadingFactor||(s=!0,this._crossFadingFactor=o),this.style.update(n);}if(this.style&&this.style.fog&&this.style.fog.hasTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0),this.style&&this._sourcesDirty&&(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),this.style._updateSources(this.transform),this._forceMarkerUpdate()),this._placementDirty=this.style&&this.style._updatePlacement(this.painter.transform,this.showCollisionBoxes,a,this._crossSourceCollisions),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showTerrainWireframe:this.showTerrainWireframe,showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:a,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),speedIndexTiming:this.speedIndexTiming}),this.fire(new e.Event("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,this.fire(new e.Event("load"))),this.style&&(this.style.hasTransitions()||s)&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),this.listens("gpu-timing-frame")){const t=e.exported.now()-n;r.endQueryEXT(r.TIME_ELAPSED_EXT,i),setTimeout(()=>{const n=r.getQueryObjectEXT(i,r.QUERY_RESULT_EXT)/1e6;r.deleteQueryEXT(i),this.fire(new e.Event("gpu-timing-frame",{cpuTime:t,gpuTime:n}));},50);}if(this.listens("gpu-timing-layer")){const t=this.painter.collectGpuTimers();setTimeout(()=>{const i=this.painter.queryGpuTimers(t);this.fire(new e.Event("gpu-timing-layer",{layerTimes:i}));},50);}const l=this._sourcesDirty||this._styleDirty||this._placementDirty||o;if(l||this._repaint)this.triggerRepaint();else {const t=!this.isMoving()&&this.loaded();if(t&&(o=this._updateAverageElevation(n,!0)),o)this.triggerRepaint();else if(this._triggerFrame(!1),t&&(this.fire(new e.Event("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const t=this._calculateSpeedIndex();this.fire(new e.Event("speedindexcompleted",{speedIndex:t})),this.speedIndexTiming=!1;}}return !this._loaded||this._fullyLoaded||l||(this._fullyLoaded=!0,this._authenticate()),this;}_forceMarkerUpdate(){for(const e of this._markers)e._update();}_updateAverageElevation(e,t=!1){const i=e=>(this.transform.averageElevation=e,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return 0!==this.transform.averageElevation&&i(0);if((t||e-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(e)){const t=this.transform.averageElevation;let r=this.transform.sampleAverageElevation();isNaN(r)?r=0:this._averageElevationLastSampledAt=e;const n=Math.abs(t-r);if(n>1){if(this._isInitialLoad)return this._averageElevation.jumpTo(r),i(r);this._averageElevation.easeTo(r,e,300);}else if(n>1e-4)return this._averageElevation.jumpTo(r),i(r);}return !!this._averageElevation.isEasing(e)&&i(this._averageElevation.getValue(e));}_authenticate(){e.getMapSessionAPI(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,t=>{if(t&&(t.message===e.AUTH_ERR_MSG||401===t.status)){const t=this.painter.context.gl;e.storeAuthState(t,!1),this._logoControl instanceof In&&this._logoControl._updateLogo(),t&&t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT|t.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new e.ErrorEvent(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")));}}),e.postMapLoadEvent(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,()=>{});}_updateTerrain(){this.painter.updateTerrain(this.style,this.isMoving()||this.isRotating()||this.isZooming());}_calculateSpeedIndex(){const e=this.painter.canvasCopy(),t=this.painter.getCanvasCopiesAndTimestamps();t.timeStamps.push(performance.now());const i=this.painter.context.gl,r=i.createFramebuffer();function n(e){i.framebufferTexture2D(i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,e,0);const t=new Uint8Array(i.drawingBufferWidth*i.drawingBufferHeight*4);return i.readPixels(0,0,i.drawingBufferWidth,i.drawingBufferHeight,i.RGBA,i.UNSIGNED_BYTE,t),t;}return i.bindFramebuffer(i.FRAMEBUFFER,r),this._canvasPixelComparison(n(e),t.canvasCopies.map(n),t.timeStamps);}_canvasPixelComparison(e,t,i){let r=i[1]-i[0];const n=e.length/4;for(let o=0;o<t.length;o++){const s=t[o];let a=0;for(let t=0;t<s.length;t+=4)s[t]===e[t]&&s[t+1]===e[t+1]&&s[t+2]===e[t+2]&&s[t+3]===e[t+3]&&(a+=1);r+=(i[o+2]-i[o+1])*(1-a/n);}return r;}remove(){this._hash&&this._hash.remove();for(const e of this._controls)e.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.painter.destroy(),this.handlers.destroy(),delete this.handlers,this.setStyle(null),void 0!==e.window&&(e.window.removeEventListener("resize",this._onWindowResize,!1),e.window.removeEventListener("orientationchange",this._onWindowResize,!1),e.window.removeEventListener("webkitfullscreenchange",this._onWindowResize,!1),e.window.removeEventListener("online",this._onWindowOnline,!1));const t=this.painter.context.gl.getExtension("WEBGL_lose_context");t&&t.loseContext(),Fn(this._canvasContainer),Fn(this._controlContainer),Fn(this._missingCSSCanary),this._container.classList.remove("mapboxgl-map"),e.removeAuthState(this.painter.context.gl),this._removed=!0,this.fire(new e.Event("remove"));}triggerRepaint(){this._triggerFrame(!0);}_triggerFrame(t){this._renderNextFrame=this._renderNextFrame||t,this.style&&!this._frame&&(this._frame=e.exported.frame(e=>{const t=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,t&&this._render(e);}));}_preloadTiles(t){const i=this.style&&Object.values(this.style._sourceCaches)||[];return e.asyncAll(i,(e,i)=>e._preloadTiles(t,i),()=>{this.triggerRepaint();}),this;}_onWindowOnline(){this._update();}_onWindowResize(e){this._trackResize&&this.resize({originalEvent:e})._update();}get showTileBoundaries(){return !!this._showTileBoundaries;}set showTileBoundaries(e){this._showTileBoundaries!==e&&(this._showTileBoundaries=e,this._update());}get showTerrainWireframe(){return !!this._showTerrainWireframe;}set showTerrainWireframe(e){this._showTerrainWireframe!==e&&(this._showTerrainWireframe=e,this._update());}get speedIndexTiming(){return !!this._speedIndexTiming;}set speedIndexTiming(e){this._speedIndexTiming!==e&&(this._speedIndexTiming=e,this._update());}get showPadding(){return !!this._showPadding;}set showPadding(e){this._showPadding!==e&&(this._showPadding=e,this._update());}get showCollisionBoxes(){return !!this._showCollisionBoxes;}set showCollisionBoxes(e){this._showCollisionBoxes!==e&&(this._showCollisionBoxes=e,e?this.style._generateCollisionBoxes():this._update());}get showOverdrawInspector(){return !!this._showOverdrawInspector;}set showOverdrawInspector(e){this._showOverdrawInspector!==e&&(this._showOverdrawInspector=e,this._update());}get repaint(){return !!this._repaint;}set repaint(e){this._repaint!==e&&(this._repaint=e,this.triggerRepaint());}get vertices(){return !!this._vertices;}set vertices(e){this._vertices=e,this._update();}_setCacheLimits(t,i){e.setCacheLimits(t,i);}get version(){return e.version;}},NavigationControl:class{constructor(t){this.options=e.extend({},Bn,t),this._container=s.create("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",e=>e.preventDefault()),this.options.showZoom&&(e.bindAll(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",e=>this._map.zoomIn({},{originalEvent:e})),s.create("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden",!0),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",e=>this._map.zoomOut({},{originalEvent:e})),s.create("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden",!0)),this.options.showCompass&&(e.bindAll(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",e=>{this.options.visualizePitch?this._map.resetNorthPitch({},{originalEvent:e}):this._map.resetNorth({},{originalEvent:e});}),this._compassIcon=s.create("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden",!0));}_updateZoomButtons(){const e=this._map.getZoom(),t=e===this._map.getMaxZoom(),i=e===this._map.getMinZoom();this._zoomInButton.disabled=t,this._zoomOutButton.disabled=i,this._zoomInButton.setAttribute("aria-disabled",t.toString()),this._zoomOutButton.setAttribute("aria-disabled",i.toString());}_rotateCompassArrow(){const e=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(this._map.transform.pitch*(Math.PI/180)),.5)}) rotateX(${this._map.transform.pitch}deg) rotateZ(${this._map.transform.angle*(180/Math.PI)}deg)`:`rotate(${this._map.transform.angle*(180/Math.PI)}deg)`;this._map._requestDomTask(()=>{this._compassIcon&&(this._compassIcon.style.transform=e);});}onAdd(e){return this._map=e,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),this._map.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&this._map.on("pitch",this._rotateCompassArrow),this._map.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Un(this._map,this._compass,this.options.visualizePitch)),this._container;}onRemove(){this._container.remove(),this.options.showZoom&&this._map.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&this._map.off("pitch",this._rotateCompassArrow),this._map.off("rotate",this._rotateCompassArrow),this._handler.off(),delete this._handler),delete this._map;}_createButton(e,t){const i=s.create("button",e,this._container);return i.type="button",i.addEventListener("click",t),i;}_setButtonTitle(e,t){const i=this._map._getUIString(`NavigationControl.${t}`);e.setAttribute("aria-label",i),e.firstElementChild&&e.firstElementChild.setAttribute("title",i);}},GeolocateControl:class extends e.Evented{constructor(t){super(),this.options=e.extend({},Vn,t),e.bindAll(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation"],this),this._onDeviceOrientationListener=this._onDeviceOrientation.bind(this),this._updateMarkerRotationThrottled=Ir(this._updateMarkerRotation,20);}onAdd(t){var i;return this._map=t,this._container=s.create("div","mapboxgl-ctrl mapboxgl-ctrl-group"),i=this._setupUI,void 0!==Gn?i(Gn):void 0!==e.window.navigator.permissions?e.window.navigator.permissions.query({name:"geolocation"}).then(e=>{Gn="denied"!==e.state,i(Gn);}):(Gn=!!e.window.navigator.geolocation,i(Gn)),this._container;}onRemove(){void 0!==this._geolocationWatchID&&(e.window.navigator.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,jn=0,$n=!1;}_isOutOfMapMaxBounds(e){const t=this._map.getMaxBounds(),i=e.coords;return t&&(i.longitude<t.getWest()||i.longitude>t.getEast()||i.latitude<t.getSouth()||i.latitude>t.getNorth());}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");}}_onSuccess(t){if(this._map){if(this._isOutOfMapMaxBounds(t))return this._setErrorState(),this.fire(new e.Event("outofmaxbounds",t)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=t,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");}this.options.showUserLocation&&"OFF"!==this._watchState&&this._updateMarker(t),this.options.trackUserLocation&&"ACTIVE_LOCK"!==this._watchState||this._updateCamera(t),this.options.showUserLocation&&this._dotElement.classList.remove("mapboxgl-user-location-dot-stale"),this.fire(new e.Event("geolocate",t)),this._finish();}}_updateCamera(t){const i=new e.LngLat(t.coords.longitude,t.coords.latitude),r=t.coords.accuracy,n=this._map.getBearing(),o=e.extend({bearing:n},this.options.fitBoundsOptions);this._map.fitBounds(i.toBounds(r),o,{geolocateSource:!0});}_updateMarker(t){if(t){const i=new e.LngLat(t.coords.longitude,t.coords.latitude);this._accuracyCircleMarker.setLngLat(i).addTo(this._map),this._userLocationDotMarker.setLngLat(i).addTo(this._map),this._accuracy=t.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius();}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove();}_updateCircleRadius(){const e=this._map._containerHeight/2,t=this._map.unproject([0,e]),i=this._map.unproject([100,e]),r=t.distanceTo(i)/100,n=Math.ceil(2*this._accuracy/r);this._circleElement.style.width=`${n}px`,this._circleElement.style.height=`${n}px`;}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius();}_updateMarkerRotation(){this._userLocationDotMarker&&"number"==typeof this._heading?(this._userLocationDotMarker.setRotation(this._heading),this._dotElement.classList.add("mapboxgl-user-location-show-heading")):(this._dotElement.classList.remove("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0));}_onError(t){if(this._map){if(this.options.trackUserLocation)if(1===t.code){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const e=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",e),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",e),void 0!==this._geolocationWatchID&&this._clearWatch();}else {if(3===t.code&&$n)return;this._setErrorState();}"OFF"!==this._watchState&&this.options.showUserLocation&&this._dotElement.classList.add("mapboxgl-user-location-dot-stale"),this.fire(new e.Event("error",t)),this._finish();}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0;}_setupUI(t){if(this._container.addEventListener("contextmenu",e=>e.preventDefault()),this._geolocateButton=s.create("button","mapboxgl-ctrl-geolocate",this._container),s.create("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden",!0),this._geolocateButton.type="button",!1===t){e.warnOnce("Geolocation support is not available so the GeolocateControl will be disabled.");const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t);}else {const e=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",e),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",e);}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=s.create("div","mapboxgl-user-location"),this._dotElement.appendChild(s.create("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(s.create("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new Pn({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=s.create("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new Pn({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",t=>{t.geolocateSource||"ACTIVE_LOCK"!==this._watchState||t.originalEvent&&"resize"===t.originalEvent.type||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new e.Event("trackuserlocationend")));});}_onDeviceOrientation(e){this._userLocationDotMarker&&(e.webkitCompassHeading?this._heading=e.webkitCompassHeading:!0===e.absolute&&(this._heading=-1*e.alpha),this._updateMarkerRotationThrottled());}trigger(){if(!this._setup)return e.warnOnce("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new e.Event("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":jn--,$n=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new e.Event("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new e.Event("trackuserlocationstart"));}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error");}if("OFF"===this._watchState&&void 0!==this._geolocationWatchID)this._clearWatch();else if(void 0===this._geolocationWatchID){let t;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),jn++,jn>1?(t={maximumAge:6e5,timeout:0},$n=!0):(t=this.options.positionOptions,$n=!1),this._geolocationWatchID=e.window.navigator.geolocation.watchPosition(this._onSuccess,this._onError,t),this.options.showUserHeading&&this._addDeviceOrientationListener();}}else e.window.navigator.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=setTimeout(this._finish,1e4);return !0;}_addDeviceOrientationListener(){const t=()=>{e.window.addEventListener("ondeviceorientationabsolute"in e.window?"deviceorientationabsolute":"deviceorientation",this._onDeviceOrientationListener);};void 0!==e.window.DeviceMotionEvent&&"function"==typeof e.window.DeviceMotionEvent.requestPermission?DeviceOrientationEvent.requestPermission().then(e=>{"granted"===e&&t();}).catch(console.error):t();}_clearWatch(){e.window.navigator.geolocation.clearWatch(this._geolocationWatchID),e.window.removeEventListener("deviceorientation",this._onDeviceOrientationListener),e.window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientationListener),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null);}},AttributionControl:Nn,ScaleControl:class{constructor(t){this.options=e.extend({},Hn,t),e.bindAll(["_onMove","setUnit"],this);}getDefaultPosition(){return "bottom-left";}_onMove(){qn(this._map,this._container,this.options);}onAdd(e){return this._map=e,this._container=s.create("div","mapboxgl-ctrl mapboxgl-ctrl-scale",e.getContainer()),this._map.on("move",this._onMove),this._onMove(),this._container;}onRemove(){this._container.remove(),this._map.off("move",this._onMove),this._map=void 0;}setUnit(e){this.options.unit=e,qn(this._map,this._container,this.options);}},FullscreenControl:class{constructor(t){this._fullscreen=!1,t&&t.container&&(t.container instanceof e.window.HTMLElement?this._container=t.container:e.warnOnce("Full screen control 'container' must be a DOM element.")),e.bindAll(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in e.window.document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in e.window.document&&(this._fullscreenchange="webkitfullscreenchange");}onAdd(t){return this._map=t,this._container||(this._container=this._map.getContainer()),this._controlContainer=s.create("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",e.warnOnce("This device does not support fullscreen mode.")),this._controlContainer;}onRemove(){this._controlContainer.remove(),this._map=null,e.window.document.removeEventListener(this._fullscreenchange,this._changeIcon);}_checkFullscreenSupport(){return !(!e.window.document.fullscreenEnabled&&!e.window.document.webkitFullscreenEnabled);}_setupUI(){const t=this._fullscreenButton=s.create("button","mapboxgl-ctrl-fullscreen",this._controlContainer);s.create("span","mapboxgl-ctrl-icon",t).setAttribute("aria-hidden",!0),t.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),e.window.document.addEventListener(this._fullscreenchange,this._changeIcon);}_updateTitle(){const e=this._getTitle();this._fullscreenButton.setAttribute("aria-label",e),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",e);}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter");}_isFullscreen(){return this._fullscreen;}_changeIcon(){(e.window.document.fullscreenElement||e.window.document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle());}_onClickFullscreen(){this._isFullscreen()?e.window.document.exitFullscreen?e.window.document.exitFullscreen():e.window.document.webkitCancelFullScreen&&e.window.document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen();}},Popup:class extends e.Evented{constructor(t){super(),this.options=e.extend(Object.create(Xn),t),e.bindAll(["_update","_onClose","remove","_onMouseMove","_onMouseUp","_onDrag"],this),this._classList=new Set(t&&t.className?t.className.trim().split(/\s+/):[]);}addTo(t){return this._map&&this.remove(),this._map=t,this.options.closeOnClick&&this._map.on("preclick",this._onClose),this.options.closeOnMove&&this._map.on("move",this._onClose),this._map.on("remove",this.remove),this._update(),this._focusFirstElement(),this._trackPointer?(this._map.on("mousemove",this._onMouseMove),this._map.on("mouseup",this._onMouseUp),this._map._canvasContainer.classList.add("mapboxgl-track-pointer")):this._map.on("move",this._update),this.fire(new e.Event("open")),this;}isOpen(){return !!this._map;}remove(){return this._content&&this._content.remove(),this._container&&(this._container.remove(),delete this._container),this._map&&(this._map.off("move",this._update),this._map.off("move",this._onClose),this._map.off("click",this._onClose),this._map.off("remove",this.remove),this._map.off("mousemove",this._onMouseMove),this._map.off("mouseup",this._onMouseUp),this._map.off("drag",this._onDrag),delete this._map),this.fire(new e.Event("close")),this;}getLngLat(){return this._lngLat;}setLngLat(t){return this._lngLat=e.LngLat.convert(t),this._pos=null,this._trackPointer=!1,this._update(),this._map&&(this._map.on("move",this._update),this._map.off("mousemove",this._onMouseMove),this._map._canvasContainer.classList.remove("mapboxgl-track-pointer")),this;}trackPointer(){return this._trackPointer=!0,this._pos=null,this._update(),this._map&&(this._map.off("move",this._update),this._map.on("mousemove",this._onMouseMove),this._map.on("drag",this._onDrag),this._map._canvasContainer.classList.add("mapboxgl-track-pointer")),this;}getElement(){return this._container;}setText(t){return this.setDOMContent(e.window.document.createTextNode(t));}setHTML(t){const i=e.window.document.createDocumentFragment(),r=e.window.document.createElement("body");let n;for(r.innerHTML=t;n=r.firstChild,n;)i.appendChild(n);return this.setDOMContent(i);}getMaxWidth(){return this._container&&this._container.style.maxWidth;}setMaxWidth(e){return this.options.maxWidth=e,this._update(),this;}setDOMContent(e){if(this._content)for(;this._content.hasChildNodes();)this._content.firstChild&&this._content.removeChild(this._content.firstChild);else this._content=s.create("div","mapboxgl-popup-content",this._container);return this._content.appendChild(e),this._createCloseButton(),this._update(),this._focusFirstElement(),this;}addClassName(e){return this._classList.add(e),this._container&&this._updateClassList(),this;}removeClassName(e){return this._classList.delete(e),this._container&&this._updateClassList(),this;}setOffset(e){return this.options.offset=e,this._update(),this;}toggleClassName(e){let t;return this._classList.delete(e)?t=!1:(this._classList.add(e),t=!0),this._container&&this._updateClassList(),t;}_createCloseButton(){this.options.closeButton&&(this._closeButton=s.create("button","mapboxgl-popup-close-button",this._content),this._closeButton.type="button",this._closeButton.setAttribute("aria-label","Close popup"),this._closeButton.setAttribute("aria-hidden","true"),this._closeButton.innerHTML="&#215;",this._closeButton.addEventListener("click",this._onClose));}_onMouseUp(e){this._update(e.point);}_onMouseMove(e){this._update(e.point);}_onDrag(e){this._update(e.point);}_getAnchor(e){if(this.options.anchor)return this.options.anchor;const t=this._pos,i=this._container.offsetWidth,r=this._container.offsetHeight;let n;return n=t.y+e.bottom.y<r?["top"]:t.y>this._map.transform.height-r?["bottom"]:[],t.x<i/2?n.push("left"):t.x>this._map.transform.width-i/2&&n.push("right"),0===n.length?"bottom":n.join("-");}_updateClassList(){const e=[...this._classList];e.push("mapboxgl-popup"),this._anchor&&e.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&e.push("mapboxgl-popup-track-pointer"),this._container.className=e.join(" ");}_update(t){if(this._map&&(this._lngLat||this._trackPointer)&&this._content){if(this._container||(this._container=s.create("div","mapboxgl-popup",this._map.getContainer()),this._tip=s.create("div","mapboxgl-popup-tip",this._container),this._container.appendChild(this._content)),this.options.maxWidth&&this._container.style.maxWidth!==this.options.maxWidth&&(this._container.style.maxWidth=this.options.maxWidth),this._map.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=Cn(this._lngLat,this._pos,this._map.transform)),!this._trackPointer||t){const i=this._pos=this._trackPointer&&t?t:this._map.project(this._lngLat),r=function(t){if(t||(t=new e.pointGeometry(0,0)),"number"==typeof t){const i=Math.round(Math.sqrt(.5*Math.pow(t,2)));return {center:new e.pointGeometry(0,0),top:new e.pointGeometry(0,t),"top-left":new e.pointGeometry(i,i),"top-right":new e.pointGeometry(-i,i),bottom:new e.pointGeometry(0,-t),"bottom-left":new e.pointGeometry(i,-i),"bottom-right":new e.pointGeometry(-i,-i),left:new e.pointGeometry(t,0),right:new e.pointGeometry(-t,0)};}if(t instanceof e.pointGeometry||Array.isArray(t)){const i=e.pointGeometry.convert(t);return {center:i,top:i,"top-left":i,"top-right":i,bottom:i,"bottom-left":i,"bottom-right":i,left:i,right:i};}return {center:e.pointGeometry.convert(t.center||[0,0]),top:e.pointGeometry.convert(t.top||[0,0]),"top-left":e.pointGeometry.convert(t["top-left"]||[0,0]),"top-right":e.pointGeometry.convert(t["top-right"]||[0,0]),bottom:e.pointGeometry.convert(t.bottom||[0,0]),"bottom-left":e.pointGeometry.convert(t["bottom-left"]||[0,0]),"bottom-right":e.pointGeometry.convert(t["bottom-right"]||[0,0]),left:e.pointGeometry.convert(t.left||[0,0]),right:e.pointGeometry.convert(t.right||[0,0])};}(this.options.offset),n=this._anchor=this._getAnchor(r),o=i.add(r[n]).round();this._map._requestDomTask(()=>{this._container&&n&&(this._container.style.transform=`${An[n]} translate(${o.x}px,${o.y}px)`);});}this._updateClassList();}}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const e=this._container.querySelector(Wn);e&&e.focus();}_onClose(){this.remove();}_setOpacity(e){this._content&&(this._content.style.opacity=e),this._tip&&(this._tip.style.opacity=e);}},Marker:Pn,Style:Ut,LngLat:e.LngLat,LngLatBounds:e.LngLatBounds,Point:e.pointGeometry,MercatorCoordinate:e.MercatorCoordinate,FreeCameraOptions:yr,Evented:e.Evented,config:e.config,prewarm:function(){Le().acquire(Ce);},clearPrewarmedResources:function(){const e=Pe;e&&(e.isPreloaded()&&1===e.numActive()?(e.release(Ce),Pe=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"));},get accessToken(){return e.config.ACCESS_TOKEN;},set accessToken(t){e.config.ACCESS_TOKEN=t;},get baseApiUrl(){return e.config.API_URL;},set baseApiUrl(t){e.config.API_URL=t;},get workerCount(){return Ae.workerCount;},set workerCount(e){Ae.workerCount=e;},get maxParallelImageRequests(){return e.config.MAX_PARALLEL_IMAGE_REQUESTS;},set maxParallelImageRequests(t){e.config.MAX_PARALLEL_IMAGE_REQUESTS=t;},clearStorage(t){e.clearTileCache(t);},workerUrl:"",workerClass:null,setNow:e.exported.setNow,restoreNow:e.exported.restoreNow};return Yn;}),i;}();class pe{markerId;definition;visible=!1;static TYPE_POLYGON="polygon";static TYPE_POINT="point";static _markerSerial=0;layerIds=[];constructor(e){this.markerId="marker"+pe._markerSerial++,e&&this.setDefinition(e);}setDefinition(e){this.definition=e;}addToMap(e){switch(this.definition.type){case pe.TYPE_POLYGON:this.#E(e);break;case pe.TYPE_POINT:break;default:throw new Error("Unrecognised marker type '{this.definition.type}'.");}}#E(e){e.isStyleLoaded()?this._addPolygonImpl(e):setTimeout(()=>{this.#E(e);},1e3);}_addPolygonImpl(e){e.addSource(this.markerId,{type:"geojson",data:{type:"Feature",properties:{name:this.definition.name},geometry:{type:"Polygon",coordinates:this.definition.coordinates}}}),this._addPolygonMarkerLayersToMap(e);}_addPolygonMarkerLayersToMap(e){if(this.definition.fillColour){let t={"fill-color":this.definition.fillColour};this.definition.fillOpacity&&(t["fill-opacity"]=this.definition.fillOpacity);const i=`${this.markerId}-fill`;e.addLayer({id:i,type:"fill",source:this.markerId,layout:{},paint:t}),this.layerIds.push(i);}if(this.definition.lineColour){let t={"line-color":this.definition.lineColour};this.definition.lineOpacity&&(t["line-opacity"]=this.definition.lineOpacity),this.definition.lineWidth&&(t["line-width"]=this.definition.lineWidth);const i=`${this.markerId}-line`;e.addLayer({id:i,type:"line",source:this.markerId,layout:{},paint:t}),this.layerIds.push(i);}this.visible=!0;}updateCoordinates(e,t,i){this.definition.coordinates=t,this.definition.name=i;let r=e.getSource(this.markerId);if(r)try{r.setData({type:"Feature",properties:{name:this.definition.name},geometry:{type:"Polygon",coordinates:this.definition.coordinates}}),this.visible||this._addPolygonMarkerLayersToMap(e);}catch(e){console.error({"Exception in MapMarker.updateCoordinates":e});}else console.error("Source is null in MapMarker.updateCoordinates");}removeFromMap(e){for(let t of this.layerIds)e.removeLayer(t);e.removeSource(this.markerId),this.visible=!1;}}class fe extends he{includeSearchBox=!1;defaultLat=55.15793;defaultLng=-4.68;defaultZoom=5;map;_squareMarker;mapPositionIsCurrent=!1;static GPS_INITIALISATION_MODE_ALWAYS="always";static GPS_INITIALISATION_MODE_PERMITTED="permitted";static GPS_INITIALISATION_MODE_MOBILE_ALWAYS="mobilealways";static GPS_INITIALISATION_MODE_MOBILE_PERMITTED="mobilepermitted";static GPS_INITIALISATION_MODE_NEVER="never";gpsInitialisationMode=fe.GPS_INITIALISATION_MODE_MOBILE_PERMITTED;geocoderOnMap=!1;useSeparateInputField=!1;constructor(e){if(super(e),e&&(e.includeSearchBox&&(this.includeSearchBox=e.includeSearchBox),e.gpsInitialisationMode&&(this.gpsInitialisationMode=e.gpsInitialisationMode)),!this.includeSearchBox&&!this.useSeparateInputField)throw new Error("Incompatible false combination of geo-ref field options: includeSearchBox and useSeparateInputField");}updateView(){if(this._fieldEl){document.getElementById(this._inputId).value=P.cleanRawString(this._value.gridRef),this.tryValue(this._value.gridRef);}}buildField(){const e=document.createElement("div");if(e.className="form-group",this.containerId=e.id=P.nextId,this._inputId=P.nextId,navigator.geolocation&&this.showGPSEnableLinkIfNotActiveOnMobile&&D.getDeviceType()===D.DEVICE_TYPE_MOBILE){const t=document.createElement("a");t.className="no-gps-link-prompt",t.href="#",t.innerText="Please enable GPS",e.appendChild(t),t.addEventListener("click",this.gpsButtonClickHandler.bind(this));}const t=e.appendChild(document.createElement("label"));t.htmlFor=this._inputId,t.textContent=this.label;const i=e.appendChild(document.createElement("div"));if(i.className="input-group",this.useSeparateInputField){const e=i.appendChild(document.createElement("input"));e.className="form-control",e.id=this._inputId,e.type="text",this.placeholder&&(e.placeholder=this.placeholder),this._autocomplete&&(e.autocomplete=this._autocomplete),"off"!==this._autocomplete&&""!==this._autocomplete||(e.name=x()),e.addEventListener("change",this.inputChangeHandler.bind(this)),this.completion===P.COMPLETION_COMPULSORY&&(e.required=!0);}if(this.validationMessage){const t=e.appendChild(document.createElement("div"));t.className="invalid-feedback",t.innerHTML=this.validationMessage;}if(this.addMapBox(e),this.includeSearchBox){const t=new MapboxGeocoder({accessToken:de.accessToken,mapboxgl:de,marker:!1,bbox:[-11,49.1,2,61],localGeocoder:e=>this.localGridRefGeocoder(e)});if(t.on("result",e=>{console.log({"geocode result":e}),this.#N(e.result);}),this.geocoderOnMap?this.map.addControl(t,"top-right"):i.appendChild(t.onAdd(this.map)),!this.useSeparateInputField){const i=e.getElementsByClassName("mapboxgl-ctrl-geocoder--input")[0];i||console.error("Failed to look-up geocoder's input element by class name"),i.id=this._inputId,i.classList.add("form-control"),i.addEventListener("change",this.inputChangeHandler.bind(this)),this.placeholder&&(i.placeholder=this.placeholder),this._autocomplete&&(i.autocomplete=this._autocomplete),"off"!==this._autocomplete&&"no"!==this._autocomplete&&""!==this._autocomplete||(i.name=x()),t.on("clear",()=>{console.log("geocoder cleared"),this.value={gridRef:"",rawString:"",source:he.GEOREF_SOURCE_UNKNOWN,latLng:null,precision:null},this.fireEvent(P.EVENT_CHANGE);});}}if(navigator.geolocation){const e=i.appendChild(document.createElement("span"));e.className="input-group-btn gps-button-flex";const t=e.appendChild(document.createElement("button"));if(t.id=P.nextId,t.type="button",t.className="btn btn-outline-secondary btn-sm",t.title="use GPS",this.gpsTextLabel){const e=t.appendChild(document.createElement("span"));e.style.verticalAlign="middle",e.innerText="GPS ";}const r=t.appendChild(document.createElement("span"));r.className="material-icons gps-icon",r.innerText="gps_not_fixed",this.gpsTextLabel&&(r.style.verticalAlign="middle"),t.addEventListener("click",this.gpsButtonClickHandler.bind(this));}const r=e.appendChild(document.createElement("small"));if(r.classList.add("offline-warning"),r.innerHTML="The map box might not display properly because you may not have a network connection currently. You can still use GPS or type in a grid-reference to locate records.",this.helpText){e.appendChild(document.createElement("small")).innerHTML=this.helpText;}this._fieldEl=e;}localGridRefGeocoder(e){let t=[];if(e=e.trim()){const i=q.from_string(e);if(i){const e=i.gridCoords.to_latLng(),r=new i.GridCoords(i.gridCoords.x,i.gridCoords.y+i.length).to_latLng(),n=new i.GridCoords(i.gridCoords.x+i.length,i.gridCoords.y+i.length).to_latLng(),o=new i.GridCoords(i.gridCoords.x+i.length,i.gridCoords.y).to_latLng(),s=(e.lat+r.lat+o.lat+n.lat)/4,a=(e.lng+r.lng+o.lng+n.lng)/4;t[0]={type:"Feature",text:`${i.preciseGridRef} (grid-reference)`,place_name:i.preciseGridRef,place_type:"gridreference",grid_square_precision:i.length,geometry:{type:"Point",coordinates:[a,s]},bbox:[r.lng,r.lat,o.lng,o.lat]};}}return t;}addField(e){super.addField(e),this.parentForm.addListener(k.EVENT_INITIALISE_NEW,async e=>{if(console.log("Handling initialisation of new MapGeoRefField."),this._value.gridRef)return void console.log({"In georef form initialisation already have a value set, so aborting.":this._value});let t;t=!(!navigator.geolocation||this.gpsInitialisationMode===fe.GPS_INITIALISATION_MODE_NEVER)&&(this.gpsInitialisationMode===fe.GPS_INITIALISATION_MODE_MOBILE_ALWAYS||this.gpsInitialisationMode===fe.GPS_INITIALISATION_MODE_MOBILE_PERMITTED?D.getDeviceType()===D.DEVICE_TYPE_MOBILE&&(this.gpsInitialisationMode===fe.GPS_INITIALISATION_MODE_MOBILE_ALWAYS||(await D.haveGPSPermission())===D.GPS_PERMISSION_GRANTED):this.gpsInitialisationMode===fe.GPS_INITIALISATION_MODE_ALWAYS||(await D.haveGPSPermission())===D.GPS_PERMISSION_GRANTED),t?(this.parentForm.addListener(k.EVENT_CAMERA,()=>{this.seekGPS().then(()=>{console.log("After photo got successful GPS fix.");},()=>{console.log("After photo failed GPS fix.");});}),this.seekGPS().then(()=>{console.log("GPS initialisation succeeded."),this._tryDefaultGeoreferenceFromSurvey(e.survey,!1);},t=>{console.log({"GPS initialisation failed":t}),this._tryDefaultGeoreferenceFromSurvey(e.survey,!0);})):this._tryDefaultGeoreferenceFromSurvey(e.survey,!0);}),this.parentForm.addListener(k.EVENT_INITIALISED,e=>{console.log("Handling re-initialisation of new MapGeoRefField."),this._tryDefaultGeoreferenceFromSurvey(e.survey,!this._value.gridRef);});}_tryDefaultGeoreferenceFromSurvey(e,t){if(this.initialiseFromDefaultSurveyGeoref){let i=e.geoReference;if(console.log({"Default occurrence georef":i}),i&&i.gridRef){t&&(this.mapPositionIsCurrent=!1,this.tryValue(i.gridRef));const e=document.getElementById(this._inputId);e&&(e.placeholder=i.gridRef);}e.addListener(N.EVENT_MODIFIED,()=>{const t=e.geoReference;if(t&&t.gridRef){const e=document.getElementById(this._inputId);e&&(e.placeholder=i.gridRef);}});}}addMapBox(e){let t=e.appendChild(document.createElement("div"));t.id=`map${P.nextId}`,t.className="map-container",de.accessToken="pk.eyJ1IjoiamFwb25pY3VzIiwiYSI6ImNramV1dnRpeTJvNzczMG10c2s3NnZ2bHMifQ.C8BsQepXT6KE-hoQaEerRw",this.map=new de.Map({container:t,style:"mapbox://styles/mapbox/streets-v11",center:[this.defaultLng,this.defaultLat],zoom:this.defaultZoom,cooperativeGestures:!0}),this.map.addControl(new de.NavigationControl({showCompass:!1})),this.map.on("click",e=>{console.log(`A click event has occurred at ${e.lngLat}`),console.log({mapMouseEvent:e});let t=this.map.getZoom();const i=this.reverseZoomMapping(t);i<=this.minResolution&&(this.map.jumpTo({center:[e.lngLat.lng,e.lngLat.lat],zoom:t},null),this.mapPositionIsCurrent=!0,this.processLatLngPosition(e.lngLat.lat,e.lngLat.lng,i,he.GEOREF_SOURCE_MAP));}),this.respondToVisibility(t,e=>{e&&(console.log("Map is visible"),this.map.resize(null));});}zoomMapping(e){return {1:12,10:12,100:11,1e3:10,2e3:10,1e4:8}[e];}reverseZoomMapping(e){return {0:1e5,1:1e5,2:1e5,3:1e5,4:1e5,5:1e5,6:1e5,7:1e4,8:1e4,9:2e3,10:2e3,11:1e3,12:1e3,13:100,14:100,15:10}[Math.round(e)];}respondToVisibility(e,t){if(window.IntersectionObserver){let i={root:document.documentElement};new IntersectionObserver((e,i)=>{e.forEach(e=>{t(e.intersectionRatio>0);});},i).observe(e);}}#N(e){console.log({"geocoded result":e}),this.mapPositionIsCurrent=!1,"gridreference"===e.place_type?(this.value={gridRef:e.place_name,rawString:e.rawString,source:he.GEOREF_SOURCE_GRIDREF,latLng:{lat:e.geometry.coordinates[1],lng:e.geometry.coordinates[0]},precision:e.grid_square_precision},this.fireEvent(P.EVENT_CHANGE)):this.processLatLngPosition(e.center[1],e.center[0],this.baseSquareResolution||1,he.GEOREF_SOURCE_PLACE,e.place_name||"");}tryValue(e){if(e){let t=q.from_string(e);if(t){const e=t.gridCoords.to_latLng(),i=new t.GridCoords(t.gridCoords.x,t.gridCoords.y+t.length).to_latLng(),r=new t.GridCoords(t.gridCoords.x+t.length,t.gridCoords.y+t.length).to_latLng(),n=new t.GridCoords(t.gridCoords.x+t.length,t.gridCoords.y).to_latLng(),o=(e.lat+i.lat+n.lat+r.lat)/4,s=(e.lng+i.lng+n.lng+r.lng)/4;this.mapPositionIsCurrent||(this.map.jumpTo({center:[s,o],zoom:this.zoomMapping(t.length)},null),this.mapPositionIsCurrent=!0),this.setSquareMarker(e,i,r,n,t.preciseGridRef);}else this.hideSquareMarker();}else this.hideSquareMarker();}hideSquareMarker(){this._squareMarker&&this._squareMarker.visible&&(this._squareMarker.removeFromMap(this.map),this._squareMarker=null);}setSquareMarker(e,t,i,r,n=""){this._squareMarker?this._squareMarker.updateCoordinates(this.map,[[[e.lng,e.lat],[t.lng,t.lat],[i.lng,i.lat],[r.lng,r.lat]]],n):(this._squareMarker=new pe({name:n,type:pe.TYPE_POLYGON,coordinates:[[[e.lng,e.lat],[t.lng,t.lat],[i.lng,i.lat],[r.lng,r.lat]]],fillColour:"#008800",fillOpacity:.5,lineColour:"#00aa00"}),this._squareMarker.addToMap(this.map));}}class me extends k{_occurrence;surveyId="";static properties;static sectionTitle="Occurrence form";static help="Records help text, should normally be initialised with an imported html template";constructor(e){if(super(),new.target===me)throw new TypeError("Cannot construct OccurrenceForm instances directly, class should be overridden.");e&&(this.model=e);}get formElement(){console.log({test_constructor:this.constructor});let e=super.formElement;return this._formFieldsBuilt||(this.buildFormFields(),e.addEventListener("change",()=>{console.log("occurrence form change event"),console.log(arguments);},{capture:!1})),e;}buildContentContainer(e){const t=e.appendChild(document.createElement("div"));t.className="card mt-3 ms-0 me-0 mb-3";const i=t.appendChild(document.createElement("div"));return i.className="card-header",i.textContent=me.sectionTitle,this._formContentContainer=t.appendChild(document.createElement("div")),this._formContentContainer.className="card-body",this._formContentContainer;}get occurrenceId(){return this._occurrence?this._occurrence.id:null;}get projectId(){return this._occurrence?this._occurrence.projectId:null;}initialiseFormFields(){const e=this.getFormSectionProperties();this.fields={};for(let t in e)e.hasOwnProperty(t)&&(this.fields[t]=new e[t].field(e[t].attributes));}updateModelFromContent(){console.log("updating occurrence from OccurrenceForm content");for(let e in this.fields)if(this.fields.hasOwnProperty(e)){let t=this.fields[e];this._occurrence.attributes[e]=t.value;}console.log({occurrence:this._occurrence});}set model(e){this._occurrence=e,this.populateFormContent();}get model(){return this._occurrence;}changeHandler(e){console.log("occurrence form change event"),console.log({event:e}),this.fireEvent(k.CHANGE_EVENT,{form:this});}pingOccurrence(){this._occurrence.unsaved()&&this.fireEvent(k.CHANGE_EVENT,{form:this});}destructor(){this._occurrence=null,super.destructor();}getFormSectionProperties(){return me.properties;}setForm(e){return e.addListener(k.CHANGE_EVENT,this.formChangedHandler.bind(this)),this.isNew||(e.liveValidation=!0),e;}setOccurrence(e){this.addListener(k.CHANGE_EVENT,e.formChangedHandler.bind(e)),e.isNew||(this.liveValidation=!0);}}class _e extends k{static sections=[];static sectionsByKey={};_survey;section;constructor(e){super(),this.section=e;}get formElement(){let e=super.formElement;return this._formFieldsBuilt||this.buildFormFields(),e;}updateModelFromContent(){console.log("updating survey from SurveyForm content");for(let e in this.fields)if(this.fields.hasOwnProperty(e)){let t=this.fields[e];this._survey.attributes[e]=t.value;}console.log({survey:this._survey});}set model(e){this._survey=e,this.populateFormContent();}get model(){return this._survey;}changeHandler(e){console.log({"survey form change event":e}),this.fireEvent(k.CHANGE_EVENT,{form:this});}destructor(){super.destructor(),this._survey=null;}static registerSection(e){_e.sections[e.sectionSortOrder]=e,_e.sectionsByKey[e.sectionNavigationKey]=e;}initialiseFormFields(){const e=this.section.properties;this.fields={};for(let t in e)e.hasOwnProperty(t)&&(this.fields[t]=new e[t].field(e[t].attributes));}getFormSectionProperties(){return this.section.properties;}sectionCompletionRequired(){return this.section.completionRequired;}registerSurvey(e){this.model=e,this.addListener(k.CHANGE_EVENT,e.formChangedHandler.bind(e)),this.isNew?(this.fireEvent(k.EVENT_INITIALISE_NEW,{}),this.liveValidation=!1):this.liveValidation=!0;}}class ye extends m{app;surveysMenuId;newSurveyLabel="new survey";newSurveyContent='\x3c!-- begin: templates/newSurveyModal.html --\x3e\r\n<div class="modal fade" id="newsurveymodal" tabindex="-1" role="dialog" aria-labelledby="newsurveymodalTitle" aria-hidden="true">\r\n    <div class="modal-dialog modal-dialog-centered" role="document">\r\n        <div class="modal-content">\r\n            <div class="modal-header">\r\n                <h5 class="modal-title" id="newsurveymodalTitle">Start a new survey?</h5>\r\n                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">\r\n                    <span aria-hidden="true">&times;</span>\r\n                </button>\r\n            </div>\r\n            <div class="modal-body">\r\n                Please confirm that you wish to start a new survey. You only need to do this if you wish to send a set of records from a different locality, otherwise please add more records to your current report.\r\n            </div>\r\n            <div class="modal-footer">\r\n                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Back</button>\r\n                <button type="button" class="btn btn-danger" data-bs-dismiss="modal" id="newsurveymodalconfirmed">New survey</button>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n\x3c!-- end: templates/newSurveyModal.html --\x3e\r\n';static NEW_SURVEY_MODAL_ID="newsurveymodal";static RESET_MODAL_ID="resetmodal";static SAVE_ALL_SUCCESS_MODAL_ID="saveallsuccess";static SAVE_ALL_FAILURE_MODAL_ID="saveallfailure";pathPrefix;constructor(){super(),this.pathPrefix=window.location.pathname.split("/")[1];}setApp(e){this.app=e,e.addListener(M.EVENT_SURVEYS_CHANGED,()=>{this.refreshSurveysMenu();}),navigator.hasOwnProperty("onLine")&&!1===navigator.onLine&&this.addOfflineFlag(),window.addEventListener("online",()=>{document.body.classList.remove("offline"),e.syncAll();}),window.addEventListener("offline",this.addOfflineFlag),this.registerGPSClassMarker();document.getElementById("navbarSupportedContent").addEventListener("click",e=>{const t=e.target;console.log({"nav content click":e}),"A"===t.tagName&&console.log("forced navbar collapse (inactive)");});}addOfflineFlag(){document.body.classList.add("offline");}registerGPSClassMarker(){navigator.geolocation&&D.haveGPSPermissionPromise().then(e=>{e===D.GPS_PERMISSION_GRANTED&&document.body.classList.add("gps-enabled"),D.gpsEventObject.addListener(D.EVENT_GPS_PERMISSION_CHANGE,e=>{e===D.GPS_PERMISSION_GRANTED?document.body.classList.add("gps-enabled"):document.body.classList.remove("gps-enabled");});});}newSurveyModal;resetModal;saveAllSuccessModal;saveAllFailureModal;initialise(){this.refreshSurveysMenu();let t=document.createElement("div");t.innerHTML=this.newSurveyContent,document.body.appendChild(t.getElementsByTagName("div")[0]),t=document.createElement("div"),t.innerHTML='\x3c!-- begin: templates/resetModal.html --\x3e\r\n<div class="modal fade" id="resetmodal" tabindex="-1" role="dialog" aria-labelledby="resetmodalTitle" aria-hidden="true">\r\n    <div class="modal-dialog modal-dialog-centered" role="document">\r\n        <div class="modal-content">\r\n            <div class="modal-header">\r\n                <h5 class="modal-title" id="resetmodalTitle">Reset?</h5>\r\n                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">\r\n                    <span aria-hidden="true">&times;</span>\r\n                </button>\r\n            </div>\r\n            <div class="modal-body">\r\n                Please confirm that you wish to clear out your survey data.\r\n                <p>Warning: any unsaved changes will be lost.</p>\r\n            </div>\r\n            <div class="modal-footer">\r\n                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Back</button>\r\n                <button type="button" class="btn btn-danger" data-bs-dismiss="modal" id="resetmodalconfirmed">Reset</button>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n\x3c!-- end: templates/resetModal.html --\x3e\r\n',document.body.appendChild(t.getElementsByTagName("div")[0]),t=document.createElement("div"),t.innerHTML='\x3c!-- begin: templates/syncSuccessModal.html --\x3e\r\n<div class="modal fade" id="saveallsuccess" tabindex="-1" role="dialog" aria-labelledby="saveallsuccessTitle" aria-hidden="true">\r\n    <div class="modal-dialog modal-dialog-centered" role="document">\r\n        <div class="modal-content">\r\n            <div class="modal-header">\r\n                <h5 class="modal-title" id="saveallsuccessTitle">All records sent</h5>\r\n                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">\r\n                    <span aria-hidden="true">&times;</span>\r\n                </button>\r\n            </div>\r\n            <div class="modal-body">\r\n                Your data has been synchronised with the server.\r\n                <p>Thank you.</p>\r\n            </div>\r\n            <div class="modal-footer">\r\n                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n\x3c!-- end: templates/syncSuccessModal.html --\x3e\r\n',document.body.appendChild(t.getElementsByTagName("div")[0]),t=document.createElement("div"),t.innerHTML='\x3c!-- begin: templates/syncFailureModal.html --\x3e\r\n<div class="modal fade" id="saveallfailure" tabindex="-1" role="dialog" aria-labelledby="saveallfailureTitle" aria-hidden="true">\r\n    <div class="modal-dialog modal-dialog-centered" role="document">\r\n        <div class="modal-content">\r\n            <div class="modal-header">\r\n                <h5 class="modal-title" id="saveallfailureTitle">One or more records could not be saved</h5>\r\n                <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">\r\n                    <span aria-hidden="true">&times;</span>\r\n                </button>\r\n            </div>\r\n            <div class="modal-body">\r\n                Please check your connection to the network and try again.\r\n            </div>\r\n            <div class="modal-footer">\r\n                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n\x3c!-- end: templates/syncFailureModal.html --\x3e\r\n',document.body.appendChild(t.getElementsByTagName("div")[0]),this.newSurveyModal=e.getOrCreateInstance(document.getElementById(ye.NEW_SURVEY_MODAL_ID),{}),this.resetModal=e.getOrCreateInstance(document.getElementById(ye.RESET_MODAL_ID),{}),this.saveAllSuccessModal=e.getOrCreateInstance(document.getElementById(ye.SAVE_ALL_SUCCESS_MODAL_ID),{}),this.saveAllFailureModal=e.getOrCreateInstance(document.getElementById(ye.SAVE_ALL_FAILURE_MODAL_ID),{}),document.getElementById(`${ye.NEW_SURVEY_MODAL_ID}confirmed`).addEventListener("click",e=>{e.stopPropagation(),e.preventDefault(),e.detail<2&&(this.newSurveyModal.hide(),this.app.fireEvent(M.EVENT_ADD_SURVEY_USER_REQUEST));}),document.getElementById(`${ye.RESET_MODAL_ID}confirmed`).addEventListener("click",e=>{e.stopPropagation(),e.preventDefault(),e.detail<2&&(this.resetModal.hide(),this.app.fireEvent(M.EVENT_RESET_SURVEYS));});}refreshSurveysMenu(){const e=document.getElementById(this.surveysMenuId),t=this.getSurveyItems();e.innerHTML=`<a class="dropdown-item" href="/${this.pathPrefix}/survey/save" data-navigo="survey/save">save all</a>\n    <div class="dropdown-divider"></div>\n    ${t.join("")}\n    <div class="dropdown-divider"></div>\n    <a class="dropdown-item" href="/${this.pathPrefix}/survey/new" data-navigo="survey/new">${this.newSurveyLabel}</a>\n    <a class="dropdown-item" href="/${this.pathPrefix}/survey/reset" data-navigo="survey/reset">reset</a>`,this.app.router.updatePageLinks();}getSurveyItems(){const e=[],t=this.app.currentSurvey?this.app.currentSurvey.id:null;for(const i of this.app.surveys){const r=i[1].generateSurveyName()+(i[0]===t?' <span style="color: green">â</span>':"");e[e.length]=`<a class="dropdown-item" href="/${this.pathPrefix}/survey/add/${i[0]}" data-navigo="survey/add/${i[0]}">${r}</a>`;}return e;}}class xe extends m{controller;initialise(){}display(){console.log("got to view display"),this.refreshHeader(),this.body();}refreshHeader(){}body(){}accordionItem(e){let t=document.createElement("div");t.id=e.cardId,t.className="accordion-item";let i=t.appendChild(document.createElement("div"));i.className="accordion-header pointer",e.cardHeadingId&&(i.id=e.cardHeadingId);let r=i.appendChild(document.createElement("h2"));r.className="mb-0";let n=r.appendChild(document.createElement("button"));if(n.className="accordion-button"+(e.collapsed?" collapsed":""),n.setAttribute("data-bs-toggle","collapse"),e.headingButtonId&&(n.id=e.headingButtonId),n.type="button",e.buttonStyleString&&(n.style.cssText=e.buttonStyleString),e.cardDescriptionId&&(n.setAttribute("data-bs-target",`#${e.cardDescriptionId}`),n.setAttribute("aria-controls",e.cardDescriptionId)),n.setAttribute("aria-expanded",e.collapsed?"false":"true"),n.innerHTML=`<div class="material-icons icon-show-collapsed">expand_more</div><div class="material-icons icon-hide-collapsed">unfold_less</div>${e.headingHTML}`,e.headingNonbuttonHTML){const t=n.appendChild(document.createElement("span"));t.style.display="flex",t.innerHTML=e.headingNonbuttonHTML;}if(e.headingValidationWarningHTML){const t=i.appendChild(document.createElement("div"));t.className="card-invalid-feedback",t.innerHTML=`<small>${e.headingValidationWarningHTML}</small>`;}let o=t.appendChild(document.createElement("div"));if(e.cardDescriptionId&&(o.id=e.cardDescriptionId),o.className="accordion-collapse collapse"+(e.collapsed?"":" show"),e.cardHeadingId&&o.setAttribute("aria-labelledby",e.cardHeadingId),o.setAttribute("data-bs-parent",`#${e.parentContainerId}`),e.dataAttributes)for(let t in e.dataAttributes)e.dataAttributes.hasOwnProperty(t)&&o.setAttribute(`data-${t}`,e.dataAttributes[t]);let s=o.appendChild(document.createElement("div"));return s.className="accordion-body ps-2 pe-2 ps-md-3 pe-md-3",s.appendChild(e.bodyContentElement),t;}card(e){let t=document.createElement("div");t.id=e.cardId,t.className="card";let i=t.appendChild(document.createElement("div"));i.className="card-header pointer",e.cardHeadingId&&(i.id=e.cardHeadingId),i.setAttribute("data-bs-toggle","collapse"),i.setAttribute("data-bs-target",`#${e.cardDescriptionId}`);let r=i.appendChild(document.createElement("h2"));r.className="mb-0";let n=r.appendChild(document.createElement("button"));if(n.className="btn btn-link"+(e.collapsed?" collapsed":""),e.headingButtonId&&(n.id=e.headingButtonId),n.type="button",n.setAttribute("data-bs-toggle","collapse"),e.buttonStyleString&&(n.style.cssText=e.buttonStyleString),e.cardDescriptionId&&(n.setAttribute("data-bs-target",`#${e.cardDescriptionId}`),n.setAttribute("aria-controls",e.cardDescriptionId)),n.setAttribute("aria-expanded",e.collapsed?"false":"true"),n.innerHTML=`<div class="material-icons icon-show-collapsed">expand_more</div><div class="material-icons icon-hide-collapsed">unfold_less</div>${e.headingHTML}`,e.headingNonbuttonHTML){const t=r.appendChild(document.createElement("span"));t.style.display="inline-block",t.innerHTML=e.headingNonbuttonHTML;}if(e.headingValidationWarningHTML){const t=i.appendChild(document.createElement("div"));t.className="card-invalid-feedback",t.innerHTML=`<small>${e.headingValidationWarningHTML}</small>`;}let o=t.appendChild(document.createElement("div"));if(e.cardDescriptionId&&(o.id=e.cardDescriptionId),o.className="collapse"+(e.collapsed?"":" show"),e.cardHeadingId&&o.setAttribute("aria-labelledby",e.cardHeadingId),o.setAttribute("data-parent",`#${e.parentContainerId}`),e.dataAttributes)for(let t in e.dataAttributes)e.dataAttributes.hasOwnProperty(t)&&o.setAttribute(`data-${t}`,e.dataAttributes[t]);let s=o.appendChild(document.createElement("div"));return s.className="card-body ps-2 pe-2 ps-md-3 pe-md-3",s.appendChild(e.bodyContentElement),t;}}class ve extends xe{content="<p>Placeholder survey picker content.</p>";body(){document.getElementById("body").innerHTML=this.content;}showSaveAllSuccess(){e.getOrCreateInstance(ye.SAVE_ALL_SUCCESS_MODAL_ID).show();}showSaveAllFailure(){e.getOrCreateInstance(ye.SAVE_ALL_FAILURE_MODAL_ID).show();}showResetDialog(){e.getOrCreateInstance(ye.RESET_MODAL_ID).show();}newSurveyDialog(){e.getOrCreateInstance(ye.NEW_SURVEY_MODAL_ID).show();}}

  var _currentOccurrenceId = /*#__PURE__*/new WeakMap();

  var MainController = /*#__PURE__*/function (_AppController) {
    _inherits(MainController, _AppController);

    var _super = _createSuper(MainController);

    /**
     *
     * @param {MainView} view
     */
    function MainController(view) {
      var _this;

      _classCallCheck(this, MainController);

      _this = _super.call(this);

      _defineProperty(_assertThisInitialized(_this), "route", '/list/:action/:id');

      _defineProperty(_assertThisInitialized(_this), "title", 'BSBI New Year Plant Hunt homepage');

      _defineProperty(_assertThisInitialized(_this), "app", void 0);

      _defineProperty(_assertThisInitialized(_this), "view", void 0);

      _classPrivateFieldInitSpec(_assertThisInitialized(_this), _currentOccurrenceId, {
        writable: true,
        value: ''
      });

      _defineProperty(_assertThisInitialized(_this), "needsFullRefresh", true);

      _defineProperty(_assertThisInitialized(_this), "needRightPanelRefresh", true);

      _defineProperty(_assertThisInitialized(_this), "viewSubcontext", '');

      _defineProperty(_assertThisInitialized(_this), "surveySection", void 0);

      _defineProperty(_assertThisInitialized(_this), "leftPanelBaseRoute", '');

      _defineProperty(_assertThisInitialized(_this), "viewContexts", {
        /**
         * @this {MainController}
         * @param {({[id] : string}|null)} queryParameters
         */
        record: function record(queryParameters) {
          // if (queryParameters && queryParameters.id) {
          //     console.log(`in record id ${queryParameters.id}`);
          // }
          // console.log({scope: this});
          this.surveySection = null; // No current survey form section, all should be closed

          if (!queryParameters) {
            // query parameters can be missing
            // force a refresh as it cheap to refresh static content and more difficult to detect
            // if strictly needed.
            // May have reached this point following deletion of the current record.
            this.currentOccurrenceId = '';
            this.needRightPanelRefresh = true;
          } else if (_classPrivateFieldGet(this, _currentOccurrenceId) !== queryParameters.id) {
            this.needRightPanelRefresh = true;
            this.currentOccurrenceId = queryParameters.id ? queryParameters.id : '';
          } else {
            this.needRightPanelRefresh = false;
          }

          this.leftPanelBaseRoute = '/list/record';
        },

        /**
         * @this {MainController}
         * @param {{[section]: string}} queryParameters
         */
        survey: function survey(queryParameters) {
          console.log("in survey section ".concat(queryParameters.section));
          this.currentOccurrenceId = '';
          this.needRightPanelRefresh = true;
          this.surveySection = queryParameters.section;
          this.leftPanelBaseRoute = "/list/survey/".concat(queryParameters.section);
        }
      });

      _this.view = view;
      view.controller = _assertThisInitialized(_this);
      _this.handle = e$1.nextHandle;
      view.addListener(MainController.EVENT_SELECT_OCCURRENCE, _this.occurrenceSelectionHandler.bind(_assertThisInitialized(_this)));
      view.addListener(MainController.EVENT_SELECT_SURVEY_SECTION, _this.surveyPartSelectionHandler.bind(_assertThisInitialized(_this)));
      view.addListener(MainController.EVENT_NEW_RECORD, _this.newRecordHandler.bind(_assertThisInitialized(_this)));
      view.addListener(MainController.EVENT_DELETE_OCCURRENCE, _this.deleteOccurrenceHandler.bind(_assertThisInitialized(_this)));
      view.addListener(MainController.EVENT_BACK, _this.backHandler.bind(_assertThisInitialized(_this)));
      view.addListener(MainController.EVENT_NEXT_TO_RECORDS, _this.nextTransitionToRecordsHandler.bind(_assertThisInitialized(_this)));
      return _this;
    }
    /**
     * handler for event fired on and by view when 'next section' button has been click, leading to the records section
     * this will expand the list of records, or if none exist, add a first one and open it
     */


    _createClass(MainController, [{
      key: "occurrences",
      get:
      /**
       * event fired on and by view when 'next section' button has been click, leading to the records section
       * this will expand the list of records, or if none exist, add a first one and open it
       *
       * @type {string}
       */

      /**
       * @type {NyphApp}
       */

      /**
       *
       * @type {MainView}
       */

      /**
       * @type {string}
       */

      /**
       * set if the view needs full layout rendering
       * @todo this should possibly be a view rather than controller property
       * @type {boolean}
       */

      /**
       * set if the currently displayed occurrence needs revision
       * @todo this should possibly be a view rather than controller property
       * @type {boolean}
       */

      /**
       *
       * @type {string}
       */

      /**
       * Currently displayed survey subsection
       *
       * @type {string|null}
       */

      /**
       * this is the route that the 'back button' in a right-hand panel view should resolve to
       * @type {string}
       */

      /**
       * ultimately this getter might be the point at which to apply filters
       *
       * @returns {Map.<string,Occurrence>}
       */
      function get() {
        return this.app.occurrences;
      }
      /**
       *
       * @returns {null|Occurrence}
       */

    }, {
      key: "currentOccurrence",
      get: function get() {
        if (_classPrivateFieldGet(this, _currentOccurrenceId)) {
          if (this.app.occurrences.has(_classPrivateFieldGet(this, _currentOccurrenceId))) {
            return this.app.occurrences.get(_classPrivateFieldGet(this, _currentOccurrenceId));
          } else {
            throw new t$1("Record id '".concat(_classPrivateFieldGet(this, _currentOccurrenceId), "' was not found."));
          }
        } else {
          return null;
        }
      }
      /**
       *
       * @returns {string}
       */

    }, {
      key: "currentOccurrenceId",
      get: function get() {
        return _classPrivateFieldGet(this, _currentOccurrenceId);
      }
      /**
       *
       * @param {string} occurrenceId
       */
      ,
      set: function set(occurrenceId) {
        // if (this.#currentOccurrenceId && this.#currentOccurrenceId !== occurrenceId) {
        //     if (this.#currentOccurrenceModifiedEventHandle) {
        //         this.#currentOccurrenceModifiedEventHandle = this.currentOccurrence.removeListener(Occurrence.EVENT_MODIFIED, this.#currentOccurrenceModifiedEventHandle);
        //     }
        // }
        _classPrivateFieldSet(this, _currentOccurrenceId, occurrenceId); // if (occurrenceId) {
        //     this.#currentOccurrenceModifiedEventHandle = this.currentOccurrence.addListener(Occurrence.EVENT_MODIFIED, this.currentOccurrenceModifiedHandler.bind(this));
        // }

      }
      /**
       *
       * @returns {Survey}
       */

    }, {
      key: "survey",
      get: function get() {
        return this.app.currentSurvey;
      }
    }, {
      key: "nextTransitionToRecordsHandler",
      value: function nextTransitionToRecordsHandler() {
        console.log('in nextTransitionToRecordsHandler()');

        if (this.app.haveExtantOccurrences()) {
          this.app.router.navigate('/list/record/');
        } else {
          this.newRecordHandler();
        }
      }
      /**
       *
       * @param {{occurrenceId : string}} parameters
       */

    }, {
      key: "deleteOccurrenceHandler",
      value: function deleteOccurrenceHandler(parameters) {
        console.log({
          deleting: parameters.occurrenceId
        });
        var occurrence = this.app.occurrences.get(parameters.occurrenceId);

        if (!occurrence) {
          throw new p$1("Occurrence id '".concat(parameters.occurrenceId, "' not found when trying to delete."));
        }

        occurrence.delete();

        if (this.currentOccurrenceId === parameters.occurrenceId) {
          this.app.router.navigate("/list/record/");
        }
      }
      /**
       *
       * @param {{sectionKey : string}} params
       */

    }, {
      key: "surveyPartSelectionHandler",
      value: function surveyPartSelectionHandler(params) {
        console.log('In surveyPartSelectionHandler');
        console.log({
          params: params
        });

        if (params.sectionKey === 'record') {
          this.app.router.navigate("/list/record/");
        } else if (params.sectionKey) {
          this.app.router.navigate("/list/survey/".concat(params.sectionKey));
        } else {
          this.app.router.navigate("/list/");
        }
      }
      /**
       * may be invoked directly or in response to the Add New Record event
       * therefore assume that the method receives no event parameters
       */

    }, {
      key: "newRecordHandler",
      value: function newRecordHandler() {
        var occurrence = this.app.addNewOccurrence();
        this.app.router.navigate("/list/record/".concat(occurrence.id));
      }
      /**
       *
       * @param {{occurrenceId : string}} params
       */

    }, {
      key: "occurrenceSelectionHandler",
      value: function occurrenceSelectionHandler(params) {
        console.log({
          'In occurrenceSelectionHandler': {
            params: params
          }
        });

        if (this.currentOccurrenceId && params.occurrenceId && this.currentOccurrenceId === params.occurrenceId) {
          console.log("ignoring spurious navigation event for '".concat(params.occurrenceId, "'"));
        } else {
          this.app.router.navigate("/list/record/".concat(params.occurrenceId));
        }
      }
      /**
       * registers the default route from this.route
       * or alternatively is overridden in a child class
       *
       * @param {PatchedNavigo} router
       */

    }, {
      key: "registerRoute",
      value: function registerRoute(router) {
        router.on('/list', this.mainRouteHandler.bind(this, 'list', '', ''), {
          before: this.beforeRouteHandler ? this.beforeRouteHandler.bind(this) : null,
          after: this.afterRouteHandler ? this.afterRouteHandler.bind(this) : null,
          leave: this.leaveRouteHandler ? this.leaveRouteHandler.bind(this) : null,
          already: this.alreadyRouteHandler ? this.alreadyRouteHandler.bind(this) : null
        });
        router.on('/list/help', this.mainRouteHandler.bind(this, 'list', '', 'help'));
        router.on('/list/record/', this.mainRouteHandler.bind(this, 'list', 'record', ''), {
          before: this.beforeRouteHandler ? this.beforeRouteHandler.bind(this) : null,
          after: this.afterRouteHandler ? this.afterRouteHandler.bind(this) : null,
          leave: this.leaveRouteHandler ? this.leaveRouteHandler.bind(this) : null,
          already: this.alreadyRouteHandler ? this.alreadyRouteHandler.bind(this) : null
        });
        router.on('/list/record/help', this.mainRouteHandler.bind(this, 'list', 'record', 'help'));
        router.on('/list/record/:id', this.mainRouteHandler.bind(this, 'list', 'record', 'form'), {
          before: this.beforeRouteHandler ? this.beforeRouteHandler.bind(this) : null,
          after: this.afterRouteHandler ? this.afterRouteHandler.bind(this) : null,
          leave: this.leaveRouteHandler ? this.leaveRouteHandler.bind(this) : null,
          already: this.alreadyRouteHandler ? this.alreadyRouteHandler.bind(this) : null
        });
        router.on('/list/survey/:section', this.mainRouteHandler.bind(this, 'list', 'survey', ''), {
          before: this.beforeRouteHandler ? this.beforeRouteHandler.bind(this) : null,
          after: this.afterRouteHandler ? this.afterRouteHandler.bind(this) : null,
          leave: this.leaveRouteHandler ? this.leaveRouteHandler.bind(this) : null,
          already: this.alreadyRouteHandler ? this.alreadyRouteHandler.bind(this) : null
        });
        router.on('/list/survey/:section/help', this.mainRouteHandler.bind(this, 'list', 'survey', 'help'));
      }
      /**
       *
       * @param {string} context typically 'list'
       * @param {('record'|'survey')} subcontext record|survey
       * @param {(''|'help')} rhs
       * @param {Object.<string, string>} queryParameters
       */

    }, {
      key: "mainRouteHandler",
      value: function mainRouteHandler(context, subcontext, rhs, queryParameters) {
        console.log("reached special route handler for MainController.js");
        console.log({
          context: context,
          params: subcontext,
          query: queryParameters
        });
        this.app.saveRoute();

        try {
          this.viewSubcontext = subcontext;

          if (subcontext) {
            this.viewContexts[subcontext].call(this, queryParameters);
          }

          if (this.app.currentControllerHandle !== this.handle) {
            // need a complete refresh of the page (the list and any occurrence panel)
            // console.log(`currentControllerHandle = ${this.app.currentControllerHandle}, handle = ${this.handle}`);
            this.needsFullRefresh = true;
            this.needRightPanelRefresh = true;
            this.app.currentControllerHandle = this.handle;
          }

          this.view.panelKey = rhs;
          this.view.display();
          this.needsFullRefresh = false;
        } catch (error) {
          this.error = error;
          console.log({
            error: error
          }); // attempt to carry on regardless to some extent (error should be reported in the view)
          // but wrap in a further try just in case

          try {
            this.needsFullRefresh = true;
            this.view.display();
          } catch (rethrownError) {
            console.log({
              rethrownError: rethrownError
            });
            document.body.innerHTML = "<h2>Sorry, something has gone wrong.</h2><p>Please try <a href=\"https://nyph.bsbi.app/app/\">reloading the page using this link</a>.</p><p>If the issue persists then please report this problem to <a href=\"mailto:nyplanthunt@bsbi.org\">nyplanthunt@bsbi.org</a> quoting the following:</p><p><strong>".concat(rethrownError.message, "</strong></p><p>Browser version: ").concat(navigator.userAgent, "</p><p>App version: 1.0.3.1649239755</p>");
          }
        }
      }
    }, {
      key: "backHandler",
      value: function backHandler() {
        if (this.app.routeHistory.length >= 2 && this.app.routeHistory[this.app.routeHistory.length - 2].url === this.leftPanelBaseRoute) {
          this.app.routeHistory.length -= 1;
          console.log('using standard back navigation');
          window.history.back(); //console.log('fell through back!');
        } else {
          console.log("navigating back using base address '".concat(this.leftPanelBaseRoute, "'"));
          this.app.router.navigate(this.leftPanelBaseRoute);
        }
      }
    }]);

    return MainController;
  }(e$1);

  _defineProperty(MainController, "EVENT_SELECT_OCCURRENCE", 'selectoccurrence');

  _defineProperty(MainController, "EVENT_SELECT_SURVEY_SECTION", 'selectsurveysection');

  _defineProperty(MainController, "EVENT_NEW_RECORD", 'newrecord');

  _defineProperty(MainController, "EVENT_DELETE_OCCURRENCE", 'deleteoccurrence');

  _defineProperty(MainController, "EVENT_BACK", 'back');

  _defineProperty(MainController, "EVENT_NEXT_TO_RECORDS", 'nexttorecords');

  var toString$1 = toString$7;

  var normalizeStringArgument$1 = function (argument, $default) {
    return argument === undefined ? arguments.length < 2 ? '' : $default : toString$1(argument);
  };

  var isObject = isObject$i;
  var createNonEnumerableProperty$1 = createNonEnumerableProperty$8;

  // `InstallErrorCause` abstract operation
  // https://tc39.es/proposal-error-cause/#sec-errorobjects-install-error-cause
  var installErrorCause$1 = function (O, options) {
    if (isObject(options) && 'cause' in options) {
      createNonEnumerableProperty$1(O, 'cause', options.cause);
    }
  };

  var uncurryThis$2 = functionUncurryThis;

  var replace = uncurryThis$2(''.replace);

  var TEST = (function (arg) { return String(Error(arg).stack); })('zxcasd');
  var V8_OR_CHAKRA_STACK_ENTRY = /\n\s*at [^:]*:[^\n]*/;
  var IS_V8_OR_CHAKRA_STACK = V8_OR_CHAKRA_STACK_ENTRY.test(TEST);

  var clearErrorStack$1 = function (stack, dropEntries) {
    if (IS_V8_OR_CHAKRA_STACK && typeof stack == 'string') {
      while (dropEntries--) stack = replace(stack, V8_OR_CHAKRA_STACK_ENTRY, '');
    } return stack;
  };

  var fails$2 = fails$q;
  var createPropertyDescriptor = createPropertyDescriptor$5;

  var errorStackInstallable = !fails$2(function () {
    var error = Error('a');
    if (!('stack' in error)) return true;
    // eslint-disable-next-line es/no-object-defineproperty -- safe
    Object.defineProperty(error, 'stack', createPropertyDescriptor(1, 7));
    return error.stack !== 7;
  });

  var getBuiltIn = getBuiltIn$9;
  var hasOwn = hasOwnProperty_1;
  var createNonEnumerableProperty = createNonEnumerableProperty$8;
  var isPrototypeOf = objectIsPrototypeOf;
  var setPrototypeOf = objectSetPrototypeOf;
  var copyConstructorProperties = copyConstructorProperties$2;
  var inheritIfRequired = inheritIfRequired$2;
  var normalizeStringArgument = normalizeStringArgument$1;
  var installErrorCause = installErrorCause$1;
  var clearErrorStack = clearErrorStack$1;
  var ERROR_STACK_INSTALLABLE = errorStackInstallable;

  var wrapErrorConstructorWithCause$1 = function (FULL_NAME, wrapper, FORCED, IS_AGGREGATE_ERROR) {
    var OPTIONS_POSITION = IS_AGGREGATE_ERROR ? 2 : 1;
    var path = FULL_NAME.split('.');
    var ERROR_NAME = path[path.length - 1];
    var OriginalError = getBuiltIn.apply(null, path);

    if (!OriginalError) return;

    var OriginalErrorPrototype = OriginalError.prototype;

    // V8 9.3- bug https://bugs.chromium.org/p/v8/issues/detail?id=12006
    if (hasOwn(OriginalErrorPrototype, 'cause')) delete OriginalErrorPrototype.cause;

    if (!FORCED) return OriginalError;

    var BaseError = getBuiltIn('Error');

    var WrappedError = wrapper(function (a, b) {
      var message = normalizeStringArgument(IS_AGGREGATE_ERROR ? b : a, undefined);
      var result = IS_AGGREGATE_ERROR ? new OriginalError(a) : new OriginalError();
      if (message !== undefined) createNonEnumerableProperty(result, 'message', message);
      if (ERROR_STACK_INSTALLABLE) createNonEnumerableProperty(result, 'stack', clearErrorStack(result.stack, 2));
      if (this && isPrototypeOf(OriginalErrorPrototype, this)) inheritIfRequired(result, this, WrappedError);
      if (arguments.length > OPTIONS_POSITION) installErrorCause(result, arguments[OPTIONS_POSITION]);
      return result;
    });

    WrappedError.prototype = OriginalErrorPrototype;

    if (ERROR_NAME !== 'Error') {
      if (setPrototypeOf) setPrototypeOf(WrappedError, BaseError);
      else copyConstructorProperties(WrappedError, BaseError, { name: true });
    }

    copyConstructorProperties(WrappedError, OriginalError);

    try {
      // Safari 13- bug: WebAssembly errors does not have a proper `.name`
      if (OriginalErrorPrototype.name !== ERROR_NAME) {
        createNonEnumerableProperty(OriginalErrorPrototype, 'name', ERROR_NAME);
      }
      OriginalErrorPrototype.constructor = WrappedError;
    } catch (error) { /* empty */ }

    return WrappedError;
  };

  /* eslint-disable no-unused-vars -- required for functions `.length` */

  var $$2 = _export;
  var global$1 = global$N;
  var apply = functionApply;
  var wrapErrorConstructorWithCause = wrapErrorConstructorWithCause$1;

  var WEB_ASSEMBLY = 'WebAssembly';
  var WebAssembly = global$1[WEB_ASSEMBLY];

  var FORCED$1 = Error('e', { cause: 7 }).cause !== 7;

  var exportGlobalErrorCauseWrapper = function (ERROR_NAME, wrapper) {
    var O = {};
    O[ERROR_NAME] = wrapErrorConstructorWithCause(ERROR_NAME, wrapper, FORCED$1);
    $$2({ global: true, forced: FORCED$1 }, O);
  };

  var exportWebAssemblyErrorCauseWrapper = function (ERROR_NAME, wrapper) {
    if (WebAssembly && WebAssembly[ERROR_NAME]) {
      var O = {};
      O[ERROR_NAME] = wrapErrorConstructorWithCause(WEB_ASSEMBLY + '.' + ERROR_NAME, wrapper, FORCED$1);
      $$2({ target: WEB_ASSEMBLY, stat: true, forced: FORCED$1 }, O);
    }
  };

  // https://github.com/tc39/proposal-error-cause
  exportGlobalErrorCauseWrapper('Error', function (init) {
    return function Error(message) { return apply(init, this, arguments); };
  });
  exportGlobalErrorCauseWrapper('EvalError', function (init) {
    return function EvalError(message) { return apply(init, this, arguments); };
  });
  exportGlobalErrorCauseWrapper('RangeError', function (init) {
    return function RangeError(message) { return apply(init, this, arguments); };
  });
  exportGlobalErrorCauseWrapper('ReferenceError', function (init) {
    return function ReferenceError(message) { return apply(init, this, arguments); };
  });
  exportGlobalErrorCauseWrapper('SyntaxError', function (init) {
    return function SyntaxError(message) { return apply(init, this, arguments); };
  });
  exportGlobalErrorCauseWrapper('TypeError', function (init) {
    return function TypeError(message) { return apply(init, this, arguments); };
  });
  exportGlobalErrorCauseWrapper('URIError', function (init) {
    return function URIError(message) { return apply(init, this, arguments); };
  });
  exportWebAssemblyErrorCauseWrapper('CompileError', function (init) {
    return function CompileError(message) { return apply(init, this, arguments); };
  });
  exportWebAssemblyErrorCauseWrapper('LinkError', function (init) {
    return function LinkError(message) { return apply(init, this, arguments); };
  });
  exportWebAssemblyErrorCauseWrapper('RuntimeError', function (init) {
    return function RuntimeError(message) { return apply(init, this, arguments); };
  });

  var collection = collection$2;
  var collectionWeak = collectionWeak$2;

  // `WeakSet` constructor
  // https://tc39.es/ecma262/#sec-weakset-constructor
  collection('WeakSet', function (init) {
    return function WeakSet() { return init(this, arguments.length ? arguments[0] : undefined); };
  }, collectionWeak);

  var fails$1 = fails$q;

  var arrayMethodIsStrict$2 = function (METHOD_NAME, argument) {
    var method = [][METHOD_NAME];
    return !!method && fails$1(function () {
      // eslint-disable-next-line no-useless-call,no-throw-literal -- required for testing
      method.call(null, argument || function () { throw 1; }, 1);
    });
  };

  var $$1 = _export;
  var uncurryThis$1 = functionUncurryThis;
  var IndexedObject = indexedObject;
  var toIndexedObject = toIndexedObject$8;
  var arrayMethodIsStrict$1 = arrayMethodIsStrict$2;

  var un$Join = uncurryThis$1([].join);

  var ES3_STRINGS = IndexedObject != Object;
  var STRICT_METHOD$1 = arrayMethodIsStrict$1('join', ',');

  // `Array.prototype.join` method
  // https://tc39.es/ecma262/#sec-array.prototype.join
  $$1({ target: 'Array', proto: true, forced: ES3_STRINGS || !STRICT_METHOD$1 }, {
    join: function join(separator) {
      return un$Join(toIndexedObject(this), separator === undefined ? ',' : separator);
    }
  });

  var arraySlice = arraySliceSimple;

  var floor = Math.floor;

  var mergeSort = function (array, comparefn) {
    var length = array.length;
    var middle = floor(length / 2);
    return length < 8 ? insertionSort(array, comparefn) : merge(
      array,
      mergeSort(arraySlice(array, 0, middle), comparefn),
      mergeSort(arraySlice(array, middle), comparefn),
      comparefn
    );
  };

  var insertionSort = function (array, comparefn) {
    var length = array.length;
    var i = 1;
    var element, j;

    while (i < length) {
      j = i;
      element = array[i];
      while (j && comparefn(array[j - 1], element) > 0) {
        array[j] = array[--j];
      }
      if (j !== i++) array[j] = element;
    } return array;
  };

  var merge = function (array, left, right, comparefn) {
    var llength = left.length;
    var rlength = right.length;
    var lindex = 0;
    var rindex = 0;

    while (lindex < llength || rindex < rlength) {
      array[lindex + rindex] = (lindex < llength && rindex < rlength)
        ? comparefn(left[lindex], right[rindex]) <= 0 ? left[lindex++] : right[rindex++]
        : lindex < llength ? left[lindex++] : right[rindex++];
    } return array;
  };

  var arraySort = mergeSort;

  var userAgent$1 = engineUserAgent;

  var firefox = userAgent$1.match(/firefox\/(\d+)/i);

  var engineFfVersion = !!firefox && +firefox[1];

  var UA = engineUserAgent;

  var engineIsIeOrEdge = /MSIE|Trident/.test(UA);

  var userAgent = engineUserAgent;

  var webkit = userAgent.match(/AppleWebKit\/(\d+)\./);

  var engineWebkitVersion = !!webkit && +webkit[1];

  var $ = _export;
  var uncurryThis = functionUncurryThis;
  var aCallable = aCallable$6;
  var toObject = toObject$5;
  var lengthOfArrayLike = lengthOfArrayLike$7;
  var toString = toString$7;
  var fails = fails$q;
  var internalSort = arraySort;
  var arrayMethodIsStrict = arrayMethodIsStrict$2;
  var FF = engineFfVersion;
  var IE_OR_EDGE = engineIsIeOrEdge;
  var V8 = engineV8Version;
  var WEBKIT = engineWebkitVersion;

  var test = [];
  var un$Sort = uncurryThis(test.sort);
  var push = uncurryThis(test.push);

  // IE8-
  var FAILS_ON_UNDEFINED = fails(function () {
    test.sort(undefined);
  });
  // V8 bug
  var FAILS_ON_NULL = fails(function () {
    test.sort(null);
  });
  // Old WebKit
  var STRICT_METHOD = arrayMethodIsStrict('sort');

  var STABLE_SORT = !fails(function () {
    // feature detection can be too slow, so check engines versions
    if (V8) return V8 < 70;
    if (FF && FF > 3) return;
    if (IE_OR_EDGE) return true;
    if (WEBKIT) return WEBKIT < 603;

    var result = '';
    var code, chr, value, index;

    // generate an array with more 512 elements (Chakra and old V8 fails only in this case)
    for (code = 65; code < 76; code++) {
      chr = String.fromCharCode(code);

      switch (code) {
        case 66: case 69: case 70: case 72: value = 3; break;
        case 68: case 71: value = 4; break;
        default: value = 2;
      }

      for (index = 0; index < 47; index++) {
        test.push({ k: chr + index, v: value });
      }
    }

    test.sort(function (a, b) { return b.v - a.v; });

    for (index = 0; index < test.length; index++) {
      chr = test[index].k.charAt(0);
      if (result.charAt(result.length - 1) !== chr) result += chr;
    }

    return result !== 'DGBEFHACIJK';
  });

  var FORCED = FAILS_ON_UNDEFINED || !FAILS_ON_NULL || !STRICT_METHOD || !STABLE_SORT;

  var getSortCompare = function (comparefn) {
    return function (x, y) {
      if (y === undefined) return -1;
      if (x === undefined) return 1;
      if (comparefn !== undefined) return +comparefn(x, y) || 0;
      return toString(x) > toString(y) ? 1 : -1;
    };
  };

  // `Array.prototype.sort` method
  // https://tc39.es/ecma262/#sec-array.prototype.sort
  $({ target: 'Array', proto: true, forced: FORCED }, {
    sort: function sort(comparefn) {
      if (comparefn !== undefined) aCallable(comparefn);

      var array = toObject(this);

      if (STABLE_SORT) return comparefn === undefined ? un$Sort(array) : un$Sort(array, comparefn);

      var items = [];
      var arrayLength = lengthOfArrayLike(array);
      var itemsLength, index;

      for (index = 0; index < arrayLength; index++) {
        if (index in array) push(items, array[index]);
      }

      internalSort(items, getSortCompare(comparefn));

      itemsLength = items.length;
      index = 0;

      while (index < itemsLength) array[index] = items[index++];
      while (index < arrayLength) delete array[index++];

      return array;
    }
  });

  var htmlLayout = "\r\n<div class=\"container-fluid\">\r\n    <div class=\"row\" style=\"height: 90vh;\">\r\n        <div class=\"col d-md-block pe-md-0 pt-3\" id=\"col1panel\" style=\"overflow-y: auto; max-height: calc(100vh - 5rem);\">\r\n        </div>\r\n        <div class=\"col d-md-none ps-0 pe-0\" id=\"ctrlpanel\" style=\"background-color: aliceblue; width: 28px; max-width: 28px; overflow-y: hidden; \">\r\n            <button class=\"navbar-light navbar-toggler ps-0 pe-0\" type=\"button\" aria-label=\"Back\" id=\"right-panel-back\">\r\n                <i class=\"material-icons-round\" style=\"color: gray;\">arrow_back</i><!-- was view_list -->\r\n            </button>\r\n        </div>\r\n        <div class=\"col d-md-block pe-md-0\" id=\"col2panel\" style=\"overflow-y: auto; height: 100%;\">\r\n        </div>\r\n    </div>\r\n</div>\r\n";

  var welcomeContent = "<!-- begin: templates/welcome.html -->\r\n<p>Help us record the plants that are in bloom over the New Year (from the 1<sup>st</sup> to 4<sup>th</sup> January).</p>\r\n<p>Data collected by New Year Plant Hunters help us understand how our wildflowers are responding to changes in autumn and winter weather patterns.</p>\r\n<p>Each Plant Hunt survey should last no more than three hours, on a single day. If you visit different places or take part on multiple days then you can send as many separate surveys as you like.</p>\r\n<p>To start a new list, or to return to one of your previous lists, please use the 'Your lists' menu at the top of the page.</p>\r\n<p>Have fun and stay safe.</p>\r\n<!-- end: templates/welcome.html -->\r\n";

  var defaultRightHandSideHelp = "<!-- begin: templates/formHelp/surveyAboutHelp.html -->\r\n<h3>Background to the project</h3>\r\n<p></p>\r\n<p>The information that you provide will be used by\r\n    <a href=\"https://bsbi.org/\" target=\"_blank\" title=\"Botanical Society of Britain and Ireland\">BSBI</a> as part of a long-term study looking at changes in plant phenology and distribution. We'll include your plant records in a permanent archive held by BSBI.</p>\r\n<p>To follow up any queries about the survey we request that you please provide your name and email address. You can choose whether or not\r\n    to include your name in our archive of plant records. Your email address will be\r\n    confidential and won't be archived.</p>\r\n<p>A summary of the New Year Plant Hunt surveys will appear on the project website.</p>\r\n<!-- end: templates/formHelp/surveyAboutHelp.html -->\r\n";

  var NyphSurveyFormSection = /*#__PURE__*/_createClass(function NyphSurveyFormSection() {
    _classCallCheck(this, NyphSurveyFormSection);
  });

  _defineProperty(NyphSurveyFormSection, "sectionTitle", void 0);

  _defineProperty(NyphSurveyFormSection, "sectionSortOrder", void 0);

  _defineProperty(NyphSurveyFormSection, "sectionNavigationKey", void 0);

  _defineProperty(NyphSurveyFormSection, "help", '');

  _defineProperty(NyphSurveyFormSection, "properties", void 0);

  var NyphSurveyForm = /*#__PURE__*/function (_SurveyForm) {
    _inherits(NyphSurveyForm, _SurveyForm);

    var _super = _createSuper(NyphSurveyForm);

    function NyphSurveyForm() {
      _classCallCheck(this, NyphSurveyForm);

      return _super.apply(this, arguments);
    }

    _createClass(NyphSurveyForm, null, [{
      key: "registerSection",
      value:
      /**
       * sections keyed by numerical order
       *
       * @type {Array.<typeof NyphSurveyFormSection>}
       */

      /**
       *
       * @type {Object.<string, typeof NyphSurveyFormSection>}
       */
      // /**
      //  * @type {Survey}
      //  */
      // #survey;
      // _formFieldsBuilt = false;
      // /**
      //  * @type {typeof NyphSurveyFormSection}
      //  */
      // section;
      // /**
      //  *
      //  * @param {typeof NyphSurveyFormSection} section
      //  */
      // constructor(section) {
      //     super(section);
      // }
      // /**
      //  *
      //  * @returns {HTMLElement}
      //  */
      // get formElement() {
      //     let el = super.formElement;
      //
      //     if (!this._formFieldsBuilt) {
      //         this.buildFormFields();
      //     }
      //
      //     return el;
      // }
      // updateModelFromContent() {
      //     console.log('updating survey from NyphSurveyForm content');
      //
      //     for (let key in this.fields) {
      //         if (this.fields.hasOwnProperty(key)) {
      //             let field = this.fields[key];
      //
      //             this.#survey.attributes[key] = field.value;
      //         }
      //     }
      //
      //     console.log({survey: this.#survey});
      // }
      // /**
      //  *
      //  * @param {Survey} model
      //  */
      // set model (model) {
      //     this.#survey = model;
      //     this.populateFormContent();
      // }
      // get model() {
      //     return this.#survey;
      // }
      // /**
      //  * the change event triggers after a field has changed, before the value has been read back into the model
      //  *
      //  * @param params
      //  */
      // changeHandler(params) {
      //     console.log('survey form change event');
      //     console.log({params});
      //
      //     this.fireEvent(SurveyForm.CHANGE_EVENT, {form: this});
      // }
      // destructor() {
      //     super.destructor();
      //     this.#survey = null;
      // }

      /**
       *
       * @param {typeof NyphSurveyFormSection} formClass
       */
      function registerSection(formClass) {
        NyphSurveyForm.sections[formClass.sectionSortOrder] = formClass;
        NyphSurveyForm.sectionsByKey[formClass.sectionNavigationKey] = formClass;
      } // /**
      //  *
      //  */
      // initialiseFormFields() {
      //     const properties = this.section.properties;
      //
      //     this.fields = {};
      //
      //     for (let key in properties) {
      //         if (properties.hasOwnProperty(key)) {
      //             // noinspection JSPotentiallyInvalidConstructorUsage
      //             this.fields[key] = new properties[key].field(properties[key].attributes);
      //         }
      //     }
      // }
      // getFormSectionProperties() {
      //     return this.section.properties;
      // }

    }]);

    return NyphSurveyForm;
  }(_e); // NyphSurveyForm.CHANGE_EVENT = 'change';

  _defineProperty(NyphSurveyForm, "sections", []);

  _defineProperty(NyphSurveyForm, "sectionsByKey", {});

  var helpPanelText$1 = "<!-- begin: templates/formHelp/surveyAboutHelp.html -->\r\n<div class=\"card mt-3\">\r\n    <div class=\"card-body\">\r\n        <h5 class=\"card-title\">Localising your records</h5>\r\n        <p class=\"card-text\">To make sense of the national coverage of the records we receive, we need to know the starting point for your survey and, ideally the location for each individual record.\r\n            We also need a place name, as a way to double-check that the postcode or grid-reference makes sense.\r\n        </p>\r\n        <p><strong>Please don't provide your full address, as we would need to remove that from our data.</strong></p>\r\n    </div>\r\n</div>\r\n<div class=\"card mt-3\">\r\n    <div class=\"card-body\">\r\n        <h5 class=\"card-title\">Your name and email</h5>\r\n        <p class=\"card-text\">We need your contact details so that we can email you a link\r\n            to your survey. It is also really useful for our experts to be able to contact you\r\n            if we have questions about the records that you've sent.\r\n        </p>\r\n        <p>You can choose whether to include your name with the records in our archive - we'd like your efforts to be acknowledged properly. Your email address will be treated as confidential and won't be stored long-term,\r\n            after your plant records have been checked.</p>\r\n    </div>\r\n</div>\r\n<!-- end: templates/formHelp/surveyAboutHelp.html -->\r\n";

  var NyphSurveyFormAboutSection = /*#__PURE__*/function (_NyphSurveyFormSectio) {
    _inherits(NyphSurveyFormAboutSection, _NyphSurveyFormSectio);

    var _super = _createSuper(NyphSurveyFormAboutSection);

    function NyphSurveyFormAboutSection() {
      _classCallCheck(this, NyphSurveyFormAboutSection);

      return _super.apply(this, arguments);
    }

    return _createClass(NyphSurveyFormAboutSection);
  }(NyphSurveyFormSection);

  _defineProperty(NyphSurveyFormAboutSection, "sectionNavigationKey", 'about');

  _defineProperty(NyphSurveyFormAboutSection, "sectionTitle", 'Your details');

  _defineProperty(NyphSurveyFormAboutSection, "sectionSortOrder", 0);

  _defineProperty(NyphSurveyFormAboutSection, "help", helpPanelText$1);

  _defineProperty(NyphSurveyFormAboutSection, "completionRequired", true);

  _defineProperty(NyphSurveyFormAboutSection, "properties", {
    recorder: {
      field: V,
      attributes: {
        label: 'Your name',
        helpText: 'This helps us follow-up if we have any queries about your records. If several people are taking part in your Plant Hunt you can list them in the next section.',
        placeholder: 'full name',
        completion: P.COMPLETION_COMPULSORY,
        validationMessage: 'Please provide your name',
        autocomplete: 'name'
      }
    },
    email: {
      field: V,
      validator: V.emailValidator,
      attributes: {
        label: 'Your email address',
        helpText: 'We need to be able to send you an acknowledgement email with a link to view and edit your list.',
        autocomplete: 'email',
        type: 'email',
        completion: P.COMPLETION_COMPULSORY,
        validationMessage: 'Please provide an email address'
      }
    }
  });

  var helpPanelText = "<!-- begin: templates/formHelp/recordsHelp.html -->\r\n<div class=\"card mt-3\">\r\n    <div class=\"card-body\">\r\n        <h5 class=\"card-title\">Using the form</h5>\r\n        <p class=\"card-text\">You can enter as many plant records as you need. To add another record click the 'Add a plant' button.</p>\r\n        <p class=\"card-text\">If you are currently online then the entries will be saved as you go, automatically. Otherwise the records\r\n            will be remembered on your device, but you will need to click '<a href=\"/app/survey/save\" data-navigo=\"survey/save\">save all</a>' (on the <i>Your lists</i> menu) when you have a network connection again.\r\n        </p>\r\n        <p class=\"card-text\">To delete a plant record, find it in the list and click the red 'bin' icon.\r\n        </p>\r\n    </div>\r\n</div>\r\n<div class=\"card mt-3\">\r\n    <div class=\"card-body\">\r\n        <h5 class=\"card-title\">Identifying your plants</h5>\r\n        <h6 class=\"card-subtitle mb-2 text-muted\">Plant names</h6>\r\n        <p class=\"card-text\">If possible, please enter the scientific or common name of the plant, but don't worry if you don't know the full details.\r\n            The list of suggested names includes a very wide range of both native and horticultural plants, but if the name you need\r\n            isn't on the list then you can still type it in.\r\n        </p>\r\n        <p>Remember to record only plants that are in flower. Plants with only buds or seed heads don't count and nor do ferns!</p>\r\n        <p>Please record only flowers growing in wild places. You can include weeds in gardens, lawns or verges, but cultivated plants in or near gardens behave very differently so we'd like to keep them out of our results.</p>\r\n        <h6 class=\"card-subtitle mb-2 text-muted\">Photos</h6>\r\n        <p class=\"card-text\">Photographs of the plant will help us confirm your record. Please provide a picture showing the whole plant, but it will\r\n            also help us if you can provide close-up views of the flowers and leaves.\r\n        </p>\r\n        <p><strong>Please send each of your finds separately.</strong> To analyse your results we need to be able to store a record of each plant. Combining multiple records in a single image, or as text in the comments field creates additional work for our volunteers and may mean that some of your finds are overlooked.</p>\r\n    </div>\r\n</div>\r\n<div class=\"card mt-3\">\r\n    <div class=\"card-body\">\r\n        <h5 class=\"card-title\">Locating your finds</h5>\r\n        <p>If you are using a mobile device in the field then each record should be assigned a GPS-based geo-reference automatically.</p>\r\n        <p>Alternatively you can type a grid-reference (Ordnance Survey or OSI grid-reference) in the grid-reference field or click on the map.</p>\r\n        <p>By default, records will be automatically assigned the location you gave for the survey, so it's not required to enter individual grid-references.</p>\r\n    </div>\r\n</div>\r\n<!-- begin: templates/formHelp/recordsHelp.html -->\r\n";

  var NyphOccurrenceForm = /*#__PURE__*/function (_OccurrenceForm) {
    _inherits(NyphOccurrenceForm, _OccurrenceForm);

    var _super = _createSuper(NyphOccurrenceForm);

    function NyphOccurrenceForm() {
      _classCallCheck(this, NyphOccurrenceForm);

      return _super.apply(this, arguments);
    }

    _createClass(NyphOccurrenceForm, [{
      key: "buildContentContainer",
      value:
      /**
       * @type {string}
       */

      /**
       * @type {string}
       */

      /**
       * sets this._formContentContainer to the container that should contain the form fields
       *
       * if no wrapper then can re-use the outer container id (this.#formEl
       */
      function buildContentContainer(outerContainer) {
        console.log('Building OccurrenceForm content container');
        var cardEl = outerContainer.appendChild(document.createElement('div'));
        cardEl.className = 'card mt-3 ms-0 me-0 mb-3';
        var cardHeaderEl = cardEl.appendChild(document.createElement('div'));
        cardHeaderEl.className = 'card-header';
        cardHeaderEl.textContent = NyphOccurrenceForm.sectionTitle;
        this._formContentContainer = cardEl.appendChild(document.createElement('div'));
        this._formContentContainer.className = 'card-body';
        return this._formContentContainer;
      }
      /**
       *
       * @type {Object.<string,{field: typeof FormField, attributes: {label: string, helpText: string, placeholder: string, autocomplete: string}}>}
       */

    }, {
      key: "getFormSectionProperties",
      value: // /**
      //  *
      //  */
      // initialiseFormFields() {
      //     const properties = NyphOccurrenceForm.properties;
      //
      //     this.fields = {};
      //
      //     for (let key in properties) {
      //         if (properties.hasOwnProperty(key)) {
      //             // noinspection JSPotentiallyInvalidConstructorUsage
      //             this.fields[key] = new properties[key].field(properties[key].attributes);
      //         }
      //     }
      // }
      // initialiseFormFields() {
      //     const properties = this.getFormSectionProperties();
      //
      //     this.fields = {};
      //
      //     for (let key in properties) {
      //         if (properties.hasOwnProperty(key)) {
      //             // noinspection JSPotentiallyInvalidConstructorUsage
      //             this.fields[key] = new properties[key].field(properties[key].attributes);
      //         }
      //     }
      // }
      function getFormSectionProperties() {
        return NyphOccurrenceForm.properties;
      }
    }]);

    return NyphOccurrenceForm;
  }(me); //NyphOccurrenceForm.CHANGE_EVENT = 'change';

  _defineProperty(NyphOccurrenceForm, "sectionTitle", 'Details of plant');

  _defineProperty(NyphOccurrenceForm, "help", helpPanelText);

  _defineProperty(NyphOccurrenceForm, "properties", {
    taxon: {
      field: $$3,
      attributes: {
        label: 'plant name',
        validationMessage: 'Please specify a taxon name or provide some photos if you cannot identify the plant.',
        helpText: 'Type the common or scientific name of the plant and, if possible, pick a suggestion from the list. If you do not know the name of the plant then please leave this blank and include some photos.'
      },

      /**
       *
       * @param {string} key
       * @param {{}} property
       * @param {{}} modelAttributes
       * @return {boolean} true if valid
       */
      validator: function validator(key, property, modelAttributes) {
        if (!(modelAttributes.hasOwnProperty(key) && !property.field.isEmpty(modelAttributes[key]))) {
          // taxon field is empty, check whether there is an image
          return modelAttributes.hasOwnProperty('images') && !B.isEmpty(modelAttributes['images']);
        } else {
          return true;
        }
      }
    },
    images: {
      field: B,
      attributes: {
        label: "(optional) please provide a photo",
        placeholder: 'photos',
        helpText: "If you've not named your find then we'll need a photo. Otherwise, if the plant is unusual or if you are unsure of its identity then photos will help us to check your record.<br><strong>Submitted images remain your property, but you agree to allow us to use the photos under the terms of a <a href=\"#\" title=\"Creative Commons Attribution\" data-bs-toggle=\"modal\" data-bs-target=\"#".concat(B.LICENSE_MODAL, "\">CC BY</a> license.</strong>")
      }
    },
    georef: {
      field: fe,
      attributes: {
        label: 'Grid-reference',
        helpText: '(optional) leave blank to use the overall survey grid-square, use gps, enter a grid-reference or click on the map',
        completion: P.COMPLETION_OPTIONAL,
        // not required as can fall-back to the survey grid-ref
        includeSearchBox: true,
        baseSquareResolution: 1000,
        gpsInitialisationMode: fe.GPS_INITIALISATION_MODE_MOBILE_PERMITTED,
        initialiseFromDefaultSurveyGeoref: true,
        gpsTextLabel: true
      },
      summary: {
        summarise: true
      },
      summarise: function summarise(key, property, modelAttributes) {
        if (modelAttributes.hasOwnProperty(key) && !property.field.isEmpty(modelAttributes[key])) {
          var precision = modelAttributes[key].source === he.GEOREF_SOURCE_GPS && modelAttributes[key].precision ? " &#177;".concat(Math.round(modelAttributes[key].precision / 2), " m") : '';
          return "<span class=\"gridref-summary\">".concat(modelAttributes[key].gridRef, "</span>").concat(modelAttributes[key].source === he.GEOREF_SOURCE_GPS ? "".concat(precision, " [GPS]") : '');
        } else {
          return '';
        }
      }
    },
    // idConfidence : {
    //     field: SelectField,
    //     attributes: {
    //         label: 'How confident are you about your identification of this plant?',
    //         helpText: '',
    //         placeholder : 'please choose an option',
    //         options: {
    //             "1" : {label: "very sure"},
    //             "2" : {label: "not really sure"},
    //             "3" : {label: "could be wrong"}
    //         },
    //         includeOtherFreeText : false,
    //         completion: FormField.COMPLETION_DESIRED,
    //     }},
    // spread : {
    //     field: OptionsField,
    //     attributes: {
    //         label: 'How does the plant spread in your garden?',
    //         helpText: '<i>(tick all that apply)</i>',
    //         options: {
    //             "seeds" : {label: "seeds"},
    //             "roots" : {label: "roots"},
    //             "runners" : {label: "runners"},
    //             "bulbs" : {label: "bulbs"},
    //             "unknown" : {label: "don't know"},
    //             "other" : {label: "other"}
    //         },
    //         includeOtherFreeText : true,
    //         completion: FormField.COMPLETION_DESIRED,
    //     },
    //     summary: {
    //         summaryPrefix: 'Spread by',
    //     }
    // },
    // control : {
    //     field: OptionsField,
    //     attributes: {
    //         label: 'How do you control this plant?',
    //         helpText: '<i>(tick all that apply)</i>',
    //         options: {
    //             "digging" : {label: "digging"},
    //             "pulling" : {label: "pulling"},
    //             "chemical" : {label: "chemical"},
    //             "cutting" : {label: "cutting"},
    //             "mulching" : {label: "mulching"},
    //             "other" : {label: "other"}
    //         },
    //         includeOtherFreeText : true,
    //         completion: FormField.COMPLETION_DESIRED,
    //     },
    //     summary: {
    //         summaryPrefix: 'Controlled by',
    //     }
    //     },
    // disposal : {
    //     field: OptionsField,
    //     attributes: {
    //         label: 'Please tell us how you dispose of this plant?',
    //         helpText: '<i>(tick all that apply)</i>',
    //         options: {
    //             "homecompost" : {label: "home composting"},
    //             "greenwaste" : {label: "green waste"},
    //             "other waste" : {label: "other waste collection"},
    //             "other" : {label: "other"}
    //         },
    //         includeOtherFreeText : true,
    //         completion: FormField.COMPLETION_DESIRED,
    //     },
    //     summary: {
    //         summaryPrefix: 'Disposal by',
    //     }},
    // problemSeverity : {
    //     field: SelectField,
    //     attributes: {
    //         label: 'Which of the following best describes your effort to control the plant?',
    //         placeholder : 'please select a response',
    //         options: {
    //             '1' : {label: 'I don\'t try to control it'},
    //             '2' : {label: 'I try to keep it confined to certain areas.'},
    //             '3' : {label: 'I am trying everything to get rid of it.'},
    //             '4' : {label: 'I have given up trying to control it.'},
    //             '5' : {label: 'I have successfully eradicated the plant.'}
    //         },
    //         includeOtherFreeText : false,
    //         completion: FormField.COMPLETION_DESIRED,
    //     },
    //     summary: {
    //         summaryPrefix: 'Severity:',
    //     }},
    // source : {
    //     field: OptionsField,
    //     attributes: {
    //         label: 'Please tell us how this plant came into your garden?',
    //         helpText: '<i>(tick all that apply)</i>',
    //         options: {
    //             "alreadypresent" : {label: "Was already in the garden"},
    //             "bought" : {label: "Bought the plant"},
    //             "seed" : {label: "Grown from seed"},
    //             "someoneelse" : {label: "From someone else's garden"},
    //             "saleswap" : {label: "Non-commercial sale/swap"},
    //             "spread" : {label: "Spread into my garden"},
    //             "other" : {label: "other"}
    //         },
    //         includeOtherFreeText : true,
    //         completion: FormField.COMPLETION_DESIRED,
    //     },
    //     summary: {
    //         summaryPrefix: 'Source',
    //     }},
    // yearsSincePlanted: {
    //     field: InputField,
    //     attributes: {
    //         label: 'How long ago did you plant (years)?',
    //         type: 'number',
    //         helpText: 'Please estimate in years or leave blank if unknown or not applicable',
    //         autocomplete: 'off',
    //     }},
    // yearsProblem: {
    //     field: InputField,
    //     attributes: {
    //         label: 'How quickly did this plant become a problem?',
    //         placeholder: 'number of years',
    //         type: 'number',
    //         helpText: 'Please estimate in years or leave blank if unknown',
    //         autocomplete: 'off',
    //     }},
    // distribution: {
    //     field: OptionsField,
    //     attributes: {
    //         label: 'Have you given the plant away to others?',
    //         helpText: '<i>(tick all that apply)</i>',
    //         options: {
    //             "neighbours" : {label: "Neighbours"},
    //             "sale" : {label: "Plant/charity sale"},
    //             "swap" : {label: "Plant or seed swap"},
    //             "localfriends" : {label: "Local friends"},
    //             "distantfriends" : {label: "Friends further away"},
    //             "other" : {label: "other"}
    //         },
    //         includeOtherFreeText : true
    //     }},
    // local : {
    //     field: SelectField,
    //     attributes: {
    //         label: 'Is the plant growing locally outside your garden?',
    //         //helpText: '(estimate)',
    //         placeholder : 'please select a response',
    //         options: {
    //             'yes' : {label: 'yes'},
    //             'no' : {label: 'no'},
    //             'notknown' : {label: "I don't know"}
    //         },
    //         includeOtherFreeText : false
    //     }},
    // warning : {
    //     field: SelectField,
    //     attributes: {
    //         label: 'In your opinion, should the plant be sold with a label ' +
    //             'warning buyers of potential control difficulties in their garden?',
    //         placeholder : 'please select a response',
    //         options: {
    //             'yes' : {label: 'Yes', summary: 'Plants should carry a warning'},
    //             'no' : {label: 'No', summary: 'Plants need not carry a warning'},
    //             'unsure' : {label: "Don't know", summary: "Don't know if plants should carry a warning"}
    //         },
    //         includeOtherFreeText : false,
    //         completion: FormField.COMPLETION_DESIRED,
    //     },
    //     summary: {
    //         summarise: true,
    //         summaryPrefix: ''
    //     }},
    comments: {
      field: H,
      attributes: {
        label: 'Any other comments about this plant?',
        helpText: '',
        autocomplete: 'off'
      },
      summary: {
        summarise: true
      }
    }
  });

  var NyphSurveyFormSurveySection = /*#__PURE__*/function (_NyphSurveyFormSectio) {
    _inherits(NyphSurveyFormSurveySection, _NyphSurveyFormSectio);

    var _super = _createSuper(NyphSurveyFormSurveySection);

    function NyphSurveyFormSurveySection() {
      _classCallCheck(this, NyphSurveyFormSurveySection);

      return _super.apply(this, arguments);
    }

    return _createClass(NyphSurveyFormSurveySection);
  }(NyphSurveyFormSection);

  _defineProperty(NyphSurveyFormSurveySection, "sectionNavigationKey", 'yoursurvey');

  _defineProperty(NyphSurveyFormSurveySection, "sectionTitle", 'Your plant hunt');

  _defineProperty(NyphSurveyFormSurveySection, "sectionSortOrder", 1);

  _defineProperty(NyphSurveyFormSurveySection, "help", helpPanelText$1);

  _defineProperty(NyphSurveyFormSurveySection, "completionRequired", true);

  _defineProperty(NyphSurveyFormSurveySection, "properties", {
    place: {
      field: V,
      attributes: {
        label: 'Where did you survey?',
        helpText: 'e.g. town or village. Please don\'t give an address.',
        placeholder: 'Nearest named place',
        autocomplete: 'address-level2',
        completion: P.COMPLETION_COMPULSORY
      }
    },
    georef: {
      field: fe,
      attributes: {
        label: 'Starting point of your walk.',
        helpText: 'Enter a grid-reference, search by place name or postcode or use the GPS button',
        placeholder: 'Grid-reference, place or postcode',
        completion: P.COMPLETION_COMPULSORY,
        validationMessage: 'Please specify an approximate starting point for the survey. You can do this by typing a grid-reference, clicking the GPS button, selecting a place from the drop-down list or by clicking on the map.',
        includeSearchBox: true,
        baseSquareResolution: 2000,
        // resolution to use for geocoded lookups
        gpsTextLabel: true,
        gpsInitialisationMode: fe.GPS_INITIALISATION_MODE_PERMITTED
      }
    },
    date: {
      field: L,
      attributes: {
        label: 'Date',
        helpText: 'When did you survey? <strong>Please start a new list if you explore for a second day.</strong>',
        placeholder: 'date',
        type: 'date',
        completion: P.COMPLETION_COMPULSORY,
        minDate: '2021-12-01',
        maxDate: '2022-01-04'
      }
    },
    people: {
      field: V,
      attributes: {
        label: 'Who is taking part',
        helpText: "(optional) Please list everyone who is taking part - we'd like to be able to acknowledge your efforts.",
        placeholder: 'Name(s)',
        completion: P.COMPLETION_OPTIONAL,
        autocomplete: 'name'
      }
    },
    numberofrecorders: {
      field: V,
      attributes: {
        label: 'How many people in your party?',
        helpText: "(optional) It helps us with funding and publicity to know participation across the whole country.",
        placeholder: '',
        type: 'number'
      }
    },
    namearchive: {
      field: j,
      attributes: {
        label: 'Can we include your name in our archive of plant records?',
        helpText: '',
        placeholder: 'please choose an option',
        options: {
          "yes": {
            label: "yes"
          },
          "no": {
            label: "no, I'd prefer my records to be anonymous"
          }
        },
        includeOtherFreeText: false,
        completion: P.COMPLETION_COMPULSORY
      }
    },
    listname: {
      field: V,
      attributes: {
        label: 'Expedition title?',
        helpText: '(optional) how we should label your list on the results page',
        placeholder: '',
        autocomplete: '',
        completion: P.COMPLETION_OPTIONAL
      }
    },
    comments: {
      field: H,
      attributes: {
        label: 'Any other notes about your plant hunt',
        helpText: "(optional) You could describe the route or mention exceptional finds. Comments here will appear on the public website. We'll email you a separate feedback form at the end.",
        autocomplete: 'off'
      },
      summary: {
        summarise: true
      }
    }
  });

  var modal = {exports: {}};

  var eventHandler = {exports: {}};

  /*!
    * Bootstrap event-handler.js v5.1.3 (https://getbootstrap.com/)
    * Copyright 2011-2021 The Bootstrap Authors (https://github.com/twbs/bootstrap/graphs/contributors)
    * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
    */

  (function (module, exports) {
  (function (global, factory) {
    module.exports = factory() ;
  })(commonjsGlobal, (function () {
    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): util/index.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */

    const getjQuery = () => {
      const {
        jQuery
      } = window;

      if (jQuery && !document.body.hasAttribute('data-bs-no-jquery')) {
        return jQuery;
      }

      return null;
    };

    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): dom/event-handler.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */
    /**
     * ------------------------------------------------------------------------
     * Constants
     * ------------------------------------------------------------------------
     */

    const namespaceRegex = /[^.]*(?=\..*)\.|.*/;
    const stripNameRegex = /\..*/;
    const stripUidRegex = /::\d+$/;
    const eventRegistry = {}; // Events storage

    let uidEvent = 1;
    const customEvents = {
      mouseenter: 'mouseover',
      mouseleave: 'mouseout'
    };
    const customEventsRegex = /^(mouseenter|mouseleave)/i;
    const nativeEvents = new Set(['click', 'dblclick', 'mouseup', 'mousedown', 'contextmenu', 'mousewheel', 'DOMMouseScroll', 'mouseover', 'mouseout', 'mousemove', 'selectstart', 'selectend', 'keydown', 'keypress', 'keyup', 'orientationchange', 'touchstart', 'touchmove', 'touchend', 'touchcancel', 'pointerdown', 'pointermove', 'pointerup', 'pointerleave', 'pointercancel', 'gesturestart', 'gesturechange', 'gestureend', 'focus', 'blur', 'change', 'reset', 'select', 'submit', 'focusin', 'focusout', 'load', 'unload', 'beforeunload', 'resize', 'move', 'DOMContentLoaded', 'readystatechange', 'error', 'abort', 'scroll']);
    /**
     * ------------------------------------------------------------------------
     * Private methods
     * ------------------------------------------------------------------------
     */

    function getUidEvent(element, uid) {
      return uid && `${uid}::${uidEvent++}` || element.uidEvent || uidEvent++;
    }

    function getEvent(element) {
      const uid = getUidEvent(element);
      element.uidEvent = uid;
      eventRegistry[uid] = eventRegistry[uid] || {};
      return eventRegistry[uid];
    }

    function bootstrapHandler(element, fn) {
      return function handler(event) {
        event.delegateTarget = element;

        if (handler.oneOff) {
          EventHandler.off(element, event.type, fn);
        }

        return fn.apply(element, [event]);
      };
    }

    function bootstrapDelegationHandler(element, selector, fn) {
      return function handler(event) {
        const domElements = element.querySelectorAll(selector);

        for (let {
          target
        } = event; target && target !== this; target = target.parentNode) {
          for (let i = domElements.length; i--;) {
            if (domElements[i] === target) {
              event.delegateTarget = target;

              if (handler.oneOff) {
                EventHandler.off(element, event.type, selector, fn);
              }

              return fn.apply(target, [event]);
            }
          }
        } // To please ESLint


        return null;
      };
    }

    function findHandler(events, handler, delegationSelector = null) {
      const uidEventList = Object.keys(events);

      for (let i = 0, len = uidEventList.length; i < len; i++) {
        const event = events[uidEventList[i]];

        if (event.originalHandler === handler && event.delegationSelector === delegationSelector) {
          return event;
        }
      }

      return null;
    }

    function normalizeParams(originalTypeEvent, handler, delegationFn) {
      const delegation = typeof handler === 'string';
      const originalHandler = delegation ? delegationFn : handler;
      let typeEvent = getTypeEvent(originalTypeEvent);
      const isNative = nativeEvents.has(typeEvent);

      if (!isNative) {
        typeEvent = originalTypeEvent;
      }

      return [delegation, originalHandler, typeEvent];
    }

    function addHandler(element, originalTypeEvent, handler, delegationFn, oneOff) {
      if (typeof originalTypeEvent !== 'string' || !element) {
        return;
      }

      if (!handler) {
        handler = delegationFn;
        delegationFn = null;
      } // in case of mouseenter or mouseleave wrap the handler within a function that checks for its DOM position
      // this prevents the handler from being dispatched the same way as mouseover or mouseout does


      if (customEventsRegex.test(originalTypeEvent)) {
        const wrapFn = fn => {
          return function (event) {
            if (!event.relatedTarget || event.relatedTarget !== event.delegateTarget && !event.delegateTarget.contains(event.relatedTarget)) {
              return fn.call(this, event);
            }
          };
        };

        if (delegationFn) {
          delegationFn = wrapFn(delegationFn);
        } else {
          handler = wrapFn(handler);
        }
      }

      const [delegation, originalHandler, typeEvent] = normalizeParams(originalTypeEvent, handler, delegationFn);
      const events = getEvent(element);
      const handlers = events[typeEvent] || (events[typeEvent] = {});
      const previousFn = findHandler(handlers, originalHandler, delegation ? handler : null);

      if (previousFn) {
        previousFn.oneOff = previousFn.oneOff && oneOff;
        return;
      }

      const uid = getUidEvent(originalHandler, originalTypeEvent.replace(namespaceRegex, ''));
      const fn = delegation ? bootstrapDelegationHandler(element, handler, delegationFn) : bootstrapHandler(element, handler);
      fn.delegationSelector = delegation ? handler : null;
      fn.originalHandler = originalHandler;
      fn.oneOff = oneOff;
      fn.uidEvent = uid;
      handlers[uid] = fn;
      element.addEventListener(typeEvent, fn, delegation);
    }

    function removeHandler(element, events, typeEvent, handler, delegationSelector) {
      const fn = findHandler(events[typeEvent], handler, delegationSelector);

      if (!fn) {
        return;
      }

      element.removeEventListener(typeEvent, fn, Boolean(delegationSelector));
      delete events[typeEvent][fn.uidEvent];
    }

    function removeNamespacedHandlers(element, events, typeEvent, namespace) {
      const storeElementEvent = events[typeEvent] || {};
      Object.keys(storeElementEvent).forEach(handlerKey => {
        if (handlerKey.includes(namespace)) {
          const event = storeElementEvent[handlerKey];
          removeHandler(element, events, typeEvent, event.originalHandler, event.delegationSelector);
        }
      });
    }

    function getTypeEvent(event) {
      // allow to get the native events from namespaced events ('click.bs.button' --> 'click')
      event = event.replace(stripNameRegex, '');
      return customEvents[event] || event;
    }

    const EventHandler = {
      on(element, event, handler, delegationFn) {
        addHandler(element, event, handler, delegationFn, false);
      },

      one(element, event, handler, delegationFn) {
        addHandler(element, event, handler, delegationFn, true);
      },

      off(element, originalTypeEvent, handler, delegationFn) {
        if (typeof originalTypeEvent !== 'string' || !element) {
          return;
        }

        const [delegation, originalHandler, typeEvent] = normalizeParams(originalTypeEvent, handler, delegationFn);
        const inNamespace = typeEvent !== originalTypeEvent;
        const events = getEvent(element);
        const isNamespace = originalTypeEvent.startsWith('.');

        if (typeof originalHandler !== 'undefined') {
          // Simplest case: handler is passed, remove that listener ONLY.
          if (!events || !events[typeEvent]) {
            return;
          }

          removeHandler(element, events, typeEvent, originalHandler, delegation ? handler : null);
          return;
        }

        if (isNamespace) {
          Object.keys(events).forEach(elementEvent => {
            removeNamespacedHandlers(element, events, elementEvent, originalTypeEvent.slice(1));
          });
        }

        const storeElementEvent = events[typeEvent] || {};
        Object.keys(storeElementEvent).forEach(keyHandlers => {
          const handlerKey = keyHandlers.replace(stripUidRegex, '');

          if (!inNamespace || originalTypeEvent.includes(handlerKey)) {
            const event = storeElementEvent[keyHandlers];
            removeHandler(element, events, typeEvent, event.originalHandler, event.delegationSelector);
          }
        });
      },

      trigger(element, event, args) {
        if (typeof event !== 'string' || !element) {
          return null;
        }

        const $ = getjQuery();
        const typeEvent = getTypeEvent(event);
        const inNamespace = event !== typeEvent;
        const isNative = nativeEvents.has(typeEvent);
        let jQueryEvent;
        let bubbles = true;
        let nativeDispatch = true;
        let defaultPrevented = false;
        let evt = null;

        if (inNamespace && $) {
          jQueryEvent = $.Event(event, args);
          $(element).trigger(jQueryEvent);
          bubbles = !jQueryEvent.isPropagationStopped();
          nativeDispatch = !jQueryEvent.isImmediatePropagationStopped();
          defaultPrevented = jQueryEvent.isDefaultPrevented();
        }

        if (isNative) {
          evt = document.createEvent('HTMLEvents');
          evt.initEvent(typeEvent, bubbles, true);
        } else {
          evt = new CustomEvent(event, {
            bubbles,
            cancelable: true
          });
        } // merge custom information in our event


        if (typeof args !== 'undefined') {
          Object.keys(args).forEach(key => {
            Object.defineProperty(evt, key, {
              get() {
                return args[key];
              }

            });
          });
        }

        if (defaultPrevented) {
          evt.preventDefault();
        }

        if (nativeDispatch) {
          element.dispatchEvent(evt);
        }

        if (evt.defaultPrevented && typeof jQueryEvent !== 'undefined') {
          jQueryEvent.preventDefault();
        }

        return evt;
      }

    };

    return EventHandler;

  }));

  }(eventHandler));

  var manipulator = {exports: {}};

  /*!
    * Bootstrap manipulator.js v5.1.3 (https://getbootstrap.com/)
    * Copyright 2011-2021 The Bootstrap Authors (https://github.com/twbs/bootstrap/graphs/contributors)
    * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
    */

  (function (module, exports) {
  (function (global, factory) {
    module.exports = factory() ;
  })(commonjsGlobal, (function () {
    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): dom/manipulator.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */
    function normalizeData(val) {
      if (val === 'true') {
        return true;
      }

      if (val === 'false') {
        return false;
      }

      if (val === Number(val).toString()) {
        return Number(val);
      }

      if (val === '' || val === 'null') {
        return null;
      }

      return val;
    }

    function normalizeDataKey(key) {
      return key.replace(/[A-Z]/g, chr => `-${chr.toLowerCase()}`);
    }

    const Manipulator = {
      setDataAttribute(element, key, value) {
        element.setAttribute(`data-bs-${normalizeDataKey(key)}`, value);
      },

      removeDataAttribute(element, key) {
        element.removeAttribute(`data-bs-${normalizeDataKey(key)}`);
      },

      getDataAttributes(element) {
        if (!element) {
          return {};
        }

        const attributes = {};
        Object.keys(element.dataset).filter(key => key.startsWith('bs')).forEach(key => {
          let pureKey = key.replace(/^bs/, '');
          pureKey = pureKey.charAt(0).toLowerCase() + pureKey.slice(1, pureKey.length);
          attributes[pureKey] = normalizeData(element.dataset[key]);
        });
        return attributes;
      },

      getDataAttribute(element, key) {
        return normalizeData(element.getAttribute(`data-bs-${normalizeDataKey(key)}`));
      },

      offset(element) {
        const rect = element.getBoundingClientRect();
        return {
          top: rect.top + window.pageYOffset,
          left: rect.left + window.pageXOffset
        };
      },

      position(element) {
        return {
          top: element.offsetTop,
          left: element.offsetLeft
        };
      }

    };

    return Manipulator;

  }));

  }(manipulator));

  var selectorEngine = {exports: {}};

  /*!
    * Bootstrap selector-engine.js v5.1.3 (https://getbootstrap.com/)
    * Copyright 2011-2021 The Bootstrap Authors (https://github.com/twbs/bootstrap/graphs/contributors)
    * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
    */

  (function (module, exports) {
  (function (global, factory) {
    module.exports = factory() ;
  })(commonjsGlobal, (function () {
    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): util/index.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */

    const isElement = obj => {
      if (!obj || typeof obj !== 'object') {
        return false;
      }

      if (typeof obj.jquery !== 'undefined') {
        obj = obj[0];
      }

      return typeof obj.nodeType !== 'undefined';
    };

    const isVisible = element => {
      if (!isElement(element) || element.getClientRects().length === 0) {
        return false;
      }

      return getComputedStyle(element).getPropertyValue('visibility') === 'visible';
    };

    const isDisabled = element => {
      if (!element || element.nodeType !== Node.ELEMENT_NODE) {
        return true;
      }

      if (element.classList.contains('disabled')) {
        return true;
      }

      if (typeof element.disabled !== 'undefined') {
        return element.disabled;
      }

      return element.hasAttribute('disabled') && element.getAttribute('disabled') !== 'false';
    };

    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): dom/selector-engine.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */
    const NODE_TEXT = 3;
    const SelectorEngine = {
      find(selector, element = document.documentElement) {
        return [].concat(...Element.prototype.querySelectorAll.call(element, selector));
      },

      findOne(selector, element = document.documentElement) {
        return Element.prototype.querySelector.call(element, selector);
      },

      children(element, selector) {
        return [].concat(...element.children).filter(child => child.matches(selector));
      },

      parents(element, selector) {
        const parents = [];
        let ancestor = element.parentNode;

        while (ancestor && ancestor.nodeType === Node.ELEMENT_NODE && ancestor.nodeType !== NODE_TEXT) {
          if (ancestor.matches(selector)) {
            parents.push(ancestor);
          }

          ancestor = ancestor.parentNode;
        }

        return parents;
      },

      prev(element, selector) {
        let previous = element.previousElementSibling;

        while (previous) {
          if (previous.matches(selector)) {
            return [previous];
          }

          previous = previous.previousElementSibling;
        }

        return [];
      },

      next(element, selector) {
        let next = element.nextElementSibling;

        while (next) {
          if (next.matches(selector)) {
            return [next];
          }

          next = next.nextElementSibling;
        }

        return [];
      },

      focusableChildren(element) {
        const focusables = ['a', 'button', 'input', 'textarea', 'select', 'details', '[tabindex]', '[contenteditable="true"]'].map(selector => `${selector}:not([tabindex^="-"])`).join(', ');
        return this.find(focusables, element).filter(el => !isDisabled(el) && isVisible(el));
      }

    };

    return SelectorEngine;

  }));

  }(selectorEngine));

  var baseComponent = {exports: {}};

  var data = {exports: {}};

  /*!
    * Bootstrap data.js v5.1.3 (https://getbootstrap.com/)
    * Copyright 2011-2021 The Bootstrap Authors (https://github.com/twbs/bootstrap/graphs/contributors)
    * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
    */

  (function (module, exports) {
  (function (global, factory) {
    module.exports = factory() ;
  })(commonjsGlobal, (function () {
    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): dom/data.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */

    /**
     * ------------------------------------------------------------------------
     * Constants
     * ------------------------------------------------------------------------
     */
    const elementMap = new Map();
    const data = {
      set(element, key, instance) {
        if (!elementMap.has(element)) {
          elementMap.set(element, new Map());
        }

        const instanceMap = elementMap.get(element); // make it clear we only want one instance per element
        // can be removed later when multiple key/instances are fine to be used

        if (!instanceMap.has(key) && instanceMap.size !== 0) {
          // eslint-disable-next-line no-console
          console.error(`Bootstrap doesn't allow more than one instance per element. Bound instance: ${Array.from(instanceMap.keys())[0]}.`);
          return;
        }

        instanceMap.set(key, instance);
      },

      get(element, key) {
        if (elementMap.has(element)) {
          return elementMap.get(element).get(key) || null;
        }

        return null;
      },

      remove(element, key) {
        if (!elementMap.has(element)) {
          return;
        }

        const instanceMap = elementMap.get(element);
        instanceMap.delete(key); // free up element references if there are no instances left for an element

        if (instanceMap.size === 0) {
          elementMap.delete(element);
        }
      }

    };

    return data;

  }));

  }(data));

  /*!
    * Bootstrap base-component.js v5.1.3 (https://getbootstrap.com/)
    * Copyright 2011-2021 The Bootstrap Authors (https://github.com/twbs/bootstrap/graphs/contributors)
    * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
    */

  (function (module, exports) {
  (function (global, factory) {
    module.exports = factory(data.exports, eventHandler.exports) ;
  })(commonjsGlobal, (function (Data, EventHandler) {
    const _interopDefaultLegacy = e => e && typeof e === 'object' && 'default' in e ? e : { default: e };

    const Data__default = /*#__PURE__*/_interopDefaultLegacy(Data);
    const EventHandler__default = /*#__PURE__*/_interopDefaultLegacy(EventHandler);

    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): util/index.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */
    const MILLISECONDS_MULTIPLIER = 1000;
    const TRANSITION_END = 'transitionend'; // Shoutout AngusCroll (https://goo.gl/pxwQGp)

    const getTransitionDurationFromElement = element => {
      if (!element) {
        return 0;
      } // Get transition-duration of the element


      let {
        transitionDuration,
        transitionDelay
      } = window.getComputedStyle(element);
      const floatTransitionDuration = Number.parseFloat(transitionDuration);
      const floatTransitionDelay = Number.parseFloat(transitionDelay); // Return 0 if element or transition duration is not found

      if (!floatTransitionDuration && !floatTransitionDelay) {
        return 0;
      } // If multiple durations are defined, take the first


      transitionDuration = transitionDuration.split(',')[0];
      transitionDelay = transitionDelay.split(',')[0];
      return (Number.parseFloat(transitionDuration) + Number.parseFloat(transitionDelay)) * MILLISECONDS_MULTIPLIER;
    };

    const triggerTransitionEnd = element => {
      element.dispatchEvent(new Event(TRANSITION_END));
    };

    const isElement = obj => {
      if (!obj || typeof obj !== 'object') {
        return false;
      }

      if (typeof obj.jquery !== 'undefined') {
        obj = obj[0];
      }

      return typeof obj.nodeType !== 'undefined';
    };

    const getElement = obj => {
      if (isElement(obj)) {
        // it's a jQuery object or a node element
        return obj.jquery ? obj[0] : obj;
      }

      if (typeof obj === 'string' && obj.length > 0) {
        return document.querySelector(obj);
      }

      return null;
    };

    const execute = callback => {
      if (typeof callback === 'function') {
        callback();
      }
    };

    const executeAfterTransition = (callback, transitionElement, waitForTransition = true) => {
      if (!waitForTransition) {
        execute(callback);
        return;
      }

      const durationPadding = 5;
      const emulatedDuration = getTransitionDurationFromElement(transitionElement) + durationPadding;
      let called = false;

      const handler = ({
        target
      }) => {
        if (target !== transitionElement) {
          return;
        }

        called = true;
        transitionElement.removeEventListener(TRANSITION_END, handler);
        execute(callback);
      };

      transitionElement.addEventListener(TRANSITION_END, handler);
      setTimeout(() => {
        if (!called) {
          triggerTransitionEnd(transitionElement);
        }
      }, emulatedDuration);
    };

    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): base-component.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */
    /**
     * ------------------------------------------------------------------------
     * Constants
     * ------------------------------------------------------------------------
     */

    const VERSION = '5.1.3';

    class BaseComponent {
      constructor(element) {
        element = getElement(element);

        if (!element) {
          return;
        }

        this._element = element;
        Data__default.default.set(this._element, this.constructor.DATA_KEY, this);
      }

      dispose() {
        Data__default.default.remove(this._element, this.constructor.DATA_KEY);
        EventHandler__default.default.off(this._element, this.constructor.EVENT_KEY);
        Object.getOwnPropertyNames(this).forEach(propertyName => {
          this[propertyName] = null;
        });
      }

      _queueCallback(callback, element, isAnimated = true) {
        executeAfterTransition(callback, element, isAnimated);
      }
      /** Static */


      static getInstance(element) {
        return Data__default.default.get(getElement(element), this.DATA_KEY);
      }

      static getOrCreateInstance(element, config = {}) {
        return this.getInstance(element) || new this(element, typeof config === 'object' ? config : null);
      }

      static get VERSION() {
        return VERSION;
      }

      static get NAME() {
        throw new Error('You have to implement the static method "NAME", for each component!');
      }

      static get DATA_KEY() {
        return `bs.${this.NAME}`;
      }

      static get EVENT_KEY() {
        return `.${this.DATA_KEY}`;
      }

    }

    return BaseComponent;

  }));

  }(baseComponent));

  /*!
    * Bootstrap modal.js v5.1.3 (https://getbootstrap.com/)
    * Copyright 2011-2021 The Bootstrap Authors (https://github.com/twbs/bootstrap/graphs/contributors)
    * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
    */

  (function (module, exports) {
  (function (global, factory) {
    module.exports = factory(eventHandler.exports, manipulator.exports, selectorEngine.exports, baseComponent.exports) ;
  })(commonjsGlobal, (function (EventHandler, Manipulator, SelectorEngine, BaseComponent) {
    const _interopDefaultLegacy = e => e && typeof e === 'object' && 'default' in e ? e : { default: e };

    const EventHandler__default = /*#__PURE__*/_interopDefaultLegacy(EventHandler);
    const Manipulator__default = /*#__PURE__*/_interopDefaultLegacy(Manipulator);
    const SelectorEngine__default = /*#__PURE__*/_interopDefaultLegacy(SelectorEngine);
    const BaseComponent__default = /*#__PURE__*/_interopDefaultLegacy(BaseComponent);

    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): util/index.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */
    const MILLISECONDS_MULTIPLIER = 1000;
    const TRANSITION_END = 'transitionend'; // Shoutout AngusCroll (https://goo.gl/pxwQGp)

    const toType = obj => {
      if (obj === null || obj === undefined) {
        return `${obj}`;
      }

      return {}.toString.call(obj).match(/\s([a-z]+)/i)[1].toLowerCase();
    };

    const getSelector = element => {
      let selector = element.getAttribute('data-bs-target');

      if (!selector || selector === '#') {
        let hrefAttr = element.getAttribute('href'); // The only valid content that could double as a selector are IDs or classes,
        // so everything starting with `#` or `.`. If a "real" URL is used as the selector,
        // `document.querySelector` will rightfully complain it is invalid.
        // See https://github.com/twbs/bootstrap/issues/32273

        if (!hrefAttr || !hrefAttr.includes('#') && !hrefAttr.startsWith('.')) {
          return null;
        } // Just in case some CMS puts out a full URL with the anchor appended


        if (hrefAttr.includes('#') && !hrefAttr.startsWith('#')) {
          hrefAttr = `#${hrefAttr.split('#')[1]}`;
        }

        selector = hrefAttr && hrefAttr !== '#' ? hrefAttr.trim() : null;
      }

      return selector;
    };

    const getElementFromSelector = element => {
      const selector = getSelector(element);
      return selector ? document.querySelector(selector) : null;
    };

    const getTransitionDurationFromElement = element => {
      if (!element) {
        return 0;
      } // Get transition-duration of the element


      let {
        transitionDuration,
        transitionDelay
      } = window.getComputedStyle(element);
      const floatTransitionDuration = Number.parseFloat(transitionDuration);
      const floatTransitionDelay = Number.parseFloat(transitionDelay); // Return 0 if element or transition duration is not found

      if (!floatTransitionDuration && !floatTransitionDelay) {
        return 0;
      } // If multiple durations are defined, take the first


      transitionDuration = transitionDuration.split(',')[0];
      transitionDelay = transitionDelay.split(',')[0];
      return (Number.parseFloat(transitionDuration) + Number.parseFloat(transitionDelay)) * MILLISECONDS_MULTIPLIER;
    };

    const triggerTransitionEnd = element => {
      element.dispatchEvent(new Event(TRANSITION_END));
    };

    const isElement = obj => {
      if (!obj || typeof obj !== 'object') {
        return false;
      }

      if (typeof obj.jquery !== 'undefined') {
        obj = obj[0];
      }

      return typeof obj.nodeType !== 'undefined';
    };

    const getElement = obj => {
      if (isElement(obj)) {
        // it's a jQuery object or a node element
        return obj.jquery ? obj[0] : obj;
      }

      if (typeof obj === 'string' && obj.length > 0) {
        return document.querySelector(obj);
      }

      return null;
    };

    const typeCheckConfig = (componentName, config, configTypes) => {
      Object.keys(configTypes).forEach(property => {
        const expectedTypes = configTypes[property];
        const value = config[property];
        const valueType = value && isElement(value) ? 'element' : toType(value);

        if (!new RegExp(expectedTypes).test(valueType)) {
          throw new TypeError(`${componentName.toUpperCase()}: Option "${property}" provided type "${valueType}" but expected type "${expectedTypes}".`);
        }
      });
    };

    const isVisible = element => {
      if (!isElement(element) || element.getClientRects().length === 0) {
        return false;
      }

      return getComputedStyle(element).getPropertyValue('visibility') === 'visible';
    };

    const isDisabled = element => {
      if (!element || element.nodeType !== Node.ELEMENT_NODE) {
        return true;
      }

      if (element.classList.contains('disabled')) {
        return true;
      }

      if (typeof element.disabled !== 'undefined') {
        return element.disabled;
      }

      return element.hasAttribute('disabled') && element.getAttribute('disabled') !== 'false';
    };
    /**
     * Trick to restart an element's animation
     *
     * @param {HTMLElement} element
     * @return void
     *
     * @see https://www.charistheo.io/blog/2021/02/restart-a-css-animation-with-javascript/#restarting-a-css-animation
     */


    const reflow = element => {
      // eslint-disable-next-line no-unused-expressions
      element.offsetHeight;
    };

    const getjQuery = () => {
      const {
        jQuery
      } = window;

      if (jQuery && !document.body.hasAttribute('data-bs-no-jquery')) {
        return jQuery;
      }

      return null;
    };

    const DOMContentLoadedCallbacks = [];

    const onDOMContentLoaded = callback => {
      if (document.readyState === 'loading') {
        // add listener on the first call when the document is in loading state
        if (!DOMContentLoadedCallbacks.length) {
          document.addEventListener('DOMContentLoaded', () => {
            DOMContentLoadedCallbacks.forEach(callback => callback());
          });
        }

        DOMContentLoadedCallbacks.push(callback);
      } else {
        callback();
      }
    };

    const isRTL = () => document.documentElement.dir === 'rtl';

    const defineJQueryPlugin = plugin => {
      onDOMContentLoaded(() => {
        const $ = getjQuery();
        /* istanbul ignore if */

        if ($) {
          const name = plugin.NAME;
          const JQUERY_NO_CONFLICT = $.fn[name];
          $.fn[name] = plugin.jQueryInterface;
          $.fn[name].Constructor = plugin;

          $.fn[name].noConflict = () => {
            $.fn[name] = JQUERY_NO_CONFLICT;
            return plugin.jQueryInterface;
          };
        }
      });
    };

    const execute = callback => {
      if (typeof callback === 'function') {
        callback();
      }
    };

    const executeAfterTransition = (callback, transitionElement, waitForTransition = true) => {
      if (!waitForTransition) {
        execute(callback);
        return;
      }

      const durationPadding = 5;
      const emulatedDuration = getTransitionDurationFromElement(transitionElement) + durationPadding;
      let called = false;

      const handler = ({
        target
      }) => {
        if (target !== transitionElement) {
          return;
        }

        called = true;
        transitionElement.removeEventListener(TRANSITION_END, handler);
        execute(callback);
      };

      transitionElement.addEventListener(TRANSITION_END, handler);
      setTimeout(() => {
        if (!called) {
          triggerTransitionEnd(transitionElement);
        }
      }, emulatedDuration);
    };

    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): util/scrollBar.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */
    const SELECTOR_FIXED_CONTENT = '.fixed-top, .fixed-bottom, .is-fixed, .sticky-top';
    const SELECTOR_STICKY_CONTENT = '.sticky-top';

    class ScrollBarHelper {
      constructor() {
        this._element = document.body;
      }

      getWidth() {
        // https://developer.mozilla.org/en-US/docs/Web/API/Window/innerWidth#usage_notes
        const documentWidth = document.documentElement.clientWidth;
        return Math.abs(window.innerWidth - documentWidth);
      }

      hide() {
        const width = this.getWidth();

        this._disableOverFlow(); // give padding to element to balance the hidden scrollbar width


        this._setElementAttributes(this._element, 'paddingRight', calculatedValue => calculatedValue + width); // trick: We adjust positive paddingRight and negative marginRight to sticky-top elements to keep showing fullwidth


        this._setElementAttributes(SELECTOR_FIXED_CONTENT, 'paddingRight', calculatedValue => calculatedValue + width);

        this._setElementAttributes(SELECTOR_STICKY_CONTENT, 'marginRight', calculatedValue => calculatedValue - width);
      }

      _disableOverFlow() {
        this._saveInitialAttribute(this._element, 'overflow');

        this._element.style.overflow = 'hidden';
      }

      _setElementAttributes(selector, styleProp, callback) {
        const scrollbarWidth = this.getWidth();

        const manipulationCallBack = element => {
          if (element !== this._element && window.innerWidth > element.clientWidth + scrollbarWidth) {
            return;
          }

          this._saveInitialAttribute(element, styleProp);

          const calculatedValue = window.getComputedStyle(element)[styleProp];
          element.style[styleProp] = `${callback(Number.parseFloat(calculatedValue))}px`;
        };

        this._applyManipulationCallback(selector, manipulationCallBack);
      }

      reset() {
        this._resetElementAttributes(this._element, 'overflow');

        this._resetElementAttributes(this._element, 'paddingRight');

        this._resetElementAttributes(SELECTOR_FIXED_CONTENT, 'paddingRight');

        this._resetElementAttributes(SELECTOR_STICKY_CONTENT, 'marginRight');
      }

      _saveInitialAttribute(element, styleProp) {
        const actualValue = element.style[styleProp];

        if (actualValue) {
          Manipulator__default.default.setDataAttribute(element, styleProp, actualValue);
        }
      }

      _resetElementAttributes(selector, styleProp) {
        const manipulationCallBack = element => {
          const value = Manipulator__default.default.getDataAttribute(element, styleProp);

          if (typeof value === 'undefined') {
            element.style.removeProperty(styleProp);
          } else {
            Manipulator__default.default.removeDataAttribute(element, styleProp);
            element.style[styleProp] = value;
          }
        };

        this._applyManipulationCallback(selector, manipulationCallBack);
      }

      _applyManipulationCallback(selector, callBack) {
        if (isElement(selector)) {
          callBack(selector);
        } else {
          SelectorEngine__default.default.find(selector, this._element).forEach(callBack);
        }
      }

      isOverflowing() {
        return this.getWidth() > 0;
      }

    }

    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): util/backdrop.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */
    const Default$2 = {
      className: 'modal-backdrop',
      isVisible: true,
      // if false, we use the backdrop helper without adding any element to the dom
      isAnimated: false,
      rootElement: 'body',
      // give the choice to place backdrop under different elements
      clickCallback: null
    };
    const DefaultType$2 = {
      className: 'string',
      isVisible: 'boolean',
      isAnimated: 'boolean',
      rootElement: '(element|string)',
      clickCallback: '(function|null)'
    };
    const NAME$2 = 'backdrop';
    const CLASS_NAME_FADE$1 = 'fade';
    const CLASS_NAME_SHOW$1 = 'show';
    const EVENT_MOUSEDOWN = `mousedown.bs.${NAME$2}`;

    class Backdrop {
      constructor(config) {
        this._config = this._getConfig(config);
        this._isAppended = false;
        this._element = null;
      }

      show(callback) {
        if (!this._config.isVisible) {
          execute(callback);
          return;
        }

        this._append();

        if (this._config.isAnimated) {
          reflow(this._getElement());
        }

        this._getElement().classList.add(CLASS_NAME_SHOW$1);

        this._emulateAnimation(() => {
          execute(callback);
        });
      }

      hide(callback) {
        if (!this._config.isVisible) {
          execute(callback);
          return;
        }

        this._getElement().classList.remove(CLASS_NAME_SHOW$1);

        this._emulateAnimation(() => {
          this.dispose();
          execute(callback);
        });
      } // Private


      _getElement() {
        if (!this._element) {
          const backdrop = document.createElement('div');
          backdrop.className = this._config.className;

          if (this._config.isAnimated) {
            backdrop.classList.add(CLASS_NAME_FADE$1);
          }

          this._element = backdrop;
        }

        return this._element;
      }

      _getConfig(config) {
        config = { ...Default$2,
          ...(typeof config === 'object' ? config : {})
        }; // use getElement() with the default "body" to get a fresh Element on each instantiation

        config.rootElement = getElement(config.rootElement);
        typeCheckConfig(NAME$2, config, DefaultType$2);
        return config;
      }

      _append() {
        if (this._isAppended) {
          return;
        }

        this._config.rootElement.append(this._getElement());

        EventHandler__default.default.on(this._getElement(), EVENT_MOUSEDOWN, () => {
          execute(this._config.clickCallback);
        });
        this._isAppended = true;
      }

      dispose() {
        if (!this._isAppended) {
          return;
        }

        EventHandler__default.default.off(this._element, EVENT_MOUSEDOWN);

        this._element.remove();

        this._isAppended = false;
      }

      _emulateAnimation(callback) {
        executeAfterTransition(callback, this._getElement(), this._config.isAnimated);
      }

    }

    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): util/focustrap.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */
    const Default$1 = {
      trapElement: null,
      // The element to trap focus inside of
      autofocus: true
    };
    const DefaultType$1 = {
      trapElement: 'element',
      autofocus: 'boolean'
    };
    const NAME$1 = 'focustrap';
    const DATA_KEY$1 = 'bs.focustrap';
    const EVENT_KEY$1 = `.${DATA_KEY$1}`;
    const EVENT_FOCUSIN = `focusin${EVENT_KEY$1}`;
    const EVENT_KEYDOWN_TAB = `keydown.tab${EVENT_KEY$1}`;
    const TAB_KEY = 'Tab';
    const TAB_NAV_FORWARD = 'forward';
    const TAB_NAV_BACKWARD = 'backward';

    class FocusTrap {
      constructor(config) {
        this._config = this._getConfig(config);
        this._isActive = false;
        this._lastTabNavDirection = null;
      }

      activate() {
        const {
          trapElement,
          autofocus
        } = this._config;

        if (this._isActive) {
          return;
        }

        if (autofocus) {
          trapElement.focus();
        }

        EventHandler__default.default.off(document, EVENT_KEY$1); // guard against infinite focus loop

        EventHandler__default.default.on(document, EVENT_FOCUSIN, event => this._handleFocusin(event));
        EventHandler__default.default.on(document, EVENT_KEYDOWN_TAB, event => this._handleKeydown(event));
        this._isActive = true;
      }

      deactivate() {
        if (!this._isActive) {
          return;
        }

        this._isActive = false;
        EventHandler__default.default.off(document, EVENT_KEY$1);
      } // Private


      _handleFocusin(event) {
        const {
          target
        } = event;
        const {
          trapElement
        } = this._config;

        if (target === document || target === trapElement || trapElement.contains(target)) {
          return;
        }

        const elements = SelectorEngine__default.default.focusableChildren(trapElement);

        if (elements.length === 0) {
          trapElement.focus();
        } else if (this._lastTabNavDirection === TAB_NAV_BACKWARD) {
          elements[elements.length - 1].focus();
        } else {
          elements[0].focus();
        }
      }

      _handleKeydown(event) {
        if (event.key !== TAB_KEY) {
          return;
        }

        this._lastTabNavDirection = event.shiftKey ? TAB_NAV_BACKWARD : TAB_NAV_FORWARD;
      }

      _getConfig(config) {
        config = { ...Default$1,
          ...(typeof config === 'object' ? config : {})
        };
        typeCheckConfig(NAME$1, config, DefaultType$1);
        return config;
      }

    }

    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): util/component-functions.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */

    const enableDismissTrigger = (component, method = 'hide') => {
      const clickEvent = `click.dismiss${component.EVENT_KEY}`;
      const name = component.NAME;
      EventHandler__default.default.on(document, clickEvent, `[data-bs-dismiss="${name}"]`, function (event) {
        if (['A', 'AREA'].includes(this.tagName)) {
          event.preventDefault();
        }

        if (isDisabled(this)) {
          return;
        }

        const target = getElementFromSelector(this) || this.closest(`.${name}`);
        const instance = component.getOrCreateInstance(target); // Method argument is left, for Alert and only, as it doesn't implement the 'hide' method

        instance[method]();
      });
    };

    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): modal.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */
    /**
     * ------------------------------------------------------------------------
     * Constants
     * ------------------------------------------------------------------------
     */

    const NAME = 'modal';
    const DATA_KEY = 'bs.modal';
    const EVENT_KEY = `.${DATA_KEY}`;
    const DATA_API_KEY = '.data-api';
    const ESCAPE_KEY = 'Escape';
    const Default = {
      backdrop: true,
      keyboard: true,
      focus: true
    };
    const DefaultType = {
      backdrop: '(boolean|string)',
      keyboard: 'boolean',
      focus: 'boolean'
    };
    const EVENT_HIDE = `hide${EVENT_KEY}`;
    const EVENT_HIDE_PREVENTED = `hidePrevented${EVENT_KEY}`;
    const EVENT_HIDDEN = `hidden${EVENT_KEY}`;
    const EVENT_SHOW = `show${EVENT_KEY}`;
    const EVENT_SHOWN = `shown${EVENT_KEY}`;
    const EVENT_RESIZE = `resize${EVENT_KEY}`;
    const EVENT_CLICK_DISMISS = `click.dismiss${EVENT_KEY}`;
    const EVENT_KEYDOWN_DISMISS = `keydown.dismiss${EVENT_KEY}`;
    const EVENT_MOUSEUP_DISMISS = `mouseup.dismiss${EVENT_KEY}`;
    const EVENT_MOUSEDOWN_DISMISS = `mousedown.dismiss${EVENT_KEY}`;
    const EVENT_CLICK_DATA_API = `click${EVENT_KEY}${DATA_API_KEY}`;
    const CLASS_NAME_OPEN = 'modal-open';
    const CLASS_NAME_FADE = 'fade';
    const CLASS_NAME_SHOW = 'show';
    const CLASS_NAME_STATIC = 'modal-static';
    const OPEN_SELECTOR = '.modal.show';
    const SELECTOR_DIALOG = '.modal-dialog';
    const SELECTOR_MODAL_BODY = '.modal-body';
    const SELECTOR_DATA_TOGGLE = '[data-bs-toggle="modal"]';
    /**
     * ------------------------------------------------------------------------
     * Class Definition
     * ------------------------------------------------------------------------
     */

    class Modal extends BaseComponent__default.default {
      constructor(element, config) {
        super(element);
        this._config = this._getConfig(config);
        this._dialog = SelectorEngine__default.default.findOne(SELECTOR_DIALOG, this._element);
        this._backdrop = this._initializeBackDrop();
        this._focustrap = this._initializeFocusTrap();
        this._isShown = false;
        this._ignoreBackdropClick = false;
        this._isTransitioning = false;
        this._scrollBar = new ScrollBarHelper();
      } // Getters


      static get Default() {
        return Default;
      }

      static get NAME() {
        return NAME;
      } // Public


      toggle(relatedTarget) {
        return this._isShown ? this.hide() : this.show(relatedTarget);
      }

      show(relatedTarget) {
        if (this._isShown || this._isTransitioning) {
          return;
        }

        const showEvent = EventHandler__default.default.trigger(this._element, EVENT_SHOW, {
          relatedTarget
        });

        if (showEvent.defaultPrevented) {
          return;
        }

        this._isShown = true;

        if (this._isAnimated()) {
          this._isTransitioning = true;
        }

        this._scrollBar.hide();

        document.body.classList.add(CLASS_NAME_OPEN);

        this._adjustDialog();

        this._setEscapeEvent();

        this._setResizeEvent();

        EventHandler__default.default.on(this._dialog, EVENT_MOUSEDOWN_DISMISS, () => {
          EventHandler__default.default.one(this._element, EVENT_MOUSEUP_DISMISS, event => {
            if (event.target === this._element) {
              this._ignoreBackdropClick = true;
            }
          });
        });

        this._showBackdrop(() => this._showElement(relatedTarget));
      }

      hide() {
        if (!this._isShown || this._isTransitioning) {
          return;
        }

        const hideEvent = EventHandler__default.default.trigger(this._element, EVENT_HIDE);

        if (hideEvent.defaultPrevented) {
          return;
        }

        this._isShown = false;

        const isAnimated = this._isAnimated();

        if (isAnimated) {
          this._isTransitioning = true;
        }

        this._setEscapeEvent();

        this._setResizeEvent();

        this._focustrap.deactivate();

        this._element.classList.remove(CLASS_NAME_SHOW);

        EventHandler__default.default.off(this._element, EVENT_CLICK_DISMISS);
        EventHandler__default.default.off(this._dialog, EVENT_MOUSEDOWN_DISMISS);

        this._queueCallback(() => this._hideModal(), this._element, isAnimated);
      }

      dispose() {
        [window, this._dialog].forEach(htmlElement => EventHandler__default.default.off(htmlElement, EVENT_KEY));

        this._backdrop.dispose();

        this._focustrap.deactivate();

        super.dispose();
      }

      handleUpdate() {
        this._adjustDialog();
      } // Private


      _initializeBackDrop() {
        return new Backdrop({
          isVisible: Boolean(this._config.backdrop),
          // 'static' option will be translated to true, and booleans will keep their value
          isAnimated: this._isAnimated()
        });
      }

      _initializeFocusTrap() {
        return new FocusTrap({
          trapElement: this._element
        });
      }

      _getConfig(config) {
        config = { ...Default,
          ...Manipulator__default.default.getDataAttributes(this._element),
          ...(typeof config === 'object' ? config : {})
        };
        typeCheckConfig(NAME, config, DefaultType);
        return config;
      }

      _showElement(relatedTarget) {
        const isAnimated = this._isAnimated();

        const modalBody = SelectorEngine__default.default.findOne(SELECTOR_MODAL_BODY, this._dialog);

        if (!this._element.parentNode || this._element.parentNode.nodeType !== Node.ELEMENT_NODE) {
          // Don't move modal's DOM position
          document.body.append(this._element);
        }

        this._element.style.display = 'block';

        this._element.removeAttribute('aria-hidden');

        this._element.setAttribute('aria-modal', true);

        this._element.setAttribute('role', 'dialog');

        this._element.scrollTop = 0;

        if (modalBody) {
          modalBody.scrollTop = 0;
        }

        if (isAnimated) {
          reflow(this._element);
        }

        this._element.classList.add(CLASS_NAME_SHOW);

        const transitionComplete = () => {
          if (this._config.focus) {
            this._focustrap.activate();
          }

          this._isTransitioning = false;
          EventHandler__default.default.trigger(this._element, EVENT_SHOWN, {
            relatedTarget
          });
        };

        this._queueCallback(transitionComplete, this._dialog, isAnimated);
      }

      _setEscapeEvent() {
        if (this._isShown) {
          EventHandler__default.default.on(this._element, EVENT_KEYDOWN_DISMISS, event => {
            if (this._config.keyboard && event.key === ESCAPE_KEY) {
              event.preventDefault();
              this.hide();
            } else if (!this._config.keyboard && event.key === ESCAPE_KEY) {
              this._triggerBackdropTransition();
            }
          });
        } else {
          EventHandler__default.default.off(this._element, EVENT_KEYDOWN_DISMISS);
        }
      }

      _setResizeEvent() {
        if (this._isShown) {
          EventHandler__default.default.on(window, EVENT_RESIZE, () => this._adjustDialog());
        } else {
          EventHandler__default.default.off(window, EVENT_RESIZE);
        }
      }

      _hideModal() {
        this._element.style.display = 'none';

        this._element.setAttribute('aria-hidden', true);

        this._element.removeAttribute('aria-modal');

        this._element.removeAttribute('role');

        this._isTransitioning = false;

        this._backdrop.hide(() => {
          document.body.classList.remove(CLASS_NAME_OPEN);

          this._resetAdjustments();

          this._scrollBar.reset();

          EventHandler__default.default.trigger(this._element, EVENT_HIDDEN);
        });
      }

      _showBackdrop(callback) {
        EventHandler__default.default.on(this._element, EVENT_CLICK_DISMISS, event => {
          if (this._ignoreBackdropClick) {
            this._ignoreBackdropClick = false;
            return;
          }

          if (event.target !== event.currentTarget) {
            return;
          }

          if (this._config.backdrop === true) {
            this.hide();
          } else if (this._config.backdrop === 'static') {
            this._triggerBackdropTransition();
          }
        });

        this._backdrop.show(callback);
      }

      _isAnimated() {
        return this._element.classList.contains(CLASS_NAME_FADE);
      }

      _triggerBackdropTransition() {
        const hideEvent = EventHandler__default.default.trigger(this._element, EVENT_HIDE_PREVENTED);

        if (hideEvent.defaultPrevented) {
          return;
        }

        const {
          classList,
          scrollHeight,
          style
        } = this._element;
        const isModalOverflowing = scrollHeight > document.documentElement.clientHeight; // return if the following background transition hasn't yet completed

        if (!isModalOverflowing && style.overflowY === 'hidden' || classList.contains(CLASS_NAME_STATIC)) {
          return;
        }

        if (!isModalOverflowing) {
          style.overflowY = 'hidden';
        }

        classList.add(CLASS_NAME_STATIC);

        this._queueCallback(() => {
          classList.remove(CLASS_NAME_STATIC);

          if (!isModalOverflowing) {
            this._queueCallback(() => {
              style.overflowY = '';
            }, this._dialog);
          }
        }, this._dialog);

        this._element.focus();
      } // ----------------------------------------------------------------------
      // the following methods are used to handle overflowing modals
      // ----------------------------------------------------------------------


      _adjustDialog() {
        const isModalOverflowing = this._element.scrollHeight > document.documentElement.clientHeight;

        const scrollbarWidth = this._scrollBar.getWidth();

        const isBodyOverflowing = scrollbarWidth > 0;

        if (!isBodyOverflowing && isModalOverflowing && !isRTL() || isBodyOverflowing && !isModalOverflowing && isRTL()) {
          this._element.style.paddingLeft = `${scrollbarWidth}px`;
        }

        if (isBodyOverflowing && !isModalOverflowing && !isRTL() || !isBodyOverflowing && isModalOverflowing && isRTL()) {
          this._element.style.paddingRight = `${scrollbarWidth}px`;
        }
      }

      _resetAdjustments() {
        this._element.style.paddingLeft = '';
        this._element.style.paddingRight = '';
      } // Static


      static jQueryInterface(config, relatedTarget) {
        return this.each(function () {
          const data = Modal.getOrCreateInstance(this, config);

          if (typeof config !== 'string') {
            return;
          }

          if (typeof data[config] === 'undefined') {
            throw new TypeError(`No method named "${config}"`);
          }

          data[config](relatedTarget);
        });
      }

    }
    /**
     * ------------------------------------------------------------------------
     * Data Api implementation
     * ------------------------------------------------------------------------
     */


    EventHandler__default.default.on(document, EVENT_CLICK_DATA_API, SELECTOR_DATA_TOGGLE, function (event) {
      const target = getElementFromSelector(this);

      if (['A', 'AREA'].includes(this.tagName)) {
        event.preventDefault();
      }

      EventHandler__default.default.one(target, EVENT_SHOW, showEvent => {
        if (showEvent.defaultPrevented) {
          // only register focus restorer if modal will actually get shown
          return;
        }

        EventHandler__default.default.one(target, EVENT_HIDDEN, () => {
          if (isVisible(this)) {
            this.focus();
          }
        });
      }); // avoid conflict when clicking moddal toggler while another one is open

      const allReadyOpen = SelectorEngine__default.default.findOne(OPEN_SELECTOR);

      if (allReadyOpen) {
        Modal.getInstance(allReadyOpen).hide();
      }

      const data = Modal.getOrCreateInstance(target);
      data.toggle(this);
    });
    enableDismissTrigger(Modal);
    /**
     * ------------------------------------------------------------------------
     * jQuery
     * ------------------------------------------------------------------------
     * add .Modal to jQuery only if jQuery is present
     */

    defineJQueryPlugin(Modal);

    return Modal;

  }));

  }(modal));

  var Modal = modal.exports;

  var collapse = {exports: {}};

  /*!
    * Bootstrap collapse.js v5.1.3 (https://getbootstrap.com/)
    * Copyright 2011-2021 The Bootstrap Authors (https://github.com/twbs/bootstrap/graphs/contributors)
    * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
    */

  (function (module, exports) {
  (function (global, factory) {
    module.exports = factory(data.exports, eventHandler.exports, manipulator.exports, selectorEngine.exports, baseComponent.exports) ;
  })(commonjsGlobal, (function (Data, EventHandler, Manipulator, SelectorEngine, BaseComponent) {
    const _interopDefaultLegacy = e => e && typeof e === 'object' && 'default' in e ? e : { default: e };

    const Data__default = /*#__PURE__*/_interopDefaultLegacy(Data);
    const EventHandler__default = /*#__PURE__*/_interopDefaultLegacy(EventHandler);
    const Manipulator__default = /*#__PURE__*/_interopDefaultLegacy(Manipulator);
    const SelectorEngine__default = /*#__PURE__*/_interopDefaultLegacy(SelectorEngine);
    const BaseComponent__default = /*#__PURE__*/_interopDefaultLegacy(BaseComponent);

    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): util/index.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */

    const toType = obj => {
      if (obj === null || obj === undefined) {
        return `${obj}`;
      }

      return {}.toString.call(obj).match(/\s([a-z]+)/i)[1].toLowerCase();
    };

    const getSelector = element => {
      let selector = element.getAttribute('data-bs-target');

      if (!selector || selector === '#') {
        let hrefAttr = element.getAttribute('href'); // The only valid content that could double as a selector are IDs or classes,
        // so everything starting with `#` or `.`. If a "real" URL is used as the selector,
        // `document.querySelector` will rightfully complain it is invalid.
        // See https://github.com/twbs/bootstrap/issues/32273

        if (!hrefAttr || !hrefAttr.includes('#') && !hrefAttr.startsWith('.')) {
          return null;
        } // Just in case some CMS puts out a full URL with the anchor appended


        if (hrefAttr.includes('#') && !hrefAttr.startsWith('#')) {
          hrefAttr = `#${hrefAttr.split('#')[1]}`;
        }

        selector = hrefAttr && hrefAttr !== '#' ? hrefAttr.trim() : null;
      }

      return selector;
    };

    const getSelectorFromElement = element => {
      const selector = getSelector(element);

      if (selector) {
        return document.querySelector(selector) ? selector : null;
      }

      return null;
    };

    const getElementFromSelector = element => {
      const selector = getSelector(element);
      return selector ? document.querySelector(selector) : null;
    };

    const isElement = obj => {
      if (!obj || typeof obj !== 'object') {
        return false;
      }

      if (typeof obj.jquery !== 'undefined') {
        obj = obj[0];
      }

      return typeof obj.nodeType !== 'undefined';
    };

    const getElement = obj => {
      if (isElement(obj)) {
        // it's a jQuery object or a node element
        return obj.jquery ? obj[0] : obj;
      }

      if (typeof obj === 'string' && obj.length > 0) {
        return document.querySelector(obj);
      }

      return null;
    };

    const typeCheckConfig = (componentName, config, configTypes) => {
      Object.keys(configTypes).forEach(property => {
        const expectedTypes = configTypes[property];
        const value = config[property];
        const valueType = value && isElement(value) ? 'element' : toType(value);

        if (!new RegExp(expectedTypes).test(valueType)) {
          throw new TypeError(`${componentName.toUpperCase()}: Option "${property}" provided type "${valueType}" but expected type "${expectedTypes}".`);
        }
      });
    };
    /**
     * Trick to restart an element's animation
     *
     * @param {HTMLElement} element
     * @return void
     *
     * @see https://www.charistheo.io/blog/2021/02/restart-a-css-animation-with-javascript/#restarting-a-css-animation
     */


    const reflow = element => {
      // eslint-disable-next-line no-unused-expressions
      element.offsetHeight;
    };

    const getjQuery = () => {
      const {
        jQuery
      } = window;

      if (jQuery && !document.body.hasAttribute('data-bs-no-jquery')) {
        return jQuery;
      }

      return null;
    };

    const DOMContentLoadedCallbacks = [];

    const onDOMContentLoaded = callback => {
      if (document.readyState === 'loading') {
        // add listener on the first call when the document is in loading state
        if (!DOMContentLoadedCallbacks.length) {
          document.addEventListener('DOMContentLoaded', () => {
            DOMContentLoadedCallbacks.forEach(callback => callback());
          });
        }

        DOMContentLoadedCallbacks.push(callback);
      } else {
        callback();
      }
    };

    const defineJQueryPlugin = plugin => {
      onDOMContentLoaded(() => {
        const $ = getjQuery();
        /* istanbul ignore if */

        if ($) {
          const name = plugin.NAME;
          const JQUERY_NO_CONFLICT = $.fn[name];
          $.fn[name] = plugin.jQueryInterface;
          $.fn[name].Constructor = plugin;

          $.fn[name].noConflict = () => {
            $.fn[name] = JQUERY_NO_CONFLICT;
            return plugin.jQueryInterface;
          };
        }
      });
    };

    /**
     * --------------------------------------------------------------------------
     * Bootstrap (v5.1.3): collapse.js
     * Licensed under MIT (https://github.com/twbs/bootstrap/blob/main/LICENSE)
     * --------------------------------------------------------------------------
     */
    /**
     * ------------------------------------------------------------------------
     * Constants
     * ------------------------------------------------------------------------
     */

    const NAME = 'collapse';
    const DATA_KEY = 'bs.collapse';
    const EVENT_KEY = `.${DATA_KEY}`;
    const DATA_API_KEY = '.data-api';
    const Default = {
      toggle: true,
      parent: null
    };
    const DefaultType = {
      toggle: 'boolean',
      parent: '(null|element)'
    };
    const EVENT_SHOW = `show${EVENT_KEY}`;
    const EVENT_SHOWN = `shown${EVENT_KEY}`;
    const EVENT_HIDE = `hide${EVENT_KEY}`;
    const EVENT_HIDDEN = `hidden${EVENT_KEY}`;
    const EVENT_CLICK_DATA_API = `click${EVENT_KEY}${DATA_API_KEY}`;
    const CLASS_NAME_SHOW = 'show';
    const CLASS_NAME_COLLAPSE = 'collapse';
    const CLASS_NAME_COLLAPSING = 'collapsing';
    const CLASS_NAME_COLLAPSED = 'collapsed';
    const CLASS_NAME_DEEPER_CHILDREN = `:scope .${CLASS_NAME_COLLAPSE} .${CLASS_NAME_COLLAPSE}`;
    const CLASS_NAME_HORIZONTAL = 'collapse-horizontal';
    const WIDTH = 'width';
    const HEIGHT = 'height';
    const SELECTOR_ACTIVES = '.collapse.show, .collapse.collapsing';
    const SELECTOR_DATA_TOGGLE = '[data-bs-toggle="collapse"]';
    /**
     * ------------------------------------------------------------------------
     * Class Definition
     * ------------------------------------------------------------------------
     */

    class Collapse extends BaseComponent__default.default {
      constructor(element, config) {
        super(element);
        this._isTransitioning = false;
        this._config = this._getConfig(config);
        this._triggerArray = [];
        const toggleList = SelectorEngine__default.default.find(SELECTOR_DATA_TOGGLE);

        for (let i = 0, len = toggleList.length; i < len; i++) {
          const elem = toggleList[i];
          const selector = getSelectorFromElement(elem);
          const filterElement = SelectorEngine__default.default.find(selector).filter(foundElem => foundElem === this._element);

          if (selector !== null && filterElement.length) {
            this._selector = selector;

            this._triggerArray.push(elem);
          }
        }

        this._initializeChildren();

        if (!this._config.parent) {
          this._addAriaAndCollapsedClass(this._triggerArray, this._isShown());
        }

        if (this._config.toggle) {
          this.toggle();
        }
      } // Getters


      static get Default() {
        return Default;
      }

      static get NAME() {
        return NAME;
      } // Public


      toggle() {
        if (this._isShown()) {
          this.hide();
        } else {
          this.show();
        }
      }

      show() {
        if (this._isTransitioning || this._isShown()) {
          return;
        }

        let actives = [];
        let activesData;

        if (this._config.parent) {
          const children = SelectorEngine__default.default.find(CLASS_NAME_DEEPER_CHILDREN, this._config.parent);
          actives = SelectorEngine__default.default.find(SELECTOR_ACTIVES, this._config.parent).filter(elem => !children.includes(elem)); // remove children if greater depth
        }

        const container = SelectorEngine__default.default.findOne(this._selector);

        if (actives.length) {
          const tempActiveData = actives.find(elem => container !== elem);
          activesData = tempActiveData ? Collapse.getInstance(tempActiveData) : null;

          if (activesData && activesData._isTransitioning) {
            return;
          }
        }

        const startEvent = EventHandler__default.default.trigger(this._element, EVENT_SHOW);

        if (startEvent.defaultPrevented) {
          return;
        }

        actives.forEach(elemActive => {
          if (container !== elemActive) {
            Collapse.getOrCreateInstance(elemActive, {
              toggle: false
            }).hide();
          }

          if (!activesData) {
            Data__default.default.set(elemActive, DATA_KEY, null);
          }
        });

        const dimension = this._getDimension();

        this._element.classList.remove(CLASS_NAME_COLLAPSE);

        this._element.classList.add(CLASS_NAME_COLLAPSING);

        this._element.style[dimension] = 0;

        this._addAriaAndCollapsedClass(this._triggerArray, true);

        this._isTransitioning = true;

        const complete = () => {
          this._isTransitioning = false;

          this._element.classList.remove(CLASS_NAME_COLLAPSING);

          this._element.classList.add(CLASS_NAME_COLLAPSE, CLASS_NAME_SHOW);

          this._element.style[dimension] = '';
          EventHandler__default.default.trigger(this._element, EVENT_SHOWN);
        };

        const capitalizedDimension = dimension[0].toUpperCase() + dimension.slice(1);
        const scrollSize = `scroll${capitalizedDimension}`;

        this._queueCallback(complete, this._element, true);

        this._element.style[dimension] = `${this._element[scrollSize]}px`;
      }

      hide() {
        if (this._isTransitioning || !this._isShown()) {
          return;
        }

        const startEvent = EventHandler__default.default.trigger(this._element, EVENT_HIDE);

        if (startEvent.defaultPrevented) {
          return;
        }

        const dimension = this._getDimension();

        this._element.style[dimension] = `${this._element.getBoundingClientRect()[dimension]}px`;
        reflow(this._element);

        this._element.classList.add(CLASS_NAME_COLLAPSING);

        this._element.classList.remove(CLASS_NAME_COLLAPSE, CLASS_NAME_SHOW);

        const triggerArrayLength = this._triggerArray.length;

        for (let i = 0; i < triggerArrayLength; i++) {
          const trigger = this._triggerArray[i];
          const elem = getElementFromSelector(trigger);

          if (elem && !this._isShown(elem)) {
            this._addAriaAndCollapsedClass([trigger], false);
          }
        }

        this._isTransitioning = true;

        const complete = () => {
          this._isTransitioning = false;

          this._element.classList.remove(CLASS_NAME_COLLAPSING);

          this._element.classList.add(CLASS_NAME_COLLAPSE);

          EventHandler__default.default.trigger(this._element, EVENT_HIDDEN);
        };

        this._element.style[dimension] = '';

        this._queueCallback(complete, this._element, true);
      }

      _isShown(element = this._element) {
        return element.classList.contains(CLASS_NAME_SHOW);
      } // Private


      _getConfig(config) {
        config = { ...Default,
          ...Manipulator__default.default.getDataAttributes(this._element),
          ...config
        };
        config.toggle = Boolean(config.toggle); // Coerce string values

        config.parent = getElement(config.parent);
        typeCheckConfig(NAME, config, DefaultType);
        return config;
      }

      _getDimension() {
        return this._element.classList.contains(CLASS_NAME_HORIZONTAL) ? WIDTH : HEIGHT;
      }

      _initializeChildren() {
        if (!this._config.parent) {
          return;
        }

        const children = SelectorEngine__default.default.find(CLASS_NAME_DEEPER_CHILDREN, this._config.parent);
        SelectorEngine__default.default.find(SELECTOR_DATA_TOGGLE, this._config.parent).filter(elem => !children.includes(elem)).forEach(element => {
          const selected = getElementFromSelector(element);

          if (selected) {
            this._addAriaAndCollapsedClass([element], this._isShown(selected));
          }
        });
      }

      _addAriaAndCollapsedClass(triggerArray, isOpen) {
        if (!triggerArray.length) {
          return;
        }

        triggerArray.forEach(elem => {
          if (isOpen) {
            elem.classList.remove(CLASS_NAME_COLLAPSED);
          } else {
            elem.classList.add(CLASS_NAME_COLLAPSED);
          }

          elem.setAttribute('aria-expanded', isOpen);
        });
      } // Static


      static jQueryInterface(config) {
        return this.each(function () {
          const _config = {};

          if (typeof config === 'string' && /show|hide/.test(config)) {
            _config.toggle = false;
          }

          const data = Collapse.getOrCreateInstance(this, _config);

          if (typeof config === 'string') {
            if (typeof data[config] === 'undefined') {
              throw new TypeError(`No method named "${config}"`);
            }

            data[config]();
          }
        });
      }

    }
    /**
     * ------------------------------------------------------------------------
     * Data Api implementation
     * ------------------------------------------------------------------------
     */


    EventHandler__default.default.on(document, EVENT_CLICK_DATA_API, SELECTOR_DATA_TOGGLE, function (event) {
      // preventDefault only for <a> elements (which change the URL) not inside the collapsible element
      if (event.target.tagName === 'A' || event.delegateTarget && event.delegateTarget.tagName === 'A') {
        event.preventDefault();
      }

      const selector = getSelectorFromElement(this);
      const selectorElements = SelectorEngine__default.default.find(selector);
      selectorElements.forEach(element => {
        Collapse.getOrCreateInstance(element, {
          toggle: false
        }).toggle();
      });
    });
    /**
     * ------------------------------------------------------------------------
     * jQuery
     * ------------------------------------------------------------------------
     * add .Collapse to jQuery only if jQuery is present
     */

    defineJQueryPlugin(Collapse);

    return Collapse;

  }));

  }(collapse));

  var Collapse = collapse.exports;

  var LEFT_PANEL_ID = 'col1panel';
  var RIGHT_PANEL_ID = 'col2panel';
  var CONTROL_PANEL_ID = 'ctrlpanel';
  var PANEL_BACK_BUTTON_ID = 'right-panel-back';
  var PANEL_LEFT = 'left';
  var PANEL_RIGHT = 'right';
  var DELETE_OCCURRENCE_MODAL_ID = 'deleteoccurrencemodal';
  var FINISH_MODAL_ID = 'finishmodal';
  var OCCURRENCE_LIST_CONTAINER_ID = 'occurrencelistcontainer';
  NyphSurveyForm.registerSection(NyphSurveyFormAboutSection);
  NyphSurveyForm.registerSection(NyphSurveyFormSurveySection);

  var _surveyFormSections = /*#__PURE__*/new WeakMap();

  var _occurrenceForm = /*#__PURE__*/new WeakMap();

  var _occurrenceChangeHandles = /*#__PURE__*/new WeakMap();

  var _refreshSurveyHelpPanel = /*#__PURE__*/new WeakSet();

  var _refreshOccurrenceEditor = /*#__PURE__*/new WeakSet();

  var _displayDefaultRightPanel = /*#__PURE__*/new WeakSet();

  var _clearOccurrenceListeners = /*#__PURE__*/new WeakSet();

  var _populateLeftPanel = /*#__PURE__*/new WeakSet();

  var _registerModals = /*#__PURE__*/new WeakSet();

  var _registerLeftPanelAccordionEvent = /*#__PURE__*/new WeakSet();

  var _appendWelcomeSection = /*#__PURE__*/new WeakSet();

  var _appendSurveyForm = /*#__PURE__*/new WeakSet();

  var _appendOccurrenceListContainer = /*#__PURE__*/new WeakSet();

  var _getOccurrenceListContainer = /*#__PURE__*/new WeakSet();

  var _buildOccurrenceList = /*#__PURE__*/new WeakSet();

  var _occurrenceSummaryHTML = /*#__PURE__*/new WeakSet();

  var MainView = /*#__PURE__*/function (_Page) {
    _inherits(MainView, _Page);

    var _super = _createSuper(MainView);

    /**
     * @type {MainController}
     */

    /**
     *
     * @type {Object.<string, NyphSurveyForm>}
     */

    /**
     * @type {NyphOccurrenceForm}
     */

    /**
     * keyed by occurrence id
     *
     * @type {{}}
     */

    /**
     * @type {(''|'help'|'form')}
     */

    /**
     * configuration flag
     * modify this for alternative survey types that finish with a general form section
     *
     * @type {boolean}
     */

    /**
     * @type {string}
     */

    /**
     * @type {string}
     */
    function MainView() {
      var _this;

      _classCallCheck(this, MainView);

      _this = _super.call(this); // mainly aiming to determine whether '/app/' or '/testapp/'

      _classPrivateMethodInitSpec(_assertThisInitialized(_this), _occurrenceSummaryHTML);

      _classPrivateMethodInitSpec(_assertThisInitialized(_this), _buildOccurrenceList);

      _classPrivateMethodInitSpec(_assertThisInitialized(_this), _getOccurrenceListContainer);

      _classPrivateMethodInitSpec(_assertThisInitialized(_this), _appendOccurrenceListContainer);

      _classPrivateMethodInitSpec(_assertThisInitialized(_this), _appendSurveyForm);

      _classPrivateMethodInitSpec(_assertThisInitialized(_this), _appendWelcomeSection);

      _classPrivateMethodInitSpec(_assertThisInitialized(_this), _registerLeftPanelAccordionEvent);

      _classPrivateMethodInitSpec(_assertThisInitialized(_this), _registerModals);

      _classPrivateMethodInitSpec(_assertThisInitialized(_this), _populateLeftPanel);

      _classPrivateMethodInitSpec(_assertThisInitialized(_this), _clearOccurrenceListeners);

      _classPrivateMethodInitSpec(_assertThisInitialized(_this), _displayDefaultRightPanel);

      _classPrivateMethodInitSpec(_assertThisInitialized(_this), _refreshOccurrenceEditor);

      _classPrivateMethodInitSpec(_assertThisInitialized(_this), _refreshSurveyHelpPanel);

      _defineProperty(_assertThisInitialized(_this), "controller", void 0);

      _classPrivateFieldInitSpec(_assertThisInitialized(_this), _surveyFormSections, {
        writable: true,
        value: {}
      });

      _classPrivateFieldInitSpec(_assertThisInitialized(_this), _occurrenceForm, {
        writable: true,
        value: void 0
      });

      _classPrivateFieldInitSpec(_assertThisInitialized(_this), _occurrenceChangeHandles, {
        writable: true,
        value: {}
      });

      _defineProperty(_assertThisInitialized(_this), "panelKey", '');

      _defineProperty(_assertThisInitialized(_this), "OCCURRENCES_ARE_LAST_SECTION", true);

      _defineProperty(_assertThisInitialized(_this), "recordsHeaderListDescriptorId", void 0);

      _defineProperty(_assertThisInitialized(_this), "pathPrefix", void 0);

      _defineProperty(_assertThisInitialized(_this), "deleteOccurrenceModal", void 0);

      _defineProperty(_assertThisInitialized(_this), "finishModal", void 0);

      _this.pathPrefix = window.location.pathname.split('/')[1];
      return _this;
    }
    /**
     * called once during late-stage app initialisation
     * (NB this may not be the current view when called)
     *
     * an opportunity to register listeners on this.controller.app
     */


    _createClass(MainView, [{
      key: "initialise",
      value: function initialise() {
        this.controller.app.addListener(b$1.EVENT_OCCURRENCE_ADDED, this.occurrenceAddedHandler.bind(this));
      }
      /**
       * called before display to initialise a two-panel layout
       */

    }, {
      key: "setLayout",
      value: function setLayout() {
        var _this2 = this;

        var bodyEl = document.getElementById('body');
        bodyEl.innerHTML = htmlLayout; // register handler on right-pane back button

        document.getElementById(PANEL_BACK_BUTTON_ID).addEventListener('click', function (event) {
          if (p(event)) {
            return;
          }

          event.stopPropagation();
          event.preventDefault();

          _this2.fireEvent(v$1.EVENT_BACK);
        });
      }
      /**
       * need to ensure that the open accordion sections match the url
       * do this by class tweaking, so that handlers do not fire
       *
       * @todo for survey sections should enforce that the first invalid or empty section is always opened
       */

    }, {
      key: "refreshLeftPanelAccordionState",
      value: function refreshLeftPanelAccordionState() {
        var cards = document.querySelectorAll("div#".concat(this.leftPanelAccordionId, " div[data-bs-parent=\"#").concat(this.leftPanelAccordionId, "\"].collapse"));
        var targetMatch;

        if (this.controller.viewSubcontext) {
          targetMatch = this.controller.viewSubcontext === 'record' ? 'record' : this.controller.surveySection;
        } else {
          targetMatch = '';
        }

        var _iterator = _createForOfIteratorHelper(cards),
            _step;

        try {
          for (_iterator.s(); !(_step = _iterator.n()).done;) {
            var card = _step.value;
            var parentDiv = card.parentElement;

            if (parentDiv.classList.contains('is-invalid')) {
              // don't ever hide invalid sections
              card.classList.add('show');
            } else {
              var cardSection = card.getAttribute('data-sectionkey');

              if (cardSection === targetMatch) {
                card.classList.add('show');
              } else {
                card.classList.remove('show');
              }
            }
          }
        } catch (err) {
          _iterator.e(err);
        } finally {
          _iterator.f();
        }

        this._refreshOccurrenceAccordionState();
      }
      /**
       * collapse open occurrence cards that don't match the current occurrence id
       *
       * @private
       */

    }, {
      key: "_refreshOccurrenceAccordionState",
      value: function _refreshOccurrenceAccordionState() {
        var occurrenceCards = document.querySelectorAll("div#".concat(OCCURRENCE_LIST_CONTAINER_ID, " div[data-bs-parent=\"#").concat(OCCURRENCE_LIST_CONTAINER_ID, "\"].collapse"));
        var targetMatch = this.controller.currentOccurrenceId;

        var _iterator2 = _createForOfIteratorHelper(occurrenceCards),
            _step2;

        try {
          for (_iterator2.s(); !(_step2 = _iterator2.n()).done;) {
            var card = _step2.value;
            var cardOccurrenceId = card.getAttribute('data-occurrenceid');

            if (cardOccurrenceId === targetMatch) {
              card.classList.add('show');
            } else {
              card.classList.remove('show');
            }
          }
        } catch (err) {
          _iterator2.e(err);
        } finally {
          _iterator2.f();
        }
      }
    }, {
      key: "display",
      value: function display() {
        if (this.controller.needsFullRefresh) {
          console.log('Full refresh triggered.');
          this.setLayout();

          _classPrivateMethodGet(this, _populateLeftPanel, _populateLeftPanel2).call(this);
        } else {
          // need to ensure that the open accordion sections match the url
          this.refreshLeftPanelAccordionState();
        }

        if (this.controller.needRightPanelRefresh) {
          // the view of the current record (in the right-hand editor pane)
          // has changed and needs rebuilding from scratch
          switch (this.controller.viewSubcontext) {
            case 'record':
              _classPrivateMethodGet(this, _refreshOccurrenceEditor, _refreshOccurrenceEditor2).call(this);

              break;

            case 'survey':
              _classPrivateMethodGet(this, _refreshSurveyHelpPanel, _refreshSurveyHelpPanel2).call(this);

              break;

            default:
              _classPrivateMethodGet(this, _displayDefaultRightPanel, _displayDefaultRightPanel2).call(this);

          }
        }

        this.setResponsivePanel('' === this.panelKey ? PANEL_LEFT : PANEL_RIGHT);
      }
    }, {
      key: "refreshOccurrenceFooterControls",
      value:
      /**
       * adds next/new and finish/close button to below right-panel occurrence editor
       * @param {HTMLElement} editorContainer
       */
      function refreshOccurrenceFooterControls(editorContainer) {
        var _this3 = this;

        var nextSection;
        var buttonContainer = editorContainer.appendChild(document.createElement('div'));
        var backButton = buttonContainer.appendChild(document.createElement('button'));
        backButton.className = 'btn btn-secondary btn-md-lg mt-2 mb-3 me-2';
        backButton.type = 'button';
        backButton.textContent = 'back to list';
        backButton.setAttribute('data-buttonaction', 'back');

        if (this.occurrenceIsMostRecent(this.controller.currentOccurrence)) {
          var addNewButton = buttonContainer.appendChild(document.createElement('button'));
          addNewButton.className = 'btn btn-primary btn-md-lg mt-2 mb-3 me-2';
          addNewButton.type = 'button';
          addNewButton.textContent = 'add another';
          addNewButton.setAttribute('data-buttonaction', 'new');
        }

        if (this.OCCURRENCES_ARE_LAST_SECTION) {
          var finishButton = buttonContainer.appendChild(document.createElement('button'));
          finishButton.className = 'btn btn-primary btn-md-lg mt-2 mb-3';
          finishButton.type = 'button';
          finishButton.textContent = 'finish';
          finishButton.setAttribute('data-buttonaction', 'finish');
        } else {
          var nextFormIndex = 1;
          nextSection = NyphSurveyForm.sections[nextFormIndex];
          var nextButton = buttonContainer.appendChild(document.createElement('button'));
          nextButton.className = 'btn btn-primary btn-md-lg mt-2 mb-3';
          nextButton.type = 'button';
          nextButton.textContent = 'next Â»';
          nextButton.setAttribute('data-buttonaction', 'next');
          nextButton.title = nextSection.sectionTitle;
        }

        buttonContainer.addEventListener('click',
        /** @param {MouseEvent} event */
        function (event) {
          if (p(event)) {
            return;
          }

          var buttonEl = event.target.closest('button');

          if (buttonEl && buttonEl.hasAttribute('data-buttonaction')) {
            switch (buttonEl.getAttribute('data-buttonaction')) {
              case 'new':
                _this3.fireEvent(v$1.EVENT_NEW_RECORD);

                break;

              case 'back':
                _this3.controller.app.router.navigate('/list/record/');

                break;

              case 'finish':
                _this3.controller.app.router.navigate('/list/record/'); // display the finish dialogue box
                //$(`#${FINISH_MODAL_ID}`).modal();


                _this3.finishModal.show(); // it's opportune at this point to try to ping the server again to save anything left outstanding


                _this3.controller.app.syncAll();

                break;

              case 'next':
                _this3.controller.app.router.navigate("/list/survey/".concat(nextSection.sectionNavigationKey));

                break;

              default:
                throw new Error("Unrecognised button action ".concat(buttonEl.getAttribute('data-buttonaction')));
            }
          }
        });
      }
      /**
       *
       * @param {Occurrence} occurrence
       * @returns {boolean}
       */

    }, {
      key: "occurrenceIsMostRecent",
      value: function occurrenceIsMostRecent(occurrence) {
        // loop through entries sorted by creation date, most recent first
        var _iterator3 = _createForOfIteratorHelper(this.controller.occurrences.entries()),
            _step3;

        try {
          for (_iterator3.s(); !(_step3 = _iterator3.n()).done;) {
            var occurrenceTuple = _step3.value;

            if (occurrenceTuple[1].createdStamp > occurrence.createdStamp && !occurrenceTuple[1].deleted) {
              return false;
            }
          }
        } catch (err) {
          _iterator3.e(err);
        } finally {
          _iterator3.f();
        }

        return true;
      }
      /**
       *
       * @param {string} [htmlText]
       */

    }, {
      key: "getOccurrenceForm",
      value:
      /**
       * @returns {NyphOccurrenceForm}
       */
      function getOccurrenceForm() {
        return _classPrivateFieldGet(this, _occurrenceForm);
      }
    }, {
      key: "_reviseWelcomeButtons",
      value:
      /**
       *
       * @param {HTMLButtonElement} nextButton
       * @param {HTMLAnchorElement} newLink
       * @param {HTMLElement} container
       * @private
       */
      function _reviseWelcomeButtons(nextButton, newLink, container) {
        //container.className = 'welcome-container';
        //const newButton = newLink.getElementsByTagName('button')[0];
        //let numberOfSurveys = this.controller.app.surveys.size;
        if (this.controller.app.currentSurvey && this.controller.app.currentSurvey && this.controller.app.currentSurvey.place) {
          nextButton.textContent = "continue '".concat(this.controller.app.currentSurvey.generateSurveyName(), "' \xBB");
          newLink.style.display = 'inline';
        } else {
          nextButton.textContent = 'get started Â»';
          newLink.style.display = 'none';
        }
      }
    }, {
      key: "_refreshVisibilityOfAccordionSections",
      value: function _refreshVisibilityOfAccordionSections() {
        //const accordionEl = document.getElementById(this.leftPanelAccordionId);
        var accordionSections = document.querySelectorAll("div#".concat(this.leftPanelAccordionId, " > div"));
        var valid = true;

        var _iterator4 = _createForOfIteratorHelper(accordionSections),
            _step4;

        try {
          for (_iterator4.s(); !(_step4 = _iterator4.n()).done;) {
            var cardEl = _step4.value;

            if (valid) {
              cardEl.classList.remove('hidden-card');
            } else {
              cardEl.classList.add('hidden-card');
            }

            if (cardEl.classList.contains('is-invalid')) {
              valid = false; // subsequent entries should be hidden
            }
          }
        } catch (err) {
          _iterator4.e(err);
        } finally {
          _iterator4.f();
        }
      }
    }, {
      key: "newButtonClickHandler",
      value:
      /**
       * @param {MouseEvent} event
       */
      function newButtonClickHandler(event) {
        if (p(event)) {
          return;
        }

        event.preventDefault();
        event.stopPropagation();
        this.fireEvent(v$1.EVENT_NEW_RECORD);
      }
    }, {
      key: "occurrenceAddedHandler",
      value:
      /**
       * called after the one-off addition of a new occurrence
       *
       * @param {{occurrenceId: string, surveyId: string}} params
       */
      function occurrenceAddedHandler(params) {
        var occurrenceList = _classPrivateMethodGet(this, _getOccurrenceListContainer, _getOccurrenceListContainer2).call(this);

        if (occurrenceList) {
          var occurrence = this.controller.occurrences.get(params.occurrenceId);
          var itemCard = document.createElement('div');
          itemCard.className = 'card';
          itemCard.id = "card_".concat(occurrence.id);
          itemCard.innerHTML = _classPrivateMethodGet(this, _occurrenceSummaryHTML, _occurrenceSummaryHTML2).call(this, occurrence);
          _classPrivateFieldGet(this, _occurrenceChangeHandles)[occurrence.id] = occurrence.addListener(f$1.EVENT_MODIFIED, this.occurrenceChangeHandler.bind(this), {
            occurrenceId: occurrence.id
          });
          occurrenceList.insertBefore(itemCard, occurrenceList.firstChild);
          occurrenceList.classList.add('has-occurrences');
        }
      }
      /**
       * sets validity flag in occurrence accordion header
       *
       * @param {Occurrence} occurrence
       */

    }, {
      key: "refreshOccurrenceValiditySummary",
      value: function refreshOccurrenceValiditySummary(occurrence) {
        var cardEl = document.getElementById("card_".concat(occurrence.id));

        if (cardEl) {
          var validity = occurrence.evaluateCompletionStatus(NyphOccurrenceForm.properties);

          if (validity.requiredFieldsPresent) {
            cardEl.classList.remove('is-invalid');
          } else {
            cardEl.classList.add('is-invalid');
          }
        }
      }
      /**
       *
       * @param {{occurrenceId : string}} params
       */

    }, {
      key: "occurrenceChangeHandler",
      value: function occurrenceChangeHandler(params) {
        var occurrence = this.controller.occurrences.get(params.occurrenceId);
        var el = document.getElementById("card_".concat(params.occurrenceId));

        if (el) {
          if (!occurrence.deleted) {
            el.innerHTML = _classPrivateMethodGet(this, _occurrenceSummaryHTML, _occurrenceSummaryHTML2).call(this, occurrence);
            this.refreshOccurrenceValiditySummary(occurrence);
          } else {
            el.parentElement.removeChild(el); // remove the event listener

            if (_classPrivateFieldGet(this, _occurrenceChangeHandles)[params.occurrenceId]) {
              occurrence.removeListener(f$1.EVENT_MODIFIED, _classPrivateFieldGet(this, _occurrenceChangeHandles)[params.occurrenceId]);
              _classPrivateFieldGet(this, _occurrenceChangeHandles)[params.occurrenceId] = null;
            }
          }
        }

        this.testForEmptyList();
      }
    }, {
      key: "testForEmptyList",
      value: function testForEmptyList() {
        var haveOccurrences = false;

        for (var _i = 0, _arr = _toConsumableArray(this.controller.occurrences.entries()); _i < _arr.length; _i++) {
          var occurrenceTuple = _arr[_i];
          var occurrence = occurrenceTuple[1];

          if (!occurrence.deleted) {
            haveOccurrences = true;
          }
        }

        var listContainer = _classPrivateMethodGet(this, _getOccurrenceListContainer, _getOccurrenceListContainer2).call(this);

        if (haveOccurrences) {
          listContainer.classList.add('has-occurrences');
        } else {
          listContainer.classList.remove('has-occurrences');
        }
      }
      /**
       *
       * @param {Occurrence} occurrence
       * @returns {string}
       */

    }, {
      key: "occurrenceSummaryBodyHTML",
      value: function occurrenceSummaryBodyHTML(occurrence) {
        var html = '';

        for (var key in occurrence.attributes) {
          if (occurrence.attributes.hasOwnProperty(key) && NyphOccurrenceForm.properties.hasOwnProperty(key) && !NyphOccurrenceForm.properties[key].field.isEmpty(occurrence.attributes[key])) {
            var summaryHTML = NyphOccurrenceForm.properties[key].field.summarise(key, NyphOccurrenceForm.properties[key], occurrence.attributes);

            if (summaryHTML) {
              html += "<p class=\"ellipsed-line mb-0\">".concat(summaryHTML, "</p>");
            }
          }
        }

        if (NyphApp.devMode) {
          html += "<p class=\"mb-0\">(<i>id ".concat(occurrence.id, "</i>)</p>");
        }

        return html;
      }
      /**
       *
       * @param {Occurrence} occurrence
       * @returns {string}
       */

    }, {
      key: "occurrenceSummaryHeadingHTML",
      value: function occurrenceSummaryHeadingHTML(occurrence) {
        var html = '';

        if (occurrence.attributes.hasOwnProperty('images') && occurrence.attributes.images.length) {
          var firstImageId = occurrence.attributes.images[0];
          html += g$1.imageLink(firstImageId, 48, 48, {
            className: 'me-1 image-float-left'
          });
        }

        if (occurrence.attributes.taxon && occurrence.attributes.taxon.taxonId) {
          // have a well-formed taxon
          html += occurrence.taxon.formattedHTML(occurrence.attributes.taxon.vernacularMatch);
        } else if (occurrence.attributes.taxon && occurrence.attributes.taxon.taxonName) {
          // match with unrecognised taxon name
          html += d$1(occurrence.attributes.taxon.taxonName);
        } else {
          html += '<span>(unnamed plant)</span>';
        }

        return html;
      }
      /**
       *
       *
       * @param {Occurrence} occurrence
       * @return {string}
       */

    }, {
      key: "setResponsivePanel",
      value:
      /**
       *
       * @param {('left'|'right')} panel
       */
      function setResponsivePanel(panel) {
        var rightPanel = document.getElementById(RIGHT_PANEL_ID);
        var leftPanel = document.getElementById(LEFT_PANEL_ID);
        var midPanel = document.getElementById(CONTROL_PANEL_ID);

        switch (panel) {
          case PANEL_LEFT:
            leftPanel.classList.remove('d-none');
            leftPanel.classList.add('d-block');
            rightPanel.classList.remove('d-block');
            rightPanel.classList.add('d-none');
            midPanel.classList.remove('d-md-none');
            midPanel.classList.add('d-none');
            break;

          case PANEL_RIGHT:
            if (leftPanel.classList.contains('d-block')) {
              leftPanel.classList.remove('d-block');
              console.log('scrolling to top in setResponsivePanel');
              rightPanel.scrollTop = 0;
            }

            leftPanel.classList.add('d-none');
            rightPanel.classList.remove('d-none');
            rightPanel.classList.add('d-block');
            midPanel.classList.remove('d-none');
            midPanel.classList.add('d-md-none');
            break;

          default:
            throw new Error("Unrecognised panel value '".concat(panel));
        }
      }
    }]);

    return MainView;
  }(xe);

  function _refreshSurveyHelpPanel2() {
    var rightPanelContainer = document.getElementById(RIGHT_PANEL_ID);
    rightPanelContainer.scrollTop = 0;
    var sectionKey = this.controller.surveySection; // section key can be 'welcome' which is a special case that doesn't match a section form

    var help = NyphSurveyForm.sectionsByKey[sectionKey] ? NyphSurveyForm.sectionsByKey[sectionKey].help : '';

    if (help) {
      rightPanelContainer.innerHTML = help;
    } else if (sectionKey === 'welcome') {
      rightPanelContainer.innerHTML = defaultRightHandSideHelp;
    } else {
      // shouldn't get here
      rightPanelContainer.innerHTML = "<p>placeholder survey help content for '".concat(sectionKey, "'</p>");
    }

    this.controller.app.router.updatePageLinks(); // required in case help text contains any Navigo links
  }

  function _refreshOccurrenceEditor2() {
    try {
      var occurrence = this.controller.currentOccurrence;
      var editorContainer = document.getElementById(RIGHT_PANEL_ID);

      if (occurrence) {
        if (!_classPrivateFieldGet(this, _occurrenceForm) || _classPrivateFieldGet(this, _occurrenceForm).occurrenceId !== occurrence.id) {
          if (_classPrivateFieldGet(this, _occurrenceForm)) {
            _classPrivateFieldGet(this, _occurrenceForm).destructor();
          } // form has not been initialised or current occurrence has changed
          //this.#occurrenceForm = occurrence.setForm(new NyphOccurrenceForm(occurrence));


          _classPrivateFieldSet(this, _occurrenceForm, new NyphOccurrenceForm(occurrence));

          _classPrivateFieldGet(this, _occurrenceForm).setOccurrence(occurrence);

          _classPrivateFieldGet(this, _occurrenceForm).surveyId = this.controller.app.currentSurvey.id; // scroll to the top of the panel

          console.log('scrolling to top of occurrence');
          editorContainer.scrollTop = 0;
        }

        editorContainer.innerHTML = '';

        var formEl = _classPrivateFieldGet(this, _occurrenceForm).formElement;

        editorContainer.appendChild(formEl);

        _classPrivateFieldGet(this, _occurrenceForm).populateFormContent();

        if (occurrence.isNew) {
          console.log('Firing event for initialisation of new occurrence.');

          _classPrivateFieldGet(this, _occurrenceForm).fireEvent(k.EVENT_INITIALISE_NEW, {
            survey: this.controller.app.currentSurvey
          }); // allows first-time initialisation of dynamic default data, e.g. starting a GPS fix

        } else {
          console.log('Firing event for initialisation of existing occurrence.');

          _classPrivateFieldGet(this, _occurrenceForm).fireEvent(k.EVENT_INITIALISED, {
            survey: this.controller.app.currentSurvey
          }); // allows re-initialisation of dynamic default data, e.g. setting a default geo-ref based on the survey

        }

        this.refreshOccurrenceFooterControls(editorContainer); // ensures that the accordion matches the navigation state
        //$(`#description_${occurrence.id}`).collapse('show');

        Collapse.getOrCreateInstance(document.getElementById("description_".concat(occurrence.id))).show();
      } else {
        _classPrivateMethodGet(this, _displayDefaultRightPanel, _displayDefaultRightPanel2).call(this, NyphOccurrenceForm.help);
      }
    } catch (error) {
      console.log({
        error: error
      });

      var _editorContainer = document.getElementById(RIGHT_PANEL_ID);

      if (_editorContainer) {
        _editorContainer.innerHTML = "<p>".concat(error.message, "</p>");
      } else {
        document.body.innerHTML = "<h2>Sorry, something has gone wrong.</h2><p>Please try <a href=\"https://nyph.bsbi.app/app/\">reloading the page using this link</a>.</p><p>If the issue persists then please report this problem to <a href=\"mailto:nyplanthunt@bsbi.org\">nyplanthunt@bsbi.org</a> quoting the following:</p><p><strong>".concat(error.message, "</strong></p><p>Browser version: ").concat(navigator.userAgent, "</p><p>App version: 1.0.3.1649239755</p>"); //document.body.innerHTML = `<h2>Internal error</h2><p>Please report this problem:</p><p>${error.message}</p>`;
      }
    }
  }

  function _displayDefaultRightPanel2(htmlText) {
    var rightPanelContainer = document.getElementById(RIGHT_PANEL_ID);
    rightPanelContainer.innerHTML = htmlText || defaultRightHandSideHelp;
    rightPanelContainer.scrollTop = 0;
    this.controller.app.router.updatePageLinks(); // required in case help text contains any Navigo links
  }

  function _clearOccurrenceListeners2() {
    for (var id in _classPrivateFieldGet(this, _occurrenceChangeHandles)) {
      var occurrence = this.controller.occurrences.get[id];

      if (occurrence) {
        occurrence.removeListener(f$1.EVENT_MODIFIED, _classPrivateFieldGet(this, _occurrenceChangeHandles)[id]);
      }
    }

    _classPrivateFieldSet(this, _occurrenceChangeHandles, {});
  }

  function _populateLeftPanel2() {
    var _this4 = this;

    var leftPanel = document.getElementById(LEFT_PANEL_ID);
    var accordionEl = leftPanel.appendChild(document.createElement('div'));
    accordionEl.className = "accordion";
    this.leftPanelAccordionId = accordionEl.id = k.nextId;

    _classPrivateMethodGet(this, _appendWelcomeSection, _appendWelcomeSection2).call(this);

    _classPrivateMethodGet(this, _appendSurveyForm, _appendSurveyForm2).call(this, 0, accordionEl, MainView.NEXT_SURVEY_SECTION); // about you


    _classPrivateMethodGet(this, _appendSurveyForm, _appendSurveyForm2).call(this, 1, accordionEl, MainView.NEXT_RECORDS); // about your survey


    _classPrivateMethodGet(this, _appendOccurrenceListContainer, _appendOccurrenceListContainer2).call(this); // Keep this as is useful as guide for building other app layouts
    // this.#appendSurveyForm(1, accordionEl, MainView.NEXT_IS_FINAL); // about your garden


    _classPrivateMethodGet(this, _buildOccurrenceList, _buildOccurrenceList2).call(this);
    /**
     * need to manually intercept clicks on the form help buttons
     * to prevent click also triggering an accordion toggle
     */


    accordionEl.addEventListener('click',
    /** @param {MouseEvent} event */
    function (event) {
      if (p(event)) {
        return;
      }

      var targetLinkEl = event.target.closest('a');

      if (targetLinkEl && targetLinkEl.hasAttribute('data-help-link')) {
        event.preventDefault();
        event.stopPropagation();

        _this4.controller.app.router.navigate(targetLinkEl.getAttribute('data-help-link'));
      }
    });

    _classPrivateMethodGet(this, _registerLeftPanelAccordionEvent, _registerLeftPanelAccordionEvent2).call(this);

    _classPrivateMethodGet(this, _registerModals, _registerModals2).call(this);
  }

  function _registerModals2() {
    var _this5 = this;

    var container = document.body; // Delete record modal

    var deleteOccurrenceModalHTML = "<div class=\"modal fade\" id=\"".concat(DELETE_OCCURRENCE_MODAL_ID, "\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"").concat(DELETE_OCCURRENCE_MODAL_ID, "Title\" aria-hidden=\"true\">\n  <div class=\"modal-dialog modal-dialog-centered\" role=\"document\">\n    <div class=\"modal-content\">\n      <div class=\"modal-header\">\n        <h5 class=\"modal-title\" id=\"").concat(DELETE_OCCURRENCE_MODAL_ID, "Title\">Delete record?</h5>\n        <button type=\"button\" class=\"close\" data-bs-dismiss=\"modal\" aria-label=\"Close\">\n          <span aria-hidden=\"true\">&times;</span>\n        </button>\n      </div>\n      <div class=\"modal-body\">\n        Please confirm that you wish to delete the record.\n      </div>\n      <div class=\"modal-footer\">\n        <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Back</button>\n        <button type=\"button\" class=\"btn btn-danger\" data-bs-dismiss=\"modal\" id=\"").concat(DELETE_OCCURRENCE_MODAL_ID, "confirmed\">Delete record</button>\n      </div>\n    </div>\n  </div>\n</div>");
    var deleteOccurrenceModalFragmentEl = document.createElement('div');
    deleteOccurrenceModalFragmentEl.innerHTML = deleteOccurrenceModalHTML;
    var deleteOccurrenceModalEl = container.appendChild(deleteOccurrenceModalFragmentEl.firstChild);
    this.deleteOccurrenceModal = Modal.getOrCreateInstance(deleteOccurrenceModalEl, {});
    deleteOccurrenceModalEl.addEventListener('show.bs.modal', function (event) {
      var button = event.relatedTarget; // Button that triggered the modal
      // button will not be valid if modal has been invoked directly from script,
      // in which case the occurrence id attribute will already have been set

      if (button && 'occurrenceid' in button.dataset && button.dataset.occurrenceid) {
        var occurrenceId = button.dataset.occurrenceid;
        document.getElementById("".concat(DELETE_OCCURRENCE_MODAL_ID, "confirmed")).setAttribute('data-occurrenceid', occurrenceId);
      }
    });
    document.getElementById("".concat(DELETE_OCCURRENCE_MODAL_ID, "confirmed")).addEventListener('click',
    /** @param {MouseEvent} event */
    function (event) {
      if (p(event)) {
        return;
      }

      var confirmButtonEl = event.target.closest('button');

      if (confirmButtonEl && confirmButtonEl.hasAttribute('data-occurrenceid')) {
        var occurrenceId = confirmButtonEl.getAttribute('data-occurrenceid');
        console.log("Deleting occurrence ".concat(occurrenceId, "."));

        _this5.fireEvent(v$1.EVENT_DELETE_OCCURRENCE, {
          occurrenceId: occurrenceId
        });
      }
    }); // 'finish' modal
    // this pop-up is informational only

    var finishModalContainerEl = document.createElement('div');
    finishModalContainerEl.innerHTML = "<div class=\"modal fade\" id=\"".concat(FINISH_MODAL_ID, "\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"").concat(FINISH_MODAL_ID, "Title\" aria-hidden=\"true\">\n  <div class=\"modal-dialog modal-dialog-centered\" role=\"document\">\n    <div class=\"modal-content\">\n      <div class=\"modal-header\">\n        <h5 class=\"modal-title\" id=\"").concat(FINISH_MODAL_ID, "Title\">Thank you</h5>\n        <button type=\"button\" class=\"close\" data-bs-dismiss=\"modal\" aria-label=\"Close\">\n          <span aria-hidden=\"true\">&times;</span>\n        </button>\n      </div>\n      <div class=\"modal-body\" id=\"").concat(FINISH_MODAL_ID, "-body\">\n        <p>Thank you! Your records have been sent. If you wish, you can continue to make changes and edit or add further records.</p>\n        <p>We've sent you an email with a link to this form, so that you can return to it later if needed.</p>\n        <p>If you are planning another Plant Hunt expedition then please start a new survey, using the 'Lists' menu.</p>\n      </div>\n      <div class=\"modal-footer\">\n        <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Close</button>\n      </div>\n    </div>\n  </div>\n</div>");
    var finishModalEl = container.appendChild(finishModalContainerEl.firstChild);
    this.finishModal = Modal.getOrCreateInstance(finishModalEl);
    B.registerLicenseModal(container); // image modal
    // includes a button to delete the image

    B.registerImageModalElement(container, this); //         const imageModalEl = document.createElement('div');
    //         imageModalEl.innerHTML = `<div class="modal fade" id="${IMAGE_MODAL_ID}" tabindex="-1" role="dialog" aria-labelledby="${IMAGE_MODAL_ID}Title" aria-hidden="true">
    //   <div class="modal-dialog modal-dialog-centered" role="document">
    //     <div class="modal-content">
    //       <div class="modal-header d-none d-md-flex">
    //         <h5 class="modal-title" id="${IMAGE_MODAL_ID}Title">Photo</h5>
    //         <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
    //           <span aria-hidden="true">&times;</span>
    //         </button>
    //       </div>
    //       <div class="modal-body" style="position: relative;">
    //         <picture>
    //         </picture>
    //       </div>
    //       <div class="modal-footer">
    //         <button type="button" id="${IMAGE_MODAL_DELETE_BUTTON_ID}" class="btn btn-outline-danger delete-occurrence-button me-3" data-bs-toggle="modal" data-bs-target="#${DELETE_IMAGE_MODAL_ID}" data-imageid=""><i class="material-icons">delete</i></button>
    //         <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
    //       </div>
    //     </div>
    //   </div>
    // </div>`;
    //         container.appendChild(imageModalEl.firstChild);
    //
    //         document.getElementById(IMAGE_MODAL_DELETE_BUTTON_ID).addEventListener('click',/** @param {MouseEvent} event */ (event) => {
    //             if (doubleClickIntercepted(event)) {
    //                 return;
    //             }
    //
    //             const deleteButtonEl = event.target.closest('button');
    //
    //             if (deleteButtonEl && deleteButtonEl.hasAttribute('data-imageid')) {
    //                 const imageId = deleteButtonEl.getAttribute('data-imageid');
    //                 //console.log(`Deleting image ${occurrenceId}.`);
    //
    //                 this.#occurrenceForm.fireEvent(EVENT_DELETE_IMAGE, {imageId});
    //                 $(`#${IMAGE_MODAL_ID}`).modal('hide');
    //             }
    //         });
  }

  function _registerLeftPanelAccordionEvent2() {
    var _this6 = this;

    // console.log('Registering left panel accordion event handler.');
    var leftPanelEl = document.getElementById(LEFT_PANEL_ID); //$(`#${LEFT_PANEL_ID}`).on('show.bs.collapse', (event) => {

    leftPanelEl.addEventListener('show.bs.collapse', function (event) {
      // this will fire for both selection events within the records list and for changes to the top-level accordion
      console.log({
        'left panel show.bs.collapse': event
      });

      if (event.target.dataset.occurrenceid) {
        console.log({
          'left panel accordion show event (with occ id)': event
        });

        _this6.fireEvent(v$1.EVENT_SELECT_OCCURRENCE, {
          occurrenceId: event.target.dataset.occurrenceid
        });
      } else if (event.target.dataset.sectionkey) {
        console.log({
          'left panel accordion show event (with section key)': event
        });

        _this6.fireEvent(v$1.EVENT_SELECT_SURVEY_SECTION, {
          sectionKey: event.target.dataset.sectionkey
        });
      } else {
        console.log({
          'left panel accordion show event (other)': event
        });
      }
    });
    leftPanelEl.addEventListener('hide.bs.collapse', function (event) {
      console.log({
        'left panel hide.bs.collapse': event
      });

      if (event.target.dataset.sectionkey && _classPrivateFieldGet(_this6, _surveyFormSections)[event.target.dataset.sectionkey]) {
        var isValid = _classPrivateFieldGet(_this6, _surveyFormSections)[event.target.dataset.sectionkey].validateForm();

        console.log({
          'survey section validity': isValid
        });

        if (!isValid) {
          event.preventDefault();
        }
      }
    });
    leftPanelEl.addEventListener('hidden.bs.collapse', function (event) {
      // this will fire for both selection events within the records list and for changes to the top-level accordion
      console.log({
        'left panel accordion hidden event': event
      });

      if (event.target.dataset.occurrenceid) {
        // should evaluate the validity of the individual occurrence
        var occurrence = _this6.controller.occurrences.get(event.target.dataset.occurrenceid);

        if (occurrence.isNew && !occurrence.isPristine) {
          // closing of the slider is an action suggesting that user has moved on and validation should start
          occurrence.isNew = false;

          _this6.refreshOccurrenceValiditySummary(occurrence);
        } // only trigger a navigation if the occurrence was the current one


        if (_this6.controller.currentOccurrenceId === event.target.dataset.occurrenceid) {
          _this6.fireEvent(v$1.EVENT_SELECT_OCCURRENCE, {
            occurrenceId: ''
          });
        }
      } else if (event.target.dataset.sectionkey) {
        if (event.target.dataset.sectionkey === 'record') {
          // closing the top-level occurrences list
          // need to propagate validation down to the occurrences
          // only trigger a navigation if the view context was the current one
          if (_this6.controller.viewSubcontext === 'record') {
            _this6.fireEvent(v$1.EVENT_SELECT_SURVEY_SECTION, {
              sectionKey: ''
            });
          }
        } else {
          if (_classPrivateFieldGet(_this6, _surveyFormSections)[event.target.dataset.sectionkey]) {
            var isValid = _classPrivateFieldGet(_this6, _surveyFormSections)[event.target.dataset.sectionkey].validateForm();

            console.log({
              'survey section validity': isValid
            }); // only trigger a navigation if the section was the current one

            if (_this6.controller.surveySection === event.target.dataset.sectionkey) {
              _this6.fireEvent(v$1.EVENT_SELECT_SURVEY_SECTION, {
                sectionKey: ''
              });
            }
          }
        }
      }
    });
  }

  function _appendWelcomeSection2() {
    var _this7 = this;

    var accordionEl = document.getElementById(this.leftPanelAccordionId); // add 'next' button to the bottom of the survey form

    var nextButton = document.createElement('button');
    nextButton.className = 'btn btn-primary';
    nextButton.type = 'button';
    nextButton.textContent = 'get started Â»';
    nextButton.setAttribute('data-bs-toggle', 'collapse');
    nextButton.setAttribute('data-bs-target', '#survey-0-about');
    nextButton.style.marginRight = '1em';
    nextButton.style.marginTop = '0.5em';
    var newSurveyLink = document.createElement('a');
    var newSurveyButton = newSurveyLink.appendChild(document.createElement('button'));
    newSurveyButton.className = 'btn';
    newSurveyButton.type = 'button';
    newSurveyButton.style.borderColor = '#046931'; //newSurveyButton.style.marginLeft = '1em';

    newSurveyButton.style.marginTop = '0.5em';
    newSurveyLink.href = "/".concat(this.pathPrefix, "/survey/new");
    newSurveyLink.dataset.navigo = 'survey/new';
    newSurveyButton.textContent = 'start new list Â»';
    newSurveyLink.style.display = 'none';
    var cardId = k.nextId;
    var sectionElement = document.createElement('div');
    sectionElement.innerHTML = welcomeContent;

    this._reviseWelcomeButtons(nextButton, newSurveyLink, sectionElement);

    this.controller.app.addListener(b$1.EVENT_SURVEYS_CHANGED, function () {
      _this7._reviseWelcomeButtons(nextButton, newSurveyLink, sectionElement);
    });
    sectionElement.appendChild(nextButton);
    sectionElement.appendChild(newSurveyLink);
    var helpLink = document.createElement('span');
    helpLink.className = 'd-md-none ps-2'; // noinspection HtmlUnknownTarget

    helpLink.innerHTML = "(<a href=\"/".concat(this.pathPrefix, "/list/survey/welcome/help\" data-navigo=\"list/survey/welcome/help\">more info</a>)");
    sectionElement.appendChild(helpLink);
    accordionEl.appendChild(this.accordionItem({
      cardId: cardId,
      cardHeadingId: k.nextId,
      collapsed: this.controller.surveySection !== 'welcome',
      headingButtonId: k.nextId,
      headingHTML: 'Welcome',
      headingNonbuttonHTML: '',
      // `<small class="btn d-md-none">(<a href="/app/list/survey/${sectionClass.sectionNavigationKey}/help" data-help-link="/list/survey/${sectionClass.sectionNavigationKey}/help">help</a>)</small>`,
      headingValidationWarningHTML: '',
      cardDescriptionId: "survey-welcome",
      // Form.nextId,
      parentContainerId: accordionEl.id,
      bodyContentElement: sectionElement,
      dataAttributes: {
        sectionkey: "welcome"
      }
    }));
  }

  function _appendSurveyForm2(formIndex, accordionEl, next) {
    var _this8 = this;

    var sectionClass = NyphSurveyForm.sections[formIndex];
    var surveyFormSection = new NyphSurveyForm(sectionClass);
    _classPrivateFieldGet(this, _surveyFormSections)[sectionClass.sectionNavigationKey] = surveyFormSection;
    var formElement = surveyFormSection.formElement; // add 'next' button to the bottom of the survey form

    var nextButton = document.createElement('button');
    nextButton.className = 'btn btn-primary';
    nextButton.type = 'button';
    nextButton.textContent = 'next Â»';
    surveyFormSection.nextButtonId = nextButton.id = k.nextId;

    switch (next) {
      case MainView.NEXT_RECORDS:
        // records section is next
        // if there are no records then clicking the button should add a new one automatically
        // the complexity of this dual action requires a click handler
        nextButton.addEventListener('click',
        /** @param {MouseEvent} event */
        function (event) {
          if (!p(event)) {
            event.preventDefault();
            event.stopPropagation();
            surveyFormSection.liveValidation = true;

            if (surveyFormSection.validateForm()) {
              _this8.fireEvent(v$1.EVENT_NEXT_TO_RECORDS);
            }
          }
        });
        break;

      case MainView.NEXT_SURVEY_SECTION:
        // there's another survey section
        var nextSection = NyphSurveyForm.sections[formIndex + 1];
        nextButton.addEventListener('click',
        /** @param {MouseEvent} event */
        function (event) {
          if (!p(event)) {
            console.log({
              'in MainView.NEXT_SURVEY_SECTION liveValidation': surveyFormSection.liveValidation
            });
            console.log({
              surveyFormSection: surveyFormSection
            });
            surveyFormSection.liveValidation = true;

            if (!surveyFormSection.validateForm()) {
              // if not valid then prevent the event
              event.preventDefault();
              event.stopPropagation();
            }
          }
        });
        nextButton.setAttribute('data-bs-toggle', 'collapse');
        nextButton.setAttribute('data-bs-target', "#survey-".concat(formIndex + 1, "-").concat(nextSection.sectionNavigationKey));
        nextButton.title = nextSection.sectionTitle;
        break;

      case MainView.NEXT_IS_FINAL:
        nextButton.textContent = 'finish';
        nextButton.className = 'btn btn-primary btn-md-lg mt-2 mb-3';
        nextButton.type = 'button';
        nextButton.addEventListener('click',
        /** @param {MouseEvent} event */
        function (event) {
          if (!p(event)) {
            _this8.controller.app.router.navigate('/list/'); // display the finish dialogue box
            //$(`#${FINISH_MODAL_ID}`).modal();


            _this8.finishModal.show();
          }
        });
        break;

      default:
        throw new Error("Unrecognized next section keyword '".concat(next, "'"));
    }

    formElement.appendChild(nextButton);
    var cardId = k.nextId; //surveyFormSection.cardId = cardId; // need to register this so that subsequent cards can be hidden completely while earlier sections are invalid

    accordionEl.appendChild(this.accordionItem({
      cardId: cardId,
      cardHeadingId: k.nextId,
      collapsed: this.controller.surveySection !== sectionClass.sectionNavigationKey,
      headingButtonId: k.nextId,
      headingHTML: sectionClass.sectionTitle,
      headingNonbuttonHTML: "<small class=\"btn d-md-none\" style=\"margin: 0; padding: 0;\"><a href=\"/".concat(this.pathPrefix, "/list/survey/").concat(sectionClass.sectionNavigationKey, "/help\" data-help-link=\"/list/survey/").concat(sectionClass.sectionNavigationKey, "/help\" style=\"margin-left: 1em;\">(<span class=\"material-icons\" style=\"vertical-align: bottom;\">help_outline</span>&nbsp;help&nbsp;)</a></small>"),
      headingValidationWarningHTML: 'Please check the form for some missing responses.',
      cardDescriptionId: "survey-".concat(formIndex, "-").concat(sectionClass.sectionNavigationKey),
      // Form.nextId,
      parentContainerId: accordionEl.id,
      bodyContentElement: formElement,
      dataAttributes: {
        sectionkey: sectionClass.sectionNavigationKey
      }
    })); // cannot call registerForm until the form is part of the document
    //this.controller.survey.registerForm(surveyFormSection);

    surveyFormSection.registerSurvey(this.controller.survey);
    surveyFormSection.addListener(k.EVENT_VALIDATION_STATE_CHANGE, function (params) {
      var cardEl = document.getElementById(cardId);

      if (params.isValid) {
        cardEl.classList.remove('is-invalid');
      } else {
        cardEl.classList.add('is-invalid');
      } //if (surveyFormSection.sectionCompletionRequired()) {

      /**
       * @type {HTMLButtonElement}
       */
      //let nextButton = document.getElementById(surveyFormSection.nextButtonId);
      //nextButton.disabled = !params.isValid;
      //}


      _this8._refreshVisibilityOfAccordionSections();
    });
    surveyFormSection.testRequiredComplete(); // will trigger event if required sections are incomplete
  }

  function _appendOccurrenceListContainer2() {
    var _this9 = this;

    var accordionEl = document.getElementById(this.leftPanelAccordionId);
    var content = document.createDocumentFragment();
    var summaryEl = content.appendChild(document.createElement('p'));
    this.recordsHeaderListDescriptorId = k.nextId;
    var separateListsHTMLMessage; // include a warning here if the date has changed - prompting for new list

    if (this.controller.survey.date < L.todaysDate()) {
      separateListsHTMLMessage = "<p>A survey can last for up to 3 hours on a single day from a single local area. You can send in as many separate lists as you like.</p><p><strong>The current survey is from ".concat(this.controller.survey.date, ", please <a href=\"/").concat(this.pathPrefix, "/survey/new\" data-navigo=\"survey/new\">start a new list</a> if you are now adding records for a different day.</strong></p>");
    } else {
      separateListsHTMLMessage = "<p>Please survey for up to 3 hours on a single day. If your start again in a new area or on a different day, then please <a href=\"/".concat(this.pathPrefix, "/survey/new\" data-navigo=\"survey/new\">start another separate list</a>.</p>");
    } // noinspection HtmlUnknownTarget


    summaryEl.innerHTML = "<span id=\"".concat(this.recordsHeaderListDescriptorId, "\"><strong>Records of plants in bloom from ").concat(this.controller.survey.generateSurveyName(), ".</strong></span><small class=\"d-block d-md-none\"><a href=\"/").concat(this.pathPrefix, "/list/record/help\">(help)</a></small>").concat(separateListsHTMLMessage);
    var newButtonEl = content.appendChild(document.createElement('button'));
    newButtonEl.type = 'button';
    newButtonEl.className = 'btn btn-primary btn-lg mb-2';
    newButtonEl.innerText = 'Add a plant record.';
    newButtonEl.addEventListener('click', this.newButtonClickHandler.bind(this));
    var recordListContainer = content.appendChild(document.createElement('div'));
    recordListContainer.id = OCCURRENCE_LIST_CONTAINER_ID;
    this.controller.survey.addListener(m$1.EVENT_MODIFIED, function () {
      var occurrenceHeadingEl = document.getElementById(_this9.recordsHeaderListDescriptorId);

      if (occurrenceHeadingEl) {
        occurrenceHeadingEl.innerHTML = "<strong>Records of plants in bloom from ".concat(_this9.controller.survey.generateSurveyName(), ".</strong>");
      }
    });
    var cardId = k.nextId;
    accordionEl.appendChild(this.accordionItem({
      cardId: cardId,
      cardHeadingId: k.nextId,
      collapsed: this.controller.viewSubcontext !== 'record',
      headingButtonId: k.nextId,
      headingHTML: 'Your plant records',
      cardDescriptionId: k.nextId,
      parentContainerId: accordionEl.id,
      bodyContentElement: content,
      dataAttributes: {
        sectionkey: 'record'
      }
    }));
    this.controller.app.router.updatePageLinks();

    this._refreshVisibilityOfAccordionSections(); // this section was added last, need to ensure that it also reflects the state of accordion section hiding

  }

  function _getOccurrenceListContainer2() {
    var listContainer = document.getElementById(OCCURRENCE_LIST_CONTAINER_ID);

    if (!listContainer) {
      throw new p$1("Failed to find list container.");
    }

    return listContainer;
  }

  function _buildOccurrenceList2() {
    var _this10 = this;

    var listContainer = _classPrivateMethodGet(this, _getOccurrenceListContainer, _getOccurrenceListContainer2).call(this);

    _classPrivateMethodGet(this, _clearOccurrenceListeners, _clearOccurrenceListeners2).call(this);

    var occurrencesHtml = []; // loop through entries sorted by creation date, most recent first

    var _iterator5 = _createForOfIteratorHelper(_toConsumableArray(this.controller.occurrences.entries()).sort(function (a, b) {
      return b[1].createdStamp - a[1].createdStamp;
    })),
        _step5;

    try {
      for (_iterator5.s(); !(_step5 = _iterator5.n()).done;) {
        var occurrenceTuple = _step5.value;
        var occurrence = occurrenceTuple[1];

        if (!occurrence.deleted) {
          var valid = occurrence.isNew || occurrence.evaluateCompletionStatus(NyphOccurrenceForm.properties).requiredFieldsPresent;
          occurrencesHtml.push("<div class=\"card".concat(valid ? '' : ' is-invalid', "\" id=\"card_").concat(occurrence.id, "\">\n    ").concat(_classPrivateMethodGet(this, _occurrenceSummaryHTML, _occurrenceSummaryHTML2).call(this, occurrence), "\n</div>"));
          _classPrivateFieldGet(this, _occurrenceChangeHandles)[occurrence.id] = occurrence.addListener(f$1.EVENT_MODIFIED, this.occurrenceChangeHandler.bind(this), {
            occurrenceId: occurrence.id
          });
          _classPrivateFieldGet(this, _occurrenceChangeHandles)[occurrence.id] = occurrence.addListener(l$1.EVENT_SAVED_REMOTELY, this.occurrenceChangeHandler.bind(this), {
            occurrenceId: occurrence.id
          });
        }
      }
    } catch (err) {
      _iterator5.e(err);
    } finally {
      _iterator5.f();
    }

    var nullListInputId = "nullList".concat(k.nextId);
    var checked = this.controller.app.currentSurvey.attributes['nulllist'] ? ' checked' : ''; // this will be hidden by css if the list is not empty

    var nullListMessage = "<div class=\"nyph-null-list-prompt\"><p>Very occasionally people encounter no plants in bloom during their survey.\nThese 'null lists' are still useful to us, so please tell us even if you recorded no plants in flower.</p>\n<p><label><input type=\"checkbox\" value=\"1\" name=\"nulllist\" id=\"".concat(nullListInputId, "\"").concat(checked, "> This is a null list (I saw no plants in flower during my walk).</label></div></p>");
    occurrencesHtml.push(nullListMessage);
    listContainer.className = 'accordion';
    listContainer.innerHTML = occurrencesHtml.join('');
    /**
     * need to manually intercept clicks on the delete occurrence button
     * to prevent click also triggering an accordion toggle
     */

    listContainer.addEventListener('click',
    /** @param {MouseEvent} event */
    function (event) {
      if (p(event)) {
        return;
      }

      var targetButtonEl = event.target.closest('button');

      if (targetButtonEl && targetButtonEl.hasAttribute('data-bs-toggle') && targetButtonEl.getAttribute('data-bs-toggle') === 'modal') {
        // annotate the delete record modal dialogue box with the occurrence id
        document.getElementById("".concat(DELETE_OCCURRENCE_MODAL_ID, "confirmed")).setAttribute('data-occurrenceid', targetButtonEl.getAttribute('data-occurrenceid')); // display the dialogue box
        //$(targetButtonEl.getAttribute('data-bs-target')).modal();

        _this10.deleteOccurrenceModal.show();

        event.preventDefault();
        event.stopPropagation();
      }
    });
    /**
     *
     * @type {HTMLInputElement}
     */

    var nullListToggleEl = document.getElementById(nullListInputId);

    if (nullListToggleEl) {
      nullListToggleEl.addEventListener('change',
      /** @param {MouseEvent} event */
      function (event) {
        if (p(event)) {
          return;
        }

        console.log({
          'Updating null list state': nullListToggleEl.checked
        });

        _this10.controller.app.currentSurvey.setAttribute('nulllist', nullListToggleEl.checked); //this.fireEvent(MainView.EVENT_NULL_LIST_CHANGE, {'isNull' : nullListToggleEl.checked});

      });
    }

    this.testForEmptyList(); // sets a class on the occurrence list container
  }

  function _occurrenceSummaryHTML2(occurrence) {
    //@todo get unsaved message working
    var unsavedMessage = ''; // let unsavedMessage = (!occurrence.isPristine && occurrence.unsaved()) ?
    //     '<span class="occurrence-unsaved-warning">Not yet saved.</span>'
    //     :
    //     '';

    return "<div class=\"card-header pointer ps-2 pe-2 pt-2 pb-2\" id=\"heading_".concat(occurrence.id, "\" data-bs-toggle=\"collapse\" data-bs-target=\"#description_").concat(occurrence.id, "\">\n    <div class=\"float-end\">\n        <button type=\"button\" class=\"btn btn-outline-danger delete-occurrence-button\" data-bs-toggle=\"modal\" data-bs-target=\"#").concat(DELETE_OCCURRENCE_MODAL_ID, "\" data-occurrenceid=\"").concat(occurrence.id, "\"><i class=\"material-icons\">delete</i></button>\n    </div>\n    <h2 class=\"mb-0 pb-0 mt-0 pt-0 ps-0 ms-0\">\n        <button class=\"occurrence-heading btn btn-link").concat(this.controller.currentOccurrenceId === occurrence.id ? '' : ' collapsed', " pt-0 pb-0 ps-0\" id=\"headingbutton_").concat(occurrence.id, "\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#description_").concat(occurrence.id, "\" aria-expanded=\"").concat(this.controller.currentOccurrenceId === occurrence.id ? 'true' : 'false', "\" aria-controls=\"description_").concat(occurrence.id, "\">\n          ").concat(this.occurrenceSummaryHeadingHTML(occurrence), "\n        </button>\n    </h2>\n    <div class=\"card-invalid-feedback\">\n        <small>Please check for errors or missing details.</small>\n    </div>").concat(unsavedMessage, "\n</div>\n<div id=\"description_").concat(occurrence.id, "\" class=\"collapse").concat(this.controller.currentOccurrenceId === occurrence.id ? ' show' : '', "\" aria-labelledby=\"heading_").concat(occurrence.id, "\" data-bs-parent=\"#").concat(OCCURRENCE_LIST_CONTAINER_ID, "\" data-occurrenceid=\"").concat(occurrence.id, "\">\n  <div class=\"card-body\">\n    ").concat(this.occurrenceSummaryBodyHTML(occurrence), "\n  </div>\n</div>");
  }

  _defineProperty(MainView, "NEXT_RECORDS", 'records');

  _defineProperty(MainView, "NEXT_SURVEY_SECTION", 'survey');

  _defineProperty(MainView, "NEXT_IS_FINAL", 'last');

  var htmlContent = "<!-- begin: templates/helpPage.html -->\r\n<div class=\"accordion\" id=\"helpaccordion\">\r\n    <div class=\"accordion-item\">\r\n        <div class=\"accordion-header\" id=\"helphelpheadingOne\">\r\n            <h5 class=\"mb-0\">\r\n                <button class=\"accordion-button\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#collapseOne\" aria-expanded=\"true\" aria-controls=\"collapseOne\">\r\n                    About the New Year Plant Hunt\r\n                </button>\r\n            </h5>\r\n        </div>\r\n\r\n        <div id=\"collapseOne\" class=\"collapse show\" aria-labelledby=\"helpheadingOne\" data-bs-parent=\"#helpaccordion\">\r\n            <div class=\"accordion-body\">\r\n                <p>BSBI's New Year Plant began eleven years ago as an informal activity on social media. Since then the project has grown and is beginning to form a significant archived snapshot of the plants in bloom at the beginning of the year.</p>\r\n                <p>The project is contributing to our understanding of how wild and naturalised plants are responding to changes in autumn and winter weather patterns across Britain and Ireland.</p>\r\n                <p>The 2022 Hunt will run from Saturday 1<sup>st</sup> to Tuesday 4<sup>th</sup> January: head out for a walk of up to 3 hours and see how many wild or naturalised plants (but not garden plants) you can find in bloom.</p>\r\n            </div>\r\n        </div>\r\n    </div>\r\n    <div class=\"accordion-item\">\r\n        <div class=\"accordion-header\" id=\"helpheadingTwo\">\r\n            <h5 class=\"mb-0\">\r\n                <button class=\"accordion-button collapsed\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#collapseTwo\" aria-expanded=\"false\" aria-controls=\"collapseTwo\">\r\n                    What happens to my records?\r\n                </button>\r\n            </h5>\r\n        </div>\r\n        <div id=\"collapseTwo\" class=\"accordion-collapse collapse\" aria-labelledby=\"helpheadingTwo\" data-bs-parent=\"#helpaccordion\">\r\n            <div class=\"accordion-body\">\r\n                <p>Data from the plant hunt will form part of BSBI's archive of millions plant occurrence records. The Plant Hunt records may be of particular interest as they represent a consistent snap-shot and should help expose long-term changes related to climate change.</p>\r\n                <p>Our record will include the plants you've seen along with any photos that you've sent and the grid-reference for each occurrence. On the project website we show only a summary of the data, so that any confidential details are obscured.</p>\r\n                <p>You can choose whether or not to include your name alongside the occurrence record in our archive. </p>\r\n            </div>\r\n        </div>\r\n    </div>\r\n    <div class=\"accordion-item\">\r\n        <div class=\"accordion-header\" id=\"helpheadingwhatreport\">\r\n            <h5 class=\"mb-0\">\r\n                <button class=\"accordion-button collapsed\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#collapseWhatReport\" aria-expanded=\"false\" aria-controls=\"collapseThree\">\r\n                    Which plants should I record?\r\n                </button>\r\n            </h5>\r\n        </div>\r\n        <div id=\"collapseWhatReport\" class=\"accordion-collapse collapse\" aria-labelledby=\"helpheadingwhatreport\" data-bs-parent=\"#helpaccordion\">\r\n            <div class=\"accordion-body\">\r\n                <p>\r\n                    Only wild or naturalised plants, not garden plants. They must be in bloom please, plants that only have buds or seed heads donât count.\r\n                </p>\r\n            </div>\r\n        </div>\r\n    </div>\r\n    <div class=\"accordion-item\">\r\n        <div class=\"accordion-header\" id=\"helpphotoid\">\r\n            <h5 class=\"mb-0\">\r\n                <button class=\"accordion-button collapsed\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#collapsePhotoId\" aria-expanded=\"false\" aria-controls=\"collapseThree\">\r\n                    What if I don't know what the plant is?\r\n                </button>\r\n            </h5>\r\n        </div>\r\n        <div id=\"collapsePhotoId\" class=\"accordion-collapse collapse\" aria-labelledby=\"helpphotoid\" data-bs-parent=\"#helpaccordion\">\r\n            <div class=\"accordion-body\">\r\n                <p>If you don't know the name of the plant, you can upload photographs instead, our experts will try to identify it for you.</p>\r\n                <p>Your photos should include a picture of the whole plant and also close-up views of the leaves and flowers. Take photographs from the side (it's harder to identify plants from above)</p>\r\n                <p>Please only choose to name plants that you can identify with confidence and avoid being overprecise unless you are certain (e.g. don't pick a sub-species if you only know the plant well at species level).</p>\r\n                <p>Some common flowers such Dandelion (<i>Taraxacum</i> sp.) can't usually be identified precisely at this time of year, so please record them only at genus level (i.e. as 'Dandelion' / '<i>Taraxacum</i>').</p>\r\n            </div>\r\n        </div>\r\n    </div>\r\n    <div class=\"accordion-item\">\r\n    <div class=\"accordion-header\" id=\"helpheadingThree\">\r\n        <h5 class=\"mb-0\">\r\n            <button class=\"accordion-button collapsed\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#collapseThree\" aria-expanded=\"false\" aria-controls=\"collapseThree\">\r\n                Locating records (grid-references)\r\n            </button>\r\n        </h5>\r\n    </div>\r\n    <div id=\"collapseThree\" class=\"accordion-collapse collapse\" aria-labelledby=\"helpheadingThree\" data-bs-parent=\"#helpaccordion\">\r\n        <div class=\"accordion-body\">\r\n            <p>If using the recording form on a mobile device in the field then please enable GPS (the button near the location field).</p>\r\n            <p>Otherwise you could type in a OS grid-reference if you know it, or enter a place name or postcode.</p>\r\n            <p>You don't need to set a location for each record, as they will otherwise use the default for the list.</p>\r\n        </div>\r\n    </div>\r\n</div>\r\n    <div class=\"accordion-item\">\r\n        <div class=\"accordion-header\" id=\"helpheadingMultilist\">\r\n            <h5 class=\"mb-0\">\r\n                <button class=\"accordion-button collapsed\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#collapseMultilist\" aria-expanded=\"false\" aria-controls=\"collapseMultilist\">\r\n                    Can I send more than one list.\r\n                </button>\r\n            </h5>\r\n        </div>\r\n        <div id=\"collapseMultilist\" class=\"accordion-collapse collapse\" aria-labelledby=\"helpheadingMultilist\" data-bs-parent=\"#helpaccordion\">\r\n            <div class=\"accordion-body\">\r\n                <p>Yes! We'd welcome multiple lists. If you survey on more than one day or conduct two separate surveys on the same day (e.g. one in morning and then another somewhere else in the afternoon) then send separate lists.</p>\r\n                <p>We prefer lists to be equivalent to the area that someone might cover on foot. If driving some distance between sites, please use a separate list for each location.</p>\r\n                <p>You can start a new list or switch between your lists using the options on the 'Your lists' menu.</p>\r\n            </div>\r\n        </div>\r\n    </div>\r\n    <div class=\"accordion-item\">\r\n        <div class=\"accordion-header\" id=\"helpheadingSave\">\r\n            <h5 class=\"mb-0\">\r\n                <button class=\"accordion-button collapsed\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#collapseSave\" aria-expanded=\"false\" aria-controls=\"collapseSave\">\r\n                    How do I save my list?\r\n                </button>\r\n            </h5>\r\n        </div>\r\n        <div id=\"collapseSave\" class=\"accordion-collapse collapse\" aria-labelledby=\"helpheadingSave\" data-bs-parent=\"#helpaccordion\">\r\n            <div class=\"accordion-body\">\r\n                <p>The recording form will try to save your records automatically as you go along.</p>\r\n                <p>If your network connection fails then records will be stored locally on your device until you are connected to the internet again. If you have added lots of images then saving may take a few minutes.</p>\r\n                <p>If records are missing from your list on the results page, then please re-open the recording form to allow any unsaved data to be sent. You can also trigger a save using this link (or by choosing âsave allâ from the lists menu of the recording form).</p>\r\n            </div>\r\n        </div>\r\n    </div>\r\n    <div class=\"accordion-item\">\r\n        <div class=\"accordion-header\" id=\"helpheadingFour\">\r\n            <h5 class=\"mb-0\">\r\n                <button class=\"accordion-button collapsed\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#collapseFour\" aria-expanded=\"false\" aria-controls=\"collapseThree\">\r\n                    Help and support\r\n                </button>\r\n            </h5>\r\n        </div>\r\n        <div id=\"collapseFour\" class=\"accordion-collapse collapse\" aria-labelledby=\"helpheadingFour\" data-bs-parent=\"#helpaccordion\">\r\n            <div class=\"accordion-body\">\r\n                <p>If you encounter problems, would like to provide feedback about the survey or for more information about the plant hunt, please contact\r\n                    <a href=\"mailto:nyplanthunt@bsbi.org\">nyplanthunt@bsbi.org</a>.\r\n                </p>\r\n            </div>\r\n        </div>\r\n    </div>\r\n    <div class=\"accordion-item\">\r\n        <div class=\"accordion-header\" id=\"helpheadingFive\">\r\n            <h5 class=\"mb-0\">\r\n                <button class=\"accordion-button collapsed\" type=\"button\" data-bs-toggle=\"collapse\" data-bs-target=\"#collapseFive\" aria-expanded=\"false\" aria-controls=\"collapseThree\">\r\n                    About us\r\n                </button>\r\n            </h5>\r\n        </div>\r\n        <div id=\"collapseFive\" class=\"accordion-collapse collapse\" aria-labelledby=\"helpheadingFive\" data-bs-parent=\"#helpaccordion\">\r\n            <div class=\"accordion-body\">\r\n                The New Year Plant Hunt is run by the <a href=\"https://bsbi.org/\" target=\"_blank\" title=\"BSBI\">Botanical Society of Britain and Ireland</a>.\r\n                <p>For more information, please contact <a href=\"mailto:nyplanthunt@bsbi.org\">nyplanthunt@bsbi.org</a>.</p>\r\n                <p>Follow us on twitter <a href=\"https://twitter.com/NYPlantHunt\" target=\"_blank\">@NYPlantHunt</a></p>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n<!-- end: templates/helpPage.html -->\r\n";

  var HelpView = /*#__PURE__*/function (_Page) {
    _inherits(HelpView, _Page);

    var _super = _createSuper(HelpView);

    function HelpView() {
      _classCallCheck(this, HelpView);

      return _super.apply(this, arguments);
    }

    _createClass(HelpView, [{
      key: "body",
      value: function body() {
        // at this point the entire content of #body should be safe to replace
        var bodyEl = document.getElementById('body');
        bodyEl.innerHTML = htmlContent + "<p>Version 1.0.3.1649239755</p>";
      }
    }]);

    return HelpView;
  }(xe);

  var nyphNewSurveyModal = "<!-- begin: templates/nyphNewSurveyModal.html -->\r\n<div class=\"modal fade\" id=\"newsurveymodal\" tabindex=\"-1\" role=\"dialog\" aria-labelledby=\"newsurveymodalTitle\" aria-hidden=\"true\">\r\n    <div class=\"modal-dialog modal-dialog-centered\" role=\"document\">\r\n        <div class=\"modal-content\">\r\n            <div class=\"modal-header\">\r\n                <h5 class=\"modal-title\" id=\"newsurveymodalTitle\">Start a new survey?</h5>\r\n                <button type=\"button\" class=\"close\" data-bs-dismiss=\"modal\" aria-label=\"Close\">\r\n                    <span aria-hidden=\"true\">&times;</span>\r\n                </button>\r\n            </div>\r\n            <div class=\"modal-body\">\r\n                Please confirm that you wish to start a new survey.\r\n            </div>\r\n            <div class=\"modal-footer\">\r\n                <button type=\"button\" class=\"btn btn-secondary\" data-bs-dismiss=\"modal\">Back</button>\r\n                <button type=\"button\" class=\"btn btn-danger\" data-bs-dismiss=\"modal\" id=\"newsurveymodalconfirmed\">New survey</button>\r\n            </div>\r\n        </div>\r\n    </div>\r\n</div>\r\n<!-- end: templates/nyphNewSurveyModal.html -->\r\n";

  var NyphLayout = /*#__PURE__*/function (_Layout) {
    _inherits(NyphLayout, _Layout);

    var _super = _createSuper(NyphLayout);

    function NyphLayout() {
      var _this;

      _classCallCheck(this, NyphLayout);

      for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {
        args[_key] = arguments[_key];
      }

      _this = _super.call.apply(_super, [this].concat(args));

      _defineProperty(_assertThisInitialized(_this), "surveysMenuId", 'surveysmenu');

      _defineProperty(_assertThisInitialized(_this), "newSurveyLabel", 'start new list');

      _defineProperty(_assertThisInitialized(_this), "newSurveyContent", nyphNewSurveyModal);

      return _this;
    }

    return _createClass(NyphLayout);
  }(ye);

  // if (!Promise.prototype.finally) {
  //     Promise.prototype.finally = function(callback) {
  //         return this.then(callback)
  //             .catch(callback);
  //     };
  // }
  // even though Rollup is bundling all your files together, errors and
  // logs will still point to your original source modules

  console.log('if you have sourcemaps enabled in your devtools, click on main.js:5 -->'); // mainly aiming to determine whether '/app/' or '/testapp/'

  var pathPrefix = window.location.pathname.split('/')[1];
  console.log({
    pathPrefix: pathPrefix
  });

  if (navigator.serviceWorker) {
    // kill after 2022-03-01 to prevent the app perpetuating itself
    if (new Date().toJSON().slice(0, 10) >= '2022-03-01') {
      navigator.serviceWorker.getRegistrations().then(function (registrations) {
        var _iterator = _createForOfIteratorHelper(registrations),
            _step;

        try {
          for (_iterator.s(); !(_step = _iterator.n()).done;) {
            var registration = _step.value;
            registration.unregister();
          }
        } catch (err) {
          _iterator.e(err);
        } finally {
          _iterator.f();
        }
      });
    } else {
      // Register the ServiceWorker limiting its action to those URL starting
      // by 'controlled'. The scope is not a path but a prefix. First, it is
      // converted into an absolute URL, then used to determine if a page is
      // controlled by testing it is a prefix of the request URL.
      navigator.serviceWorker.register("/".concat(pathPrefix, "/serviceworker.js"), {// scope: './controlled'
      });
      navigator.serviceWorker.addEventListener('controllerchange', function () {
        window.location.reload();
      });
    }
  }

  var app = new NyphApp();
  app.router = new f("https://nyph.bsbi.app/".concat(pathPrefix, "/"));
  app.containerId = 'appcontainer';
  app.setLayout(new NyphLayout());
  app.registerController(new y$1(new HelpView(), '/help'));
  app.registerController(new MainController(new MainView()));
  app.registerController(new S$1(new ve()));
  app.setLocalForageName(NyphApp.forageName); // test detection of cameras
  // see https://stackoverflow.com/questions/23288918/check-if-user-has-webcam-or-not-using-javascript-only
  // navigator.mediaDevices.enumerateDevices()
  //     .then(function(devices) {
  //         devices.forEach(function(device) {
  //             console.log(device.kind + ": " + device.label +
  //                 " id = " + device.deviceId);
  //         });
  //     });

  app.restoreOccurrences().then(function (result) {
    console.log({
      'result from restoreOccurrences': result
    });
  }, function (result) {
    console.log({
      'failed result from restoreOccurrences': result
    });
  }).finally(function () {
    // the taxon list may be slow to load
    $$8.onceTaxaLoaded().then(function () {
      app.initialise();
      app.display();
    });
  });

})();
//# sourceMappingURL=app.js.map
