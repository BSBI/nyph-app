const e=Math.PI/180,t=180/Math.PI;class r{lat;lng;constructor(e,t){this.lat=e,this.lng=t}static _transform(t,n,s,i,o,a,c,S,l,d,u,h,N,f){const p=1e-6*f;let T=s/Math.sqrt(1-i*(Math.sin(t)*Math.sin(t)));const g=(T+o)*Math.cos(t)*Math.cos(n),v=(T+o)*Math.cos(t)*Math.sin(n),y=((1-i)*T+o)*Math.sin(t),m=u/3600*e,E=h/3600*e,_=N/3600*e,b=g+g*p-v*_+y*E+S,I=g*_+v+v*p-y*m+l,C=-1*g*E+v*m+y+y*p+d;n=Math.atan(I/b);const M=Math.sqrt(b*b+I*I);t=Math.atan(C/(M*(1-c))),T=a/Math.sqrt(1-c*(Math.sin(t)*Math.sin(t)));let O=1,L=0;for(;O>.001;)L=Math.atan((C+c*T*Math.sin(t))/M),O=Math.abs(L-t),t=L;return new r(t,n)}static _Marc(e,t,r,n){return e*((1+t+5/4*(t*t)+5/4*(t*t*t))*(n-r)-(3*t+t*t*3+21/8*(t*t*t))*Math.sin(n-r)*Math.cos(n+r)+(15/8*(t*t)+15/8*(t*t*t))*Math.sin(2*(n-r))*Math.cos(2*(n+r))-35/24*(t*t*t)*Math.sin(3*(n-r))*Math.cos(3*(n+r)))}}class n extends r{constructor(e,t){super(e,t)}}class s extends r{constructor(e,t){super(e,t)}to_WGS84(){let r=6377563.396,s=.00667054007;const i=this.lat*e,o=Math.sin(i),a=this.lng*e,c=r/Math.sqrt(1-s*(o*o)),S=c*Math.cos(i)*Math.cos(a),l=c*Math.cos(i)*Math.sin(a),d=(1-s)*c*o,u=-204894e-10,h=7.28190110241429e-7,N=119748977294801e-20,f=446.448+S*(1+u)+-h*l+N*d,p=408261589226812e-20*S-124.157+l*(1+u)+-h*d,T=542.06+-N*S+h*l+d*(1+u);r=6378137,s=.00669438003;const g=Math.sqrt(f*f+p*p);let v=Math.atan(T/(g*(1-s)));for(let e=1;e<10;++e){let e=Math.sin(v);v=Math.atan((T+s*(r/Math.sqrt(1-s*(e*e)))*e)/g)}return new n(t*v,t*Math.atan(p/f))}static from_wgs84(r){const n=r.lat*e,i=r.lng*e,o=.00669438037928458,a=.0066705397616,c=20.4894*1e-6;let S=6378137/Math.sqrt(1-o*Math.sin(n)*Math.sin(n));const l=(S+0)*Math.cos(n)*Math.cos(i),d=(S+0)*Math.cos(n)*Math.sin(i),u=((1-o)*S+0)*Math.sin(n),h=-.1502/3600*e,N=-.247/3600*e,f=-.8421/3600*e,p=l+l*c-d*f+u*N-446.448,T=l*f+d+d*c-u*h+125.157,g=-1*l*N+d*h+u+u*c+-542.06,v=Math.atan(T/p),y=Math.sqrt(p*p+T*T);let m=Math.atan(g/(y*(1-a)));S=6377563.396/Math.sqrt(1-a*(Math.sin(m)*Math.sin(m)));let E=1,_=0;for(;E>.001;)_=Math.atan((g+a*S*Math.sin(m))/y),E=Math.abs(_-m),m=_;return new s(m*t,v*t)}}class i extends r{constructor(e,t){super(e,t)}to_WGS84(){const s=r._transform(this.lat*e,this.lng*e,6377340.189,.00667054015,0,6378137,.00669438037928458,482.53,-130.596,564.557,-1.042,-.214,-.631,-8.15);return new n(s.lat*t,s.lng*t)}static from_wgs84(n){const s=n.lat*e,o=n.lng*e,a=r._transform(s,o,6378137,.00669438037928458,0,6377340.189,.00667054015,-482.53,130.596,-564.557,1.042,.214,.631,8.15);return new i(a.lat*t,a.lng*t)}}class o extends r{constructor(e,t){super(e,t)}static from_wgs84(n){const s=n.lat*e,i=n.lng*e,a=r._transform(s,i,6378137,.00669438037928458,0,6378388,.0067226700223333,83.901,98.127,118.635,0,0,0,0);return new o(a.lat*t,a.lng*t)}}class a{x;y;constructor(){}to_latLng(){}to_gridref(e){}to_hectad(){}static tetradLetters="ABCDEFGHIJKLMNPQRSTUVWXYZ";static tetradLettersRowFirst="AFKQVBGLRWCHMSXDINTYEJPUZ";static from_latlng(e,t){if(t>=-8.74&&e>49.88){const r=a._from_gb_latlng(s.from_wgs84(new n(e,t)));if(r.x>=0&&r.is_gb_hectad())return r}if(t<-5.3&&e>51.34&&t>-11&&e<55.73){const r=a._from_ie_latlng(i.from_wgs84(new n(e,t)));return r.x<0||r.y<0?null:r}{const r=a._from_ci_latlng(o.from_wgs84(new n(e,t)));if(r.x>=5e5&&r.x<6e5&&r.y>=54e5&&r.y<56e5)return r}return null}static _from_gb_latlng(t){const n=t.lat*e,s=t.lng*e,i=.9996012717,o=.0066705397616,a=6377563.396*i,c=6356256.91*i,l=Math.sin(n)*Math.sin(n),d=a/Math.sqrt(1-o*l),u=d*(1-o)/(1-o*l),h=d/u-1,N=s- -.03490658503988659,f=d*Math.cos(n),p=Math.pow(Math.cos(n),3),T=Math.tan(n)*Math.tan(n),g=d/6*p*(d/u-T),v=Math.pow(Math.cos(n),5),y=Math.pow(Math.tan(n),4),m=d/120*v*(5-18*T+y+14*h-58*T*h),E=4e5+N*f+Math.pow(N,3)*g+Math.pow(N,5)*m,_=r._Marc(c,.0016732202503250907,.8552113334772214,n)+-1e5,b=d/2*Math.sin(n)*Math.cos(n),I=d/24*Math.sin(n)*Math.pow(Math.cos(n),3)*(5-Math.pow(Math.tan(n),2)+9*h),C=d/720*Math.sin(n)*v*(61-58*T+y),M=_+N*N*b+Math.pow(N,4)*I+Math.pow(N,6)*C;return new S(Math.round(E),Math.round(M))}static _from_ie_latlng(t){const n=t.lat*e,s=t.lng*e,i=1.000035,o=.00667054015,a=6377340.189*i,c=6356034.447*i,S=Math.sin(n)*Math.sin(n),d=a/Math.sqrt(1-o*S),u=d*(1-o)/(1-o*S),h=d/u-1,N=s- -.13962634015954636,f=d*Math.cos(n),p=Math.pow(Math.cos(n),3),T=Math.tan(n)*Math.tan(n),g=d/6*p*(d/u-T),v=Math.pow(Math.cos(n),5),y=Math.pow(Math.tan(n),4),m=d/120*v*(5-18*T+y+14*h-58*T*h),E=2e5+N*f+Math.pow(N,3)*g+Math.pow(N,5)*m,_=r._Marc(c,.0016732203841520518,.9337511498169663,n)+25e4,b=d/2*Math.sin(n)*Math.cos(n),I=d/24*Math.sin(n)*Math.pow(Math.cos(n),3)*(5-Math.pow(Math.tan(n),2)+9*h),C=d/720*Math.sin(n)*v*(61-58*T+y),M=_+N*N*b+Math.pow(N,4)*I+Math.pow(N,6)*C;return new l(Math.round(E),Math.round(M))}static _from_ci_latlng(t){const n=t.lat*e,s=t.lng*e,i=.9996,o=.0067226700223333,a=6378388*i,c=6356911.946*i,S=Math.sin(n)*Math.sin(n),l=a/Math.sqrt(1-o*S),u=l*(1-o)/(1-o*S),h=l/u-1,N=s- -.0523598775598,f=l*Math.cos(n),p=Math.pow(Math.cos(n),3),T=Math.tan(n)*Math.tan(n),g=l/6*p*(l/u-T),v=Math.pow(Math.cos(n),5),y=Math.pow(Math.tan(n),4),m=l/120*v*(5-18*T+y+14*h-58*T*h),E=5e5+N*f+Math.pow(N,3)*g+Math.pow(N,5)*m,_=r._Marc(c,.0016863406508729017,0,n)+0,b=l/2*Math.sin(n)*Math.cos(n),I=l/24*Math.sin(n)*Math.pow(Math.cos(n),3)*(5-Math.pow(Math.tan(n),2)+9*h),C=l/720*Math.sin(n)*v*(61-58*T+y),M=_+N*N*b+Math.pow(N,4)*I+Math.pow(N,6)*C;return new d(Math.round(E),Math.round(M))}static calculate_tetrad(e,t){return e>=0&&t>=0?a.tetradLetters.charAt(5*Math.floor(e%1e4/2e3)+Math.floor(t%1e4/2e3)):""}tetradLetter(){return this.x>=0&&this.y>=0?a.tetradLetters.charAt(5*Math.floor(this.x%1e4/2e3)+Math.floor(this.y%1e4/2e3)):""}toString(){return this.x+","+this.y}}const c=function(e,t,r,n){let s="00000"+Math.floor(t),i="00000"+Math.floor(r);if(2e3===n)return e+s.charAt(s.length-5)+i.charAt(i.length-5)+a.calculate_tetrad(t,r);if(1e5===n)return e;{5e3===n&&(n=1e4);let t=Math.round(Math.log10(n));return e+(t?s.slice(-5,-t)+i.slice(-5,-t):s.slice(-5)+i.slice(-5))}};class S extends a{gridCoords=null;constructor(e,t){super(),this.x=0|e,this.y=0|t}country="GB";static gbHectads="SV80SV81SV90SV91SW32SW33SW42SW43SW44SW52SW53SW54SW61SW62SW63SW64SW65SW71SW72SW73SW74SW75SW76SW81SW82SW83SW84SW85SW86SW87SW95SW96SW97SS10SS11SS20SS21SS30SW83SW84SW85SW93SW94SW95SW96SW97SW98SX03SX04SX05SX06SX07SX08SX09SX14SX15SX16SX17SX18SX19SX25SX26SX27SX28SX29SX35SX36SX37SX38SX39SX44SX45SX46SX47SS70SS80SS81SS90SS91ST00ST01ST10ST11ST20ST21ST30SX37SX44SX45SX46SX47SX48SX54SX55SX56SX57SX58SX63SX64SX65SX66SX67SX68SX69SX73SX74SX75SX76SX77SX78SX79SX83SX84SX85SX86SX87SX88SX89SX94SX95SX96SX97SX98SX99SY07SY08SY09SY18SY19SY28SY29SY38SY39SS14SS20SS21SS22SS30SS31SS32SS40SS41SS42SS43SS44SS50SS51SS52SS53SS54SS60SS61SS62SS63SS64SS70SS71SS72SS73SS74SS75SS80SS81SS82SS83SS91SS92ST01ST02SX28SX29SX37SX38SX39SX48SX49SX58SX59SX68SX69SX79SS73SS74SS82SS83SS84SS92SS93SS94ST01ST02ST03ST04ST11ST12ST13ST14ST20ST21ST22ST23ST24ST25ST30ST31ST32ST33ST34ST40ST41ST42ST50ST51ST52ST61ST62ST71ST72ST24ST25ST26ST32ST33ST34ST35ST36ST37ST42ST43ST44ST45ST46ST47ST52ST53ST54ST55ST56ST57ST62ST63ST64ST65ST66ST67ST72ST73ST74ST75ST76ST77ST83ST84ST85ST86SP00SP10ST76ST77ST85ST86ST87ST88ST89ST96ST97ST98ST99SU06SU07SU08SU09SU16SU17SU18SU19SU26SU27SU28SU29SU36SU37ST73ST74ST75ST76ST82ST83ST84ST85ST86ST91ST92ST93ST94ST95ST96SU01SU02SU03SU04SU05SU06SU11SU12SU13SU14SU15SU16SU21SU22SU23SU24SU25SU26SU31SU32SU34SU35SU36ST20ST30ST40ST50ST51ST60ST61ST70ST71ST72ST73ST80ST81ST82ST83ST90ST91ST92SU00SU01SU02SU10SU11SY39SY48SY49SY58SY59SY66SY67SY68SY69SY77SY78SY79SY87SY88SY89SY97SY98SY99SZ07SZ08SZ09SZ28SZ38SZ39SZ47SZ48SZ49SZ57SZ58SZ59SZ68SZ69SU00SU01SU02SU10SU11SU12SU20SU21SU22SU23SU30SU31SU32SU33SU40SU41SU42SU43SU50SU51SU52SU60SU61SU62SU70SU71SU72SZ08SZ09SZ19SZ29SZ38SZ39SZ49SZ59SZ69SZ79SU23SU24SU25SU33SU34SU35SU36SU42SU43SU44SU45SU46SU52SU53SU54SU55SU56SU62SU63SU64SU65SU66SU72SU73SU74SU75SU76SU82SU83SU84SU85SU86SU70SU71SU72SU80SU81SU82SU83SU90SU91SU92SU93SZ79SZ89SZ99TQ00TQ01TQ02TQ03TQ10TQ11TQ12TQ13TQ20TQ21TQ22TQ23TQ30TQ31TQ32TQ20TQ21TQ22TQ23TQ30TQ31TQ32TQ33TQ40TQ41TQ42TQ43TQ44TQ50TQ51TQ52TQ53TQ54TQ60TQ61TQ62TQ63TQ70TQ71TQ72TQ80TQ81TQ82TQ91TQ92TV49TV59TV69TQ65TQ72TQ73TQ74TQ75TQ76TQ77TQ82TQ83TQ84TQ85TQ86TQ87TQ91TQ92TQ93TQ94TQ95TQ96TQ97TR01TR02TR03TR04TR05TR06TR07TR12TR13TR14TR15TR16TR23TR24TR25TR26TR27TR33TR34TR35TR36TR37TR46TR47TQ35TQ36TQ37TQ38TQ43TQ44TQ45TQ46TQ47TQ48TQ53TQ54TQ55TQ56TQ57TQ58TQ63TQ64TQ65TQ66TQ67TQ72TQ73TQ74TQ75TQ76TQ77TQ78TQ87TQ88TQ97SU83SU84SU85SU86SU93SU94SU95SU96SU97TQ03TQ04TQ05TQ06TQ07TQ13TQ14TQ15TQ16TQ17TQ23TQ24TQ25TQ26TQ27TQ33TQ34TQ35TQ36TQ37TQ38TQ43TQ44TQ45TL30TL40TL50TL60TL70TL80TL90TM00TQ38TQ39TQ47TQ48TQ49TQ57TQ58TQ59TQ67TQ68TQ69TQ77TQ78TQ79TQ88TQ89TQ98TQ99TR08TR09TR19TL30TL31TL34TL40TL41TL42TL43TL44TL50TL51TL52TL53TL54TL60TL61TL62TL63TL64TL70TL71TL72TL73TL74TL80TL81TL82TL83TL84TL90TL91TL92TL93TM01TM02TM03TM11TM12TM13TM21TM22TM23TQ49SP81SP90SP91TL00TL01TL02TL10TL11TL12TL13TL20TL21TL22TL23TL24TL30TL31TL32TL33TL34TL41TL42TL43TL44TL51TL52TQ09TQ19TQ29TQ39TL20TL30TQ06TQ07TQ08TQ09TQ16TQ17TQ18TQ19TQ27TQ28TQ29TQ37TQ38TQ39SP20SP30SP40SP41SP50SU19SU26SU27SU28SU29SU36SU37SU38SU39SU46SU47SU48SU49SU56SU57SU58SU59SU66SU67SU68SU69SU76SU77SU78SU86SU87SU88SU96SU97SU98SP10SP20SP21SP22SP23SP30SP31SP32SP33SP34SP40SP41SP42SP43SP44SP45SP50SP51SP52SP53SP54SP60SP61SP62SP63SP70SU29SU39SU49SU57SU58SU59SU67SU68SU69SU77SU78SU79SP51SP53SP60SP61SP62SP63SP64SP70SP71SP72SP73SP74SP80SP81SP82SP83SP84SP85SP90SP91SP92SP93SP94SP95SU78SU79SU88SU89SU97SU98SU99TL00TL01TQ07TQ08TQ09TG40TG50TM03TM04TM05TM06TM07TM13TM14TM15TM16TM17TM23TM24TM25TM26TM27TM28TM33TM34TM35TM36TM37TM38TM39TM44TM45TM46TM47TM48TM49TM57TM58TM59TL64TL65TL66TL67TL68TL74TL75TL76TL77TL78TL83TL84TL85TL86TL87TL88TL93TL94TL95TL96TL97TL98TM03TM04TM05TM06TM07TM08TG00TG01TG02TG03TG04TG10TG11TG12TG13TG14TG20TG21TG22TG23TG24TG30TG31TG32TG33TG40TG41TG42TG50TG51TM07TM08TM09TM17TM18TM19TM27TM28TM29TM38TM39TM49TM59TF40TF41TF42TF50TF51TF52TF53TF60TF61TF62TF63TF64TF70TF71TF72TF73TF74TF80TF81TF82TF83TF84TF90TF91TF92TF93TF94TG00TG01TG02TG03TG04TL49TL59TL68TL69TL78TL79TL87TL88TL89TL98TL99TM07TM08TM09TF20TF30TF31TF40TF41TF50TL15TL19TL23TL24TL25TL26TL28TL29TL33TL34TL35TL36TL37TL38TL39TL44TL45TL46TL47TL48TL49TL54TL55TL56TL57TL58TL59TL63TL64TL65TL66TL67TL68TL69TL75TL76SP91SP92SP93SP94SP95SP96TL01TL02TL03TL04TL05TL06TL07TL11TL12TL13TL14TL15TL16TL23TL24TL25TL06TL07TL08TL09TL15TL16TL17TL18TL19TL25TL26TL27TL28TL29TL36TL37TL38TL39SK90SP43SP44SP45SP46SP53SP54SP55SP56SP57SP58SP63SP64SP65SP66SP67SP68SP73SP74SP75SP76SP77SP78SP79SP84SP85SP86SP87SP88SP89SP95SP96SP97SP98SP99TF00TF10TF20TL06TL07TL08TL09TL18TL19TL29SO70SO71SO80SO81SO82SO83SO90SO91SO92SO93SO94SP00SP01SP02SP03SP04SP10SP11SP12SP13SP14SP15SP20SP21SP22SP23SP24SP25ST99SU09SU19SU29SO50SO51SO60SO61SO62SO63SO70SO71SO72SO73SO80SO81SO82SO83SO90ST57ST58ST59ST66ST67ST68ST69ST76ST77ST78ST79ST87ST88ST89ST98ST99SO10SO11SO20SO21SO22SO23SO30SO31SO32SO40SO41SO42SO50SO51ST18ST19ST27ST28ST29ST37ST38ST39ST47ST48ST49ST58ST59SO22SO23SO24SO25SO26SO32SO33SO34SO35SO36SO37SO41SO42SO43SO44SO45SO46SO47SO51SO52SO53SO54SO55SO56SO57SO61SO62SO63SO64SO65SO66SO73SO74SO75SO76SO56SO64SO65SO66SO67SO72SO73SO74SO75SO76SO77SO78SO82SO83SO84SO85SO86SO87SO88SO93SO94SO95SO96SO97SO98SO99SP03SP04SP05SP06SP07SP08SP13SP14SP16SP17SP18SK10SK20SK30SP04SP05SP06SP07SP08SP09SP14SP15SP16SP17SP18SP19SP22SP23SP24SP25SP26SP27SP28SP29SP33SP34SP35SP36SP37SP38SP39SP44SP45SP46SP47SP48SP49SP55SP56SP57SP58SJ63SJ70SJ71SJ72SJ73SJ74SJ75SJ80SJ81SJ82SJ83SJ84SJ85SJ86SJ90SJ91SJ92SJ93SJ94SJ95SJ96SK00SK01SK02SK03SK04SK05SK06SK10SK11SK12SK13SK14SK15SK16SK20SK21SK22SO77SO78SO79SO88SO89SO98SO99SP08SP09SP19SP29SJ20SJ21SJ22SJ23SJ30SJ31SJ32SJ33SJ34SJ40SJ41SJ42SJ43SJ50SJ51SJ52SJ53SJ54SJ60SJ61SJ62SJ63SJ64SJ70SJ71SJ72SJ73SJ74SJ80SO17SO18SO27SO28SO29SO37SO38SO39SO46SO47SO48SO49SO56SO57SO58SO59SO66SO67SO68SO69SO77SO78SO79SO88SO89SN50SN60SN61SN70SN71SN80SN81SN90SO00SO01SO10SO11SS38SS39SS48SS49SS58SS59SS68SS69SS77SS78SS79SS87SS88SS89SS96SS97SS98SS99ST06ST07ST08ST09ST16ST17ST18ST19ST26ST27ST28SN70SN71SN74SN80SN81SN82SN83SN84SN85SN86SN90SN91SN92SN93SN94SN95SN96SO00SO01SO02SO03SO04SO05SO06SO10SO11SO12SO13SO14SO21SO22SO23SO24SN86SN87SN96SN97SO04SO05SO06SO07SO08SO13SO14SO15SO16SO17SO18SO24SO25SO26SO27SO36SO37SN01SN02SN10SN11SN12SN20SN21SN22SN23SN24SN30SN31SN32SN33SN34SN40SN41SN42SN43SN44SN50SN51SN52SN53SN54SN60SN61SN62SN63SN64SN65SN71SN72SN73SN74SN75SN81SN82SN83SN84SS39SS49SS59SM50SM62SM70SM71SM72SM73SM80SM81SM82SM83SM84SM90SM91SM92SM93SM94SN00SN01SN02SN03SN04SN10SN11SN12SN13SN14SN22SN23SN24SR89SR99SS09SS19SN14SN15SN24SN25SN33SN34SN35SN36SN44SN45SN46SN54SN55SN56SN57SN58SN64SN65SN66SN67SN68SN69SN74SN75SN76SN77SN78SN79SN84SN85SN86SN87SN88SN89SH70SH71SH80SH81SH90SH91SH92SJ00SJ01SJ02SJ03SJ10SJ11SJ12SJ20SJ21SJ22SJ31SN69SN78SN79SN87SN88SN89SN97SN98SN99SO07SO08SO09SO18SO19SO28SO29SO39SH50SH51SH52SH53SH54SH60SH61SH62SH63SH64SH70SH71SH72SH73SH74SH80SH81SH82SH83SH84SH91SH92SH93SH94SH95SJ03SJ04SJ05SJ13SJ14SN59SN69SN79SH12SH13SH22SH23SH24SH32SH33SH34SH43SH44SH45SH46SH53SH54SH55SH56SH57SH64SH65SH66SH67SH74SH75SH76SH77SH78SH84SH85SH86SH87SH88SH74SH75SH76SH77SH84SH85SH86SH87SH88SH94SH95SH96SH97SH98SJ02SJ03SJ04SJ05SJ06SJ07SJ08SJ12SJ13SJ14SJ15SJ16SJ17SJ22SJ23SJ24SJ25SJ26SJ33SJ34SJ35SJ43SJ44SJ45SJ53SJ54SH97SH98SJ06SJ07SJ08SJ15SJ16SJ17SJ18SJ25SJ26SJ27SJ35SJ36SJ37SH27SH28SH29SH36SH37SH38SH39SH46SH47SH48SH49SH56SH57SH58SH59SH67SH68SK81SK82SK83SK84SK85SK86SK87SK90SK91SK92SK93SK94SK95SK96SK97TF00TF01TF02TF03TF04TF05TF06TF07TF10TF11TF12TF13TF14TF15TF16TF17TF20TF21TF22TF23TF24TF25TF30TF31TF32TF33TF34TF41TF42TF43TF44TF52SE60SE70SE71SE80SE81SE82SE90SE91SE92SK78SK79SK87SK88SK89SK97SK98SK99TA00TA01TA02TA10TA11TA12TA20TA21TA30TA31TA40TF07TF08TF09TF15TF16TF17TF18TF19TF24TF25TF26TF27TF28TF29TF33TF34TF35TF36TF37TF38TF39TF43TF44TF45TF46TF47TF48TF49TF54TF55TF56TF57TF58SK20SK21SK30SK31SK32SK40SK41SK42SK43SK50SK51SK52SK60SK61SK62SK70SK71SK72SK73SK74SK80SK81SK82SK83SK84SK90SK91SP39SP48SP49SP57SP58SP59SP68SP69SP78SP79SP89SP99TF00TF01SE60SE70SK42SK43SK44SK45SK46SK52SK53SK54SK55SK56SK57SK58SK59SK62SK63SK64SK65SK66SK67SK68SK69SK72SK73SK74SK75SK76SK77SK78SK79SK84SK85SK86SK87SK88SK89SK97SJ98SJ99SK03SK06SK07SK08SK09SK11SK12SK13SK14SK15SK16SK17SK18SK19SK21SK22SK23SK24SK25SK26SK27SK28SK31SK32SK33SK34SK35SK36SK37SK38SK42SK43SK44SK45SK46SK47SK48SK53SK56SK57SD90SE00SE10SJ18SJ19SJ27SJ28SJ29SJ35SJ36SJ37SJ38SJ39SJ44SJ45SJ46SJ47SJ48SJ54SJ55SJ56SJ57SJ58SJ63SJ64SJ65SJ66SJ67SJ68SJ69SJ74SJ75SJ76SJ77SJ78SJ79SJ85SJ86SJ87SJ88SJ89SJ96SJ97SJ98SJ99SK06SK07SK08SK09SK19SD20SD21SD22SD30SD31SD32SD40SD41SD42SD50SD51SD52SD53SD60SD61SD62SD63SD70SD71SD72SD73SD74SD80SD81SD82SD83SD84SD90SD91SD92SD93SD94SJ29SJ38SJ39SJ48SJ49SJ58SJ59SJ68SJ69SJ79SJ88SJ89SJ99SD22SD23SD32SD33SD34SD35SD36SD42SD43SD44SD45SD46SD47SD52SD53SD54SD55SD56SD57SD63SD64SD65SD66SD67SD68SD73SD78SE53SE54SE62SE63SE64SE65SE72SE73SE74SE75SE76SE82SE83SE84SE85SE86SE87SE92SE93SE94SE95SE96SE97SE98TA02TA03TA04TA05TA06TA07TA08TA12TA13TA14TA15TA16TA17TA18TA21TA22TA23TA24TA26TA27TA31TA32TA33TA41TA42NZ30NZ31NZ40NZ41NZ42NZ50NZ51NZ52NZ60NZ61NZ62NZ70NZ71NZ72NZ80NZ81NZ90NZ91SE37SE38SE39SE46SE47SE48SE49SE55SE56SE57SE58SE59SE64SE65SE66SE67SE68SE69SE75SE76SE77SE78SE79SE86SE87SE88SE89SE97SE98SE99TA08TA09TA18SD84SD90SD91SD92SD93SD94SD95SE00SE01SE02SE03SE04SE10SE11SE12SE13SE14SE20SE21SE22SE23SE30SE31SE32SE33SE40SE41SE42SE50SE51SE52SE60SE61SE62SE70SE71SE72SE81SE82SK18SK19SK28SK29SK38SK39SK47SK48SK49SK57SK58SK59SK69SD54SD55SD64SD65SD66SD67SD68SD73SD74SD75SD76SD77SD78SD84SD85SD86SD87SD88SD94SD95SD96SD97SD98SE04SE05SE06SE07SE13SE14SE15SE16SE17SE23SE24SE25SE26SE27SE32SE33SE34SE35SE36SE37SE42SE43SE44SE45SE46SE52SE53SE54SE55SE56SE62SE63SE64SE65SE72NY72NY80NY81NY82NY90NY91NY92NZ00NZ01NZ02NZ10NZ11NZ20NZ21NZ30NZ31SD68SD69SD78SD79SD88SD89SD97SD98SD99SE07SE08SE09SE17SE18SE19SE27SE28SE29SE36SE37SE38SE39SE46SE47NY73NY74NY82NY83NY84NY92NY93NY94NY95NZ01NZ02NZ03NZ04NZ05NZ11NZ12NZ13NZ14NZ15NZ16NZ20NZ21NZ22NZ23NZ24NZ25NZ26NZ30NZ31NZ32NZ33NZ34NZ35NZ36NZ41NZ42NZ43NZ44NZ45NZ46NZ52NZ53NT60NT70NT80NT90NU00NU10NU20NY58NY59NY64NY65NY66NY67NY68NY69NY74NY75NY76NY77NY78NY79NY84NY85NY86NY87NY88NY89NY94NY95NY96NY97NY98NY99NZ04NZ05NZ06NZ07NZ08NZ09NZ15NZ16NZ17NZ18NZ19NZ26NZ27NZ28NZ29NZ36NZ37NZ38NZ39NT70NT71NT73NT80NT81NT82NT83NT84NT90NT91NT92NT93NT94NT95NU00NU01NU02NU03NU04NU05NU10NU11NU12NU13NU14NU20NU21NU22NU23NZ09NZ19NY20NY21NY30NY31NY40NY41NY42NY50NY51NY52NY53NY60NY61NY62NY63NY70NY71NY72NY73NY80NY81NY82NY83SD16SD17SD18SD19SD26SD27SD28SD29SD36SD37SD38SD39SD46SD47SD48SD49SD57SD58SD59SD67SD68SD69SD78SD79SD89NX90NX91NX92NX93NY00NY01NY02NY03NY04NY05NY10NY11NY12NY13NY14NY15NY16NY20NY21NY22NY23NY24NY25NY26NY31NY32NY33NY34NY35NY36NY37NY41NY42NY43NY44NY45NY46NY47NY48NY52NY53NY54NY55NY56NY57NY58NY62NY63NY64NY65NY66NY67NY68NY73NY74NY75NY84SD08SD09SD17SD18SD19SD28SD29NX30NX40SC16SC17SC26SC27SC28SC36SC37SC38SC39SC47SC48SC49NS60NS61NS70NS71NS72NS80NS81NS90NT00NT01NT10NT11NT20NT21NT30NX69NX78NX79NX88NX89NX96NX97NX98NX99NY05NY06NY07NY08NY09NY16NY17NY18NY19NY26NY27NY28NY29NY36NY37NY38NY39NY47NY48NY49NS50NS60NX36NX37NX38NX45NX46NX47NX48NX49NX54NX55NX56NX57NX58NX59NX64NX65NX66NX67NX68NX69NX74NX75NX76NX77NX78NX79NX84NX85NX86NX87NX88NX95NX96NX97NX98NY05NY06NW95NW96NW97NX03NX04NX05NX06NX07NX13NX14NX15NX16NX17NX24NX25NX26NX27NX33NX34NX35NX36NX37NX43NX44NX45NX46NS00NS10NS14NS15NS16NS20NS21NS23NS24NS25NS26NS30NS31NS32NS33NS34NS35NS36NS40NS41NS42NS43NS44NS45NS50NS51NS52NS53NS54NS55NS60NS61NS62NS63NS64NS71NS72NS73NX07NX08NX09NX17NX18NX19NX27NX28NX29NX37NX38NX39NX48NX49NX59NS16NS17NS26NS27NS35NS36NS37NS44NS45NS46NS47NS54NS55NS56NS64NS65NS66NS53NS54NS55NS56NS57NS63NS64NS65NS66NS67NS71NS72NS73NS74NS75NS76NS77NS80NS81NS82NS83NS84NS85NS86NS87NS90NS91NS92NS93NS94NS95NS96NT00NT01NT02NT03NT04NT05NT14NT01NT02NT03NT04NT05NT11NT12NT13NT14NT15NT21NT22NT23NT24NT25NT32NT33NT34NT10NT11NT20NT21NT22NT23NT30NT31NT32NT33NT34NT41NT42NT43NT44NT53NT20NT30NT31NT40NT41NT42NT43NT44NT50NT51NT52NT53NT54NT60NT61NT62NT63NT64NT70NT71NT72NT73NT74NT81NT82NT83NY39NY47NY48NY49NY58NY59NY69NT44NT45NT46NT53NT54NT55NT56NT63NT64NT65NT66NT73NT74NT75NT76NT77NT83NT84NT85NT86NT87NT94NT95NT96NT36NT37NT45NT46NT47NT48NT55NT56NT57NT58NT65NT66NT67NT68NT76NT77NS95NS96NT05NT06NT15NT16NT17NT24NT25NT26NT27NT34NT35NT36NT37NT43NT44NT45NT46NS86NS87NS95NS96NS97NS98NT06NT07NT08NT16NT17NO00NO01NO10NO11NO20NO21NO22NO30NO31NO32NO40NO41NO42NO50NO51NO52NO60NO61NS99NT08NT09NT18NT19NT28NT29NT39NT49NT59NT69NN30NN31NN40NN41NS38NS39NS47NS48NS49NS57NS58NS59NS67NS68NS69NS77NS78NS79NS86NS87NS88NS89NS97NS98NN21NN22NN30NN31NN32NN40NN41NN42NN50NN51NN52NN60NN61NN70NN71NN80NN81NN90NN91NO00NS49NS59NS69NS79NS88NS89NS98NS99NT08NT09NN22NN23NN32NN33NN34NN35NN42NN43NN44NN45NN46NN47NN51NN52NN53NN54NN55NN56NN57NN61NN62NN63NN64NN65NN66NN67NN71NN72NN73NN74NN75NN76NN77NN81NN82NN83NN84NN85NN86NN90NN91NN92NN93NN94NN95NN96NO00NO01NO02NO03NO04NO11NO12NO13NO21NN56NN57NN66NN67NN68NN76NN77NN78NN86NN87NN88NN94NN95NN96NN97NN98NO02NO03NO04NO05NO06NO07NO08NO11NO12NO13NO14NO15NO16NO17NO21NO22NO23NO24NO25NO32NO33NO34NO15NO16NO17NO23NO24NO25NO26NO27NO28NO32NO33NO34NO35NO36NO37NO38NO42NO43NO44NO45NO46NO47NO48NO53NO54NO55NO56NO57NO58NO63NO64NO65NO66NO67NO74NO75NO76NJ60NJ70NJ80NJ90NO57NO58NO66NO67NO68NO69NO76NO77NO78NO79NO86NO87NO88NO89NO99NH90NJ00NJ10NJ11NJ20NJ21NJ30NJ31NJ32NJ40NJ41NJ42NJ50NJ51NJ52NJ60NJ61NJ62NJ70NJ71NJ72NJ80NJ81NJ82NJ90NJ91NJ92NK02NN98NN99NO07NO08NO09NO17NO18NO19NO27NO28NO29NO37NO38NO39NO48NO49NO58NO59NO68NO69NO79NO89NJ31NJ32NJ33NJ34NJ42NJ43NJ44NJ52NJ53NJ54NJ55NJ62NJ63NJ64NJ65NJ72NJ73NJ74NJ75NJ76NJ82NJ83NJ84NJ85NJ86NJ92NJ93NJ94NJ95NJ96NK02NK03NK04NK05NK06NK13NK14NK15NH90NJ00NJ01NJ10NJ11NJ12NJ13NJ14NJ21NJ22NJ23NJ24NJ25NJ32NJ33NJ34NJ35NJ36NJ42NJ43NJ44NJ45NJ46NJ54NJ55NJ56NJ64NJ65NJ66NJ74NJ75NJ76NJ86NN99NH72NH81NH82NH91NH92NH93NH94NH95NH96NJ00NJ01NJ02NJ03NJ04NJ05NJ06NJ11NJ12NJ13NJ14NJ15NJ16NJ17NJ23NJ24NJ25NJ26NJ27NJ34NJ35NJ36NJ45NH01NH02NH10NH11NH12NH13NH14NH20NH21NH22NH23NH24NH30NH31NH32NH33NH34NH40NH41NH42NH43NH44NH50NH51NH52NH53NH54NH60NH61NH62NH63NH64NH70NH71NH72NH73NH74NH75NH80NH81NH82NH83NH84NH85NH90NH91NH92NH93NH94NH95NH96NJ00NJ01NN39NN46NN47NN48NN49NN56NN57NN58NN59NN67NN68NN69NN77NN78NN79NN88NN89NN98NN99NG60NG70NG71NG72NG80NG81NG82NG90NG91NH00NH01NH10NH20NH30NM46NM47NM54NM55NM56NM57NM64NM65NM66NM67NM68NM69NM74NM75NM76NM77NM78NM79NM84NM85NM86NM87NM88NM89NM95NM96NM97NM98NM99NN05NN06NN07NN08NN09NN16NN17NN18NN19NN26NN27NN28NN29NN35NN36NN37NN38NN39NN46NN47NN48NN49NN57NN58NN59NM70NM71NM72NM73NM80NM81NM82NM83NM84NM90NM91NM92NM93NM94NM95NN00NN01NN02NN03NN04NN05NN10NN11NN12NN13NN14NN15NN16NN20NN21NN22NN23NN24NN25NN26NN30NN33NN34NN35NN36NN44NN45NN46NR79NR88NR89NR96NR97NR98NR99NS06NS07NS08NS09NS16NS17NS18NS19NS28NS29NN20NN21NN30NN31NS28NS29NS37NS38NS39NS46NS47NS48NS56NS57NR82NR83NR84NR92NR93NR94NR95NR96NR97NS01NS02NS03NS04NS05NS06NS07NS15NS16NR50NR51NR60NR61NR62NR63NR64NR65NR67NR68NR70NR71NR72NR73NR74NR75NR76NR77NR78NR79NR83NR84NR85NR86NR87NR88NR89NR95NR96NM40NM60NM61NM70NM71NR15NR16NR24NR25NR26NR27NR34NR35NR36NR37NR38NR39NR44NR45NR46NR47NR48NR49NR56NR57NR58NR59NR67NR68NR69NR79NL93NL94NM04NM05NM15NM16NM21NM22NM23NM24NM25NM26NM31NM32NM33NM34NM35NM41NM42NM43NM44NM45NM51NM52NM53NM54NM55NM61NM62NM63NM64NM72NM73NG13NG14NG15NG20NG23NG24NG25NG26NG30NG31NG32NG33NG34NG35NG36NG37NG38NG40NG41NG42NG43NG44NG45NG46NG47NG50NG51NG52NG53NG54NG55NG56NG60NG61NG62NG63NG64NG65NG66NG71NG72NG82NM19NM29NM37NM38NM39NM47NM48NM49NM59NB90NB91NC00NC01NC10NC11NC20NC21NG63NG64NG65NG72NG73NG74NG75NG76NG77NG78NG79NG82NG83NG84NG85NG86NG87NG88NG89NG91NG92NG93NG94NG95NG96NG97NG98NG99NH00NH01NH02NH03NH04NH05NH06NH07NH08NH09NH10NH11NH15NH16NH17NH18NH19NH27NH28NH29NC10NC20NC21NC30NC31NC40NH02NH03NH04NH05NH06NH07NH12NH13NH14NH15NH16NH17NH19NH23NH24NH25NH26NH27NH28NH29NH34NH35NH36NH37NH38NH39NH44NH45NH46NH47NH48NH49NH54NH55NH56NH57NH58NH59NH64NH65NH66NH67NH68NH69NH75NH76NH77NH78NH86NH87NH88NH97NH98NC22NC30NC31NC32NC33NC40NC41NC42NC43NC50NC51NC52NC60NC61NC62NC63NC70NC71NC72NC73NC74NC80NC81NC82NC83NC84NC90NC91NC92NC93ND01ND02NH49NH59NH68NH69NH78NH79NH88NH89NC01NC02NC03NC10NC11NC12NC13NC14NC15NC16NC20NC21NC22NC23NC24NC25NC26NC27NC31NC32NC33NC34NC35NC36NC37NC42NC43NC44NC45NC46NC52NC53NC54NC55NC56NC62NC63NC64NC65NC66NC73NC74NC75NC76NC83NC84NC85NC86NC93NC94NC95NC96NC92NC93NC94NC95NC96ND01ND02ND03ND04ND05ND06ND07ND12ND13ND14ND15ND16ND17ND23ND24ND25ND26ND27ND33ND34ND35ND36ND37ND47HW63HW83HX62NA00NA10NA64NA74NA81NA90NA91NA92NA93NB00NB01NB02NB03NB10NB11NB12NB13NB14NB20NB21NB22NB23NB24NB30NB31NB32NB33NB34NB35NB40NB41NB42NB43NB44NB45NB46NB52NB53NB54NB55NB56NF09NF19NF56NF58NF60NF61NF66NF67NF68NF70NF71NF72NF73NF74NF75NF76NF77NF80NF81NF82NF83NF84NF85NF86NF87NF88NF89NF95NF96NF97NF98NF99NG07NG08NG09NG18NG19NG29NG49NL57NL58NL68NL69NL79HY10HY20HY21HY22HY23HY30HY31HY32HY33HY34HY35HY40HY41HY42HY43HY44HY45HY50HY51HY52HY53HY54HY55HY60HY61HY62HY63HY64HY73HY74HY75ND19ND28ND29ND38ND39ND47ND48ND49ND59HP40HP50HP51HP60HP61HT93HT94HU14HU15HU16HU24HU25HU26HU27HU28HU30HU31HU32HU33HU34HU35HU36HU37HU38HU39HU40HU41HU42HU43HU44HU45HU46HU47HU48HU49HU53HU54HU55HU56HU57HU58HU59HU66HU67HU68HU69HZ16HZ17HZ26HZ27";to_gridref(e){const t=this.x/1e5|0,r=this.y/1e5|0;let n;n=r<5?t<5?"S":"T":r<10?t<5?"N":"O":t<5?"H":"J";let s=65+5*(4-r%5)+t%5;s>=73&&s++;const i=String.fromCharCode(s);return c(n+i,this.x-1e5*t,this.y-1e5*r,e||1)}to_hectad(){const e=this.x/1e5|0,t=this.y/1e5|0;let r;r=t<5?e<5?"S":"T":t<10?e<5?"N":"O":e<5?"H":"J";let n=65+5*(4-t%5)+e%5;return n>=73&&n++,r+String.fromCharCode(n)+((this.x-1e5*e)/1e4|0)+((this.y-1e5*t)/1e4|0)}is_gb_hectad(){return-1!==S.gbHectads.indexOf(this.to_hectad())}to_latLng(){const e=4e5,r=.85521133347722,n=6377563.396,i=.00667054007,o=this.x,a=this.y,c=.0016732203289875;let S,l=(a+1e5)/(.9996012717*n)+r;do{S=a+1e5-6353722.489*(1.0016767257674*(l-r)-.00502807228247412*Math.sin(l-r)*Math.cos(l+r)+(1.875*c*c+1.875*c*c*c)*Math.sin(2*(l-r))*Math.cos(2*(l+r))-35/24*c*c*c*Math.sin(3*(l-r))*Math.cos(3*(l+r))),l+=S/6375020.48098897}while(S>=.001);const d=Math.sin(l)*Math.sin(l),u=Math.tan(l)*Math.tan(l),h=1/Math.cos(l),N=.9996012717*n*Math.pow(1-i*d,-.5),f=6332495.651423464*Math.pow(1-i*d,-1.5),p=N/f-1,T=Math.tan(l)/(2*f*N),g=Math.tan(l)/(24*f*Math.pow(N,3))*(5+3*u+p-9*u*p),v=Math.tan(l)/(720*f*Math.pow(N,5))*(61+90*u+45*u*u),y=h/N,m=h/(6*N*N*N)*(N/f+2*u),E=h/(120*Math.pow(N,5))*(5+28*u+24*u*u),_=h/(5040*Math.pow(N,7))*(61+662*u+1320*u*u+720*u*u*u),b=l-T*Math.pow(o-e,2)+g*Math.pow(o-e,4)-v*Math.pow(o-e,6),I=y*(o-e)-.034906585039887-m*Math.pow(o-e,3)+E*Math.pow(o-e,5)-_*Math.pow(o-e,7);return new s(t*b,t*I).to_WGS84()}}class l extends a{country="IE";gridCoords=null;constructor(e,t){super(),this.x=e,this.y=t}static irishGrid={0:["V","Q","L","F","A"],1:["W","R","M","G","B"],2:["X","S","N","H","C"],3:["Y","T","O","J","D"]};to_latLng(){const e=1.000035,r=6377340.189,n=.0066705402933363,s=.0016732203841521,o=this.x-2e5,a=.0067153352074207,c=(5929615.3530033+(this.y-25e4)/e)/6366691.7742864415,S=c+.002509826623715886*Math.sin(2*c)+36745487490091978e-22*Math.sin(4*c)+151*s*s*s/96*Math.sin(6*c),l=r/Math.sqrt(1-n*Math.sin(S)*Math.sin(S)),d=Math.tan(S)*Math.tan(S),u=a*Math.cos(S)*Math.cos(S),h=r*(1-n)/Math.pow(1-n*Math.sin(S)*Math.sin(S),1.5),N=o/(l*e);let f=S-l*Math.tan(S)/h*(N*N/2-(5+3*d+10*u-4*u*u-9*a)*N*N*N*N/24+(61+90*d+298*u+45*d*d-1.6922644722700164-3*u*u)*N*N*N*N*N*N/720);f*=t;let p=(N-(1+2*d+u)*N*N*N/6+(5-2*u+28*d-3*u*u+8*a+24*d*d)*N*N*N*N*N/120)/Math.cos(S);return p=p*t-8,new i(f,p).to_WGS84()}to_gridref(e){const t=this.x/1e5|0,r=this.y/1e5|0;return l.irishGrid[t]&&l.irishGrid[t][r]?c(l.irishGrid[t][r],this.x-1e5*t,this.y-1e5*r,e||1):null}to_hectad(){const e=this.x/1e5|0,t=this.y/1e5|0;return l.irishGrid[e]&&l.irishGrid[e][t]?l.irishGrid[e][t]+Math.floor(this.x%1e5/1e4)+Math.floor(this.y%1e5/1e4):null}}class d extends a{country="CI";constructor(e,t){super(),this.x=e,this.y=t}to_latLng(){const e=.9996,r=.0067226700223333,s=6378388*e,i=6356911.946*e,o=this.x-5e5,a=h(this.y,0,s,0,.0016863406508729017,i),c=s/Math.sqrt(1-r*(Math.sin(a)*Math.sin(a))),S=c*(1-r)/(1-r*Math.sin(a)*Math.sin(a)),l=c/S-1,d=Math.tan(a)*Math.tan(a),N=Math.pow(Math.tan(a),4),f=Math.pow(Math.tan(a),6),p=Math.pow(Math.cos(a),-1),T=Math.tan(a)/(2*S*c),g=Math.tan(a)/(24*S*(c*c*c))*(5+3*d+l-9*l*d),v=Math.tan(a)/(720*S*Math.pow(c,5))*(61+90*d+45*N),y=a-o*o*T+Math.pow(o,4)*g-Math.pow(o,6)*v,m=Math.pow(Math.cos(a),-1)/c,E=p/(c*c*c*6)*(c/S+2*d),_=p/(120*Math.pow(c,5))*(5+28*d+24*N),b=p/(5040*Math.pow(c,7))*(61+662*d+1320*N+720*f),I=o*m-.0523598775598-o*o*o*E+Math.pow(o,5)*_-Math.pow(o,7)*b,C=u(y,I);return new n(C.lat*t,C.lng*t)}to_gridref(e){return this.y>=55e5?c("WA",this.x-5e5,this.y-55e5,e||1):this.y<55e5?c("WV",this.x-5e5,this.y-54e5,e||1):null}to_hectad(){return this.y>55e5?"WA"+this.x.toString().substring(1,2)+this.y.toString().substring(2,3):this.y<55e5?"WV"+this.x.toString().substring(1,2)+this.y.toString().substring(2,3):null}}const u=function(e,t){return r._transform(e,t,6378388,.0067226700223333,10,6378137,.00669438037928458,-83.901,-98.127,-118.635,0,0,0,0)},h=function(e,t,n,s,i,o){let a=(e-t)/n+s,c=r._Marc(o,i,s,a),S=(e-t-c)/n+a,l=0;for(;Math.abs(e-t-c)>1e-5&&l<20;)l+=1,S=(e-t-c)/n+a,c=r._Marc(o,i,s,S),a=S;return S};class N{static tetradOffsets={E:[0,8e3],J:[2e3,8e3],P:[4e3,8e3],U:[6e3,8e3],Z:[8e3,8e3],D:[0,6e3],I:[2e3,6e3],N:[4e3,6e3],T:[6e3,6e3],Y:[8e3,6e3],C:[0,4e3],H:[2e3,4e3],M:[4e3,4e3],S:[6e3,4e3],X:[8e3,4e3],B:[0,2e3],G:[2e3,2e3],L:[4e3,2e3],R:[6e3,2e3],W:[8e3,2e3],A:[0,0],F:[2e3,0],K:[4e3,0],Q:[6e3,0],V:[8e3,0]};static quadrantOffsets={NW:[0,5e3],NE:[5e3,5e3],SW:[0,0],SE:[5e3,0]};static letterMapping={A:0,B:1,C:2,D:3,E:4,F:5,G:6,H:7,J:8,K:9,L:10,M:11,N:12,O:13,P:14,Q:15,R:16,S:17,T:18,U:19,V:20,W:21,X:22,Y:23,Z:24};static tetradLetters="ABCDEFGHIJKLMNPQRSTUVWXYZ";preciseGridRef="";length=0;hectad="";tetrad="";tetradLetter="";quadrant="";quadrantCode="";gridCoords=null;error=!1;errorMessage="";get centrePoint(){const e=new a,t=Math.floor(this.length/2);return e.x=this.gridCoords.x+t,e.y=this.gridCoords.y+t,e}squareIntersectsPoint(e,t=1){return e.x,this.length,e.y,this.length,1===t?this.gridCoords.x<=e.x&&this.gridCoords.x+this.length>e.x&&this.gridCoords.y<=e.y&&this.gridCoords.y+this.length>e.y:N._checkOverlap(t,e.x,e.y,this.gridCoords.x,this.gridCoords.y,this.gridCoords.x+this.length,this.gridCoords.y+this.length)}static _checkOverlap(e,t,r,n,s,i,o){let a=Math.max(n,Math.min(t,i))-t,c=Math.max(s,Math.min(r,o))-r;return a*a+c*c<=e*e}set_tetrad(){if(this.tetradLetter=N.tetradLetters.charAt(5*(Math.floor(this.gridCoords.x%1e4/1e3)>>1)+(Math.floor(this.gridCoords.y%1e4/1e3)>>1)),!this.tetradLetter)throw new Error("Failed to get tetrad letter when processing '"+this.preciseGridRef+"', easting="+this.gridCoords.x+" northing="+this.gridCoords.y);this.tetrad=this.hectad+this.tetradLetter}static getNormalizedPrecision(e,t){return e>2e3?1e4:e>1e3?2e3:e>100?1e3:e>10?100:e>1?10:t||1}toHtml(e=null){let t;if(e&&e!==this.length)if(2e3===this.length)t=`${this.hectad}<span class='nonsig'>${this.tetradLetter}</span>`;else if(5e3===this.length)t=`${this.hectad}<span class='nonsig'>${this.quadrantCode}</span>`;else if(e>5e3)t=`<span class='nonsig'>${this.preciseGridRef}</span>`;else{let r=5+Math.log10(1/e)|0,n=(this.preciseGridRef.length-2)/2|0;t=this.preciseGridRef.substring(0,2)+"<span class='sig'>"+this.preciseGridRef.substring(2,2+r)+"</span><span class='nonsig'>"+this.preciseGridRef.substring(r+2,2+n)+"</span><span class='sig'>"+this.preciseGridRef.substring(2+n,2+n+r)+"</span><span class='nonsig'>"+this.preciseGridRef.substring(2+n+r)+"</span>"}else if(this.length<=1e3){let e=(this.preciseGridRef.length-2)/2|0;t=this.preciseGridRef.substring(0,2)+"<span class='sig'>"+this.preciseGridRef.substring(2,2+e)+"</span><span class='sig'>"+this.preciseGridRef.substring(2+e)+"</span>"}else t=this.preciseGridRef;return t}static interleave(e){if(!e)return"";let t;if(e.length>3)if(e.includes("NENWSESW",e.length-2))e=e.substring(0,e.length-2),t="";else if(e.substring(e.length-1).match(/a-z/i)){let r="ABCDEFGHIJKLMNPQRSTUVWXYZ".indexOf(e.substring(e.length-1));e=e.substring(0,e.length-1),t=`${r/5|0}${r%5}`}else t="";else t="";switch(e.length){case 0:return"";case 1:return`_${e}`;case 2:return e;case 3:return`_${e}${t}`;case 4:return`${e}${t}`;case 5:return`_${e.substring(0,2)}${e[3]}${e[2]>>1}${e[4]>>1}${e[2]}${e[4]}`;case 6:return`${e.substring(0,3)}${e[4]}${e[3]>>1}${e[5]>>1}${e[3]}${e[5]}`;case 7:return`_${e.substring(0,2)}${e[4]}${e[2]>>1}${e[5]>>1}${e[2]}${e[5]}${e[3]}${e[6]}`;case 8:return`${e.substring(0,3)}${e[5]}${e[3]>>1}${e[6]>>1}${e[3]}${e[6]}${e[4]}${e[7]}`;case 9:return`_${e.substring(0,2)}${e[5]}${e[2]>>1}${e[6]>>1}${e[2]}${e[6]}${e[3]}${e[7]}${e[4]}${e[8]}`;case 10:return`${e.substring(0,3)}${e[6]}${e[3]>>1}${e[7]>>1}${e[3]}${e[7]}${e[4]}${e[8]}${e[5]}${e[9]}`;case 11:return`_${e.substring(0,2)}${e[6]}${e[2]>>1}${e[7]>>1}${e[2]}${e[7]}${e[3]}${e[8]}${e[4]}${e[9]}${e[5]}${e[10]}`;case 12:return`${e.substring(0,3)}${e[7]}${e[3]>>1}${e[8]>>1}${e[3]}${e[8]}${e[4]}${e[9]}${e[5]}${e[10]}${e[6]}${e[11]}`;default:throw new Error(`Bad grid-ref length '${e.length}' for interleaving.`)}}}class f extends N{country="CI";GridCoords=d;gridCoords=null;constructor(){super(),this.parse_well_formed=this.fromString}fromString(e){let t,r=e.replace(/[\[\]\s\t.\/-]+/gu,"").toUpperCase(),n="";/[ABCDEFGHIJKLMNPQRSTUVWXYZ]$/.test(r)&&(N.quadrantOffsets.hasOwnProperty(r.substring(r.length-2))?(this.quadrantCode=r.substring(r.length-2),r=r.substring(0,r.length-2)):(n=r.charAt(r.length-1),r=r.substring(0,r.length-1))),/^(W[AV](?:\d\d){1,5})$/.test(r)?(t=f.gridref_string_to_e_n_l(r))?(this.length=t.length,this.gridCoords=new d(t.e,t.n),this.hectad=this.gridCoords.to_gridref(1e4),1e4===this.length&&(n||this.quadrantCode)?n?(this.preciseGridRef=r+n,this.tetrad=this.hectad+n,this.tetradLetter=n,this.length=2e3,this.gridCoords.x+=N.tetradOffsets[n][0],this.gridCoords.y+=N.tetradOffsets[n][1]):(this.preciseGridRef=r+this.quadrantCode,this.tetradLetter="",this.tetrad="",this.quadrant=this.preciseGridRef,this.length=5e3,this.gridCoords.x+=N.quadrantOffsets[this.quadrantCode][0],this.gridCoords.y+=N.quadrantOffsets[this.quadrantCode][1]):(this.preciseGridRef=r,this.length<=1e3&&this.set_tetrad())):(this.error=!0,this.errorMessage="Grid reference format not understood (odd length)."):(this.error=!0,this.errorMessage="Channel Island grid reference format not understood. ('"+e+"')")}static gridref_string_to_e_n_l(e){let t,r,n,s,i=e.substring(0,2);if("WA"===i)t=55e5;else{if("WV"!==i)return console.log("Bad Channel Island grid letters: '"+i+"'"),!1;t=54e5}let o=e.substring(2);switch(o.length){case 2:r=1e4*o.charAt(0),n=1e4*o.charAt(1),s=1e4;break;case 4:r=1e3*o.substring(0,2),n=1e3*o.substring(2),s=1e3;break;case 6:r=100*o.substring(0,3),n=100*o.substring(3),s=100;break;case 8:r=10*o.substring(0,4),n=10*o.substring(4),s=10;break;case 10:r=parseInt(o.substring(0,5),10),n=parseInt(o.substring(5),10),s=1;break;default:return console.log("Bad length for Channel Island grid ref '"+e+"'"),!1}return{e:r+5e5,n:n+t,length:s}}}class p extends N{country="GB";GridCoords=S;gridCoords=null;constructor(){super()}parse_well_formed(e){e.length>=5&&/^[A-Z]/.test(e.charAt(4))&&(N.quadrantOffsets.hasOwnProperty(e.substring(e.length-2))?this.quadrantCode=e.substring(e.length-2):this.tetradLetter=e.charAt(4),e=e.substring(0,4)),this.parse_wellformed_gb_gr_string_no_tetrads(e),this.tetradLetter||this.quadrantCode?this.tetradLetter?(this.preciseGridRef=this.tetrad=this.hectad+this.tetradLetter,this.length=2e3,this.gridCoords.x+=N.tetradOffsets[this.tetradLetter][0],this.gridCoords.y+=N.tetradOffsets[this.tetradLetter][1]):(this.preciseGridRef=this.quadrant=e+this.quadrantCode,this.length=5e3,this.gridCoords.x+=N.quadrantOffsets[this.quadrantCode][0],this.gridCoords.y+=N.quadrantOffsets[this.quadrantCode][1]):(this.preciseGridRef=e,this.length<=1e3&&this.set_tetrad())}fromString(e){let t,r=e.replace(/[\[\]\s\t.-]+/gu,"").toUpperCase(),n="";if(/[ABCDEFGHIJKLMNPQRSTUVWXYZ]$/.test(r)&&(N.quadrantOffsets.hasOwnProperty(r.substring(r.length-2))?(this.quadrantCode=r.substring(r.length-2),r=r.substring(0,r.length-2)):(n=r.charAt(r.length-1),r=r.substring(0,r.length-1))),r===parseInt(r,10).toString()?r=r.substring(0,2)+"/"+r.substring(2):r.length>3&&"/"===r.charAt(2)&&/^[A-Z]{2}$/.test(r.substring(0,2))&&(r=r.replace("/","")),"VC"===r.substring(0,2))this.error=!0,this.errorMessage="Misplaced vice-county code in grid-reference field. ('"+r+"')",this.gridCoords=null,this.length=0;else if(null!==(t=r.match(/^([HJNOST][ABCDEFGHJKLMNOPQRSTUVWXYZ](?:\d\d){1,5})$/)))r=t[0],this.parse_wellformed_gb_gr_string_no_tetrads(r),this.length>0?1e4===this.length&&(n||this.quadrantCode)?n?(this.preciseGridRef=r+n,this.tetradLetter=n,this.tetrad=this.hectad+n,this.length=2e3,this.gridCoords.x+=N.tetradOffsets[n][0],this.gridCoords.y+=N.tetradOffsets[n][1]):(this.preciseGridRef=r+this.quadrantCode,this.tetradLetter="",this.tetrad="",this.quadrant=this.preciseGridRef,this.length=5e3,this.gridCoords.x+=N.quadrantOffsets[this.quadrantCode][0],this.gridCoords.y+=N.quadrantOffsets[this.quadrantCode][1]):(this.preciseGridRef=r,this.length<=1e3&&this.set_tetrad()):(this.error=!0,this.errorMessage="GB grid reference format not understood (strange length).");else if(/^([\d]{2})\/((?:\d\d){1,5})$/.test(r)){switch(this.parse_gr_string_without_tetrads(r),this.length){case 1e4:r=this.gridCoords.to_gridref(1e4),this.hectad=r,n?(r+=n,this.tetradLetter=n,this.tetrad=this.hectad+n,this.length=2e3,this.gridCoords.x+=N.tetradOffsets[n][0],this.gridCoords.y+=N.tetradOffsets[n][1]):this.quadrantCode&&(r+=this.quadrantCode,this.quadrant=r,this.length=5e3,this.gridCoords.x+=N.quadrantOffsets[this.quadrantCode][0],this.gridCoords.y+=N.quadrantOffsets[this.quadrantCode][1]);break;case 1e3:case 100:case 10:case 1:r=this.gridCoords.to_gridref(this.length),this.hectad=this.gridCoords.to_gridref(1e4),this.set_tetrad();break;default:this.error=!0,this.errorMessage="Bad grid square dimension ("+this.length+" m).",this.gridCoords=null,this.length=0}this.preciseGridRef=r}else this.gridCoords=null,this.length=0,this.error=!0,this.errorMessage="Grid reference format not understood. ('"+e+"')"}parse_gr_string_without_tetrads(e){let t,r,n,s;if(null!==(t=e.match(/^(\d{2})\/((?:\d\d){1,5})$/))){switch(t[1]){case"57":r=3e5,n=1e6;break;case"67":r=4e5,n=1e6;break;case"58":r=3e5,n=11e5;break;case"68":r=4e5,n=11e5;break;case"69":r=4e5,n=12e5;break;default:r=1e5*e.charAt(0),n=1e5*e.charAt(1)}s=t[2]}else{if(!N.letterMapping.hasOwnProperty(e.charAt(0))||!N.letterMapping.hasOwnProperty(e.charAt(1)))return this.length=0,void(this.gridCoords=null);let t=N.letterMapping[e.charAt(0)],i=N.letterMapping[e.charAt(1)];s=e.substring(2),r=t%5*5e5+i%5*1e5-1e6,n=5e5*-Math.floor(t/5)-1e5*Math.floor(i/5)+19e5}switch(s.length){case 2:this.gridCoords=new S(r+1e4*s.charAt(0),n+1e4*s.charAt(1)),this.length=1e4;break;case 4:this.gridCoords=new S(r+1e3*Math.floor(s/100),n+s%100*1e3),this.length=1e3;break;case 6:this.gridCoords=new S(r+100*Math.floor(s/1e3),n+s%1e3*100),this.length=100;break;case 8:this.gridCoords=new S(r+10*Math.floor(s/1e4),n+s%1e4*10),this.length=10;break;case 10:this.gridCoords=new S(r+Math.floor(s/1e5),n+s%1e5),this.length=1;break;default:console.log("Bad grid ref length, ref="+e),this.gridCoords=null,this.length=0}}parse_wellformed_gb_gr_string_no_tetrads(e){let t,r,n,s,i;switch(t=N.letterMapping[e.charAt(0)],r=N.letterMapping[e.charAt(1)],n=e.substring(2),s=t%5*5e5+r%5*1e5-1e6,i=5e5*-Math.floor(t/5)-1e5*Math.floor(r/5)+19e5,n.length){case 2:this.gridCoords=new S(s+1e4*n.charAt(0),i+1e4*n.charAt(1)),this.length=1e4,this.hectad=e;break;case 4:this.gridCoords=new S(s+1e3*Math.floor(n/100),i+n%100*1e3),this.length=1e3,this.hectad=e.substring(0,3)+e.charAt(4);break;case 6:this.gridCoords=new S(s+100*Math.floor(n/1e3),i+n%1e3*100),this.length=100,this.hectad=e.substring(0,3)+e.charAt(5);break;case 8:this.gridCoords=new S(s+10*Math.floor(n/1e4),i+n%1e4*10),this.length=10,this.hectad=e.substring(0,3)+e.charAt(6);break;case 10:this.gridCoords=new S(s+Math.floor(n/1e5),i+n%1e5),this.length=1,this.hectad=e.substring(0,3)+e.charAt(7);break;default:throw this.gridCoords=null,new Error("Bad grid ref length when parsing supposedly well-formed ref, ref='"+e+"'")}}}class T extends N{constructor(){super(),this.parse_well_formed=this.fromString}country="IE";GridCoords=l;gridCoords=null;static gridLetter={A:[0,4],B:[1,4],C:[2,4],D:[3,4],F:[0,3],G:[1,3],H:[2,3],J:[3,3],L:[0,2],M:[1,2],N:[2,2],O:[3,2],Q:[0,1],R:[1,1],S:[2,1],T:[3,1],V:[0,0],W:[1,0],X:[2,0],Y:[3,0]};fromString(e){let t=e.replace(/[\[\]\s\t.-]+/gu,"").toUpperCase();/[ABCDEFGHIJKLMNPQRSTUVWXYZ]$/.test(t)&&(T.quadrantOffsets.hasOwnProperty(t.substring(t.length-2))?(this.quadrantCode=t.substring(t.length-2),t=t.substring(0,t.length-2)):(this.tetradLetter=t.substring(t.length-1),t=t.substring(0,t.length-1))),this.parse_gr_string_without_tetrads(t),this.length>0?this.tetradLetter||this.quadrantCode?this.tetradLetter?(this.preciseGridRef=this.hectad+this.tetradLetter,this.tetrad=this.preciseGridRef,this.length=2e3,this.gridCoords.x+=T.tetradOffsets[this.tetradLetter][0],this.gridCoords.y+=T.tetradOffsets[this.tetradLetter][1]):(this.preciseGridRef=this.hectad+this.quadrantCode,this.quadrant=this.preciseGridRef,this.length=5e3,this.gridCoords.x+=T.quadrantOffsets[this.quadrantCode][0],this.gridCoords.y+=T.quadrantOffsets[this.quadrantCode][1]):(this.preciseGridRef=t,this.length<=1e3&&this.set_tetrad()):(this.error=!0,this.errorMessage="Irish grid reference format not understood. ('"+e+"')")}static _IE_GRID_LETTERS="VQLFAWRMGBXSNHCYTOJD";parse_gr_string_without_tetrads(e){let t,r,n,s;if(/^\d{2}\/(?:\d\d){1,5}$/.test(e)){if(t=parseInt(e.charAt(0),10),r=parseInt(e.charAt(1),10),t>3||r>4)return console.log("bad grid square, ref='"+e+"' (Ireland)"),this.length=0,!1;n=e.substring(3),s=T._IE_GRID_LETTERS.charAt(5*t+r),t*=1e5,r*=1e5}else{if(e=e.replace("/",""),!/^[ABCDFGHJLMNOQRSTVWXY](?:\d\d){1,5}$/.test(e))return this.length=0,this.gridCoords=null,!1;if(!e)return console.log("Bad (empty) Irish grid ref"),this.length=0,this.gridCoords=null,!1;{s=e.charAt(0);let n=T._IE_GRID_LETTERS.indexOf(s);if(-1===n)return console.log("Bad grid ref grid-letter, ref='"+e+"' (Ireland)"),this.length=0,this.gridCoords=null,!1;t=1e5*Math.floor(n/5),r=n%5*1e5}n=e.substring(1)}switch(n.length){case 2:this.gridCoords=new l(t+1e4*n.charAt(0),r+1e4*n.charAt(1)),this.length=1e4,this.hectad=s+n;break;case 4:this.gridCoords=new l(t+1e3*Math.floor(n/100),r+n%100*1e3),this.length=1e3,this.hectad=s+n.charAt(0)+n.charAt(2);break;case 6:this.gridCoords=new l(t+100*Math.floor(n/1e3),r+n%1e3*100),this.length=100,this.hectad=s+n.charAt(0)+n.charAt(3);break;case 8:this.gridCoords=new l(t+10*Math.floor(n/1e4),r+n%1e4*10),this.length=10,this.hectad=s+n.charAt(0)+n.charAt(4);break;case 10:this.gridCoords=new l(t+Math.floor(n/1e5),r+n%1e5),this.length=1,this.hectad=s+n.charAt(0)+n.charAt(5);break;default:return console.log("Bad grid ref length, ref='"+e+"' (Ireland)"),this.length=0,this.gridCoords=null,!1}return!0}toHtml(e=null){let t;if(e&&e!==this.length)if(2e3===this.length)t=`${this.hectad}<span class='nonsig'>${this.tetradLetter}</span>`;else if(5e3===this.length)t=`${this.hectad}<span class='nonsig'>${this.quadrantCode}</span>`;else if(e>5e3)t=`<span class='nonsig'>${this.preciseGridRef}</span>`;else{let r=5+Math.log10(1/e)|0,n=(this.preciseGridRef.length-1)/2|0;t=this.preciseGridRef[0]+"<span class='sig'>"+this.preciseGridRef.substring(1,1+r)+"</span><span class='nonsig'>"+this.preciseGridRef.substring(r+1,1+n)+"</span><span class='sig'>"+this.preciseGridRef.substring(1+n,1+n+r)+"</span><span class='nonsig'>"+this.preciseGridRef.substring(1+n+r)+"</span>"}else if(this.length<=1e3){let e=(this.preciseGridRef.length-1)/2|0;t=this.preciseGridRef[0]+"<span class='sig'>"+this.preciseGridRef.substring(1,1+e)+"</span><span class='sig'>"+this.preciseGridRef.substring(1+e)+"</span>"}else t=this.preciseGridRef;return t}}N.fromString=function(e){let t,r=e.replace(/\s+/gu,"").toUpperCase();if(!r)return!1;if(/^(?:[BCDFGHJLMNOQRSTVWXY]|[HJNOST][ABCDEFGHJKLMNOPQRSTUVWXYZ]|W[VA])\d{2}(?:[A-Z]|[NS][EW]|(?:\d{2}){0,4})?$/.test(r))return t=/^.\d/.test(r)?new T:"W"===r.charAt(0)?new f:new p,t.parse_well_formed(r),!(!t.length||t.error)&&t;if(t=new p,t.fromString(r),t.length&&!t.error)return t;if("W"===r.charAt(0)){if(t=new f,t.fromString(r),t.length&&!t.error)return t}else if(t=new T,t.fromString(r),t.length&&!t.error)return t;return!1};class g{_eventListeners=[];static STOP_PROPAGATION="STOP_PROPAGATION";addWeakListener(e,t,r,n={}){this._eventListeners=this._eventListeners||[];const s=new WeakRef(t);t=null;const i=(e,t,i={})=>{let o=s.deref();o?o[r]({context:e,eventName:t,...i,...n}):console.warn(`A ${t} handler (${r}) has been garbage collected`)};return this._eventListeners[e]?this._eventListeners[e].push(i)-1:(this._eventListeners[e]=[i],0)}addListener(e,t,r={}){this._eventListeners=this._eventListeners||[];const n=(e,n,s={})=>t({context:e,eventName:n,...s,...r});return this._eventListeners[e]?this._eventListeners[e].push(n)-1:(this._eventListeners[e]=[n],0)}removeListener(e,t){this._eventListeners[e]?.[t]?delete this._eventListeners[e][t]:console.log("trying to remove non-existent event handler, event = "+e+" handle = "+t)}destructor(){this._eventListeners=null}fireEvent(e,t){if(this._eventListeners)for(let t in this._eventListeners[e])if(this._eventListeners[e].hasOwnProperty(t)&&this._eventListeners[e][t](this,e,arguments[1])===g.STOP_PROPAGATION)break}}var v="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function y(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function m(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var E={exports:{}},_=y(E.exports=function e(t,r,n){function s(o,a){if(!r[o]){if(!t[o]){if(!a&&m)return m(o);if(i)return i(o,!0);var c=new Error("Cannot find module '"+o+"'");throw c.code="MODULE_NOT_FOUND",c}var S=r[o]={exports:{}};t[o][0].call(S.exports,(function(e){var r=t[o][1][e];return s(r||e)}),S,S.exports,e,t,r,n)}return r[o].exports}for(var i=m,o=0;o<n.length;o++)s(n[o]);return s}({1:[function(e,t,r){(function(e){var r,n,s=e.MutationObserver||e.WebKitMutationObserver;if(s){var i=0,o=new s(l),a=e.document.createTextNode("");o.observe(a,{characterData:!0}),r=function(){a.data=i=++i%2}}else if(e.setImmediate||void 0===e.MessageChannel)r="document"in e&&"onreadystatechange"in e.document.createElement("script")?function(){var t=e.document.createElement("script");t.onreadystatechange=function(){l(),t.onreadystatechange=null,t.parentNode.removeChild(t),t=null},e.document.documentElement.appendChild(t)}:function(){setTimeout(l,0)};else{var c=new e.MessageChannel;c.port1.onmessage=l,r=function(){c.port2.postMessage(0)}}var S=[];function l(){var e,t;n=!0;for(var r=S.length;r;){for(t=S,S=[],e=-1;++e<r;)t[e]();r=S.length}n=!1}function d(e){1!==S.push(e)||n||r()}t.exports=d}).call(this,void 0!==v?v:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],2:[function(e,t,r){var n=e(1);function s(){}var i={},o=["REJECTED"],a=["FULFILLED"],c=["PENDING"];function S(e){if("function"!=typeof e)throw new TypeError("resolver must be a function");this.state=c,this.queue=[],this.outcome=void 0,e!==s&&h(this,e)}function l(e,t,r){this.promise=e,"function"==typeof t&&(this.onFulfilled=t,this.callFulfilled=this.otherCallFulfilled),"function"==typeof r&&(this.onRejected=r,this.callRejected=this.otherCallRejected)}function d(e,t,r){n((function(){var n;try{n=t(r)}catch(t){return i.reject(e,t)}n===e?i.reject(e,new TypeError("Cannot resolve promise with itself")):i.resolve(e,n)}))}function u(e){var t=e&&e.then;if(e&&("object"==typeof e||"function"==typeof e)&&"function"==typeof t)return function(){t.apply(e,arguments)}}function h(e,t){var r=!1;function n(t){r||(r=!0,i.reject(e,t))}function s(t){r||(r=!0,i.resolve(e,t))}function o(){t(s,n)}var a=N(o);"error"===a.status&&n(a.value)}function N(e,t){var r={};try{r.value=e(t),r.status="success"}catch(e){r.status="error",r.value=e}return r}function f(e){return e instanceof this?e:i.resolve(new this(s),e)}function p(e){var t=new this(s);return i.reject(t,e)}function T(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var r=e.length,n=!1;if(!r)return this.resolve([]);for(var o=new Array(r),a=0,c=-1,S=new this(s);++c<r;)l(e[c],c);return S;function l(e,s){function c(e){o[s]=e,++a!==r||n||(n=!0,i.resolve(S,o))}t.resolve(e).then(c,(function(e){n||(n=!0,i.reject(S,e))}))}}function g(e){var t=this;if("[object Array]"!==Object.prototype.toString.call(e))return this.reject(new TypeError("must be an array"));var r=e.length,n=!1;if(!r)return this.resolve([]);for(var o=-1,a=new this(s);++o<r;)c(e[o]);return a;function c(e){t.resolve(e).then((function(e){n||(n=!0,i.resolve(a,e))}),(function(e){n||(n=!0,i.reject(a,e))}))}}t.exports=S,S.prototype.catch=function(e){return this.then(null,e)},S.prototype.then=function(e,t){if("function"!=typeof e&&this.state===a||"function"!=typeof t&&this.state===o)return this;var r=new this.constructor(s);return this.state!==c?d(r,this.state===a?e:t,this.outcome):this.queue.push(new l(r,e,t)),r},l.prototype.callFulfilled=function(e){i.resolve(this.promise,e)},l.prototype.otherCallFulfilled=function(e){d(this.promise,this.onFulfilled,e)},l.prototype.callRejected=function(e){i.reject(this.promise,e)},l.prototype.otherCallRejected=function(e){d(this.promise,this.onRejected,e)},i.resolve=function(e,t){var r=N(u,t);if("error"===r.status)return i.reject(e,r.value);var n=r.value;if(n)h(e,n);else{e.state=a,e.outcome=t;for(var s=-1,o=e.queue.length;++s<o;)e.queue[s].callFulfilled(t)}return e},i.reject=function(e,t){e.state=o,e.outcome=t;for(var r=-1,n=e.queue.length;++r<n;)e.queue[r].callRejected(t);return e},S.resolve=f,S.reject=p,S.all=T,S.race=g},{1:1}],3:[function(e,t,r){(function(t){"function"!=typeof t.Promise&&(t.Promise=e(2))}).call(this,void 0!==v?v:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{2:2}],4:[function(e,t,r){var n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(){try{if("undefined"!=typeof indexedDB)return indexedDB;if("undefined"!=typeof webkitIndexedDB)return webkitIndexedDB;if("undefined"!=typeof mozIndexedDB)return mozIndexedDB;if("undefined"!=typeof OIndexedDB)return OIndexedDB;if("undefined"!=typeof msIndexedDB)return msIndexedDB}catch(e){return}}var o=i();function a(){try{if(!o||!o.open)return!1;var e="undefined"!=typeof openDatabase&&/(Safari|iPhone|iPad|iPod)/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent)&&!/BlackBerry/.test(navigator.platform),t="function"==typeof fetch&&-1!==fetch.toString().indexOf("[native code");return(!e||t)&&"undefined"!=typeof indexedDB&&"undefined"!=typeof IDBKeyRange}catch(e){return!1}}function c(e,t){e=e||[],t=t||{};try{return new Blob(e,t)}catch(s){if("TypeError"!==s.name)throw s;for(var r=new("undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder?MozBlobBuilder:WebKitBlobBuilder),n=0;n<e.length;n+=1)r.append(e[n]);return r.getBlob(t.type)}}"undefined"==typeof Promise&&e(3);var S=Promise;function l(e,t){t&&e.then((function(e){t(null,e)}),(function(e){t(e)}))}function d(e,t,r){"function"==typeof t&&e.then(t),"function"==typeof r&&e.catch(r)}function u(e){return"string"!=typeof e&&(console.warn(e+" used as a key, but it is not a string."),e=String(e)),e}function h(){if(arguments.length&&"function"==typeof arguments[arguments.length-1])return arguments[arguments.length-1]}var N="local-forage-detect-blob-support",f=void 0,p={},T=Object.prototype.toString,g="readonly",v="readwrite";function y(e){for(var t=e.length,r=new ArrayBuffer(t),n=new Uint8Array(r),s=0;s<t;s++)n[s]=e.charCodeAt(s);return r}function m(e){return new S((function(t){var r=e.transaction(N,v),n=c([""]);r.objectStore(N).put(n,"key"),r.onabort=function(e){e.preventDefault(),e.stopPropagation(),t(!1)},r.oncomplete=function(){var e=navigator.userAgent.match(/Chrome\/(\d+)/),r=navigator.userAgent.match(/Edge\//);t(r||!e||parseInt(e[1],10)>=43)}})).catch((function(){return!1}))}function E(e){return"boolean"==typeof f?S.resolve(f):m(e).then((function(e){return f=e}))}function _(e){var t=p[e.name],r={};r.promise=new S((function(e,t){r.resolve=e,r.reject=t})),t.deferredOperations.push(r),t.dbReady?t.dbReady=t.dbReady.then((function(){return r.promise})):t.dbReady=r.promise}function b(e){var t=p[e.name].deferredOperations.pop();if(t)return t.resolve(),t.promise}function I(e,t){var r=p[e.name].deferredOperations.pop();if(r)return r.reject(t),r.promise}function C(e,t){return new S((function(r,n){if(p[e.name]=p[e.name]||A(),e.db){if(!t)return r(e.db);_(e),e.db.close()}var s=[e.name];t&&s.push(e.version);var i=o.open.apply(o,s);t&&(i.onupgradeneeded=function(t){var r=i.result;try{r.createObjectStore(e.storeName),t.oldVersion<=1&&r.createObjectStore(N)}catch(r){if("ConstraintError"!==r.name)throw r;console.warn('The database "'+e.name+'" has been upgraded from version '+t.oldVersion+" to version "+t.newVersion+', but the storage "'+e.storeName+'" already exists.')}}),i.onerror=function(e){e.preventDefault(),n(i.error)},i.onsuccess=function(){var t=i.result;t.onversionchange=function(e){e.target.close()},r(t),b(e)}}))}function M(e){return C(e,!1)}function O(e){return C(e,!0)}function L(e,t){if(!e.db)return!0;var r=!e.db.objectStoreNames.contains(e.storeName),n=e.version<e.db.version,s=e.version>e.db.version;if(n&&(e.version!==t&&console.warn('The database "'+e.name+"\" can't be downgraded from version "+e.db.version+" to version "+e.version+"."),e.version=e.db.version),s||r){if(r){var i=e.db.version+1;i>e.version&&(e.version=i)}return!0}return!1}function w(e){return new S((function(t,r){var n=new FileReader;n.onerror=r,n.onloadend=function(r){var n=btoa(r.target.result||"");t({__local_forage_encoded_blob:!0,data:n,type:e.type})},n.readAsBinaryString(e)}))}function R(e){return c([y(atob(e.data))],{type:e.type})}function H(e){return e&&e.__local_forage_encoded_blob}function D(e){var t=this,r=t._initReady().then((function(){var e=p[t._dbInfo.name];if(e&&e.dbReady)return e.dbReady}));return d(r,e,e),r}function P(e){_(e);for(var t=p[e.name],r=t.forages,n=0;n<r.length;n++){var s=r[n];s._dbInfo.db&&(s._dbInfo.db.close(),s._dbInfo.db=null)}return e.db=null,M(e).then((function(t){return e.db=t,L(e)?O(e):t})).then((function(n){e.db=t.db=n;for(var s=0;s<r.length;s++)r[s]._dbInfo.db=n})).catch((function(t){throw I(e,t),t}))}function U(e,t,r,n){void 0===n&&(n=1);try{var s=e.db.transaction(e.storeName,t);r(null,s)}catch(s){if(n>0&&(!e.db||"InvalidStateError"===s.name||"NotFoundError"===s.name))return S.resolve().then((function(){if(!e.db||"NotFoundError"===s.name&&!e.db.objectStoreNames.contains(e.storeName)&&e.version<=e.db.version)return e.db&&(e.version=e.db.version+1),O(e)})).then((function(){return P(e).then((function(){U(e,t,r,n-1)}))})).catch(r);r(s)}}function A(){return{forages:[],db:null,dbReady:null,deferredOperations:[]}}function J(e){var t=this,r={db:null};if(e)for(var n in e)r[n]=e[n];var s=p[r.name];s||(s=A(),p[r.name]=s),s.forages.push(t),t._initReady||(t._initReady=t.ready,t.ready=D);var i=[];function o(){return S.resolve()}for(var a=0;a<s.forages.length;a++){var c=s.forages[a];c!==t&&i.push(c._initReady().catch(o))}var l=s.forages.slice(0);return S.all(i).then((function(){return r.db=s.db,M(r)})).then((function(e){return r.db=e,L(r,t._defaultConfig.version)?O(r):e})).then((function(e){r.db=s.db=e,t._dbInfo=r;for(var n=0;n<l.length;n++){var i=l[n];i!==t&&(i._dbInfo.db=r.db,i._dbInfo.version=r.version)}}))}function Y(e,t){var r=this;e=u(e);var n=new S((function(t,n){r.ready().then((function(){U(r._dbInfo,g,(function(s,i){if(s)return n(s);try{var o=i.objectStore(r._dbInfo.storeName).get(e);o.onsuccess=function(){var e=o.result;void 0===e&&(e=null),H(e)&&(e=R(e)),t(e)},o.onerror=function(){n(o.error)}}catch(e){n(e)}}))})).catch(n)}));return l(n,t),n}function F(e,t){var r=this,n=new S((function(t,n){r.ready().then((function(){U(r._dbInfo,g,(function(s,i){if(s)return n(s);try{var o=i.objectStore(r._dbInfo.storeName).openCursor(),a=1;o.onsuccess=function(){var r=o.result;if(r){var n=r.value;H(n)&&(n=R(n));var s=e(n,r.key,a++);void 0!==s?t(s):r.continue()}else t()},o.onerror=function(){n(o.error)}}catch(e){n(e)}}))})).catch(n)}));return l(n,t),n}function G(e,t,r){var n=this;e=u(e);var s=new S((function(r,s){var i;n.ready().then((function(){return i=n._dbInfo,"[object Blob]"===T.call(t)?E(i.db).then((function(e){return e?t:w(t)})):t})).then((function(t){U(n._dbInfo,v,(function(i,o){if(i)return s(i);try{var a=o.objectStore(n._dbInfo.storeName);null===t&&(t=void 0);var c=a.put(t,e);o.oncomplete=function(){void 0===t&&(t=null),r(t)},o.onabort=o.onerror=function(){var e=c.error?c.error:c.transaction.error;s(e)}}catch(e){s(e)}}))})).catch(s)}));return l(s,r),s}function $(e,t){var r=this;e=u(e);var n=new S((function(t,n){r.ready().then((function(){U(r._dbInfo,v,(function(s,i){if(s)return n(s);try{var o=i.objectStore(r._dbInfo.storeName).delete(e);i.oncomplete=function(){t()},i.onerror=function(){n(o.error)},i.onabort=function(){var e=o.error?o.error:o.transaction.error;n(e)}}catch(e){n(e)}}))})).catch(n)}));return l(n,t),n}function x(e){var t=this,r=new S((function(e,r){t.ready().then((function(){U(t._dbInfo,v,(function(n,s){if(n)return r(n);try{var i=s.objectStore(t._dbInfo.storeName).clear();s.oncomplete=function(){e()},s.onabort=s.onerror=function(){var e=i.error?i.error:i.transaction.error;r(e)}}catch(e){r(e)}}))})).catch(r)}));return l(r,e),r}function K(e){var t=this,r=new S((function(e,r){t.ready().then((function(){U(t._dbInfo,g,(function(n,s){if(n)return r(n);try{var i=s.objectStore(t._dbInfo.storeName).count();i.onsuccess=function(){e(i.result)},i.onerror=function(){r(i.error)}}catch(e){r(e)}}))})).catch(r)}));return l(r,e),r}function k(e,t){var r=this,n=new S((function(t,n){e<0?t(null):r.ready().then((function(){U(r._dbInfo,g,(function(s,i){if(s)return n(s);try{var o=i.objectStore(r._dbInfo.storeName),a=!1,c=o.openKeyCursor();c.onsuccess=function(){var r=c.result;r?0===e||a?t(r.key):(a=!0,r.advance(e)):t(null)},c.onerror=function(){n(c.error)}}catch(e){n(e)}}))})).catch(n)}));return l(n,t),n}function Q(e){var t=this,r=new S((function(e,r){t.ready().then((function(){U(t._dbInfo,g,(function(n,s){if(n)return r(n);try{var i=s.objectStore(t._dbInfo.storeName).openKeyCursor(),o=[];i.onsuccess=function(){var t=i.result;t?(o.push(t.key),t.continue()):e(o)},i.onerror=function(){r(i.error)}}catch(e){r(e)}}))})).catch(r)}));return l(r,e),r}function X(e,t){t=h.apply(this,arguments);var r=this.config();(e="function"!=typeof e&&e||{}).name||(e.name=e.name||r.name,e.storeName=e.storeName||r.storeName);var n,s=this;if(e.name){var i=e.name===r.name&&s._dbInfo.db?S.resolve(s._dbInfo.db):M(e).then((function(t){var r=p[e.name],n=r.forages;r.db=t;for(var s=0;s<n.length;s++)n[s]._dbInfo.db=t;return t}));n=e.storeName?i.then((function(t){if(t.objectStoreNames.contains(e.storeName)){var r=t.version+1;_(e);var n=p[e.name],s=n.forages;t.close();for(var i=0;i<s.length;i++){var a=s[i];a._dbInfo.db=null,a._dbInfo.version=r}var c=new S((function(t,n){var s=o.open(e.name,r);s.onerror=function(e){s.result.close(),n(e)},s.onupgradeneeded=function(){s.result.deleteObjectStore(e.storeName)},s.onsuccess=function(){var e=s.result;e.close(),t(e)}}));return c.then((function(e){n.db=e;for(var t=0;t<s.length;t++){var r=s[t];r._dbInfo.db=e,b(r._dbInfo)}})).catch((function(t){throw(I(e,t)||S.resolve()).catch((function(){})),t}))}})):i.then((function(t){_(e);var r=p[e.name],n=r.forages;t.close();for(var s=0;s<n.length;s++)n[s]._dbInfo.db=null;var i=new S((function(t,r){var n=o.deleteDatabase(e.name);n.onerror=function(){var e=n.result;e&&e.close(),r(n.error)},n.onblocked=function(){console.warn('dropInstance blocked for database "'+e.name+'" until all open connections are closed')},n.onsuccess=function(){var e=n.result;e&&e.close(),t(e)}}));return i.then((function(e){r.db=e;for(var t=0;t<n.length;t++)b(n[t]._dbInfo)})).catch((function(t){throw(I(e,t)||S.resolve()).catch((function(){})),t}))}))}else n=S.reject("Invalid arguments");return l(n,t),n}var V={_driver:"asyncStorage",_initStorage:J,_support:a(),iterate:F,getItem:Y,setItem:G,removeItem:$,clear:x,length:K,key:k,keys:Q,dropInstance:X};function q(){return"function"==typeof openDatabase}var j="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",B="~~local_forage_type~",W=/^~~local_forage_type~([^~]+)~/,Z="__lfsc__:",z=Z.length,ee="arbf",te="blob",re="si08",ne="ui08",se="uic8",ie="si16",oe="si32",ae="ur16",ce="ui32",Se="fl32",le="fl64",de=z+ee.length,ue=Object.prototype.toString;function he(e){var t,r,n,s,i,o=.75*e.length,a=e.length,c=0;"="===e[e.length-1]&&(o--,"="===e[e.length-2]&&o--);var S=new ArrayBuffer(o),l=new Uint8Array(S);for(t=0;t<a;t+=4)r=j.indexOf(e[t]),n=j.indexOf(e[t+1]),s=j.indexOf(e[t+2]),i=j.indexOf(e[t+3]),l[c++]=r<<2|n>>4,l[c++]=(15&n)<<4|s>>2,l[c++]=(3&s)<<6|63&i;return S}function Ne(e){var t,r=new Uint8Array(e),n="";for(t=0;t<r.length;t+=3)n+=j[r[t]>>2],n+=j[(3&r[t])<<4|r[t+1]>>4],n+=j[(15&r[t+1])<<2|r[t+2]>>6],n+=j[63&r[t+2]];return r.length%3==2?n=n.substring(0,n.length-1)+"=":r.length%3==1&&(n=n.substring(0,n.length-2)+"=="),n}function fe(e,t){var r="";if(e&&(r=ue.call(e)),e&&("[object ArrayBuffer]"===r||e.buffer&&"[object ArrayBuffer]"===ue.call(e.buffer))){var n,s=Z;e instanceof ArrayBuffer?(n=e,s+=ee):(n=e.buffer,"[object Int8Array]"===r?s+=re:"[object Uint8Array]"===r?s+=ne:"[object Uint8ClampedArray]"===r?s+=se:"[object Int16Array]"===r?s+=ie:"[object Uint16Array]"===r?s+=ae:"[object Int32Array]"===r?s+=oe:"[object Uint32Array]"===r?s+=ce:"[object Float32Array]"===r?s+=Se:"[object Float64Array]"===r?s+=le:t(new Error("Failed to get type for BinaryArray"))),t(s+Ne(n))}else if("[object Blob]"===r){var i=new FileReader;i.onload=function(){var r=B+e.type+"~"+Ne(this.result);t(Z+te+r)},i.readAsArrayBuffer(e)}else try{t(JSON.stringify(e))}catch(r){console.error("Couldn't convert value into a JSON string: ",e),t(null,r)}}function pe(e){if(e.substring(0,z)!==Z)return JSON.parse(e);var t,r=e.substring(de),n=e.substring(z,de);if(n===te&&W.test(r)){var s=r.match(W);t=s[1],r=r.substring(s[0].length)}var i=he(r);switch(n){case ee:return i;case te:return c([i],{type:t});case re:return new Int8Array(i);case ne:return new Uint8Array(i);case se:return new Uint8ClampedArray(i);case ie:return new Int16Array(i);case ae:return new Uint16Array(i);case oe:return new Int32Array(i);case ce:return new Uint32Array(i);case Se:return new Float32Array(i);case le:return new Float64Array(i);default:throw new Error("Unkown type: "+n)}}var Te={serialize:fe,deserialize:pe,stringToBuffer:he,bufferToString:Ne};function ge(e,t,r,n){e.executeSql("CREATE TABLE IF NOT EXISTS "+t.storeName+" (id INTEGER PRIMARY KEY, key unique, value)",[],r,n)}function ve(e){var t=this,r={db:null};if(e)for(var n in e)r[n]="string"!=typeof e[n]?e[n].toString():e[n];var s=new S((function(e,n){try{r.db=openDatabase(r.name,String(r.version),r.description,r.size)}catch(e){return n(e)}r.db.transaction((function(s){ge(s,r,(function(){t._dbInfo=r,e()}),(function(e,t){n(t)}))}),n)}));return r.serializer=Te,s}function ye(e,t,r,n,s,i){e.executeSql(r,n,s,(function(e,o){o.code===o.SYNTAX_ERR?e.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name = ?",[t.storeName],(function(e,a){a.rows.length?i(e,o):ge(e,t,(function(){e.executeSql(r,n,s,i)}),i)}),i):i(e,o)}),i)}function me(e,t){var r=this;e=u(e);var n=new S((function(t,n){r.ready().then((function(){var s=r._dbInfo;s.db.transaction((function(r){ye(r,s,"SELECT * FROM "+s.storeName+" WHERE key = ? LIMIT 1",[e],(function(e,r){var n=r.rows.length?r.rows.item(0).value:null;n&&(n=s.serializer.deserialize(n)),t(n)}),(function(e,t){n(t)}))}))})).catch(n)}));return l(n,t),n}function Ee(e,t){var r=this,n=new S((function(t,n){r.ready().then((function(){var s=r._dbInfo;s.db.transaction((function(r){ye(r,s,"SELECT * FROM "+s.storeName,[],(function(r,n){for(var i=n.rows,o=i.length,a=0;a<o;a++){var c=i.item(a),S=c.value;if(S&&(S=s.serializer.deserialize(S)),void 0!==(S=e(S,c.key,a+1)))return void t(S)}t()}),(function(e,t){n(t)}))}))})).catch(n)}));return l(n,t),n}function _e(e,t,r,n){var s=this;e=u(e);var i=new S((function(i,o){s.ready().then((function(){void 0===t&&(t=null);var a=t,c=s._dbInfo;c.serializer.serialize(t,(function(t,S){S?o(S):c.db.transaction((function(r){ye(r,c,"INSERT OR REPLACE INTO "+c.storeName+" (key, value) VALUES (?, ?)",[e,t],(function(){i(a)}),(function(e,t){o(t)}))}),(function(t){if(t.code===t.QUOTA_ERR){if(n>0)return void i(_e.apply(s,[e,a,r,n-1]));o(t)}}))}))})).catch(o)}));return l(i,r),i}function be(e,t,r){return _e.apply(this,[e,t,r,1])}function Ie(e,t){var r=this;e=u(e);var n=new S((function(t,n){r.ready().then((function(){var s=r._dbInfo;s.db.transaction((function(r){ye(r,s,"DELETE FROM "+s.storeName+" WHERE key = ?",[e],(function(){t()}),(function(e,t){n(t)}))}))})).catch(n)}));return l(n,t),n}function Ce(e){var t=this,r=new S((function(e,r){t.ready().then((function(){var n=t._dbInfo;n.db.transaction((function(t){ye(t,n,"DELETE FROM "+n.storeName,[],(function(){e()}),(function(e,t){r(t)}))}))})).catch(r)}));return l(r,e),r}function Me(e){var t=this,r=new S((function(e,r){t.ready().then((function(){var n=t._dbInfo;n.db.transaction((function(t){ye(t,n,"SELECT COUNT(key) as c FROM "+n.storeName,[],(function(t,r){var n=r.rows.item(0).c;e(n)}),(function(e,t){r(t)}))}))})).catch(r)}));return l(r,e),r}function Oe(e,t){var r=this,n=new S((function(t,n){r.ready().then((function(){var s=r._dbInfo;s.db.transaction((function(r){ye(r,s,"SELECT key FROM "+s.storeName+" WHERE id = ? LIMIT 1",[e+1],(function(e,r){var n=r.rows.length?r.rows.item(0).key:null;t(n)}),(function(e,t){n(t)}))}))})).catch(n)}));return l(n,t),n}function Le(e){var t=this,r=new S((function(e,r){t.ready().then((function(){var n=t._dbInfo;n.db.transaction((function(t){ye(t,n,"SELECT key FROM "+n.storeName,[],(function(t,r){for(var n=[],s=0;s<r.rows.length;s++)n.push(r.rows.item(s).key);e(n)}),(function(e,t){r(t)}))}))})).catch(r)}));return l(r,e),r}function we(e){return new S((function(t,r){e.transaction((function(n){n.executeSql("SELECT name FROM sqlite_master WHERE type='table' AND name <> '__WebKitDatabaseInfoTable__'",[],(function(r,n){for(var s=[],i=0;i<n.rows.length;i++)s.push(n.rows.item(i).name);t({db:e,storeNames:s})}),(function(e,t){r(t)}))}),(function(e){r(e)}))}))}function Re(e,t){t=h.apply(this,arguments);var r=this.config();(e="function"!=typeof e&&e||{}).name||(e.name=e.name||r.name,e.storeName=e.storeName||r.storeName);var n,s=this;return l(n=e.name?new S((function(t){var n;n=e.name===r.name?s._dbInfo.db:openDatabase(e.name,"","",0),e.storeName?t({db:n,storeNames:[e.storeName]}):t(we(n))})).then((function(e){return new S((function(t,r){e.db.transaction((function(n){function s(e){return new S((function(t,r){n.executeSql("DROP TABLE IF EXISTS "+e,[],(function(){t()}),(function(e,t){r(t)}))}))}for(var i=[],o=0,a=e.storeNames.length;o<a;o++)i.push(s(e.storeNames[o]));S.all(i).then((function(){t()})).catch((function(e){r(e)}))}),(function(e){r(e)}))}))})):S.reject("Invalid arguments"),t),n}var He={_driver:"webSQLStorage",_initStorage:ve,_support:q(),iterate:Ee,getItem:me,setItem:be,removeItem:Ie,clear:Ce,length:Me,key:Oe,keys:Le,dropInstance:Re};function De(){try{return"undefined"!=typeof localStorage&&"setItem"in localStorage&&!!localStorage.setItem}catch(e){return!1}}function Pe(e,t){var r=e.name+"/";return e.storeName!==t.storeName&&(r+=e.storeName+"/"),r}function Ue(){var e="_localforage_support_test";try{return localStorage.setItem(e,!0),localStorage.removeItem(e),!1}catch(e){return!0}}function Ae(){return!Ue()||localStorage.length>0}function Je(e){var t=this,r={};if(e)for(var n in e)r[n]=e[n];return r.keyPrefix=Pe(e,t._defaultConfig),Ae()?(t._dbInfo=r,r.serializer=Te,S.resolve()):S.reject()}function Ye(e){var t=this,r=t.ready().then((function(){for(var e=t._dbInfo.keyPrefix,r=localStorage.length-1;r>=0;r--){var n=localStorage.key(r);0===n.indexOf(e)&&localStorage.removeItem(n)}}));return l(r,e),r}function Fe(e,t){var r=this;e=u(e);var n=r.ready().then((function(){var t=r._dbInfo,n=localStorage.getItem(t.keyPrefix+e);return n&&(n=t.serializer.deserialize(n)),n}));return l(n,t),n}function Ge(e,t){var r=this,n=r.ready().then((function(){for(var t=r._dbInfo,n=t.keyPrefix,s=n.length,i=localStorage.length,o=1,a=0;a<i;a++){var c=localStorage.key(a);if(0===c.indexOf(n)){var S=localStorage.getItem(c);if(S&&(S=t.serializer.deserialize(S)),void 0!==(S=e(S,c.substring(s),o++)))return S}}}));return l(n,t),n}function $e(e,t){var r=this,n=r.ready().then((function(){var t,n=r._dbInfo;try{t=localStorage.key(e)}catch(e){t=null}return t&&(t=t.substring(n.keyPrefix.length)),t}));return l(n,t),n}function xe(e){var t=this,r=t.ready().then((function(){for(var e=t._dbInfo,r=localStorage.length,n=[],s=0;s<r;s++){var i=localStorage.key(s);0===i.indexOf(e.keyPrefix)&&n.push(i.substring(e.keyPrefix.length))}return n}));return l(r,e),r}function Ke(e){var t=this.keys().then((function(e){return e.length}));return l(t,e),t}function ke(e,t){var r=this;e=u(e);var n=r.ready().then((function(){var t=r._dbInfo;localStorage.removeItem(t.keyPrefix+e)}));return l(n,t),n}function Qe(e,t,r){var n=this;e=u(e);var s=n.ready().then((function(){void 0===t&&(t=null);var r=t;return new S((function(s,i){var o=n._dbInfo;o.serializer.serialize(t,(function(t,n){if(n)i(n);else try{localStorage.setItem(o.keyPrefix+e,t),s(r)}catch(e){"QuotaExceededError"!==e.name&&"NS_ERROR_DOM_QUOTA_REACHED"!==e.name||i(e),i(e)}}))}))}));return l(s,r),s}function Xe(e,t){if(t=h.apply(this,arguments),!(e="function"!=typeof e&&e||{}).name){var r=this.config();e.name=e.name||r.name,e.storeName=e.storeName||r.storeName}var n,s=this;return n=e.name?new S((function(t){e.storeName?t(Pe(e,s._defaultConfig)):t(e.name+"/")})).then((function(e){for(var t=localStorage.length-1;t>=0;t--){var r=localStorage.key(t);0===r.indexOf(e)&&localStorage.removeItem(r)}})):S.reject("Invalid arguments"),l(n,t),n}var Ve={_driver:"localStorageWrapper",_initStorage:Je,_support:De(),iterate:Ge,getItem:Fe,setItem:Qe,removeItem:ke,clear:Ye,length:Ke,key:$e,keys:xe,dropInstance:Xe},qe=function(e,t){return e===t||"number"==typeof e&&"number"==typeof t&&isNaN(e)&&isNaN(t)},je=function(e,t){for(var r=e.length,n=0;n<r;){if(qe(e[n],t))return!0;n++}return!1},Be=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},We={},Ze={},ze={INDEXEDDB:V,WEBSQL:He,LOCALSTORAGE:Ve},et=[ze.INDEXEDDB._driver,ze.WEBSQL._driver,ze.LOCALSTORAGE._driver],tt=["dropInstance"],rt=["clear","getItem","iterate","key","keys","length","removeItem","setItem"].concat(tt),nt={description:"",driver:et.slice(),name:"localforage",size:4980736,storeName:"keyvaluepairs",version:1};function st(e,t){e[t]=function(){var r=arguments;return e.ready().then((function(){return e[t].apply(e,r)}))}}function it(){for(var e=1;e<arguments.length;e++){var t=arguments[e];if(t)for(var r in t)t.hasOwnProperty(r)&&(Be(t[r])?arguments[0][r]=t[r].slice():arguments[0][r]=t[r])}return arguments[0]}var ot=function(){function e(t){for(var r in s(this,e),ze)if(ze.hasOwnProperty(r)){var n=ze[r],i=n._driver;this[r]=i,We[i]||this.defineDriver(n)}this._defaultConfig=it({},nt),this._config=it({},this._defaultConfig,t),this._driverSet=null,this._initDriver=null,this._ready=!1,this._dbInfo=null,this._wrapLibraryMethodsWithReady(),this.setDriver(this._config.driver).catch((function(){}))}return e.prototype.config=function(e){if("object"===(void 0===e?"undefined":n(e))){if(this._ready)return new Error("Can't call config() after localforage has been used.");for(var t in e){if("storeName"===t&&(e[t]=e[t].replace(/\W/g,"_")),"version"===t&&"number"!=typeof e[t])return new Error("Database version must be a number.");this._config[t]=e[t]}return!("driver"in e)||!e.driver||this.setDriver(this._config.driver)}return"string"==typeof e?this._config[e]:this._config},e.prototype.defineDriver=function(e,t,r){var n=new S((function(t,r){try{var n=e._driver,s=new Error("Custom driver not compliant; see https://mozilla.github.io/localForage/#definedriver");if(!e._driver)return void r(s);for(var i=rt.concat("_initStorage"),o=0,a=i.length;o<a;o++){var c=i[o];if((!je(tt,c)||e[c])&&"function"!=typeof e[c])return void r(s)}var d=function(){for(var t=function(e){return function(){var t=new Error("Method "+e+" is not implemented by the current driver"),r=S.reject(t);return l(r,arguments[arguments.length-1]),r}},r=0,n=tt.length;r<n;r++){var s=tt[r];e[s]||(e[s]=t(s))}};d();var u=function(r){We[n]&&console.info("Redefining LocalForage driver: "+n),We[n]=e,Ze[n]=r,t()};"_support"in e?e._support&&"function"==typeof e._support?e._support().then(u,r):u(!!e._support):u(!0)}catch(e){r(e)}}));return d(n,t,r),n},e.prototype.driver=function(){return this._driver||null},e.prototype.getDriver=function(e,t,r){var n=We[e]?S.resolve(We[e]):S.reject(new Error("Driver not found."));return d(n,t,r),n},e.prototype.getSerializer=function(e){var t=S.resolve(Te);return d(t,e),t},e.prototype.ready=function(e){var t=this,r=t._driverSet.then((function(){return null===t._ready&&(t._ready=t._initDriver()),t._ready}));return d(r,e,e),r},e.prototype.setDriver=function(e,t,r){var n=this;Be(e)||(e=[e]);var s=this._getSupportedDrivers(e);function i(){n._config.driver=n.driver()}function o(e){return n._extend(e),i(),n._ready=n._initStorage(n._config),n._ready}function a(e){return function(){var t=0;function r(){for(;t<e.length;){var s=e[t];return t++,n._dbInfo=null,n._ready=null,n.getDriver(s).then(o).catch(r)}i();var a=new Error("No available storage method found.");return n._driverSet=S.reject(a),n._driverSet}return r()}}var c=null!==this._driverSet?this._driverSet.catch((function(){return S.resolve()})):S.resolve();return this._driverSet=c.then((function(){var e=s[0];return n._dbInfo=null,n._ready=null,n.getDriver(e).then((function(e){n._driver=e._driver,i(),n._wrapLibraryMethodsWithReady(),n._initDriver=a(s)}))})).catch((function(){i();var e=new Error("No available storage method found.");return n._driverSet=S.reject(e),n._driverSet})),d(this._driverSet,t,r),this._driverSet},e.prototype.supports=function(e){return!!Ze[e]},e.prototype._extend=function(e){it(this,e)},e.prototype._getSupportedDrivers=function(e){for(var t=[],r=0,n=e.length;r<n;r++){var s=e[r];this.supports(s)&&t.push(s)}return t},e.prototype._wrapLibraryMethodsWithReady=function(){for(var e=0,t=rt.length;e<t;e++)st(this,rt[e])},e.prototype.createInstance=function(t){return new e(t)},e}(),at=new ot;t.exports=at},{3:3}]},{},[4])(4));
/*!
    localForage -- Offline Storage, Improved
    Version 1.10.0
    https://localforage.github.io/localForage
    (c) 2013-2017 Mozilla, Apache License 2.0
*/function b(e){return e?(e^16*Math.random()>>e/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,b)}const I=/^[a-fA-F0-9]{8}-(?:[a-fA-F0-9]{4}-){3}[a-fA-F0-9]{12}$/,C="SAVED_LOCALLY",M="SAVED_TO_SERVER";class O extends g{_id;_savedRemotely=!1;static EVENT_SAVED_REMOTELY="savedremotely";static bsbiAppVersion="";set savedRemotely(e){this._savedRemotely!==e&&(this._savedRemotely=!!e,this._savedRemotely&&this.fireEvent(O.EVENT_SAVED_REMOTELY,{id:this.id}))}_savedLocally=!1;deleted=!1;createdStamp;modifiedStamp;projectId;isPristine=!1;constructor(){super(),this.createdStamp=Math.floor(Date.now()/1e3)}unsaved(){return!(this._savedLocally&&this._savedRemotely)}get id(){return this._id?"undefined"===this._id&&(console.error("id is literal 'undefined', am forcing new id"),this._id=b()):this._id=b(),this._id}set id(e){if(!e.match(I))throw new Error(`Cannot set malformed object id '${e}'.`);if(this._id&&e!==this._id)throw new Error(`Object id has already been set, when trying to set new id '${e}'.`);this._id=e}static _tasks=[];queuePost(e){return new Promise(((t,r)=>{const n=()=>(console.log({"posting form data":e}),this.post(e).then(t,r));O._tasks.push(n),O._tasks.length>1?console.log("Added post request to the queue."):(console.log("No pending tasks, starting post request immediately."),n().finally(O._next))}))}static _next(){if(O._tasks.shift(),O._tasks.length)return console.log("Running the next task."),O._tasks[0]().finally(O._next)}post(e){return fetch(this.SAVE_ENDPOINT,{method:"POST",body:e}).then((e=>{if(e.ok){return e.clone().json().then((t=>{switch(console.log({"returned to client after save":t}),t.saveState){case M:this._savedLocally=!0,this.savedRemotely=!0;break;case C:this._savedLocally=!0,this.savedRemotely=!1;break;default:console.log(`Unrecognised save state '${t.saveState}'`)}return this.createdStamp=parseInt(t.created,10),this.modifiedStamp=parseInt(t.modified,10),e.json()}))}return console.log("Save failed, presumably service worker is missing and there is no network connection. Should write to IndexedDb here."),this._savedLocally=!1,this.savedRemotely=!1,Promise.reject("IndexedDb storage not yet implemented")}))}static retrieveFromLocal(e,t){return _.getItem(`${t.TYPE}.${e}`).then((r=>r?(t._id=e,t._parseDescriptor(r),t):Promise.reject(`Failed to retrieve ${t.TYPE}.${e} locally`)))}_parseDescriptor(e){this._parseAttributes(e.attributes),this._parseSavedState(e.saveState),this.deleted=!0===e.deleted||"true"===e.deleted,this.createdStamp=parseInt(e.created,10),this.modifiedStamp=e.modified?parseInt(e.modified,10):0,this.projectId=parseInt(e.projectId,10),e.userId&&(this.userId=e.userId)}_parseAttributes(e){"string"==typeof e&&(e=JSON.parse(e)),Array.isArray(e)?this.attributes={}:this.attributes=e}_parseSavedState(e){switch(e){case C:this.savedRemotely=!1,this._savedLocally=!0;break;case M:this.savedRemotely=!0,this._savedLocally=!0;break;default:throw new Error(`Unrecognised saved state '${e}`)}}touch(){this.modifiedStamp=Math.floor(Date.now()/1e3),this.isPristine&&(this.isPristine=!1,this.createdStamp=this.modifiedStamp),this._savedLocally=!1,this.savedRemotely=!1}evaluateCompletionStatus(e){const t={};let r=!0;for(let n in e)if(e.hasOwnProperty(n)){let s=e[n];t[n]=s.validator?s.validator(n,s,this.attributes):s.field.isValid(n,s,this.attributes),null!==t[n]&&(r=r&&t[n])}return{requiredFieldsPresent:r,validity:t}}}function L(e){try{const t=document.createElement("textarea");return t.innerHTML=e,t.innerHTML.replace(/"/g,"&quot;")}catch(t){const r=document.createElement("pre");return r.appendChild(document.createTextNode(e)),r.innerHTML.replace(/"/g,"&quot;")}}class w extends g{static DEVICE_TYPE_UNKNOWN="unknown";static DEVICE_TYPE_UNCHECKED="unchecked";static DEVICE_TYPE_MOBILE="mobile";static DEVICE_TYPE_IMMOBILE="immobile";static _deviceType=w.DEVICE_TYPE_UNCHECKED;static getDeviceType(){return w._deviceType===w.DEVICE_TYPE_UNCHECKED&&(navigator.userAgentData&&"mobile"in navigator.userAgentData?(w._deviceType=navigator.userAgentData.mobile?w.DEVICE_TYPE_MOBILE:w.DEVICE_TYPE_IMMOBILE,console.log(`Evaluated device using mobile flag, result: ${w._deviceType}`)):/Android|webOS|iPhone|iPad|iPod|BlackBerry/i.test(navigator.userAgent)?(console.log(`Detected mobile via use-agent string: ${navigator.userAgent}`),w._deviceType=w.DEVICE_TYPE_MOBILE):(console.log("Flagging device type as unknown."),w._deviceType=w.DEVICE_TYPE_UNKNOWN)),w._deviceType}}class R extends O{attributes={};points=[];pointIndex=0;userId="";surveyId="";deviceId="";SAVE_ENDPOINT="/savetrack.php";TYPE="track";static _app;static trackingIsActive=!1;static _currentlyTrackedSurveyId=null;static _currentlyTrackedDeviceId=null;static _tracks=new Map;static lastPingStamp=0;static msInterval=3e4;_surveyChangeListenerHandle=null;static reset(){R._tracks=new Map,R.trackingIsActive=!1,R._currentlyTrackedSurveyId=null,R.lastPingStamp=0}static registerApp(e){R._app=e,w.getDeviceType()!==w.DEVICE_TYPE_IMMOBILE&&e.addListener(F.EVENT_CURRENT_SURVEY_CHANGED,(()=>{const e=R._app.currentSurvey;if(R._currentlyTrackedSurveyId!==e.id){let t=null;if(R._currentlyTrackedSurveyId){const e=R._tracks.get(R._currentlyTrackedSurveyId)?.get(R._currentlyTrackedDeviceId);t=this._app.surveys.get(R._currentlyTrackedSurveyId),e?(e._surveyChangeListenerHandle&&e.removeSurveyChangeListener(),e.endCurrentSeries(3),e.save().then((()=>{console.log(`Tracking for survey ${e.surveyId} saved following survey change.`)}))):console.error(`Failed to retrieve old track for survey ${R._currentlyTrackedSurveyId} in survey changed event handler.`),R._currentlyTrackedSurveyId=null,R._currentlyTrackedDeviceId=null}!e.attributes?.casual&&e.isToday()&&e.baseSurveyId===t?.baseSurveyId?(R._trackSurvey(e),R.trackingIsActive=!0):R._app.fireEvent(F.EVENT_CANCEL_WATCHED_GPS_USER_REQUEST)}})),R._app.addListener(F.EVENT_WATCH_GPS_USER_REQUEST,(()=>{const e=this._app.currentSurvey;e&&!e.attributes?.casual&&e.isToday()&&(R._trackSurvey(e),R.trackingIsActive=!0)})),R._app.addListener(F.EVENT_CANCEL_WATCHED_GPS_USER_REQUEST,(()=>{if(R.trackingIsActive){const e=R._tracks.get(R._currentlyTrackedSurveyId)?.get(R._currentlyTrackedDeviceId);e&&(e.endCurrentSeries(1),e.save().then((()=>{console.log(`Tracking for survey ${e.surveyId} saved following tracking change.`)}))),R._currentlyTrackedSurveyId=null,R._currentlyTrackedDeviceId=null,R.trackingIsActive=!1}}))}static _trackSurvey(e){let t,r=R._tracks.get(e.id);r||(r=new Map,R._tracks.set(e.id,r));const n=R._app.deviceId;r.has(n)?t=r.get(n):(t=e.initialiseNewTracker(R._app),r.set(n,t)),t.registerSurvey(e)}static ping(e,t){const r=R._tracks.get(R._currentlyTrackedSurveyId)?.get(R._currentlyTrackedDeviceId);r?.addPoint(e,t),R.lastPingStamp=e.timestamp}addPoint(e,t){let r=this.points[this.points.length-1];r&&0===r?.[1]||(r=this.startPointSeries()),r[0][r[0].length]=[e.coords.longitude,e.coords.latitude,e.timestamp],this.touch()}startPointSeries(){const e=[[],0];return this.points[this.points.length]=e,this.pointIndex++,e}endCurrentSeries(e){if(this.points.length){const t=this.points[this.points.length-1];t[0].length?t[1]=e:(delete this.points[this.points.length-1],this.pointIndex--)}else console.error("Track.endCurrentSeries called when no series in progress.")}save(e=!1){if(this.unsaved()||e){const e=new FormData;if(!this.surveyId)throw new Error("Survey id must be set before saving an occurrence.");if(!this.deviceId)throw new Error("Device id must be set before saving an occurrence.");return e.append("type",this.TYPE),e.append("surveyId",this.surveyId),e.append("deviceId",this.deviceId),e.append("id",`${this.surveyId}.${this.deviceId}`),e.append("projectId",this.projectId.toString()),e.append("pointIndex",this.pointIndex.toString()),e.append("points",JSON.stringify(this.points)),e.append("attributes",JSON.stringify(this.attributes)),e.append("created",this.createdStamp?.toString()||""),e.append("modified",this.modifiedStamp?.toString()||""),this.userId&&e.append("userId",this.userId),e.append("appVersion",O.bsbiAppVersion),console.log("queueing Track post"),this.queuePost(e)}return Promise.resolve()}_parseDescriptor(e){super._parseDescriptor(e),this.surveyId=e.surveyId,this.deviceId=e.deviceId,this.pointIndex=parseInt(e.pointIndex,10),this.points=JSON.parse(e.points)}registerSurvey(e){if(R._currentlyTrackedSurveyId=this.surveyId,R._currentlyTrackedDeviceId=R._app.deviceId,e.attributes.casual)throw new Error("Attempt to register tracking for casual survey.");this._surveyChangeListenerHandle||(this._surveyChangeListenerHandle=e.addListener(H.EVENT_MODIFIED,(()=>{R.trackingIsActive&&e.id===R._currentlyTrackedSurveyId&&(e.isToday()||(this.endCurrentSeries(2),this.save().then((()=>{console.log(`Tracking for survey ${this.surveyId} saved following survey date change.`)})),R._currentlyTrackedSurveyId=null,R._currentlyTrackedDeviceId=null,R.trackingIsActive=!1))}))),this._surveyOccurrencesChangeListenerHandle||(this._surveyOccurrencesChangeListenerHandle=e.addListener(H.EVENT_OCCURRENCES_CHANGED,(()=>{this.isPristine=!1,R.trackingIsActive&&e.id===R._currentlyTrackedSurveyId&&!this.isPristine&&this.unsaved()&&this.save().then((()=>{console.log(`Tracking for survey ${this.surveyId} saved following occurrence change.`)}))})))}removeSurveyChangeListener(){const e=R._app.surveys.get(this.surveyId);e?.removeListener(H.EVENT_MODIFIED,this._surveyChangeListenerHandle),this._surveyChangeListenerHandle=null}}class H extends O{static EVENT_MODIFIED="modified";static EVENT_OCCURRENCES_CHANGED="occurrenceschanged";static EVENT_LIST_LENGTH_CHANGED="listlengthchanged";static EVENT_TETRAD_SUBUNIT_CHANGED="tetradsubunitchanged";SAVE_ENDPOINT="/savesurvey.php";TYPE="survey";attributes={};isNew=!1;hasAppModifiedListener=!1;userId="";_track=null;_baseSurveyId="";get geoReference(){return this.attributes.georef||{gridRef:"",rawString:"",source:"unknown",latLng:null,precision:null}}get baseSurveyId(){return this._baseSurveyId&&"undefined"!==this._baseSurveyId||(this._baseSurveyId=this._id),this._baseSurveyId}set baseSurveyId(e){this._baseSurveyId=e}get id(){return this._id?"undefined"===this._id&&(console.error("id is literal 'undefined', am forcing new id"),this._id=b(),this._baseSurveyId||(this._baseSurveyId=this._id)):(this._id=b(),this._baseSurveyId||(this._baseSurveyId=this._id)),this._id}currentTetradSubunit="";get summaryReference(){if(!this.attributes.sampleUnit?.selection?.[0])return this._infer_square_ref_from_survey_ref();{let e=parseInt(this.attributes.sampleUnit.selection[0],10);if(e>0){if(2e3===e&&this.currentTetradSubunit)return{gridRef:this.currentTetradSubunit,rawString:this.currentTetradSubunit,source:"unknown",latLng:null,precision:/[A-Z]$/.test(this.currentTetradSubunit)?2e3:1e3};const t=this.geoReference,r=N.fromString(t.gridRef);if(r&&r.length<=e){const t=r.gridCoords.to_gridref(e);return this.currentTetradSubunit=2e3===e?t:"",{gridRef:t,rawString:t,source:"unknown",latLng:null,precision:e}}return{gridRef:"",rawString:"",source:"unknown",latLng:null,precision:null}}switch(this.attributes.sampleUnit.selection[0]){case"centroid":const e=this.geoReference;return{gridRef:e.gridRef,rawString:"",source:"unknown",latLng:e.latLng,precision:this.attributes.sampleUnit.precision||1e3};case"other":return this._infer_square_ref_from_survey_ref();default:throw new Error(`Unrecognized sample unit value '${this.attributes.sampleUnit.selection[0]}'`)}}}_infer_square_ref_from_survey_ref(){if(this.attributes.georef?.gridRef&&this.attributes.georef.precision<=2e3){let e;if(2e3===this.attributes.georef.precision||1e3===this.attributes.georef.precision)e=this.attributes.georef.gridRef;else{const t=this.getGeoContext();e=t.monad||t.tetrad}return{gridRef:e,rawString:e,source:"unknown",latLng:null,precision:this.attributes.georef.precision}}return{gridRef:"",rawString:"",source:"unknown",latLng:null,precision:null}}get date(){return this.attributes.date||""}get prettyDate(){const e=this.attributes.date||"",t=new Date;return e===t.toISOString().slice(0,10)?"today":e===new Date(t.valueOf()-864e5).toISOString().slice(0,10)?"yesterday":e}isToday(){return this.date===(new Date).toISOString().slice(0,10)}get place(){return this.attributes.place||""}formChangedHandler(e){console.log("Survey change handler invoked."),e.form.updateModelFromContent().then((()=>{console.log("Survey calling conditional validation."),e.form.conditionallyValidateForm(),this.touch(),this.fireEvent(H.EVENT_MODIFIED,{surveyId:this.id})})).catch((e=>{console.log({"In survey form handler promise rejected (probably normal cancellation of dialogue box)":e})}))}setAttribute(e,t){this.attributes[e]!==t&&(this.attributes[e]=t,this.touch(),this.fireEvent(H.EVENT_MODIFIED,{surveyId:this.id}))}getGeoContext(){const e=this.geoReference,t={};this.attributes.vc?.selection?t.vc=[...this.attributes.vc.selection]:t.vc=[];const r=parseInt(this.attributes.sampleUnit?.selection?.[0],10)||null;if(r&&(t.surveyGridUnit=r),e?.gridRef){const n=N.fromString(e.gridRef);n&&(n.length<=100&&100===r&&(t.hectare=n.gridCoords.to_gridref(100)),n.length<=1e3&&(t.monad=n.gridCoords.to_gridref(1e3)),n.length<=2e3&&(t.tetrad=n.gridCoords.to_gridref(2e3)),t.country=n.country),t.hectad=n.gridCoords.to_gridref(1e4),t.interleavedGridRef=N.interleave(e.gridRef)}return{hectad:"",tetrad:"",monad:"",hectare:"",country:"",vc:[],interleavedGridRef:"",...t}}save(e=!1){if(e||this.unsaved()){const e=new FormData;return e.append("type",this.TYPE),e.append("surveyId",this.id),e.append("id",this.id),e.append("projectId",this.projectId.toString()),e.append("attributes",JSON.stringify(this.attributes)),e.append("deleted",this.deleted.toString()),e.append("created",this.createdStamp?.toString()||""),e.append("baseSurveyId",this.baseSurveyId||this.id),this.userId&&e.append("userId",this.userId),e.append("appVersion",O.bsbiAppVersion),console.log("queueing survey post"),this.queuePost(e)}return Promise.reject(`Survey ${this.id} has already been saved.`)}generateSurveyName(e={summarySquarePrecision:1e3,summarizeTetrad:!1}){if(this.attributes.casual)return this.attributes.surveyName?L(this.attributes.surveyName):`Data-set created on ${this._createdDateString()}`;{let t;if(this.attributes.place){let r=this._summarySquareString(e.summarySquarePrecision);t=`${this.attributes.place}${r?` ${r}`:""}`}else t=this.attributes.georef?.gridRef?this._summarySquareString(e.summarySquarePrecision):"(unlocalized)";return`${L(t)} ${this.prettyDate||this._createdDateString()}`}}_summarySquareString(e){if(this.attributes.georef?.gridRef){let t;const r=this.attributes.georef.gridRef.replace(/[<&\s]/g,"");this.attributes.sampleUnit&&(t=parseInt(this.attributes.sampleUnit?.selection[0],10)||null);const n=t||e;if(n){const e=N.fromString(r);return e?.gridCoords?.to_gridref(e.length<=n?n:e.length)||this.attributes.georef.gridRef}return r}return""}_createdDateString(){const e=new Date(1e3*this.createdStamp);let t;try{t=e.toLocaleString("default",{year:"numeric",month:"long",day:"numeric"})}catch(r){t=e.toLocaleString("en-GB",{year:"numeric",month:"long",day:"numeric"})}return t}extantOccurrenceKeys=new Set;countRecords(){return this.extantOccurrenceKeys.size}_parseDescriptor(e){super._parseDescriptor(e),this._baseSurveyId=e.baseSurveyId}duplicate(e={},t={}){const r=new H;return r.attributes=Object.assign(structuredClone(this.attributes),e),r.userId=t.hasOwnProperty("userId")?t.userId:this.userId,r.isPristine=!0,r.isNew=!1,r._savedLocally=!1,r._savedRemotely=!1,r.deleted=!1,r.projectId=this.projectId,r.baseSurveyId=this.baseSurveyId,r.id,r}initialiseNewTracker(e){const t=new R;return t.surveyId=this.id,t.deviceId=e.deviceId,t.projectId=e.projectId,t.isPristine=!0,this.track=t,t.registerSurvey(this),t}get track(){return this._track}set track(e){this._track=e}}class D extends Error{}class P extends Error{}class U{static PARENT_IDS_KEY=10;static GR_PRESENCE_KEY=18;static RPR_KEY=19;static VC_PRESENCE_KEY=20;static rawTaxa;static includeAtlasDocumentation=!1;id;nameString="";canonical="";hybridCanonical="";acceptedEntityId="";qualifier="";authority="";vernacular="";vernacularRoot="";badVernacular=!1;used;sortOrder;parentIds=[];nationalStatus={GB:null,IE:null,CI:null};rareScarceStatus={GB:null,IE:null};rprStatus={};occurrenceCoverage=null;vcPresence=null;nyphRanking=null;documentation=null;static showVernacular=!0;static setTaxa(e){U.rawTaxa=e}static initialiseTaxa(e,t){U.rawTaxa=e,e.stamp+604800<Date.now()/1e3&&(console.log(`Taxon list may be stale (stamp is ${e.stamp}), prompting re-cache.`),navigator?.serviceWorker?.ready.then((e=>{e.active.postMessage({action:"recache",url:t})})))}static fromId(e){if(!U.rawTaxa)throw new P("Taxon.fromId() called before taxon list has been initialized.");if(!U.rawTaxa.hasOwnProperty(e))throw new P(`Taxon id '${e}' not found.`);const t=U.rawTaxa[e],r=new U;return r.id=e,r.nameString=t[0],r.canonical=t[1]||t[0],r.hybridCanonical=t[2]||r.canonical,r.acceptedEntityId=t[3]||e,r.qualifier=t[4]||"",r.authority=t[5]||"",r.vernacular=t[6]||"",r.vernacularRoot=t[7]||"",r.used=!!t[8],r.sortOrder=t[9],r.parentIds=t[10],r.badVernacular=!!t[11],r.nyphRanking=t[17]||null,r.nationalStatus={GB:t[12]||null,IE:t[13]||null,CI:t[14]||null},r.rareScarceStatus={GB:t[15]||null,IE:t[16]||null},r.rprStatus=t[U.RPR_KEY]||null,r.occurrenceCoverage=t[U.GR_PRESENCE_KEY]||null,r.vcPresence=t[U.VC_PRESENCE_KEY]||null,r}seekRankedAncestor(e,t=56,r=!0,n=!0){const s=[this];do{let i=s.pop();if(i.sortOrder<=e&&i.sortOrder>=t&&(!r||"agg."!==i.qualifier&&"s.l."!==i.qualifier))return i;if(!(i.sortOrder<t||n&&120===i.sortOrder)&&i.parentIds?.length)for(let e of i.parentIds)try{s[s.length]=U.fromId(e)}catch{}}while(s.length);return null}formattedHTML(e){let t;this.id!==this.acceptedEntityId&&(t=U.fromId(this.acceptedEntityId));return e?t?`<q class="taxon-vernacular">${L(this.vernacular)}</q><wbr> <span class="italictaxon">${this.nameString}${this.qualifier?` <span class="taxon-qualifier">${this.qualifier}</span>`:""}</span> <span class="taxauthority">${L(this.authority)}</span> = <span class="italictaxon">${t.nameString}${t.qualifier?` <span class="taxon-qualifier">${t.qualifier}</span>`:""}</span> <span class="taxauthority">${L(t.authority)}</span>`:`<q class="taxon-vernacular">${L(this.vernacular)}</q><wbr> <span class="italictaxon">${this.nameString}${this.qualifier?` <span class="taxon-qualifier">${this.qualifier}</span>`:""}</span> <span class="taxauthority">${L(this.authority)}</span>`:t?`<span class="italictaxon">${this.nameString}${this.qualifier?` <span class="taxon-qualifier">${this.qualifier}</span>`:""}</span> <span class="taxauthority">${this.authority}</span>${this.vernacular?` <wbr><q class="taxon-vernacular">${L(this.vernacular)}</q>`:""} = <span class="italictaxon">${t.nameString}${t.qualifier?` <span class="taxon-qualifier">${t.qualifier}</span>`:""}</span> <span class="taxauthority">${L(t.authority)}</span>`:`<span class="italictaxon">${this.nameString}${this.qualifier?` <span class="taxon-qualifier">${this.qualifier}</span>`:""}</span> <span class="taxauthority">${L(this.authority)}</span>${this.vernacular?` <wbr><q class="taxon-vernacular">${L(this.vernacular)}</q>`:""}`}}class A extends O{attributes={};userId="";SAVE_ENDPOINT="/saveoccurrence.php";TYPE="occurrence";static EVENT_MODIFIED="modified";isNew=!1;get taxon(){return this.attributes.taxon?.taxonId?U.fromId(this.attributes.taxon.taxonId):null}formChangedHandler(e){console.log("Occurrence change handler invoked."),e.form.updateModelFromContent().then((()=>{e.form.conditionallyValidateForm(),this.changeApplied()}))}changeApplied(){this.touch(),this.fireEvent(A.EVENT_MODIFIED,{occurrenceId:this.id})}delete(){this.deleted||(this.touch(),this.deleted=!0,this.fireEvent(A.EVENT_MODIFIED,{occurrenceId:this.id}))}save(e="",t=!1){if(this.unsaved()||t){const e=new FormData;if(!this.surveyId)throw new Error(`Survey id must be set before saving an occurrence. Failed for occ id '${this.id}'`);return e.append("type",this.TYPE),e.append("surveyId",this.surveyId),e.append("occurrenceId",this.id),e.append("id",this.id),e.append("projectId",this.projectId.toString()),e.append("attributes",JSON.stringify(this.attributes)),e.append("deleted",this.deleted.toString()),e.append("created",this.createdStamp?.toString()||""),e.append("modified",this.modifiedStamp?.toString()||""),this.userId&&e.append("userId",this.userId),e.append("appVersion",O.bsbiAppVersion),console.log("queueing occurrence post"),this.queuePost(e)}return Promise.reject(`Occurrence ${this.id} has already been saved.`)}_parseDescriptor(e){super._parseDescriptor(e),this.surveyId=e.surveyId}getGeoContext(){const e=this.geoReference,t={};if(this.attributes.vc?.selection?t.vc=[...this.attributes.vc.selection]:t.vc=[],e?.gridRef){const r=N.fromString(e.gridRef);r&&(r.length<=1e3&&(t.monad=r.gridCoords.to_gridref(1e3)),r.length<=2e3&&(t.tetrad=r.gridCoords.to_gridref(2e3)),t.country=r.country),t.hectad=r.gridCoords.to_gridref(1e4),t.interleavedGridRef=N.interleave(e.gridRef)}return{hectad:"",tetrad:"",monad:"",country:"",vc:[],interleavedGridRef:"",...t}}get geoReference(){return this.attributes.georef||{gridRef:"",rawString:"",source:"unknown",latLng:null,precision:null}}}class J extends O{file;static imageCache=new Map;TYPE="image";occurrenceId="";surveyId="";context="occurrence";getUrl(){throw new Error("OccurrenceImage getUrl() not implemented.")}SAVE_ENDPOINT="/saveimage.php";static fromFile(e){const t=new J;return t.file=e,t}save(e="",t="",r=null){if(e&&(this.surveyId=e),r&&(this.projectId=r),t&&(this.occurrenceId=t),this.unsaved()){const n=new FormData;return n.append("type",this.TYPE),n.append("surveyId",e||(this.surveyId?this.surveyId:"")),n.append("projectId",r?r.toString():""),n.append("imageId",this.id),n.append("id",this.id),n.append("image",this.file),n.append("deleted",this.deleted.toString()),n.append("created",this.createdStamp?.toString()||""),n.append("modified",this.modifiedStamp?.toString()||""),"survey"===this.context?n.append("context",this.context):n.append("occurrenceId",t||this.occurrenceId),this.userId&&n.append("userId",this.userId),n.append("appVersion",O.bsbiAppVersion),console.log(`queueing image post, image id ${this.id}`),this.queuePost(n)}return Promise.reject(`Image ${this.id} has already been saved.`)}static EVENT_MODIFIED="modified";static placeholder(e){let t=new J;return t.id=e,J.imageCache.set(e,t),t}_parseDescriptor(e){super._parseDescriptor(e),this.surveyId=e.surveyId,e.occurrenceId&&(this.occurrenceId=e.occurrenceId),this.file=e.image,e.context&&(this.context=e.context)}static imageLink(e,t,r,n){t=t||0,r=r||0;let s="";n.className&&(s+=` class="${n.className}"`);return`<picture><source srcset="/image.php?imageid=${e}&amp;height=128&amp;format=webp" type="image/webp"><img${s} src="/image.php?imageid=${e}&amp;width=${t}&amp;height=${r}&amp;format=jpeg" ${t>r?`width="${t}"`:`height="${r}"`} alt="photo"></picture>`}}class Y{static app;static logError=function(e,t="",r="",n=null,s=null){window.onerror=null,console.error(e,t,r,s),console.trace&&console.trace("Trace");const i=document.implementation.createDocument("","response",null),o=i.createElement("error");return null!=r&&o.setAttribute("line",r),s&&"stack"in s&&o.setAttribute("stack",s.stack),null!=t&&""!==t&&o.setAttribute("url",t),window.location.href&&o.setAttribute("referrer",window.location.href),window.location.search&&o.setAttribute("urlquery",window.location.search),window.location.hash&&o.setAttribute("urlhash",window.location.hash),Y.app?.session?.userId&&o.setAttribute("userid",Y.app.session.userId),o.setAttribute("browser",navigator.appName),o.setAttribute("browserv",navigator.appVersion),o.setAttribute("userAgent",navigator.userAgent),o.setAttribute("versions",O.bsbiAppVersion),o.appendChild(i.createTextNode(e)),i.documentElement.appendChild(o),fetch("/javascriptErrorLog.php",{method:"POST",mode:"cors",cache:"no-cache",credentials:"include",headers:{"Content-Type":"text/xml"},redirect:"follow",referrerPolicy:"no-referrer-when-downgrade",body:(new XMLSerializer).serializeToString(i)}),window.onerror=Y.logError,!0}}class F extends g{_router;_containerEl;controllers=[];currentControllerHandle=!1;routeHistory=[];occurrences=new Map;surveys=new Map;_currentSurvey=null;projectId;static EVENT_ADD_SURVEY_USER_REQUEST="useraddsurveyrequest";static EVENT_RESET_SURVEYS="userresetsurveys";static EVENT_NEW_SURVEY="newsurvey";static LOAD_SURVEYS_ENDPOINT="/loadsurveys.php";static EVENT_OCCURRENCE_ADDED="occurrenceadded";static EVENT_SURVEY_LOADED="surveyloaded";static EVENT_OCCURRENCE_LOADED="occurrenceloaded";static EVENT_CURRENT_OCCURRENCE_CHANGED="currentoccurrencechanged";static EVENT_CURRENT_SURVEY_CHANGED="currentsurveychanged";static EVENT_SURVEYS_CHANGED="surveyschanged";static EVENT_ALL_SYNCED_TO_SERVER="allsyncedtoserver";static EVENT_SYNC_ALL_FAILED="syncallfailed";static EVENT_USER_LOGIN="login";static EVENT_USER_LOGOUT="logout";static EVENT_WATCH_GPS_USER_REQUEST="watchgps";static EVENT_CANCEL_WATCHED_GPS_USER_REQUEST="cancelgpswatch";static CURRENT_SURVEY_KEY_NAME="currentsurvey";static SESSION_KEY_NAME="session";static DEVICE_ID_KEY_NAME="deviceid";static RESERVED_KEY_NAMES=[F.CURRENT_SURVEY_KEY_NAME,F.SESSION_KEY_NAME,F.DEVICE_ID_KEY_NAME];static devMode=!1;constructor(){super()}set currentSurvey(e){if(this._currentSurvey!==e){this._currentSurvey=e||null;let t=e?.id;_.setItem(F.CURRENT_SURVEY_KEY_NAME,t).then((()=>{this.fireEvent(F.EVENT_CURRENT_SURVEY_CHANGED,{newSurvey:e})}))}}_deviceId="";initialiseDeviceId(){return this._deviceId?Promise.resolve(this._deviceId):_.getItem(F.DEVICE_ID_KEY_NAME).then((e=>{if(e)return this._deviceId=e,e;{const e=b();return _.setItem(F.DEVICE_ID_KEY_NAME,e).then((()=>(this._deviceId=e,e)))}}))}get deviceId(){if(!this._deviceId)throw new Error("Device ID has not been initialised.");return this._deviceId}forageSetItem(e,t){return _.setItem(e,t)}forageGetItem(e){return _.getItem(e)}forageRemoveItem(e){return _.removeItem(e)}get currentSurvey(){return this._currentSurvey}getLastSurveyId(){return _.getItem(F.CURRENT_SURVEY_KEY_NAME).catch((e=>(console.log({"Error retrieving last survey id":e}),Promise.resolve(null))))}clearLastSurveyId(){return _.removeItem(F.CURRENT_SURVEY_KEY_NAME).catch((e=>(console.log({"Error removing last survey id":e}),Promise.resolve(null))))}layout;setLocalForageName(e){_.config({name:e})}reset(){return this.surveys=new Map,R.reset(),this.clearCurrentSurvey().then(this.clearLastSurveyId)}clearCurrentSurvey(){return this.occurrences=new Map,this._currentSurvey=null,this.clearLastSurveyId()}set router(e){this._router=e}get router(){return this._router}set containerId(e){const t=document.getElementById(e);if(!t)throw new Error(`App container '${e}' not found.`);this._containerEl=t}get container(){return this._containerEl}registerController(e){e.handle=this.controllers.length,this.controllers[this.controllers.length]=e,e.app=this,e.registerRoute(this._router)}initialise(){this.layout.initialise(),this._router.notFound((e=>{console.log(`no route found for '${e}'`),this.notFoundView()})),this._router.on((()=>{console.log("redirecting from '/' to '/list'"),this._router.pause(),this.currentSurvey&&this.currentSurvey.isPristine?this._router.navigate("/list/survey/welcome").resume():this._router.navigate("/list").resume(),this._router.resolve()}));for(let e of this.controllers)e.initialise()}display(){this.syncAll(!0).then((()=>{this._router.resolve()}))}saveRoute(){const e=this._router.lastRouteResolved();this.routeHistory.length?this.routeHistory[this.routeHistory.length-1]!==e&&(this.routeHistory[this.routeHistory.length]=e):this.routeHistory[0]=e}markAllNotPristine(){for(let e of this.occurrences)e[1].isPristine=!1}setLayout(e){this.layout=e,e.setApp(this)}addSurvey(e){if(e.projectId!==this.projectId)throw new Error(`Survey project id '${e.projectId} does not match with current project ('${this.projectId}')`);e.hasAppModifiedListener||(e.hasAppModifiedListener=!0,e.addListener(H.EVENT_MODIFIED,(()=>{e.save().finally((()=>{this.fireEvent(F.EVENT_SURVEYS_CHANGED)}))}))),this.surveys.set(e.id,e),this.fireEvent(F.EVENT_SURVEYS_CHANGED)}haveExtantOccurrences(){for(let e of this.occurrences)if(!e.deleted)return!0;return!1}addOccurrence(e){if(!e.surveyId)throw new D("Survey id must set prior to registering occurrence.");const t=this.surveys.get(e.surveyId);if(!t)throw new Error(`Failed to look up survey id ${e.surveyId}`);e.createdStamp&&(0===this.occurrences.size||t.createdStamp>e.createdStamp)&&(t.createdStamp=e.createdStamp),this.occurrences.set(e.id,e),e.addListener(A.EVENT_MODIFIED,(()=>{const t=this.surveys.get(e.surveyId);if(!t)throw new Error(`Failed to look up survey id ${e.surveyId}`);t.isPristine=!1,t.save(!0),e.save().finally((()=>{t.fireEvent(H.EVENT_OCCURRENCES_CHANGED,{occurrenceId:e.id})}))})),this.fireEvent(F.EVENT_OCCURRENCE_LOADED,{occurrence:e})}refreshFromServer(e){console.log({"Refresh from server, ids":e});const t=new FormData;let r=0;for(let n of e)n&&"undefined"!==n&&t.append(`surveyId[${r++}]`,n);return this.session?.userId&&t.append("userId",this.session.userId),fetch(F.LOAD_SURVEYS_ENDPOINT,{method:"POST",body:t}).then((e=>e.ok?e.json():Promise.reject("Invalid response from server when refreshing survey ids"))).then((e=>{console.log({"refresh from server json response":e});const t=[];for(let r in e)if(e.hasOwnProperty(r))for(let n of e[r])t.push(this._conditionallyReplaceObject(n));return Promise.all(t)}))}_conditionallyReplaceObject(e){const t=`${e.type}.${e.id}`;return _.getItem(t).then((r=>r&&!e.deleted&&r.modified>=e.modified?(console.info(`Local copy of ${t} is the same or newer than the server copy. (${r.modified} >= ${e.modified}) `),Promise.resolve()):(console.info(`Adding or replacing local copy of ${t}`),_.setItem(t,e))))}seekKeys(e){return _.keys().then((t=>{for(let r of t)if(!F.RESERVED_KEY_NAMES.includes(r)){let t,n;[t,n]=r.split(".",2),e.hasOwnProperty(t)?e[t].includes(n)||e[t].push(n):"track"!==t&&console.error(`Unrecognised stored key type '${t}.`)}return e}))}syncAll(e=!0){return this.seekKeys({survey:[],occurrence:[],image:[],track:[]}).then((t=>this._syncLocalUnsaved(t,e).then((t=>(e||this.fireEvent(F.EVENT_ALL_SYNCED_TO_SERVER),t)))),(e=>(console.error(`Failed to sync all: ${e}`),Y.logError(`Failed to sync all: ${e}`),this.fireEvent(F.EVENT_SYNC_ALL_FAILED),!1)))}queryLocalSurveys(e){const t=[];for(const r of this.surveys){const n=r[1];e.structuredSurvey&&n.attributes.casual||(e.defaultCasual&&!n.attributes.defaultCasual||e.isToday&&!n.isToday()||e.monad&&n.getGeoContext()?.monad!==e.monad||e.tetrad&&n.getGeoContext()?.tetrad!==e.tetrad||e.sampleUnit&&n.attributes?.sampleUnit?.selection[0]!==e.sampleUnit||e.hasOwnProperty("userId")&&e.userId!==n.userId||e.excludeSurveyId!==n.id&&(e.date&&e.date!==n.date||(t[t.length]=n)))}return t}_syncLocalUnsaved(e,t=!1){const r=[];t&&(r[0]=Promise.resolve(!0));for(let t of e.survey)r.push(H.retrieveFromLocal(t,new H).then((e=>{if(e.unsaved())return e.save(!0)})));for(let t of e.occurrence)r.push(A.retrieveFromLocal(t,new A).then((e=>{if(e.unsaved())return e.save("",!0)})));for(let t of e.image)r.push(J.retrieveFromLocal(t,new J).then((e=>{if(e.unsaved())return e.save()})));return t?Promise.race(r):Promise.all(r).catch((e=>(console.log(`Save failure: ${e}`),Promise.reject(e))))}restoreOccurrences(e="",t=!1){return console.log(`Invoked restoreOccurrences, target survey id: ${e}`),"undefined"===e&&(console.error("Attempt to restore occurrences for literal 'undefined' survey id."),e=""),e?this._restoreOccurrenceImp(e,t):this.getLastSurveyId().then((e=>(console.log(`Retrieved last used survey id '${e}'`),this._restoreOccurrenceImp(e,t).catch((()=>(console.log(`Failed to retrieve lastSurveyId ${e}. Resetting current survey and retrying.`),this.currentSurvey=null,this._restoreOccurrenceImp("",t)))))),(()=>this._restoreOccurrenceImp("",t)))}_restoreOccurrenceImp(e="",t=!1){if(e&&this.surveys.has(e)){const t=this.surveys.get(e);if(t.isPristine)return this.clearCurrentSurvey().then((()=>(this.currentSurvey=t,this.fireEvent(F.EVENT_SURVEYS_CHANGED),Promise.resolve())))}const r={survey:[],occurrence:[],image:[]};return e&&(r.survey[0]=e),this.clearCurrentSurvey().then((()=>this.seekKeys(r))).then((e=>e.survey.length||this.session?.userId?this.refreshFromServer(e.survey).finally((()=>this.seekKeys(e))):null)).finally((()=>{if(console.log({storedObjectKeys:r}),r?.survey?.length){const n=[];let s=0;for(let t of r.survey)n.push(this._restoreSurveyFromLocal(t,r,e===t||!e&&0==s++));return Promise.all(n).finally((()=>{if(!this.currentSurvey&&t)return console.log(`Failed to retrieve survey id '${e}'`),Promise.reject(new Error(`Failed to retrieve survey id '${e}'`));if(this.currentSurvey?.deleted){if(this.currentSurvey=null,t)return Promise.reject(new Error(`Survey id '${e}' ${this.currentSurvey?.deleted?"is deleted":"not found"}.`));this.setNewSurvey()}return this.fireEvent(F.EVENT_SURVEYS_CHANGED),this.currentSurvey?.fireEvent(H.EVENT_OCCURRENCES_CHANGED),this.currentSurvey?.fireEvent(H.EVENT_LIST_LENGTH_CHANGED),Promise.resolve()}))}return t?(console.log("no pre-existing survey"),this.fireEvent(F.EVENT_SURVEYS_CHANGED),Promise.reject(new Error("Failed to match survey."))):(console.log("no pre-existing surveys, so creating a new one"),this.setNewSurvey(),Promise.resolve())}))}setNewSurvey(e){const t=new H;t.id,e&&(t.attributes={...t.attributes,...e}),t.projectId=this.projectId,t.isPristine=!0,t.isNew=!0,this.session?.userId&&(t.userId=this.session.userId),this.currentSurvey=t,this.addSurvey(t),this.fireEvent(F.EVENT_NEW_SURVEY)}addAndSetSurvey(e){this.currentSurvey=e,this.addSurvey(e),this.fireEvent(F.EVENT_NEW_SURVEY)}addNewOccurrence(e,t){const r=new A,n=this.currentSurvey;if(!n)throw new Error("Current survey unset when adding new occurrence.");return r.id,r.surveyId=n.id,r.projectId=this.projectId,n.userId&&(r.userId=n.userId),r.isNew=!0,r.isPristine=!0,e&&Object.keys(e).length&&(r.attributes={...r.attributes,...e},r.touch()),t&&Object.keys(t).length&&(r.attributes={...r.attributes,...t}),this.addOccurrence(r),n.extantOccurrenceKeys.add(r.id),this.fireEvent(F.EVENT_OCCURRENCE_ADDED,{occurrenceId:r.id,surveyId:r.surveyId}),n.fireEvent(H.EVENT_OCCURRENCES_CHANGED,{occurrenceId:r.id}),n.fireEvent(H.EVENT_LIST_LENGTH_CHANGED),r.fireEvent(A.EVENT_MODIFIED),r}_restoreSurveyFromLocal(e,t,r){let n=this.session?.userId,s=H.retrieveFromLocal(e,new H).then((s=>{if(console.log(`retrieving local survey ${e}`),this.fireEvent(F.EVENT_SURVEY_LOADED,{survey:s}),!n&&!s.userId||s.userId===n||this.session?.superAdmin){if(r)return this.clearCurrentSurvey().then((()=>{this.addSurvey(s);const r=[];for(let n of t.occurrence)r.push(A.retrieveFromLocal(n,new A).then((t=>{t.surveyId===e?(this.addOccurrence(t),s.extantOccurrenceKeys.add(t.id)):this.surveys.get(t.surveyId)?.extantOccurrenceKeys?.add(t.id)})));return Promise.all(r)}));this.addSurvey(s)}else console.log(`Skipping survey id ${s.id} that belongs to user ${s.userId}`)}));return r&&s.finally((()=>{const r=[];for(let n of t.image)r.push(J.retrieveFromLocal(n,new J).then((t=>{console.log(`restoring image id '${n}'`),t.surveyId===e&&J.imageCache.set(n,t)}),(e=>{console.log(`Failed to retrieve an image: ${e}`)})));return this.currentSurvey=this.surveys.get(t.survey[0])||null,this.currentSurvey?Promise.all(r):Promise.resolve()})),s}clearLocalForage(){return _.clear()}notFoundView(){}}class G{static responses={};static fromPostedData(e){const t={saveState:C};for(let r of e.entries())t[r[0]]=r[1];if(!t.type)throw new Error("Missing type in form data.");if(G.responses.hasOwnProperty(t.type))return new G.responses[t.type](t,{});throw new Error(`Unrecognised post type '${t.type}'`)}static fromPostResponse(e){if(!e)throw new Error("Invalid empty post response.");if(!e.type)throw new Error("Missing type in returned response.");if(G.responses.hasOwnProperty(e.type))return console.log(`in fromPostResponse returning a ${e.type}`),new G.responses[e.type]({},e);throw new Error(`Unrecognised post type '${e.type}'`)}}function $(e){const t=new Headers;return t.set("Content-Type","application/json"),new Response(JSON.stringify(e),{status:e.error?500:200,headers:t})}class x{toSaveLocally;returnedToClient;prebuiltResponse;failureErrorMessage="Failed to save a local copy on your device.";failureErrorHelp="Your internet connection may have failed (or there could be a problem with the server). It wasn't possible to save a temporary copy on your device. Perhaps there is insufficient space? Please try to re-establish a network connection and try again.";constructor(e,t){this.toSaveLocally=e,this.returnedToClient=t}setPrebuiltResponse(e){return this.prebuiltResponse=e,this}storeLocally(){return _.setItem(this.localKey(),this.toSaveLocally).then((()=>(console.log(`Stored object ${this.localKey()} locally`),this.prebuiltResponse?this.prebuiltResponse:$(this.returnedToClient))),(e=>(console.log(`Failed to store object ${this.localKey()} locally`),console.log({reason:e}),this.returnedToClient.error=this.failureErrorMessage,this.returnedToClient.errorHelp=this.failureErrorHelp,$(this.returnedToClient))))}localKey(){throw new Error(`LocalKey must be implemented in a subclass for ${this.toSaveLocally.type}`)}populateClientResponse(){}}class K extends x{failureErrorMessage="Failed to store image.";failureErrorHelp="Your internet connection may have failed (or there could be a problem with the server). It wasn't possible to save a temporary copy on your device. Perhaps there is insufficient space? Please try to re-establish a network connection and try again.";populateClientResponse(){return this.returnedToClient.id=this.toSaveLocally.imageId?this.toSaveLocally.imageId:this.toSaveLocally.id,this.returnedToClient.imageId=this.toSaveLocally.imageId?this.toSaveLocally.imageId:this.toSaveLocally.id,this.returnedToClient.type="image",this.returnedToClient.surveyId=this.toSaveLocally.surveyId,this.returnedToClient.created=parseInt(this.toSaveLocally.created,10),this.returnedToClient.modified=parseInt(this.toSaveLocally.modified,10),this.returnedToClient.saveState=C,this.returnedToClient.deleted=this.toSaveLocally.deleted,this.returnedToClient.projectId=parseInt(this.toSaveLocally.projectId,10),this.returnedToClient.context=this.toSaveLocally.context,"survey"!==this.toSaveLocally.context&&(this.returnedToClient.occurrenceId=this.toSaveLocally.occurrenceId),this}populateLocalSave(){return this.toSaveLocally.surveyId=this.returnedToClient.surveyId,this.toSaveLocally.type="image",this.toSaveLocally.imageId=this.returnedToClient.id?this.returnedToClient.id:this.returnedToClient.imageId,this.toSaveLocally.id=this.returnedToClient.id?this.returnedToClient.id:this.returnedToClient.imageId,this.toSaveLocally.created=parseInt(this.returnedToClient.created,10),this.toSaveLocally.modified=parseInt(this.returnedToClient.modified,10),this.toSaveLocally.saveState=M,this.toSaveLocally.deleted=!0===this.returnedToClient.deleted||"true"===this.returnedToClient.deleted,this.toSaveLocally.projectId=parseInt(this.returnedToClient.projectId,10),this.toSaveLocally.context=this.returnedToClient.context,"survey"!==this.returnedToClient.context&&(this.toSaveLocally.occurrenceId=this.returnedToClient.occurrenceId),this}localKey(){return`image.${this.toSaveLocally.imageId}`}static register(){G.responses.image=K}}class k extends x{failureErrorMessage="Failed to store survey.";failureErrorHelp="Your internet connection may have failed (or there could be a problem with the server). It wasn't possible to save a temporary copy on your device. Perhaps there is insufficient space? Please try to re-establish a network connection and try again.";populateClientResponse(){return this.returnedToClient.surveyId=this.toSaveLocally.id||this.toSaveLocally.surveyId,this.returnedToClient.id=this.toSaveLocally.id?this.toSaveLocally.id:this.toSaveLocally.surveyId,this.returnedToClient.baseSurveyId=this.toSaveLocally.baseSurveyId||this.returnedToClient.id,this.returnedToClient.type="survey",this.returnedToClient.attributes=this.toSaveLocally.attributes,this.returnedToClient.created=this.toSaveLocally.created,this.returnedToClient.modified=this.toSaveLocally.modified,this.returnedToClient.saveState=C,this.returnedToClient.deleted=this.toSaveLocally.deleted,this.returnedToClient.projectId=this.toSaveLocally.projectId,this.returnedToClient.userId=this.toSaveLocally.userId||"",this}populateLocalSave(){return this.toSaveLocally.surveyId=this.returnedToClient.id?this.returnedToClient.id:this.returnedToClient.surveyId,this.toSaveLocally.id=this.returnedToClient.id?this.returnedToClient.id:this.returnedToClient.surveyId,this.toSaveLocally.baseSurveyId=this.returnedToClient.baseSurveyId||this.toSaveLocally.id,this.toSaveLocally.type="survey",this.toSaveLocally.attributes=this.returnedToClient.attributes,this.toSaveLocally.created=parseInt(this.returnedToClient.created,10),this.toSaveLocally.modified=parseInt(this.returnedToClient.modified,10),this.toSaveLocally.saveState=M,this.toSaveLocally.deleted=this.returnedToClient.deleted,this.toSaveLocally.projectId=parseInt(this.returnedToClient.projectId,10),this.toSaveLocally.userId=this.returnedToClient.userId||"",this}localKey(){return`survey.${this.toSaveLocally.surveyId}`}static register(){G.responses.survey=k}}class Q extends x{failureErrorMessage="Failed to store occurrence.";failureErrorHelp="Your internet connection may have failed (or there could be a problem with the server). It wasn't possible to save a temporary copy on your device. Perhaps there is insufficient space? Please try to re-establish a network connection and try again.";populateClientResponse(){return this.returnedToClient.id=this.toSaveLocally.occurrenceId?this.toSaveLocally.occurrenceId:this.toSaveLocally.id,this.returnedToClient.occurrenceId=this.toSaveLocally.occurrenceId?this.toSaveLocally.occurrenceId:this.toSaveLocally.id,this.returnedToClient.type="occurrence",this.returnedToClient.surveyId=this.toSaveLocally.surveyId,this.returnedToClient.attributes=this.toSaveLocally.attributes,this.returnedToClient.created=parseInt(this.toSaveLocally.created,10),this.returnedToClient.modified=parseInt(this.toSaveLocally.modified,10),this.returnedToClient.saveState=C,this.returnedToClient.deleted=this.toSaveLocally.deleted,this.returnedToClient.projectId=parseInt(this.toSaveLocally.projectId,10),this.returnedToClient.userId=this.toSaveLocally.userId||"",this}populateLocalSave(){return this.toSaveLocally.occurrenceId=this.returnedToClient.id?this.returnedToClient.id:this.returnedToClient.occurrenceId,this.toSaveLocally.id=this.returnedToClient.id?this.returnedToClient.id:this.returnedToClient.occurrenceId,this.toSaveLocally.type="occurrence",this.toSaveLocally.surveyId=this.returnedToClient.surveyId,this.toSaveLocally.attributes=this.returnedToClient.attributes,this.toSaveLocally.created=parseInt(this.returnedToClient.created,10),this.toSaveLocally.modified=parseInt(this.returnedToClient.modified,10),this.toSaveLocally.saveState=M,this.toSaveLocally.deleted=!0===this.returnedToClient.deleted||"true"===this.returnedToClient.deleted,this.toSaveLocally.projectId=parseInt(this.returnedToClient.projectId,10),this.toSaveLocally.userId=this.returnedToClient.userId||"",this}localKey(){return`occurrence.${this.toSaveLocally.occurrenceId}`}static register(){G.responses.occurrence=Q}}class X extends x{failureErrorMessage="Failed to store tracking data.";failureErrorHelp="Your internet connection may have failed (or there could be a problem with the server). It wasn't possible to save a temporary copy on your device. Perhaps there is insufficient space? Please try to re-establish a network connection and try again.";populateClientResponse(){return this.returnedToClient.surveyId=this.toSaveLocally.surveyId,this.returnedToClient.deviceId=this.toSaveLocally.deviceId,this.returnedToClient.type="track",this.returnedToClient.attributes=this.toSaveLocally.attributes,this.returnedToClient.created=this.toSaveLocally.created,this.returnedToClient.modified=this.toSaveLocally.modified,this.returnedToClient.saveState=C,this.returnedToClient.deleted=this.toSaveLocally.deleted||"",this.returnedToClient.projectId=this.toSaveLocally.projectId,this.returnedToClient.userId=this.toSaveLocally.userId||"",this.returnedToClient.pointIndex=this.toSaveLocally.pointIndex,this.returnedToClient.points=this.toSaveLocally.points,this}populateLocalSave(){return this.toSaveLocally.surveyId=this.returnedToClient.surveyId,this.toSaveLocally.deviceId=this.returnedToClient.deviceId,this.toSaveLocally.type="track",this.toSaveLocally.attributes=this.returnedToClient.attributes,this.toSaveLocally.created=parseInt(this.returnedToClient.created,10),this.toSaveLocally.modified=parseInt(this.returnedToClient.modified,10),this.toSaveLocally.saveState=M,this.toSaveLocally.deleted=this.returnedToClient.deleted,this.toSaveLocally.projectId=parseInt(this.returnedToClient.projectId,10),this.toSaveLocally.userId=this.returnedToClient.userId||"",this.toSaveLocally.pointIndex=parseInt(this.returnedToClient.pointIndex,10),this.toSaveLocally.points=this.returnedToClient.points,this}localKey(){return`track.${this.toSaveLocally.surveyId}.${this.toSaveLocally.deviceId}`}static register(){G.responses.track=X}}let V=location.pathname.split("/")[1];if((new Date).toJSON().slice(0,10)>="2024-02-01")throw new Error("Built-in expiry date has passed for NYPH.");(new class{URL_CACHE_SET;CACHE_VERSION;DATA_CACHE_VERSION;SERVICE_WORKER_DATA_URL_MATCHES;initialise(e){Promise.prototype.finally||(Promise.prototype.finally=function(e){return this.then(e).catch(e)}),K.register(),k.register(),Q.register(),X.register(),this.CACHE_VERSION=`version-1.0.3.1703156307-${e.version}`,this.DATA_CACHE_VERSION=`bsbi-data-${e.dataVersion||e.version}`,O.bsbiAppVersion=e.version;const t=e.postPassThroughWhitelist,r=e.postImageUrlMatch,n=e.getImageUrlMatch,s=e.interceptUrlMatches,i=e.ignoreUrlMatches,o=e.passThroughNoCache;this.SERVICE_WORKER_DATA_URL_MATCHES=e.dataUrlMatches||/^NO_MATCHING$/;const a=e.staticUrlMatches,c=e.indexUrl;this.URL_CACHE_SET=e.urlCacheSet,_.config({name:e.forageName}),self.addEventListener("message",(e=>{if(console.log({"Message received":e.data}),"recache"===e.data.action)e.waitUntil(this.handleRecacheMessage(e.data.url))})),self.addEventListener("install",(e=>{console.log("BSBI app service worker is being installed."),self.skipWaiting(),e.waitUntil(this.precache())})),self.addEventListener("activate",(e=>{console.log({"service worker activate event":e}),e.waitUntil(self.clients.matchAll({includeUncontrolled:!0}).then((e=>{const t=e.map((e=>e.url));console.log("[ServiceWorker] Matching clients:",t.join(", "))})).then((()=>caches.keys())).then((e=>Promise.all(e.map((e=>e.startsWith("version")&&e!==this.CACHE_VERSION?(console.log("[ServiceWorker] Deleting old code cache:",e),caches.delete(e)):e.startsWith("bsbi-data")&&e!==this.DATA_CACHE_VERSION?(console.log("[ServiceWorker] Deleting old data cache:",e),caches.delete(e)):void 0))))).then((()=>(console.log("[ServiceWorker] Claiming clients for version",this.CACHE_VERSION),self.clients.claim()))))})),self.addEventListener("fetch",(e=>{if(e.preventDefault(),"POST"===e.request.method)t.test(e.request.url)||o.test(e.request.url)?e.respondWith(fetch(e.request)):r.test(e.request.url)?this.handle_image_post(e):this.handle_post(e);else if(s.test(e.request.url)&&!i.test(e.request.url)){console.log(`redirecting to the root of the SPA for '${e.request.url}'`);let t=new Request(c);e.respondWith(this.fromCache(t))}else e.request.url.match(n)?(console.log(`request is for an image '${e.request.url}'`),this.handleImageFetch(e)):o.test(e.request.url)?e.respondWith(fetch(e.request)):a?.test(e.request.url)?e.respondWith(this.fromCache(e.request)):(console.log(`request is for non-image '${e.request.url}'`),e.respondWith(this.fromCache(e.request)),e.waitUntil(this.update(e.request)))}))}handle_post(e){let t;try{t=e.request.clone()}catch(e){console.log("Failed to clone request."),console.log({"Cloning error":e})}e.respondWith(fetch(e.request).then((e=>e.ok?Promise.resolve(e).then((e=>(console.log("About to clone the json response."),e.clone().json()))).then((t=>(console.log("Following successful remote post, about to save locally."),G.fromPostResponse(t).setPrebuiltResponse(e).populateLocalSave().storeLocally()))).catch((t=>(console.log({"local storage failed":t}),Promise.resolve(e)))):(console.log("Failed to save, moving on to attempt IndexedDb"),Promise.reject("Failed to save to server.")))).catch((e=>(console.log({"post fetch failed (probably no network)":e}),console.log(`post fetch failed (probably no network), (reason: ${e})`),t.formData().then((e=>(console.log("got to form data handler"),G.fromPostedData(e).populateClientResponse().storeLocally())),(e=>{console.log({"failed to read form data locally":e});return $({error:"Failed to process posted response data. (internal error)",errorHelp:"Your internet connection may have failed (or there could be a problem with the server). It wasn't possible to save a temporary copy on your device. (an unexpected error occurred) Please try to re-establish a network connection and try again."})}))))))}handle_image_post(e){let t;console.log("posting image");try{t=e.request.clone()}catch(e){console.log("Failed to clone request."),console.log({"Cloning error":e})}e.respondWith(t.formData().then((t=>(console.log({"got to image form data handler":t}),G.fromPostedData(t).populateClientResponse().storeLocally().then((t=>(e.waitUntil(fetch(e.request).then((e=>{if(console.log("posting image to server in waitUntil part of fetch cycle"),e.ok)return console.log("posted image to server in waitUntil part of fetch cycle: got OK response"),Promise.resolve(e).then((e=>e.clone().json())).then((t=>G.fromPostResponse(t).setPrebuiltResponse(e).populateLocalSave().storeLocally())).catch((t=>(console.log({error:t}),Promise.resolve(e))));return console.log("posted image to server in waitUntil part of fetch cycle: got Error response"),$({error:"Failed to save posted response data. (internal error)",errorHelp:"Your internet connection may have failed (or there could be a problem with the server). It wasn't possible to save a temporary copy on your device. (an unexpected error occurred) Please try to re-establish a network connection and try again."})}),(()=>{console.log("Rejected image post fetch from server - implies network is down")}))),t))))),(e=>{console.log("failed to read form data locally"),console.log({reason:e});return $({error:"Failed to process posted response data. (internal error)",errorHelp:"Your internet connection may have failed (or there could be a problem with the server). It wasn't possible to save a temporary copy on your device. (an unexpected error occurred) Please try to re-establish a network connection and try again."})})))}precache(){return caches.open(this.CACHE_VERSION).then((e=>e.addAll(this.URL_CACHE_SET))).catch((e=>(console.log({"Precache failed result":e}),Promise.resolve())))}fromCache(e,t=!0,r=0){let n;return n=this.SERVICE_WORKER_DATA_URL_MATCHES.test(e.url)?this.DATA_CACHE_VERSION:this.CACHE_VERSION,caches.open(n).then((n=>n.match(e).then((n=>(console.log(n?`cache matched ${e.url}`:`no cache match for ${e.url}`),n||t&&this.update(e,r))))))}handleImageFetch(e){e.respondWith(this.fromCache(e.request,!0,5e3).then((t=>{if(t&&t.ok)return console.info("Responding with image from cache (or remotely if no cache)."),t;{const t=e.request.url;console.info(`Attempting image match for '${t}'`);const r=t.match(/imageid=([a-fA-F0-9]{8}-(?:[a-fA-F0-9]{4}-){3}[a-fA-F0-9]{12})/);if(r){const e=r[1];return console.info(`Returning image match for '${t}' from local database`),this.imageFromLocalDatabase(e)}console.error(`Failed to match image id in url '${t}'`)}})).catch((t=>{const r=e.request.url;console.log({caught:t}),console.log(`In catch following failed network fetch, attempting image match for '${r}'`);const n=r.match(/imageid=([a-fA-F0-9]{8}-(?:[a-fA-F0-9]{4}-){3}[a-fA-F0-9]{12})/);if(n){const e=n[1];return console.log(`(via catch) Returning image match for '${r}' from local database`),this.imageFromLocalDatabase(e)}return console.error(`(via catch) Failed to match image id in url '${r}'`),Promise.reject(null)})))}imageFromLocalDatabase(e){const t=new J;return console.info("attempting retrieval of image data from local database"),O.retrieveFromLocal(e,t).then((t=>{if(console.log(`Retrieved image '${e}' from indexeddb.`),t.file){return(new Headers).append("Content-Type",t.file.type),new Response(t.file,{status:200,statusText:"OK image response from IndexedDb"})}return console.error(`No local file object associated with retrieved image '${e}' from indexeddb.`),Promise.reject(`No local file object associated with retrieved image '${e}' from indexeddb.`)}))}handleRecacheMessage(e){let t;return t=this.SERVICE_WORKER_DATA_URL_MATCHES.test(e)?this.DATA_CACHE_VERSION:this.CACHE_VERSION,caches.open(t).then((t=>t.add(e))).catch((e=>(console.error({"Precache failed result":e}),Promise.resolve())))}update(e,t=0){let r;return r=this.SERVICE_WORKER_DATA_URL_MATCHES.test(e.url)?this.DATA_CACHE_VERSION:this.CACHE_VERSION,e=new Request(e,{mode:"cors",credentials:"omit"}),console.info(`Attempting fetch and cache update of ${e.url}`),caches.open(r).then((r=>{let n,s;const i={cache:"no-cache"};return t&&(n=new AbortController,s=setTimeout((()=>{n.abort(),console.log(`User-define update fetch timeout expired after ${t} ms`)}),t),i.signal=n.signal),fetch(e,i).then((t=>(s&&(clearTimeout(s),s=null),t.ok?(console.info(`(re-)caching ${e.url}`),r.put(e,t).then((()=>r.match(e)))):(console.error(`Request during cache update failed for ${e.url}`),console.error({"failed cache response":t}),Promise.reject("Request during cache update failed, not caching."))))).catch((t=>(s&&(clearTimeout(s),s=null),console.log(`Cache attempt failed for ${e.url}: error was ${t}`),Promise.reject(`Cache attempt failed for ${e.url}: error was ${t}`))))}))}}).initialise({forageName:"Nyph App2024",postPassThroughWhitelist:/^https:\/\/nyph\.bsbi\.app\/loadsurveys.php|^https:\/\/nyph\.bsbi\.app\/javascriptErrorLog\.php/,postImageUrlMatch:/^https:\/\/nyph\.bsbi\.app\/saveimage.php/,getImageUrlMatch:/^https:\/\/nyph\.bsbi\.app\/image\.php/,interceptUrlMatches:new RegExp(`^https://nyph.bsbi.app/${V}/|^https://nyph.bsbi.app/${V}$`),ignoreUrlMatches:new RegExp(`^https://nyph.bsbi.app/${V}/app.m?js|^https://nyph.bsbi.app/${V}/serviceworker.m?js|^https://nyph.bsbi.app/${V}/manifest.webmanifest|^https://nyph.bsbi.app/${V}/index.html|^https://api.mapbox.com`),staticUrlMatches:/(?:^https:\/\/(?:staticdatabase\.bsbi\.org|fonts\.googleapis\.com|fonts\.gstatic\.com)|\.(?:png|svg|ico|m?js)$)/,indexUrl:`https://nyph.bsbi.app/${V}/index.html`,urlCacheSet:["./index.html","./app.mjs?version=1.0.4.1703956492","./manifest.webmanifest","/appcss/app.__BSBI_APP_VERSION__.css","/img/icons/favicon-32x32.png","/img/icons/favicon-16x16.png","/img/icons/android-icon-192x192.png","/img/nyph_final@2x.png","https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Round","https://staticdatabase.bsbi.org/js/taxaexpanded.mjs","https://fonts.googleapis.com/css2?family=Gentium+Basic&display=swap"],passThroughNoCache:/^https:\/\/api\.mapbox\.com|^https:\/\/events\.mapbox\.com|^https:\/\/browser-update\.org/,version:"1.0.4.1703956492",dataVersion:"1.0.4"});
//# sourceMappingURL=serviceworker.mjs.map
